Index: wizards/groupwisemain.cpp
===================================================================
--- wizards/groupwisemain.cpp	(.../tags/KDE/4.2.2/kdepim)	(wersja 952918)
+++ wizards/groupwisemain.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 952918)
@@ -48,8 +48,8 @@
 
   bool verbose = false;
   if ( args->isSet( "verbose" ) ) verbose = true;
-
+  args->clear();
   GroupwiseWizard wizard;
 
-  wizard.exec();
+  return wizard.exec();
 }
Index: wizards/sloxmain.cpp
===================================================================
--- wizards/sloxmain.cpp	(.../tags/KDE/4.2.2/kdepim)	(wersja 952918)
+++ wizards/sloxmain.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 952918)
@@ -47,8 +47,8 @@
 
   bool verbose = false;
   if ( args->isSet( "verbose" ) ) verbose = true;
-
+  args->clear();
   SloxWizard wizard;
 
-  wizard.exec();
+  return wizard.exec();
 }
Index: wizards/kolabmain.cpp
===================================================================
--- wizards/kolabmain.cpp	(.../tags/KDE/4.2.2/kdepim)	(wersja 952918)
+++ wizards/kolabmain.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 952918)
@@ -47,8 +47,8 @@
 
   bool verbose = false;
   if ( args->isSet( "verbose" ) ) verbose = true;
-
+  args->clear();
   KolabWizard wizard;
 
-  wizard.exec();
+  return wizard.exec();
 }
Index: wizards/groupwaremain.cpp
===================================================================
--- wizards/groupwaremain.cpp	(.../tags/KDE/4.2.2/kdepim)	(wersja 952918)
+++ wizards/groupwaremain.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 952918)
@@ -48,11 +48,11 @@
   QString serverType;
   if ( args->isSet( "serverType" ) )
     serverType = args->getOption( "serverType" );
-
+  args->clear();
   GroupwareWizard wizard( 0 );
   app.setMainWidget( &wizard );
 
   wizard.show();
 
-  app.exec();
+  return app.exec();
 }
Index: wizards/egroupwaremain.cpp
===================================================================
--- wizards/egroupwaremain.cpp	(.../tags/KDE/4.2.2/kdepim)	(wersja 952918)
+++ wizards/egroupwaremain.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 952918)
@@ -48,8 +48,8 @@
 
   bool verbose = false;
   if ( args->isSet( "verbose" ) ) verbose = true;
-
+  args->clear();
   EGroupwareWizard wizard;
 
-  wizard.exec();
+  return wizard.exec();
 }
Index: wizards/kmailchanges.cpp
===================================================================
--- wizards/kmailchanges.cpp	(.../tags/KDE/4.2.2/kdepim)	(wersja 952918)
+++ wizards/kmailchanges.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 952918)
@@ -243,14 +243,12 @@
   group = c.group( QString("Folder-%1").arg( uid ) );
   group.writeEntry( "isOpen", true );
 
-  if ( mEnableSavePassword ) {
-    group.writeEntry( "pass", KStringHandler::obscure( mPassword ) );
-    group.writeEntry( "store-passwd", true );
-  }
-
   group = c.group( QLatin1String( "AccountWizard" ) );
   group.writeEntry( QLatin1String( "ShowOnStartup" ), false );
 
+  group = c.group( QLatin1String( "Composer" ) );
+  group.writeEntry( "default-transport", mAccountName );
+
   KConfig transport( "mailtransports" );
   group = transport.group( QString("Transport %1").arg( transportId ) );
   group.writeEntry( "name", mAccountName );
Index: wizards/scalixmain.cpp
===================================================================
--- wizards/scalixmain.cpp	(.../tags/KDE/4.2.2/kdepim)	(wersja 952918)
+++ wizards/scalixmain.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 952918)
@@ -47,7 +47,8 @@
   bool verbose = false;
   if ( args->isSet( "verbose" ) ) verbose = true;
 
+  args->clear();
   ScalixWizard wizard;
 
-  wizard.exec();
+  return wizard.exec();
 }
Index: kresources/scalix/kabc/scalix.desktop
===================================================================
--- kresources/scalix/kabc/scalix.desktop	(.../tags/KDE/4.2.2/kdepim)	(wersja 952918)
+++ kresources/scalix/kabc/scalix.desktop	(.../branches/KDE/4.2/kdepim)	(wersja 952918)
@@ -6,6 +6,7 @@
 Name[da]=Adressebog på Scalix-server via KMail
 Name[de]=Scalix-Adressbuch via KMail
 Name[el]=Ημερολόγιο σε εξυπηρετητή Scalix μέσω του KMail
+Name[en_GB]=Address book on Scalix Server via KMail
 Name[es]=Libreta de direcciones en servidor Scalix por medio de KMail
 Name[et]=Aadressiraamat Scalix-serveris (KMaili vahendusel)
 Name[fi]=Osoitekirja Scalix-palvelimella KMailin avulla
Index: kresources/birthdays/kabc.desktop
===================================================================
--- kresources/birthdays/kabc.desktop	(.../tags/KDE/4.2.2/kdepim)	(wersja 952918)
+++ kresources/birthdays/kabc.desktop	(.../branches/KDE/4.2/kdepim)	(wersja 952918)
@@ -75,7 +75,7 @@
 Comment[pl]=Zapewnia dostęp do dat urodzin wizytówek w książce adresowej KDE jako zdarzeń kalendarza
 Comment[pt]=Oferece o acesso às datas de aniversário dos contactos no livro de endereços como eventos do calendário
 Comment[pt_BR]=Fornece acesso às datas de aniversário de contatos do livro de endereços do KDE como eventos de calendário
-Comment[ru]=Показ дней рождения из адресной книги KDE как событий календаря
+Comment[ru]=Дни рождения из адресной книги KDE в органайзере
 Comment[sl]=Omogoča dostop do rojstnih dnevov stikov, shranjenih v KDE-jevem adresarju. Na voljo so kot koledarski dogodki.
 Comment[sv]=Ger tillgång till födelsedagsdatum för kontakter i KDE:s adressbok som kalenderhändelser
 Comment[tr]=KDE Adres defterindeki kişilerin doğumgünü günlerine takvim olayları olarak erişmeyi sağlar
Index: kresources/akonadi/kabc/resourceakonadi.cpp
===================================================================
--- kresources/akonadi/kabc/resourceakonadi.cpp	(.../tags/KDE/4.2.2/kdepim)	(wersja 952918)
+++ kresources/akonadi/kabc/resourceakonadi.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 952918)
@@ -21,8 +21,9 @@
 #include "resourceakonadi.h"
 #include "resourceakonadiconfig.h"
 
+#include "../shared/concurrentjobs.h"
+
 #include <akonadi/collection.h>
-#include <akonadi/collectionfetchjob.h>
 #include <akonadi/collectionfilterproxymodel.h>
 #include <akonadi/collectionmodel.h>
 #include <akonadi/control.h>
@@ -31,7 +32,6 @@
 #include <akonadi/item.h>
 #include <akonadi/itemcreatejob.h>
 #include <akonadi/itemdeletejob.h>
-#include <akonadi/itemfetchjob.h>
 #include <akonadi/itemfetchscope.h>
 #include <akonadi/itemmodifyjob.h>
 #include <akonadi/transactionsequence.h>
@@ -41,8 +41,6 @@
 #include <kconfiggroup.h>
 #include <kdebug.h>
 
-#include <QtConcurrentRun>
-#include <QFuture>
 #include <QHash>
 
 using namespace Akonadi;
@@ -56,81 +54,42 @@
   virtual Collection collectionForUid( const QString &uid ) const = 0;
 };
 
-static KJob *createSaveSequence( const UidToCollectionMapper &mapper,
+static Akonadi::Job *createSaveSequence( const UidToCollectionMapper &mapper,
     const Item::List &addedItems, const Item::List &modifiedItems, const Item::List &deletedItems );
 
-class ThreadJobContext
+class ConcurrentItemSaveJob : public ConcurrentJob<Akonadi::Job>
 {
   public:
-    explicit ThreadJobContext( const UidToCollectionMapper &mapper )
-      : mMapper( mapper ) {}
+    ConcurrentItemSaveJob(  const UidToCollectionMapper &mapper,
+        const Item::List &addedItems, const Item::List &modifiedItems,
+        const Item::List &deletedItems )
+      : ConcurrentJob<Akonadi::Job>(),
+        mMapper( mapper ),
+        mAddedItems( addedItems ),
+        mModifiedItems( modifiedItems ),
+        mDeletedItems( deletedItems ) {}
 
-    void clear()
+    const ConcurrentItemSaveJob *operator->() const
     {
-      mJobError.clear();
-      mCollections.clear();
-      mItems.clear();
-
-      mAddedItems.clear();
-      mModifiedItems.clear();
-      mDeletedItems.clear();
+      return this;
     }
 
-    bool fetchCollections()
-    {
-      CollectionFetchJob *job = new CollectionFetchJob( Collection::root(), CollectionFetchJob::Recursive );
+  protected:
+    const UidToCollectionMapper &mMapper;
 
-      bool jobResult = job->exec();
-      if ( jobResult )
-        mCollections = job->collections();
-      else
-        mJobError = job->errorString();
+    const Item::List mAddedItems;
+    const Item::List mModifiedItems;
+    const Item::List mDeletedItems;
 
-      delete job;
-      return jobResult;
-    }
-
-    bool fetchItems( const Collection &collection )
+  protected:
+    void createJob()
     {
-      ItemFetchJob *job = new ItemFetchJob( collection );
-      job->fetchScope().fetchFullPayload();
-
-      bool jobResult = job->exec();
-      if ( jobResult )
-        mItems = job->items();
-      else
-        mJobError = job->errorString();
-
-      delete job;
-      return jobResult;
+      mJob = createSaveSequence( mMapper, mAddedItems, mModifiedItems, mDeletedItems );
     }
 
-    bool saveChanges()
+    void handleSuccess()
     {
-      KJob *job = createSaveSequence( mMapper, mAddedItems, mModifiedItems, mDeletedItems );
-
-      bool jobResult = job->exec();
-      if ( !jobResult )
-        mJobError = job->errorString();
-
-      delete job;
-      return jobResult;
     }
-
-  public:
-    QString mJobError;
-
-    Collection::List mCollections;
-    Item::List mItems;
-
-    Item::List mAddedItems;
-    Item::List mModifiedItems;
-    Item::List mDeletedItems;
-
-  private:
-    const UidToCollectionMapper &mMapper;
-
-  private:
 };
 
 typedef QMap<Item::Id, Item> ItemMap;
@@ -210,8 +169,7 @@
 {
   public:
     Private( ResourceAkonadi *parent )
-      : mParent( parent ), mMonitor( 0 ), mCollectionModel( 0 ), mCollectionFilterModel( 0 ),
-        mThreadJobContext( *this ), mOpenState(Opened)
+      : mParent( parent ), mMonitor( 0 ), mCollectionModel( 0 ), mCollectionFilterModel( 0 ), mOpenState(Opened)
     {
     }
 
@@ -258,8 +216,6 @@
 
     QSet<QString> mAsyncLoadCollections;
 
-    ThreadJobContext mThreadJobContext;
-
     enum OpenState
     {
       Closed,
@@ -285,7 +241,7 @@
 
     Collection findDefaultCollection() const;
     bool prepareSaving();
-    KJob *createSaveSequence() const;
+    Akonadi::Job *createSaveSequence() const;
 
     void createItemListsForSave( Item::List &added, Item::List &modified, Item::List &deleted ) const;
 
@@ -464,15 +420,13 @@
 
   // if we do not have any collection yet, fetch them explicitly
   if ( collections.isEmpty() ) {
-    d->mThreadJobContext.clear();
-    QFuture<bool> threadResult =
-      QtConcurrent::run( &(d->mThreadJobContext), &ThreadJobContext::fetchCollections );
-    if ( !threadResult.result() ) {
-      emit loadingError( this, d->mThreadJobContext.mJobError );
+    ConcurrentCollectionFetchJob fetchJob;
+    if ( !fetchJob.exec() ) {
+      emit loadingError( this, fetchJob->errorString() );
       return false;
     }
 
-    collections = d->mThreadJobContext.mCollections;
+    collections = fetchJob->collections();
   }
 
   bool result = true;
@@ -529,15 +483,13 @@
 
   // if we do not have any collection yet, fetch them explicitly
   if ( collections.isEmpty() ) {
-    d->mThreadJobContext.clear();
-    QFuture<bool> threadResult =
-      QtConcurrent::run( &(d->mThreadJobContext), &ThreadJobContext::fetchCollections );
-    if ( !threadResult.result() ) {
-      emit loadingError( this, d->mThreadJobContext.mJobError );
+    ConcurrentCollectionFetchJob fetchJob;
+    if ( !fetchJob.exec() ) {
+      emit loadingError( this, fetchJob->errorString() );
       return false;
     }
 
-    foreach ( const Collection &collection, d->mThreadJobContext.mCollections ) {
+    foreach ( const Collection &collection, fetchJob->collections() ) {
       if ( !collection.contentMimeTypes().contains( QLatin1String( "text/directory" ) )
             && !collection.contentMimeTypes().contains( KPIM::ContactGroup::mimeType() ) )
         continue;
@@ -588,22 +540,22 @@
   if ( !d->prepareSaving() )
     return false;
 
-  d->mThreadJobContext.clear();
+  Item::List addedItems;
+  Item::List modifiedItems;
+  Item::List deletedItems;
 
-  d->createItemListsForSave( d->mThreadJobContext.mAddedItems,
-                             d->mThreadJobContext.mModifiedItems,
-                             d->mThreadJobContext.mDeletedItems );
+  d->createItemListsForSave( addedItems, modifiedItems, deletedItems );
 
-  QFuture<bool> threadResult =
-    QtConcurrent::run( &(d->mThreadJobContext), &ThreadJobContext::saveChanges );
-  if ( !threadResult.result() ) {
-    // TODO error handling
-    kError(5700) << "Save Sequence failed:" << d->mThreadJobContext.mJobError;
+  ConcurrentItemSaveJob saveJob( *d, addedItems, modifiedItems, deletedItems );
+  if ( !saveJob.exec() ) {
+    kError(5700) << "Save Sequence failed:" << saveJob->errorString();
+    emit savingError( this, saveJob->errorString() );
     return false;
   }
 
   d->mChanges.clear();
 
+  emit savingFinished( this );
   return true;
 }
 
@@ -619,7 +571,7 @@
   if ( !d->prepareSaving() )
     return false;
 
-  KJob *job = d->createSaveSequence();
+  Akonadi::Job *job = d->createSaveSequence();
   if ( job == 0 )
     return false;
 
@@ -1420,7 +1372,7 @@
   return true;
 }
 
-static KJob *createSaveSequence( const UidToCollectionMapper &mapper,
+static Akonadi::Job *createSaveSequence( const UidToCollectionMapper &mapper,
     const Item::List &addedItems, const Item::List &modifiedItems, const Item::List &deletedItems )
 {
   TransactionSequence *sequence = new TransactionSequence();
@@ -1482,7 +1434,7 @@
   return sequence;
 }
 
-KJob *ResourceAkonadi::Private::createSaveSequence() const
+Akonadi::Job *ResourceAkonadi::Private::createSaveSequence() const
 {
   Item::List addedItems;
   Item::List modifiedItems;
@@ -1574,15 +1526,14 @@
 bool ResourceAkonadi::Private::reloadSubResource( SubResource *subResource, bool &changed )
 {
   changed = false;
-  mThreadJobContext.clear();
-  QFuture<bool> threadResult =
-    QtConcurrent::run( &mThreadJobContext, &ThreadJobContext::fetchItems, subResource->mCollection );
-  if ( !threadResult.result() ) {
-    emit mParent->loadingError( mParent, mThreadJobContext.mJobError );
+
+  ConcurrentItemFetchJob fetchJob( subResource->mCollection );
+  if ( !fetchJob.exec() ) {
+    emit mParent->loadingError( mParent, fetchJob->errorString() );
     return false;
   }
 
-  Item::List items = mThreadJobContext.mItems;
+  Item::List items = fetchJob->items();
 
   const QString collectionUrl = subResource->mCollection.url().url();
 
Index: kresources/akonadi/kabc/CMakeLists.txt
===================================================================
--- kresources/akonadi/kabc/CMakeLists.txt	(.../tags/KDE/4.2.2/kdepim)	(wersja 952918)
+++ kresources/akonadi/kabc/CMakeLists.txt	(.../branches/KDE/4.2/kdepim)	(wersja 952918)
@@ -3,7 +3,7 @@
 
 ########### next target ###############
 
-set(kabc_akonadi_SRCS resourceakonadiplugin.cpp resourceakonadi.cpp resourceakonadiconfig.cpp)
+set(kabc_akonadi_SRCS resourceakonadiplugin.cpp resourceakonadi.cpp resourceakonadiconfig.cpp ../shared/concurrentjobs.cpp)
 
 
 kde4_add_plugin(kabc_akonadi ${kabc_akonadi_SRCS})
Index: kresources/akonadi/shared/concurrentjobs.cpp
===================================================================
--- kresources/akonadi/shared/concurrentjobs.cpp	(.../tags/KDE/4.2.2/kdepim)	(wersja 0)
+++ kresources/akonadi/shared/concurrentjobs.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 952918)
@@ -0,0 +1,146 @@
+/*
+    This file is part of kdepim.
+    Copyright (c) 2009 Kevin Krammer <kevin.krammer@gmx.at>
+
+    This library is free software; you can redistribute it and/or
+    modify it under the terms of the GNU Library General Public
+    License as published by the Free Software Foundation; either
+    version 2 of the License, or (at your option) any later version.
+
+    This library is distributed in the hope that it will be useful,
+    but WITHOUT ANY WARRANTY; without even the implied warranty of
+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
+    Library General Public License for more details.
+
+    You should have received a copy of the GNU Library General Public License
+    along with this library; see the file COPYING.LIB.  If not, write to
+    the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor,
+    Boston, MA 02110-1301, USA.
+*/
+
+#include "concurrentjobs.h"
+
+//#include "itemsavecontext.h"
+
+#include <akonadi/itemfetchscope.h>
+
+using namespace Akonadi;
+
+ConcurrentJobBase::~ConcurrentJobBase()
+{
+}
+
+ConcurrentJobBase::JobRunner::JobRunner( ConcurrentJobBase *parent )
+  : QThread(), mParent( parent )
+{
+  Q_ASSERT( mParent != 0 );
+}
+
+void ConcurrentJobBase::JobRunner::run()
+{
+  QMutexLocker mutexLocker( &(mParent->mMutex) );
+
+  mParent->createJob();
+  Job *job = mParent->job();
+  Q_ASSERT( job != 0 );
+
+  mParent->mRunnerResult = job->exec();
+  if ( mParent->mRunnerResult ) {
+    mParent->handleSuccess();
+  } else {
+    mParent->mErrorString = job->errorString();
+  }
+
+  delete job;
+
+  mParent->mCondition.wakeAll();
+}
+
+const ConcurrentCollectionFetchJob *ConcurrentCollectionFetchJob::operator->() const
+{
+  return this;
+}
+
+Collection::List ConcurrentCollectionFetchJob::collections() const
+{
+  return mCollections;
+}
+
+void ConcurrentCollectionFetchJob::createJob()
+{
+  mJob = new CollectionFetchJob( Collection::root(), CollectionFetchJob::Recursive );
+}
+
+void ConcurrentCollectionFetchJob::handleSuccess()
+{
+  mCollections = mJob->collections();
+}
+
+ConcurrentItemFetchJob::ConcurrentItemFetchJob( const Collection &collection )
+  : ConcurrentJob<ItemFetchJob>(),
+    mCollection( collection )
+{
+}
+
+const ConcurrentItemFetchJob *ConcurrentItemFetchJob::operator->() const
+{
+  return this;
+}
+
+Item::List ConcurrentItemFetchJob::items() const
+{
+  return mItems;
+}
+
+void ConcurrentItemFetchJob::createJob()
+{
+  mJob = new ItemFetchJob( mCollection );
+  mJob->fetchScope().fetchFullPayload();
+}
+
+void ConcurrentItemFetchJob::handleSuccess()
+{
+  mItems = mJob->items();
+}
+
+ConcurrentCollectionCreateJob::ConcurrentCollectionCreateJob( const Akonadi::Collection &collection )
+  : ConcurrentJob<CollectionCreateJob>(),
+    mCollection( collection )
+{
+}
+
+const ConcurrentCollectionCreateJob *ConcurrentCollectionCreateJob::operator->() const
+{
+  return this;
+}
+
+void ConcurrentCollectionCreateJob::createJob()
+{
+  mJob = new CollectionCreateJob( mCollection );
+}
+
+void ConcurrentCollectionCreateJob::handleSuccess()
+{
+}
+
+ConcurrentCollectionDeleteJob::ConcurrentCollectionDeleteJob( const Akonadi::Collection &collection )
+  : ConcurrentJob<CollectionDeleteJob>(),
+    mCollection( collection )
+{
+}
+
+const ConcurrentCollectionDeleteJob *ConcurrentCollectionDeleteJob::operator->() const
+{
+  return this;
+}
+
+void ConcurrentCollectionDeleteJob::createJob()
+{
+  mJob = new CollectionDeleteJob( mCollection );
+}
+
+void ConcurrentCollectionDeleteJob::handleSuccess()
+{
+}
+
+// kate: space-indent on; indent-width 2; replace-tabs on;
Index: kresources/akonadi/shared/concurrentjobs.h
===================================================================
--- kresources/akonadi/shared/concurrentjobs.h	(.../tags/KDE/4.2.2/kdepim)	(wersja 0)
+++ kresources/akonadi/shared/concurrentjobs.h	(.../branches/KDE/4.2/kdepim)	(wersja 952918)
@@ -0,0 +1,178 @@
+/*
+    This file is part of kdepim.
+    Copyright (c) 2009 Kevin Krammer <kevin.krammer@gmx.at>
+
+    This library is free software; you can redistribute it and/or
+    modify it under the terms of the GNU Library General Public
+    License as published by the Free Software Foundation; either
+    version 2 of the License, or (at your option) any later version.
+
+    This library is distributed in the hope that it will be useful,
+    but WITHOUT ANY WARRANTY; without even the implied warranty of
+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
+    Library General Public License for more details.
+
+    You should have received a copy of the GNU Library General Public License
+    along with this library; see the file COPYING.LIB.  If not, write to
+    the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor,
+    Boston, MA 02110-1301, USA.
+*/
+
+#ifndef KRES_AKONADI_CONCURRENTJOBS_H
+#define KRES_AKONADI_CONCURRENTJOBS_H
+
+//#include "itemsavejob.h"
+
+#include <akonadi/collection.h>
+#include <akonadi/collectioncreatejob.h>
+#include <akonadi/collectiondeletejob.h>
+#include <akonadi/collectionfetchjob.h>
+#include <akonadi/item.h>
+#include <akonadi/itemfetchjob.h>
+
+#include <QtCore/QMutex>
+#include <QtCore/QMutexLocker>
+#include <QtCore/QThread>
+#include <QtCore/QWaitCondition>
+
+class ConcurrentJobBase
+{
+  public:
+    virtual ~ConcurrentJobBase();
+
+    QString errorString() const
+    {
+      return mErrorString;
+    }
+
+  protected:
+    bool mRunnerResult;
+
+    QString mErrorString;
+
+    QMutex mMutex;
+    QWaitCondition mCondition;
+
+  protected:
+    virtual void createJob() = 0;
+
+    virtual void handleSuccess() = 0;
+
+    virtual Akonadi::Job *job() = 0;
+
+  private:
+    class JobRunner : public QThread
+    {
+      public:
+        JobRunner( ConcurrentJobBase *parent );
+
+      protected:
+        void run();
+
+      private:
+        ConcurrentJobBase *mParent;
+    };
+};
+
+template <class JobClass>
+class ConcurrentJob : public ConcurrentJobBase
+{
+  public:
+    ConcurrentJob() : mJob( 0 ) {}
+
+    virtual ~ConcurrentJob() {}
+
+    bool exec()
+    {
+      JobRunner *runner = new JobRunner( this );
+      QObject::connect( runner, SIGNAL( finished() ), runner, SLOT( deleteLater() ) );
+
+      QMutexLocker mutexLocker( &mMutex );
+
+      runner->start();
+
+      mCondition.wait( &mMutex );
+
+      return mRunnerResult;
+    }
+
+  protected:
+    JobClass *mJob;
+
+  protected:
+    Akonadi::Job *job()
+    {
+      return mJob;
+    }
+};
+
+class ConcurrentCollectionFetchJob : public ConcurrentJob<Akonadi::CollectionFetchJob>
+{
+  public:
+    const ConcurrentCollectionFetchJob *operator->() const;
+
+    Akonadi::Collection::List collections() const;
+
+  protected:
+    Akonadi::Collection::List mCollections;
+
+  protected:
+    void createJob();
+
+    void handleSuccess();
+};
+
+class ConcurrentItemFetchJob : public ConcurrentJob<Akonadi::ItemFetchJob>
+{
+  public:
+    ConcurrentItemFetchJob( const Akonadi::Collection &collection );
+
+    const ConcurrentItemFetchJob *operator->() const;
+
+    Akonadi::Item::List items() const;
+
+  protected:
+    const Akonadi::Collection mCollection;
+    Akonadi::Item::List mItems;
+
+  protected:
+    void createJob();
+
+    void handleSuccess();
+};
+
+class ConcurrentCollectionCreateJob : public ConcurrentJob<Akonadi::CollectionCreateJob>
+{
+  public:
+    ConcurrentCollectionCreateJob( const Akonadi::Collection &collection );
+
+    const ConcurrentCollectionCreateJob *operator->() const;
+
+  protected:
+    Akonadi::Collection mCollection;
+
+  protected:
+    void createJob();
+
+    void handleSuccess();
+};
+
+class ConcurrentCollectionDeleteJob : public ConcurrentJob<Akonadi::CollectionDeleteJob>
+{
+  public:
+    ConcurrentCollectionDeleteJob( const Akonadi::Collection &collection );
+
+    const ConcurrentCollectionDeleteJob *operator->() const;
+
+  protected:
+    Akonadi::Collection mCollection;
+
+  protected:
+    void createJob();
+
+    void handleSuccess();
+};
+
+#endif
+
+// kate: space-indent on; indent-width 2; replace-tabs on;
Index: kresources/akonadi/kcal/resourceakonadi.cpp
===================================================================
--- kresources/akonadi/kcal/resourceakonadi.cpp	(.../tags/KDE/4.2.2/kdepim)	(wersja 952918)
+++ kresources/akonadi/kcal/resourceakonadi.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 952918)
@@ -21,6 +21,8 @@
 #include "resourceakonadi.h"
 #include "resourceakonadiconfig.h"
 
+#include "../shared/concurrentjobs.h"
+
 #include "kcal/calendarlocal.h"
 #include "kabc/locknull.h"
 
@@ -28,9 +30,6 @@
 #include <akonadi/agentinstance.h>
 #include <akonadi/agentinstancemodel.h>
 #include <akonadi/collection.h>
-#include <akonadi/collectioncreatejob.h>
-#include <akonadi/collectiondeletejob.h>
-#include <akonadi/collectionfetchjob.h>
 #include <akonadi/collectionfilterproxymodel.h>
 #include <akonadi/collectionmodel.h>
 #include <akonadi/control.h>
@@ -39,7 +38,6 @@
 #include <akonadi/item.h>
 #include <akonadi/itemcreatejob.h>
 #include <akonadi/itemdeletejob.h>
-#include <akonadi/itemfetchjob.h>
 #include <akonadi/itemfetchscope.h>
 #include <akonadi/itemmodifyjob.h>
 #include <akonadi/transactionsequence.h>
@@ -50,8 +48,6 @@
 #include <kdebug.h>
 #include <kmimetype.h>
 
-#include <QtConcurrentRun>
-#include <QFuture>
 #include <QHash>
 
 #include <boost/shared_ptr.hpp>
@@ -91,81 +87,42 @@
   virtual Collection collectionForUid( const QString &uid ) const = 0;
 };
 
-static KJob *createSaveSequence( const UidToCollectionMapper &mapper,
+static Akonadi::Job *createSaveSequence( const UidToCollectionMapper &mapper,
     const Item::List &addedItems, const Item::List &modifiedItems, const Item::List &deletedItems );
 
-class ThreadJobContext
+class ConcurrentItemSaveJob : public ConcurrentJob<Akonadi::Job>
 {
   public:
-    explicit ThreadJobContext( const UidToCollectionMapper &mapper )
-      : mMapper( mapper ) {}
+    ConcurrentItemSaveJob(  const UidToCollectionMapper &mapper,
+        const Item::List &addedItems, const Item::List &modifiedItems,
+        const Item::List &deletedItems )
+      : ConcurrentJob<Akonadi::Job>(),
+        mMapper( mapper ),
+        mAddedItems( addedItems ),
+        mModifiedItems( modifiedItems ),
+        mDeletedItems( deletedItems ) {}
 
-    void clear()
+    const ConcurrentItemSaveJob *operator->() const
     {
-      mJobError.clear();
-      mCollections.clear();
-      mItems.clear();
-
-      mAddedItems.clear();
-      mModifiedItems.clear();
-      mDeletedItems.clear();
+      return this;
     }
 
-    bool fetchCollections()
-    {
-      CollectionFetchJob *job = new CollectionFetchJob( Collection::root(), CollectionFetchJob::Recursive );
+  protected:
+    const UidToCollectionMapper &mMapper;
 
-      bool jobResult = job->exec();
-      if ( jobResult )
-        mCollections = job->collections();
-      else
-        mJobError = job->errorString();
+    const Item::List mAddedItems;
+    const Item::List mModifiedItems;
+    const Item::List mDeletedItems;
 
-      delete job;
-      return jobResult;
-    }
-
-    bool fetchItems( const Collection &collection )
+  protected:
+    void createJob()
     {
-      ItemFetchJob *job = new ItemFetchJob( collection );
-      job->fetchScope().fetchFullPayload();
-
-      bool jobResult = job->exec();
-      if ( jobResult )
-        mItems = job->items();
-      else
-        mJobError = job->errorString();
-
-      delete job;
-      return jobResult;
+      mJob = createSaveSequence( mMapper, mAddedItems, mModifiedItems, mDeletedItems );
     }
 
-    bool saveChanges()
+    void handleSuccess()
     {
-      KJob *job = createSaveSequence( mMapper, mAddedItems, mModifiedItems, mDeletedItems );
-
-      bool jobResult = job->exec();
-      if ( !jobResult )
-        mJobError = job->errorString();
-
-      delete job;
-      return jobResult;
     }
-
-  public:
-    QString mJobError;
-
-    Collection::List mCollections;
-    Item::List mItems;
-
-    Item::List mAddedItems;
-    Item::List mModifiedItems;
-    Item::List mDeletedItems;
-
-  private:
-    const UidToCollectionMapper &mMapper;
-
-  private:
 };
 
 class SubResource
@@ -245,7 +202,7 @@
         mMimeVisitor( new KCalMimeTypeVisitor() ),
         mCollectionModel( 0 ), mCollectionFilterModel( 0 ),
         mAgentModel( 0 ), mAgentFilterModel( 0 ),
-        mThreadJobContext( *this ), mOpenState( Closed )
+        mOpenState( Closed )
     {
       mCalendar.registerObserver( this );
     }
@@ -299,8 +256,6 @@
     AgentInstanceModel *mAgentModel;
     AgentFilterProxyModel *mAgentFilterModel;
 
-    ThreadJobContext mThreadJobContext;
-
     AssignmentVisitor mIncidenceAssigner;
 
     enum OpenState
@@ -639,10 +594,9 @@
   // TODO should we set content mime types at all?
   collection.setContentMimeTypes( QStringList( QLatin1String( "text/calendar" ) ) );
 
-  CollectionCreateJob *job = new CollectionCreateJob( collection );
-
-  if ( !job->exec() ) {
-    kError(5800) << "Creating collection failed:" << job->errorString();
+  ConcurrentCollectionCreateJob createJob( collection );
+  if ( !createJob.exec() ) {
+    kError(5800) << "Creating collection failed:" << createJob->errorString();
     return false;
   }
 
@@ -663,10 +617,10 @@
     return false;
   }
 
-  CollectionDeleteJob *job = new CollectionDeleteJob( subResource->mCollection );
+  ConcurrentCollectionDeleteJob deleteJob( subResource->mCollection );
 
-  if ( !job->exec() ) {
-    kError(5800) << "Deleting collection failed:" << job->errorString();
+  if ( !deleteJob.exec() ) {
+    kError(5800) << "Deleting collection failed:" << deleteJob->errorString();
     return false;
   }
 
@@ -789,15 +743,13 @@
 
   // if we do not have any collection yet, fetch them explicitly
   if ( collections.isEmpty() ) {
-    d->mThreadJobContext.clear();
-    QFuture<bool> threadResult =
-      QtConcurrent::run( &(d->mThreadJobContext), &ThreadJobContext::fetchCollections );
-    if ( !threadResult.result() ) {
-      loadError( d->mThreadJobContext.mJobError );
+    ConcurrentCollectionFetchJob fetchJob;
+    if ( !fetchJob.exec() ) {
+      loadError( fetchJob->errorString() );
       return false;
     }
 
-    collections = d->mThreadJobContext.mCollections;
+    collections = fetchJob->collections();
   }
 
   bool result = true;
@@ -841,18 +793,16 @@
   if ( !d->prepareSaving() )
     return false;
 
-  d->mThreadJobContext.clear();
+  Item::List addedItems;
+  Item::List modifiedItems;
+  Item::List deletedItems;
 
-  d->createItemListsForSave( d->mThreadJobContext.mAddedItems,
-                             d->mThreadJobContext.mModifiedItems,
-                             d->mThreadJobContext.mDeletedItems );
+  d->createItemListsForSave( addedItems, modifiedItems, deletedItems );
 
-  QFuture<bool> threadResult =
-    QtConcurrent::run( &(d->mThreadJobContext), &ThreadJobContext::saveChanges );
-  if ( !threadResult.result() ) {
-    // TODO error handling
-    kError(5800) << "Save Sequence failed:" << d->mThreadJobContext.mJobError;
-    saveError( d->mThreadJobContext.mJobError );
+  ConcurrentItemSaveJob saveJob( *d, addedItems, modifiedItems, deletedItems );
+  if ( !saveJob.exec() ) {
+    kError(5800) << "Save Sequence failed:" << saveJob->errorString();
+    saveError( saveJob->errorString() );
     return false;
   }
 
@@ -903,17 +853,16 @@
     }
   }
 
-  d->mThreadJobContext.clear();
+  Item::List addedItems;
+  Item::List modifiedItems;
+  Item::List deletedItems;
 
-  d->processChange( changeIt, d->mThreadJobContext.mAddedItems,
-                    d->mThreadJobContext.mModifiedItems, d->mThreadJobContext.mDeletedItems );
+  d->processChange( changeIt, addedItems, modifiedItems, deletedItems );
 
-  QFuture<bool> threadResult =
-    QtConcurrent::run( &(d->mThreadJobContext), &ThreadJobContext::saveChanges );
-  if ( !threadResult.result() ) {
-    // TODO error handling
-    kError(5800) << "Save Sequence failed:" << d->mThreadJobContext.mJobError;
-    saveError( d->mThreadJobContext.mJobError );
+  ConcurrentItemSaveJob saveJob( *d, addedItems, modifiedItems, deletedItems );
+  if ( !saveJob.exec() ) {
+    kError(5800) << "Save Sequence failed:" << saveJob->errorString();
+    saveError( saveJob->errorString() );
     return false;
   }
 
@@ -1465,7 +1414,7 @@
   return true;
 }
 
-static KJob *createSaveSequence( const UidToCollectionMapper &mapper,
+static Akonadi::Job *createSaveSequence( const UidToCollectionMapper &mapper,
     const Item::List &addedItems, const Item::List &modifiedItems, const Item::List &deletedItems )
 {
   TransactionSequence *sequence = new TransactionSequence();
@@ -1632,15 +1581,13 @@
 {
   changed = false;
 
-  mThreadJobContext.clear();
-  QFuture<bool> threadResult =
-    QtConcurrent::run( &mThreadJobContext, &ThreadJobContext::fetchItems, subResource->mCollection );
-  if ( !threadResult.result() ) {
-    mParent->loadError( mThreadJobContext.mJobError );
+  ConcurrentItemFetchJob fetchJob( subResource->mCollection );
+  if ( !fetchJob.exec() ) {
+    mParent->loadError( fetchJob->errorString() );
     return false;
   }
 
-  Item::List items = mThreadJobContext.mItems;
+  Item::List items = fetchJob->items();
 
   const QString collectionUrl = subResource->mCollection.url().url();
 
Index: kresources/akonadi/kcal/CMakeLists.txt
===================================================================
--- kresources/akonadi/kcal/CMakeLists.txt	(.../tags/KDE/4.2.2/kdepim)	(wersja 952918)
+++ kresources/akonadi/kcal/CMakeLists.txt	(.../branches/KDE/4.2/kdepim)	(wersja 952918)
@@ -4,7 +4,7 @@
 
 ########### next target ###############
 
-set(kcal_akonadi_SRCS resourceakonadiplugin.cpp resourceakonadi.cpp resourceakonadiconfig.cpp)
+set(kcal_akonadi_SRCS resourceakonadiplugin.cpp resourceakonadi.cpp resourceakonadiconfig.cpp ../shared/concurrentjobs.cpp)
 
 
 kde4_add_plugin(kcal_akonadi ${kcal_akonadi_SRCS})
Index: kresources/akonadi/kcal/akonadi.desktop
===================================================================
--- kresources/akonadi/kcal/akonadi.desktop	(.../tags/KDE/4.2.2/kdepim)	(wersja 952918)
+++ kresources/akonadi/kcal/akonadi.desktop	(.../branches/KDE/4.2/kdepim)	(wersja 952918)
@@ -25,7 +25,7 @@
 Comment[pl]=Zapewnia dostęp do kalendarzy przechowywanych w katalogach kalendarzy Akonadi
 Comment[pt]=Oferece o acesso aos calendários guardados nas pastas de calendários do Akonadi
 Comment[pt_BR]=Fornece acesso aos calendários armazenados nas pastas de calendários do Akonadi
-Comment[ru]=Доступ к папкам календарей Akonadi
+Comment[ru]=Доступ к папкам органайзера Akonadi
 Comment[sl]=Omogoča dostop do koledarjev, shranjenih v Akonadijevih mapah s koledarji
 Comment[sv]=Ger tillgång till kalendrar lagrade i Akonadi-kalenderkataloger
 Comment[tr]=Akonadi takvim dizinlerindeki takvimlere erişim sağlar
Index: kresources/groupware/kabc_groupware.desktop
===================================================================
--- kresources/groupware/kabc_groupware.desktop	(.../tags/KDE/4.2.2/kdepim)	(wersja 952918)
+++ kresources/groupware/kabc_groupware.desktop	(.../branches/KDE/4.2/kdepim)	(wersja 952918)
@@ -37,7 +37,7 @@
 Name[pt]=Servidor de Groupware
 Name[pt_BR]=Servidor Groupware
 Name[ro]=Server Groupware
-Name[ru]=Сервер Groupware
+Name[ru]=Groupware-cервер
 Name[sl]=Strežnik za skupinsko delo
 Name[sv]=Grupprogramserver
 Name[ta]=குழுவாரி சேவகன்
@@ -68,7 +68,7 @@
 Comment[pl]=Zapewnia dostęp do wizytówek przechowywanych na serwerach pracy grupowej.
 Comment[pt]=Oferece o acesso aos contactos guardados num servidor de Groupware.
 Comment[pt_BR]=Fornece acesso aos contatos armazenados em um servidor de Groupware.
-Comment[ru]=Доступ к контактам на сервере Groupware.
+Comment[ru]=Доступ к контактам на сервере коллективной работы.
 Comment[sl]=Omogoča dostop do stikov, shranjenih na strežniku Groupware.
 Comment[sv]=Ger tillgång till kontakter lagrade på en grupprogramserver.
 Comment[tr]=Groupware sunucusu üzerindeki kişilere erişim sağlar.
Index: kresources/groupware/kcal_groupware.desktop
===================================================================
--- kresources/groupware/kcal_groupware.desktop	(.../tags/KDE/4.2.2/kdepim)	(wersja 952918)
+++ kresources/groupware/kcal_groupware.desktop	(.../branches/KDE/4.2/kdepim)	(wersja 952918)
@@ -37,7 +37,7 @@
 Name[pt]=Servidor de Groupware
 Name[pt_BR]=Servidor Groupware
 Name[ro]=Server Groupware
-Name[ru]=Сервер Groupware
+Name[ru]=Groupware-cервер
 Name[sl]=Strežnik za skupinsko delo
 Name[sv]=Grupprogramserver
 Name[ta]=குழுவாரி சேவகன்
Index: kmail/folderstorage.h
===================================================================
--- kmail/folderstorage.h	(.../tags/KDE/4.2.2/kdepim)	(wersja 952918)
+++ kmail/folderstorage.h	(.../branches/KDE/4.2/kdepim)	(wersja 952918)
@@ -638,7 +638,7 @@
   /** number of unread messages, -1 if not yet set */
   int mUnreadMsgs, mGuessedUnreadMsgs;
   int mTotalMsgs;
-  qint64 mSize;
+  mutable qint64 mCachedSize;
   bool mWriteConfigEnabled :1;
   /** sven: true if on destruct folder needs to be compacted. */
   bool needsCompact :1;
Index: kmail/managesievescriptsdialog_p.h
===================================================================
--- kmail/managesievescriptsdialog_p.h	(.../tags/KDE/4.2.2/kdepim)	(wersja 952918)
+++ kmail/managesievescriptsdialog_p.h	(.../branches/KDE/4.2/kdepim)	(wersja 952918)
@@ -15,7 +15,8 @@
 
   QString script() const { return mTextEdit->toPlainText(); }
   void setScript( const QString & script ) { mTextEdit->setText( script ); }
-
+private slots:
+  void slotTextChanged();
 private:
   KTextEdit * mTextEdit;
 };
Index: kmail/kmailicalifaceimpl.cpp
===================================================================
--- kmail/kmailicalifaceimpl.cpp	(.../tags/KDE/4.2.2/kdepim)	(wersja 952918)
+++ kmail/kmailicalifaceimpl.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 952918)
@@ -713,7 +713,8 @@
       QStringList remainder(parts);
       remainder.pop_front();
       remainder.pop_front();
-      if ( dimapAccountCount() > 1 ) {
+      if ( dimapAccountCount() > 1 && folder && folder->storage() &&
+           static_cast<const KMFolderCachedImap*>( folder->storage() )->account() ) {
         label = i18n( "My %1 (%2)", remainder.join( QString::fromLatin1("/") ),
                       static_cast<const KMFolderCachedImap*>( folder->storage() )->account()->name() );
       } else {
Index: kmail/messagelistview/storagemodel.cpp
===================================================================
--- kmail/messagelistview/storagemodel.cpp	(.../tags/KDE/4.2.2/kdepim)	(wersja 952918)
+++ kmail/messagelistview/storagemodel.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 952918)
@@ -287,7 +287,8 @@
     receiver = unknown;
 
   mi->initialSetup(
-      msg->date(), msg->msgSize(),
+      msg->date(),
+      mFolder->folderType() == KMFolderTypeImap ? msg->msgSizeServer() : msg->msgSize(),
       sender, receiver,
       bUseReceiver ? receiver : sender
     );
Index: kmail/kmfoldermaildir.cpp
===================================================================
--- kmail/kmfoldermaildir.cpp	(.../tags/KDE/4.2.2/kdepim)	(wersja 952918)
+++ kmail/kmfoldermaildir.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 952918)
@@ -434,7 +434,7 @@
     }
   }
   ++mTotalMsgs;
-  mSize = -1;
+  mCachedSize = -1;
 
   if ( aMsg->attachmentState() == KMMsgAttachmentUnknown &&
        aMsg->readyToShow() )
@@ -1076,7 +1076,7 @@
   KIO::DirectorySizeJob * dirsize = dynamic_cast<KIO::DirectorySizeJob*>( job );
   if ( dirsize && !dirsize->error() )
   {
-    mSize = dirsize->totalSize();
+    mCachedSize = dirsize->totalSize();
     //kDebug(5006) << << "DirectorySizeJob completed. Folder"
     //             << location() << "has size" << mSize;
     emit folderSizeChanged();
Index: kmail/managesievescriptsdialog.h
===================================================================
--- kmail/managesievescriptsdialog.h	(.../tags/KDE/4.2.2/kdepim)	(wersja 952918)
+++ kmail/managesievescriptsdialog.h	(.../branches/KDE/4.2/kdepim)	(wersja 952918)
@@ -34,7 +34,6 @@
   void slotPutResult( KMail::SieveJob *, bool );
   void slotSieveEditorOkClicked();
   void slotSieveEditorCancelClicked();
-
 private:
   void killAllJobs();
   void changeActiveScript( Q3CheckListItem * );
Index: kmail/messageactions.cpp
===================================================================
--- kmail/messageactions.cpp	(.../tags/KDE/4.2.2/kdepim)	(wersja 952918)
+++ kmail/messageactions.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 952918)
@@ -168,7 +168,12 @@
 
 void MessageActions::updateActions()
 {
-  const bool singleMsg = (mCurrentMessage != 0);
+  bool singleMsg = (mCurrentMessage != 0);
+  if ( mCurrentMessage && mCurrentMessage->parent() ) {
+    if ( mCurrentMessage->parent()->isSent() ||
+         mCurrentMessage->parent()->isTemplates())
+      singleMsg = false;
+  }
   const bool multiVisible = mVisibleSernums.count() > 0 || mCurrentMessage;
   const bool flagsAvailable = GlobalSettings::self()->allowLocalFlags() ||
       !((mCurrentMessage && mCurrentMessage->parent()) ? mCurrentMessage->parent()->isReadOnly() : true);
Index: kmail/managesievescriptsdialog.cpp
===================================================================
--- kmail/managesievescriptsdialog.cpp	(.../tags/KDE/4.2.2/kdepim)	(wersja 952918)
+++ kmail/managesievescriptsdialog.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 952918)
@@ -181,7 +181,8 @@
     // top-levels:
     menu.addAction( i18n( "New Script..." ), this, SLOT(slotNewScript()) );
   }
-  menu.exec( p );
+  if ( !menu.actions().isEmpty() )
+    menu.exec( p );
   mContextMenuItem = 0;
 }
 
@@ -253,7 +254,6 @@
                                    KStandardGuiItem::del() )
        != KMessageBox::Continue )
     return;
-
   SieveJob * job = SieveJob::del( u );
   connect( job, SIGNAL(result(KMail::SieveJob*,bool,const QString&,bool)),
            this, SLOT(slotRefresh()) );
@@ -321,16 +321,22 @@
   vlay->setSpacing( spacingHint() );
   vlay->setMargin( 0 );
   mTextEdit = new KTextEdit( frame);
+  mTextEdit->setFocus();
   vlay->addWidget( mTextEdit );
   mTextEdit->setAcceptRichText( false );
   mTextEdit->setWordWrapMode ( QTextOption::NoWrap );
   mTextEdit->setFont( KGlobalSettings::fixedFont() );
-
+  connect( mTextEdit, SIGNAL( textChanged () ), SLOT( slotTextChanged() ) );
   resize( 3 * sizeHint() );
 }
 
 KMail::SieveEditor::~SieveEditor() {}
 
+void KMail::SieveEditor::slotTextChanged()
+{
+  enableButtonOk( !script().isEmpty() );
+}
+
 void KMail::ManageSieveScriptsDialog::slotGetResult( KMail::SieveJob *, bool success, const QString & script, bool isActive ) {
   if ( !success )
     return;
@@ -357,6 +363,7 @@
 void KMail::ManageSieveScriptsDialog::slotSieveEditorCancelClicked() {
   mSieveEditor->deleteLater(); mSieveEditor = 0;
   mCurrentURL = KUrl();
+  slotRefresh();
 }
 
 void KMail::ManageSieveScriptsDialog::slotPutResult( KMail::SieveJob *, bool success ) {
Index: kmail/filterlogdlg.cpp
===================================================================
--- kmail/filterlogdlg.cpp	(.../tags/KDE/4.2.2/kdepim)	(wersja 952918)
+++ kmail/filterlogdlg.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 952918)
@@ -67,16 +67,14 @@
   mTextEdit = new KTextEdit( page );
   mTextEdit->setReadOnly( true );
   mTextEdit->setLineWrapMode ( KTextEdit::NoWrap );
-  mTextEdit->setAcceptRichText( false );
 
   QString text;
-  QStringList logEntries = FilterLog::instance()->getLogEntries();
-  for ( QStringList::Iterator it = logEntries.begin();
-        it != logEntries.end(); ++it )
+  const QStringList logEntries = FilterLog::instance()->getLogEntries();
+  for ( QStringList::ConstIterator it = logEntries.constBegin();
+        it != logEntries.constEnd(); ++it )
   {
-    text+=*it;
+      mTextEdit->append(*it);
   }
-  mTextEdit->setText(text);
 
   mLogActiveBox = new QCheckBox( i18n("&Log filter activities"), page );
   mLogActiveBox->setChecked( FilterLog::instance()->isLogging() );
Index: kmail/kmpopheaders.cpp
===================================================================
--- kmail/kmpopheaders.cpp	(.../tags/KDE/4.2.2/kdepim)	(wersja 952918)
+++ kmail/kmpopheaders.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 952918)
@@ -31,8 +31,7 @@
 
 KMPopHeaders::~KMPopHeaders()
 {
-  if ( mHeader )
-    delete mHeader;
+  delete mHeader;
 }
 
 KMPopHeaders::KMPopHeaders( const QByteArray & id, const QByteArray & uid,
Index: kmail/kmmainwidget.cpp
===================================================================
--- kmail/kmmainwidget.cpp	(.../tags/KDE/4.2.2/kdepim)	(wersja 952918)
+++ kmail/kmmainwidget.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 952918)
@@ -792,6 +792,7 @@
   QVBoxLayout *vboxlayout = new QVBoxLayout;
   vboxlayout->setMargin(0);
   mFolderQuickSearch = new KTreeWidgetSearchLine( mSearchAndTree );
+  mFolderQuickSearch->setClickMessage( i18n( "Search" ) );
   vboxlayout->addWidget( mFolderQuickSearch );
   mSearchAndTree->setLayout( vboxlayout );
 
@@ -2510,7 +2511,7 @@
 //-----------------------------------------------------------------------------
 void KMMainWidget::slotJumpToFolder()
 {
-  KMail::FolderSelectionDialog dlg( this, i18n("Jump to Folder"), true );
+  KMail::FolderSelectionDialog dlg( this, i18n("Jump to Folder"), false );
   KMFolder* dest;
 
   if (!dlg.exec()) return;
@@ -4442,7 +4443,7 @@
   mPreferHtmlAction->setChecked( mHtmlPref ? !mFolderHtmlPref : mFolderHtmlPref );
   mPreferHtmlLoadExtAction->setChecked( mHtmlLoadExtPref ? !mFolderHtmlLoadExtPref : mFolderHtmlLoadExtPref );
 
-  mNewFolderAction->setEnabled( !multiFolder );
+  mNewFolderAction->setEnabled( !multiFolder && ( mFolder && mFolder->folderType() != KMFolderTypeSearch) );
   mRemoveDuplicatesAction->setEnabled( !multiFolder && mFolder && mFolder->canDeleteMessages() );
   mFolderShortCutCommandAction->setEnabled( !multiFolder );
 }
@@ -5008,6 +5009,7 @@
 
   actionCollection()->action("check_mail")->setEnabled( actList.size() > 0 );
   actionCollection()->action("check_mail_in")->setEnabled( actList.size() > 0 );
+  actionCollection()->action("favorite_check_mail")->setEnabled( actList.size() > 0 );
 }
 
 //-----------------------------------------------------------------------------
Index: kmail/recipientseditor.h
===================================================================
--- kmail/recipientseditor.h	(.../tags/KDE/4.2.2/kdepim)	(wersja 952918)
+++ kmail/recipientseditor.h	(.../branches/KDE/4.2/kdepim)	(wersja 952918)
@@ -158,6 +158,7 @@
     void analyzeLine( const QString & );
     void slotFocusUp();
     void slotFocusDown();
+    void slotEditingFinished();
     void slotPropagateDeletion();
     void slotTypeModified();
 
Index: kmail/kmsearchpatternedit.cpp
===================================================================
--- kmail/kmsearchpatternedit.cpp	(.../tags/KDE/4.2.2/kdepim)	(wersja 952918)
+++ kmail/kmsearchpatternedit.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 952918)
@@ -41,8 +41,15 @@
 //       you change the following i18n-ized strings!
 // Note: The index of the values in the following array has to correspond to
 //       the value of the entries in the enum in KMSearchRuleWidget.
+
+#undef I18N_NOOP
+#define I18N_NOOP(t) 0, t
+#undef I18N_NOOP2
+#define I18N_NOOP2(c,t) c, t
+
 static const struct {
   const char *internalName;
+  const char *context;
   const char *displayName;
 } SpecialRuleFields[] = {
   { "<message>",     I18N_NOOP( "Complete Message" )       },
@@ -214,7 +221,7 @@
 QByteArray KMSearchRuleWidget::ruleFieldToEnglish( const QString & i18nVal )
 {
   for ( int i = 0; i < SpecialRuleFieldsCount; ++i ) {
-    if ( i18nVal == i18n( SpecialRuleFields[i].displayName ) )
+    if ( i18nVal == i18nc( SpecialRuleFields[i].context, SpecialRuleFields[i].displayName ) )
       return SpecialRuleFields[i].internalName;
   }
   return i18nVal.toLatin1();
@@ -223,7 +230,7 @@
 int KMSearchRuleWidget::ruleFieldToId( const QString & i18nVal )
 {
   for ( int i = 0; i < SpecialRuleFieldsCount; ++i ) {
-    if ( i18nVal == i18n( SpecialRuleFields[i].displayName ) )
+    if ( i18nVal == i18nc( SpecialRuleFields[i].context, SpecialRuleFields[i].displayName ) )
       return i;
   }
   return -1; // no pseudo header
@@ -233,7 +240,7 @@
 {
   for ( int i = 0; i < SpecialRuleFieldsCount; ++i ) {
     if ( internal == SpecialRuleFields[i].internalName )
-      return i18n(SpecialRuleFields[i].displayName);
+      return i18nc(SpecialRuleFields[i].context, SpecialRuleFields[i].displayName);
   }
   return internal.toLatin1();
 }
@@ -260,18 +267,18 @@
   mFilterFieldList.clear();
   mFilterFieldList.append(""); // empty entry for user input
   if( !headersOnly ) {
-    mFilterFieldList.append( i18n( SpecialRuleFields[Message].displayName ) );
-    mFilterFieldList.append( i18n( SpecialRuleFields[Body].displayName ) );
+    mFilterFieldList.append( i18nc( SpecialRuleFields[Message].context, SpecialRuleFields[Message].displayName ) );
+    mFilterFieldList.append( i18nc( SpecialRuleFields[Body].context, SpecialRuleFields[Body].displayName ) );
   }
-  mFilterFieldList.append( i18n( SpecialRuleFields[AnyHeader].displayName ) );
-  mFilterFieldList.append( i18n( SpecialRuleFields[Recipients].displayName ) );
-  mFilterFieldList.append( i18n( SpecialRuleFields[Size].displayName ) );
+  mFilterFieldList.append( i18nc( SpecialRuleFields[AnyHeader].context, SpecialRuleFields[AnyHeader].displayName ) );
+  mFilterFieldList.append( i18nc( SpecialRuleFields[Recipients].context, SpecialRuleFields[Recipients].displayName ) );
+  mFilterFieldList.append( i18nc( SpecialRuleFields[Size].context, SpecialRuleFields[Size].displayName ) );
   if ( !absoluteDates )
-    mFilterFieldList.append( i18n( SpecialRuleFields[AgeInDays].displayName ) );
-  mFilterFieldList.append( i18n( SpecialRuleFields[Subject].displayName ) );
-  mFilterFieldList.append( i18n( SpecialRuleFields[From].displayName ) );
-  mFilterFieldList.append( i18n( SpecialRuleFields[To].displayName ) );
-  mFilterFieldList.append( i18n( SpecialRuleFields[CC].displayName ) );
+    mFilterFieldList.append( i18nc( SpecialRuleFields[AgeInDays].context, SpecialRuleFields[AgeInDays].displayName ) );
+  mFilterFieldList.append( i18nc( SpecialRuleFields[Subject].context, SpecialRuleFields[Subject].displayName ) );
+  mFilterFieldList.append( i18nc( SpecialRuleFields[From].context, SpecialRuleFields[From].displayName ) );
+  mFilterFieldList.append( i18nc( SpecialRuleFields[To].context, SpecialRuleFields[To].displayName ) );
+  mFilterFieldList.append( i18nc( SpecialRuleFields[CC].context, SpecialRuleFields[CC].displayName ) );
 
   // these others only represent message headers and you can add to
   // them as you like
Index: kmail/folderstorage.cpp
===================================================================
--- kmail/folderstorage.cpp	(.../tags/KDE/4.2.2/kdepim)	(wersja 952918)
+++ kmail/folderstorage.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 952918)
@@ -76,7 +76,7 @@
   mUnreadMsgs = -1;
   mGuessedUnreadMsgs = -1;
   mTotalMsgs = -1;
-  mSize = -1;
+  mCachedSize = -1;
   needsCompact = false;
   mConvertToUtf8 = false;
   mCompactable = true;
@@ -415,7 +415,7 @@
   }
   --mTotalMsgs;
 
-  mSize = -1;
+  mCachedSize = -1;
   QString msgIdMD5 = mb->msgIdMD5();
   emit msgRemoved( idx, msgIdMD5 );
   emit msgRemoved( folder() );
@@ -453,7 +453,7 @@
   --mTotalMsgs;
   msg->setParent(0);
   setDirty( true );
-  mSize = -1;
+  mCachedSize = -1;
   needsCompact=true; // message is taken from here - needs to be compacted
   QString msgIdMD5 = msg->msgIdMD5();
   emit msgRemoved( idx, msgIdMD5 );
@@ -828,7 +828,7 @@
 
   mUnreadMsgs = 0;
   mTotalMsgs = 0;
-  mSize = 0;
+  mCachedSize = 0;
   emit numUnreadMsgsChanged( folder() );
   if ( mAutoCreateIndex ) {  // FIXME Heh? - Till
     writeConfig();
@@ -877,11 +877,10 @@
 
 qint64 FolderStorage::folderSize() const
 {
-    if ( mSize != -1 ) {
-        return mSize;
-    } else {
-        return doFolderSize();
-    }
+  if ( mCachedSize == -1 ) {
+    mCachedSize = doFolderSize();
+  }
+  return mCachedSize;
 }
 
 
@@ -954,8 +953,8 @@
   if (mTotalMsgs == -1)
     mTotalMsgs = group.readEntry("TotalMsgs", -1 );
   mCompactable = group.readEntry("Compactable", true );
-  if ( mSize == -1 )
-    mSize = group.readEntry( "FolderSize", Q_INT64_C(-1) );
+  if ( mCachedSize == -1 )
+    mCachedSize = group.readEntry( "FolderSize", Q_INT64_C(-1) );
 
   int type = group.readEntry( "ContentsType", 0 );
   if ( type < 0 || type > KMail::ContentsTypeLast ) type = 0;
@@ -974,7 +973,7 @@
   group.writeEntry( "TotalMsgs", mTotalMsgs );
   group.writeEntry( "Compactable", mCompactable );
   group.writeEntry( "ContentsType", (int)mContentsType );
-  group.writeEntry( "FolderSize", mSize );
+  group.writeEntry( "FolderSize", mCachedSize );
 
   // Write the KMFolder parts
   if( folder() ) folder()->writeConfig( group );
@@ -1101,7 +1100,7 @@
     //FIXME: the questions is : should we iterate through all
     //messages in jobs? I don't think so, because it would
     //mean canceling the jobs that work with other messages
-    if ( (*it)->msgList().first() == msg )
+    if ( !(*it)->msgList().isEmpty() && (*it)->msgList().first() == msg )
     {
       FolderJob* job = (*it);
       it = mJobList.erase( it );
Index: kmail/kmfolderimap.cpp
===================================================================
--- kmail/kmfolderimap.cpp	(.../tags/KDE/4.2.2/kdepim)	(wersja 952918)
+++ kmail/kmfolderimap.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 952918)
@@ -2304,6 +2304,21 @@
 }
 
 //-----------------------------------------------------------------------------
+qint64 KMFolderImap::doFolderSize() const
+{
+  if ( count() == -1 )
+  {
+    return -1;
+  }
+
+  qint64 folderSize = 0;
+  for ( int i = 0, end = count(); i < end; ++i ) {
+    folderSize += getMsgBase( i )->msgSizeServer();
+  }
+  return folderSize;
+}
+
+//-----------------------------------------------------------------------------
 void
 KMFolderImap::setUserRights( unsigned int userRights )
 {
Index: kmail/kmcomposereditor.cpp
===================================================================
--- kmail/kmcomposereditor.cpp	(.../tags/KDE/4.2.2/kdepim)	(wersja 952918)
+++ kmail/kmcomposereditor.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 952918)
@@ -148,7 +148,7 @@
         }
       }
     } else if ( md->hasText() ) {
-      textCursor().insertText( md->text() );
+      KMeditor::dropEvent( e );
       e->accept();
     } else {
       kDebug(5006) << "Unable to add dropped object";
Index: kmail/kmfoldermbox.cpp
===================================================================
--- kmail/kmfoldermbox.cpp	(.../tags/KDE/4.2.2/kdepim)	(wersja 952918)
+++ kmail/kmfoldermbox.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 952918)
@@ -1135,7 +1135,7 @@
     }
   }
   ++mTotalMsgs;
-  mSize = -1;
+  mCachedSize = -1;
 
   if ( aMsg->attachmentState() == KMMsgAttachmentUnknown &&
        aMsg->readyToShow() )
Index: kmail/recipientseditor.cpp
===================================================================
--- kmail/recipientseditor.cpp	(.../tags/KDE/4.2.2/kdepim)	(wersja 952918)
+++ kmail/recipientseditor.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 952918)
@@ -170,6 +170,7 @@
   connect( mEdit, SIGNAL( rightPressed() ), SIGNAL( rightPressed() ) );
 
   connect( mEdit, SIGNAL( leftPressed() ), mCombo, SLOT( setFocus() ) );
+  connect( mEdit, SIGNAL( editingFinished() ), SLOT( slotEditingFinished() ) );
   connect( mEdit, SIGNAL( clearButtonClicked() ), SLOT( slotPropagateDeletion() ) );
   connect( mCombo, SIGNAL( rightPressed() ), mEdit, SLOT( setFocus() ) );
 
@@ -271,6 +272,13 @@
   emit deleteLine( this );
 }
 
+void RecipientLine::slotEditingFinished()
+{
+  if ( mEdit->text().isEmpty() ) {
+    emit deleteLine( this );
+  }
+}
+
 void RecipientLine::keyPressEvent( QKeyEvent *ev )
 {
   if ( ev->key() == Qt::Key_Up ) {
@@ -490,7 +498,7 @@
     mModified = true;
   if ( mLines.count() == 1 ) {
     line->clear();
-  } else {
+  } else if ( mLines.indexOf( line ) != mLines.count() - 1 ) {
     mCurDelLine = line;
     QTimer::singleShot( 0, this, SLOT( slotDeleteLine( ) ) );
   }
@@ -504,13 +512,15 @@
   RecipientLine *line = mCurDelLine;
   int pos = mLines.indexOf( line );
 
-  int newPos;
-  if ( pos == 0 ) newPos = pos + 1;
-  else newPos = pos - 1;
+  if ( mCurDelLine->isActive() ) {
+    int newPos;
+    if ( pos == 0 ) newPos = pos + 1;
+    else newPos = pos - 1;
 
-  // if there is something left to activate, do so
-  if ( mLines.at( newPos ) )
-    mLines.at( newPos )->activate();
+    // if there is something left to activate, do so
+    if ( mLines.at( newPos ) )
+      mLines.at( newPos )->activate();
+  }
 
   mLines.removeAll( line );
   line->setParent( 0 );
@@ -900,7 +910,8 @@
 {
   DistributionListDialog *dlg = new DistributionListDialog( this );
   dlg->setRecipients( mRecipientsView->recipients() );
-  dlg->show();
+  dlg->exec();
+  delete dlg;
 }
 
 Recipient::List RecipientsEditor::recipients() const
Index: kmail/kmfolderimap.h
===================================================================
--- kmail/kmfolderimap.h	(.../tags/KDE/4.2.2/kdepim)	(wersja 952918)
+++ kmail/kmfolderimap.h	(.../branches/KDE/4.2/kdepim)	(wersja 952918)
@@ -421,6 +421,9 @@
     the various index files deleted.  Returns 0 on success. */
   virtual int expungeContents();
 
+  /**  reimp */
+  virtual qint64 doFolderSize() const;
+
   void setChildrenState( const QString &attributes );
 
   /** Create or find the INBOX and initialize it */
Index: kmail/folderview.cpp
===================================================================
--- kmail/folderview.cpp	(.../tags/KDE/4.2.2/kdepim)	(wersja 952918)
+++ kmail/folderview.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 952918)
@@ -575,7 +575,7 @@
         Util::reconnectSignalSlotPair( fld, SIGNAL( folderSizeChanged( KMFolder * ) ), fvi, SLOT( slotFolderCountsChanged( KMFolder * ) ) );
 
         Util::reconnectSignalSlotPair( fld, SIGNAL( shortcutChanged( KMFolder * ) ), mMainWidget, SLOT( slotShortcutChanged( KMFolder * ) ) );
-      }  
+      }
     }
     i++;
   }
@@ -839,7 +839,7 @@
         // not end up in endless loops trying to update and never making progress.
         elapsed = tStart.msecsTo( QTime::currentTime() );
         if ( ( elapsed > gUpdateCountsProcessingInterval ) || ( elapsed < 0 ) )
-          return OperationInterrupted; // it's taking too long, will continue later.  
+          return OperationInterrupted; // it's taking too long, will continue later.
       break;
       case OperationCompletedClean:
         // no children were dirty
@@ -861,7 +861,7 @@
       {
         elapsed = tStart.msecsTo( QTime::currentTime() );
         if ( ( elapsed > gUpdateCountsProcessingInterval ) || ( elapsed < 0 ) )
-          return OperationInterrupted; // it's taking too long, will continue later.  
+          return OperationInterrupted; // it's taking too long, will continue later.
       }
     }
   }
@@ -997,7 +997,7 @@
 
   if ( notifyManager )
     mManager->viewFolderActivated( this, folder, middleButton );
- 
+
   if ( folder )
   {
     // update counts up to top-level parent
@@ -1007,7 +1007,7 @@
          break; // nothing has changed at this level: parents can't change
       fvi = static_cast< FolderViewItem * >( static_cast< QTreeWidgetItem *>( fvi )->parent() );
     }
-    
+
   }
 
   updateCopyActions();
@@ -1071,7 +1071,7 @@
       {
         // yes, it can happen
         bCanMove = false; // stay safe
-        break; 
+        break;
       }
 
       if( !( *it )->isMoveable() )
@@ -1201,7 +1201,7 @@
   tip += QString::fromLatin1(
           "</td>" \
           "<td align=\"right\" valign=\"top\">" \
-            "<table border=\"0\"><tr><td width=\"32\" height=\"32\" align=\"center\" valign=\"middle\">" 
+            "<table border=\"0\"><tr><td width=\"32\" height=\"32\" align=\"center\" valign=\"middle\">"
               "<img src=\"%1\">" \
             "</td></tr></table>" \
           "</td>" \
@@ -1215,7 +1215,7 @@
 
   QToolTip::showText( he->globalPos(), tip, viewport(), visualItemRect( it ) );
 
-  return true;  
+  return true;
 }
 
 bool FolderView::fillHeaderContextMenu( KMenu * menu, const QPoint &clickPoint )
@@ -1353,7 +1353,7 @@
 {
   if ( multiSelection )
     return; // no multiSelection Account Related actions
- 
+
   KMFolder *folder = item->folder();
 
   if ( !folder )
@@ -1399,7 +1399,7 @@
 {
   if ( multiSelection )
     return; // no multiSelection Account Related actions
- 
+
   KMFolder *folder = item->folder();
 
   if ( !folder )
@@ -2182,7 +2182,7 @@
   } else {
     // FIXME: anybody sets this option to false ?
     if ( GlobalSettings::self()->showPopupAfterDnD() || alwaysAsk )
-    { 
+    {
       KMenu menu;
       QAction *moveAction = menu.addAction( KIcon( "go-jump"), i18n( "&Move Here" ) );
       if ( ! canMove )
@@ -2312,7 +2312,7 @@
 
     e->acceptProposedAction();
   } else
-    e->ignore(); 
+    e->ignore();
 }
 
 
@@ -2402,7 +2402,7 @@
   // First of all call the base class implementation in order to
   // handle scrolling and item expanding
   FolderTreeWidget::dragMoveEvent( e );
- 
+
   if ( e->mimeData()->hasFormat( DraggedFolderList::mimeDataType() ) )
     handleFoldersDragMoveEvent( e );
   else if ( e->mimeData()->hasFormat( KPIM::MailList::mimeDataType() ) )
@@ -2454,7 +2454,7 @@
         static_cast<QTreeWidgetItem *>( fvi )->parent()
       )
     )
-    return; 
+    return;
 
   if ( folder->getSubfolderState() != KMFolderImap::imapNoInformation )
     return;
@@ -2462,7 +2462,7 @@
   // the tree will be reloaded after that
   bool success = folder->listDirectory();
   if (!success)
-    fvi->setExpanded( false ); // failed to list the directory 
+    fvi->setExpanded( false ); // failed to list the directory
 
   if ( ( fvi->childCount() == 0 ) && static_cast<QTreeWidgetItem *>( fvi )->parent() )
     fvi->setChildIndicatorPolicy( QTreeWidgetItem::DontShowIndicatorWhenChildless ); // no children after listing
@@ -2547,7 +2547,7 @@
           depth++;
         }
         QString prefix;
-        prefix.fill( ' ', 2 * depth );   
+        prefix.fill( ' ', 2 * depth );
         folderNames->append( prefix + fvi->labelText() );
       } else {
         folderNames->append( fvi->labelText() );
@@ -2568,7 +2568,7 @@
   if ( !item->folder() )
     return;
   if ( item->folder()->folderType() != KMFolderTypeImap )
-    return; 
+    return;
 
   KMFolderImap *folder = static_cast< KMFolderImap * >( item->folder()->storage() );
   folder->setSubfolderState( KMFolderImap::imapNoInformation );
@@ -2662,7 +2662,11 @@
         icon = "document-new";
       break;
       default:
-        icon = kmkernel->iCalIface().folderPixmap( folderType() );
+      {
+        //If not a resource folder don't try to use icalIface folder pixmap
+        if(kmkernel->iCalIface().isResourceFolder( mFolder ))
+          icon = kmkernel->iCalIface().folderPixmap( folderType() );
+      }
       break;
     }
 
@@ -2711,7 +2715,9 @@
     if ( fld && fld->noContent() )
       icon = "folder-open-grey";
     else {
-      icon = kmkernel->iCalIface().folderPixmap( folderType() );
+      //If not a resource folder don't try to use icalIface folder pixmap
+      if(kmkernel->iCalIface().isResourceFolder( mFolder ))
+        icon = kmkernel->iCalIface().folderPixmap( folderType() );
       if ( icon.isEmpty() )
          icon = "folder-open";
     }
@@ -2736,7 +2742,7 @@
   if ( protocol() == Search )
     return "Folder_search";     // FIXME: Why we're using a different prefix here ? Folder-Virtual-Search wouldn't be nice ?
 
-  return QString();  
+  return QString();
 }
 
 void FolderViewItem::slotIconsChanged()
Index: kmail/kmmsgpartdlg.cpp
===================================================================
--- kmail/kmmsgpartdlg.cpp	(.../tags/KDE/4.2.2/kdepim)	(wersja 952918)
+++ kmail/kmmsgpartdlg.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 952918)
@@ -38,10 +38,10 @@
   KMMsgPartDialog::Encoding encoding;
   const char * displayName;
 } encodingTypes[] = {
-  { KMMsgPartDialog::SevenBit, I18N_NOOP("None (7-bit text)") },
-  { KMMsgPartDialog::EightBit, I18N_NOOP("None (8-bit text)") },
-  { KMMsgPartDialog::QuotedPrintable, I18N_NOOP("Quoted Printable") },
-  { KMMsgPartDialog::Base64, I18N_NOOP2("Base 64 message encoding.", "Base 64") },
+  { KMMsgPartDialog::SevenBit, I18N_NOOP2("message encoding type", "None (7-bit text)") },
+  { KMMsgPartDialog::EightBit, I18N_NOOP2("message encoding type", "None (8-bit text)") },
+  { KMMsgPartDialog::QuotedPrintable, I18N_NOOP2("message encoding type", "Quoted Printable") },
+  { KMMsgPartDialog::Base64, I18N_NOOP2("message encoding type", "Base 64") },
 };
 static const int numEncodingTypes =
   sizeof encodingTypes / sizeof *encodingTypes;
@@ -64,7 +64,7 @@
   setHelp( QString::fromLatin1("attachments") );
 
   for ( int i = 0 ; i < numEncodingTypes ; ++i )
-    mI18nizedEncodings << i18n( encodingTypes[i].displayName );
+    mI18nizedEncodings << i18nc( "message encoding type", encodingTypes[i].displayName );
   QFrame *frame = new QFrame( this );
   setMainWidget( frame );
   glay = new QGridLayout(frame );
Index: knode/knarticlefilter.cpp
===================================================================
--- knode/knarticlefilter.cpp	(.../tags/KDE/4.2.2/kdepim)	(wersja 952918)
+++ knode/knarticlefilter.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 952918)
@@ -75,7 +75,8 @@
 bool KNArticleFilter::loadInfo()
 {
   if (i_d!=-1) {
-    QString fname(KStandardDirs::locate("data",QString( "knode/filters/%1.fltr" ).arg(i_d) ) );
+    QString fname( KStandardDirs::locate( "data",
+                                          QString( "knode/filters/%1.fltr" ).arg( i_d ) ) );
 
     if (fname.isNull())
       return false;
@@ -95,7 +96,7 @@
 
 void KNArticleFilter::load()
 {
-  QString fname(KStandardDirs::locate("data",QString( "knode/filters/%1.fltr").arg(i_d) ) );
+  QString fname(KStandardDirs::locate( "data", QString( "knode/filters/%1.fltr" ).arg( i_d ) ) );
 
   if (fname.isNull())
     return;
@@ -137,7 +138,7 @@
 {
   if (i_d==-1)
     return;
-  QString dir(KStandardDirs::locateLocal("data","knode/")+"filters/");
+  QString dir( KStandardDirs::locateLocal( "data", "knode/filters/" ) );
   if (dir.isNull()) {
     KNHelper::displayInternalFileError();
     return;
Index: knode/articlewidget.cpp
===================================================================
--- knode/articlewidget.cpp	(.../tags/KDE/4.2.2/kdepim)	(wersja 952918)
+++ knode/articlewidget.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 952918)
@@ -133,8 +133,12 @@
   mInstances.removeAll( this );
   delete mTimer;
   delete mCSSHelper;
-  if ( mArticle && mArticle->isOrphant() )
+  if ( mArticle && mArticle->isOrphant() ) {
+    // if the article manager is still loading the current article,
+    // cancel the job.
+    knGlobals.articleManager()->cancelJobs( mArticle );
     delete mArticle;
+  }
   removeTempFiles();
 }
 
Index: knode/knfiltermanager.cpp
===================================================================
--- knode/knfiltermanager.cpp	(.../tags/KDE/4.2.2/kdepim)	(wersja 952918)
+++ knode/knfiltermanager.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 952918)
@@ -105,7 +105,7 @@
 
 void KNFilterManager::loadFilters()
 {
-  QString fname(KStandardDirs::locate("data","knode/filters/filters.rc") );
+  QString fname( KStandardDirs::locate( "data","knode/filters/filters.rc" ) );
 
   if (!fname.isNull()) {
     KConfig conf( fname, KConfig::SimpleConfig);
@@ -128,7 +128,7 @@
 
 void KNFilterManager::saveFilterLists()
 {
-  QString dir(KStandardDirs::locateLocal("data","knode/")+"filters/");
+  QString dir( KStandardDirs::locateLocal( "data","knode/filters/" ) );
 
   if (dir.isNull()) {
     KNHelper::displayInternalFileError();
Index: knode/knjobdata.cpp
===================================================================
--- knode/knjobdata.cpp	(.../tags/KDE/4.2.2/kdepim)	(wersja 952918)
+++ knode/knjobdata.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 952918)
@@ -54,7 +54,17 @@
     processJob( j );
 }
 
+void KNJobConsumer::cancelJobs( KNJobItem *item )
+{
+  Q_FOREACH( KNJobData *job, mJobs ) {
+    if ( job->data() == item ) {
+      job->d_ata = 0;
+      job->cancel();
+    }
+  }
+}
 
+
 void KNJobConsumer::processJob( KNJobData *j )
 {
   delete j;
@@ -77,7 +87,9 @@
 
 KNJobData::~KNJobData()
 {
-  d_ata->setLocked(false);
+  if ( d_ata ) {
+    d_ata->setLocked( false );
+  }
 }
 
 
@@ -131,6 +143,7 @@
         job->addMetaData( "tls", "off" );
     }
   }
+  job->setUiDelegate(0);
   setupKJob( job );
 }
 
Index: knode/kncomposer.cpp
===================================================================
--- knode/kncomposer.cpp	(.../tags/KDE/4.2.2/kdepim)	(wersja 952918)
+++ knode/kncomposer.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 952918)
@@ -515,7 +515,7 @@
   QWidget* fw = focusWidget();
   if (!fw) return;
 
-  if (fw->inherits("KEdit"))
+  if (fw->inherits("KTextEdit"))
     ((KTextEdit*)fw)->cut();
   else if (fw->inherits("QLineEdit"))
     ((QLineEdit*)fw)->cut();
Index: knode/knconfig.cpp
===================================================================
--- knode/knconfig.cpp	(.../tags/KDE/4.2.2/kdepim)	(wersja 952918)
+++ knode/knconfig.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 952918)
@@ -219,7 +219,7 @@
 
 KNode::DisplayedHeaders::DisplayedHeaders()
 {
-  QString fname( KStandardDirs::locate("data","knode/headers.rc") );
+  QString fname( KStandardDirs::locate( "data","knode/headers.rc" ) );
 
   if (!fname.isNull()) {
     KConfig headerConf( fname, KConfig::SimpleConfig);
@@ -266,7 +266,7 @@
 
   kDebug(5003) <<"KNConfig::DisplayedHeaders::save()";
 
-  QString dir(KStandardDirs::locateLocal("data","knode/"));
+  QString dir( KStandardDirs::locateLocal( "data", "knode/" ) );
   if (dir.isNull()) {
     KNHelper::displayInternalFileError();
     return;
Index: knode/knfoldermanager.cpp
===================================================================
--- knode/knfoldermanager.cpp	(.../tags/KDE/4.2.2/kdepim)	(wersja 952918)
+++ knode/knfoldermanager.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 952918)
@@ -35,7 +35,7 @@
 KNFolderManager::KNFolderManager(KNArticleManager *a) : a_rtManager(a)
 {
   //standard folders
-  QString dir(KStandardDirs::locateLocal("data","knode/")+"folders/");
+  QString dir( KStandardDirs::locateLocal( "data", "knode/folders/" ) );
   if (dir.isNull()) {
     KNHelper::displayInternalFileError();
     return;
@@ -422,7 +422,7 @@
 
 void KNFolderManager::syncFolders()
 {
-  QString dir(KStandardDirs::locateLocal("data","knode/")+"folders/");
+  QString dir( KStandardDirs::locateLocal( "data", "knode/folders/" ) );
   if (dir.isNull()) {
     KNHelper::displayInternalFileError();
     return;
@@ -440,7 +440,7 @@
 int KNFolderManager::loadCustomFolders()
 {
   int cnt=0;
-  QString dir(KStandardDirs::locateLocal("data","knode/")+"folders/");
+  QString dir( KStandardDirs::locateLocal( "data", "knode/folders/" ) );
   KNFolder *f;
 
   if (dir.isNull()) {
Index: knode/knnntpaccount.cpp
===================================================================
--- knode/knnntpaccount.cpp	(.../tags/KDE/4.2.2/kdepim)	(wersja 952918)
+++ knode/knnntpaccount.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 952918)
@@ -174,7 +174,7 @@
 
 QString KNNntpAccount::path()
 {
-  QString dir(KStandardDirs::locateLocal("data","knode/")+QString("nntp.%1/").arg(i_d));
+  QString dir( KStandardDirs::locateLocal( "data", QString( "knode/nntp.%1/" ).arg( i_d ) ) );
   if (dir.isNull())
     KNHelper::displayInternalFileError();
   return (dir);
Index: knode/knfolder.cpp
===================================================================
--- knode/knfolder.cpp	(.../tags/KDE/4.2.2/kdepim)	(wersja 952918)
+++ knode/knfolder.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 952918)
@@ -97,7 +97,7 @@
 
 QString KNFolder::path()
 {
-  QString dir(KStandardDirs::locateLocal("data","knode/")+"folders/");
+  QString dir( KStandardDirs::locateLocal( "data", "knode/folders/" ) );
   /*if (dir.isNull())
     KNHelper::displayInternalFileError();*/
   return dir;
Index: knode/knjobdata.h
===================================================================
--- knode/knjobdata.h	(.../tags/KDE/4.2.2/kdepim)	(wersja 952918)
+++ knode/knjobdata.h	(.../branches/KDE/4.2/kdepim)	(wersja 952918)
@@ -29,6 +29,7 @@
 class Job;
 }
 
+class KNJobItem;
 class KNJobData;
 class KNServerInfo;
 
@@ -55,6 +56,10 @@
      */
     bool jobsPending() const { return !mJobs.isEmpty(); }
 
+    /** Find any job related to a job item and cancel it.
+     */
+    void cancelJobs( KNJobItem *item );
+
   protected:
     /** The actual work is done here */
     virtual void processJob(KNJobData *j);
Index: knode/knconvert.cpp
===================================================================
--- knode/knconvert.cpp	(.../tags/KDE/4.2.2/kdepim)	(wersja 952918)
+++ knode/knconvert.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 952918)
@@ -184,7 +184,7 @@
       return;
     }
 
-    QString dataDir=KStandardDirs::locateLocal("data","knode/");
+    QString dataDir = KStandardDirs::locateLocal( "data", "knode/" );
     t_ar=new KProcess;
     *t_ar << "tar";
     *t_ar << "-cz" << dataDir
@@ -251,7 +251,7 @@
 
 bool KNConvert::Converter04::doConvert()
 {
-  QString dir=KStandardDirs::locateLocal("data","knode/")+"folders/";
+  QString dir = KStandardDirs::locateLocal( "data", "knode/folders/" );
   int num;
   bool error=false;
 
Index: knode/knaccountmanager.cpp
===================================================================
--- knode/knaccountmanager.cpp	(.../tags/KDE/4.2.2/kdepim)	(wersja 952918)
+++ knode/knaccountmanager.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 952918)
@@ -60,7 +60,7 @@
 
 void KNAccountManager::loadAccounts()
 {
-  QString dir(KStandardDirs::locateLocal("data","knode/"));
+  QString dir( KStandardDirs::locateLocal( "data", "knode/" ) );
   if (dir.isNull()) {
     KNHelper::displayInternalFileError();
     return;
@@ -105,7 +105,7 @@
 bool KNAccountManager::newAccount(KNNntpAccount *a)
 {
   // find a unused id for the new account...
-  QString dir(KStandardDirs::locateLocal("data","knode/"));
+  QString dir( KStandardDirs::locateLocal( "data", "knode/" ) );
   if (dir.isNull()) {
     delete a;
     KNHelper::displayInternalFileError();
@@ -120,7 +120,7 @@
 
   a->setId(id);
 
-  dir = KStandardDirs::locateLocal("data",QString("knode/nntp.%1/").arg(a->id()));
+  dir = KStandardDirs::locateLocal( "data", QString( "knode/nntp.%1/" ).arg( a->id() ) );
   if (!dir.isNull()) {
     mAccounts.append(a);
     emit(accountAdded(a));
Index: doc/kalarm/mainwindow.png
===================================================================
Nie można wyświetlić: plik binarny.
svn:mime-type = image/png
Index: doc/kalarm/alarmmessage.png
===================================================================
Nie można wyświetlić: plik binarny.
svn:mime-type = image/png
Index: kalarm/kalarm.h
===================================================================
--- kalarm/kalarm.h	(.../tags/KDE/4.2.2/kdepim)	(wersja 952918)
+++ kalarm/kalarm.h	(.../branches/KDE/4.2/kdepim)	(wersja 952918)
@@ -23,7 +23,7 @@
 
 #undef QT3_SUPPORT
 
-#define KALARM_VERSION "2.1.6"
+#define KALARM_VERSION "2.1.7"
 #define KALARM_NAME "KAlarm"
 #define KALARM_DBUS_SERVICE  "org.kde.kalarm"  // D-Bus service name of KAlarm application
 
Index: kalarm/eventlistmodel.cpp
===================================================================
--- kalarm/eventlistmodel.cpp	(.../tags/KDE/4.2.2/kdepim)	(wersja 952918)
+++ kalarm/eventlistmodel.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 952918)
@@ -95,7 +95,7 @@
 		mTextIcon    = new QPixmap(SmallIcon("dialog-information"));
 		mFileIcon    = new QPixmap(SmallIcon("document-open"));
 		mCommandIcon = new QPixmap(SmallIcon("system-run"));
-		mEmailIcon   = new QPixmap(SmallIcon("mail-message-new"));
+		mEmailIcon   = new QPixmap(SmallIcon("mail-message-unread"));
 		mIconSize = mTextIcon->size().expandedTo(mFileIcon->size()).expandedTo(mCommandIcon->size()).expandedTo(mEmailIcon->size());
 	}
 	MinuteTimer::connect(this, SLOT(slotUpdateTimeTo()));
Index: kalarm/Changelog
===================================================================
--- kalarm/Changelog	(.../tags/KDE/4.2.2/kdepim)	(wersja 952918)
+++ kalarm/Changelog	(.../branches/KDE/4.2/kdepim)	(wersja 952918)
@@ -1,6 +1,11 @@
 KAlarm Change Log
 
-=== Version 2.1.6 --- 4 March 2009 ===
+=== Version 2.1.7 --- 28 March 2009 ===
+Fix recurring alarms being missed when deferred to earlier than next due alarm,
+  when next due alarm is earlier than the next recurrence.
+
+=== Version 2.1.6 (KDE 4.2.2) --- 18 March 2009 ===
+Fix memory leaks.
 Fix crash when KAlarm quits.
 
 === Version 2.1.5 (KDE 4.2.1) --- 7 February 2009 ===
Index: kalarm/alarmcalendar.cpp
===================================================================
--- kalarm/alarmcalendar.cpp	(.../tags/KDE/4.2.2/kdepim)	(wersja 952918)
+++ kalarm/alarmcalendar.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 952918)
@@ -944,12 +944,7 @@
 			evnt->clearUpdated();
 			if (kaevnt != evnt)
 				*kaevnt = *evnt;   // update the event instance in our lists, keeping the same pointer
-			for (EarliestMap::Iterator eit = mEarliestAlarm.begin();  eit != mEarliestAlarm.end();  ++eit)
-				if (eit.value() == kaevnt)
-				{
-					findEarliestAlarm(eit.key());
-					break;
-				}
+			findEarliestAlarm(AlarmResources::instance()->resource(kcalEvent));
 			return kaevnt;
 		}
 	}
Index: kaddressbook/undocmds.cpp
===================================================================
--- kaddressbook/undocmds.cpp	(.../tags/KDE/4.2.2/kdepim)	(wersja 952918)
+++ kaddressbook/undocmds.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 952918)
@@ -26,6 +26,7 @@
 
 #include <QtGui/QApplication>
 #include <QtGui/QClipboard>
+#include <QMimeData>
 
 #include <kabc/resource.h>
 #include <kapplication.h>
@@ -323,11 +324,12 @@
     lock()->unlock( addr.resource() );
   }
 
-  // Convert to clipboard
-  mClipText = AddresseeUtil::addresseesToClipboard( mAddresseeList );
-
   QClipboard *cb = QApplication::clipboard();
   mOldText = cb->text();
   kapp->processEvents();
-  cb->setText( mClipText );
+  // Convert to clipboard
+  mClipText = AddresseeUtil::addresseesToClipboard( mAddresseeList );
+  QMimeData *data = new QMimeData();
+  data->setData( "text/directory", mClipText );
+  cb->setMimeData( data );
 }
Index: kaddressbook/views/cardview.cpp
===================================================================
--- kaddressbook/views/cardview.cpp	(.../tags/KDE/4.2.2/kdepim)	(wersja 952918)
+++ kaddressbook/views/cardview.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 952918)
@@ -57,6 +57,7 @@
       setFrameStyle( Panel | Plain );
       setMidLineWidth( 0 );
       setIndent( 1 );
+      setAutoFillBackground( true );
     }
 
     ~CardViewTip() {}
Index: kaddressbook/undocmds.h
===================================================================
--- kaddressbook/undocmds.h	(.../tags/KDE/4.2.2/kdepim)	(wersja 952918)
+++ kaddressbook/undocmds.h	(.../branches/KDE/4.2/kdepim)	(wersja 952918)
@@ -110,7 +110,7 @@
   private:
     KABC::Addressee::List mAddresseeList;
     QStringList mUIDList;
-    QString mClipText;
+    QByteArray mClipText;
     QString mOldText;
 };
 
Index: kaddressbook/xxport/gmx_xxport.desktop
===================================================================
--- kaddressbook/xxport/gmx_xxport.desktop	(.../tags/KDE/4.2.2/kdepim)	(wersja 952918)
+++ kaddressbook/xxport/gmx_xxport.desktop	(.../branches/KDE/4.2/kdepim)	(wersja 952918)
@@ -42,6 +42,7 @@
 Comment[da]=Plugin til at importere og eksportere kontakter i GMX's adressebogsformat
 Comment[de]=Modul für Import/Export von Kontakten im GMX-Adressbuchformat
 Comment[el]=Πρόσθετο για εισαγωγή και εξαγωγή επαφών μορφής GMX
+Comment[en_GB]=Plugin to import and export contacts in GMX's address book format
 Comment[es]=Complemento para importar y exportar contactos en el formato de libreta de direcciones de GMX
 Comment[et]=Plugin kontaktide importimiseks ja eksportimiseks GMX aadressiraamatu vormingus
 Comment[fa]=وصله برای واردات و صادرات تماسها در قالب کتاب نشانی GMX
Index: kaddressbook/xxport/kde2_xxport.cpp
===================================================================
--- kaddressbook/xxport/kde2_xxport.cpp	(.../tags/KDE/4.2.2/kdepim)	(wersja 952918)
+++ kaddressbook/xxport/kde2_xxport.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 952918)
@@ -66,9 +66,10 @@
     proc << "--override";
   } else if ( result == KMessageBox::No )
     proc << "kab2kabc";
-  else
+  else {
     kDebug(5720) <<"KAddressBook::importKDE2(): Unknow return value.";
-
+    return KABC::AddresseeList();
+  }
   proc.execute();
 
   addressBook()->load();
Index: kaddressbook/searchmanager.cpp
===================================================================
--- kaddressbook/searchmanager.cpp	(.../tags/KDE/4.2.2/kdepim)	(wersja 952918)
+++ kaddressbook/searchmanager.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 952918)
@@ -25,6 +25,65 @@
 
 #include <kabc/addresseelist.h>
 
+static QStringList phoneNumberValues( const KABC::Addressee &addressee,
+                                      KABC::PhoneNumber::Type type )
+{
+  QStringList result;
+
+  const KABC::PhoneNumber::List list = addressee.phoneNumbers( type );
+  foreach ( const KABC::PhoneNumber &number, list ) {
+    result << number.number();
+  }
+
+  return result;
+}
+
+typedef QString (KABC::Address::*AddressQStringGetter)() const;
+
+static QStringList addressValues( const KABC::Addressee &addressee,
+                                  KABC::Address::Type type,
+                                  AddressQStringGetter getter )
+{
+  QStringList result;
+
+  const KABC::Address::List list = addressee.addresses( type );
+  foreach ( const KABC::Address &address, list ) {
+    result << (address.*getter)();
+  }
+
+  return result;
+}
+
+static QStringList addressStreetValues( const KABC::Addressee &addressee,
+                                        KABC::Address::Type type )
+{
+  return addressValues( addressee, type, &KABC::Address::street );
+}
+
+static QStringList addressLocalityValues( const KABC::Addressee &addressee,
+                                          KABC::Address::Type type )
+{
+  return addressValues( addressee, type, &KABC::Address::locality );
+}
+
+static QStringList addressRegionValues( const KABC::Addressee &addressee,
+                                        KABC::Address::Type type )
+{
+  return addressValues( addressee, type, &KABC::Address::region );
+}
+
+static QStringList addressCountryValues( const KABC::Addressee &addressee,
+                                         KABC::Address::Type type )
+{
+  return addressValues( addressee, type, &KABC::Address::country );
+}
+
+static QStringList addressPostalCodeValues( const KABC::Addressee &addressee,
+                                            KABC::Address::Type type )
+{
+  return addressValues( addressee, type, &KABC::Address::postalCode );
+}
+
 using namespace KAB;
 
 SearchManager::SearchManager( KABC::AddressBook *ab,
@@ -92,26 +151,73 @@
     KABC::Field::List::ConstIterator fieldIt( fieldList.begin() );
     const KABC::Field::List::ConstIterator fieldEndIt( fieldList.end() );
     for ( ; fieldIt != fieldEndIt; ++fieldIt ) {
-
-      if ( type == StartsWith && (*fieldIt)->value( *it ).startsWith( pattern, Qt::CaseInsensitive ) ) {
+      QStringList values;
+      if ( (*fieldIt)->label() == KABC::Addressee::homeAddressStreetLabel() ) {
+        values = addressStreetValues( *it, KABC::Address::Home );
+      } else if ( (*fieldIt)->label() == KABC::Addressee::homeAddressLocalityLabel() ) {
+        values = addressLocalityValues( *it, KABC::Address::Home );
+      } else if ( (*fieldIt)->label() == KABC::Addressee::homeAddressRegionLabel() ) {
+        values = addressRegionValues( *it, KABC::Address::Home );
+      } else if ( (*fieldIt)->label() == KABC::Addressee::homeAddressCountryLabel() ) {
+        values = addressCountryValues( *it, KABC::Address::Home );
+      } else if ( (*fieldIt)->label() == KABC::Addressee::homeAddressPostalCodeLabel() ) {
+        values = addressPostalCodeValues( *it, KABC::Address::Home );
+      } else if ( (*fieldIt)->label() == KABC::Addressee::businessAddressStreetLabel() ) {
+        values = addressStreetValues( *it, KABC::Address::Work );
+      } else if ( (*fieldIt)->label() == KABC::Addressee::businessAddressLocalityLabel() ) {
+        values = addressLocalityValues( *it, KABC::Address::Work );
+      } else if ( (*fieldIt)->label() == KABC::Addressee::businessAddressRegionLabel() ) {
+        values = addressRegionValues( *it, KABC::Address::Work );
+      } else if ( (*fieldIt)->label() == KABC::Addressee::businessAddressCountryLabel() ) {
+        values = addressCountryValues( *it, KABC::Address::Work );
+      } else if ( (*fieldIt)->label() == KABC::Addressee::businessAddressPostalCodeLabel() ) {
+        values = addressPostalCodeValues( *it, KABC::Address::Work );
+      } else if ( (*fieldIt)->label() == KABC::Addressee::homePhoneLabel() ) {
+        values = phoneNumberValues( *it, KABC::PhoneNumber::Home );
+      } else if ( (*fieldIt)->label() == KABC::Addressee::businessPhoneLabel() ) {
+        values = phoneNumberValues( *it, KABC::PhoneNumber::Work );
+      } else if ( (*fieldIt)->label() == KABC::Addressee::carPhoneLabel() ) {
+        values = phoneNumberValues( *it, KABC::PhoneNumber::Car );
+      } else if ( (*fieldIt)->label() == KABC::Addressee::isdnLabel() ) {
+        values = phoneNumberValues( *it, KABC::PhoneNumber::Isdn );
+      } else if ( (*fieldIt)->label() == KABC::Addressee::pagerLabel() ) {
+        values = phoneNumberValues( *it, KABC::PhoneNumber::Pager );
+      } else if ( (*fieldIt)->label() == KABC::Addressee::mobilePhoneLabel() ) {
+        values = phoneNumberValues( *it, KABC::PhoneNumber::Cell );
+      } else if ( (*fieldIt)->label() == KABC::Addressee::homeFaxLabel() ) {
+        values = phoneNumberValues( *it, KABC::PhoneNumber::Home | KABC::PhoneNumber::Fax );
+      } else if ( (*fieldIt)->label() == KABC::Addressee::businessFaxLabel() ) {
+        values = phoneNumberValues( *it, KABC::PhoneNumber::Work | KABC::PhoneNumber::Fax);
+      } else if ( (*fieldIt)->label() == KABC::Addressee::emailLabel() ) {
+        values = (*it).emails();
+      } else {
+        values << (*fieldIt)->value( *it );
+      }
+      foreach ( const QString &value, values ) {
+        if ( type == StartsWith && value.startsWith( pattern, Qt::CaseInsensitive ) ) {
         mContacts.append( *it );
         found = true;
         break;
-      } else if ( type == EndsWith && (*fieldIt)->value( *it ).endsWith( pattern, Qt::CaseInsensitive ) ) {
+        } else if ( type == EndsWith && value.endsWith( pattern, Qt::CaseInsensitive ) ) {
         mContacts.append( *it );
         found = true;
         break;
-      } else if ( type == Contains && (*fieldIt)->value( *it ).contains( pattern, Qt::CaseInsensitive ) ) {
+        } else if ( type == Contains && value.contains( pattern, Qt::CaseInsensitive ) ) {
         mContacts.append( *it );
         found = true;
         break;
-      } else if ( type == Equals && (*fieldIt)->value( *it ).localeAwareCompare( pattern ) == 0 ) {
+        } else if ( type == Equals && value.localeAwareCompare( pattern ) == 0 ) {
         mContacts.append( *it );
         found = true;
         break;
       }
     }
 
+      if ( found ) {
+        break;
+      }
+    }
+
     if ( !found ) {
       // search over custom fields
       const QStringList customs = (*it).customs();
Index: kaddressbook/kabcore.cpp
===================================================================
--- kaddressbook/kabcore.cpp	(.../tags/KDE/4.2.2/kdepim)	(wersja 952918)
+++ kaddressbook/kabcore.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 952918)
@@ -519,9 +519,9 @@
 
 void KABCore::cutContacts()
 {
-  QStringList uidList = mViewManager->selectedUids();
+  const QStringList uidList = mViewManager->selectedUids();
 
-  if ( uidList.size() > 0 ) {
+  if ( !uidList.isEmpty() ) {
     CutCommand *command = new CutCommand( mAddressBook, uidList );
     mCommandHistory->push( command );
 
Index: kaddressbook/addresseeeditorextension.h
===================================================================
--- kaddressbook/addresseeeditorextension.h	(.../tags/KDE/4.2.2/kdepim)	(wersja 952918)
+++ kaddressbook/addresseeeditorextension.h	(.../branches/KDE/4.2/kdepim)	(wersja 952918)
@@ -52,10 +52,12 @@
     virtual QString identifier() const;
 
     QSize minimumSizeHint() const;
-
+  private slots:
+    void emitModifiedAddresses();
   private:
     AddresseeEditorBase *mAddresseeEditor;
     bool mDirty;
+    KABC::Addressee::List addressees;
 };
 
 #endif
Index: kaddressbook/addresseeeditorextension.cpp
===================================================================
--- kaddressbook/addresseeeditorextension.cpp	(.../tags/KDE/4.2.2/kdepim)	(wersja 952918)
+++ kaddressbook/addresseeeditorextension.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 952918)
@@ -24,6 +24,7 @@
 #include "addresseeeditorextension.h"
 
 #include <QtGui/QVBoxLayout>
+#include <QTimer>
 
 #include <klocale.h>
 
@@ -51,17 +52,22 @@
 void AddresseeEditorExtension::contactsSelectionChanged()
 {
   const KABC::Addressee::List selectedAddressees = selectedContacts();
-  KABC::Addressee::List addressees;
-
+  KABC::Addressee::List modifiedAddress;
   if ( mAddresseeEditor->dirty() ) {
     mAddresseeEditor->save();
     addressees.append( mAddresseeEditor->addressee() );
-    emit modified( addressees );
+    modifiedAddress = addressees;
+    QTimer::singleShot(0, this, SLOT(emitModifiedAddresses()));
   }
   if( !selectedAddressees.isEmpty())
       mAddresseeEditor->setAddressee( selectedAddressees[ 0 ] );
 }
 
+void AddresseeEditorExtension::emitModifiedAddresses()
+{
+  emit modified( addressees );
+}
+
 QString AddresseeEditorExtension::title() const
 {
   return i18n( "Contact Editor" );
Index: ksendemail/mailerservice.cpp
===================================================================
--- ksendemail/mailerservice.cpp	(.../tags/KDE/4.2.2/kdepim)	(wersja 952918)
+++ ksendemail/mailerservice.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 952918)
@@ -147,8 +147,20 @@
     {
         mailto = true;
         for ( QStringList::Iterator it = attachList.begin() ; it != attachList.end() ; ++it )
+        {
             if ( !(*it).isEmpty() )
+            {
+              KUrl url( *it );
+
+              if ( url.protocol().isEmpty() )
+              {
+                const QString newUrl =  QDir::currentPath () + QDir::separator () + url.fileName();
+                attachURLs.append( newUrl );
+              }
+              else
                 attachURLs.append( *it );
+            }
+        }
     }
 
     customHeaders = args->getOptionList("header");
Index: ktimetracker/kcmconfigs/ktimetrackerconfig.desktop
===================================================================
--- ktimetracker/kcmconfigs/ktimetrackerconfig.desktop	(.../tags/KDE/4.2.2/kdepim)	(wersja 952918)
+++ ktimetracker/kcmconfigs/ktimetrackerconfig.desktop	(.../branches/KDE/4.2/kdepim)	(wersja 952918)
@@ -24,6 +24,7 @@
 Comment[da]=Indstil KTimeTracker
 Comment[de]=KDE-Zeitplaner einrichten
 Comment[el]=Ρύθμιση του ktimetracker
+Comment[en_GB]=Configure KTimeTracker
 Comment[es]=Configurar ktimetracker
 Comment[et]=KTimeTrackeri seadistamine
 Comment[fr]=Configurer KTimeTracker
Index: libkdepim/addresseelineedit.cpp
===================================================================
--- libkdepim/addresseelineedit.cpp	(.../tags/KDE/4.2.2/kdepim)	(wersja 952918)
+++ libkdepim/addresseelineedit.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 952918)
@@ -747,6 +747,12 @@
 
 void AddresseeLineEdit::slotStartLDAPLookup()
 {
+  KGlobalSettings::Completion  mode = completionMode();
+
+  if ( mode == KGlobalSettings::CompletionNone ) {
+    return;
+  }
+
   if ( !s_LDAPSearch->isAvailable() ) {
     return;
   }
Index: kpilot/conduits/contacts/kpilot-conduit-contacts.desktop
===================================================================
--- kpilot/conduits/contacts/kpilot-conduit-contacts.desktop	(.../tags/KDE/4.2.2/kdepim)	(wersja 952918)
+++ kpilot/conduits/contacts/kpilot-conduit-contacts.desktop	(.../branches/KDE/4.2/kdepim)	(wersja 952918)
@@ -5,6 +5,7 @@
 Comment[da]=Denne kanal synkroniserer den håndholdtes adressebogs-database med en Akonadi-samling.
 Comment[de]=Abgleich der Adressbücher von Taschencomputer und Akonadi-Ressourcen.
 Comment[el]=Αυτό το κύκλωμα συγχρονίζει το βιβλίο διευθύνσεων του υπολογιστή παλάμης με μια συλλογή του Akonadi.
+Comment[en_GB]=This conduit syncs the handheld address book database with an Akonadi collection.
 Comment[es]=Este conducto sincroniza la base de datos de la libreta de direcciones de la agenda electrónica con una colección Akonadi.
 Comment[et]=See kanal sünkroniseerib pihuarvuti aadressiraamatu andmebaasi Akonadi koguga.
 Comment[fr]=Ce canal synchronise le carnet d'adresse du périphérique avec une collection Akonadi.
Index: kpilot/Documentation/base-conduit-template/contacts-conduit.desktop
===================================================================
--- kpilot/Documentation/base-conduit-template/contacts-conduit.desktop	(.../tags/KDE/4.2.2/kdepim)	(wersja 952918)
+++ kpilot/Documentation/base-conduit-template/contacts-conduit.desktop	(.../branches/KDE/4.2/kdepim)	(wersja 952918)
@@ -5,6 +5,7 @@
 Comment[da]=Denne kanal synkroniserer den håndholdtes adressebog med en database lagret på pc'en.
 Comment[de]=Abgleich des Addressbuchs von Taschencomputer und PC.
 Comment[el]=Αυτό το κύκλωμα συγχρονίζει το βιβλίο διευθύνσεων του υπολογιστή παλάμης με τη βάση δεδομένων του υπολογιστή.
+Comment[en_GB]=This conduit syncs the handheld address book with a database stored on the PC.
 Comment[es]=Este conducto sincroniza la libreta de direcciones de la agenda electrónica con la base de datos almacenada en el equipo.
 Comment[et]=See kanal sünkroniseerib pihuarvuti aadressiraamatu PC-s leiduva andmebaasiga.
 Comment[fr]=Ce canal synchronise le carnet d'adresse du périphérique avec une base de données sur votre ordinateur.
Index: kontact/src/mainwindow.cpp
===================================================================
--- kontact/src/mainwindow.cpp	(.../tags/KDE/4.2.2/kdepim)	(wersja 952918)
+++ kontact/src/mainwindow.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 952918)
@@ -579,7 +579,6 @@
 bool MainWindow::removePlugin( const KPluginInfo &info )
 {
   PluginList::Iterator end = mPlugins.end();
-  ActionPluginList::Iterator it2 = mActionPlugins.begin();
   for ( PluginList::Iterator it = mPlugins.begin(); it != end; ++it ) {
     Plugin *plugin = *it;
     if ( ( *it )->identifier() == info.pluginName() ) {
@@ -608,8 +607,10 @@
       plugin->deleteLater(); // removes the part automatically
       mPlugins.erase( it );
       if ( plugin->showInSideBar() ) {
-        delete *it2; // remove the KAction, so we free the shortcut for later us
-        mActionPlugins.erase( it2 );
+        QAction *q = mPluginAction[plugin]; // remove the KAction, so we free the shortcut for later us
+        mActionPlugins.remove( q );
+        mPluginAction.remove(plugin);
+        delete q;
       }
 
       if ( mCurrentPlugin == 0 ) {
@@ -624,9 +625,6 @@
       return true;
     }
 
-    if ( plugin->showInSideBar() ) {
-      it2++;
-    }
   }
 
   return false;
Index: knotes/knote.cpp
===================================================================
--- knotes/knote.cpp	(.../tags/KDE/4.2.2/kdepim)	(wersja 952918)
+++ knotes/knote.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 952918)
@@ -1039,25 +1039,36 @@
 
 void KNote::updateFocus()
 {
-  if ( hasFocus() ) {
+  if ( hasFocus() )
+  {
     m_button->show();
 
-    if ( !m_editor->isReadOnly() ) {
-      if ( m_tool && m_tool->isHidden() && m_editor->acceptRichText() ) {
-        m_tool->show();
-	m_grip->show();
-        setGeometry( x(), y(), width(), height() + m_tool->height() );
-      }
-    } else if ( m_tool && !m_tool->isHidden() ) {
-      m_tool->hide();
-      setGeometry( x(), y(), width(), height() - m_tool->height() );
-      updateLayout();     // to update the minimum height
+    if ( !m_editor->isReadOnly() )
+    {
+        if ( m_tool && m_tool->isHidden() && m_editor->acceptRichText() )
+        {
+            m_tool->show();
+            setGeometry( x(), y(), width(), height() + m_tool->height() );
+        }
+        m_grip->show();
     }
-  } else {
+    else
+    {
+        if ( m_tool && !m_tool->isHidden() ) {
+            m_tool->hide();
+            setGeometry( x(), y(), width(), height() - m_tool->height() );
+            updateLayout();     // to update the minimum height
+        }
+        m_grip->hide();
+    }
+  }
+  else
+  {
     m_button->hide();
     m_grip->hide();
 
-    if ( m_tool && !m_tool->isHidden() ) {
+    if ( m_tool && !m_tool->isHidden() )
+    {
       m_tool->hide();
       setGeometry( x(), y(), width(), height() - m_tool->height() );
       updateLayout();     // to update the minimum height
Index: akonadi/resources/distlist/distlistresource.desktop
===================================================================
--- akonadi/resources/distlist/distlistresource.desktop	(.../tags/KDE/4.2.2/kdepim)	(wersja 952918)
+++ akonadi/resources/distlist/distlistresource.desktop	(.../branches/KDE/4.2/kdepim)	(wersja 952918)
@@ -4,6 +4,7 @@
 Name[da]=Distributionsliste-fil
 Name[de]=Verteilerlistendatei
 Name[el]=Αρχείο λίστας διανομής
+Name[en_GB]=Distribution List File
 Name[es]=Archivo de lista de distribución
 Name[et]=Postiloendi fail
 Name[fr]=Fichier de liste de distribution
@@ -37,6 +38,7 @@
 Comment[da]=Indlæser data fra en distributionsliste-fil
 Comment[de]=Daten werden aus einer Verteilerlistendatei geladen
 Comment[el]=Φόρτωση δεδομένων από ένα αρχείο λίστας διανομής
+Comment[en_GB]=Loads data from a distribution list file
 Comment[es]=Carga datos desde un archivo de lista de distribución.
 Comment[et]=Andmete laadimine postiloendi failist
 Comment[fr]=Charger les données depuis un fichier de liste de distribution
Index: akonadi/resources/kabc/kabcresource.desktop
===================================================================
--- akonadi/resources/kabc/kabcresource.desktop	(.../tags/KDE/4.2.2/kdepim)	(wersja 952918)
+++ akonadi/resources/kabc/kabcresource.desktop	(.../branches/KDE/4.2/kdepim)	(wersja 952918)
@@ -5,6 +5,7 @@
 Name[da]=KDE's adressebog (traditionel)
 Name[de]=KDE-Adressbuch (herkömmlich)
 Name[el]=Βιβλίο διευθύνσεων του KDE (παραδοσιακό)
+Name[en_GB]=KDE Address Book (traditional)
 Name[es]=KDE Addressbook (tradicional)
 Name[et]=KDE aadressiraamat (traditsiooniline)
 Name[fr]=Carnet d'adresse KDE (traditionnel)
@@ -38,6 +39,7 @@
 Comment[da]=Indlæser data fra en traditionel KDE adressebogsressource
 Comment[de]=Lädt Daten aus einer herkömmlichen KDE-Adressbuch-Ressource
 Comment[el]=Φόρτωση δεδομένων από έναν παραδοσιακό πόρο βιβλίου διευθύνσεων του KDE
+Comment[en_GB]=Loads data from a traditional KDE address book resource
 Comment[es]=Carga datos desde un recurso tradicional de Libreta de Direcciones de KDE
 Comment[et]=Andmete laadimine traditsioonilisest KDE aadressiraamatu ressursist
 Comment[fr]=Charge des données depuis un carnet d'adresses KDE traditionnel
Index: korganizer/kogroupware.cpp
===================================================================
--- korganizer/kogroupware.cpp	(.../tags/KDE/4.2.2/kdepim)	(wersja 952918)
+++ korganizer/kogroupware.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 952918)
@@ -180,6 +180,10 @@
   KCal::iTIPMethod method = static_cast<KCal::iTIPMethod>( message->method() );
   KCal::ScheduleMessage::Status status = message->status();
   KCal::Incidence *incidence = dynamic_cast<KCal::Incidence*>( message->event() );
+  if(!incidence) {
+    delete message;
+    return;
+  }
   KCal::MailScheduler scheduler( mCalendar );
   if ( action.startsWith( "accepted" ) || action.startsWith( "tentative" ) ||
        action.startsWith( "delegated" ) || action.startsWith( "counter" ) ) {
Index: korganizer/publishdialog.cpp
===================================================================
--- korganizer/publishdialog.cpp	(.../tags/KDE/4.2.2/kdepim)	(wersja 952918)
+++ korganizer/publishdialog.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 952918)
@@ -87,9 +87,11 @@
   for ( i=0; i<count; i++ ) {
     item = mUI.mAddressListView->firstChild();
     mUI.mAddressListView->takeItem( item );
-    to += item->text( 1 );
-    if ( i < count-1 ) {
-      to += ", ";
+    if( !item->text( 1 ).isEmpty() ) {
+      to += item->text( 1 );
+      if ( i < count-1 ) {
+        to += ", ";
+      }
     }
   }
   return to;
Index: korganizer/koattendeeeditor.cpp
===================================================================
--- korganizer/koattendeeeditor.cpp	(.../tags/KDE/4.2.2/kdepim)	(wersja 952918)
+++ korganizer/koattendeeeditor.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 952918)
@@ -410,6 +410,9 @@
       mDelegateLabel->setText( i18n( "Not delegated" ) );
     }
   }
+  if( myself )
+    mRsvpButton->setEnabled( false );
+
 }
 
 void KOAttendeeEditor::updateAttendeeInput()
Index: korganizer/koeditorfreebusy.cpp
===================================================================
--- korganizer/koeditorfreebusy.cpp	(.../tags/KDE/4.2.2/kdepim)	(wersja 952918)
+++ korganizer/koeditorfreebusy.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 952918)
@@ -342,8 +342,6 @@
 
   connect( mGanttView, SIGNAL(lvSelectionChanged(KDGanttViewItem*)),
           this, SLOT(updateAttendeeInput()) );
-  connect( mGanttView, SIGNAL(lvItemLeftClicked(KDGanttViewItem*)),
-           this, SLOT(showAttendeeStatusMenu()) );
   connect( mGanttView, SIGNAL(lvItemRightClicked(KDGanttViewItem*)),
            this, SLOT(showAttendeeStatusMenu()) );
   connect( mGanttView, SIGNAL(lvMouseButtonClicked(int, KDGanttViewItem*, const QPoint&, int)),
Index: korganizer/koglobals.h
===================================================================
--- korganizer/koglobals.h	(.../tags/KDE/4.2.2/kdepim)	(wersja 952918)
+++ korganizer/koglobals.h	(.../branches/KDE/4.2/kdepim)	(wersja 952918)
@@ -63,6 +63,11 @@
       COMPLETION_MODIFIED_WITH_RECURRENCE,
       UNKNOWN_MODIFIED
     };
+    enum
+    {
+      // This value is passed to QColor's lighter(int factor) for selected events
+      BRIGHTNESS_FACTOR = 125
+    };
 
     static void fitDialogToScreen( QWidget *widget, bool force=false );
     KConfig *config() const;
Index: korganizer/interfaces/korganizer/baseview.cpp
===================================================================
--- korganizer/interfaces/korganizer/baseview.cpp	(.../tags/KDE/4.2.2/kdepim)	(wersja 952918)
+++ korganizer/interfaces/korganizer/baseview.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 952918)
@@ -78,6 +78,11 @@
   return false;
 }
 
+bool BaseView::usesFullWindow()
+{
+  return false;
+}
+
 } //namespace KOrg
 
 #include "baseview.moc"
Index: korganizer/interfaces/korganizer/baseview.h
===================================================================
--- korganizer/interfaces/korganizer/baseview.h	(.../tags/KDE/4.2.2/kdepim)	(wersja 952918)
+++ korganizer/interfaces/korganizer/baseview.h	(.../branches/KDE/4.2/kdepim)	(wersja 952918)
@@ -102,6 +102,12 @@
     */
     virtual bool isEventView();
 
+    /**
+     * returns whether this view should be displayed full window.
+     * Base implementation returns false.
+     */
+    virtual bool usesFullWindow();
+
   public Q_SLOTS:
     /**
       Show incidences for the given date range. The date range actually shown
Index: korganizer/views/monthview/monthview.cpp
===================================================================
--- korganizer/views/monthview/monthview.cpp	(.../tags/KDE/4.2.2/kdepim)	(wersja 952918)
+++ korganizer/views/monthview/monthview.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 952918)
@@ -399,3 +399,8 @@
 {
   return startDate().addDays( startDate().daysTo( endDate() ) / 2 );
 }
+
+bool MonthView::usesFullWindow()
+{
+  return KOPrefs::instance()->mFullViewMonth;
+}
Index: korganizer/views/monthview/monthview.h
===================================================================
--- korganizer/views/monthview/monthview.h	(.../tags/KDE/4.2.2/kdepim)	(wersja 952918)
+++ korganizer/views/monthview/monthview.h	(.../branches/KDE/4.2/kdepim)	(wersja 952918)
@@ -63,6 +63,8 @@
      */
     QDate averageDate() const;
 
+    bool usesFullWindow();
+
   public slots:
     virtual void updateView();
     virtual void showDates( const QDate &start, const QDate &end );
Index: korganizer/views/monthview/monthgraphicsitems.cpp
===================================================================
--- korganizer/views/monthview/monthgraphicsitems.cpp	(.../tags/KDE/4.2.2/kdepim)	(wersja 952918)
+++ korganizer/views/monthview/monthgraphicsitems.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 952918)
@@ -27,6 +27,7 @@
 #include "monthitem.h"
 #include "monthscene.h"
 
+#include "koglobals.h"
 #include "koprefs.h"
 #include "kohelper.h"
 
@@ -235,10 +236,9 @@
   int textMargin = 10;
 
   QColor bgColor = mMonthItem->bgColor();
-  // keep this (110) in sync with agendaview
-  bgColor = mMonthItem->selected() ? bgColor.lighter( 110 ) : bgColor;
+  bgColor = mMonthItem->selected() ? bgColor.lighter( KOGlobals::BRIGHTNESS_FACTOR ) : bgColor;
   QColor frameColor = mMonthItem->frameColor( bgColor );
-  frameColor = mMonthItem->selected() ? frameColor.lighter( 110 ) : frameColor;
+  frameColor = mMonthItem->selected() ? frameColor.lighter( KOGlobals::BRIGHTNESS_FACTOR ) : frameColor;
   QColor textColor = getTextColor(bgColor);
 
   // make moving or resizing items translucent
Index: korganizer/views/todoview/kotodoview.h
===================================================================
--- korganizer/views/todoview/kotodoview.h	(.../tags/KDE/4.2.2/kdepim)	(wersja 952918)
+++ korganizer/views/todoview/kotodoview.h	(.../branches/KDE/4.2/kdepim)	(wersja 952918)
@@ -75,6 +75,8 @@
     void saveLayout( KConfig *config, const QString &group ) const;
     void restoreLayout( KConfig *config, const QString &group );
 
+    bool usesFullWindow();
+
   public Q_SLOTS:
     virtual void setIncidenceChanger( IncidenceChangerBase *changer );
     virtual void showDates( const QDate &start, const QDate &end );
Index: korganizer/views/todoview/kotodoview.cpp
===================================================================
--- korganizer/views/todoview/kotodoview.cpp	(.../tags/KDE/4.2.2/kdepim)	(wersja 952918)
+++ korganizer/views/todoview/kotodoview.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 952918)
@@ -702,4 +702,9 @@
   mModel->setFlatView( flatView );
 }
 
+bool KOTodoView::usesFullWindow()
+{
+  return KOPrefs::instance()->mFullViewTodo;
+}
+
 #include "kotodoview.moc"
Index: korganizer/views/multiagendaview/multiagendaview.cpp
===================================================================
--- korganizer/views/multiagendaview/multiagendaview.cpp	(.../tags/KDE/4.2.2/kdepim)	(wersja 952918)
+++ korganizer/views/multiagendaview/multiagendaview.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 952918)
@@ -193,11 +193,8 @@
              SIGNAL(pasteIncidenceSignal()) );
     connect( agenda, SIGNAL(toggleAlarmSignal(Incidence*)),
              SIGNAL(toggleAlarmSignal(Incidence*)) );
-    connect( agenda, SIGNAL(dissociateOccurrenceSignal(Incidence*, const QDate&)),
-             SIGNAL(dissociateOccurrenceSignal(Incidence*, const QDate&)) );
-    connect( agenda, SIGNAL(dissociateFutureOccurrenceSignal(Incidence*, const QDate&)),
-             SIGNAL(dissociateFutureOccurrenceSignal(Incidence*, const QDate&)) );
-
+    connect( agenda, SIGNAL(dissociateOccurrencesSignal(Incidence*, const QDate&)),
+             SIGNAL(dissociateOccurrencesSignal(Incidence*, const QDate&)) );
     connect( agenda, SIGNAL(newEventSignal(const QDate&)),
              SIGNAL(newEventSignal(const QDate&)) );
     connect( agenda, SIGNAL(newEventSignal(const QDateTime&)),
Index: korganizer/views/agendaview/koagendaitem.cpp
===================================================================
--- korganizer/views/agendaview/koagendaitem.cpp	(.../tags/KDE/4.2.2/kdepim)	(wersja 952918)
+++ korganizer/views/agendaview/koagendaitem.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 952918)
@@ -873,7 +873,7 @@
   }
 
   if ( mSelected ) {
-    bgColor = bgColor.light( 110 ); // keep this in sync with month view
+    bgColor = bgColor.light( KOGlobals::BRIGHTNESS_FACTOR );
   }
 
   QColor textColor = getTextColor( bgColor );
Index: korganizer/koviewmanager.cpp
===================================================================
--- korganizer/koviewmanager.cpp	(.../tags/KDE/4.2.2/kdepim)	(wersja 952918)
+++ korganizer/koviewmanager.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 952918)
@@ -160,8 +160,7 @@
 
 void KOViewManager::raiseCurrentView()
 {
-  if ( ( mMonthView && KOPrefs::instance()->mFullViewMonth && mCurrentView == mMonthView ) ||
-       ( mTodoView && KOPrefs::instance()->mFullViewTodo && mCurrentView == mTodoView ) ) {
+  if ( mCurrentView && mCurrentView->usesFullWindow() ) {
     mMainView->showLeftFrame( false );
     if ( mCurrentView == mTodoView ) {
       mMainView->navigatorBar()->hide();
Index: korganizer/incidencechanger.cpp
===================================================================
--- korganizer/incidencechanger.cpp	(.../tags/KDE/4.2.2/kdepim)	(wersja 952918)
+++ korganizer/incidencechanger.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 952918)
@@ -363,7 +363,7 @@
     // widgets sooner or later
     stdcal->setDialogParentWidget( tmpparent );
   }
-  if ( !success ) {
+  if ( !success && stdcal ) {
     // We can have a failure if the user pressed [cancel] in the resource
     // selectdialog, so check the exception.
     ErrorFormat *e = stdcal->exception();

Zmiany atrybutów dla: .
___________________________________________________________________
Dodane: svn:externals
   + 


