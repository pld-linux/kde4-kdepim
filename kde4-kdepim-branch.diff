Index: akregator/plugins/mk4storage/akregator_mk4storage_plugin.desktop
===================================================================
--- akregator/plugins/mk4storage/akregator_mk4storage_plugin.desktop	(.../tags/KDE/4.3.1/kdepim)	(wersja 1023019)
+++ akregator/plugins/mk4storage/akregator_mk4storage_plugin.desktop	(.../branches/KDE/4.3/kdepim)	(wersja 1023019)
@@ -18,7 +18,7 @@
 Name[fr]=Stockage avec Metakit
 Name[fy]=Metakit-opslachefterein
 Name[ga]=Inneall stórála Metakit
-Name[gl]=Manexador do almacenador Metakit
+Name[gl]=Infraestrutura do almacenador Metakit
 Name[hu]=Metakit tároló
 Name[is]=Metakit geymslu bakendi
 Name[it]=Backend archiviazione metakit
Index: akregator/configuration/akregator_config_browser.desktop
===================================================================
--- akregator/configuration/akregator_config_browser.desktop	(.../tags/KDE/4.3.1/kdepim)	(wersja 1023019)
+++ akregator/configuration/akregator_config_browser.desktop	(.../branches/KDE/4.3/kdepim)	(wersja 1023019)
@@ -56,7 +56,7 @@
 Comment[es]=Configurar el componente navegador interno
 Comment[et]=Sisemise sirvimiskomponendi seadistamine
 Comment[fr]=Configurer le navigateur web interne
-Comment[gl]=Configurar o componente navegador interno
+Comment[gl]=Configurar o compoñente do navegador interno
 Comment[hu]=A belső böngészőkomponens beállítása
 Comment[it]=Configura il componente interno di navigazione internet
 Comment[ja]=内部ブラウザコンポーネントの設定
Index: libkleo/libkleopatrarc.desktop
===================================================================
--- libkleo/libkleopatrarc.desktop	(.../tags/KDE/4.3.1/kdepim)	(wersja 1023019)
+++ libkleo/libkleopatrarc.desktop	(.../branches/KDE/4.3/kdepim)	(wersja 1023019)
@@ -185,7 +185,7 @@
 Name[fi]=Luotettu juurivarmenne
 Name[fr]=Certificat racine de confiance
 Name[fy]=Fertroude haadsertifikaat
-Name[gl]=Certificado raiz autentificado
+Name[gl]=Certificado raíz autenticado
 Name[hu]=Megbízható gyökértanúsítvány
 Name[is]=Treyst rótarskilríki
 Name[it]=Certificato radice affidabile
@@ -243,7 +243,7 @@
 Name[fi]=Ei-luotettu juurivarmenne
 Name[fr]=Certificat racine non fiable
 Name[fy]=Net fertroude haadsertifikaat
-Name[gl]=Certificado raiz non autentificado
+Name[gl]=Certificado raíz non autenticado
 Name[hu]=Nem megbízható gyökértanúsítvány
 Name[is]=Ekki traust rótarskilríki
 Name[it]=Certificato radice non affidabile
Index: kresources/slox/kcal_slox.desktop
===================================================================
--- kresources/slox/kcal_slox.desktop	(.../tags/KDE/4.3.1/kdepim)	(wersja 1023019)
+++ kresources/slox/kcal_slox.desktop	(.../branches/KDE/4.3/kdepim)	(wersja 1023019)
@@ -38,7 +38,7 @@
 Name[pa]=SUSE LINUX Openexchange ਸਰਵਰ
 Name[pl]=Serwer SUSE LINUX Openexchange
 Name[pt]=Servidor SUSE LINUX Openexchange
-Name[pt_BR]=Servidor OpenExchange do SUSE Linux (SLOX)
+Name[pt_BR]=Servidor Openexchange do SUSE Linux (SLOX)
 Name[ru]=Сервер SUSE LINUX Openexchange
 Name[sl]=Strežnik SUSE LINUX Openexchange
 Name[sv]=SUSE Linux Openexchange-server
Index: kresources/slox/kabc_slox.desktop
===================================================================
--- kresources/slox/kabc_slox.desktop	(.../tags/KDE/4.3.1/kdepim)	(wersja 1023019)
+++ kresources/slox/kabc_slox.desktop	(.../branches/KDE/4.3/kdepim)	(wersja 1023019)
@@ -38,7 +38,7 @@
 Name[pa]=SUSE LINUX Openexchange ਸਰਵਰ
 Name[pl]=Serwer SUSE LINUX Openexchange
 Name[pt]=Servidor SUSE LINUX Openexchange
-Name[pt_BR]=Servidor OpenExchange do SUSE Linux (SLOX)
+Name[pt_BR]=Servidor Openexchange do SUSE Linux (SLOX)
 Name[ru]=Сервер SUSE LINUX Openexchange
 Name[sl]=Strežnik SUSE LINUX Openexchange
 Name[sv]=SUSE Linux Openexchange-server
Index: kmail/kmail.antispamrc
===================================================================
--- kmail/kmail.antispamrc	(.../tags/KDE/4.3.1/kdepim)	(wersja 1023019)
+++ kmail/kmail.antispamrc	(.../branches/KDE/4.3/kdepim)	(wersja 1023019)
@@ -56,13 +56,13 @@
 Version=1
 Priority=30
 VisibleName=Annoyance-Filter
-Executable=$HOME/.annoyance-filter/annoyance-filter --version
+Executable=PATH=$HOME/.annoyance-filter:${PATH} annoyance-filter --version
 URL=http://www.fourmilab.ch/annoyance-filter
 PipeFilterName=Annoyance-Filter Check
-PipeCmdDetect=$HOME/.annoyance-filter/annoyance-filter --fread $HOME/.annoyance-filter/FastDict.bin --phrasemin 1 --phrasemax 2 --transcript - --test -
+PipeCmdDetect=PATH=$HOME/.annoyance-filter:${PATH} annoyance-filter --fread $HOME/.annoyance-filter/FastDict.bin --phrasemin 1 --phrasemax 2 --transcript - --test -
 PipeCmdNoSpam=
-ExecCmdSpam=$HOME/.annoyance-filter/annoyance-filter --read $HOME/.annoyance-filter/Dict.bin --phrasemin 1 --phrasemax 2 --junk - --prune --write $HOME/.annoyance-filter/Dict.bin --fwrite $HOME/.annoyance-filter/FastDict.bin
-ExecCmdHam=$HOME/.annoyance-filter/annoyance-filter --read $HOME/.annoyance-filter/Dict.bin --phrasemin 1 --phrasemax 2 --mail - --prune --write $HOME/.annoyance-filter/Dict.bin --fwrite $HOME/.annoyance-filter/FastDict.bin
+ExecCmdSpam=PATH=$HOME/.annoyance-filter:${PATH} annoyance-filter --read $HOME/.annoyance-filter/Dict.bin --phrasemin 1 --phrasemax 2 --junk - --prune --write $HOME/.annoyance-filter/Dict.bin --fwrite $HOME/.annoyance-filter/FastDict.bin
+ExecCmdHam=PATH=$HOME/.annoyance-filter:${PATH} annoyance-filter --read $HOME/.annoyance-filter/Dict.bin --phrasemin 1 --phrasemax 2 --mail - --prune --write $HOME/.annoyance-filter/Dict.bin --fwrite $HOME/.annoyance-filter/FastDict.bin
 DetectionHeader=X-Annoyance-Filter-Classification
 DetectionPattern=Junk
 DetectionPattern2=
Index: kmail/kmailicalifaceimpl.cpp
===================================================================
--- kmail/kmailicalifaceimpl.cpp	(.../tags/KDE/4.3.1/kdepim)	(wersja 1023019)
+++ kmail/kmailicalifaceimpl.cpp	(.../branches/KDE/4.3/kdepim)	(wersja 1023019)
@@ -1712,6 +1712,21 @@
   }
 }
 
+// Builds a folder list from the dimap and the local folder list.
+static void createFolderList( QStringList &folderNames, QList<QPointer<KMFolder> > &folderList )
+{
+  QStringList dimapFolderNames;
+  QStringList localFolderNames;
+  QList<QPointer<KMFolder> > dimapFolderList;
+  QList<QPointer<KMFolder> > localFolderList;
+  kmkernel->dimapFolderMgr()->createFolderList( &dimapFolderNames, &dimapFolderList );
+  kmkernel->folderMgr()->createFolderList( &localFolderNames, &localFolderList );
+  folderNames += dimapFolderNames;
+  folderNames += localFolderNames;
+  folderList += dimapFolderList;
+  folderList += localFolderList;
+}
+
 /****************************
  * The config stuff
  */
@@ -1882,9 +1897,6 @@
     if ( mNotes->folderType() == KMFolderTypeCachedImap )
       static_cast<KMFolderCachedImap *>( mNotes->storage() )->updateAnnotationFolderType();
 
-    // BEGIN TILL TODO The below only uses the dimap folder manager, which
-    // will fail for all other folder types. Adjust.
-
     kDebug() << "mCalendar=" << mCalendar << mCalendar->location();
     kDebug() << "mContacts=" << mContacts << mContacts->location();
     kDebug() << "mNotes=" << mNotes << mNotes->location();
@@ -1892,13 +1904,15 @@
     // Find all extra folders
     QStringList folderNames;
     QList<QPointer<KMFolder> > folderList;
-    kmkernel->dimapFolderMgr()->createFolderList(&folderNames, &folderList);
+    createFolderList( folderNames, folderList );
     for(QList<QPointer<KMFolder> >::iterator it = folderList.begin();
         it != folderList.end(); ++it)
     {
-      KMFolderCachedImap* storage = dynamic_cast<KMFolderCachedImap*>( (*it)->storage() );
+      FolderStorage *storage = (*it)->storage();
+      KMFolderCachedImap* dimapStorage = dynamic_cast<KMFolderCachedImap*>( storage );
       if ( storage && storage->contentsType() != 0 ) {
-        storage->updateAnnotationFolderType();
+        if ( dimapStorage )
+          dimapStorage->updateAnnotationFolderType();
         folderContentsTypeChanged( *it, storage->contentsType() );
       }
     }
@@ -1916,8 +1930,6 @@
     if ( mExtraFolders.contains( mNotes->location() ) )
       delete mExtraFolders.take( mNotes->location() );
 
-    // END TILL TODO
-
     emit subresourceAdded( folderContentsType( KMail::ContentsTypeCalendar ),
                            mCalendar->location(), mCalendar->label(), true, true );
     emit subresourceAdded( folderContentsType( KMail::ContentsTypeTask ),
Index: kmail/messagelistview/core/model.cpp
===================================================================
--- kmail/messagelistview/core/model.cpp	(.../tags/KDE/4.3.1/kdepim)	(wersja 1023019)
+++ kmail/messagelistview/core/model.cpp	(.../branches/KDE/4.3/kdepim)	(wersja 1023019)
@@ -60,6 +60,7 @@
 #include <QScrollBar>
 
 #include <KLocale>
+#include <KCalendarSystem>
 #include <KGlobal>
 #include <KDebug>
 #include <kcursorsaver.h>
@@ -309,7 +310,8 @@
 void Model::setAggregation( const Aggregation * aggregation )
 {
   mAggregation = aggregation;
-  mView->setRootIsDecorated( mAggregation->grouping() == Aggregation::NoGrouping );
+  mView->setRootIsDecorated( ( mAggregation->grouping() == Aggregation::NoGrouping ) &&
+                             ( mAggregation->threading() != Aggregation::NoThreading ) );
 }
 
 void Model::setTheme( const Theme * theme )
@@ -1182,34 +1184,6 @@
   }
 }
 
-static inline QString get_capitalized_long_day_name( int dayOfWeek )
-{
-  // The day name should be capitalized in the group labels
-  // This fixes some complaints from translators that have mapped
-  // their standard day names to lowercase versions for general
-  // use but still want them to be capitalized in the headers...
-  QString name = QDate::longDayName( dayOfWeek );
-  if ( name.isEmpty() )
-    return name;
-  QString copy = name;
-  copy[ 0 ] = name.at( 0 ).toUpper();
-  return copy;
-}
-
-static inline QString get_capitalized_month_name( int month )
-{
-  // The month name should be capitalized in the group labels
-  // This fixes some complaints from translators that have mapped
-  // their standard month names to lowercase versions for general
-  // use but still want them to be capitalized in the headers...
-  QString name = QDate::longMonthName( month );
-  if ( name.isEmpty() )
-    return name;
-  QString copy = name;
-  copy[ 0 ] = name.at( 0 ).toUpper();
-  return copy;
-}
-
 void Model::attachMessageToGroupHeader( MessageItem *mi )
 {
   QString groupLabel;
@@ -1265,24 +1239,12 @@
         if ( dateWeekNumber == todayWeekNumber )
         {
           // within this week
-          groupLabel = get_capitalized_long_day_name( dDate.dayOfWeek() );
+          groupLabel = KGlobal::locale()->calendar()->weekDayName( dDate );
         } else {
-          // not this week
-          // FIXME: After 4.2 think about a configurable date format.
-          //        At the moment KMime::DateFormatter doesn't support date-only formatting.
-          //        KDateTime is not better than QDate in this case.
-          //        A configurable date-only format should be probably tweaked into KMime::DateFormatter
-          //        but this can't be done with the string freeze in effect.
-          groupLabel = dDate.toString( Qt::DefaultLocaleShortDate );
+          groupLabel = KGlobal::locale()->formatDate( dDate, KLocale::ShortDate );
         }
       } else {
-        // not within this month
-        // FIXME: After 4.2 think about a configurable date format.
-        //        At the moment KMime::DateFormatter doesn't support date-only formatting.
-        //        KDateTime is not better than QDate in this case.
-        //        A configurable date-only format should be probably tweaked into KMime::DateFormatter
-        //        but this can't be done with the string freeze in effect.
-        groupLabel = dDate.toString( Qt::DefaultLocaleShortDate );
+        groupLabel = KGlobal::locale()->formatDate( dDate, KLocale::ShortDate );
       }
 
     }
@@ -1335,7 +1297,7 @@
         if ( dateWeekNumber == todayWeekNumber )
         {
           // within this week
-          groupLabel = get_capitalized_long_day_name( dDate.dayOfWeek() );
+          groupLabel = KGlobal::locale()->calendar()->weekDayName( dDate );
         } else {
           // previous weeks
           int weekDiff = todayWeekNumber - dateWeekNumber;
@@ -1364,10 +1326,12 @@
         )
         {
           // group by months, this year (so no year appended)
-          groupLabel = get_capitalized_month_name( dDate.month() );
+          groupLabel = KGlobal::locale()->calendar()->monthName( dDate );
         } else {
           // group by months
-          groupLabel = QString( "%1 %2" ).arg( get_capitalized_month_name( dDate.month() ) ).arg( dDate.year() );
+          groupLabel = QString( "%1 %2" )
+            .arg( KGlobal::locale()->calendar()->monthName( dDate ) )
+            .arg( dDate.year() );
         }
       }
     }
Index: kmail/kmpopfiltercnfrmdlg.cpp
===================================================================
--- kmail/kmpopfiltercnfrmdlg.cpp	(.../tags/KDE/4.3.1/kdepim)	(wersja 1023019)
+++ kmail/kmpopfiltercnfrmdlg.cpp	(.../branches/KDE/4.3/kdepim)	(wersja 1023019)
@@ -55,9 +55,6 @@
               << i18nc("@title:column", "Sender") << i18nc("@title:column", "Receiver")
               << i18nc("@title:column", "Date") << i18nc("@title:column", "Size");
   QTreeWidgetItem *headerItem = new QTreeWidgetItem( headerNames );
-  headerItem->setTextAlignment( 0, Qt::AlignHCenter );
-  headerItem->setTextAlignment( 1, Qt::AlignHCenter );
-  headerItem->setTextAlignment( 2, Qt::AlignHCenter );
   headerItem->setTextAlignment( 7, Qt::AlignRight );
   headerItem->setToolTip( 0, i18nc("@action:button", "Download all messages now") );
   headerItem->setToolTip( 1, i18nc("@action:button", "Download all messages later") );
@@ -76,9 +73,9 @@
   //    Disable it for now.
   //header()->setResizeMode( 3, QHeaderView::Stretch );
   header()->setStretchLastSection( false );
-  setColumnWidth( 0, 22 );    // Download Now icon
-  setColumnWidth( 1, 22 );    // Download Later icon
-  setColumnWidth( 2, 22 );    // Delete icon
+  setColumnWidth( 0, IconSize( KIconLoader::Small ) + 6 );    // Download Now icon
+  setColumnWidth( 1, IconSize( KIconLoader::Small ) + 6 );    // Download Later icon
+  setColumnWidth( 2, IconSize( KIconLoader::Small ) + 6 );    // Delete icon
   setColumnWidth( 3, 180 );   // Subject
   setColumnWidth( 4, 140 );   // Sender
   setColumnWidth( 5, 140);    // Receiver
@@ -150,7 +147,8 @@
   }
 }
 
-void KMPopHeadersView::slotRadioButtonClicked( QTreeWidgetItem* item, int column ) {
+void KMPopHeadersView::slotRadioButtonClicked( QTreeWidgetItem* item, int column )
+{
   assert( item && column >= 0 && column < NoAction );
   mDialog->setAction( item, mapToAction( column ) );
 
Index: kmail/cachedimapjob.cpp
===================================================================
--- kmail/cachedimapjob.cpp	(.../tags/KDE/4.3.1/kdepim)	(wersja 1023019)
+++ kmail/cachedimapjob.cpp	(.../branches/KDE/4.3/kdepim)	(wersja 1023019)
@@ -510,7 +510,7 @@
         bool b = kmkernel->iCalIface().isResourceQuiet();
         kmkernel->iCalIface().setResourceQuiet( true );
 
-        mFolder->take( i );
+        mFolder->takeTemporarily( i );
         mFolder->addMsgKeepUID( mMsg );
         mMsg->setTransferInProgress( false );
 
Index: kmail/kmlineeditspell.cpp
===================================================================
--- kmail/kmlineeditspell.cpp	(.../tags/KDE/4.3.1/kdepim)	(wersja 1023019)
+++ kmail/kmlineeditspell.cpp	(.../branches/KDE/4.3/kdepim)	(wersja 1023019)
@@ -97,7 +97,7 @@
   const QAction *result = menu.exec( QCursor::pos() );
   if ( !result )
     return;
-  setText( contents + result->text() );
+  setText( contents + KGlobal::locale()->removeAcceleratorMarker( result->text() ) );
 }
 
 void KMLineEdit::dropEvent(QDropEvent *event)
@@ -202,8 +202,13 @@
       int idx = addCompletionSource( i18n( "Recent Addresses" ) );
       for ( ; it != recent.end(); ++it ) {
         KABC::Addressee addr;
-        KPIMUtils::extractEmailAddressAndName(*it, email, name);
-        addr.setNameFromString( KPIMUtils::quoteNameIfNecessary( name ));
+        KPIMUtils::extractEmailAddressAndName( *it, email, name );
+        name = KPIMUtils::quoteNameIfNecessary( name );
+        if ( ( name[0] == '"' ) && ( name[name.length() - 1] == '"' ) ) {
+          name.remove( 0, 1 );
+          name.truncate( name.length() - 1 );
+        }
+        addr.setNameFromString( name );
         addr.insertEmail( email, true );
         addContact( addr, 120, idx ); // more weight than kabc entries and more than ldap results
       }
Index: kmail/kmreaderwin.cpp
===================================================================
--- kmail/kmreaderwin.cpp	(.../tags/KDE/4.3.1/kdepim)	(wersja 1023019)
+++ kmail/kmreaderwin.cpp	(.../branches/KDE/4.3/kdepim)	(wersja 1023019)
@@ -2489,13 +2489,13 @@
 //-----------------------------------------------------------------------------
 void KMReaderWin::slotScrollPrior()
 {
-  mViewer->view()->scrollBy( 0, -(int)(height() * 0.8 ) );
+  mViewer->view()->scrollBy( 0, -(int)(mViewer->widget()->height() * 0.8 ) );
 }
 
 //-----------------------------------------------------------------------------
 void KMReaderWin::slotScrollNext()
 {
-  mViewer->view()->scrollBy( 0, (int)(height() * 0.8 ) );
+  mViewer->view()->scrollBy( 0, (int)(mViewer->widget()->height() * 0.8 ) );
 }
 
 //-----------------------------------------------------------------------------
Index: kmail/kmmessage.cpp
===================================================================
--- kmail/kmmessage.cpp	(.../tags/KDE/4.3.1/kdepim)	(wersja 1023019)
+++ kmail/kmmessage.cpp	(.../branches/KDE/4.3/kdepim)	(wersja 1023019)
@@ -3237,18 +3237,17 @@
 }
 
 //-----------------------------------------------------------------------------
-void KMMessage::updateAttachmentState( DwBodyPart *part )
+void KMMessage::updateAttachmentState( DwBodyPart *partGiven )
 {
+  DwEntity *part = partGiven;
+  DwBodyPart *firstPart = partGiven;
+
   if ( !part ) {
-    part = getFirstDwBodyPart();
+    part = firstPart = getFirstDwBodyPart();
   }
 
   if ( !part ) {
-    // kDebug() <<"updateAttachmentState - no part!";
-    if ( mStatus.hasAttachment() ) {
-      toggleStatus( MessageStatus::statusHasAttachment() );
-    }
-    return;
+    part = mMsg;  // no part, use message itself
   }
 
   bool filenameEmpty = true;
@@ -3294,8 +3293,8 @@
   }
 
   // next part
-  if ( part->Next() ) {
-    updateAttachmentState( part->Next() );
+  if ( firstPart && firstPart->Next() ) {
+    updateAttachmentState( firstPart->Next() );
   } else if ( attachmentState() == KMMsgAttachmentUnknown &&
               mStatus.hasAttachment() ) {
     toggleStatus( MessageStatus::statusHasAttachment() );
Index: kmail/messageactions.cpp
===================================================================
--- kmail/messageactions.cpp	(.../tags/KDE/4.3.1/kdepim)	(wersja 1023019)
+++ kmail/messageactions.cpp	(.../branches/KDE/4.3/kdepim)	(wersja 1023019)
@@ -149,28 +149,29 @@
   mForwardActionMenu  = new KActionMenu(KIcon("mail-forward"), i18nc("Message->","&Forward"), this);
   mActionCollection->addAction("message_forward", mForwardActionMenu );
 
-  mForwardAttachedAction  = new KAction(KIcon("mail-forward"), i18nc("Message->Forward->","As &Attachment..."), this);
-  mActionCollection->addAction("message_forward_as_attachment", mForwardAttachedAction );
-  mForwardAttachedAction->setShortcut(QKeySequence(Qt::Key_F));
-  connect( mForwardAttachedAction, SIGNAL(triggered(bool) ),
-           parent, SLOT(slotForwardAttachedMsg()) );
+  mForwardAttachedAction = new KAction( KIcon("mail-forward"),
+                                        i18nc( "@action:inmenu Message->Forward->",
+                                               "As &Attachment..." ),
+                                        this );
+  connect( mForwardAttachedAction, SIGNAL( triggered( bool ) ),
+           parent, SLOT( slotForwardAttachedMsg() ) );
+  mActionCollection->addAction( "message_forward_as_attachment", mForwardAttachedAction );
 
-  mForwardInlineAction  = new KAction( KIcon( "mail-forward" ),
+  mForwardInlineAction = new KAction( KIcon( "mail-forward" ),
                                        i18nc( "@action:inmenu Message->Forward->",
                                               "&Inline..." ),
                                        this );
+  connect( mForwardInlineAction, SIGNAL( triggered( bool ) ),
+           parent, SLOT( slotForwardInlineMsg() ) );
   mActionCollection->addAction( "message_forward_inline", mForwardInlineAction );
-  mForwardInlineAction->setShortcut( QKeySequence( Qt::SHIFT + Qt::Key_F ) );
-  connect( mForwardInlineAction, SIGNAL(triggered(bool) ),
-           parent, SLOT(slotForwardInlineMsg()) );
 
   setupForwardActions();
 
-  mRedirectAction  = new KAction(i18nc("Message->Forward->", "&Redirect..."), this);
-  mActionCollection->addAction("message_forward_redirect", mRedirectAction );
-  connect( mRedirectAction, SIGNAL(triggered(bool)),
-           parent, SLOT(slotRedirectMsg()));
-  mRedirectAction->setShortcut(QKeySequence(Qt::Key_E));
+  mRedirectAction  = new KAction(i18nc("Message->Forward->", "&Redirect..."), this );
+  mActionCollection->addAction( "message_forward_redirect", mRedirectAction );
+  connect( mRedirectAction, SIGNAL( triggered( bool ) ),
+           parent, SLOT( slotRedirectMsg() ) );
+  mRedirectAction->setShortcut( QKeySequence( Qt::Key_E ) );
   mForwardActionMenu->addAction( mRedirectAction );
 
   updateActions();
@@ -269,18 +270,18 @@
 
 void MessageActions::setupForwardingActionsList( KXMLGUIClient *guiClient )
 {
-  QList<QAction*> mForwardActionList;
+  QList<QAction*> forwardActionList;
   guiClient->unplugActionList( "forward_action_list" );
   if ( GlobalSettings::self()->forwardingInlineByDefault() ) {
-    mForwardActionList.append( mForwardInlineAction );
-    mForwardActionList.append( mForwardAttachedAction );
+    forwardActionList.append( mForwardInlineAction );
+    forwardActionList.append( mForwardAttachedAction );
   }
   else {
-    mForwardActionList.append( mForwardAttachedAction );
-    mForwardActionList.append( mForwardInlineAction );
+    forwardActionList.append( mForwardAttachedAction );
+    forwardActionList.append( mForwardInlineAction );
   }
-  mForwardActionList.append( mRedirectAction );
-  guiClient->plugActionList( "forward_action_list", mForwardActionList );
+  forwardActionList.append( mRedirectAction );
+  guiClient->plugActionList( "forward_action_list", forwardActionList );
 }
 
 
Index: kmail/kmaccount.cpp
===================================================================
--- kmail/kmaccount.cpp	(.../tags/KDE/4.3.1/kdepim)	(wersja 1023019)
+++ kmail/kmaccount.cpp	(.../branches/KDE/4.3/kdepim)	(wersja 1023019)
@@ -395,7 +395,6 @@
           SLOT(precommandExited(bool)));
 
   kDebug() << "Running precommand" << precommand;
-  mPrecommandEventLoop = new QEventLoop();
   if ( !precommandProcess.start() )
     return false;
 
@@ -403,9 +402,10 @@
   // the precommand is running (which may take a while).
   // The exec call will block until the event loop is exited, which happens in
   // precommandExited().
-  if ( mPrecommandEventLoop ) { // yes it can be 0 due to races with precommandProcess.start()
-    mPrecommandEventLoop->exec();
-  }
+  mPrecommandEventLoop = new QEventLoop();
+  mPrecommandEventLoop->exec();
+  delete mPrecommandEventLoop;
+  mPrecommandEventLoop = 0;
 
   return mPrecommandSuccess;
 }
@@ -413,18 +413,12 @@
 //-----------------------------------------------------------------------------
 void KMAccount::precommandExited(bool success)
 {
-  Q_ASSERT( mPrecommandEventLoop != 0 );
   mPrecommandSuccess = success;
-
-  // Exit and delete the event loop. This makes sure the execution continues
-  // in runPrecommand(), where the event loop was entered.
-  mPrecommandEventLoop->exit();
-
-  // Use deleteLater, because we are called inside of this very eventloop
-  mPrecommandEventLoop->deleteLater();
-  mPrecommandEventLoop = 0;
+  if ( mPrecommandEventLoop )  // don't crash when kmail exits while mPrecommandEventLoop runs
+    mPrecommandEventLoop->exit();
 }
 
+//-----------------------------------------------------------------------------
 void KMAccount::slotIdentitiesChanged()
 {
   // Fall back to the default identity if the one used currently is invalid
Index: kmail/kmcommands.cpp
===================================================================
--- kmail/kmcommands.cpp	(.../tags/KDE/4.3.1/kdepim)	(wersja 1023019)
+++ kmail/kmcommands.cpp	(.../branches/KDE/4.3/kdepim)	(wersja 1023019)
@@ -767,11 +767,16 @@
   return OK;
 }
 
-static KUrl subjectToUrl( const QString &subject ) {
+static KUrl subjectToUrl( const QString &subject )
+{
+  QString fileName = KMCommand::cleanFileName( subject.trimmed() );
 
-  return KFileDialog::getSaveUrl( KUrl::fromPath( subject.trimmed()
-                                  .replace( QDir::separator(), '_' ) ),
-                                  "*.mbox" );
+  // avoid stripping off the last part of the subject after a "."
+  // by KFileDialog, which thinks it's an extension
+  if ( !fileName.endsWith( ".mbox" ) )
+    fileName += ".mbox";
+
+  return KFileDialog::getSaveUrl( KUrl::fromPath( fileName ), "*.mbox" );
 }
 
 KMSaveMsgCommand::KMSaveMsgCommand( QWidget *parent, KMMessage *msg )
@@ -2434,13 +2439,14 @@
   else {
     // only one item, get the desired filename
     partNode *node = mAttachmentMap.begin().key();
-    // replace all ':' with '_' because ':' isn't allowed on FAT volumes
-    QString s =
-      node->msgPart().fileName().trimmed().replace( ':', '_' );
+    QString s = node->msgPart().fileName().trimmed();
     if ( s.isEmpty() )
-      s = node->msgPart().name().trimmed().replace( ':', '_' );
+      s = node->msgPart().name().trimmed();
     if ( s.isEmpty() )
       s = i18nc("filename for an unnamed attachment", "attachment.1");
+    else
+      s = cleanFileName( s );
+
     url = KFileDialog::getSaveUrl( KUrl( "kfiledialog:///saveAttachment/" + s ),
                                    QString(),
                                    parentWidget(),
@@ -2464,16 +2470,18 @@
     KUrl curUrl;
     if ( !dirUrl.isEmpty() ) {
       curUrl = dirUrl;
-      QString s =
-        it.key()->msgPart().fileName().trimmed().replace( ':', '_' );
+      QString s = it.key()->msgPart().fileName().trimmed();
       if ( s.isEmpty() )
-        s = it.key()->msgPart().name().trimmed().replace( ':', '_' );
+        s = it.key()->msgPart().name().trimmed();
       if ( s.isEmpty() ) {
         ++unnamedAtmCount;
         s = i18nc("filename for the %1-th unnamed attachment",
                  "attachment.%1",
               unnamedAtmCount );
       }
+      else
+        s = cleanFileName( s );
+
       curUrl.setFileName( s );
     } else {
       curUrl = url;
@@ -2541,6 +2549,18 @@
   deleteLater();
 }
 
+QString KMCommand::cleanFileName( const QString &name )
+{
+  QString fileName = name.trimmed();
+  // replace all ':' with '_' because ':' isn't allowed on FAT volumes
+  fileName.replace( ':', '_' );
+  // better not use a dir-delimiter in a filename
+  fileName.replace( '/', '_' );
+  fileName.replace( '\\', '_' );
+
+  return fileName;
+}
+
 KMCommand::Result KMSaveAttachmentsCommand::saveItem( partNode *node,
                                                       const KUrl& url )
 {
Index: kmail/kmfoldercachedimap.cpp
===================================================================
--- kmail/kmfoldercachedimap.cpp	(.../tags/KDE/4.3.1/kdepim)	(wersja 1023019)
+++ kmail/kmfoldercachedimap.cpp	(.../branches/KDE/4.3/kdepim)	(wersja 1023019)
@@ -527,6 +527,11 @@
   return KMFolderMaildir::take( idx );
 }
 
+void KMFolderCachedImap::takeTemporarily( int idx )
+{
+  KMFolderMaildir::take( idx );
+}
+
 int KMFolderCachedImap::addMsgInternal( KMMessage *msg, bool newMail, int *index_return )
 {
   // Possible optimization: Only dirty if not filtered below
@@ -1628,7 +1633,7 @@
 bool KMFolderCachedImap::deleteMessages()
 {
   /* Delete messages from cache that are gone from the server */
-  QList<KMMessage*> msgsForDeletion;
+  QList<KMMsgBase*> msgsForDeletion;
 
   /*
    * It is not possible to just go over all indices and remove
@@ -1641,7 +1646,7 @@
     ulong uid ( it.key() );
     if ( uid != 0 && !uidsOnServer.contains( uid ) ) {
       uids << QString::number( uid );
-      msgsForDeletion.append( getMsg( *it ) );
+      msgsForDeletion.append( getMsgBase( *it ) );
     }
   }
 
@@ -1673,6 +1678,11 @@
     job->start();
     return true;
   } else {
+
+    // Nothing to delete on the server, make sure the map is clear again.
+    // Normally this wouldn't be necessary, but there can be stale maps because of
+    // https://issues.kolab.org/issue3833.
+    mDeletedUIDsSinceLastSync.clear();
     return false;
   }
 }
Index: kmail/isubject.cpp
===================================================================
--- kmail/isubject.cpp	(.../tags/KDE/4.3.1/kdepim)	(wersja 1023019)
+++ kmail/isubject.cpp	(.../branches/KDE/4.3/kdepim)	(wersja 1023019)
@@ -25,8 +25,11 @@
 
   void ISubject::notify()
   {
-    for ( QVector<Interface::Observer*>::iterator it = mObserverList.begin() ; it != mObserverList.end() ; ++it )
-      (*it)->update( this );
+    for ( QVector<Interface::Observer*>::iterator it = mObserverList.begin() ; it != mObserverList.end() ; ++it ) {
+      if ( (*it) ) {
+        (*it)->update( this );
+      }
+    }
   }
 
 }
Index: kmail/kmkernel.cpp
===================================================================
--- kmail/kmkernel.cpp	(.../tags/KDE/4.3.1/kdepim)	(wersja 1023019)
+++ kmail/kmkernel.cpp	(.../branches/KDE/4.3/kdepim)	(wersja 1023019)
@@ -738,6 +738,7 @@
                               const QString & messageFile,
                               const QString & MsgStatusFlags)
 {
+  // FIXME: Remove code duplication between this method and dbusAddMessage_fastImport()!
   kDebug();
 
   if ( foldername.isEmpty() || foldername.startsWith('.'))
@@ -751,7 +752,6 @@
   if ( foldername != mAddMessageLastFolder ) {
     mAddMessageMsgIds.clear();
     readFolderMsgIds = true;
-    mAddMessageLastFolder = foldername;
   }
 
   KUrl msgUrl( messageFile );
@@ -804,6 +804,8 @@
       else {
         mAddMsgCurrentFolder = the_folderMgr->findOrCreate(_foldername, false);
       }
+
+      mAddMessageLastFolder = foldername;
     }
 
     if ( mAddMsgCurrentFolder ) {
@@ -917,16 +919,10 @@
     return -1;
 
   int retval;
-  bool createNewFolder = false;
 
   QString _foldername = foldername.trimmed();
   _foldername = _foldername.remove( '\\' ); //try to prevent ESCAPE Sequences
 
-  if ( foldername != mAddMessageLastFolder ) {
-    createNewFolder = true;
-    mAddMessageLastFolder = foldername;
-  }
-
   KUrl msgUrl( messageFile );
   if ( !msgUrl.isEmpty() && msgUrl.isLocalFile() ) {
     const QByteArray messageText =
@@ -937,7 +933,7 @@
     KMMessage *msg = new KMMessage();
     msg->fromString( messageText );
 
-    if (createNewFolder) {
+    if ( foldername != mAddMessageLastFolder ) {
       if ( foldername.contains("/")) {
         QString tmp_fname = "";
         KMFolder *folder = NULL;
@@ -975,6 +971,7 @@
       else {
         mAddMsgCurrentFolder = the_folderMgr->findOrCreate(_foldername, false);
       }
+      mAddMessageLastFolder = foldername;
     }
 
     if ( mAddMsgCurrentFolder ) {
Index: kmail/headerstyle.cpp
===================================================================
--- kmail/headerstyle.cpp	(.../tags/KDE/4.3.1/kdepim)	(wersja 1023019)
+++ kmail/headerstyle.cpp	(.../branches/KDE/4.3/kdepim)	(wersja 1023019)
@@ -758,7 +758,7 @@
         "background-image: url("+imgpath+"shadow_right.png); width: 10px; min-height: 100%;\">&nbsp;</div>";
 
     headerStr +=
-      "<div style=\"margin-left: 8px; top: 0px;\"><span style=\"font-size: 10px; font-weight: bold;\">"+dateString+"</span></div>"
+      "<div style=\"margin-left: 10px; top: 0px;\"><span style=\"font-size: 10px; font-weight: bold;\">"+dateString+"</span></div>"
       // #0057ae
       "<table style=\"background: "+activeColorDark.name()+"; border-collapse:collapse; top: 14px; min-width: 200px; \" cellpadding=0> \n"
       "  <tr> \n"
@@ -836,7 +836,13 @@
         "</div>\n";
     }
 
-    headerStr += "<div style=\"padding: 6px;\">";
+    if ( printing ) {
+      //provide a bit more left padding when printing
+      //kolab/issue3254 (printed mail cut at the left side)
+      headerStr += "<div style=\"padding: 6px; padding-left: 10px;\">";
+    } else {
+      headerStr += "<div style=\"padding: 6px;\">";
+    }
 
     // TODO
     // spam status
Index: kmail/kmfoldercachedimap.h
===================================================================
--- kmail/kmfoldercachedimap.h	(.../tags/KDE/4.3.1/kdepim)	(wersja 1023019)
+++ kmail/kmfoldercachedimap.h	(.../branches/KDE/4.3/kdepim)	(wersja 1023019)
@@ -228,10 +228,23 @@
     /** Reimplemented from KMFolder. Moving is not supported, so aParent must be 0. */
     virtual int rename( const QString &aName, KMFolderDir *aParent = 0 );
 
-    /** Reimplemented from KMFolderMaildir */
-    virtual KMMessage *take( int idx );
     bool canDeleteMessages() const;
 
+    /**
+     * Reimplemented from KMFolderMaildir
+     * This deletes the message permanently, also from the server. For this,
+     * rememberDeletion() is called, so that the message can be deleted from
+     * the server on the next sync.
+     */
+    virtual KMMessage* take( int idx );
+
+    /**
+     * Like take(), only that the deletion is not remembered, i.e. the
+     * message will not be deleted from the server. Calling this can cause
+     * inconsistencies, so make sure you re-add the message later!
+     */
+    void takeTemporarily( int idx );
+
     /** Reimplemented from KMFolderMaildir */
     virtual int addMsg( KMMessage *msg, int *index_return = 0 );
 
Index: kmail/kmmainwidget.cpp
===================================================================
--- kmail/kmmainwidget.cpp	(.../tags/KDE/4.3.1/kdepim)	(wersja 1023019)
+++ kmail/kmmainwidget.cpp	(.../branches/KDE/4.3/kdepim)	(wersja 1023019)
@@ -3546,7 +3546,6 @@
 {
   mMsgActions = new KMail::MessageActions( actionCollection(), this );
   mMsgActions->setMessageView( mMsgView );
-  mMsgActions->setupForwardingActionsList( mGUIClient );
 
   //----- File Menu
   mSaveAsAction = new KAction(KIcon("document-save"), i18n("Save &As..."), this);
@@ -4503,14 +4502,13 @@
   connect( kmkernel->msgTagMgr(), SIGNAL( msgTagListChanged() ),
            this, SLOT( initializeMessageTagActions() ) );
 
-  // plug shortcut filter actions now
+  // Plug various action lists. This can't be done in the constructor, as that is called before
+  // the main window or Kontact calls createGUI().
+  // This function however is called with a single shot timer.
   initializeFilterActions();
-
-  // plug folder shortcut actions
   initializeFolderShortcutActions();
-
-  // plug tag actions now
   initializeMessageTagActions();
+  messageActions()->setupForwardingActionsList( mGUIClient );
 
   QString newFeaturesMD5 = KMReaderWin::newFeaturesMD5();
   if ( kmkernel->firstStart() ||
Index: kmail/kmcommands.h
===================================================================
--- kmail/kmcommands.h	(.../tags/KDE/4.3.1/kdepim)	(wersja 1023019)
+++ kmail/kmcommands.h	(.../branches/KDE/4.3/kdepim)	(wersja 1023019)
@@ -72,6 +72,11 @@
   */
   Result result() const;
 
+  /** cleans a filename by replacing characters not allowed or wanted on the filesystem
+      e.g. ':', '/', '\' with '_'
+  */
+  static QString cleanFileName( const QString &fileName );
+
 public slots:
   // Retrieve messages then calls execute
   void start();
Index: kmail/kmcomposewin.cpp
===================================================================
--- kmail/kmcomposewin.cpp	(.../tags/KDE/4.3.1/kdepim)	(wersja 1023019)
+++ kmail/kmcomposewin.cpp	(.../branches/KDE/4.3/kdepim)	(wersja 1023019)
@@ -2824,6 +2824,8 @@
   msgPart->setSubtypeStr( "zip" );
 
   msgPartToItem( msgPart, attachmentItem, false );
+
+  setModified( true );
 }
 
 //-----------------------------------------------------------------------------
@@ -2892,6 +2894,8 @@
   msgPart->setSubtypeStr( subtype );
 
   msgPartToItem( msgPart, attachmentItem, false );
+
+  setModified( true );
 }
 
 //-----------------------------------------------------------------------------
Index: kmail/folderstorage.cpp
===================================================================
--- kmail/folderstorage.cpp	(.../tags/KDE/4.3.1/kdepim)	(wersja 1023019)
+++ kmail/folderstorage.cpp	(.../branches/KDE/4.3/kdepim)	(wersja 1023019)
@@ -1173,7 +1173,7 @@
   if ( !mSearchPattern )
     return;
   QList<quint32> matchingSerNums;
-  const int end = qMin( mCurrentSearchedMsg + 100, count() );
+  const int end = qMin( mCurrentSearchedMsg + 10, count() );
   for ( int i = mCurrentSearchedMsg; i < end; ++i )
   {
     quint32 serNum = KMMsgDict::instance()->getMsgSerNum( folder(), i );
Index: kmail/recipientseditor.cpp
===================================================================
--- kmail/recipientseditor.cpp	(.../tags/KDE/4.3.1/kdepim)	(wersja 1023019)
+++ kmail/recipientseditor.cpp	(.../branches/KDE/4.3/kdepim)	(wersja 1023019)
@@ -934,8 +934,8 @@
     if ( count++ > GlobalSettings::self()->maximumRecipients() ) {
       KMessageBox::sorry( this,
         i18nc("@info:status", "Truncating recipients list to %1 of %2 entries.",
-          GlobalSettings::self()->maximumRecipients(),
-          r.count() ) );
+              GlobalSettings::self()->maximumRecipients(),
+              r.count() ) );
       break;
     }
     addRecipient( *it, type );
@@ -947,14 +947,15 @@
   QString str;
 
   Recipient::List recipients = mRecipientsView->recipients();
-  Recipient::List::ConstIterator it;
-  for( it = recipients.constBegin(); it != recipients.constEnd(); ++it ) {
-    if ( (*it).type() == type ) {
-      if ( !str.isEmpty() ) str += ", ";
-      str.append( (*it).email() );
+  if ( !recipients.isEmpty() ) {
+    Recipient::List::ConstIterator it;
+    for( it = recipients.constBegin(); it != recipients.constEnd(); ++it ) {
+      if ( (*it).type() == type ) {
+        if ( !str.isEmpty() ) str += ", ";
+        str.append( (*it).email() );
+      }
     }
   }
-
   return str;
 }
 
Index: kmail/regexplineedit.cpp
===================================================================
--- kmail/regexplineedit.cpp	(.../tags/KDE/4.3.1/kdepim)	(wersja 1023019)
+++ kmail/regexplineedit.cpp	(.../branches/KDE/4.3/kdepim)	(wersja 1023019)
@@ -71,6 +71,7 @@
     hlay->setMargin( 0 );
 
     mLineEdit = new KLineEdit( str, this );
+    mLineEdit->setClearButtonShown( true );
     setFocusProxy( mLineEdit );
     hlay->addWidget( mLineEdit );
 
Index: kmail/kmversion.h
===================================================================
--- kmail/kmversion.h	(.../tags/KDE/4.3.1/kdepim)	(wersja 1023019)
+++ kmail/kmversion.h	(.../branches/KDE/4.3/kdepim)	(wersja 1023019)
@@ -3,6 +3,6 @@
 #ifndef kmversion_h
 #define kmversion_h
 
-#define KMAIL_VERSION "1.12.1"
+#define KMAIL_VERSION "1.12.2"
 
 #endif /*kmversion_h*/
Index: doc/kleopatra/index.docbook
===================================================================
--- doc/kleopatra/index.docbook	(.../tags/KDE/4.3.1/kdepim)	(wersja 1023019)
+++ doc/kleopatra/index.docbook	(.../branches/KDE/4.3/kdepim)	(wersja 1023019)
@@ -1246,11 +1246,14 @@
       </para>
 
       <para>
-	The only mandatory key in a <literal>Key Filter
-	#<replaceable>n</replaceable></literal> group is
+	The only mandatory keys in a <literal>Key Filter
+	#<replaceable>n</replaceable></literal> group are
 	<varname>Name</varname>, containing the name of the category
 	as displayed in the <link
-	linkend="configuration-appearance">config dialog</link>.
+	linkend="configuration-appearance">config dialog</link>, and
+	<varname>id</varname>, which is used as a reference for the
+	filter in other configuration sections (such as <literal>View
+	#<replaceable>n</replaceable></literal>).
       </para>
 
       <para>
@@ -1362,6 +1365,21 @@
 	      <entry>the key has been revoked.</entry>
 	    </row>
 	    <row>
+	      <entry><varname>match-context</varname></entry>
+	      <entry>
+                context<footnote>
+                  <para>
+                    Context is an enumeration with the following
+                    allowed values:
+                    <literal>appearance</literal>,
+                    <literal>filtering</literal>
+                    and <literal>any</literal>.
+                  </para>
+                </footnote>
+              </entry>
+	      <entry>the context in which this filter matches.</entry>
+	    </row>
+	    <row>
 	      <entry><varname>is-expired</varname></entry>
 	      <entry>boolean</entry>
 	      <entry>the key is expired.</entry>
@@ -1413,6 +1431,22 @@
 	      </entry>
 	    </row>
 	    <row>
+	      <entry><varname>is-qualified</varname></entry>
+	      <entry>boolean</entry>
+	      <entry>
+		the key can be used to make Qualified Signatures (as
+		defined by the German Digital Signature Law).
+	      </entry>
+	    </row>
+	    <row>
+	      <entry><varname>is-cardkey</varname></entry>
+	      <entry>boolean</entry>
+	      <entry>
+		the key material is stored on a smartcard (instead of
+		on the computer).
+	      </entry>
+	    </row>
+	    <row>
 	      <entry><varname>has-secret-key</varname></entry>
 	      <entry>boolean</entry>
 	      <entry>
Index: doc/ktimetracker/index.docbook
===================================================================
--- doc/ktimetracker/index.docbook	(.../tags/KDE/4.3.1/kdepim)	(wersja 1023019)
+++ doc/ktimetracker/index.docbook	(.../branches/KDE/4.3/kdepim)	(wersja 1023019)
@@ -470,41 +470,28 @@
 
 </sect2>
 
-<sect2 id="dcop"><title>&DCOP;</title>
+<sect2 id="dcop"><title>&DBus;</title>
 
-<para>&DCOP; is the mechanism &kde; programs use to communicate with each
+<para>&DBus; is the mechanism &kde; programs use to communicate with each
 other.  A &kde; program provides a list of functions that other programs (a Bash
 script, for example) can use.</para>
 
 <example><title>Bash script that echo's &karm;'s version</title>
 <programlisting>
-	DCOPID=`dcop | grep karm`
-	if [ $DCOPID ]
-	then
-		VERS=`dcop $DCOPID KarmDCOPIface version`
-		echo "&karm; version is $VERS"
-	else
-		echo "&karm; not running"
-	fi
+qdbus org.kde.ktimetracker /KTimeTracker version 2>/dev/null || echo "ktimetracker not running"
 </programlisting>
 </example>
 
-<para>&karm;'s current &DCOP; interface is currently used mainly for automated
+<para>&karm;'s current &DBus; interface is currently used mainly for automated
 	testing, so it is very limited.  For the full interface definition, see
-	<link linkend="dcopappendix">&DCOP; Interface Appendix</link>.</para>
+	<link linkend="dcopappendix">&DBus; Interface Appendix</link>.</para>
 
-<para>To see the full &DCOP; interface of the &karm; version installed on your
+<para>To see the full &DBus; interface of the &karm; version installed on your
 	system, run the following Bash script:</para>
 
-<example><title>List &karm;'s &DCOP; interface to console</title>
+<example><title>List &karm;'s &DBus; interface to console</title>
 <programlisting>
-	DCOPID=`dcop | grep karm`
-	if [ $DCOPID ]
-	then
-		dcop $DCOPID KarmDCOPIface
-	else
-		echo "&karm; not running"
-	fi
+qdbus org.kde.ktimetracker /KTimeTracker 2>/dev/null || echo "ktimetracker not running"
 </programlisting>
 </example>
 </sect2>
@@ -642,312 +629,6 @@
 
 </sect1>
 
-<sect1 id="menus">
-<title>The &karm; menubar</title>
-<sect2>
-<title>The <guimenu>File</guimenu> menu</title>
-
-<variablelist>
-<varlistentry>
-<term>
-<menuchoice><shortcut>
-<keycombo action="simul">&Ctrl;<keycap>S</keycap></keycombo>
-</shortcut>
-<guimenu>File</guimenu>
-<guimenuitem>Save</guimenuitem>
-</menuchoice></term>
-<listitem>
-<para><action>Saves the current tasks and subtasks with their accumulated
-times</action></para>
-</listitem>
-</varlistentry>
-
-<varlistentry>
-<term>
-<menuchoice>
-<shortcut>
-<keycombo action="simul">&Ctrl;<keycap>P</keycap></keycombo>
-</shortcut>
-<guimenu>File</guimenu>
-<guimenuitem>Print</guimenuitem>
-</menuchoice></term>
-<listitem><para>
-<action>Prints</action> the &karm; window</para>
-</listitem>
-</varlistentry>
-
-<varlistentry>
-<term><menuchoice>
-<guimenu>File</guimenu>
-<guimenuitem>Start New Session</guimenuitem>
-</menuchoice></term>
-<listitem>
-<para><action>Resets </action>all session times to zero</para>
-</listitem>
-</varlistentry>
-
-<varlistentry>
-<term><menuchoice>
-<guimenu>File</guimenu>
-<guimenuitem>Reset All Times</guimenuitem>
-</menuchoice></term>
-<listitem>
-<para><action>Resets </action>all times to zero</para>
-</listitem>
-</varlistentry>
-
-<varlistentry>
-<term><menuchoice>
-<guimenu>File</guimenu>
-<guisubmenu>Import/Export</guisubmenu>
-<guimenuitem>Import Legacy Flat File...</guimenuitem>
-</menuchoice></term>
-<listitem>
-<para><action>Import </action>old style &karm; save files (&karm; 
-now uses iCalendar-style save files.)</para>
-</listitem>
-</varlistentry>
-
-<varlistentry>
-<term><menuchoice>
-<guimenu>File</guimenu>
-<guisubmenu>Import/Export</guisubmenu>
-<guimenuitem>Import Tasks from Planner...</guimenuitem>
-</menuchoice></term>
-<listitem>
-<para><action>Import </action>an imendio planner project (see <ulink
-url="http://planner.imendio.org">planner.imendio.org</ulink>). All tasks, subtasks and their "completed" flag will be imported from a .planner-file. You can import them as a subtask by creating a subtask, leaving it marked, and then importing. </para>
-</listitem>
-</varlistentry>
-
-<varlistentry>
-<term>
-<menuchoice>
-<guimenu>File</guimenu>
-<guisubmenu>Import/Export</guisubmenu>
-<guimenuitem>Export to CSV file...</guimenuitem>
-</menuchoice></term>
-<listitem>
-<para><action>Export </action>
-<guilabel>Total Session Time</guilabel>,
-<guilabel>Session Time</guilabel>, <guilabel>Time</guilabel>, and
-<guilabel>Total Time</guilabel> to a text file.</para>
-</listitem>
-</varlistentry>
-
-<varlistentry>
-<term><menuchoice>
-<guimenu>File</guimenu>
-<guisubmenu>Import/Export</guisubmenu>
-<guimenuitem>Export History to CSV file...</guimenuitem>
-</menuchoice></term>
-<listitem>
-<para><action>Export </action> task history to a text file.
-</para>
-</listitem>
-</varlistentry>
-
-<varlistentry>
-<term><menuchoice>
-<shortcut>
-<keycombo action="simul">&Ctrl;<keycap>C</keycap></keycombo>
-</shortcut>
-<guimenu>File</guimenu>
-<guimenuitem>Copy Totals to Clipboard</guimenuitem>
-</menuchoice></term>
-<listitem>
-<para><action>Copies </action> the current total time for a 
-task or all tasks to the &kde; clipboard</para>
-</listitem>
-</varlistentry>
-
-<varlistentry>
-<term><menuchoice>
-<shortcut>
-<keycombo action="simul">&Ctrl;&Alt;<keycap>C</keycap></keycombo>
-</shortcut>
-<guimenu>File</guimenu>
-<guimenuitem>Copy History to Clipboard</guimenuitem>
-</menuchoice></term>
-<listitem>
-<para><action>Copies </action> daily times for a 
-given period to the &kde; clipboard</para>
-</listitem>
-</varlistentry>
-
-<varlistentry>
-<term><menuchoice>
-<shortcut>
-<keycombo action="simul">&Ctrl;<keycap>Q</keycap></keycombo>
-</shortcut>
-<guimenu>File</guimenu>
-<guimenuitem>Quit</guimenuitem>
-</menuchoice></term>
-<listitem>
-<para><action>Closes</action> &karm;</para>
-</listitem>
-</varlistentry>
-</variablelist>
-
-</sect2>
-
-<sect2>
-<title>The <guimenu>Clock</guimenu> menu</title>
-
-<variablelist>
-<varlistentry>
-<term>
-<menuchoice>
-<shortcut><keycap>S</keycap></shortcut>
-<guimenu>Clock</guimenu>
-<guimenuitem>Start</guimenuitem>
-</menuchoice>
-</term>
-<listitem>
-<para><action>Starts</action> timing the selected task</para></listitem>
-</varlistentry>
-
-<varlistentry>
-<term>
-<menuchoice>
-<guimenu>Clock</guimenu>
-<guimenuitem>Stop</guimenuitem>
-</menuchoice>
-</term>
-<listitem>
-<para><action>Stops</action> timing the selected task</para></listitem>
-</varlistentry>
-
-<varlistentry>
-<term>
-<menuchoice>
-<shortcut><keycap>&Esc;</keycap></shortcut>
-<guimenu>Clock</guimenu>
-<guimenuitem>Stop All Timers</guimenuitem>
-</menuchoice>
-</term>
-<listitem><para><action>Stops</action> timing all tasks</para></listitem>
-</varlistentry>
-</variablelist>
-</sect2>
-
-<sect2>
-<title>The <guimenu>Task</guimenu> menu</title>
-
-<variablelist>
-<varlistentry>
-<term>
-<menuchoice>
-<shortcut>
-<keycombo action="simul">&Ctrl;<keycap>N</keycap></keycombo>
-</shortcut>
-<guimenu>Task</guimenu>
-<guimenuitem>New</guimenuitem>
-</menuchoice>
-</term>
-<listitem><para><action>Add</action> a new task</para></listitem>
-</varlistentry>
-
-<varlistentry>
-<term>
-<menuchoice>
-<shortcut>
-<keycombo action="simul">&Ctrl;&Alt;<keycap>N</keycap></keycombo>
-</shortcut>
-<guimenu>Task</guimenu>
-<guimenuitem>New Subtask</guimenuitem>
-</menuchoice>
-</term>
-<listitem>
-<para><action>Add</action> a new subtask to the selected task</para>
-</listitem>
-</varlistentry>
-
-<varlistentry>
-<term>
-<menuchoice>
-<shortcut>
-<keycap>Del</keycap>
-</shortcut>
-<guimenu>Task</guimenu>
-<guimenuitem>Delete</guimenuitem>
-</menuchoice>
-</term>
-<listitem>
-<para><action>Delete</action> the selected task or subtask</para>
-</listitem>
-</varlistentry>
-
-<varlistentry>
-<term>
-<menuchoice>
-<shortcut>
-<keycombo action="simul">&Ctrl;<keycap>E</keycap></keycombo>
-</shortcut>
-<guimenu>Task</guimenu>
-<guimenuitem>Edit</guimenuitem>
-</menuchoice>
-</term>
-<listitem>
-<para><action>Change the name or accumulated time</action> for the
-current task</para><para>There are two options for changing the time: Edit
-Absolute, in which the session and total times can be changed separately;
-and Edit Relative, in which a certain change is added to or subtracted from
-both the session and total times.</para><para>The Auto tracking option allows 
-timing to start and stop automatically when you switch to or from a particular 
-&kde; desktop.</para>
-</listitem>
-</varlistentry>
-</variablelist>
-</sect2>
-
-<sect2>
-<title>The <guimenu>Settings</guimenu> menu</title>
-<variablelist>
-
-
-<varlistentry>
-<term>
-<menuchoice>
-<guimenu>Settings</guimenu>
-<guimenuitem>Configure Shortcuts</guimenuitem>
-</menuchoice>
-</term>
-<listitem><para><action>Opens</action> a dialog to allow the user to customize
-the keyboard shortcuts</para>
-</listitem>
-</varlistentry>
-
-<varlistentry>
-<term>
-<menuchoice>
-<guimenu>Settings</guimenu>
-<guimenuitem>Configure &karm;</guimenuitem>
-</menuchoice>
-</term>
-<listitem><para><action>Opens</action> a dialog to allow the user to
-configure &karm;</para>
-
-<para>The dialog has three tabbed panes: <guilabel>Behavior </guilabel>, which 
-allows you to specify an alert for no activity and a warning message when you 
-delete a task set, <guilabel>Display </guilabel>, which configures the fields 
-shown in the main window and <guilabel>Storage</guilabel>,
-which configures the location of the save file, whether auto saving is
-enabled and the auto save interval.</para> </listitem>
-</varlistentry>
-
-</variablelist>
-</sect2>
-
-<sect2>
-<title>The <guimenu>Help</guimenu> menu</title>
-
-&help.menu.documentation;
-
-</sect2>
-
-</sect1>
-
 <sect1 id="tool-bar">
 <title>The Toolbar</title>
 <para>The toolbar contains icons for the following commands:</para>
@@ -1033,7 +714,7 @@
 </glossentry>
 
 <glossentry id="gloss-dcop">
-<glossterm>&DCOP;</glossterm>
+<glossterm>&DBus;</glossterm>
 <glossdef><para>The interprocess communication protocol used in &kde;.  Short
 for Desktop COmmunication Protocol.</para></glossdef>
 </glossentry>
@@ -1106,7 +787,7 @@
 
 </appendix>
 
-<appendix id="dcopappendix"><title>&DCOP; Interface</title>
+<appendix id="dcopappendix"><title>&DBus; Interface</title>
 
 <refentry id="dcop-version">
 <refmeta>
@@ -1123,7 +804,7 @@
 </refsynopsisdiv>
 <refsect1>
 <title>Description</title>
-<para><function>version()</function> is a &DCOP; call that returns &karm;'s
+<para><function>version()</function> is a &DBus; call that returns &karm;'s
 version number; for example 1.5.0.  The version number is returned as a string
 in the typical &GNU; format of major.minor.bugfix.</para>
 </refsect1>
@@ -1144,7 +825,7 @@
 </refsynopsisdiv>
 <refsect1>
 <title>Description</title>
-<para><function>quit()</function> is a &DCOP; call that provides a way that an
+<para><function>quit()</function> is a &DBus; call that provides a way that an
 external program can gracefully shutdown &karm;.
 </para>
 </refsect1>
@@ -1176,7 +857,7 @@
 </refsynopsisdiv>
 <refsect1>
 <title>Description</title>
-<para><function>hastodo(QString taskname)</function> is a &DCOP; call that
+<para><function>hastodo(QString taskname)</function> is a &DBus; call that
 	looks for a of the given name.  If found, it returns the
 	iCalendar UID that identifies that to-do.  If not found, it returns an empty
 	string.
@@ -1214,7 +895,7 @@
 
 <refsect1>
 <title>Description</title>
-<para><function>addtodo(QString todoname)</function> is a &DCOP; call that
+<para><function>addtodo(QString todoname)</function> is a &DBus; call that
 	adds a new top-level to-do to the current storage.  The UID of the new to-do
 	is returned.
 </para>
Index: doc/kmail/configure.docbook
===================================================================
--- doc/kmail/configure.docbook	(.../tags/KDE/4.3.1/kdepim)	(wersja 1023019)
+++ doc/kmail/configure.docbook	(.../branches/KDE/4.3/kdepim)	(wersja 1023019)
@@ -1930,6 +1930,21 @@
 <para>Invitations use to be send as attachments to a mail. By enabling this option, you let the invitation mails to be sent in the text of the mail, which is necessary to send invitations and replies to Microsoft Outlook(tm).</para>
 </listitem>
 </varlistentry>
+<varlistentry>
+<term><guilabel>Exchange compatible invitations naming</guilabel></term>
+<listitem>
+<para>Microsoft Outlook, when used in combination with a Microsoft Exchange
+server, has a problem understanding standards-compliant groupware e-mail.
+Enable this option to send groupware invitations in a way that Microsoft
+Exchange understands. The invitation will be sent as an attachment with name <filename>ical.ics</filename>.</para>
+</listitem>
+</varlistentry>
+<varlistentry>
+<term><guilabel>Outlook compatible invitation reply comments</guilabel></term>
+<listitem>
+<para>When the user provides comments when responding to invitations, send the comment in way that Microsoft Outlook(tm) understands. If this option is not enabled, the reponse comments will not be seen in Outlook.</para>
+</listitem>
+</varlistentry>
 </variablelist>
 </sect2>
 
Index: doc/knode/more.docbook
===================================================================
--- doc/knode/more.docbook	(.../tags/KDE/4.3.1/kdepim)	(wersja 1023019)
+++ doc/knode/more.docbook	(.../branches/KDE/4.3/kdepim)	(wersja 1023019)
@@ -98,10 +98,10 @@
 url="http://www.kirchwitz.de/~amk/dni/usenet-einfuehrung">http://www.kirchwitz.de/~amk/dni/usenet-einfuehrung</ulink>
 (German)</member> 
 <member>Why should I take the rules seriously? <ulink
-url="http://www.kirchwitz.de/~amk/dni/warum-regel">http://www.kirchwitz.de/~amk/dni/warum-regel</ulink>
+url="http://www.kirchwitz.de/~amk/dni/warum-regeln">http://www.kirchwitz.de/~amk/dni/warum-regeln</ulink>
 (German)</member> 
 <member>The newsreader <acronym>FAQ</acronym>: <ulink
-url="http://www.crosswinds.net/~cgarbers/faq/newsreaderFAQ.htm">http://www.crosswinds.net/~cgarbers/faq/newsreaderFAQ.htm</ulink></member> 
+url="http://www.thomas-huehn.de/usenet/newsreaderFAQ.txt">http://www.thomas-huehn.de/usenet/newsreaderFAQ.txt</ulink> (German)</member> 
 <member>The correct quoting: <ulink
 url="http://www.afaik.de/usenet/faq/zitieren">http://www.afaik.de/usenet/faq/zitieren</ulink>
 (German)</member> 
@@ -122,13 +122,13 @@
 <simplelist> 
 <member>Header entries: <ulink url="http://www.kirchwitz.de/~amk/dni/headerzeilen"> 
 http://www.kirchwitz.de/~amk/dni/headerzeilen</ulink> (German)</member> 
-<member>A very useful message-ID <acronym>FAQ</acronym>: <ulink url="http://www.qad.org/faq/faq-messageid.html"> 
-http://www.qad.org/faq/faq-messageid.html</ulink></member> 
+<member>A very useful message-ID <acronym>FAQ</acronym>: <ulink url="http://www.hanau.net/usenet/faq/messageid.php"> 
+http://www.hanau.net/usenet/faq/messageid.php (German)</ulink></member> 
 <member>A lot of links about newsreaders and related topics: <ulink
-url="http://www.leafnode.org/links">http://www.leafnode.org/links</ulink></member> 
+url="http://www.leafnode.org/links.shtml">http://www.leafnode.org/links.shtml</ulink></member> 
 <member><acronym>RFC</acronym>s, Drafts and documents for the technical
-interested: <ulink url="http://www.landfield.com/usefor/"> 
-http://www.landfield.com/usefor/</ulink></member> 
+interested: <ulink url="http://tools.ietf.org/wg/usefor/">
+http://tools.ietf.org/wg/usefor/</ulink></member> 
 </simplelist> 
 </sect1> 
 </chapter> 
Index: doc/kpilot/usage.docbook
===================================================================
--- doc/kpilot/usage.docbook	(.../tags/KDE/4.3.1/kdepim)	(wersja 1023019)
+++ doc/kpilot/usage.docbook	(.../branches/KDE/4.3/kdepim)	(wersja 1023019)
@@ -8,7 +8,7 @@
 </para>
 
 <para>
-On the first start &kpilot; opens the configuration dialog which allows to you adjust its 
+On the first start &kpilot; opens the configuration dialog which allows you to adjust its 
 settings and select and configure the conduits to be used.
 Click the <guibutton>OK</guibutton> button to switch to the
 &HotSync;-log, as shown <link linkend="main-app">here</link>.
Index: doc/kalarm/index.docbook
===================================================================
--- doc/kalarm/index.docbook	(.../tags/KDE/4.3.1/kdepim)	(wersja 1023019)
+++ doc/kalarm/index.docbook	(.../branches/KDE/4.3/kdepim)	(wersja 1023019)
@@ -41,8 +41,8 @@
 
 <!-- Don't change format of date and version of the documentation -->
 
-<date>2009-05-25</date>
-<releaseinfo>2.02.00</releaseinfo>
+<date>2008-09-25</date>
+<releaseinfo>2.2.7</releaseinfo>
 
 <abstract>
 <para>&kalarm; is a personal alarm message, command and email scheduler for &kde;.</para>
@@ -423,21 +423,25 @@
 <sect2>
 <title>Deleting/Reactivating an Alarm</title>
 
-<para>To delete existing alarms, do one of the following:</para>
+<para>To delete existing alarms, select one or more by clicking on
+their entries in the alarm list. Then do one of the following:</para>
 
 <itemizedlist>
 <listitem>
-<para>Select one or more alarms by clicking on their entries in the
-alarm list. Then choose <menuchoice>
+<para>Choose <menuchoice>
 <guimenu>Actions</guimenu><guimenuitem>Delete</guimenuitem>
 </menuchoice>.</para>
 </listitem>
 <listitem>
-<para><mousebutton>Right</mousebutton> click on the desired entries in
-the alarm list and choose
+<para><mousebutton>Right</mousebutton> click on the selected entries
+and choose
 <menuchoice><guimenuitem>Delete</guimenuitem></menuchoice>
 from the context menu.</para>
 </listitem>
+<listitem>
+<para>To delete them without a confirmation prompt, type
+&Shift;-<keycap>Delete</keycap>.</para>
+</listitem>
 </itemizedlist>
 
 <para>When you delete an active alarm, it is archived, provided that
@@ -2833,7 +2837,7 @@
   <replaceable>period</replaceable></option></entry>
   <entry>Cancel the alarm if it cannot be triggered within the
   specified <replaceable>period</replaceable> after the correct
-  time. The <replaceable>period</replaceable> period is specified in
+  time. The <replaceable>period</replaceable> is specified in
   the same format as described for <option>--reminder</option>.
   The default value of <replaceable>period</replaceable> is 1
   minute.</entry>
Index: kalarm/functions.h
===================================================================
--- kalarm/functions.h	(.../tags/KDE/4.3.1/kdepim)	(wersja 1023019)
+++ kalarm/functions.h	(.../branches/KDE/4.3/kdepim)	(wersja 1023019)
@@ -141,21 +141,7 @@
 KDateTime           applyTimeZone(const QString& tzstring, const QDate& date, const QTime& time,
                                   bool haveTime, const KDateTime& defaultDt = KDateTime());
 bool                isWorkingTime(const KDateTime&, const KAEvent*);
-int                 localeFirstDayOfWeek();
-QString             weekDayName(int day, const KLocale*);
 
-/* Given a standard KDE day number, return the day number in the week for the user's locale.
- * Standard day number = 1 (Mon) .. 7 (Sun)
- * Locale day number in week = 0 .. 6
- */
-inline int          weekDay_to_localeDayInWeek(int weekDay)  { return (weekDay + 7 - localeFirstDayOfWeek()) % 7; }
-
-/* Given a day number in the week for the user's locale, return the standard KDE day number.
- * 'index' = 0 .. 6
- * Standard day number = 1 (Mon) .. 7 (Sun)
- */
-inline int          localeDayInWeek_to_weekDay(int index)  { return (index + localeFirstDayOfWeek() - 1) % 7 + 1; }
-
 #ifndef NDEBUG
 void                setTestModeConditions();
 void                setSimulatedSystemTime(const KDateTime&);
Index: kalarm/Changelog
===================================================================
--- kalarm/Changelog	(.../tags/KDE/4.3.1/kdepim)	(wersja 1023019)
+++ kalarm/Changelog	(.../branches/KDE/4.3/kdepim)	(wersja 1023019)
@@ -1,5 +1,8 @@
 KAlarm Change Log
 
+=== Version 2.2.8 --- 19 August 2009 ===
+- Use KDE system settings to determine default working days in the week.
+
 === Version 2.2.7 (KDE 4.3.1) --- 19 August 2009 ===
 - Shift-Delete now deletes alarms without showing confirmation prompt.
 - Disable edit alarm dialogue OK button if no changes have been made.
Index: kalarm/lib/kalocale.h
===================================================================
--- kalarm/lib/kalocale.h	(.../tags/KDE/4.3.1/kdepim)	(wersja 0)
+++ kalarm/lib/kalocale.h	(.../branches/KDE/4.3/kdepim)	(wersja 1023019)
@@ -0,0 +1,54 @@
+/*
+ *  kalocale.h  -  miscellaneous locale functions
+ *  Program:  kalarm
+ *  Copyright © 2004-2009 by David Jarvie <djarvie@kde.org>
+ *
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the GNU General Public License as published by
+ *  the Free Software Foundation; either version 2 of the License, or
+ *  (at your option) any later version.
+ *
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
+ *  GNU General Public License for more details.
+ *
+ *  You should have received a copy of the GNU General Public License along
+ *  with this program; if not, write to the Free Software Foundation, Inc.,
+ *  51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ */
+
+#ifndef LOCALE_H
+#define LOCALE_H
+
+#include <QString>
+class KLocale;
+
+namespace KAlarm
+{
+
+/** Return the first day of the week for the user's locale.
+*   Reply = 1 (Mon) .. 7 (Sun).
+*/
+int        localeFirstDayOfWeek();
+
+/** Return the week day name (Monday = 1). */
+QString    weekDayName(int day, const KLocale*);
+
+/* Given a standard KDE day number, return the day number in the week for the user's locale.
+ * Standard day number = 1 (Mon) .. 7 (Sun)
+ * Locale day number in week = 0 .. 6
+ */
+inline int weekDay_to_localeDayInWeek(int weekDay)  { return (weekDay + 7 - localeFirstDayOfWeek()) % 7; }
+
+/* Given a day number in the week for the user's locale, return the standard KDE day number.
+ * 'index' = 0 .. 6
+ * Standard day number = 1 (Mon) .. 7 (Sun)
+ */
+inline int localeDayInWeek_to_weekDay(int index)  { return (index + localeFirstDayOfWeek() - 1) % 7 + 1; }
+
+uint defaultWorkDays();
+
+} // namespace KAlarm
+
+#endif // LOCALE_H
Index: kalarm/lib/kalocale.cpp
===================================================================
--- kalarm/lib/kalocale.cpp	(.../tags/KDE/4.3.1/kdepim)	(wersja 0)
+++ kalarm/lib/kalocale.cpp	(.../branches/KDE/4.3/kdepim)	(wersja 1023019)
@@ -0,0 +1,83 @@
+/*
+ *  kalocale.cpp  -  miscellaneous locale functions
+ *  Program:  kalarm
+ *  Copyright © 2003-2009 by David Jarvie <djarvie@kde.org>
+ *
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the GNU General Public License as published by
+ *  the Free Software Foundation; either version 2 of the License, or
+ *  (at your option) any later version.
+ *
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
+ *  GNU General Public License for more details.
+ *
+ *  You should have received a copy of the GNU General Public License along
+ *  with this program; if not, write to the Free Software Foundation, Inc.,
+ *  51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ */
+
+#include "kalarm.h"   //krazy:exclude=includes (kalarm.h must be first)
+#include "kalocale.h"
+
+#include <kglobal.h>
+#include <klocale.h>
+#include <kdebug.h>
+
+
+namespace KAlarm
+{
+
+/******************************************************************************
+*  Return the first day of the week for the user's locale.
+*  Reply = 1 (Mon) .. 7 (Sun).
+*/
+int localeFirstDayOfWeek()
+{
+	static int firstDay = 0;
+	if (!firstDay)
+		firstDay = KGlobal::locale()->weekStartDay();
+	return firstDay;
+}
+
+/******************************************************************************
+* Return the week day name (Monday = 1).
+*/
+QString weekDayName(int day, const KLocale* locale)
+{
+	switch (day)
+	{
+		case 1: return ki18nc("@option Name of the weekday", "Monday").toString(locale);
+		case 2: return ki18nc("@option Name of the weekday", "Tuesday").toString(locale);
+		case 3: return ki18nc("@option Name of the weekday", "Wednesday").toString(locale);
+		case 4: return ki18nc("@option Name of the weekday", "Thursday").toString(locale);
+		case 5: return ki18nc("@option Name of the weekday", "Friday").toString(locale);
+		case 6: return ki18nc("@option Name of the weekday", "Saturday").toString(locale);
+		case 7: return ki18nc("@option Name of the weekday", "Sunday").toString(locale);
+	}
+	return QString();
+}
+
+/******************************************************************************
+* Return the default work days in the week, as a bit mask.
+* They are determined by the start and end work days in system settings.
+*/
+uint defaultWorkDays()
+{
+	KLocale* locale = KGlobal::locale();
+	int end = locale->workingWeekEndDay() - 1;
+	uint days = 0;
+	for (int day = locale->workingWeekStartDay() - 1;  ; )
+	{
+		days |= 1 << day;
+		if (day == end)
+			break;
+		++day;
+		if (day >= 7)
+			day = 0;
+	}
+	return days;
+}
+
+} // namespace KAlarm
Index: kalarm/functions.cpp
===================================================================
--- kalarm/functions.cpp	(.../tags/KDE/4.3.1/kdepim)	(wersja 1023019)
+++ kalarm/functions.cpp	(.../branches/KDE/4.3/kdepim)	(wersja 1023019)
@@ -1562,36 +1562,6 @@
 }
 
 /******************************************************************************
-*  Return the first day of the week for the user's locale.
-*  Reply = 1 (Mon) .. 7 (Sun).
-*/
-int localeFirstDayOfWeek()
-{
-	static int firstDay = 0;
-	if (!firstDay)
-		firstDay = KGlobal::locale()->weekStartDay();
-	return firstDay;
-}
-
-/******************************************************************************
-* Return the week day name (Monday = 1).
-*/
-QString weekDayName(int day, const KLocale* locale)
-{
-	switch (day)
-	{
-		case 1: return ki18nc("@option Name of the weekday", "Monday").toString(locale);
-		case 2: return ki18nc("@option Name of the weekday", "Tuesday").toString(locale);
-		case 3: return ki18nc("@option Name of the weekday", "Wednesday").toString(locale);
-		case 4: return ki18nc("@option Name of the weekday", "Thursday").toString(locale);
-		case 5: return ki18nc("@option Name of the weekday", "Friday").toString(locale);
-		case 6: return ki18nc("@option Name of the weekday", "Saturday").toString(locale);
-		case 7: return ki18nc("@option Name of the weekday", "Sunday").toString(locale);
-	}
-	return QString();
-}
-
-/******************************************************************************
 * Convert a date/time specification string into a local date/time or date value.
 * Parameters:
 *   timeString  = in the form [[[yyyy-]mm-]dd-]hh:mm [TZ] or yyyy-mm-dd [TZ].
Index: kalarm/kalarmconfig.kcfg
===================================================================
--- kalarm/kalarmconfig.kcfg	(.../tags/KDE/4.3.1/kdepim)	(wersja 1023019)
+++ kalarm/kalarmconfig.kcfg	(.../branches/KDE/4.3/kdepim)	(wersja 1023019)
@@ -10,6 +10,7 @@
   <include>qnamespace.h</include>
   <include>kglobalsettings.h</include>
   <include>"timeperiod.h"</include>
+  <include>"kalocale.h"</include>
 
   <kcfgfile name="kalarmrc"/>
 
@@ -193,7 +194,7 @@
     <entry name="Base_WorkDays" key="WorkDays" type="UInt">
       <label context="@label">Working days</label>
       <whatsthis context="@info:whatsthis">OR'ed bits indicating which days of the week are work days, 1 = Monday ... 64 = Sunday.</whatsthis>
-      <default>31</default>
+      <default code="true">KAlarm::defaultWorkDays()</default>
       <emit signal="base_WorkTimeChanged"/>
     </entry>
     <entry name="DisabledColour" type="Color">
Index: kalarm/prefdlg.cpp
===================================================================
--- kalarm/prefdlg.cpp	(.../tags/KDE/4.3.1/kdepim)	(wersja 1023019)
+++ kalarm/prefdlg.cpp	(.../branches/KDE/4.3/kdepim)	(wersja 1023019)
@@ -32,6 +32,7 @@
 #include "identities.h"
 #include "itembox.h"
 #include "kalarmapp.h"
+#include "kalocale.h"
 #include "kamail.h"
 #include "label.h"
 #include "latecancel.h"
Index: kalarm/CMakeLists.txt
===================================================================
--- kalarm/CMakeLists.txt	(.../tags/KDE/4.3.1/kdepim)	(wersja 1023019)
+++ kalarm/CMakeLists.txt	(.../branches/KDE/4.3/kdepim)	(wersja 1023019)
@@ -30,6 +30,7 @@
 	lib/identities.cpp
 	lib/itembox.cpp
 	lib/label.cpp 
+	lib/kalocale.cpp
 	lib/messagebox.cpp 
 	lib/packedlayout.cpp 
 	lib/pushbutton.cpp 
Index: kalarm/recurrenceedit.cpp
===================================================================
--- kalarm/recurrenceedit.cpp	(.../tags/KDE/4.3.1/kdepim)	(wersja 1023019)
+++ kalarm/recurrenceedit.cpp	(.../branches/KDE/4.3/kdepim)	(wersja 1023019)
@@ -50,6 +50,7 @@
 #include "dateedit.h"
 #include "functions.h"
 #include "kalarmapp.h"
+#include "kalocale.h"
 #include "karecurrence.h"
 #include "preferences.h"
 #include "radiobutton.h"
Index: kaddressbook/xxport/gmx_xxport.cpp
===================================================================
--- kaddressbook/xxport/gmx_xxport.cpp	(.../tags/KDE/4.3.1/kdepim)	(wersja 1023019)
+++ kaddressbook/xxport/gmx_xxport.cpp	(.../branches/KDE/4.3/kdepim)	(wersja 1023019)
@@ -1,10 +1,13 @@
 /*
     This file is part of KAddressbook.
     Copyright (c) 2003 - 2004 Helge Deller <deller@kde.org>
+    Copyright (c) 2009 Laurent Montel <montel@kde.org>
+    Copyright (c) 2009 Urs Joss <tschenturs@gmx.ch>
 
     This program is free software; you can redistribute it and/or modify
-    it under the terms of the GNU General Public License version 2 as
-    published by the Free Software Foundation.
+    it under the terms of the GNU General Public License as published by
+    the Free Software Foundation; either version 2 of the License, or
+    (at your option) any later version.
 
     This program is distributed in the hope that it will be useful,
     but WITHOUT ANY WARRANTY; without even the implied warranty of
@@ -18,21 +21,67 @@
     As a special exception, permission is given to link this program
     with any edition of Qt, and distribute the resulting executable,
     without including the source code for Qt in the source distribution.
+*/
 
+/*
+    Description:
 
-    Description:
     This import/export filter reads and writes addressbook entries in the
     gmx format which is natively used by the german freemail provider GMX.
     The big advantage of this format is, that it stores it's information
-    very consistent and makes parsing pretty simple. Furthermore, most
+    very consistently and makes parsing pretty simple. Furthermore, most
     information needed by KABC is available when compared to other formats.
     For further information please visit http://www.gmx.com
+
+    A couple of notes:
+
+    a) Categories
+
+    GMX allows to define categories in the UI and assign one or more categories
+    to each addressee. The gmxa file contains a list of defined categories in
+    the last part of the file, in the section AB_CATEGORIES. The Category_id in
+    this list is a 1-based index. The multi-category assignement of each
+    contact consists of a bitfield which applies one bit per category. E.g.
+    if one contact belongs to category 1 and 3, the bit-field for the category
+    assignment for this addressee is 0101 or decimal 5.
+
+    The export of categories into hte gmxa file works flawlessly and also
+    transfers nicely into the addressee categories. During the import of a
+    gmxa file into GMX, the procedure will correctly manage the category
+    bitfield for each contact. However GMX does *not* process the category
+    list in the end of the file. In other words: If your categories have
+    changed (either in kadderssbook or in GMX) since your
+    previous import, the addressee records may point to the wrong - or even
+    non-existing - categories. After an import it is suggested that you
+    manually verify the category list is still valid. If not, you need to
+    manually delete any categories which alphabetically list beyond your new
+    or deleted category and recreate the remaining categories.
+
+    Only up to 31 different categories over all contacts are exported. Any
+    more categories are ignored.
+
+    b) Address types
+
+    Home address and Work address are relatively straight forwardly handled.
+    The third address type "Other" is factored out of a bunch of different
+    address elements, which have been chosen relatively at random. There is
+    some interpretation which is not completely reversible.
+
+    If you thus export a contact from kaddressbook to GMX
+    and reimport it into kaddressbook, you will not exactly
+    get the same contact as the original one.
+
+    Also other items affect this non-reversability: GMX should receive a nick
+    name in the gmxa file. If there is none defined in kaddressbook,
+    the export will use the formatted name instead. If you reimport
+    such a record, you'll end up with the formatted name in the nickname field.
 */
 
 #include "gmx_xxport.h"
 
 #include <QtCore/QFile>
 #include <QtCore/QMap>
+#include <QtCore/QList>
 #include <QtCore/QTextStream>
 
 #include <kcodecs.h>
@@ -46,8 +95,13 @@
 
 K_EXPORT_KADDRESSBOOK_XXFILTER_CATALOG( kaddrbk_gmx_xxport, GMXXXPort, "kaddrbk_gmx_xxport" )
 
-#define GMX_FILESELECTION_STRING "*.gmxa|" + i18n( "GMX address book file (*.gmxa)" )
+#define GMX_FILESELECTION_STRING "*.gmxa|" + \
+  i18n( "GMX address book file (*.gmxa)" )
 
+const int typeHome  = 0;
+const int typeWork  = 1;
+const int typeOther = 2;
+
 GMXXXPort::GMXXXPort( KABC::AddressBook *ab, QWidget *parent, const char *name )
   : KAB::XXPort( ab, parent, name )
 {
@@ -57,32 +111,32 @@
 
 static bool checkDateTime( const QString &dateStr, QDateTime &dt )
 {
-  if (dateStr.isEmpty())
+  if ( dateStr.isEmpty() )
      return false;
-  dt = QDateTime::fromString(dateStr, Qt::ISODate);
-  if (dt.isValid() && dt.date().year()>1901)
+  dt = QDateTime::fromString( dateStr, Qt::ISODate );
+  if ( dt.isValid() && dt.date().year()>1901 )
      return true;
-  dt.setDate(QDate());
+  dt.setDate( QDate() );
   return false;
 }
 
 /* import */
 
-KABC::Addressee::List GMXXXPort::importContacts( const QString& ) const
+KABC::Addressee::List GMXXXPort::importContacts( const QString &data ) const
 {
-  KABC::Addressee::List addrList;
+  KABC::Addressee::List addresseeList;
 
   QString fileName = KFileDialog::getOpenFileName( QDir::homePath(),
-                      GMX_FILESELECTION_STRING, 0 );
+                       GMX_FILESELECTION_STRING, 0 );
   if ( fileName.isEmpty() )
-    return addrList;
+    return addresseeList;
 
   QFile file( fileName );
   if ( !file.open( QIODevice::ReadOnly ) ) {
     QString msg = i18n( "<qt>Unable to open <b>%1</b> for reading.</qt>",
                         fileName );
     KMessageBox::error( parentWidget(), msg );
-    return addrList;
+    return addresseeList;
   }
 
   QDateTime dt;
@@ -91,132 +145,204 @@
   QString line, line2;
   line  = gmxStream.readLine();
   line2 = gmxStream.readLine();
-  if (!line.startsWith(QLatin1String("AB_ADDRESSES:")) || !line2.startsWith(QLatin1String("Address_id"))) {
-	KMessageBox::error( parentWidget(), i18n("%1 is not a GMX address book file.", fileName) );
-	return addrList;
+  if ( !line.startsWith( QLatin1String( "AB_ADDRESSES:" ) ) ||
+      !line2.startsWith( QLatin1String( "Address_id"    ) ) ) {
+    KMessageBox::error( parentWidget(),
+      i18n( "%1 is not a GMX address book file.", fileName ) );
+    return addresseeList;
   }
 
-  QStringList strList;
-  typedef QMap<QString, KABC::Addressee *> AddressMap;
-  AddressMap addrMap;
+  QStringList itemList;
+  QMap<QString, QString>  categoriesOfAddressee;
+  typedef QMap<QString, KABC::Addressee *> AddresseeMap;
+  AddresseeMap addresseeMap;
 
-  // "Address_id,Nickname,Firstname,Lastname,Title,Birthday,Comments,Change_date,Status,Address_link_id,Categories"
+  // "Address_id,Nickname,Firstname,Lastname,Title,Birthday,Comments,
+  // Change_date,Status,Address_link_id,Categories"
   line = gmxStream.readLine();
-  while (!line.startsWith(QLatin1String("####")) && !gmxStream.atEnd()) {
-    while (1) {
-       strList = line.split('#', QString::KeepEmptyParts );
-       if (strList.count() >= 11)
+  while ( ( line!=QLatin1String( "####" ) ) && !gmxStream.atEnd() ) {
+    // an addressee entry may spread over several lines in the file
+    while ( 1 ) {
+       itemList = line.split( '#', QString::KeepEmptyParts );
+       if ( itemList.count() >= 11 )
            break;
-       line.append('\n');
-       line.append(gmxStream.readLine());
+       line.append( '\n' );
+       line.append( gmxStream.readLine() );
     };
 
-    KABC::Addressee *addr = new KABC::Addressee;
-    addr->setNickName(strList[1]);
-    addr->setGivenName(strList[2]);
-    addr->setFamilyName(strList[3]);
-    addr->setTitle(strList[4]);
-    if (checkDateTime(strList[5],dt)) addr->setBirthday(dt);
-    addr->setNote(strList[6]);
-    if (checkDateTime(strList[7],dt)) addr->setRevision(dt);
-    // addr->setStatus(strList[8]); Status
-    // addr->xxx(strList[9]); Address_link_id
-    // addr->setCategory(strList[10]); Categories
-    addrMap[strList[0]] = addr;
+    // populate the addressee
+    KABC::Addressee *addressee = new KABC::Addressee;
+    addressee->setNickName( itemList[1] );
+    addressee->setGivenName( itemList[2] );
+    addressee->setFamilyName( itemList[3] );
+    addressee->setFormattedName( itemList[3] + ", " + itemList[2] );
+    addressee->setPrefix( itemList[4] );
+    if ( checkDateTime( itemList[5],dt ) ) addressee->setBirthday( dt );
+    addressee->setNote( itemList[6] );
+    if ( checkDateTime( itemList[7],dt ) ) addressee->setRevision( dt );
+    // addressee->setStatus( itemList[8] ); Status
+    // addressee->xxx( itemList[9] ); Address_link_id
+    categoriesOfAddressee[ itemList[0] ] = itemList[10];
+    addresseeMap[ itemList[0] ] = addressee;
 
     line = gmxStream.readLine();
   }
 
   // now read the address records
   line  = gmxStream.readLine();
-  if (!line.startsWith(QLatin1String("AB_ADDRESS_RECORDS:"))) {
-	kWarning() <<"Could not find address records!";
-	return addrList;
+  if ( !line.startsWith( QLatin1String( "AB_ADDRESS_RECORDS:" ) ) ) {
+    kWarning() << "Could not find address records!";
+    return addresseeList;
   }
-  // Address_id,Record_id,Street,Country,Zipcode,City,Phone,Fax,Mobile,Mobile_type,Email,
-  // Homepage,Position,Comments,Record_type_id,Record_type,Company,Department,Change_date,Preferred,Status
+  // Address_id,Record_id,Street,Country,Zipcode,City,Phone,Fax,Mobile,
+  // Mobile_type,Email,Homepage,Position,Comments,Record_type_id,Record_type,
+  // Company,Department,Change_date,Preferred,Status
   line = gmxStream.readLine();
   line = gmxStream.readLine();
 
-  while (!line.startsWith(QLatin1String("####")) && !gmxStream.atEnd()) {
-    while (1) {
-       strList = line.split('#', QString::KeepEmptyParts );
-       if (strList.count() >= 21)
+  while ( !line.startsWith( QLatin1String( "####" ) ) && !gmxStream.atEnd() ) {
+    // an address entry may spread over several lines in the file
+    while ( 1 ) {
+       itemList = line.split( '#', QString::KeepEmptyParts );
+       if ( itemList.count() >= 21 )
            break;
-       line.append('\n');
-       line.append(gmxStream.readLine());
+       line.append( '\n' );
+       line.append( gmxStream.readLine() );
     };
 
-    KABC::Addressee *addr = addrMap[strList[0]];
-    if (addr) {
-	for ( QStringList::Iterator it = strList.begin(); it != strList.end(); ++it )
-		*it = (*it).simplified();
-	// strList[1] = Record_id (numbered item, ignore here)
-	int id = strList[14].toInt(); // Record_type_id (0=work,1=home,2=other)
-  KABC::Address::Type type = (id==0) ? KABC::Address::Work : KABC::Address::Home;
-	if (!strList[19].isEmpty() && strList[19].toInt()!=0)
-		type |= KABC::Address::Pref; // Preferred address (seems to be bitfield for telephone Prefs)
-        KABC::Address adr = addr->address(type);
-	adr.setStreet(strList[2]);
-	adr.setCountry(strList[3]);
-	adr.setPostalCode(strList[4]);
-	adr.setLocality(strList[5]);
-	addr->insertPhoneNumber( KABC::PhoneNumber(strList[6], KABC::PhoneNumber::Home) );
-	addr->insertPhoneNumber( KABC::PhoneNumber(strList[7], KABC::PhoneNumber::Fax) );
-  KABC::PhoneNumber::Type celltype = KABC::PhoneNumber::Cell;
-	// strList[9]=Mobile_type // always 0 or -1(default phone).
-	if (strList[9].toInt()) celltype |= KABC::PhoneNumber::Pref;
-	addr->insertPhoneNumber( KABC::PhoneNumber(strList[8], celltype) );
-	addr->insertEmail(strList[10]);
-	if (!strList[11].isEmpty()) addr->setUrl(strList[11]);
-	if (!strList[12].isEmpty()) addr->setRole(strList[12]);
-	// strList[13]=Comments
-	// strList[14]=Record_type_id (0,1,2) - see above
-	// strList[15]=Record_type (name of this additional record entry)
-	if (!strList[16].isEmpty()) addr->setOrganization(strList[16]); // Company
-	if (!strList[17].isEmpty()) addr->insertCustom(
-			"KADDRESSBOOK", "X-Department", strList[17]); // Department
-        if (checkDateTime(strList[18],dt)) addr->setRevision(dt); // Change_date
-	// strList[19]=Preferred (see above)
-	// strList[20]=Status (should always be "1")
-	addr->insertAddress(adr);
+    KABC::Addressee *addressee = addresseeMap[ itemList[0] ];
+    if ( addressee ) {
+      // itemList[1] = Record_id (numbered item, ignore here)
+      int recordTypeId = itemList[14].toInt();
+      KABC::Address::Type addressType;
+      KABC::PhoneNumber::Type phoneType;
+      switch ( recordTypeId ) {
+        case typeHome:
+          addressType = KABC::Address::Home;
+          phoneType = KABC::PhoneNumber::Home;
+          break;
+        case typeWork:
+          addressType = KABC::Address::Work;
+          phoneType = KABC::PhoneNumber::Work;
+          break;
+        case typeOther:
+        default:
+          addressType = KABC::Address::Intl;
+          phoneType = KABC::PhoneNumber::Voice;
+          break;
+      }
+      KABC::Address address = addressee->address( addressType );
+      address.setStreet(     itemList[2] );
+      address.setCountry(    itemList[3] );
+      address.setPostalCode( itemList[4] );
+      address.setLocality(   itemList[5] );
+      if ( !itemList[6].isEmpty() ) {
+        addressee->insertPhoneNumber(
+          KABC::PhoneNumber( itemList[6], phoneType ) );
+      }
+      if ( !itemList[7].isEmpty() )
+        addressee->insertPhoneNumber(
+          KABC::PhoneNumber( itemList[7], KABC::PhoneNumber::Fax ) );
+      KABC::PhoneNumber::Type cellType = KABC::PhoneNumber::Cell;
+      // itemList[9]=Mobile_type // always 0 or -1(default phone).
+      // if ( itemList[19].toInt() & 4 ) cellType |= KABC::PhoneNumber::Pref;
+      // don't do the above to avoid duplicate mobile numbers
+      if ( !itemList[8].isEmpty() )
+        addressee->insertPhoneNumber(
+          KABC::PhoneNumber( itemList[8], cellType ) );
+      bool preferred = false;
+      if ( itemList[19].toInt() & 1 )
+        preferred = true;
+      addressee->insertEmail( itemList[10], preferred );
+      if ( !itemList[11].isEmpty() )
+        addressee->setUrl( itemList[11] );
+      if ( !itemList[12].isEmpty() )
+        addressee->setRole( itemList[12] );
+      // itemList[13]=Comments
+      // itemList[14]=Record_type_id (0,1,2) - see above
+      // itemList[15]=Record_type (name of this additional record entry)
+      if ( !itemList[16].isEmpty() )
+        addressee->setOrganization( itemList[16] ); // Company
+      if ( !itemList[17].isEmpty() ) addressee->insertCustom(
+        "KADDRESSBOOK", "X-Department", itemList[17] ); // Department
+      if ( checkDateTime( itemList[18],dt ) )
+        addressee->setRevision( dt ); // Change_date
+      // itemList[19]=Preferred (see above)
+      // itemList[20]=Status (should always be "1")
+      addressee->insertAddress( address );
     } else {
-	kWarning() <<"unresolved line:" << line;
+      kWarning() << "unresolved line:" << line;
     }
-
     line = gmxStream.readLine();
   }
 
-  // now add the addresses to to addrList
-  for ( AddressMap::Iterator it = addrMap.begin(); it != addrMap.end(); ++it ) {
-     KABC::Addressee *addr = it.value();
-     addrList.append(*addr);
-     delete addr;
+  // extract the categories from the list of addressees of the file to import
+  QStringList usedCategoryList;
+  line = gmxStream.readLine();
+  line2 = gmxStream.readLine();
+  if ( !line.startsWith( QLatin1String( "AB_CATEGORIES:" ) ) ||
+    !line2.startsWith( QLatin1String( "Category_id" ) ) ) {
+    kWarning() << "Could not find category records!";
+  } else {
+    while ( !line.startsWith( QLatin1String( "####" ) ) &&
+            !gmxStream.atEnd() ) {
+      // a category should not spread over multiple lines, but just in case
+      while ( 1 ) {
+        itemList = line.split( '#', QString::KeepEmptyParts );
+        if ( itemList.count() >= 3 )
+          break;
+        line.append( '\n' );
+        line.append( gmxStream.readLine() );
+      };
+      usedCategoryList.append( itemList[1] );
+      line = gmxStream.readLine();
+    };
   }
 
+  // now add the addresses to addresseeList
+  for ( AddresseeMap::Iterator addresseeIt = addresseeMap.begin();
+    addresseeIt != addresseeMap.end(); ++addresseeIt ) {
+    KABC::Addressee *addressee = addresseeIt.value();
+    // Add categories
+    // catgories is a bitfield with max 31 defined categories
+    int categories = categoriesOfAddressee[ addresseeIt.key() ].toInt();
+    for ( int i=32; i >= 0; --i ) {
+      // convert category index to bitfield value for comparison
+      int catBit =  1<<i;
+      if ( catBit > categories ) continue; // current index unassigned
+      if ( catBit & categories  && usedCategoryList.count() > i )
+        addressee->insertCategory( usedCategoryList[i] );
+    }
+    addresseeList.append( *addressee );
+    delete addressee;
+  }
+
   file.close();
-  return addrList;
+  return addresseeList;
 }
 
 
 /* export */
 
-bool GMXXXPort::exportContacts( const KABC::AddresseeList &list, const QString& )
+bool GMXXXPort::exportContacts( const KABC::AddresseeList &list, const QString &data )
 {
-  KUrl url = KFileDialog::getSaveUrl( KUrl( QDir::homePath() + "/addressbook.gmx" ),
-			GMX_FILESELECTION_STRING );
+  KUrl url = KFileDialog::getSaveUrl(
+    KUrl( QDir::homePath() + "/addressbook.gmx" ), GMX_FILESELECTION_STRING );
   if ( url.isEmpty() )
       return true;
 
-  if( QFileInfo( url.isLocalFile() ? url.toLocalFile() : url.path() ).exists() ) {
-      if(KMessageBox::questionYesNo( parentWidget(), i18n("Do you want to overwrite file \"%1\"", url.isLocalFile() ? url.toLocalFile() : url.path()) ) == KMessageBox::No)
-        return false;
+  if( QFileInfo( url.isLocalFile() ?
+    url.toLocalFile() : url.path() ).exists() ) {
+    if( KMessageBox::questionYesNo( parentWidget(),
+      i18n( "Do you want to overwrite file \"%1\"",
+      url.isLocalFile() ? url.toLocalFile() : url.path() ) )==KMessageBox::No )
+      return false;
   }
 
   if ( !url.isLocalFile() ) {
     KTemporaryFile tmpFile;
     if ( !tmpFile.open() ) {
-      QString txt = i18n("<qt>Unable to open file <b>%1</b></qt>", url.url());
+      QString txt = i18n( "<qt>Unable to open file <b>%1</b></qt>", url.url() );
       KMessageBox::error( parentWidget(), txt );
       return false;
     }
@@ -226,12 +352,12 @@
 
     return KIO::NetAccess::upload( tmpFile.fileName(), url, parentWidget() );
   } else {
-    QString filename = url.toLocalFile();
-    QFile file( filename );
+    QString fileName = url.toLocalFile();
+    QFile file( fileName );
 
     if ( !file.open( QIODevice::WriteOnly ) ) {
       QString txt = i18n( "<qt>Unable to open file <b>%1</b>.</qt>",
-                          filename );
+                          fileName );
       KMessageBox::error( parentWidget(), txt );
       return false;
     }
@@ -245,46 +371,89 @@
 
 static const QString dateString( const QDateTime &dt )
 {
-  if (!dt.isValid())
-	return QString::fromLatin1("1000-01-01 00:00:00");
-  QString d(dt.toString(Qt::ISODate));
+  if ( !dt.isValid() )
+    return QString::fromLatin1( "1000-01-01 00:00:00" );
+  QString d( dt.toString( Qt::ISODate ) );
   d[10] = ' '; // remove the "T" in the middle of the string
   return d;
 }
 
+static const QStringList assignedCategoriesSorted(
+  const KABC::AddresseeList &list )
+{
+  // Walk through the addressees and return a unique list of up to 31
+  // categories, alphabetically sorted
+  QStringList categoryList;
+  const KABC::Addressee *addressee;
+  for ( KABC::AddresseeList::ConstIterator addresseeIt = list.begin();
+    addresseeIt != list.end() && categoryList.count() < 32; ++addresseeIt ) {
+    addressee = &( *addresseeIt );
+    if ( addressee->isEmpty() ) continue;
+    const QStringList categories = addressee->categories();
+    for ( int i=0; i < categories.count() && categoryList.count() < 32; ++i ) {
+      if ( !categoryList.contains( categories[i]) )
+        categoryList.append( categories[i] );
+    }
+  }
+  categoryList.sort();
+  return categoryList;
+}
+
 void GMXXXPort::doExport( QFile *fp, const KABC::AddresseeList &list )
 {
-  if (!fp || !list.count())
+  if ( !fp || !list.count() )
     return;
 
   QTextStream t( fp );
   t.setCodec( "ISO 8859-1" );
 
-  KABC::AddresseeList::ConstIterator it;
-  typedef QMap<int, const KABC::Addressee *> AddressMap;
-  AddressMap addrMap;
-  const KABC::Addressee *addr;
+  typedef QMap<int, const KABC::Addressee *> AddresseeMap;
+  AddresseeMap addresseeMap;
+  const KABC::Addressee *addressee;
 
   t << "AB_ADDRESSES:\n";
   t << "Address_id,Nickname,Firstname,Lastname,Title,Birthday,Comments,"
        "Change_date,Status,Address_link_id,Categories\n";
 
-  int no = 0;
-  const QChar DELIM('#');
-  for ( it = list.begin(); it != list.end(); ++it ) {
-     addr = &(*it);
-     if (addr->isEmpty())
-        continue;
-     addrMap[++no] = addr;
-     t << no << DELIM			// Address_id
-	<< addr->nickName() << DELIM	// Nickname
-	<< addr->givenName() << DELIM	// Firstname
-	<< addr->familyName() << DELIM	// Lastname
-	<< addr->title() << DELIM	// Title
-	<< dateString(addr->birthday()) << DELIM   // Birthday
-	<< addr->note() /*.replace('\n',"\r\n")*/ << DELIM // Comments
-	<< dateString(addr->revision()) << DELIM   // Change_date
-	<< "1##0\n";			// Status, Address_link_id, Categories
+  QList<QString> categoryMap;
+  categoryMap.append( assignedCategoriesSorted( list ) );
+
+  int addresseeId = 0;
+  const QChar DELIM( '#' );
+  for ( KABC::AddresseeList::ConstIterator it = list.begin();
+    it != list.end(); ++it ) {
+    addressee = &(*it);
+    if ( addressee->isEmpty() )
+       continue;
+    addresseeMap[ ++addresseeId ] = addressee;
+
+    // Assign categories as bitfield
+    const QStringList categories = addressee->categories();
+    long int category = 0;
+    if ( categories.count() > 0 ) {
+      for ( int i=0; i < categories.count(); i++ ) {
+        if ( categoryMap.contains( categories[i] ) )
+          category |= 1 << categoryMap.indexOf( categories[i], 0 ) ;
+      }
+    }
+
+    // GMX sorts by nickname by default - don't leave empty
+    QString nickName = addressee->nickName();
+    if ( nickName.isEmpty() )
+      nickName = addressee->formattedName();
+
+    t << addresseeId << DELIM             // Address_id
+      << nickName << DELIM                // Nickname
+      << addressee->givenName() << DELIM  // Firstname
+      << addressee->familyName() << DELIM // Lastname
+      << addressee->prefix() << DELIM     // Title - Note: ->title()
+                                          // refers to the professional title
+      << dateString( addressee->birthday() ) << DELIM   // Birthday
+      << addressee->note() /*.replace('\n',"\r\n")*/ << DELIM // Comments
+      << dateString( addressee->revision() ) << DELIM   // Change_date
+      << "1" << DELIM                     // Status
+      << DELIM                            // Address_link_id
+      << category << endl;                // Categories
   }
 
   t << "####\n";
@@ -293,57 +462,139 @@
        "Mobile_type,Email,Homepage,Position,Comments,Record_type_id,Record_type,"
        "Company,Department,Change_date,Preferred,Status\n";
 
-  no = 1;
-  while ( (addr = addrMap[no]) != NULL ) {
-    for (int record_id=0; record_id<3; ++record_id) {
+  addresseeId = 1;
+  while ( ( addressee = addresseeMap[ addresseeId ] ) != NULL ) {
 
-	KABC::Address address;
-  	KABC::PhoneNumber phone, fax, cell;
+    const KABC::PhoneNumber::List cellPhones =
+      addressee->phoneNumbers( KABC::PhoneNumber::Cell );
 
-	/* record ID == 1: Work address */
-        if (record_id == 1) {
-		address = addr->address(KABC::Address::Work);
-		phone = addr->phoneNumber(KABC::PhoneNumber::Work);
-		fax   = addr->phoneNumber(KABC::PhoneNumber::Fax);
-		cell  = addr->phoneNumber(KABC::PhoneNumber::Work | KABC::PhoneNumber::Cell);
-	} else {
-		address = addr->address(KABC::Address::Home);
-		phone = addr->phoneNumber(KABC::PhoneNumber::Home);
-		cell  = addr->phoneNumber(KABC::PhoneNumber::Cell);
-	}
+    const QStringList emails = addressee->emails();
 
-	const QStringList emails = addr->emails();
-	QString email;
-	if (emails.count()>record_id) email = emails[record_id];
+    for ( int recId=0; recId<3; ++recId ) {
+      KABC::Address address;
+      KABC::PhoneNumber phone, fax, cell;
 
-	t << no << DELIM			// Address_id
-	  << record_id << DELIM			// Record_id
-	  << address.street() << DELIM		// Street
-	  << address.country() << DELIM 	// Country
-	  << address.postalCode() << DELIM	// Zipcode
-	  << address.locality() << DELIM	// City
-	  << phone.number() << DELIM		// Phone
-	  << fax.number() << DELIM		// Fax
-	  << cell.number() << DELIM		// Mobile
-	  << ((cell.type()&KABC::PhoneNumber::Pref)?-1:0) << DELIM // Mobile_type
-	  << email << DELIM			// Email
-	  << ((record_id==1)?addr->url().url():QString()) << DELIM // Homepage
-	  << ((record_id==1)?addr->role():QString()) << DELIM	// Position
-	  << DELIM				// Comments
-	  << record_id << DELIM			// Record_type_id (0,1,2) - see above
-	  << DELIM				// Record_type (name of this additional record entry)
-	  << ((record_id==1)?addr->organization():QString()) << DELIM // Company
-	  << ((record_id==1)?addr->custom("KADDRESSBOOK", "X-Department"):QString()) << DELIM // Department
-	  << dateString(addr->revision()) << DELIM	// Change_date
-	  << 5 << DELIM				// Preferred
-	  << 1 << endl;				// Status (should always be "1")
+      // address preference flag:
+      // & 1: preferred email address
+      // & 4: preferred cell phone
+      int prefFlag=0;
+
+      switch ( recId ) {
+      // Assign address, phone and cellphone, fax if applicable
+        case typeHome:
+          address = addressee->address( KABC::Address::Home );
+          phone   = addressee->phoneNumber( KABC::PhoneNumber::Home );
+          if ( cellPhones.count() > 0 ) {
+            cell  = cellPhones.at( 0 );
+            if ( !cell.isEmpty() )
+              prefFlag |= 4;
+          }
+          break;
+        case typeWork:
+          address = addressee->address( KABC::Address::Work );
+          phone   = addressee->phoneNumber( KABC::PhoneNumber::Work );
+          if ( cellPhones.count() >= 2 )
+            cell  = cellPhones.at( 1 );
+          fax     = addressee->phoneNumber( KABC::PhoneNumber::Fax );
+          break;
+        case typeOther:
+        default:
+          if ( addressee->addresses( KABC::Address::Home ).count() > 1 )
+            address = addressee->addresses( KABC::Address::Home ).at( 1 );
+          if ( ( address.isEmpty() ) &&
+               ( addressee->addresses( KABC::Address::Work ).count() > 1 ) )
+            address = addressee->addresses( KABC::Address::Work ).at( 1 );
+          if ( address.isEmpty() )
+            address = addressee->address( KABC::Address::Dom );
+          if ( address.isEmpty() )
+            address = addressee->address( KABC::Address::Intl );
+          if ( address.isEmpty() )
+            address = addressee->address( KABC::Address::Postal );
+          if ( address.isEmpty() )
+            address = addressee->address( KABC::Address::Parcel );
+
+          if ( addressee->phoneNumbers( KABC::PhoneNumber::Home ).count() > 1 )
+            phone = addressee->phoneNumbers( KABC::PhoneNumber::Home ).at( 1 );
+          if ( ( phone.isEmpty() ) && ( addressee->phoneNumbers(
+            KABC::PhoneNumber::Work ).count() > 1 ) )
+            phone = addressee->phoneNumbers( KABC::PhoneNumber::Work ).at( 1 );
+          if ( phone.isEmpty() )
+            phone = addressee->phoneNumber( KABC::PhoneNumber::Voice );
+          if ( phone.isEmpty() )
+            phone = addressee->phoneNumber( KABC::PhoneNumber::Msg );
+          if ( phone.isEmpty() )
+            phone = addressee->phoneNumber( KABC::PhoneNumber::Isdn );
+          if ( phone.isEmpty() )
+            phone = addressee->phoneNumber( KABC::PhoneNumber::Car );
+          if ( phone.isEmpty() )
+            phone = addressee->phoneNumber( KABC::PhoneNumber::Pager );
+
+          switch ( cellPhones.count() ) {
+            case 0: break;
+            case 1:
+            case 2:
+              if ( !address.isEmpty() )
+                cell = cellPhones.at( 0 );
+              break;
+            default:
+              cell = cellPhones.at( 2 );
+              break;
+          }
+          break;
+      }
+
+      QString email="";
+      if ( emails.count()>recId ) {
+        email = emails[ recId ];
+        if ( email == addressee->preferredEmail() ) prefFlag |= 1;
+      }
+
+      if ( !address.isEmpty() || !phone.isEmpty() ||
+           !cell.isEmpty()    || !email.isEmpty() ) {
+        t << addresseeId << DELIM             // Address_id
+          << recId << DELIM                   // Record_id
+          << address.street() << DELIM        // Street
+          << address.country() << DELIM       // Country
+          << address.postalCode() << DELIM    // Zipcode
+          << address.locality() << DELIM      // City
+          << phone.number() << DELIM          // Phone
+          << fax.number() << DELIM            // Fax
+          << cell.number() << DELIM           // Mobile
+          << ((recId==typeWork)?0:1) << DELIM // Mobile_type
+          << email << DELIM                   // Email
+          << ((recId==typeWork)?addressee->url().url():QString()) << DELIM
+                                              // Homepage
+          << ((recId==typeWork)?addressee->role():QString()) << DELIM
+                                              // Position
+          << ((recId==typeHome)?addressee->custom(
+             "KADDRESSBOOK", "X-SpousesName" ):QString() ) << DELIM // Comments
+          << recId << DELIM                   // Record_type_id (0,1,2)
+          << DELIM                            // Record_type
+          << ((recId==typeWork)?addressee->organization():QString()) << DELIM
+                                              // Company
+          << ((recId==typeWork)?addressee->custom(
+             "KADDRESSBOOK", "X-Department" ):QString() )<< DELIM // Department
+          << dateString( addressee->revision() ) << DELIM // Change_date
+          << prefFlag << DELIM                // Preferred:
+                                              // ( & 1: preferred email,
+                                              //   & 4: preferred cell phone )
+          << 1 << endl;                       // Status (should always be "1")
+      }
     }
 
-    ++no;
+    ++addresseeId;
   };
 
-  t << "####";
+  t << "####" << endl;
+  t << "AB_CATEGORIES:" << endl;
+  t << "Category_id,Name,Icon_id" << endl;
+
+  //  Write Category List (beware: Category_ID 0 is reserved for none
+  //  Interestingly: The index here is an int sequence and does not
+  //  correspond to the bit reference used above.
+  for ( int i = 0; i < categoryMap.size(); i++ ) {
+    t << ( i + 1 ) << DELIM << categoryMap.at( i ) << DELIM << 0 << endl;
+  }
+  t << "####" << endl;
 }
 
-#include "gmx_xxport.moc"
-
Index: kjots/kjots_config_misc.desktop
===================================================================
--- kjots/kjots_config_misc.desktop	(.../tags/KDE/4.3.1/kdepim)	(wersja 1023019)
+++ kjots/kjots_config_misc.desktop	(.../branches/KDE/4.3/kdepim)	(wersja 1023019)
@@ -81,7 +81,7 @@
 Comment[es]=Configuraciones varias de KJots
 Comment[et]=KJotsi muud seadistused
 Comment[fr]=Configuration (divers) de KJots
-Comment[gl]=Configurar opcións varias do KJots
+Comment[gl]=Configuración de opcións varias do KJots
 Comment[it]=Impostazioni varie per KJots
 Comment[km]=ការ​ដំឡើង​ផ្សេងៗ​សម្រាប់ KJots
 Comment[lv]=Dažādi KJots iestatījumi
Index: libkdepim/addresseelineedit.cpp
===================================================================
--- libkdepim/addresseelineedit.cpp	(.../tags/KDE/4.3.1/kdepim)	(wersja 1023019)
+++ libkdepim/addresseelineedit.cpp	(.../branches/KDE/4.3/kdepim)	(wersja 1023019)
@@ -800,7 +800,7 @@
 
 void AddresseeLineEdit::slotLDAPSearchData( const KPIM::LdapResultList &adrs )
 {
-  if ( s_LDAPLineEdit != this ) {
+  if ( adrs.isEmpty() || s_LDAPLineEdit != this ) {
     return;
   }
 
@@ -817,7 +817,8 @@
     setText( m_previousAddresses + m_searchString );
     // only complete again if the user didn't change the selection while
     // we were waiting; otherwise the completion box will be closed
-    if ( m_searchString.trimmed() != completionBox()->currentItem()->text().trimmed() ) {
+    QListWidgetItem *current = completionBox()->currentItem();
+    if ( !current || m_searchString.trimmed() != current->text().trimmed() ) {
       doCompletion( m_lastSearchMode );
     }
   }
Index: libkdepim/foldertreewidget.cpp
===================================================================
--- libkdepim/foldertreewidget.cpp	(.../tags/KDE/4.3.1/kdepim)	(wersja 1023019)
+++ libkdepim/foldertreewidget.cpp	(.../branches/KDE/4.3/kdepim)	(wersja 1023019)
@@ -34,6 +34,7 @@
 #include <QStyle>
 #include <QPainter>
 #include <QFontMetrics>
+#include <QApplication>
 
 #define FOLDERTREEWIDGETITEM_TYPE ( QTreeWidgetItem::UserType + 0xcafe )
 
@@ -88,8 +89,6 @@
     if ( !item )
       return; // ugh :/
 
-    // FIXME: opt->direction == Qt::RightToLeft ?
-
     // draw the labelText().
     QRect textRect = style->subElementRect( QStyle::SE_ItemViewItemText, &opt, mFolderTreeWidget );
     textRect.setWidth( textRect.width() - ITEM_LABEL_RIGHT_MARGIN );
@@ -164,7 +163,10 @@
 
         painter->drawText( textRect, Qt::AlignLeft | Qt::TextSingleLine | Qt::AlignVCenter, label );
 
-        textRect.setLeft( textRect.left() + labelWidth + ITEM_LABEL_TO_UNREADCOUNT_SPACING );
+        if ( QApplication::isLeftToRight() )
+          textRect.setLeft( textRect.left() + labelWidth + ITEM_LABEL_TO_UNREADCOUNT_SPACING );
+        else
+          textRect.setRight( textRect.right() - labelWidth - ITEM_LABEL_TO_UNREADCOUNT_SPACING );
 
         if ( !( opt.state & QStyle::State_Selected ) ) {
           painter->setPen( QPen( mFolderTreeWidget->unreadCountColor(), 0 ) );
Index: kpilot/conduits/timeconduit/time_conduit.desktop
===================================================================
--- kpilot/conduits/timeconduit/time_conduit.desktop	(.../tags/KDE/4.3.1/kdepim)	(wersja 1023019)
+++ kpilot/conduits/timeconduit/time_conduit.desktop	(.../branches/KDE/4.3/kdepim)	(wersja 1023019)
@@ -18,7 +18,7 @@
 Comment[fr]=Ce canal règle l'heure de votre ordinateur de poche sur celle du PC.
 Comment[fy]=Comment=Dit conduit set de tiid fan jo handheld oan d ehÃ¢n fan de pc-klok.
 Comment[ga]=Sioncrónaíonn an seoladán seo an t-am ar do ríomhaire boise leis an gclog ar do ríomhaire deisce.
-Comment[gl]=Este conduto muda a hora do aparello portátil dende o reloxo do PC.
+Comment[gl]=Este conduto muda a hora do aparello portátil desde o reloxo do PC.
 Comment[hu]=Ez a csatoló beállítja a kéziszámítógép óráját a számítógépé alapján
 Comment[is]=Þessi rás stillir klukku lófatölvunnar eftir klukku PC tölvunnar.
 Comment[it]=Questo condotto imposta l'ora sul tuo palmare prendendola dall'orologio del PC.
Index: kpilot/conduits/popmail/popmail-conduit.desktop
===================================================================
--- kpilot/conduits/popmail/popmail-conduit.desktop	(.../tags/KDE/4.3.1/kdepim)	(wersja 1023019)
+++ kpilot/conduits/popmail/popmail-conduit.desktop	(.../branches/KDE/4.3/kdepim)	(wersja 1023019)
@@ -37,7 +37,7 @@
 Comment[pa]=ਆਪਣੇ ਹੈਂਡਹਿਲਡ ਤੋਂ ਕੇਮੇਲ ਰਾਹੀਂ ਮੇਲ ਭੇਜੋ।
 Comment[pl]=Wysyła pocztę z palmtopa za pomocą KMail.
 Comment[pt]=Enviar um e-mail a partir do seu dispositivo móvel através do KMail.
-Comment[pt_BR]=Envia mensagem do seu handheld através do Kmail.
+Comment[pt_BR]=Envia mensagem do seu handheld através do KMail.
 Comment[ru]=Отправка почты с КПК через KMail.
 Comment[sk]=Pošle poštu z prenosného zariadenia cez KMail.
 Comment[sl]=Pošljite pošto z vašega ročnega računalnika preko KMaila.
Index: kpilot/conduits/todo/kpilot-conduit-todo.desktop
===================================================================
--- kpilot/conduits/todo/kpilot-conduit-todo.desktop	(.../tags/KDE/4.3.1/kdepim)	(wersja 1023019)
+++ kpilot/conduits/todo/kpilot-conduit-todo.desktop	(.../branches/KDE/4.3/kdepim)	(wersja 1023019)
@@ -9,7 +9,7 @@
 Comment[es]=Este conducto sincroniza la base de tareas pendientes de la agenda electrónica con una colección de tareas pendientes de Akonadi.
 Comment[et]=See kanal sünkroniseerib pihuarvuti ülesannete andmebaasi ja Akonadi ülesannete kogu.
 Comment[fr]=Ce canal synchronise la liste de tâches du périphérique avec une collection de liste de tâches Akonadi.
-Comment[gl]=Este conduto sincroniza o base de datos do chaveiro do aparello portátil coa colección da Tarefas do Akonadi.
+Comment[gl]=Este conduto sincroniza o base de datos do chaveiro do aparello portátil coa colección de Tarefas do Akonadi.
 Comment[hu]=Ezzel a csatolóval egy kéziszámítógép feladatai és egy Akonadi-feladatgyűjtemény között lehet szinkronizálást végezni.
 Comment[it]=Questo condotto sincronizza l'elenco delle cose da fare del palmare con una collezione di cose da fare di Akonadi.
 Comment[ja]=このコンジットはハンドヘルドの To-Do データベースを Akonadi の To-Do コレクションと同期させます。
Index: kpilot/conduits/contacts/kpilot-conduit-contacts.desktop
===================================================================
--- kpilot/conduits/contacts/kpilot-conduit-contacts.desktop	(.../tags/KDE/4.3.1/kdepim)	(wersja 1023019)
+++ kpilot/conduits/contacts/kpilot-conduit-contacts.desktop	(.../branches/KDE/4.3/kdepim)	(wersja 1023019)
@@ -10,7 +10,7 @@
 Comment[et]=See kanal sünkroniseerib pihuarvuti aadressiraamatu andmebaasi Akonadi koguga.
 Comment[fr]=Ce canal synchronise le carnet d'adresse du périphérique avec une collection Akonadi.
 Comment[ga]=Sioncrónaíonn an seoladán seo bunachar sonraí an leabhair seoltaí ar do ríomhaire boise le Bailiúchán Akonadi.
-Comment[gl]=Este conduto sincroniza o caderno de enderezos do aparello móbil coa colección de calendarios do Akonadi
+Comment[gl]=Este conduto sincroniza o caderno de enderezos do aparello portátil coa colección de calendarios do Akonadi
 Comment[it]=Questo condotto sincronizza la rubrica del palmare con una collezione di Akonadi.
 Comment[ja]=このコンジットはハンドヘルドのアドレス帳データベースを Akonadi のコレクションと同期させます。
 Comment[km]=conduit syncs នេះ​ជា​មូលដ្ឋាន​​សៀវភៅ​អាសយដ្ឋាន​ឧបករណ៍​​​យួរដៃ​ដែល​មាន​បណ្ដុំ Akonadi ។
Index: kontact/plugins/planner/planner.cpp
===================================================================
--- kontact/plugins/planner/planner.cpp	(.../tags/KDE/4.3.1/kdepim)	(wersja 1023019)
+++ kontact/plugins/planner/planner.cpp	(.../branches/KDE/4.3/kdepim)	(wersja 1023019)
@@ -361,7 +361,7 @@
       urlLabel2->setUrl( todo->uid() );
       urlLabel2->installEventFilter( this );
       urlLabel2->setAlignment( Qt::AlignLeft | Qt::AlignTop );
-      urlLabel->setWordWrap( true );
+      urlLabel2->setWordWrap( true );
       if ( stateText == i18nc( "to-do is overdue", "overdue" ) ) {
         urlLabel2->setText( "<font color = red >" + string + "</font>" );
       }
Index: kontact/plugins/knode/knodeplugin.desktop
===================================================================
--- kontact/plugins/knode/knodeplugin.desktop	(.../tags/KDE/4.3.1/kdepim)	(wersja 1023019)
+++ kontact/plugins/knode/knodeplugin.desktop	(.../branches/KDE/4.3/kdepim)	(wersja 1023019)
@@ -56,7 +56,7 @@
 Comment[pa]=ਕੇਸੰਪਰਕ ਕੇਨੋਡ ਪਲੱਗਇਨ
 Comment[pl]=Wtyczka Kontact do współpracy z KNode
 Comment[pt]='Plugin' do KNode para o Kontact
-Comment[pt_BR]=Plug-in do Knode para o Kontact
+Comment[pt_BR]=Plug-in do KNode para o Kontact
 Comment[ro]=Modul KNode pentru Kontact
 Comment[ru]=Новости
 Comment[se]=Kontact, KNode-lassemoduvla
Index: kontact/plugins/kjots/kjots_plugin.desktop
===================================================================
--- kontact/plugins/kjots/kjots_plugin.desktop	(.../tags/KDE/4.3.1/kdepim)	(wersja 1023019)
+++ kontact/plugins/kjots/kjots_plugin.desktop	(.../branches/KDE/4.3/kdepim)	(wersja 1023019)
@@ -42,7 +42,7 @@
 Comment[pa]=ਕੇ-ਸੰਪਰਕ ਕੇਜੂਟ ਪਲੱਗਇਨ
 Comment[pl]=Wtyczka Kontact do współpracy z Notatkami
 Comment[pt]='Plugin' do KJots para o Kontact
-Comment[pt_BR]=Plug-in do Kjots para o Kontact
+Comment[pt_BR]=Plug-in do KJots para o Kontact
 Comment[ru]=Блокнот
 Comment[sl]=Vstavek KJots za Kontact
 Comment[sv]=Kontact insticksdelprogram för Kjots
Index: kontactinterfaces/kontactplugin.desktop
===================================================================
--- kontactinterfaces/kontactplugin.desktop	(.../tags/KDE/4.3.1/kdepim)	(wersja 1023019)
+++ kontactinterfaces/kontactplugin.desktop	(.../branches/KDE/4.3/kdepim)	(wersja 1023019)
@@ -20,7 +20,7 @@
 Name[fi]=Kontact-liitännäinen
 Name[fr]=Module Kontact
 Name[ga]=Breiseán Kontact
-Name[gl]=Engadido do Kontact
+Name[gl]=Engadido para Kontact
 Name[he]=תוסף Kontact
 Name[hu]=Kontact-bővítőmodul
 Name[is]=Kontact íforrit
Index: korganizer/datenavigator.cpp
===================================================================
--- korganizer/datenavigator.cpp	(.../tags/KDE/4.3.1/kdepim)	(wersja 1023019)
+++ korganizer/datenavigator.cpp	(.../branches/KDE/4.3/kdepim)	(wersja 1023019)
@@ -158,6 +158,8 @@
 
   if ( dateCount == 7 ) {
     selectWeek( d );
+  } else if ( dateCount == 5 ) {
+    selectWorkWeek( d );
   } else {
     selectDates( d, dateCount );
   }
Index: korganizer/koeditorgeneraltodo.cpp
===================================================================
--- korganizer/koeditorgeneraltodo.cpp	(.../tags/KDE/4.3.1/kdepim)	(wersja 1023019)
+++ korganizer/koeditorgeneraltodo.cpp	(.../branches/KDE/4.3/kdepim)	(wersja 1023019)
@@ -287,11 +287,12 @@
 
   KOEditorGeneral::readIncidence( todo );
 
-  QDateTime dueDT;
-
   if ( todo->hasDueDate() ) {
     enableAlarm( true );
-    dueDT = todo->dtDue().dateTime();
+    KDateTime dueDT = todo->dtDue();
+    if ( dueDT.isUtc() ) {
+      dueDT = dueDT.toLocalZone();
+    }
     mDueDateEdit->setDate( dueDT.date() );
     mDueTimeEdit->setTime( dueDT.time() );
     mDueCheck->setChecked( true );
@@ -308,9 +309,12 @@
   }
 
   if ( todo->hasStartDate() ) {
-    QDateTime start = todo->dtStart().dateTime();
-    mStartDateEdit->setDate( start.date() );
-    mStartTimeEdit->setTime( start.time() );
+    KDateTime startDT = todo->dtStart();
+    if ( startDT.isUtc() ) {
+      startDT = startDT.toLocalZone();
+    }
+    mStartDateEdit->setDate( startDT.date() );
+    mStartTimeEdit->setTime( startDT.time() );
     mStartCheck->setChecked( true );
     mStartSpec = todo->dtStart().timeSpec();
     mTimeZoneComboStart->selectTimeSpec( todo->dtStart().timeSpec() );
@@ -446,11 +450,11 @@
   if( mDueCheck->isChecked() || mStartCheck->isChecked() ) {
     mTimeButton->setEnabled( true );
   } else {
-    mTimeButton->setEnabled(false);
-    mTimeButton->setChecked(false);
+    mTimeButton->setEnabled( false );
+    mTimeButton->setChecked( false );
   }
 
-  if (enable) {
+  if ( enable ) {
     mStartTimeEdit->setEnabled( mTimeButton->isChecked() );
     mTimeZoneComboStart->setEnabled( mTimeButton->isChecked() );
   } else {
Index: korganizer/koeditorgeneralevent.cpp
===================================================================
--- korganizer/koeditorgeneralevent.cpp	(.../tags/KDE/4.3.1/kdepim)	(wersja 1023019)
+++ korganizer/koeditorgeneralevent.cpp	(.../branches/KDE/4.3/kdepim)	(wersja 1023019)
@@ -430,8 +430,16 @@
   setTimeEditorsEnabled( !event->allDay() );
 
   if ( !isTemplate ) {
-    // the rest is for the events only
-    setDateTimes( event->dtStart(), event->dtEnd() );
+    // Convert UTC to local timezone, if needed (i.e. for kolab #204059)
+    KDateTime startDT = event->dtStart();
+    KDateTime endDT = event->dtEnd();
+    if ( startDT.isUtc() ) {
+      startDT = startDT.toLocalZone();
+    }
+    if ( endDT.isUtc() ) {
+      endDT = endDT.toLocalZone();
+    }
+    setDateTimes( startDT, endDT );
   } else {
     // set the start/end time from the template, only as a last resort #190545
     if ( !event->dtStart().isValid() || !event->dtEnd().isValid() ) {
Index: korganizer/koeditorgeneraljournal.cpp
===================================================================
--- korganizer/koeditorgeneraljournal.cpp	(.../tags/KDE/4.3.1/kdepim)	(wersja 1023019)
+++ korganizer/koeditorgeneraljournal.cpp	(.../branches/KDE/4.3/kdepim)	(wersja 1023019)
@@ -148,9 +148,13 @@
 {
   setSummary( journal->summary() );
   if ( !tmpl ) {
-    setDate( journal->dtStart().date() );
+    KDateTime startDT = journal->dtStart();
+    if ( startDT.isUtc() ) {
+      startDT = startDT.toLocalZone();
+    }
+    setDate( startDT.date() );
     if ( !journal->allDay() ) {
-      setTime( journal->dtStart().time() );
+      setTime( startDT.time() );
     } else {
       setTime( QTime( -1, -1, -1 ) );
     }
Index: korganizer/plugins/printing/whatsnext/whatsnextprint.desktop
===================================================================
--- korganizer/plugins/printing/whatsnext/whatsnextprint.desktop	(.../tags/KDE/4.3.1/kdepim)	(wersja 1023019)
+++ korganizer/plugins/printing/whatsnext/whatsnextprint.desktop	(.../branches/KDE/4.3/kdepim)	(wersja 1023019)
@@ -17,7 +17,7 @@
 Name[fr]=Impression des évènements à venir
 Name[fy]=Printstyl foar Wat komt der no
 Name[ga]=Priontáil Rudaí Le Teacht
-Name[gl]=Estilo de Impresión do Quen Ven Agora
+Name[gl]=Estilo de Impresión do Que Ven Agora
 Name[hu]=A közeljövő eseményeinek kinyomtatása
 Name[is]=Hvað er næst prentstíll
 Name[it]=Stile di stampa "cosa viene dopo"
Index: korganizer/views/todoview/kotodomodel.cpp
===================================================================
--- korganizer/views/todoview/kotodomodel.cpp	(.../tags/KDE/4.3.1/kdepim)	(wersja 1023019)
+++ korganizer/views/todoview/kotodomodel.cpp	(.../branches/KDE/4.3/kdepim)	(wersja 1023019)
@@ -630,11 +630,11 @@
   }
 
   TodoTreeNode *node = static_cast<TodoTreeNode *>( child.internalPointer() );
-  // every model index given out by us has a valid internal pointer, so
-  // that's save:
-  TodoTreeNode *parent = node->mParent;
-
-  return getModelIndex( parent );
+  if ( node->isValid() ) {
+    return getModelIndex( node->mParent );
+  } else {
+    return QModelIndex();
+  }
 }
 
 int KOTodoModel::columnCount( const QModelIndex &/*parent*/ ) const
Index: korganizer/freebusymanager.cpp
===================================================================
--- korganizer/freebusymanager.cpp	(.../tags/KDE/4.3.1/kdepim)	(wersja 1023019)
+++ korganizer/freebusymanager.cpp	(.../branches/KDE/4.3/kdepim)	(wersja 1023019)
@@ -38,6 +38,8 @@
 #include "freebusymanager.h"
 #include "koprefs.h"
 #include "mailscheduler.h"
+#include "actionmanager.h"
+#include "korganizer.h"
 
 #include <kabc/stdaddressbook.h>
 #include <kabc/addressee.h>
@@ -50,6 +52,7 @@
 #include <kcal/icalformat.h>
 
 #include <kio/job.h>
+#include <kio/jobuidelegate.h>
 #include <kio/netaccess.h>
 #include <kdebug.h>
 #include <kmessagebox.h>
@@ -74,6 +77,11 @@
   : QObject( manager ), mManager( manager ), mEmail( email )
 {
   KIO::Job *job = KIO::get( url, KIO::NoReload, KIO::HideProgressInfo );
+
+  //pass the mainwindow to the job so any prompts are active
+  KOrg::MainWindow *korg = ActionManager::findInstance( KUrl() );
+  job->ui()->setWindow( korg->topLevelWidget() );
+
   connect( job, SIGNAL(result(KJob *)), SLOT(slotResult(KJob *)) );
   connect( job, SIGNAL(data(KIO::Job *,const QByteArray &)),
            SLOT(slotData(KIO::Job *,const QByteArray &)) );
@@ -317,6 +325,11 @@
     kDebug() << targetURL;
 
     KIO::Job *job = KIO::file_copy( src, targetURL, -1, KIO::Overwrite | KIO::HideProgressInfo );
+
+    //pass the mainwindow to the job so any prompts are active
+    KOrg::MainWindow *korg = ActionManager::findInstance( KUrl() );
+    job->ui()->setWindow( korg->topLevelWidget() );
+
     connect( job, SIGNAL(result(KJob *)), SLOT(slotUploadFreeBusyResult(KJob *)) );
   }
 }

Zmiany atrybutów dla: .
___________________________________________________________________
Dodane: svn:externals
   + 


