Index: akregator/plugins/mk4storage/feedstoragemk4impl.cpp
===================================================================
--- akregator/plugins/mk4storage/feedstoragemk4impl.cpp	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ akregator/plugins/mk4storage/feedstoragemk4impl.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -95,10 +95,6 @@
         StorageMK4Impl* mainStorage;
         c4_View archiveView;
 
-        c4_Storage* catStorage;
-        c4_View catView;
-        c4_Storage* tagStorage;
-        c4_View tagView;
         bool autoCommit;
 	    bool modified;
         bool convert;
@@ -159,23 +155,12 @@
 
     c4_View hash = d->storage->GetAs("archiveHash[_H:I,_R:I]");
     d->archiveView = d->archiveView.Hash(hash, 1); // hash on guid
-
-
-    d->tagStorage = new c4_Storage((filePath + ".mk4___TAGS").toLocal8Bit(), true);
-    d->tagView = d->tagStorage->GetAs("tagIndex[tag:S,taggedArticles[guid:S]]");
-    hash = d->tagStorage->GetAs("archiveHash[_H:I,_R:I]");
-    d->tagView = d->tagView.Hash(hash, 1); // hash on tag
-
-    d->catStorage = new c4_Storage((filePath + ".mk4___CATEGORIES").toLocal8Bit(), true);
-    d->catView = d->catStorage->GetAs("catIndex[catTerm:S,catScheme:S,catName:S,categorizedArticles[guid:S]]");
 }
 
 
 FeedStorageMK4Impl::~FeedStorageMK4Impl()
 {
     delete d->storage;
-    delete d->tagStorage;
-    delete d->catStorage;
     delete d; d = 0;
 }
 
@@ -194,8 +179,6 @@
     if (d->modified)
     {
         d->storage->Commit();
-        d->tagStorage->Commit();
-        d->catStorage->Commit();
     }
     d->modified = false;
 }
@@ -203,8 +186,6 @@
 void FeedStorageMK4Impl::rollback()
 {
     d->storage->Rollback();
-    d->tagStorage->Rollback();
-    d->catStorage->Rollback();
 }
 
 void FeedStorageMK4Impl::close()
@@ -244,11 +225,14 @@
 QStringList FeedStorageMK4Impl::articles(const QString& tag) const
 {
     QStringList list;
+#if 0 //category and tag support disabled
     if (tag.isNull()) // return all articles
     {
+#endif
         int size = d->archiveView.GetSize();
         for (int i = 0; i < size; i++) // fill with guids
             list += QString(d->pguid(d->archiveView.GetAt(i)));
+#if 0 //category and tag support disabled
     }
     else
     {
@@ -265,13 +249,14 @@
         }
 
     }
+#endif
     return list;
 }
 
 QStringList FeedStorageMK4Impl::articles(const Category& cat) const
 {
     QStringList list;
-
+#if 0 //category and tag support disabled
     c4_Row catrow;
     d->pcatTerm(catrow) = cat.term.toUtf8().data();
     d->pcatScheme(catrow) = cat.scheme.toUtf8().data();
@@ -285,7 +270,7 @@
         for (int i = 0; i < size; i++)
             list += QString(d->pguid(catView.GetAt(i)));
     }
-
+#endif
     return list;
 }
 
@@ -636,7 +621,7 @@
         d->pcatTerm(catrow) = cat.term.toUtf8().data();
         d->pcatScheme(catrow) = cat.scheme.toUtf8().data();
         d->pcatName(catrow) = cat.name.toUtf8().data();
-
+#if 0 //category and tag support disabled
         int catidx2 = d->catView.Find(catrow);
 
         if (catidx2 == -1)
@@ -657,7 +642,7 @@
             d->pcategorizedArticles(catrow2) = catView2;
             d->catView.SetAt(catidx2, catrow2);
         }
-
+#endif
         markDirty();
     }
 }
@@ -691,6 +676,7 @@
     }
     else // return all categories in the feed
     {
+#if 0 //category and tag support disabled
         int size = d->catView.GetSize();
         for (int i = 0; i < size; i++)
         {
@@ -703,6 +689,8 @@
 
             list += cat;
         }
+#endif
+
     }
 
     return list;
@@ -710,6 +698,7 @@
 
 void FeedStorageMK4Impl::addTag(const QString& guid, const QString& tag)
 {
+#if 0 //category and tag support disabled
     int findidx = findArticle(guid);
     if (findidx == -1)
         return;
@@ -747,10 +736,12 @@
         }
         markDirty();
     }
+#endif
 }
 
 void FeedStorageMK4Impl::removeTag(const QString& guid, const QString& tag)
 {
+#if 0 //category and tag support disabled
     int findidx = findArticle(guid);
     if (findidx == -1)
         return;
@@ -789,12 +780,13 @@
 
         markDirty();
     }
+#endif
 }
 
 QStringList FeedStorageMK4Impl::tags(const QString& guid) const
 {
     QStringList list;
-
+#if 0 //category and tag support disabled
     if (!guid.isNull()) // return tags for an articles
     {
         int findidx = findArticle(guid);
@@ -815,7 +807,7 @@
         for (int i = 0; i < size; i++)
              list += QString(d->ptag(d->tagView.GetAt(i)));
     }
-
+#endif
     return list;
 }
 
@@ -905,7 +897,7 @@
 void FeedStorageMK4Impl::clear()
 {
     d->storage->RemoveAll();
-    d->tagStorage->RemoveAll();
+
     setUnread(0);
     markDirty();
 }
Index: akregator/plugins/CMakeLists.txt
===================================================================
--- akregator/plugins/CMakeLists.txt	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ akregator/plugins/CMakeLists.txt	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -1,3 +1,8 @@
 add_subdirectory( mk4storage )
+
+# onlinesync plugin is broken, thus disabled
+# minimal TODO before reactivating this:
+# * make it work 
+# * make it use KWallet instead of plaintext KConfig to store the password
 add_subdirectory( onlinesync )
 
Index: akregator/src/articleviewer.cpp
===================================================================
--- akregator/src/articleviewer.cpp	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ akregator/src/articleviewer.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -304,7 +304,9 @@
     QClipboard *cb = QApplication::clipboard();
     cb->setText(m_url.prettyUrl(), QClipboard::Clipboard);
     // don't set url to selection as it's a no-no according to a fd.o spec
-    //cb->setText(m_url.prettyUrl(), QClipboard::Selection);
+    // which spec? Nobody seems to care (tested Firefox (3.5.10) Konqueror,and KMail (4.2.3)), so I re-enable the following line unless someone gives 
+    // a good reason to remove it again (bug 183022) --Frank
+    cb->setText(m_url.prettyUrl(), QClipboard::Selection);
 }
 
 void ArticleViewer::slotSelectionChanged()
@@ -710,9 +712,9 @@
     if(url == "config:/disable_introduction")
     {
         KGuiItem yesButton(KStandardGuiItem::yes());
-        yesButton.setText(i18n("Keep Enabled"));
+        yesButton.setText(i18n("Disable"));
         KGuiItem noButton(KStandardGuiItem::no());
-        noButton.setText(i18n("Disable"));
+        noButton.setText(i18n("Keep Enabled"));
         if(KMessageBox::questionYesNo( widget(), i18n("Are you sure you want to disable this introduction page?"), i18n("Disable Introduction Page"), yesButton, noButton) == KMessageBox::Yes)
         {
             KConfigGroup conf(Settings::self()->config(), "General");
Index: akregator/src/selectioncontroller.cpp
===================================================================
--- akregator/src/selectioncontroller.cpp	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ akregator/src/selectioncontroller.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -181,7 +181,7 @@
 
 void Akregator::SelectionController::articleHeadersAvailable()
 {
-    ArticleModel* const newModel = new ArticleModel( m_selectedSubscription );
+    ArticleModel* const newModel = new ArticleModel( m_selectedSubscription, this );
     m_articleLister->setIsAggregation( m_selectedSubscription->isAggregation() );
     m_articleLister->setArticleModel( newModel );
     delete m_articleModel;
Index: akregator/src/feed.cpp
===================================================================
--- akregator/src/feed.cpp	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ akregator/src/feed.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -668,7 +668,7 @@
     }
 
     if (title().isEmpty())
-        setTitle( doc->title() );
+        setTitle( Syndication::htmlToPlainText( doc->title() ) );
 
     d->description = doc->description();
     d->htmlUrl = doc->link();
Index: akregator/src/aboutdata.h
===================================================================
--- akregator/src/aboutdata.h	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ akregator/src/aboutdata.h	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -28,7 +28,7 @@
 #include "akregator_export.h"
 #include <kaboutdata.h>
 
-#define AKREGATOR_VERSION "1.4.2"
+#define AKREGATOR_VERSION "1.4.4"
 
 namespace Akregator {
 /**
Index: akregator/src/articlelistview.cpp
===================================================================
--- akregator/src/articlelistview.cpp	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ akregator/src/articlelistview.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -428,7 +428,7 @@
 {
     if ( !model() )
         return;
-
+    emit userActionTakingPlace();
     const QModelIndex idx = currentIndex();
     const int newRow = qMax( 0, ( idx.isValid() ? idx.row() : model()->rowCount() ) - 1 );
     const QModelIndex newIdx = idx.isValid() ? idx.sibling( newRow, 0 ) : model()->index( newRow, 0 );
@@ -440,6 +440,7 @@
     if ( !model() )
         return;
 
+    emit userActionTakingPlace();
     const QModelIndex idx = currentIndex();
     const int newRow = idx.isValid() ? ( idx.row() + 1 ) : 0;
     const QModelIndex newIdx = model()->index( qMin( newRow, model()->rowCount() - 1 ), 0 );
Index: akregator/src/mainwindow.cpp
===================================================================
--- akregator/src/mainwindow.cpp	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ akregator/src/mainwindow.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -152,7 +152,7 @@
 void MainWindow::optionsConfigureKeys()
 {
     KShortcutsDialog dlg( KShortcutsEditor::AllActions,
-      KShortcutsEditor::LetterShortcutsDisallowed, this );
+      KShortcutsEditor::LetterShortcutsAllowed, this );
 
     dlg.addCollection(actionCollection());
     if (m_part)
Index: akregator/src/subscriptionlistview.h
===================================================================
--- akregator/src/subscriptionlistview.h	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ akregator/src/subscriptionlistview.h	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -73,6 +73,9 @@
     void slotItemRight();
     void slotItemUp();
     void slotItemDown();
+
+Q_SIGNALS:
+    void userActionTakingPlace();
     
 private:
     void saveHeaderSettings();
Index: akregator/src/actionmanagerimpl.cpp
===================================================================
--- akregator/src/actionmanagerimpl.cpp	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ akregator/src/actionmanagerimpl.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -313,14 +313,16 @@
     connect(action, SIGNAL(triggered(bool)), d->mainWidget, SLOT(slotCopyLinkAddress()));
 
     action = coll->addAction("go_prev_unread_article");
+    action->setIcon(KIcon("go-previous"));
     action->setText(i18n("Pre&vious Unread Article"));
     connect(action, SIGNAL(triggered(bool)), d->mainWidget, SLOT(slotPrevUnreadArticle()));
     action->setShortcut(QKeySequence(Qt::Key_Minus));
 
     action = coll->addAction("go_next_unread_article");
+    action->setIcon(KIcon("go-next"));
     action->setText(i18n("Ne&xt Unread Article"));
     connect(action, SIGNAL(triggered(bool)), d->mainWidget, SLOT(slotNextUnreadArticle()));
-    action->setShortcuts(KShortcut(Qt::Key_Equal, Qt::Key_Plus));
+    action->setShortcuts(KShortcut(Qt::Key_Plus, Qt::Key_Equal));
 
     action = coll->addAction("article_delete");
     action->setIcon(KIcon("edit-delete"));
@@ -453,11 +455,13 @@
     action->setShortcuts(KShortcut( "N" ));
 
     action = coll->addAction("go_next_unread_feed");
+    action->setIcon(KIcon("go-down"));
     action->setText(i18n("N&ext Unread Feed"));
     connect(action, SIGNAL(triggered(bool)), subscriptionListView, SLOT(slotNextUnreadFeed()));
     action->setShortcut(  QKeySequence(Qt::ALT+Qt::Key_Plus) );
 
     action = coll->addAction("go_prev_unread_feed");
+    action->setIcon(KIcon("go-up"));
     action->setText(i18n("Prev&ious Unread Feed"));
     connect(action, SIGNAL(triggered(bool)), subscriptionListView, SLOT(slotPrevUnreadFeed()));
     action->setShortcut( QKeySequence(Qt::ALT+Qt::Key_Minus) );
Index: akregator/src/tabwidget.cpp
===================================================================
--- akregator/src/tabwidget.cpp	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ akregator/src/tabwidget.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -213,6 +213,7 @@
     Frame* f = d->framesById.value(frameId);
     d->frames.remove(f);
     d->framesById.remove(frameId);
+    f->disconnect( this );
     removeTab(indexOf(f));
     emit signalRemoveFrameRequest(f->id());
     if (d->currentFrame())
Index: akregator/src/subscriptionlistview.cpp
===================================================================
--- akregator/src/subscriptionlistview.cpp	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ akregator/src/subscriptionlistview.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -237,6 +237,7 @@
 {
     if ( !model() )
         return;
+    emit userActionTakingPlace();
     const QModelIndex current = currentIndex();
     QModelIndex next = nextFeedIndex( current );
     if ( !next.isValid() )
@@ -249,6 +250,7 @@
 {
     if ( !model() )
         return;
+    emit userActionTakingPlace();
     const QModelIndex current = currentIndex();
     QModelIndex prev = prevUnreadFeedIndex( current );
     if ( !prev.isValid() )
@@ -261,6 +263,7 @@
 {
     if ( !model() )
         return;
+    emit userActionTakingPlace();
     const QModelIndex current = currentIndex();
     QModelIndex next = nextUnreadFeedIndex( current );
     if ( !next.isValid() )
Index: akregator/src/articlelistview.h
===================================================================
--- akregator/src/articlelistview.h	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ akregator/src/articlelistview.h	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -139,6 +139,10 @@
 
     void slotNextUnreadArticle();
 
+Q_SIGNALS:
+
+    void userActionTakingPlace();
+
 private:
     void saveHeaderSettings();
     void loadHeaderSettings();
Index: akregator/src/mainwidget.cpp
===================================================================
--- akregator/src/mainwidget.cpp	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ akregator/src/mainwidget.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -134,9 +134,10 @@
     m_feedListView->setObjectName( "feedtree" );
     m_actionManager->initSubscriptionListView( m_feedListView );
 
-    connect(m_feedListView, SIGNAL(signalContextMenu(K3ListView*, Akregator::TreeNode*, const QPoint&)),
-            this, SLOT(slotFeedTreeContextMenu(K3ListView*, Akregator::TreeNode*, const QPoint&)));
-
+    
+    connect( m_feedListView, SIGNAL(userActionTakingPlace()),
+             this, SLOT(ensureArticleTabVisible()) );
+    
     connect(m_feedListView, SIGNAL(signalDropped (KUrl::List &, Akregator::TreeNode*,
             Akregator::Folder*)),
             this, SLOT(slotFeedUrlDropped (KUrl::List &,
@@ -188,7 +189,9 @@
     m_articleSplitter->setObjectName("panner2");
 
     m_articleListView = new ArticleListView( m_articleSplitter );
-
+    connect( m_articleListView, SIGNAL(UserActionTakingPlace()),
+             this, SLOT(ensureArticleTabVisible()) );
+    
     m_selectionController = new SelectionController( this );
     m_selectionController->setArticleLister( m_articleListView );
     m_selectionController->setFeedSelector( m_feedListView );
@@ -565,7 +568,7 @@
     Settings::setViewMode( m_viewMode );
 }
 
-void Akregator::MainWidget::slotFeedTreeContextMenu(K3ListView*, TreeNode* /*node*/, const QPoint& /*p*/)
+void Akregator::MainWidget::ensureArticleTabVisible()
 {
     m_tabWidget->setCurrentWidget( m_mainFrame );
 }
@@ -735,6 +738,7 @@
 
 void Akregator::MainWidget::slotNextUnreadArticle()
 {
+    ensureArticleTabVisible();
     if (m_viewMode == CombinedView)
     {
         m_feedListView->slotNextUnreadFeed();
@@ -749,6 +753,7 @@
 
 void Akregator::MainWidget::slotPrevUnreadArticle()
 {
+    ensureArticleTabVisible();
     if (m_viewMode == CombinedView)
     {
         m_feedListView->slotPrevUnreadFeed();
Index: akregator/src/trayicon.cpp
===================================================================
--- akregator/src/trayicon.cpp	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ akregator/src/trayicon.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -152,7 +152,7 @@
         }
 
         // overlay
-        QImage overlayImg = m_defaultIcon.toImage().copy();
+        QPixmap overlayImg = m_defaultIcon;
         QPainter p(&overlayImg);
         p.setFont(f);
         KColorScheme scheme(QPalette::Active, KColorScheme::View);
@@ -173,7 +173,7 @@
         p.setOpacity(1.0);
         p.drawText(overlayImg.rect(), Qt::AlignCenter, countStr);
 
-        setIcon(QPixmap::fromImage(overlayImg));
+        setIcon(overlayImg);
     }
 }
 
Index: akregator/src/mainwidget.h
===================================================================
--- akregator/src/mainwidget.h	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ akregator/src/mainwidget.h	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -138,8 +138,7 @@
         /** the article selection has changed */
         void slotArticleSelected(const Akregator::Article&);
 
-        /** Shows requested popup menu for feed tree */
-        void slotFeedTreeContextMenu(K3ListView*, Akregator::TreeNode*, const QPoint&);
+        void ensureArticleTabVisible();
 
         /** emits @ref signalUnreadCountChanged(int) */
         void slotSetTotalUnread();
Index: akregator/configuration/akregator_config_browser.desktop
===================================================================
--- akregator/configuration/akregator_config_browser.desktop	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ akregator/configuration/akregator_config_browser.desktop	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -26,6 +26,7 @@
 Name[ko]=탐색기
 Name[lt]=Naršyklė
 Name[lv]=Pārlūks
+Name[mai]=ब्राउज़र
 Name[nb]=Nettleser
 Name[nds]=Kieker
 Name[nn]=Nettlesar
Index: akregator/configuration/akregator_config_appearance.desktop
===================================================================
--- akregator/configuration/akregator_config_appearance.desktop	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ akregator/configuration/akregator_config_appearance.desktop	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -42,6 +42,7 @@
 Name[ko]=모양
 Name[lt]=Išvaizda
 Name[lv]=Izskats
+Name[mai]=प्रकटन
 Name[mk]=Изглед
 Name[ms]=Rupa
 Name[nb]=Utseende
Index: akregator/configuration/akregator_config_advanced.desktop
===================================================================
--- akregator/configuration/akregator_config_advanced.desktop	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ akregator/configuration/akregator_config_advanced.desktop	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -29,6 +29,7 @@
 Name[ko]=고급
 Name[lt]=Sudėtingesni
 Name[lv]=Paplašināti
+Name[mai]=उन्नत
 Name[nb]=Avansert
 Name[nds]=Verwiedert
 Name[nl]=Geavanceerd
Index: akregator/configuration/settings_advanced.cpp
===================================================================
--- akregator/configuration/settings_advanced.cpp	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ akregator/configuration/settings_advanced.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -27,11 +27,13 @@
 #include "storagefactory.h"
 #include "storagefactoryregistry.h"
 
+#include <KComboBox>
+
 #include <QPushButton>
 #include <QStringList>
 #include <QWidget>
 
-#include <kcombobox.h>
+#include <cassert>
 
 namespace Akregator {
 
@@ -40,20 +42,17 @@
     setObjectName(name);
     setupUi(this);
     
-    QStringList backends = Backend::StorageFactoryRegistry::self()->list();
-    QString tname;
-    int i = 0;
-    QStringList::Iterator end( backends.end() );
-    for (QStringList::Iterator it = backends.begin(); it != end; ++it)
+    const QStringList backends = Backend::StorageFactoryRegistry::self()->list();
+    Q_FOREACH( const QString& i, backends)
     {
-        m_factories[i] = Backend::StorageFactoryRegistry::self()->getFactory(*it);
-	if(m_factories[i])
-	{
-          m_keyPos[m_factories[i]->key()] = i;
-          cbBackend->addItem(m_factories[i]->name());
-	}
-        i++;
+        Backend::StorageFactory* const factory = Backend::StorageFactoryRegistry::self()->getFactory( i );
+        if ( !factory )
+            continue;
+       
+        m_factories.insert( factory->key(), factory );
+        cbBackend->addItem( factory->name(), factory->key() );
     }
+    
     connect(pbBackendConfigure, SIGNAL(clicked()), this, SLOT(slotConfigureStorage()));
     connect(cbBackend, SIGNAL(activated(int)), this, SLOT(slotFactorySelected(int)));
     connect( kcfg_UseMarkReadDelay, SIGNAL( toggled( bool ) ),
@@ -62,34 +61,34 @@
 
 QString SettingsAdvanced::selectedFactory() const
 {
-    const int idx = cbBackend->currentIndex();
-    if ( idx < 0 || idx >= m_factories.count() )
-        return QString();
-    return m_factories[idx]->key();
+    return cbBackend->itemData( cbBackend->currentIndex() ).toString();
 }
 
-void SettingsAdvanced::selectFactory(const QString& key)
+void SettingsAdvanced::selectFactory( const QString& key )
 {
-    const int pos = m_keyPos[key];
-    if ( pos < 0 || pos >= m_factories.count() )
+    const int idx = cbBackend->findData( key );
+    if ( idx < 0 )
         return;
-    cbBackend->setCurrentIndex( pos );
-    pbBackendConfigure->setEnabled( m_factories[pos]->isConfigurable() );
+    cbBackend->setCurrentIndex( idx );
+    const Backend::StorageFactory* const factory = m_factories.value( key );
+    assert( factory );
+    pbBackendConfigure->setEnabled( factory->isConfigurable() );
 }
 
 void SettingsAdvanced::slotConfigureStorage()
 {
-    const int idx = cbBackend->currentIndex();
-     if ( idx < 0 || idx >= m_factories.count() )
-         return;
-    m_factories[idx]->configure();
+    const QString key = cbBackend->itemData( cbBackend->currentIndex() ).toString();
+    Backend::StorageFactory* const factory = m_factories.value( key );
+    assert( factory );
+    factory->configure();
 }
 
-void SettingsAdvanced::slotFactorySelected(int pos)
+void SettingsAdvanced::slotFactorySelected( int pos )
 {
-    if ( pos < 0 || pos >= m_factories.count() )
-        return;
-    pbBackendConfigure->setEnabled(m_factories[pos]->isConfigurable());
+    const QString key = cbBackend->itemData( pos ).toString();
+    const Backend::StorageFactory* const factory = m_factories.value( key );
+    assert( factory );
+    pbBackendConfigure->setEnabled( factory->isConfigurable() );
 }
 
 } //namespace Akregator
Index: akregator/configuration/akregator_config_general.desktop
===================================================================
--- akregator/configuration/akregator_config_general.desktop	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ akregator/configuration/akregator_config_general.desktop	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -40,6 +40,7 @@
 Name[ko]=일반
 Name[lt]=Bendras
 Name[lv]=Pamata
+Name[mai]=सामान्य
 Name[mk]=Општо
 Name[ms]=Umum
 Name[nb]=SGenerelt
Index: akregator/configuration/settings_advanced.h
===================================================================
--- akregator/configuration/settings_advanced.h	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ akregator/configuration/settings_advanced.h	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -57,8 +57,7 @@
         void slotFactorySelected(int);
         
     private:
-        QHash<int,Backend::StorageFactory*> m_factories;
-        QHash<QString, int> m_keyPos;
+        QHash<QString,Backend::StorageFactory*> m_factories;
 };
 
 } // namespace Akregator
Index: akregator/configuration/akregator_config_archive.desktop
===================================================================
--- akregator/configuration/akregator_config_archive.desktop	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ akregator/configuration/akregator_config_archive.desktop	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -27,6 +27,7 @@
 Name[ko]=저장소
 Name[lt]=Archyvas
 Name[lv]=Arhīvs
+Name[mai]=अभिलेख
 Name[nb]=Arkiv
 Name[nds]=Archiev
 Name[nl]=Archief
Index: libkleo/backends/qgpgme/threadedjobmixin.h
===================================================================
--- libkleo/backends/qgpgme/threadedjobmixin.h	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ libkleo/backends/qgpgme/threadedjobmixin.h	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -45,6 +45,7 @@
 #include <gpgme++/context.h>
 #include <gpgme++/interfaces/progressprovider.h>
 
+#include <boost/shared_ptr.hpp>
 #include <boost/bind.hpp>
 #include <boost/tuple/tuple.hpp>
 #include <boost/utility/enable_if.hpp>
@@ -101,9 +102,9 @@
 
     template <typename T_binder>
     void run( const T_binder & func ) {
-      m_watcher.setFuture( QtConcurrent::run( boost::bind( func, m_ctx ) ) );
+      m_watcher.setFuture( QtConcurrent::run( boost::bind( func, m_ctx.get() ) ) );
     }
-    GpgME::Context * context() const { return m_ctx; }
+    GpgME::Context * context() const { return m_ctx.get(); }
 
     virtual void resultHook( const result_type & ) {}
 
@@ -151,7 +152,7 @@
     }
 
   private:
-    GpgME::Context * m_ctx;
+    boost::shared_ptr<GpgME::Context> m_ctx;
     QFutureWatcher<T_result> m_watcher;
     QString m_auditLog;
   };
Index: kleopatra/conf/kleopatra_config_appear.desktop
===================================================================
--- kleopatra/conf/kleopatra_config_appear.desktop	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ kleopatra/conf/kleopatra_config_appear.desktop	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -44,6 +44,7 @@
 Name[ko]=모양
 Name[lt]=Išvaizda
 Name[lv]=Izskats
+Name[mai]=प्रकटन
 Name[mk]=Изглед
 Name[ms]=Rupa
 Name[nb]=Utseende
Index: kresources/tvanytime/kcal_tvanytime.desktop
===================================================================
--- kresources/tvanytime/kcal_tvanytime.desktop	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ kresources/tvanytime/kcal_tvanytime.desktop	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -26,6 +26,7 @@
 Name[ko]=TV 편성표
 Name[lt]=TV tvarkaraščiai
 Name[lv]=TV programmas
+Name[mai]=TV कार्यक्रम
 Name[mk]=ТВ програми
 Name[nb]=TV-program
 Name[nds]=Feernsehprogramm
Index: kresources/kolab/kabc/contact.cpp
===================================================================
--- kresources/kolab/kabc/contact.cpp	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ kresources/kolab/kabc/contact.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -891,28 +891,28 @@
     type = type & ~KABC::PhoneNumber::Work;
   }
 
-  // To support both "home1" and "home2", map Home+Pref to home1
+  // To support both "home1" and "home2", map Home+Pref to home2
   if ( ( type & KABC::PhoneNumber::Home ) && ( type & KABC::PhoneNumber::Pref ) )
   {
-      types << "home1";
+      types << "home2";
       type = type & ~KABC::PhoneNumber::Home;
       type = type & ~KABC::PhoneNumber::Pref;
   }
-  // To support both "business1" and "business2", map Work+Pref to business1
+  // To support both "business1" and "business2", map Work+Pref to business2
   if ( ( type & KABC::PhoneNumber::Work ) && ( type & KABC::PhoneNumber::Pref ) )
   {
-      types << "business1";
+      types << "business2";
       type = type & ~KABC::PhoneNumber::Work;
       type = type & ~KABC::PhoneNumber::Pref;
   }
 
 
   if ( type & KABC::PhoneNumber::Home )
-    types << "home2";
+    types << "home1";
   if ( type & KABC::PhoneNumber::Msg ) // Msg==messaging
     types << "company";
   if ( type & KABC::PhoneNumber::Work )
-    types << "business2";
+    types << "business1";
   if ( type & KABC::PhoneNumber::Pref )
     types << "primary";
   if ( type & KABC::PhoneNumber::Voice )
@@ -942,13 +942,13 @@
     return KABC::PhoneNumber::Home | KABC::PhoneNumber::Fax;
   if ( type == "businessfax" )
     return KABC::PhoneNumber::Work | KABC::PhoneNumber::Fax;
+  if ( type == "business2" )
+    return KABC::PhoneNumber::Work | KABC::PhoneNumber::Pref;
   if ( type == "business1" )
-    return KABC::PhoneNumber::Work | KABC::PhoneNumber::Pref;
-  if ( type == "business2" )
     return KABC::PhoneNumber::Work;
+  if ( type == "home2" )
+    return KABC::PhoneNumber::Home | KABC::PhoneNumber::Pref;
   if ( type == "home1" )
-    return KABC::PhoneNumber::Home | KABC::PhoneNumber::Pref;
-  if ( type == "home2" )
     return KABC::PhoneNumber::Home;
   if ( type == "company" )
     return KABC::PhoneNumber::Msg;
Index: kresources/kolab/shared/kmailconnection.h
===================================================================
--- kresources/kolab/shared/kmailconnection.h	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ kresources/kolab/shared/kmailconnection.h	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -79,6 +79,12 @@
    */
   bool connectToKMail();
 
+  /**
+   * Deletes the KMail groupware interface. The next method needs
+   * to call connectToKMail() again to make it work.
+   */
+  void disconnectFromKMail();
+
   // Call the DBus methods
   bool kmailSubresources( QList<KMail::SubResource>& lst,
                           const QString& contentsType );
@@ -122,8 +128,8 @@
         value = reply.value();
         return true;
       }
-      kWarning(5650) << "D-Bus communication failed. Reply error is: " << reply.error()
-          << "Last interface error was: " << mKmailGroupwareInterface->lastError();
+      kWarning(5650) << "D-Bus communication with KMail failed. Reply error is: " << reply.error()
+                     << "Last interface error was: " << mKmailGroupwareInterface->lastError();
       return false;
     }
 
@@ -134,8 +140,13 @@
       return b && ok;
     }
 
+    /**
+     * There is no reliable way to detect if the /Groupware object on KMail is really available,
+     * so we look for the dummy service org.kde.kmail.groupware instead, which KMail registers
+     * _after_ setting up the other groupware interfaces.
+     */
+    bool waitForGroupwareObject() const;
 
-
 private slots:
   void dbusServiceOwnerChanged(const QString & service, const QString & oldOwner, const QString & newOwner);
 
Index: kresources/kolab/shared/kmailconnection.cpp
===================================================================
--- kresources/kolab/shared/kmailconnection.cpp	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ kresources/kolab/shared/kmailconnection.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -42,6 +42,8 @@
 #include <QDBusAbstractInterface>
 #include <QMap>
 
+#include <unistd.h>
+
 using namespace Kolab;
 
 KMailConnection::KMailConnection( ResourceKolabBase* resource )
@@ -58,10 +60,29 @@
 
 KMailConnection::~KMailConnection()
 {
-  delete mKmailGroupwareInterface;
-  mKmailGroupwareInterface = 0;
+  disconnectFromKMail();
 }
 
+bool KMailConnection::waitForGroupwareObject() const
+{
+  const int waitTime = 1000 * 10;        // 10 milliseconds step
+  const int timeout = 1000 * 1000 * 60;  // 60 seconds total timeout
+  int waited = 0;
+
+  forever {
+    if ( QDBusConnection::sessionBus().interface()->isServiceRegistered( "org.kde.kmail.groupware" ) ) {
+      return true;
+    }
+
+    usleep( waitTime );
+    waited += waitTime;
+    if ( waited > timeout ) {
+      kDebug(5650) << "Timeout while waiting for the groupware interface.";
+      return false;
+    }
+  }
+}
+
 bool KMailConnection::connectToKMail()
 {
   if ( !mKmailGroupwareInterface ) {
@@ -77,10 +98,13 @@
       return false;
     }
     kDebug(5650) << "Connected to the KMail DBus interface.";
+    if ( !waitForGroupwareObject() ) {
+      kError(5650) << "Can't connect to the groupware object on the KMail interface!";
+      return false;
+    }
+
     mKmailGroupwareInterface = new OrgKdeKmailGroupwareInterface( dbusService, KMAIL_DBUS_GROUPWARE_PATH,
                                                                   QDBusConnection::sessionBus() );
-    if ( !mKmailGroupwareInterface->isValid() )
-      kWarning(5650) << "The groupware interface is not valid, race condition!?";
 
     mOldServiceName = mKmailGroupwareInterface->service();
 
@@ -100,6 +124,12 @@
   return ( mKmailGroupwareInterface != 0 );
 }
 
+void KMailConnection::disconnectFromKMail()
+{
+  delete mKmailGroupwareInterface;
+  mKmailGroupwareInterface = 0;
+}
+
 bool KMailConnection::fromKMailAddIncidence( const QString& type,
                                              const QString& folder,
                                              uint sernum,
@@ -292,8 +322,7 @@
     {
       // Delete the stub so that the next time we need to talk to kmail,
       // we'll know that we need to start a new one.
-      delete mKmailGroupwareInterface;
-      mKmailGroupwareInterface = 0;
+      disconnectFromKMail();
     }
     else {
       const bool kmailJustStarted = oldOwner.isEmpty();
Index: kresources/birthdays/resourcekabcconfig.cpp
===================================================================
--- kresources/birthdays/resourcekabcconfig.cpp	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ kresources/birthdays/resourcekabcconfig.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -30,6 +30,7 @@
 #include <QGridLayout>
 #include <QBoxLayout>
 #include <QCheckBox>
+#include <QIntValidator>
 
 #include <kabprefs.h>
 #include <kdebug.h>
@@ -54,7 +55,7 @@
 
   mALabel = new QLabel(i18n("Reminder before (in days):"),this);
   topLayout->addWidget(mALabel, 1, 0 );
-  mAlarmTimeEdit = new KLineEdit(this); 
+  mAlarmTimeEdit = new KLineEdit(this);
   mAlarmTimeEdit->setValidator(new QIntValidator(mAlarmTimeEdit));
   mAlarmTimeEdit->setText("0");
   topLayout->addWidget(mAlarmTimeEdit, 1, 1 );
Index: kresources/akonadi/kcal/akonadi.desktop
===================================================================
--- kresources/akonadi/kcal/akonadi.desktop	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ kresources/akonadi/kcal/akonadi.desktop	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -26,7 +26,7 @@
 Comment[pl]=Zapewnia dostęp do kalendarzy przechowywanych w katalogach kalendarzy Akonadi
 Comment[pt]=Oferece o acesso aos calendários guardados nas pastas de calendários do Akonadi
 Comment[pt_BR]=Fornece acesso aos calendários armazenados nas pastas de calendários do Akonadi
-Comment[ru]=Доступ к папкам органайзера Akonadi
+Comment[ru]=Доступ к папкам календарей Akonadi
 Comment[sl]=Omogoča dostop do koledarjev, shranjenih v Akonadijevih mapah s koledarji
 Comment[sv]=Ger tillgång till kalendrar lagrade i Akonadi-kalenderkataloger
 Comment[tr]=Akonadi takvim dizinlerindeki takvimlere erişim sağlar
Index: kresources/akonadi/CMakeLists.txt
===================================================================
--- kresources/akonadi/CMakeLists.txt	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ kresources/akonadi/CMakeLists.txt	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -4,5 +4,7 @@
 # include (ConfigureChecks.cmake)
 # configure_file (config.h.cmake ${CMAKE_CURRENT_BINARY_DIR}/config.h)
 
+set( CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} ${KDE4_ENABLE_EXCEPTIONS}" )
+
 add_subdirectory(kabc)
 add_subdirectory(kcal)
Index: kresources/groupware/kabc_groupware.desktop
===================================================================
--- kresources/groupware/kabc_groupware.desktop	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ kresources/groupware/kabc_groupware.desktop	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -37,7 +37,7 @@
 Name[pt]=Servidor de Groupware
 Name[pt_BR]=Servidor Groupware
 Name[ro]=Server Groupware
-Name[ru]=Groupware-cервер
+Name[ru]=Сервер совместной работы
 Name[sl]=Strežnik za skupinsko delo
 Name[sv]=Grupprogramserver
 Name[ta]=குழுவாரி சேவகன்
@@ -69,7 +69,7 @@
 Comment[pl]=Zapewnia dostęp do wizytówek przechowywanych na serwerach pracy grupowej.
 Comment[pt]=Oferece o acesso aos contactos guardados num servidor de Groupware.
 Comment[pt_BR]=Fornece acesso aos contatos armazenados em um servidor de Groupware.
-Comment[ru]=Доступ к контактам на сервере коллективной работы.
+Comment[ru]=Доступ к контактам на сервере совместной работы.
 Comment[sl]=Omogoča dostop do stikov, shranjenih na strežniku Groupware.
 Comment[sv]=Ger tillgång till kontakter lagrade på en grupprogramserver.
 Comment[tr]=Groupware sunucusu üzerindeki kişilere erişim sağlar.
Index: kresources/groupware/kcal_groupware.desktop
===================================================================
--- kresources/groupware/kcal_groupware.desktop	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ kresources/groupware/kcal_groupware.desktop	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -37,7 +37,7 @@
 Name[pt]=Servidor de Groupware
 Name[pt_BR]=Servidor Groupware
 Name[ro]=Server Groupware
-Name[ru]=Groupware-cервер
+Name[ru]=Сервер совместной работы
 Name[sl]=Strežnik za skupinsko delo
 Name[sv]=Grupprogramserver
 Name[ta]=குழுவாரி சேவகன்
Index: kmail/kmfolderdir.h
===================================================================
--- kmail/kmfolderdir.h	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ kmail/kmfolderdir.h	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -25,6 +25,11 @@
 
   virtual bool isDir() const { return true; }
 
+  /**
+   * Adds the given subdirectory of this directory to the associated folder.
+   */
+  void addDirToParent( const QString &dirName, KMFolder *parentFolder );
+
   /** Read contents of directory. */
   virtual bool reload();
 
Index: kmail/accountdialog.cpp
===================================================================
--- kmail/accountdialog.cpp	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ kmail/accountdialog.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -324,6 +324,8 @@
   connect( mImap.ui.useDefaultIdentityCheck, SIGNAL( toggled(bool) ), this, SLOT( slotIdentityCheckboxChanged() ) );
   connect( mImap.ui.checkCapabilities, SIGNAL(clicked()), SLOT(slotCheckImapCapabilities()));
   connect( mImap.encryptionButtonGroup, SIGNAL(buttonClicked(int)), SLOT(slotImapEncryptionChanged(int)) );
+  connect( mImap.ui.passwordEdit, SIGNAL( textEdited( const QString& ) ),
+           this, SLOT( slotImapPasswordChanged( const QString& ) ) );
 
   // TODO (marc/bo): Test this
   mSieveConfigEditor = new SieveConfigEditor( mImap.ui.tabWidget );
@@ -694,7 +696,7 @@
     checkHighest( mPop.authButtonGroup );
 }
 
-void AccountDialog::slotPopPasswordChanged(const QString& text)
+void AccountDialog::slotPopPasswordChanged( const QString& text )
 {
   if ( text.isEmpty() )
     mPop.ui.storePasswordCheck->setCheckState( Qt::Unchecked );
@@ -702,6 +704,14 @@
     mPop.ui.storePasswordCheck->setCheckState( Qt::Checked );
 }
 
+void AccountDialog::slotImapPasswordChanged( const QString& text )
+{
+  if ( text.isEmpty() )
+    mImap.ui.storePasswordCheck->setCheckState( Qt::Unchecked );
+  else
+    mImap.ui.storePasswordCheck->setCheckState( Qt::Checked );
+}
+
 void AccountDialog::slotImapEncryptionChanged( int id )
 {
   kDebug(5006) << id;
@@ -1472,6 +1482,11 @@
     if ( edit->isModified() ) {
       mDelimMap.remove( edit->lastText() );
     }
+    if ( mDelimMap.isEmpty() ) {
+      // Make sure that old values get overwritten in the config when the map is
+      // empty. It is needed to add an empty item for that.
+      mDelimMap.insert( QString(), QString() );
+    }
     mLineEditMap.remove( id );
     mainWidget()->layout()->removeWidget( edit );
     edit->close();
Index: kmail/imapaccountbase.cpp
===================================================================
--- kmail/imapaccountbase.cpp	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ kmail/imapaccountbase.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -1,3 +1,4 @@
+
 /** -*- c++ -*-
  * imapaccountbase.cpp
  *
@@ -1118,12 +1119,12 @@
 }
 
 //-----------------------------------------------------------------------------
-void ImapAccountBase::processNewMailSingleFolder( KMFolder *folder )
+void ImapAccountBase::processNewMailInFolder( KMFolder *folder, FolderListType type /*= Single*/  )
 {
   if ( mFoldersQueuedForChecking.contains( folder ) )
     return;
   mFoldersQueuedForChecking.append( folder );
-  mCheckingSingleFolder = true;
+  mCheckingSingleFolder = ( type == Single );
   if ( checkingMail() ) {
     disconnect( this, SIGNAL( finishedCheck( bool, CheckStatus ) ),
                 this, SLOT( slotCheckQueuedFolders() ) );
Index: kmail/kmailicalifaceimpl.cpp
===================================================================
--- kmail/kmailicalifaceimpl.cpp	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ kmail/kmailicalifaceimpl.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -193,6 +193,7 @@
 
 KMailICalIfaceImpl::~KMailICalIfaceImpl()
 {
+  QDBusConnection::sessionBus().unregisterService( "org.kde.kmail.groupware" );
   qDeleteAll( mExtraFolders );
   qDeleteAll( mAccumulators );
   mAccumulators.clear();
@@ -204,6 +205,11 @@
   KMail::registerGroupwareTypes();
   QDBusConnection::sessionBus().registerObject( "/Groupware", this, QDBusConnection::ExportAdaptors );
   new GroupwareAdaptor( this );
+
+  // Register a dummy service, so we can use isServiceRegistered() in other applications
+  // to find out if the KMail groupware services are available.
+  // And no, D-Bus does not provide an easy way to just check for the /Groupware object :(
+  QDBusConnection::sessionBus().registerService( "org.kde.kmail.groupware" );
 }
 
 /* libkcal part of the interface, called from the resources using this
@@ -778,7 +784,7 @@
       imap->getAndCheckFolder();
     } else if ( f->folderType() == KMFolderTypeCachedImap ) {
       KMFolderCachedImap* cached = static_cast<KMFolderCachedImap*>( f->storage() );
-      cached->account()->processNewMailSingleFolder( f );
+      cached->account()->processNewMailInFolder( f );
     }
   }
   return true;
@@ -2387,7 +2393,7 @@
     else
       return;
   }
-  dimapFolder->account()->processNewMailSingleFolder( folder );
+  dimapFolder->account()->processNewMailInFolder( folder );
 }
 
 #include "kmailicalifaceimpl.moc"
Index: kmail/subscriptiondialog.h
===================================================================
--- kmail/subscriptiondialog.h	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ kmail/subscriptiondialog.h	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -89,11 +89,6 @@
           const QStringList&, const QStringList&, const ImapAccountBase::jobData &);
 
       /**
-       * called by Ok-button, saves the changes
-       */
-      void slotSave();
-
-      /**
        * Called from the account when a connection was established
        */
       void slotConnectionResult( int errorCode, const QString& errorMsg );
@@ -105,10 +100,22 @@
       void slotLoadFolders();
 
     protected:
+
+      /**
+       * Reimplemented from KDialog to call doSave() when the OK button is clicked.
+       * This makes it possible to keep the dialog open after the user canceled the dialog
+       * from checkIfSubscriptionsEnabled().
+       */
+      virtual void slotButtonClicked( int button );
+
       virtual void listAllAvailableAndCreateItems() = 0;
       virtual void processFolderListing() = 0;
-      virtual void doSave() = 0;
 
+      /**
+       * @return false is saving was canceled by the user
+       */
+      virtual bool doSave() = 0;
+
       // helpers
       /** Move all child items of @param oldItem under @param item */
       void moveChildrenToNewParent( GroupItem *oldItem, GroupItem *item  );
@@ -117,9 +124,13 @@
        * folders. */
       void createListViewItem( int i );
 
-      /** If subscriptions are not used for the server, 
-       *  asks "Do you want to enable subscriptions?" */
-      void checkIfSubscriptionsEnabled();
+      /**
+       * If subscriptions are not used for the server,
+       * asks "Do you want to enable subscriptions?"
+       *
+       * @return false if the user clicked cancel, true otherwise
+       */
+      bool checkIfSubscriptionsEnabled();
 
       QString mDelimiter;
       QStringList mFolderNames, mFolderPaths,
@@ -149,7 +160,7 @@
       /** reimpl */
       virtual void processFolderListing();
       /** reimpl */
-      virtual void doSave();
+      virtual bool doSave();
 
     private:
       /**
Index: kmail/localsubscriptiondialog.h
===================================================================
--- kmail/localsubscriptiondialog.h	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ kmail/localsubscriptiondialog.h	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -53,7 +53,7 @@
       /** reimpl */
       virtual void processFolderListing();
       /**  reimpl */
-      virtual void doSave();
+      virtual bool doSave();
       virtual void loadingComplete();
 
     private:
Index: kmail/messagelistview/widget.cpp
===================================================================
--- kmail/messagelistview/widget.cpp	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ kmail/messagelistview/widget.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -618,8 +618,7 @@
     menu.addAction( mMainWidget->useAction() );
   } else {
     // show most used actions
-    if( !folder()->isSent() )
-      menu.addAction( mMainWidget->messageActions()->replyMenu() );
+    menu.addAction( mMainWidget->messageActions()->replyMenu() );
     menu.addAction( mMainWidget->forwardMenu() );
     if( mMainWidget->sendAgainAction()->isEnabled() )
       menu.addAction( mMainWidget->sendAgainAction() );
Index: kmail/profiles/profile-high-contrast-rc.desktop
===================================================================
--- kmail/profiles/profile-high-contrast-rc.desktop	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ kmail/profiles/profile-high-contrast-rc.desktop	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -32,6 +32,7 @@
 Name[ko]=고대비
 Name[lt]=Didelis kontrastas
 Name[lv]=Augsts kontrasts
+Name[mai]=बेसी विरोधी
 Name[mk]=Висок контраст
 Name[ms]=Kontras Tinggi
 Name[nb]=Høy kontrast
@@ -107,8 +108,8 @@
 Comment[tr]=Görsel engelli kullanıcılar için arttırılmış yazı tipi boyutu
 Comment[uk]=Збільшений розмір шрифтів для людей з поганим зором
 Comment[vi]=Tăng cỡ font cho người dùng tàn tật 
+Comment[xh]=Ubungakanani bobukhulu begama bunyusiwe kubasebenzisi ababonayo
 Comment[x-test]=xxIncreased font sizes for visually impaired usersxx
-Comment[xh]=Ubungakanani bobukhulu begama bunyusiwe kubasebenzisi ababonayo
 Comment[zh_CN]=对有视觉障碍的用户增加字体大小
 Comment[zh_TW]=遞增字型大小以適合視覺障礙者
 
Index: kmail/profiles/profile-default-rc.desktop
===================================================================
--- kmail/profiles/profile-default-rc.desktop	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ kmail/profiles/profile-default-rc.desktop	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -32,6 +32,7 @@
 Name[ko]=기본값
 Name[lt]=Numatytasis
 Name[lv]=Noklusētais
+Name[mai]=मूलभूत
 Name[mk]=Стандарден
 Name[ms]=Piawai
 Name[nb]=Standard
@@ -59,8 +60,8 @@
 Name[uz@cyrillic]=Андоза
 Name[vi]=Mặc định 
 Name[wa]=Prémetou
+Name[xh]=Engagqibekanga
 Name[x-test]=xxDefaultxx
-Name[xh]=Engagqibekanga
 Name[zh_CN]=默认
 Name[zh_TW]=預設
 Comment=Standard profile
@@ -120,8 +121,8 @@
 Comment[uz]=Andoza profili
 Comment[uz@cyrillic]=Андоза профили
 Comment[vi]=Hồ sơ chuẩn
+Comment[xh]=Imboniselo yabucala esezantsi
 Comment[x-test]=xxStandard profilexx
-Comment[xh]=Imboniselo yabucala esezantsi
 Comment[zh_CN]=标准配置文件
 Comment[zh_TW]=標準設定
 
Index: kmail/profiles/profile-html-rc.desktop
===================================================================
--- kmail/profiles/profile-html-rc.desktop	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ kmail/profiles/profile-html-rc.desktop	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -55,8 +55,8 @@
 Comment[tr]=HTML ön izleme aktif standart profil - daha az güvenli!
 Comment[uk]=Окремий профіль з ввімкненим переглядом HTML - менш безпечний!
 Comment[vi]=Hồ sơ chuẩn cho phép xem trước HTML - I't bảo mật hơn !
+Comment[xh]=Imboniselo yabucala esezantsi nge HTML imboniso yenziwe - ukhuseleko oluncinane!
 Comment[x-test]=xxStandard profile with HTML preview enabled - less secure!xx
-Comment[xh]=Imboniselo yabucala esezantsi nge HTML imboniso yenziwe - ukhuseleko oluncinane!
 Comment[zh_CN]=启用 HTML 预览的标准配置文件 - 更不安全！
 Comment[zh_TW]=標準設定，HTML 預覽開啟 - 較不安全!
 
Index: kmail/profiles/profile-purist-rc.desktop
===================================================================
--- kmail/profiles/profile-purist-rc.desktop	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ kmail/profiles/profile-purist-rc.desktop	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -37,8 +37,8 @@
 Name[tg]=Пурист
 Name[tr]=Sadelikçi
 Name[uk]=Пуристичний
+Name[xh]=isiPurist
 Name[x-test]=xxPuristxx
-Name[xh]=isiPurist
 Name[zh_CN]=严格
 Name[zh_TW]=較安全
 Comment=Most features turned off, KDE global settings are used
@@ -92,8 +92,8 @@
 Comment[tr]=Bir çok özellik kapatılmış, KDE'nin küresel ayarları kullanılır
 Comment[uk]=Більшість функцій вимкнено, вживаються глобальні установки KDE
 Comment[vi]=Hầu hết các chức năng tắt, Thiết lập toàn cục của KDE được dùng 
+Comment[xh]=Imisebenzi emininzi icinyiwe, izicwangciso ezingqukuva ze KDE ziyasetyenziswa
 Comment[x-test]=xxMost features turned off, KDE global settings are usedxx
-Comment[xh]=Imisebenzi emininzi icinyiwe, izicwangciso ezingqukuva ze KDE ziyasetyenziswa
 Comment[zh_CN]=关闭大多数特性，使用 KDE 全局设置
 Comment[zh_TW]=大部份功能都關閉，使用 KDE 全域設定
 
Index: kmail/folderselectiontreewidget.cpp
===================================================================
--- kmail/folderselectiontreewidget.cpp	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ kmail/folderselectiontreewidget.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -64,6 +64,16 @@
   KMFolder * folder() const
     { return mFolder; };
 
+  bool isReadOnly() const
+  {
+    return folder() && folder()->isReadOnly();
+  }
+
+  bool noContent() const
+  {
+    return folder() && folder()->noContent();
+  }
+
 private:
   KMFolder * mFolder;
 
@@ -90,6 +100,12 @@
            this, SLOT( addChildFolder() ) );
 }
 
+bool FolderSelectionTreeWidget::itemSelectable( const FolderSelectionTreeWidgetItem *item ) const
+{
+  return !( ( mLastMustBeReadWrite && item->isReadOnly() ) ||
+            ( item->noContent() ) );
+}
+
 void FolderSelectionTreeWidget::recursiveReload( FolderViewItem *fti, FolderSelectionTreeWidgetItem *parent )
 {
   // search folders are never shown
@@ -118,8 +134,8 @@
 
   item->setText( mPathColumnIndex, path );
 
-  // Make readonly items unselectable, if we're told so
-  if ( mLastMustBeReadWrite && ( fti->folder() && fti->folder()->isReadOnly() ) ) {
+  // Make readonly and nocoontent items unselectable, if we're told so
+  if ( !itemSelectable( item ) ) {
     item->setFlags( item->flags() & ~Qt::ItemIsSelectable );
   } else {
     item->setFolder( fti->folder() );
@@ -296,7 +312,10 @@
     {
       item->setHidden( false );
       item->setSelected( false );
-      item->setFlags( item->flags() | Qt::ItemIsSelectable );
+      if ( itemSelectable( static_cast< FolderSelectionTreeWidgetItem* >( item ) ) )
+        item->setFlags( item->flags() | Qt::ItemIsSelectable );
+      else
+        item->setFlags( item->flags() & ~Qt::ItemIsSelectable );
       ++clean;
     }
 
@@ -320,6 +339,9 @@
 
   for( QList<QTreeWidgetItem *>::Iterator it = lItems.begin(); it != lItems.end(); ++it )
   {
+    if ( !itemSelectable( static_cast<FolderSelectionTreeWidgetItem*>( ( *it ) ) ) )
+      continue;
+
     ( *it )->setFlags( ( *it )->flags() | Qt::ItemIsSelectable );
     ( *it )->setHidden( false );
 
Index: kmail/kmsystemtray.cpp
===================================================================
--- kmail/kmsystemtray.cpp	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ kmail/kmsystemtray.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -203,7 +203,7 @@
     }
 
     // Overlay the light KMail icon with the number image
-    QImage iconWithNumberImage = mDefaultIcon.toImage().copy();
+    QPixmap iconWithNumberImage = mDefaultIcon;
     QPainter p( &iconWithNumberImage );
     p.setFont( countFont );
     KColorScheme scheme( QPalette::Active, KColorScheme::View );
@@ -224,7 +224,7 @@
     p.setOpacity( 1.0 );
     p.drawText( iconWithNumberImage.rect(), Qt::AlignCenter, countString );
 
-    setIcon( QPixmap::fromImage( iconWithNumberImage ) );
+    setIcon( iconWithNumberImage );
   } else
   {
     setIcon( mDefaultIcon );
@@ -278,6 +278,10 @@
       /** Check all new folders to see if we started with any new messages */
       updateNewMessageNotification(currentFolder);
     }
+    else {
+      disconnect( currentFolder, SIGNAL( numUnreadMsgsChanged(KMFolder*) ),
+                  this, SLOT( updateNewMessageNotification(KMFolder *) ) );
+    }
   }
 }
 
@@ -575,4 +579,9 @@
   ftw->setCurrentFolder( fldr );
 }
 
+bool KMSystemTray::hasUnreadMail() const
+{
+  return ( mCount != 0 );
+}
+
 #include "kmsystemtray.moc"
Index: kmail/kmmessage.h
===================================================================
--- kmail/kmmessage.h	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ kmail/kmmessage.h	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -412,11 +412,13 @@
     as long as the mail is not in a folder. */
   void setMsgSerNum(unsigned long newMsgSerNum = 0);
 
+  enum EncodingMode { NoEncoding, MessageCharsetEncoding };
+
   /** Returns the value of a header field with the given name. If multiple
       header fields with the given name might exist then you should use
       headerFields() instead.
   */
-  QString headerField(const QByteArray& name) const;
+  QString headerField( const QByteArray& name, EncodingMode encodingMode = MessageCharsetEncoding ) const;
 
   enum HeaderFieldType { Unstructured, Structured, Address };
 
@@ -426,7 +428,7 @@
   */
   void setHeaderField( const QByteArray& name, const QString& value,
                        HeaderFieldType type = Unstructured,
-                       bool prepend = false );
+                       bool prepend = false, EncodingMode encodingMode = MessageCharsetEncoding );
 
   /** Returns a list of the values of all header fields with the given name. */
   QStringList headerFields( const QByteArray& name ) const;
Index: kmail/kmail_config_misc.desktop
===================================================================
--- kmail/kmail_config_misc.desktop	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ kmail/kmail_config_misc.desktop	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -42,6 +42,7 @@
 Name[ko]=기타
 Name[lt]=Įvairūs
 Name[lv]=Dažādi
+Name[mai]=विविध
 Name[mk]=Разно
 Name[ms]=Pelbagai
 Name[nb]=Div
Index: kmail/simplestringlisteditor.h
===================================================================
--- kmail/simplestringlisteditor.h	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ kmail/simplestringlisteditor.h	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -91,6 +91,7 @@
   void slotSelectionChanged();
 
 protected:
+  bool containsString( const QString & str );
   QListWidget   *mListBox;
   QPushButton   *mAddButton;
   QPushButton   *mRemoveButton;
Index: kmail/kmacctcachedimap.cpp
===================================================================
--- kmail/kmacctcachedimap.cpp	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ kmail/kmacctcachedimap.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -210,7 +210,12 @@
   else {
     KMFolder* f = mMailCheckFolders.front();
     mMailCheckFolders.pop_front();
-    processNewMail( static_cast<KMFolderCachedImap *>( f->storage() ), false );
+
+    // Only check mail if the folder really exists, it might have been removed by the sync in
+    // the meantime.
+    if ( f ) {
+      processNewMail( static_cast<KMFolderCachedImap *>( f->storage() ), !checkingSingleFolder() );
+    }
   }
 }
 
@@ -353,8 +358,8 @@
   QStringList strList;
   QList<QPointer<KMFolder> > folderList;
   kmkernel->dimapFolderMgr()->createFolderList( &strList, &folderList,
-						folder->folder()->child(), QString(),
-						false );
+                                                folder->folder()->child(), QString(),
+                                                false );
   QList<QPointer<KMFolder> >::Iterator it;
   mCountLastUnread = 0;
   mUnreadBeforeCheck.clear();
@@ -366,13 +371,12 @@
       // This invalidates the folder completely
       cfolder->setUidValidity("INVALID");
       cfolder->writeUidCache();
-      processNewMailSingleFolder( f );
     }
   }
   folder->setUidValidity("INVALID");
   folder->writeUidCache();
 
-  processNewMailSingleFolder( folder->folder() );
+  processNewMailInFolder( folder->folder(), Recursive );
 }
 
 //-----------------------------------------------------------------------------
Index: kmail/kmfoldermaildir.cpp
===================================================================
--- kmail/kmfoldermaildir.cpp	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ kmail/kmfoldermaildir.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -363,7 +363,7 @@
     aMsg->removeHeaderField("Content-Type");        // the line above
 
 
-  const QString uidHeader = aMsg->headerField( "X-UID" );
+  const QString uidHeader = aMsg->headerField( "X-UID", KMMessage::NoEncoding );
   if ( !uidHeader.isEmpty() && stripUid )
     aMsg->removeHeaderField( "X-UID" );
 
@@ -372,7 +372,7 @@
   // Re-add the uid so that the take can make use of it, in case the
   // message is currently in an imap folder
   if ( !uidHeader.isEmpty() && stripUid )
-    aMsg->setHeaderField( "X-UID", uidHeader );
+    aMsg->setHeaderField( "X-UID", uidHeader, KMMessage::Unstructured, false, KMMessage::NoEncoding );
 
   if ( msgText.isEmpty() ) {
     kDebug(5006) <<"Message added to folder `" << objectName() <<"' contains no data. Ignoring it.";
Index: kmail/simplestringlisteditor.cpp
===================================================================
--- kmail/simplestringlisteditor.cpp	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ kmail/simplestringlisteditor.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -158,6 +158,14 @@
   return result;
 }
 
+bool SimpleStringListEditor::containsString( const QString & str ) {
+  for ( int i = 0; i < mListBox->count(); i++ ) {
+    if ( mListBox->item( i )->text() == str )
+      return true;
+  }
+  return false;
+}
+
 void SimpleStringListEditor::setButtonText( ButtonCode button,
                                             const QString & text ) {
   switch ( button ) {
@@ -196,9 +204,10 @@
                                             &ok, this );
   // let the user verify the string before adding
   emit aboutToAdd( newEntry );
-  if ( ok && !newEntry.isEmpty() )
-    mListBox->addItem( newEntry );
-  emit changed();
+  if ( ok && !newEntry.isEmpty() && !containsString( newEntry )) {
+      mListBox->addItem( newEntry );
+      emit changed();
+  }
 }
 
 void SimpleStringListEditor::slotRemove() {
Index: kmail/subscriptiondialog.cpp
===================================================================
--- kmail/subscriptiondialog.cpp	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ kmail/subscriptiondialog.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -49,9 +49,6 @@
   hideTreeCheckbox();
   hideNewOnlyCheckbox();
 
-  // ok-button
-  connect(this, SIGNAL(okClicked()), SLOT(slotSave()));
-
   // reload-list button
   connect(this, SIGNAL(user1Clicked()), SLOT(slotLoadFolders()));
 
@@ -78,6 +75,18 @@
   processFolderListing();
 }
 
+void SubscriptionDialogBase::slotButtonClicked( int button )
+{
+  if ( button == KDialog::Ok ) {
+    if ( doSave() ) {
+      accept();
+    }
+  }
+  else {
+    KDialog::slotButtonClicked( button );
+  }
+}
+
 void SubscriptionDialogBase::moveChildrenToNewParent( GroupItem *oldItem, GroupItem *item  )
 {
   if ( !oldItem || !item ) return;
@@ -118,7 +127,7 @@
     // the parent is not available and it's no root-item
     // this happens when the folders do not arrive in hierarchical order
     // so we create each parent in advance
-    QStringList folders = parentPath.split(mDelimiter);
+    QStringList folders = parentPath.split( mDelimiter, QString::SkipEmptyParts );
     uint i = 0;
     for ( QStringList::Iterator it = folders.begin(); it != folders.end(); ++it )
     {
@@ -149,10 +158,12 @@
       // as these items are "dummies" we create them non-checkable
       if (!item)
       {
-        if (parent)
+        if (parent) {
           item = new GroupItem(parent, info, this, false);
-        else
+        }
+        else {
           item = new GroupItem(folderTree(), info, this, false);
+        }
         mItemDict.insert(info.path, item);
       }
 
@@ -170,10 +181,12 @@
   // only checkable when the folder is selectable
   bool checkable = ( mFolderMimeTypes[i] == "inode/directory" ) ? false : true;
   // create a new item
-  if (parent)
+  if ( parent ) {
     item = new GroupItem(parent, info, this, checkable);
-  else
+  }
+  else {
     item = new GroupItem(folderTree(), info, this, checkable);
+  }
 
   if (oldItem) // remove old item
     mItemDict.remove(info.path);
@@ -215,12 +228,6 @@
 }
 
 //------------------------------------------------------------------------------
-void SubscriptionDialogBase::slotSave()
-{
-  doSave();
-}
-
-//------------------------------------------------------------------------------
 void SubscriptionDialogBase::slotLoadFolders()
 {
   ImapAccountBase* ai = static_cast<ImapAccountBase*>(account());
@@ -311,7 +318,6 @@
 /* virtual */
 SubscriptionDialog::~SubscriptionDialog()
 {
-
 }
 
 /* virtual */
@@ -354,13 +360,13 @@
     slotLoadFolders();
 }
 
-void SubscriptionDialogBase::checkIfSubscriptionsEnabled()
+bool SubscriptionDialogBase::checkIfSubscriptionsEnabled()
 {
   KMail::ImapAccountBase *account = static_cast<KMail::ImapAccountBase*>(mAcct);
   if( !account )
-    return;
+    return true;
   if( account->onlySubscribedFolders() )
-    return;
+    return true;
   kDebug(5006) <<"Not subscribed!!!";
   int result = KMessageBox::questionYesNoCancel( this,
     i18nc("@info", "Currently subscriptions are not used for server <resource>%1</resource>.<nl/>"
@@ -373,9 +379,11 @@
     case KMessageBox::No:
         break;
     case KMessageBox::Cancel:
-        reject();
+        return false;
         break;
   }
+
+  return true;
 }
 
 void SubscriptionDialogBase::show()
@@ -392,9 +400,10 @@
 }
 
 /* virtual */
-void SubscriptionDialog::doSave()
+bool SubscriptionDialog::doSave()
 {
-  checkIfSubscriptionsEnabled();
+  if ( !checkIfSubscriptionsEnabled() )
+    return false;
 
   // subscribe
   Q3ListViewItemIterator it(subView);
@@ -416,6 +425,7 @@
     KMail::ImapAccountBase *a = static_cast<KMail::ImapAccountBase*>(mAcct);
     a->setOnlySubscribedFolders(true);
   }
+  return true;
 }
 
 void SubscriptionDialog::processItems()
Index: kmail/cachedimapjob.cpp
===================================================================
--- kmail/cachedimapjob.cpp	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ kmail/cachedimapjob.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -462,9 +462,10 @@
 
   if ( data.contains("UID") && mMsg )
   {
-    int uid = (data.right(data.length()-4)).toInt();
-    kDebug( 5006 ) <<"Server told us uid is:" << uid;
+    ulong uid = (data.right(data.length()-4)).toLong();
+    kDebug() << "Server told us uid is:" << uid;
     mMsg->setUID( uid );
+    Q_ASSERT( mMsg->UID() == uid );
   }
 }
 
Index: kmail/kmreaderwin.cpp
===================================================================
--- kmail/kmreaderwin.cpp	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ kmail/kmreaderwin.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -1140,12 +1140,33 @@
 #endif
   }
 
+  // We do a queued connection below, and for that we need to register the meta types of the
+  // parameters.
+  //
+  // Why do we do a queued connection instead of a direct one? slotUrlOpen() handles those clicks,
+  // and can end up in the click handler for accepting invitations. That handler can pop up a dialog
+  // asking the user for a comment on the invitation reply. This dialog is started with exec(), i.e.
+  // executes a sub-eventloop. This sub-eventloop then eventually re-enters the KHTML event handler,
+  // which then thinks we started a drag, and therefore adds a silly drag object to the cursor, with
+  // urls like x-kmail-whatever/43/8/accept, and we don't want that drag object.
+  //
+  // Therefore, use queued connections to avoid the reentry of the KHTML event loop, so we don't
+  // get the drag object.
+  static bool metaTypesRegistered = false;
+  if ( !metaTypesRegistered ) {
+    qRegisterMetaType<KParts::OpenUrlArguments>( "KParts::OpenUrlArguments" );
+    qRegisterMetaType<KParts::BrowserArguments>( "KParts::BrowserArguments" );
+    metaTypesRegistered = true;
+  }
+
   connect(mViewer->browserExtension(),
           SIGNAL(openUrlRequest(const KUrl &, const KParts::OpenUrlArguments &, const KParts::BrowserArguments &)),this,
-          SLOT(slotUrlOpen(const KUrl &, const KParts::OpenUrlArguments &, const KParts::BrowserArguments &)));
+          SLOT(slotUrlOpen(const KUrl &, const KParts::OpenUrlArguments &, const KParts::BrowserArguments &)),
+          Qt::QueuedConnection);
   connect(mViewer->browserExtension(),
           SIGNAL(createNewWindow(const KUrl &, const KParts::OpenUrlArguments &, const KParts::BrowserArguments &)),this,
-          SLOT(slotUrlOpen(const KUrl &, const KParts::OpenUrlArguments &, const KParts::BrowserArguments &)));
+          SLOT(slotUrlOpen(const KUrl &, const KParts::OpenUrlArguments &, const KParts::BrowserArguments &)),
+          Qt::QueuedConnection);
   connect(mViewer,SIGNAL(onURL(const QString &)),this,
           SLOT(slotUrlOn(const QString &)));
   connect(mViewer,SIGNAL(popupMenu(const QString &, const QPoint &)),
Index: kmail/kmmessage.cpp
===================================================================
--- kmail/kmmessage.cpp	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ kmail/kmmessage.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -2161,14 +2161,14 @@
 
 //-----------------------------------------------------------------------------
 ulong KMMessage::UID() const {
-  return headerField( "X-UID" ).toULong();
+  return headerField( "X-UID", NoEncoding ).toULong();
 }
 
 
 //-----------------------------------------------------------------------------
 void KMMessage::setUID(ulong uid)
 {
-  setHeaderField("X-UID", QByteArray::number((qlonglong)uid));
+  setHeaderField( "X-UID", QByteArray::number((qlonglong)uid), Unstructured, false, NoEncoding );
   mDirty = true;
 }
 
@@ -2223,7 +2223,7 @@
   return headerFields;
 }
 
-QString KMMessage::headerField(const QByteArray& aName) const
+QString KMMessage::headerField( const QByteArray& aName, EncodingMode encodingMode ) const
 {
   if ( aName.isEmpty() ) {
     return QString();
@@ -2233,8 +2233,13 @@
     return QString();
   }
 
-  return decodeRFC2047String( mMsg->Headers().FieldBody( aName.data() ).AsString().c_str(),
-                              charset() );
+  const char *fieldValue = mMsg->Headers().FieldBody( aName.data() ).AsString().c_str();
+  if ( encodingMode == NoEncoding ) {
+    return QString( fieldValue );
+  }
+  else {
+    return decodeRFC2047String( fieldValue, charset() );
+  }
 }
 
 QStringList KMMessage::headerFields( const QByteArray& field ) const
@@ -2275,7 +2280,7 @@
 
 //-----------------------------------------------------------------------------
 void KMMessage::setHeaderField( const QByteArray& aName, const QString& bValue,
-                                HeaderFieldType type, bool prepend )
+                                HeaderFieldType type, bool prepend, EncodingMode encodingMode )
 {
 #if 0
   if ( type != Unstructured )
@@ -2297,10 +2302,16 @@
     if ( type != Unstructured )
       kDebug(5006) <<"value: \"" << value <<"\"";
 #endif
-    QByteArray encoding = autoDetectCharset( charset(), s->prefCharsets, value );
-    if (encoding.isEmpty())
-       encoding = "utf-8";
-    aValue = encodeRFC2047String( value, encoding );
+    if ( encodingMode == NoEncoding ) {
+      aValue = value.toAscii();
+      Q_ASSERT( QString::fromAscii( aValue ) == bValue );
+    }
+    else {
+      QByteArray encoding = autoDetectCharset( charset(), s->prefCharsets, value );
+      if (encoding.isEmpty())
+        encoding = "utf-8";
+      aValue = encodeRFC2047String( value, encoding );
+    }
 #if 0
     if ( type != Unstructured )
       kDebug(5006) <<"aValue: \"" << aValue <<"\"";
Index: kmail/messageactions.cpp
===================================================================
--- kmail/messageactions.cpp	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ kmail/messageactions.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -170,8 +170,7 @@
 {
   bool singleMsg = (mCurrentMessage != 0);
   if ( mCurrentMessage && mCurrentMessage->parent() ) {
-    if ( mCurrentMessage->parent()->isSent() ||
-         mCurrentMessage->parent()->isTemplates())
+    if ( mCurrentMessage->parent()->isTemplates() )
       singleMsg = false;
   }
   const bool multiVisible = mVisibleSernums.count() > 0 || mCurrentMessage;
Index: kmail/folderview.h
===================================================================
--- kmail/folderview.h	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ kmail/folderview.h	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -737,9 +737,17 @@
   /**
    * Reimplemented in order to draw our custom drop indications
    */
-  virtual void paintEvent( QPaintEvent *e);
+  virtual void paintEvent( QPaintEvent *e );
 
   /**
+   * Reimplemented, to handle column resizing.
+   * If the folder view was enlarged, we give the label column the space.
+   * If it was shrunk, we take the space from the label column and other columns
+   * if it gets really small.
+   */
+  virtual void resizeEvent( QResizeEvent *event );
+
+  /**
    * Internal helper for drop our custom drop indicator
    */
   void setDropIndicatorData(
@@ -782,8 +790,30 @@
    */
   UpdateCountsResult updateCountsForChildren( QTreeWidgetItem *it, const QTime &tStart );
 
+  /**
+   * @return the total size of all columns combined
+   */
+  int totalColumnsSize() const;
+
 protected Q_SLOTS:
+
   /**
+   * Resets all column sizes to some default values.
+   * The size, unread and total column get 70 pixels, label column the rest
+   */
+  void setDefaultColumnSizes();
+
+  /**
+   * Slot which handles the resize of a column.
+   * If one column gets bigger, it would mean that the total width of all columns would be bigger
+   * than the complete view, meaning we get a scrollbar.
+   * To compensate for this, the next section is shrunk.
+   *
+   * Same case for the opposite, when a column gets smaller.
+   */
+  void handleSectionResize( int logicalIndex, int oldSize, int newSize );
+
+  /**
    * Connected to our own signal columnVisibilityChanged()
    * Used to trigger columnsChanged() which is handled by KMMainWindow
    * and to eventually trigger a reload.
@@ -928,6 +958,10 @@
 
 private: // member variables
 
+  /// Ignore header section resizes and don't act on them. This should always be set before
+  /// resizing a section programmatically.
+  bool mIgnoreResizes;
+
   QTimer * mUpdateCountsTimer;                      ///< Timer used to trigger a delayed updateCounts()
   QList< QPointer< KMFolder > > mFolderClipboard;   ///< Local clipboard of folders
   FolderClipboardMode mFolderClipboardMode;         ///< Are we cutting or just copying folders ?
Index: kmail/kmcommands.cpp
===================================================================
--- kmail/kmcommands.cpp	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ kmail/kmcommands.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -1231,11 +1231,15 @@
   if (msgList.count() >= 2) {
     // ask if they want a mime digest forward
 
-    if (KMessageBox::questionYesNo( parentWidget(),
-                                    i18n("Do you want to forward the selected messages as "
-                                         "attachments in one message (as a MIME digest) or as "
-                                         "individual messages?"), QString(), KGuiItem(i18n("Send As Digest")), KGuiItem(i18n("Send Individually")) )
-        == KMessageBox::Yes) {
+    int answer = KMessageBox::questionYesNoCancel(
+                   parentWidget(),
+                   i18n("Do you want to forward the selected messages as "
+                        "attachments in one message (as a MIME digest) or as "
+                        "individual messages?"), QString(),
+                   KGuiItem(i18n("Send As Digest")),
+                   KGuiItem(i18n("Send Individually")) );
+
+    if ( answer == KMessageBox::Yes ) {
       uint id = 0;
       KMMessage *fwdMsg = new KMMessage;
       KMMessagePart *msgPart = new KMMessagePart;
@@ -1300,7 +1304,7 @@
       win->addAttach(msgPart);
       win->show();
       return OK;
-    } else {            // NO MIME DIGEST, Multiple forward
+    } else if ( answer == KMessageBox::No ) {// NO MIME DIGEST, Multiple forward
       uint id = 0;
       QList<KMMessage*> linklist;
       QList<KMMessage*>::const_iterator it;
@@ -1331,6 +1335,9 @@
       win->setCharset("");
       win->show();
       return OK;
+    } else {
+      // user cancelled
+      return OK;
     }
   }
 
Index: kmail/messagecomposer.cpp
===================================================================
--- kmail/messagecomposer.cpp	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ kmail/messagecomposer.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -548,7 +548,7 @@
 
   mEncryptWithChiasmus = mComposeWin->mEncryptWithChiasmus;
 
-  mIsRichText = ( mComposeWin->mEditor->textMode() == KMeditor::Rich );
+  mIsRichText = mComposeWin->mEditor->isFormattingUsed();
   mIdentityUid = mComposeWin->identityUid();
   if ( !breakLinesAndApplyCodec() ) {
     mRc = false;
Index: kmail/kmfoldercachedimap.cpp
===================================================================
--- kmail/kmfoldercachedimap.cpp	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ kmail/kmfoldercachedimap.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -144,7 +144,7 @@
 
   mIndexButton = new QRadioButton( page );
   mIndexButton->setText( i18n( "Rebuild &index" ) );
-  mButtonGroup->addButton( mIndexButton );
+  mButtonGroup->addButton( mIndexButton, 1 );
   topLayout->addWidget( mIndexButton );
 
   KHBox *hbox = new KHBox( page );
@@ -160,7 +160,7 @@
 
   mCacheButton = new QRadioButton( page );
   mCacheButton->setText( i18n( "Refresh &Cache" ) );
-  mButtonGroup->addButton( mCacheButton );
+  mButtonGroup->addButton( mCacheButton, 2 );
   topLayout->addWidget( mCacheButton );
 
   connect ( mIndexButton, SIGNAL( toggled( bool ) ),
@@ -312,7 +312,7 @@
   mStatusChangedLocally = group.readEntry( "StatusChangedLocally", false );
   QStringList uidsChanged = group.readEntry( "UIDStatusChangedLocally", QStringList() );
   foreach( const QString &uid, uidsChanged ) {
-    mUIDsOfLocallyChangedStatuses.append( uid.toUInt() );
+    mUIDsOfLocallyChangedStatuses.insert( uid.toUInt() );
   }
   mAnnotationFolderTypeChanged = group.readEntry( "AnnotationFolderTypeChanged", false );
   mIncidencesForChanged = group.readEntry( "IncidencesForChanged", false );
@@ -1444,7 +1444,7 @@
         // Either not a valid message or not one that is on the server yet
         continue;
       }
-      if ( mUIDsOfLocallyChangedStatuses.indexOf( msg->UID() ) < 0 && !mStatusChangedLocally ) {
+      if ( !mUIDsOfLocallyChangedStatuses.contains( msg->UID() ) && !mStatusChangedLocally ) {
         // This message has not had its status changed locally
         continue;
       }
@@ -1491,7 +1491,7 @@
         // Either not a valid message or not one that is on the server yet
         continue;
 
-      if ( mUIDsOfLocallyChangedStatuses.indexOf( msg->UID() ) < 0 && !mStatusChangedLocally ) {
+      if ( !mUIDsOfLocallyChangedStatuses.contains( msg->UID() ) && !mStatusChangedLocally ) {
         // This message has not had its status changed locally
         continue;
       }
@@ -1556,7 +1556,7 @@
   const KMMsgBase *msg = getMsgBase( idx );
   Q_ASSERT( msg );
   if ( msg )
-    mUIDsOfLocallyChangedStatuses.append( msg->UID() );
+    mUIDsOfLocallyChangedStatuses.insert( msg->UID() );
 }
 
 void KMFolderCachedImap::setStatus( QList<int> &ids, const MessageStatus &status, bool toggle )
@@ -1566,7 +1566,7 @@
     const KMMsgBase *msg = getMsgBase( id );
     Q_ASSERT( msg );
     if ( msg )
-      mUIDsOfLocallyChangedStatuses.append( msg->UID() );
+      mUIDsOfLocallyChangedStatuses.insert( msg->UID() );
   }
 }
 
Index: kmail/folderjob.cpp
===================================================================
--- kmail/folderjob.cpp	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ kmail/folderjob.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -47,8 +47,8 @@
     mPassiveDestructor( false ), mStarted( false )
 {
   if ( msg ) {
-    mMsgList.append(msg);
-    mSets = msg->headerField("X-UID");
+    mMsgList.append( msg );
+    mSets = msg->headerField( "X-UID", KMMessage::NoEncoding );
   }
   init();
 }
Index: kmail/kmkernel.cpp
===================================================================
--- kmail/kmkernel.cpp	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ kmail/kmkernel.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -400,11 +400,11 @@
   // tentatively decode to, cc and bcc because invokeMailer calls us with
   // RFC 2047 encoded addresses in order to protect non-ASCII email addresses
   if (!to.isEmpty())
-    msg->setTo( KMMsgBase::decodeRFC2047String( to.toLatin1() ) );
+    msg->setTo( KMMsgBase::decodeRFC2047String( to.toLocal8Bit() ) );
   if (!cc.isEmpty())
-    msg->setCc( KMMsgBase::decodeRFC2047String( cc.toLatin1() ) );
+    msg->setCc( KMMsgBase::decodeRFC2047String( cc.toLocal8Bit() ) );
   if (!bcc.isEmpty())
-    msg->setBcc( KMMsgBase::decodeRFC2047String( bcc.toLatin1() ) );
+    msg->setBcc( KMMsgBase::decodeRFC2047String( bcc.toLocal8Bit() ) );
   if (!subject.isEmpty()) msg->setSubject(subject);
 
   KUrl messageUrl = KUrl( messageFile );
@@ -1906,7 +1906,7 @@
   if( !mConfigureDialog ) {
     mConfigureDialog = new ConfigureDialog( 0, false );
     mConfigureDialog->setObjectName( "configure" );
-    connect( mConfigureDialog, SIGNAL( configCommitted() ),
+    connect( mConfigureDialog, SIGNAL( configChanged() ),
              this, SLOT( slotConfigChanged() ) );
   }
 
@@ -2259,7 +2259,7 @@
   if ( systray->mode() == GlobalSettings::EnumSystemTrayPolicy::ShowAlways ) {
     systray->hideKMail();
     return false;
-  } else if ( systray->mode() == GlobalSettings::EnumSystemTrayPolicy::ShowOnUnread ) {
+  } else if ( ( systray->mode() == GlobalSettings::EnumSystemTrayPolicy::ShowOnUnread ) && ( systray->hasUnreadMail() )) {
     systray->show();
     systray->hideKMail();
     return false;
Index: kmail/callback.h
===================================================================
--- kmail/callback.h	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ kmail/callback.h	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -80,6 +80,7 @@
     bool askForComment( KCal::Attendee::PartStat status ) const;
     bool deleteInvitationAfterReply() const;
     void deleteInvitation() const;
+    bool exchangeCompatibleInvitations() const;
 
     /**
       Closes the main window showing this message, if it's a secondary window.
Index: kmail/kmfoldercachedimap.h
===================================================================
--- kmail/kmfoldercachedimap.h	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ kmail/kmfoldercachedimap.h	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -45,6 +45,7 @@
 
 #include <QDialog>
 #include <QList>
+#include <QSet>
 #include <QTimerEvent>
 
 using KMail::FolderJob;
@@ -635,7 +636,7 @@
     * uploaded to the server, overwriting the server's notion of the status
     * of the mails in this folder.
     */
-    QList<ulong> mUIDsOfLocallyChangedStatuses;
+    QSet<ulong> mUIDsOfLocallyChangedStatuses;
 
     /**
      * Same as above, but uploads the flags of all mails, even if not all changed.
Index: kmail/kmmainwidget.cpp
===================================================================
--- kmail/kmmainwidget.cpp	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ kmail/kmmainwidget.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -706,7 +706,7 @@
            SLOT( slotMessageStatusChangeRequest( KMMsgBase *, const KPIM::MessageStatus &, const KPIM::MessageStatus &  ) ) );
   {
     KAction *action = new KAction( i18n("Set Focus to Quick Search"), this );
-    action->setShortcut( QKeySequence( Qt::Key_Alt + Qt::Key_Q ) );
+    action->setShortcut( QKeySequence( Qt::ALT + Qt::Key_Q ) );
     actionCollection()->addAction( "focus_to_quickseach", action );
     connect( action, SIGNAL( triggered( bool ) ),
              SLOT( slotFocusQuickSearch() ) );
@@ -1485,7 +1485,7 @@
       imap->getAndCheckFolder();
     } else if ( mFolder->folderType() == KMFolderTypeCachedImap ) {
       KMFolderCachedImap* f = static_cast<KMFolderCachedImap*>( mFolder->storage() );
-      f->account()->processNewMailSingleFolder( mFolder );
+      f->account()->processNewMailInFolder( mFolder );
     }
   }
 }
@@ -1913,7 +1913,7 @@
 
   Q_ASSERT( set );
 
-  if ( command->result() != KMCommand::OK )
+  if ( command->result() == KMCommand::OK )
   {
     BroadcastStatus::instance()->setStatusMsg( i18n( "Messages copied successfully." ) );
   } else {
@@ -2508,6 +2508,7 @@
 {
   kmkernel->undoStack()->undo();
   updateMessageActions();
+  updateFolderMenu();
 }
 
 
@@ -3449,10 +3450,7 @@
     if ( mFolder->isTemplates() ) {
       menu->addAction( mUseAction );
     } else {
-
-      if ( !mFolder->isSent() ) {
-        menu->addAction( mMsgActions->replyMenu() );
-      }
+      menu->addAction( mMsgActions->replyMenu() );
       menu->addAction( mForwardActionMenu );
     }
     menu->addAction(editAction());
Index: kmail/kmfolderdialog.h
===================================================================
--- kmail/kmfolderdialog.h	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ kmail/kmfolderdialog.h	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -152,6 +152,7 @@
 
   KMFolderDialog* mDlg;
   bool mIsLocalSystemFolder;
+  bool mIsResourceFolder;
 };
 
 /**
Index: kmail/kmfolderdialog.cpp
===================================================================
--- kmail/kmfolderdialog.cpp	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ kmail/kmfolderdialog.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -268,14 +268,16 @@
   : FolderDialogTab( parent, name ), mDlg( dlg )
 {
   mIsLocalSystemFolder = mDlg->folder()->isSystemFolder();
+  mIsResourceFolder = kmkernel->iCalIface().isStandardResourceFolder( mDlg->folder() );
+
   QLabel *label;
 
   QVBoxLayout *topLayout = new QVBoxLayout( this );
   topLayout->setSpacing( KDialog::spacingHint() );
   topLayout->setMargin( 0 );
 
-  // Musn't be able to edit details for a system folder.
-  if ( !mIsLocalSystemFolder ) {
+  // Musn't be able to edit details for a non-resource, system folder.
+  if ( !mIsLocalSystemFolder || mIsResourceFolder ) {
 
     QHBoxLayout *hl = new QHBoxLayout();
     topLayout->addItem( hl );
@@ -286,7 +288,7 @@
 
     mNameEdit = new KLineEdit( this );
     if( !mDlg->folder() )
-            mNameEdit->setFocus();
+      mNameEdit->setFocus();
     mNameEdit->setText( mDlg->folder() ? mDlg->folder()->label() : i18n("unnamed") );
     if (!aName.isEmpty())
             mNameEdit->setText(aName);
@@ -469,7 +471,8 @@
   else if (whoField == "To") mShowSenderReceiverComboBox->setCurrentIndex(2);
 
   // folder contents
-  if ( !mIsLocalSystemFolder && kmkernel->iCalIface().isEnabled() ) {
+  if ( ( !mIsLocalSystemFolder || mIsResourceFolder ) &&
+       kmkernel->iCalIface().isEnabled() ) {
     // Only do make this settable, if the IMAP resource is enabled
     // and it's not the personal folders (those must not be changed)
     ++row;
@@ -489,7 +492,7 @@
       mContentsComboBox->setCurrentIndex( mDlg->folder()->storage()->contentsType() );
     connect ( mContentsComboBox, SIGNAL ( activated( int ) ),
               this, SLOT( slotFolderContentsSelectionChanged( int ) ) );
-    if ( mDlg->folder()->isReadOnly() )
+    if ( mDlg->folder()->isReadOnly() || mIsResourceFolder )
       mContentsComboBox->setEnabled( false );
   } else {
     mContentsComboBox = 0;
Index: kmail/imapaccountbase.h
===================================================================
--- kmail/imapaccountbase.h	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ kmail/imapaccountbase.h	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -256,9 +256,10 @@
     virtual void cancelMailCheck();
 
     /**
-     * Init a new-mail-check for a single folder
+     * Init a new-mail-check for a single folder, and optionally its subfolders.
      */
-    void processNewMailSingleFolder(KMFolder* folder);
+    enum FolderListType { Single, Recursive };
+    void processNewMailInFolder( KMFolder* folder, FolderListType type = Single );
 
     /**
      * Return true if we are processing a mailcheck for a single folder
Index: kmail/kmfilteraction.cpp
===================================================================
--- kmail/kmfilteraction.cpp	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ kmail/kmfilteraction.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -559,9 +559,9 @@
        unfortunate, as we need to removed the original from the folder
        using that, and look it up in the message. When the (new) message
        is uploaded, the header is stripped anyhow. */
-      QString uid = aMsg->headerField("X-UID");
+      QString uid = aMsg->headerField( "X-UID", KMMessage::NoEncoding );
       aMsg->fromString( msgText );
-      aMsg->setHeaderField("X-UID",uid);
+      aMsg->setHeaderField( "X-UID", uid, KMMessage::Unstructured, false, KMMessage::NoEncoding );
     }
     else {
       qDeleteAll( atmList );
@@ -1482,7 +1482,7 @@
   KMMessage *fwdMsg = msg->createForward();
   fwdMsg->setTo( mParameter );
 
-  if ( !kmkernel->msgSender()->send( fwdMsg, KMail::MessageSender::SendLater ) ) {
+  if ( !kmkernel->msgSender()->send( fwdMsg, KMail::MessageSender::SendDefault ) ) {
     kWarning() << "KMFilterAction: could not forward message (sending failed)";
     return ErrorButGoOn; // error: couldn't send
   }
@@ -1627,10 +1627,10 @@
         // unfortunate, as we need to removed the original from the folder
         // using that, and look it up in the message. When the (new) message
         // is uploaded, the header is stripped anyhow. */
-        const QString uid = mMsg->headerField( "X-UID" );
+        const QString uid = mMsg->headerField( "X-UID", KMMessage::NoEncoding );
         mMsg->fromString( ba );
         if ( !uid.isEmpty() )
-          mMsg->setHeaderField( "X-UID", uid );
+          mMsg->setHeaderField( "X-UID", uid, KMMessage::Unstructured, false, KMMessage::NoEncoding );
 
         if ( !origSerNum.isEmpty() )
           mMsg->setHeaderField( "X-KMail-Filtered", origSerNum );
Index: kmail/kmcomposewin.cpp
===================================================================
--- kmail/kmcomposewin.cpp	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ kmail/kmcomposewin.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -3529,14 +3529,14 @@
   else
     mMsg->setHeaderField( "X-KMail-QuotePrefix", mEditor->quotePrefixName() );
 
-  if ( mEditor->textMode() == KMeditor::Rich ) {
+  if ( mEditor->isFormattingUsed() ) {
     kDebug(5006) << "Html mode";
     mMsg->setHeaderField( "X-KMail-Markup", "true" );
   } else {
     mMsg->removeHeaderField( "X-KMail-Markup" );
     kDebug(5006) << "Plain text";
   }
-  if ( mEditor->textMode() == KMeditor::Rich &&
+  if ( mEditor->isFormattingUsed() &&
        inlineSigningEncryptionSelected() ) {
     QString keepBtnText = mEncryptAction->isChecked() ?
       mSignAction->isChecked() ? i18n( "&Keep markup, do not sign/encrypt" )
@@ -3880,11 +3880,9 @@
 void KMComposeWin::slotAutoSpellCheckingToggled( bool on )
 {
   mAutoSpellCheckingAction->setChecked( on );
-  if ( on == mEditor->checkSpellingEnabled() )
-    return;
+  if ( on != mEditor->checkSpellingEnabled() )
+    mEditor->setCheckSpellingEnabled( on );
 
-  mEditor->setCheckSpellingEnabled( on );
-
   QString temp;
   if ( on ) {
     temp = i18n( "Spellcheck: on" );
Index: kmail/localsubscriptiondialog.cpp
===================================================================
--- kmail/localsubscriptiondialog.cpp	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ kmail/localsubscriptiondialog.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -101,7 +101,7 @@
 }
 
 /*virtual*/
-void LocalSubscriptionDialog::doSave()
+bool LocalSubscriptionDialog::doSave()
 {
   bool somethingHappened = false;
   // subscribe
@@ -133,6 +133,8 @@
   if ( somethingHappened ) {
     kmkernel->acctMgr()->singleCheckMail( mAccount, true);
   }
+
+  return true;
 }
 
 void LocalSubscriptionDialog::loadingComplete()
Index: kmail/callback.cpp
===================================================================
--- kmail/callback.cpp	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ kmail/callback.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -133,6 +133,7 @@
     cWin->addAttach( msgPart );
   }
 
+  cWin->forceDisableHtml();
   if ( GlobalSettings::self()->automaticSending() ) {
     cWin->setAttribute( Qt::WA_DeleteOnClose );
     cWin->slotSendNow();
@@ -237,6 +238,11 @@
   ( new KMDeleteMsgCommand( sernum ) )->start();
 }
 
+bool Callback::exchangeCompatibleInvitations() const
+{
+  return GlobalSettings::self()->exchangeCompatibleInvitations();
+}
+
 QString Callback::sender() const
 {
   return mMsg->from();
Index: kmail/configuredialog.cpp
===================================================================
--- kmail/configuredialog.cpp	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ kmail/configuredialog.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -287,10 +287,12 @@
 
 void ConfigureDialog::slotApply() {
   GlobalSettings::self()->writeConfig();
+  emit configChanged();
 }
 
 void ConfigureDialog::slotOk() {
   GlobalSettings::self()->writeConfig();
+  emit configChanged();
 }
 
 void ConfigureDialog::slotUser2() {
Index: kmail/kmfolderimap.cpp
===================================================================
--- kmail/kmfolderimap.cpp	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ kmail/kmfolderimap.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -1219,7 +1219,7 @@
   }
 
   if ( account() ) {
-    account()->processNewMailSingleFolder( folder() );
+    account()->processNewMailInFolder( folder() );
   }
   if ( force ) {
     // force an update
Index: kmail/kmail_config_appearance.desktop
===================================================================
--- kmail/kmail_config_appearance.desktop	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ kmail/kmail_config_appearance.desktop	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -44,6 +44,7 @@
 Name[ko]=모양
 Name[lt]=Išvaizda
 Name[lv]=Izskats
+Name[mai]=प्रकटन
 Name[mk]=Изглед
 Name[ms]=Rupa
 Name[nb]=Utseende
Index: kmail/kmfoldermbox.cpp
===================================================================
--- kmail/kmfoldermbox.cpp	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ kmail/kmfoldermbox.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -125,7 +125,7 @@
   assert( !folder()->name().isEmpty() );
 
   mFilesLocked = false;
-  mStream = KDE_fopen( QFile::encodeName( location() ), "r+" ); // messages file
+  mStream = KDE_fopen( QFile::encodeName( location() ), "rb+" ); // messages file
   if ( !mStream ) {
     KMessageBox::sorry( 0, i18n( "Cannot open file \"%1\":\n%2",
                                  location(), strerror( errno ) ) );
@@ -1068,6 +1068,7 @@
     fread( endStr, 1, 2, mStream ); // ensure separating empty line
     if ( KDE_ftell( mStream ) > 0 && endStr[0]!='\n' ) {
       ++growth;
+      KDE_fseek( mStream, 0, SEEK_END ); // required at least on Windows, Solaris, etc.
       if ( endStr[1]!='\n' ) {
         //printf ("****endStr[1]=%c\n", endStr[1]);
         fwrite( "\n\n", 1, 2, mStream );
Index: kmail/KMail.desktop
===================================================================
--- kmail/KMail.desktop	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ kmail/KMail.desktop	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -46,6 +46,7 @@
 GenericName[ko]=전자 우편 클라이언트
 GenericName[lt]=Pašto klientas
 GenericName[lv]=Pasta klients
+GenericName[mai]=डाकिया
 GenericName[mk]=Клиент за електронска пошта
 GenericName[ms]=Pelanggan Mel
 GenericName[nb]=E-postklient
@@ -71,8 +72,8 @@
 GenericName[uk]=Поштовий клієнт
 GenericName[uz]=Xat-xabar klienti
 GenericName[uz@cyrillic]=Хат-хабар клиенти
+GenericName[xh]=Umxhasi Weposi
 GenericName[x-test]=xxMail Clientxx
-GenericName[xh]=Umxhasi Weposi
 GenericName[zh_CN]=邮件客户程序
 GenericName[zh_TW]=收發信軟體
 Terminal=false
Index: kmail/folderview.cpp
===================================================================
--- kmail/folderview.cpp	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ kmail/folderview.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -156,6 +156,7 @@
 
 FolderView::FolderView( KMMainWidget *mainWidget, FolderViewManager *manager, QWidget *parent, const QString &configPrefix, const char *name )
  : KPIM::FolderTreeWidget( parent, name ),
+   mIgnoreResizes( false ),
    mMainWidget( mainWidget ),
    mManager( manager ),
    mConfigPrefix( configPrefix ),
@@ -183,8 +184,8 @@
 
   setDropIndicatorShown( false );
 
-  header()->setMinimumSectionSize( 30 ); // empiric :)
-  header()->setDefaultSectionSize( 30 ); // empiric :)
+  header()->setMinimumSectionSize( 20 ); // empiric :)
+  header()->setStretchLastSection( false );
 
   setIconSize( QSize( 22, 22 ) );
 
@@ -195,14 +196,17 @@
                          "Total" ) );
   addDataSizeColumn( i18nc( "@title:column Size of the folder.", "Size" ) );
 
-  header()->setResizeMode( LabelColumn, QHeaderView::Stretch );
-  header()->setResizeMode( UnreadColumn, QHeaderView::ResizeToContents );
-  header()->setResizeMode( TotalColumn, QHeaderView::ResizeToContents );
-  header()->setResizeMode( DataSizeColumn, QHeaderView::ResizeToContents );
+  header()->setResizeMode( LabelColumn, QHeaderView::Interactive );
+  header()->setResizeMode( UnreadColumn, QHeaderView::Interactive);
+  header()->setResizeMode( TotalColumn, QHeaderView::Interactive );
+  header()->setResizeMode( DataSizeColumn, QHeaderView::Interactive );
 
   connect( this, SIGNAL( columnVisibilityChanged( int ) ),
            SLOT( slotColumnVisibilityChanged( int ) ) );
 
+  connect( header(), SIGNAL( sectionResized( int, int, int ) ),
+           this, SLOT( handleSectionResize( int, int, int ) ) );
+
   // Connect local folder manager
   connect( kmkernel->folderMgr(), SIGNAL( changed() ),
            SLOT( slotReload() ) );
@@ -263,6 +267,7 @@
   else
     setFont( KGlobalSettings::generalFont() );
 
+  mIgnoreResizes = true;
   if ( !restoreLayout( KMKernel::config(), "Geometry", mConfigPrefix + "Layout" ) )
   {
     // hide all the columns but the first (the default)
@@ -271,7 +276,11 @@
     setColumnHidden( TotalColumn, true );
     // default sort order is ascending
     header()->setSortIndicator( LabelColumn, Qt::AscendingOrder );
+
+    // Use a singleshot, as there is no layout here yet, and therefore no correct sizes
+    QTimer::singleShot( 0, this, SLOT( setDefaultColumnSizes() ) );
   }
+  mIgnoreResizes = false;
 
   KConfigGroup myGroup( KMKernel::config(), mConfigPrefix );
   int iIconSize = myGroup.readEntry( "IconSize", iconSize().width() );
@@ -332,7 +341,6 @@
       KConfigGroup conf( KMKernel::config(), configGroupName );
 
       conf.writeEntry( mConfigPrefix + "ItemIsExpanded", fvi->isExpanded() );
-      conf.writeEntry( mConfigPrefix + "ItemIsHidden", fvi->isHidden() );
       conf.writeEntry( mConfigPrefix + "ItemIsSelected", fvi->isSelected() );
       conf.writeEntry( mConfigPrefix + "ItemDnDSortingKey", fvi->dndSortingKey() );
     }
@@ -375,7 +383,6 @@
     KConfigGroup conf( KMKernel::config(), mit.key() );
 
     fvi->setExpanded( conf.readEntry( mConfigPrefix + "ItemIsExpanded", false ) );
-    fvi->setHidden( conf.readEntry( mConfigPrefix + "ItemIsHidden", false ) );
     fvi->setSelected( conf.readEntry( mConfigPrefix + "ItemIsSelected", false ) );
     fvi->setDndSortingKey( conf.readEntry( mConfigPrefix + "ItemDnDSortingKey", -1 ) );
   }
@@ -435,27 +442,101 @@
   }
 }
 
-void FolderView::slotColumnVisibilityChanged( int logicalIndex )
+int FolderView::totalColumnsSize() const
 {
-  // This is called when one of our columns is hidden or shown either
-  // by the means of the header popup menu or programmatically.
+  int totalw = 0;
+  int count = header()->count();
 
-  bool nowVisible = !isColumnHidden( logicalIndex );
-
-  switch( logicalIndex )
+  // Compute the actual total width and find out the width of the label column
+  for ( int i = 0; i < count ; i++ )
   {
-    case LabelColumn:
-      // Ugh.. should never happen :/
-    break;
-    case UnreadColumn:
-    case TotalColumn:
-    case DataSizeColumn:
-      reload( nowVisible );
-    break;
+    if ( !isColumnHidden( i ) )
+    {
+      int size = header()->sectionSize( i );
+      totalw += size;
+    }
   }
+  return totalw;
+}
 
-  // OK: what follows is totally empiric.. but it looks nice ;)
+void FolderView::resizeEvent( QResizeEvent *event )
+{
+  KPIM::FolderTreeWidget::resizeEvent( event );
+  if ( !event->oldSize().isValid() )
+    return;
 
+  mIgnoreResizes = true;
+
+  int diff = event->oldSize().width() - event->size().width();
+  //kDebug() << "We got resized by" << -diff << "pixels, old size was" << event->oldSize().width()
+  //         << ", new size is" << event->size().width();
+  if ( !isColumnHidden( LabelColumn ) ) {
+
+    const int smallestSize = 20;
+    // If the label column can handle shrinking (or growing) without being < 20 pixels,
+    // resize it.
+    int newSize = header()->sectionSize( LabelColumn ) - diff;
+    //kDebug() << "The new size of the label column would be:" << newSize;
+    if ( newSize > smallestSize ) {
+      //kDebug() << "Ok, resizing the label column to that size";
+      header()->resizeSection( LabelColumn, newSize );
+    }
+    else {
+
+      // Ok, resizing the label column is not enough to make every column fit.
+      // So resize all other columns as well
+      for ( int i = 0; i < header()->count(); i++ ) {
+
+        if ( isColumnHidden( i ) )
+          continue;
+
+        // Each column has a minimum of 5 pixels.
+        int amountToResizeSection = diff;
+        if ( header()->sectionSize( i ) - diff < smallestSize )
+          amountToResizeSection = header()->sectionSize( i ) - smallestSize;
+        diff -= amountToResizeSection;
+        //kDebug() << "Going to resize section" << i << "by" << amountToResizeSection << "pixels";
+        header()->resizeSection( i, header()->sectionSize( i ) - amountToResizeSection );
+      }
+    }
+  }
+  mIgnoreResizes = false;
+}
+
+
+void FolderView::handleSectionResize( int logicalIndex, int oldSize, int newSize )
+{
+  if ( mIgnoreResizes ) {
+    return;
+  }
+
+  //kDebug() << "Section" << logicalIndex << "was resized from" << oldSize << "to" << newSize;
+
+  // Some column got bigger or smaller. That means the column after it needs to get a new size.
+  // In the loop below, find the column that should be resized, which is normally the next column
+  int diff = newSize - oldSize;
+
+  int columnToResize = LabelColumn;
+  for ( int i = logicalIndex + 1; i < header()->count(); i++ ) {
+    if ( !isColumnHidden( i ) ) {
+      if ( header()->sectionSize( i ) - diff > 5 ) {
+        columnToResize = i;
+        break;
+      }
+    }
+  }
+  mIgnoreResizes = true;
+  //kDebug() << "Section" << columnToResize << "is going to pay for this, it will be resized" << diff << "pixels";
+  header()->resizeSection( columnToResize, header()->sectionSize( columnToResize ) - diff );
+  mIgnoreResizes = false;
+}
+
+void FolderView::setDefaultColumnSizes()
+{
+    // OK: what follows is totally empiric.. but it looks nice ;)
+
+  //kDebug() << "Setting default column sizes!";
+
   // A shown column usually causes the horizontal scrollbar to appear.
   // The user is then forced to readjust the size of the column manually,
   // sometimes with non trivial operations (try it: #ifdef this code and see :D).
@@ -469,45 +550,50 @@
   // If you feel afraid when mantaining the following code, be aware
   // that nothing really relies on it...
 
-  if ( nowVisible && ( !isColumnHidden( LabelColumn ) ) )
+  mIgnoreResizes = true;
+  if ( !isColumnHidden( LabelColumn ) )
   {
-    // A new column appeared and the "LabelColumn" (the long one) is actually visible.
     int count = header()->count();
-    int totalw = 0;
-    int labelw = 180;
+    int vwidth = viewport()->width();
 
-    // Compute the actual total width and find out the width of the label column
-    for ( int i = 0; i < count ; i++ )
+    // all the sections but the "LabelColumn" get 70 pixels (yes, this is heuristic)
+    for ( int c = 0; c < count ; c++ )
     {
-      if ( !isColumnHidden( i ) )
+      if ( !isColumnHidden( c ) && ( c != LabelColumn ) )
       {
-        int size = header()->sectionSize( i );
-        totalw += size;
-        if ( i == LabelColumn )
-          labelw = size;
+        header()->resizeSection( c, 70 );
+        vwidth -= 70;
       }
     }
+    // then the LabelSection gets the remaining space (but at least 180 pixels)
+    header()->resizeSection( LabelColumn, vwidth >= 180 ? vwidth : 180 );
+  }
+  mIgnoreResizes = false;
+}
 
-    int vwidth = viewport()->width();
+void FolderView::slotColumnVisibilityChanged( int logicalIndex )
+{
+  // This is called when one of our columns is hidden or shown either
+  // by the means of the header popup menu or programmatically.
 
-    // If the total width extends beyond the view or the label column is really too small
-    // then perform a nice proportional re-layout.
-    if ( ( totalw > vwidth ) || ( labelw < 180 ) )
-    {
-      // all the sections but the "LabelColumn" get 70 pixels (yes, this is heuristic)
-      for ( int c = 0; c < count ; c++ )
-      {
-        if ( !isColumnHidden( c ) && ( c != LabelColumn ) )
-        {
-          header()->resizeSection( c, 70 );
-          vwidth -= 70;
-        }
-      }
-      // then the LabelSection gets the remaining space (but at least 180 pixels)
-      header()->resizeSection( LabelColumn, vwidth >= 180 ? vwidth : 180 );
-    }
-  } // else less space is needed and the view should look OK without resizing.
+  //kDebug() << "Column visibility changed!";
 
+  bool nowVisible = !isColumnHidden( logicalIndex );
+
+  switch( logicalIndex )
+  {
+    case LabelColumn:
+      // Ugh.. should never happen :/
+    break;
+    case UnreadColumn:
+    case TotalColumn:
+    case DataSizeColumn:
+      reload( nowVisible );
+    break;
+  }
+
+  setDefaultColumnSizes();
+
   emit columnsChanged();
 }
 
@@ -2360,7 +2446,9 @@
   e->accept();
 
   // KMHeaders does copy/move itself
-  if ( action == DragMove && item->folder() )
+  if ( action == DragCancel )
+     return;
+  else if ( action == DragMove && item->folder() )
      emit folderDrop( item->folder() );
   else if ( action == DragCopy && item->folder() )
      emit folderDropCopy( item->folder() );
Index: kmail/kmacctimap.cpp
===================================================================
--- kmail/kmacctimap.cpp	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ kmail/kmacctimap.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -454,11 +454,15 @@
     if (idx != -1) {
 
       msg = folder->getMsg( idx );
-      if (!msg) { // sanity checking
+      if ( !msg ) {
         mFilterSerNumsToSave.remove( QString( "%1" ).arg( sernum ) );
         continue;
       }
 
+      if ( msg->parent() && msg->parent()->find( msg ) == -1 ) {
+        kWarning() << "WTF!?!? Message is in reverse dictionary, but not in the index!!";
+      }
+
       if (ActionScheduler::isEnabled() ||
           kmkernel->filterMgr()->atLeastOneOnlineImapFolderTarget()) {
         mScheduler->execFilters( msg );
@@ -593,7 +597,16 @@
     // messageRetrieved(0) is always possible
     return -1;
   }
-  msg->setTransferInProgress(false);
+
+  msg->setTransferInProgress( false );
+
+  if ( msg->parent() && msg->parent()->find( msg ) == -1 ) {
+    // ### Isn't the msg pointer invalid already at this point, because it was removed
+    //     from the message list!? Seems to work, so...
+    kWarning() << "The message with subject" << msg->subject() << "was removed from the server"
+               << "while we were filtering!";
+    return 1; // Yay for clean return enums! (see kmfiltermgr for explaination)
+  }
   quint32 serNum = msg->getMsgSerNum();
   if ( serNum )
     mFilterSerNumsToSave.remove( QString( "%1" ).arg( serNum ) );
Index: kmail/folderselectiontreewidget.h
===================================================================
--- kmail/folderselectiontreewidget.h	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ kmail/folderselectiontreewidget.h	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -153,6 +153,11 @@
    */
   void recursiveReload( FolderViewItem *fti, FolderSelectionTreeWidgetItem *parent );
 
+  /**
+   * Returns false if the item is read-only and we need write access or has no content.
+   */
+  bool itemSelectable( const FolderSelectionTreeWidgetItem *item ) const;
+
 signals:
   /**
    * Emitted when the tree widget selection changes, to inform the parent dialogue
Index: kmail/accountdialog.h
===================================================================
--- kmail/accountdialog.h	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ kmail/accountdialog.h	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -113,7 +113,8 @@
     void slotFilterOnServerClicked();
     void slotPipeliningClicked();
     void slotPopEncryptionChanged(int);
-    void slotPopPasswordChanged(const QString& text);
+    void slotPopPasswordChanged( const QString& text );
+    void slotImapPasswordChanged( const QString& text );
     void slotImapEncryptionChanged(int);
     void slotCheckPopCapabilities();
     void slotCheckImapCapabilities();
Index: kmail/configuredialog.h
===================================================================
--- kmail/configuredialog.h	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ kmail/configuredialog.h	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -50,6 +50,7 @@
       included in the file.
   */
   void installProfile( KConfig *profile );
+  void configChanged();
 protected:
   void hideEvent( QHideEvent *i );
 protected slots:
Index: kmail/favoritefolderview.cpp
===================================================================
--- kmail/favoritefolderview.cpp	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ kmail/favoritefolderview.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -443,7 +443,7 @@
       } else if ( fti->folder()->folderType() == KMFolderTypeCachedImap )
       {
         KMFolderCachedImap* f = static_cast<KMFolderCachedImap*>( fti->folder()->storage() );
-        f->account()->processNewMailSingleFolder( fti->folder() );
+        f->account()->processNewMailInFolder( fti->folder() );
       }
     }
 
Index: kmail/kmail_config_security.desktop
===================================================================
--- kmail/kmail_config_security.desktop	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ kmail/kmail_config_security.desktop	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -44,6 +44,7 @@
 Name[ko]=보안
 Name[lt]=Saugumas
 Name[lv]=Drošība
+Name[mai]=सुरक्षा
 Name[mk]=Безбедност
 Name[ms]=Keselamatan
 Name[nb]=Sikkerhet
Index: kmail/kmfolderdir.cpp
===================================================================
--- kmail/kmfolderdir.cpp	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ kmail/kmfolderdir.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -168,7 +168,32 @@
     return label();
 }
 
+//-----------------------------------------------------------------------------
+void KMFolderDir::addDirToParent( const QString &dirName, KMFolder *parentFolder )
+{
+  KMFolderDir* folderDir = new KMFolderDir( parentFolder, this, dirName, mDirType);
+  folderDir->reload();
+  append( folderDir );
+  parentFolder->setChild( folderDir );
+}
 
+// Get the default folder type of the given dir type. This function should only be used when
+// needing to find out what the folder type of a missing folder is.
+KMFolderType dirTypeToFolderType( KMFolderDirType dirType )
+{
+  switch( dirType ) {
+
+    // Use maildir for normal folder dirs, as this function is only called when finding a dir
+    // without a parent folder, which can only happen with maildir-like folders
+    case KMStandardDir: return KMFolderTypeMaildir;
+
+    case KMImapDir: return KMFolderTypeImap;
+    case KMDImapDir: return KMFolderTypeCachedImap;
+    case KMSearchDir: return KMFolderTypeSearch;
+    default: Q_ASSERT( false ); return KMFolderTypeMaildir;
+  }
+}
+
 //-----------------------------------------------------------------------------
 bool KMFolderDir::reload(void)
 {
@@ -291,20 +316,44 @@
     }
   }
 
+  QSet<QString> dirsWithoutFolder = dirs;
   foreach ( KMFolder* folder, folderList )
   {
-    if ( dirs.contains( '.' + folder->fileName() + ".directory" ) )
+    const QString dirName = '.' + folder->fileName() + ".directory";
+    if ( dirs.contains( dirName ) )
     {
-      KMFolderDir* folderDir = new KMFolderDir( folder, this, '.' + folder->fileName() + ".directory", mDirType );
-      folderDir->reload();
-      append(folderDir);
-      folder->setChild(folderDir);
+      dirsWithoutFolder.remove( dirName );
+      addDirToParent( dirName, folder );
     }
   }
+
+  // Check if the are any dirs without an associated folder. This can happen if the user messes
+  // with the on-disk folder structure, see kolab issue 2972. In that case, we don't want to loose
+  // the subfolders as well, so we recreate the folder so the folder/dir hierachy is OK again.
+  if ( type() == KMDImapDir ) {
+    foreach ( const QString &dirName, dirsWithoutFolder ) {
+
+      // .foo.directory => foo
+      QString folderName = dirName;
+      int right = folderName.indexOf( ".directory" );
+      int left = folderName.indexOf( "." );
+      Q_ASSERT( left != -1 && right != -1 );
+      folderName = folderName.mid( left + 1, right - 1 );
+
+      kWarning() << "Found dir without associated folder:" << dirName << ", recreating the folder"
+                << folderName;
+
+      // Recreate the missing folder
+      KMFolder *folder = new KMFolder( this, folderName, KMFolderTypeCachedImap );
+      append( folder );
+      folderList.append( folder );
+
+      addDirToParent( dirName, folder );
+    }
+  }
   return true;
 }
 
-
 //-----------------------------------------------------------------------------
 KMFolderNode* KMFolderDir::hasNamedFolder(const QString& aName)
 {
Index: kmail/kmail_config_accounts.desktop
===================================================================
--- kmail/kmail_config_accounts.desktop	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ kmail/kmail_config_accounts.desktop	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -44,6 +44,7 @@
 Name[ko]=계정
 Name[lt]=Paskyros
 Name[lv]=Konti
+Name[mai]=खाता
 Name[mk]=Сметки
 Name[ms]=Akaun
 Name[nb]=Kontoer
Index: kmail/kmsystemtray.h
===================================================================
--- kmail/kmsystemtray.h	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ kmail/kmsystemtray.h	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -50,6 +50,8 @@
   int mode() const;
 
   void hideKMail();
+  bool hasUnreadMail() const;
+
 public slots:
   void foldersChanged();
 
Index: kmail/kmversion.h
===================================================================
--- kmail/kmversion.h	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ kmail/kmversion.h	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -3,6 +3,6 @@
 #ifndef kmversion_h
 #define kmversion_h
 
-#define KMAIL_VERSION "1.11.3"
+#define KMAIL_VERSION "1.11.4"
 
 #endif /*kmversion_h*/
Index: knode/knode_config_identity.desktop
===================================================================
--- knode/knode_config_identity.desktop	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ knode/knode_config_identity.desktop	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -104,6 +104,7 @@
 Comment[ko]=개인 정보
 Comment[lt]=Asmeninė informacija
 Comment[lv]=Personīgā informācija
+Comment[mai]=निज सूचना
 Comment[mk]=Лични информации
 Comment[ms]=Maklumat Peribadi
 Comment[nb]=Personlig informasjon
Index: knode/knode_config_accounts.desktop
===================================================================
--- knode/knode_config_accounts.desktop	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ knode/knode_config_accounts.desktop	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -44,6 +44,7 @@
 Name[ko]=계정
 Name[lt]=Paskyros
 Name[lv]=Konti
+Name[mai]=खाता
 Name[mk]=Сметки
 Name[ms]=Akaun
 Name[nb]=Kontoer
Index: knode/knode_config_cleanup.desktop
===================================================================
--- knode/knode_config_cleanup.desktop	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ knode/knode_config_cleanup.desktop	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -39,6 +39,7 @@
 Name[km]=សម្អាត
 Name[lt]=Išvalymas
 Name[lv]=Attīrīt
+Name[mai]=साफ करू
 Name[mk]=Расчистување
 Name[ms]=Pembersihan
 Name[nb]=Rydd opp
Index: knode/knode_config_appearance.desktop
===================================================================
--- knode/knode_config_appearance.desktop	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ knode/knode_config_appearance.desktop	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -44,6 +44,7 @@
 Name[ko]=모양
 Name[lt]=Išvaizda
 Name[lv]=Izskats
+Name[mai]=प्रकटन
 Name[mk]=Изглед
 Name[ms]=Rupa
 Name[nb]=Utseende
Index: knode/KNode.desktop
===================================================================
--- knode/KNode.desktop	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ knode/KNode.desktop	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -44,6 +44,7 @@
 GenericName[ko]=뉴스 리더
 GenericName[lt]=Naujienų skaitytuvė
 GenericName[lv]=Ziņu lasītājs
+GenericName[mai]=समाचार वाचक
 GenericName[mk]=Читач на вести
 GenericName[ms]=Pembaca Berita
 GenericName[nb]=Njusleser
@@ -67,8 +68,8 @@
 GenericName[tr]=Haber Okuyucu
 GenericName[uk]=Програма для перегляду новин
 GenericName[vi]=Trình đọc News 
+GenericName[xh]=Umfundi weendaba
 GenericName[x-test]=xxNews Readerxx
-GenericName[xh]=Umfundi weendaba
 GenericName[zh_CN]=新闻组阅读器
 GenericName[zh_TW]=新聞閱讀器
 X-KDE-StartupNotify=true
Index: kalarm/kalarm.h
===================================================================
--- kalarm/kalarm.h	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ kalarm/kalarm.h	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -23,7 +23,7 @@
 
 #undef QT3_SUPPORT
 
-#define KALARM_VERSION "2.1.7"
+#define KALARM_VERSION "2.1.8"
 #define KALARM_NAME "KAlarm"
 #define KALARM_DBUS_SERVICE  "org.kde.kalarm"  // D-Bus service name of KAlarm application
 
Index: kalarm/eventlistmodel.cpp
===================================================================
--- kalarm/eventlistmodel.cpp	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ kalarm/eventlistmodel.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -750,7 +750,8 @@
 	KLocale* locale = KGlobal::locale();
 	KDateTime kdt = dateTime.effectiveKDateTime().toTimeSpec(Preferences::timeZone());
 	QString dateTimeText = locale->formatDate(kdt.date(), KLocale::ShortDate);
-	if (!dateTime.isDateOnly()  ||  kdt.utcOffset() != dateTime.utcOffset())
+	if (!dateTime.isDateOnly()
+	||  (!dateTime.isClockTime()  &&  kdt.utcOffset() != dateTime.utcOffset()))
 	{
 		// Display the time of day if it's a date/time value, or if it's
 		// a date-only value but it's in a different time zone
Index: kalarm/Changelog
===================================================================
--- kalarm/Changelog	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ kalarm/Changelog	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -1,5 +1,13 @@
 KAlarm Change Log
 
+=== Version 2.1.8 --- 25 May 2009 ===
+- Fix crash on exit from birthday import dialogue.
+- Fix crash when an alarm is open for edit when its last occurrence triggers,
+  and the edit is then saved.
+- Fix another possible crash when KAlarm quits.
+- Don't show time in alarm list for date-only alarms without time zone (e.g.
+  those created by Import Birthdays).
+
 === Version 2.1.7 (KDE 4.2.3) --- 29 April 2009 ===
 - Fix recurring alarms being missed when deferred to earlier than next due alarm,
   when next due alarm is earlier than the next recurrence.
Index: kalarm/functions.cpp
===================================================================
--- kalarm/functions.cpp	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ kalarm/functions.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -97,7 +97,7 @@
 namespace KAlarm
 {
 
-void doEditNewAlarm(EditAlarmDlg*);
+void doEditNewAlarm(EditAlarmDlg*, bool alreadyExecuted = false);
 
 
 /******************************************************************************
@@ -884,9 +884,9 @@
 /******************************************************************************
 * Common code for editNewAlarm() variants.
 */
-void doEditNewAlarm(EditAlarmDlg* editDlg)
+void doEditNewAlarm(EditAlarmDlg* editDlg, bool alreadyExecuted)
 {
-	if (editDlg->exec() == QDialog::Accepted)
+	if (alreadyExecuted  ||  editDlg->exec() == QDialog::Accepted)
 	{
 		KAEvent event;
 		AlarmResource* resource;
@@ -995,9 +995,17 @@
 		viewAlarm(event, parent);
 		return;
 	}
+	QString id = event->id();
 	EditAlarmDlg* editDlg = EditAlarmDlg::create(false, event, false, parent, EditAlarmDlg::RES_USE_EVENT_ID);
 	if (editDlg->exec() == QDialog::Accepted)
 	{
+		if (!AlarmCalendar::resources()->event(id))
+		{
+			// Event has been deleted while the user was editing the alarm,
+			// so treat it as a new alarm.
+			doEditNewAlarm(editDlg, true);
+			return;
+		}
 		KAEvent newEvent;
 		AlarmResource* resource;
 		bool changeDeferral = !editDlg->getEvent(newEvent, resource);
Index: kalarm/alarmcalendar.cpp
===================================================================
--- kalarm/alarmcalendar.cpp	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ kalarm/alarmcalendar.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -389,8 +389,6 @@
 			mLocalFile = "";
 		}
 	}
-	while (!mResourceMap.isEmpty())
-		removeKAEvents(mResourceMap.begin().key(), true);
 	// Flag as closed now to prevent removeKAEvents() doing silly things
 	// when it's called again
 	mOpen = false;
@@ -400,6 +398,9 @@
 		delete mCalendar;
 		mCalendar = 0;
 	}
+	// Resource map should be empty, but just in case...
+	while (!mResourceMap.isEmpty())
+		removeKAEvents(mResourceMap.begin().key(), true);
 }
 
 /******************************************************************************
Index: kalarm/resources/kalarm_manager.desktop
===================================================================
--- kalarm/resources/kalarm_manager.desktop	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ kalarm/resources/kalarm_manager.desktop	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -21,6 +21,7 @@
 Name[ko]=알람
 Name[lt]=Priminimai
 Name[lv]=Atgādinājumi
+Name[mai]=सचेतक
 Name[nb]=Varslinger
 Name[ne]=संसूचक
 Name[nl]=Herinneringen
Index: kalarm/editdlg.cpp
===================================================================
--- kalarm/editdlg.cpp	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ kalarm/editdlg.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -964,9 +964,12 @@
 		if (!mResourceEventId.isEmpty())
 		{
 			mResource = AlarmCalendar::resources()->resourceForEvent(mResourceEventId);
-			AlarmResource::Type type = mTemplate ? AlarmResource::TEMPLATE : AlarmResource::ACTIVE;
-			if (mResource->alarmType() != type)
-				mResource = 0;   // event may have expired while dialog was open
+			if (mResource)
+			{
+				AlarmResource::Type type = mTemplate ? AlarmResource::TEMPLATE : AlarmResource::ACTIVE;
+				if (mResource->alarmType() != type)
+					mResource = 0;   // event may have expired while dialog was open
+			}
 		}
 		bool cancelled = false;
 		if (!mResource  ||  !mResource->writable())
Index: kalarm/birthdaymodel.cpp
===================================================================
--- kalarm/birthdaymodel.cpp	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ kalarm/birthdaymodel.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -1,7 +1,7 @@
 /*
  *  birthdaymodel.cpp  -  model class for birthdays from address book
  *  Program:  kalarm
- *  Copyright © 2007,2008 by David Jarvie <djarvie@kde.org>
+ *  Copyright © 2007-2009 by David Jarvie <djarvie@kde.org>
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -68,11 +68,8 @@
 	if (count)
 	{
 		beginRemoveRows(QModelIndex(), 0, count - 1);
-		for (int row = 0;  row < count;  ++row)
-		{
-			delete mData[row];
-			mData.removeAt(row);     // alarm exists, so remove from selection list
-		}
+		while (!mData.isEmpty())
+			delete mData.takeLast();   // alarm exists, so remove from selection list
 		endRemoveRows();
 	}
 	if (this == mInstance)
Index: kaddressbook/views/iconview.desktop
===================================================================
--- kaddressbook/views/iconview.desktop	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ kaddressbook/views/iconview.desktop	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -33,6 +33,7 @@
 Name[ko]=아이콘 보기
 Name[lt]=Rodyti piktogramas
 Name[lv]=Ikonu skatījums
+Name[mai]=चिह्न दृश्य
 Name[mk]=Преглед со икони
 Name[ms]=Pelihat Ikon
 Name[nb]=Ikonvisning
@@ -59,8 +60,8 @@
 Name[uz]=Nishoncha koʻrinishida
 Name[uz@cyrillic]=Нишонча кўринишида
 Name[vi]=Xem icon 
+Name[xh]=Imboniselo ye Icon
 Name[x-test]=xxIcon Viewxx
-Name[xh]=Imboniselo ye Icon
 Name[zh_CN]=图标视图
 Name[zh_TW]=圖示檢視
 Type=Service
Index: kaddressbook/xxport/gmx_xxport.cpp
===================================================================
--- kaddressbook/xxport/gmx_xxport.cpp	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ kaddressbook/xxport/gmx_xxport.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -295,8 +295,8 @@
 	KABC::Address address;
   	KABC::PhoneNumber phone, fax, cell;
 
-
-        if (record_id == 0) {
+	/* record ID == 1: Work address */
+        if (record_id == 1) {
 		address = addr->address(KABC::Address::Work);
 		phone = addr->phoneNumber(KABC::PhoneNumber::Work);
 		fax   = addr->phoneNumber(KABC::PhoneNumber::Fax);
@@ -322,13 +322,13 @@
 	  << cell.number() << DELIM		// Mobile
 	  << ((cell.type()&KABC::PhoneNumber::Pref)?-1:0) << DELIM // Mobile_type
 	  << email << DELIM			// Email
-	  << ((record_id==0)?addr->url().url():QString()) << DELIM // Homepage
-	  << ((record_id==0)?addr->role():QString()) << DELIM	// Position
+	  << ((record_id==1)?addr->url().url():QString()) << DELIM // Homepage
+	  << ((record_id==1)?addr->role():QString()) << DELIM	// Position
 	  << DELIM				// Comments
 	  << record_id << DELIM			// Record_type_id (0,1,2) - see above
 	  << DELIM				// Record_type (name of this additional record entry)
-	  << ((record_id==0)?addr->organization():QString()) << DELIM // Company
-	  << ((record_id==0)?addr->custom("KADDRESSBOOK", "X-Department"):QString()) << DELIM // Department
+	  << ((record_id==1)?addr->organization():QString()) << DELIM // Company
+	  << ((record_id==1)?addr->custom("KADDRESSBOOK", "X-Department"):QString()) << DELIM // Department
 	  << dateString(addr->revision()) << DELIM	// Change_date
 	  << 5 << DELIM				// Preferred
 	  << 1 << endl;				// Status (should always be "1")
Index: kaddressbook/editors/protocols/msnprotocol.desktop
===================================================================
--- kaddressbook/editors/protocols/msnprotocol.desktop	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ kaddressbook/editors/protocols/msnprotocol.desktop	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -17,6 +17,7 @@
 Comment[km]=កម្មវិធី​ផ្ញើសារ MSN
 Comment[ko]=MSN 메신저
 Comment[lv]=MSN tūlītējas ziņampaiņas programma
+Comment[mai]=MSN मेसेंजर
 Comment[nds]=MSN-Kortnarichtenmaker
 Comment[ne]=एमएसएन मेसेन्जर
 Comment[pa]=MSN ਮੈਂਸਜ਼ਰ
@@ -35,6 +36,7 @@
 Name[ka]=MSN შიკრიკი
 Name[km]=កម្មវិធី​ផ្ញើសារ MSN
 Name[ko]=MSN 메신저
+Name[mai]=MSN मेसेंजर
 Name[nds]=MSN-Kortnarichtenmaker
 Name[ne]=एमएसएन मेसेन्जर
 Name[pa]=MSN ਮੈਂਸਜ਼ਰ
Index: kaddressbook/editors/protocols/yahooprotocol.desktop
===================================================================
--- kaddressbook/editors/protocols/yahooprotocol.desktop	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ kaddressbook/editors/protocols/yahooprotocol.desktop	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -63,6 +63,7 @@
 Name[de]=Yahoo!
 Name[fa]=یاهو
 Name[km]=យ៉ាហ៊ូ
+Name[mai]=याहू
 Name[ne]=याहू
 Name[nn]=Yahoo!
 Name[pa]=ਯਾਹੂ
Index: kaddressbook/editors/imaddresseditor.desktop
===================================================================
--- kaddressbook/editors/imaddresseditor.desktop	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ kaddressbook/editors/imaddresseditor.desktop	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -28,6 +28,7 @@
 Name[ko]=인스턴트 메시징
 Name[lt]=Momentinės žinutės
 Name[lv]=Tūlītējā ziņojumapmaiņa
+Name[mai]=इंस्टेंट मैसेजिंग
 Name[ms]=Penghantaran Mesej Segera
 Name[nb]=Lynmelding
 Name[nds]=Kortnarichten-Maker
Index: kaddressbook/searchmanager.cpp
===================================================================
--- kaddressbook/searchmanager.cpp	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ kaddressbook/searchmanager.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -54,6 +54,46 @@
   return result;
 }
 
+static QStringList phoneNumberHomeValues( KABC::Field&, const KABC::Addressee &addressee )
+{
+  return phoneNumberValues( addressee, KABC::PhoneNumber::Home );
+}
+
+static QStringList phoneNumberWorkValues( KABC::Field&, const KABC::Addressee &addressee )
+{
+  return phoneNumberValues( addressee, KABC::PhoneNumber::Work );
+}
+
+static QStringList phoneNumberCarValues( KABC::Field&, const KABC::Addressee &addressee )
+{
+  return phoneNumberValues( addressee, KABC::PhoneNumber::Car );
+}
+
+static QStringList phoneNumberIsdnValues( KABC::Field&, const KABC::Addressee &addressee )
+{
+  return phoneNumberValues( addressee, KABC::PhoneNumber::Isdn );
+}
+
+static QStringList phoneNumberCellValues( KABC::Field&, const KABC::Addressee &addressee )
+{
+  return phoneNumberValues( addressee, KABC::PhoneNumber::Cell );
+}
+
+static QStringList phoneNumberPagerValues( KABC::Field&, const KABC::Addressee &addressee )
+{
+  return phoneNumberValues( addressee, KABC::PhoneNumber::Pager );
+}
+
+static QStringList faxNumberHomeValues( KABC::Field&, const KABC::Addressee &addressee )
+{
+  return phoneNumberValues( addressee, KABC::PhoneNumber::Home | KABC::PhoneNumber::Fax );
+}
+
+static QStringList faxNumberWorkValues( KABC::Field&, const KABC::Addressee &addressee )
+{
+  return phoneNumberValues( addressee, KABC::PhoneNumber::Work | KABC::PhoneNumber::Fax );
+}
+
 static QStringList addressStreetValues( const KABC::Addressee &addressee,
                                         KABC::Address::Type type )
 {
@@ -84,6 +124,66 @@
   return addressValues( addressee, type, &KABC::Address::postalCode );
 }
 
+static QStringList addressStreetHomeValues( KABC::Field&, const KABC::Addressee &addressee )
+{
+  return addressStreetValues( addressee, KABC::Address::Home );
+}
+
+static QStringList addressStreetWorkValues( KABC::Field&, const KABC::Addressee &addressee )
+{
+  return addressStreetValues( addressee, KABC::Address::Work );
+}
+
+static QStringList addressLocalityHomeValues( KABC::Field&, const KABC::Addressee &addressee )
+{
+  return addressLocalityValues( addressee, KABC::Address::Home );
+}
+
+static QStringList addressLocalityWorkValues( KABC::Field&, const KABC::Addressee &addressee )
+{
+  return addressLocalityValues( addressee, KABC::Address::Work );
+}
+
+static QStringList addressRegionHomeValues( KABC::Field&, const KABC::Addressee &addressee )
+{
+  return addressRegionValues( addressee, KABC::Address::Home );
+}
+
+static QStringList addressRegionWorkValues( KABC::Field&, const KABC::Addressee &addressee )
+{
+  return addressRegionValues( addressee, KABC::Address::Work );
+}
+
+static QStringList addressCountryHomeValues( KABC::Field&, const KABC::Addressee &addressee )
+{
+  return addressCountryValues( addressee, KABC::Address::Home );
+}
+
+static QStringList addressCountryWorkValues( KABC::Field&, const KABC::Addressee &addressee )
+{
+  return addressCountryValues( addressee, KABC::Address::Work );
+}
+
+static QStringList addressPostalCodeHomeValues( KABC::Field&, const KABC::Addressee &addressee )
+{
+  return addressPostalCodeValues( addressee, KABC::Address::Home );
+}
+
+static QStringList addressPostalCodeWorkValues( KABC::Field&, const KABC::Addressee &addressee )
+{
+  return addressPostalCodeValues( addressee, KABC::Address::Work );
+}
+
+static QStringList emailValues( KABC::Field&, const KABC::Addressee &addressee )
+{
+  return addressee.emails();
+}
+
+static QStringList singleFieldValues( KABC::Field& field, const KABC::Addressee &addressee )
+{
+  return QStringList() << field.value( addressee );
+}
+
 using namespace KAB;
 
 SearchManager::SearchManager( KABC::AddressBook *ab,
@@ -91,6 +191,28 @@
   : QObject( parent ), mAddressBook( ab )
 {
   setObjectName( name );
+
+  mValueListGetters[ KABC::Addressee::homePhoneLabel() ] = phoneNumberHomeValues;
+  mValueListGetters[ KABC::Addressee::businessPhoneLabel() ] = phoneNumberWorkValues;
+  mValueListGetters[ KABC::Addressee::carPhoneLabel() ] = phoneNumberCarValues;
+  mValueListGetters[ KABC::Addressee::mobilePhoneLabel() ] = phoneNumberCellValues;
+  mValueListGetters[ KABC::Addressee::isdnLabel() ] = phoneNumberIsdnValues;
+  mValueListGetters[ KABC::Addressee::pagerLabel() ] = phoneNumberPagerValues;
+  mValueListGetters[ KABC::Addressee::homeFaxLabel() ] = faxNumberHomeValues;
+  mValueListGetters[ KABC::Addressee::businessFaxLabel() ] = faxNumberWorkValues;
+
+  mValueListGetters[ KABC::Addressee::homeAddressStreetLabel() ] = addressStreetHomeValues;
+  mValueListGetters[ KABC::Addressee::businessAddressStreetLabel() ] = addressStreetWorkValues;
+  mValueListGetters[ KABC::Addressee::homeAddressLocalityLabel() ] = addressLocalityHomeValues;
+  mValueListGetters[ KABC::Addressee::businessAddressLocalityLabel() ] = addressLocalityWorkValues;
+  mValueListGetters[ KABC::Addressee::homeAddressRegionLabel() ] = addressRegionHomeValues;
+  mValueListGetters[ KABC::Addressee::businessAddressRegionLabel() ] = addressRegionWorkValues;
+  mValueListGetters[ KABC::Addressee::homeAddressCountryLabel() ] = addressCountryHomeValues;
+  mValueListGetters[ KABC::Addressee::businessAddressCountryLabel() ] = addressCountryWorkValues;
+  mValueListGetters[ KABC::Addressee::homeAddressPostalCodeLabel() ] = addressPostalCodeHomeValues;
+  mValueListGetters[ KABC::Addressee::businessAddressPostalCodeLabel() ] = addressPostalCodeWorkValues;
+
+  mValueListGetters[ KABC::Addressee::emailLabel() ] = emailValues;
 }
 
 void SearchManager::search( const QString &pattern, const KABC::Field::List &fields, Type type )
@@ -143,56 +265,29 @@
 
   const KABC::Field::List fieldList = !mFields.isEmpty() ? mFields : KABC::Field::allFields();
 
+  QList<valueListGetter> fieldGetters;
+  KABC::Field::List::ConstIterator fieldIt( fieldList.constBegin() );
+  const KABC::Field::List::ConstIterator fieldEndIt( fieldList.constEnd() );
+  for ( ; fieldIt != fieldEndIt; ++fieldIt ) {
+    const QString label = (*fieldIt)->label();
+    ValueListGetters::const_iterator getterIt = mValueListGetters.constFind( label );
+    if ( getterIt != mValueListGetters.constEnd() ) {
+      fieldGetters << getterIt.value();
+    } else {
+      fieldGetters << singleFieldValues;
+    }
+  }
+
   KABC::Addressee::List::ConstIterator it( allContacts.constBegin() );
   const KABC::Addressee::List::ConstIterator endIt( allContacts.constEnd() );
   for ( ; it != endIt; ++it ) {
     bool found = false;
     // search over all fields
-    KABC::Field::List::ConstIterator fieldIt( fieldList.begin() );
-    const KABC::Field::List::ConstIterator fieldEndIt( fieldList.end() );
-    for ( ; fieldIt != fieldEndIt; ++fieldIt ) {
-      QStringList values;
-      if ( (*fieldIt)->label() == KABC::Addressee::homeAddressStreetLabel() ) {
-        values = addressStreetValues( *it, KABC::Address::Home );
-      } else if ( (*fieldIt)->label() == KABC::Addressee::homeAddressLocalityLabel() ) {
-        values = addressLocalityValues( *it, KABC::Address::Home );
-      } else if ( (*fieldIt)->label() == KABC::Addressee::homeAddressRegionLabel() ) {
-        values = addressRegionValues( *it, KABC::Address::Home );
-      } else if ( (*fieldIt)->label() == KABC::Addressee::homeAddressCountryLabel() ) {
-        values = addressCountryValues( *it, KABC::Address::Home );
-      } else if ( (*fieldIt)->label() == KABC::Addressee::homeAddressPostalCodeLabel() ) {
-        values = addressPostalCodeValues( *it, KABC::Address::Home );
-      } else if ( (*fieldIt)->label() == KABC::Addressee::businessAddressStreetLabel() ) {
-        values = addressStreetValues( *it, KABC::Address::Work );
-      } else if ( (*fieldIt)->label() == KABC::Addressee::businessAddressLocalityLabel() ) {
-        values = addressLocalityValues( *it, KABC::Address::Work );
-      } else if ( (*fieldIt)->label() == KABC::Addressee::businessAddressRegionLabel() ) {
-        values = addressRegionValues( *it, KABC::Address::Work );
-      } else if ( (*fieldIt)->label() == KABC::Addressee::businessAddressCountryLabel() ) {
-        values = addressCountryValues( *it, KABC::Address::Work );
-      } else if ( (*fieldIt)->label() == KABC::Addressee::businessAddressPostalCodeLabel() ) {
-        values = addressPostalCodeValues( *it, KABC::Address::Work );
-      } else if ( (*fieldIt)->label() == KABC::Addressee::homePhoneLabel() ) {
-        values = phoneNumberValues( *it, KABC::PhoneNumber::Home );
-      } else if ( (*fieldIt)->label() == KABC::Addressee::businessPhoneLabel() ) {
-        values = phoneNumberValues( *it, KABC::PhoneNumber::Work );
-      } else if ( (*fieldIt)->label() == KABC::Addressee::carPhoneLabel() ) {
-        values = phoneNumberValues( *it, KABC::PhoneNumber::Car );
-      } else if ( (*fieldIt)->label() == KABC::Addressee::isdnLabel() ) {
-        values = phoneNumberValues( *it, KABC::PhoneNumber::Isdn );
-      } else if ( (*fieldIt)->label() == KABC::Addressee::pagerLabel() ) {
-        values = phoneNumberValues( *it, KABC::PhoneNumber::Pager );
-      } else if ( (*fieldIt)->label() == KABC::Addressee::mobilePhoneLabel() ) {
-        values = phoneNumberValues( *it, KABC::PhoneNumber::Cell );
-      } else if ( (*fieldIt)->label() == KABC::Addressee::homeFaxLabel() ) {
-        values = phoneNumberValues( *it, KABC::PhoneNumber::Home | KABC::PhoneNumber::Fax );
-      } else if ( (*fieldIt)->label() == KABC::Addressee::businessFaxLabel() ) {
-        values = phoneNumberValues( *it, KABC::PhoneNumber::Work | KABC::PhoneNumber::Fax);
-      } else if ( (*fieldIt)->label() == KABC::Addressee::emailLabel() ) {
-        values = (*it).emails();
-      } else {
-        values << (*fieldIt)->value( *it );
-      }
+    fieldIt = fieldList.constBegin();
+    QList<valueListGetter>::ConstIterator getterIt( fieldGetters.constBegin() );
+    const QList<valueListGetter>::ConstIterator getterEndIt( fieldGetters.constEnd() );
+    for ( ; getterIt != getterEndIt; ++getterIt, ++fieldIt ) {
+      const QStringList values = (*(*getterIt))( *(*fieldIt), *it );
       foreach ( const QString &value, values ) {
         if ( type == StartsWith && value.startsWith( pattern, Qt::CaseInsensitive ) ) {
         mContacts.append( *it );
Index: kaddressbook/kabcore.cpp
===================================================================
--- kaddressbook/kabcore.cpp	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ kaddressbook/kabcore.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -394,7 +394,7 @@
   mActionDelete->setEnabled( someSelected && writable );
   // the "edit" dialog doubles as the details dialog and it knows when the addressee is read-only
   // (### this does not make much sense from the user perspective!)
-  mActionEditAddressee->setEnabled( singleSelected );
+  mActionEditAddressee->setEnabled( singleSelected && !mExtensionManager->isQuickEditVisible());
   mActionCopyAddresseeTo->setEnabled( someSelected && moreThanOneResource );
   mActionMoveAddresseeTo->setEnabled( someSelected && moreThanOneResource && writable );
   mActionMail->setEnabled( someSelected && !mViewManager->selectedEmails( false ).isEmpty());
Index: kaddressbook/kcmconfigs/kabconfig.desktop
===================================================================
--- kaddressbook/kcmconfigs/kabconfig.desktop	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ kaddressbook/kcmconfigs/kabconfig.desktop	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -40,6 +40,7 @@
 Name[ko]=일반
 Name[lt]=Bendras
 Name[lv]=Pamata
+Name[mai]=सामान्य
 Name[mk]=Општо
 Name[ms]=Umum
 Name[nb]=SGenerelt
Index: kaddressbook/searchmanager.h
===================================================================
--- kaddressbook/searchmanager.h	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ kaddressbook/searchmanager.h	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -25,10 +25,14 @@
 #define SEARCHMANAGER_H
 
 #include <QtCore/QObject>
+#include <QtCore/QHash>
 
 #include <kabc/stdaddressbook.h>
 #include <kabc/distributionlist.h>
 
+typedef QStringList (*valueListGetter)( KABC::Field&, const KABC::Addressee& );
+typedef QHash<QString, valueListGetter> ValueListGetters;
+
 namespace KAB {
 
 class SearchManager : public QObject
@@ -94,6 +98,8 @@
     QString mPattern;
     KABC::Field::List mFields;
     Type mType;
+
+    ValueListGetters mValueListGetters;
 };
 
 }
Index: kaddressbook/ldapsearchdialog.cpp
===================================================================
--- kaddressbook/ldapsearchdialog.cpp	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ kaddressbook/ldapsearchdialog.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -700,15 +700,17 @@
 
 void LDAPSearchDialog::slotUser2()
 {
-    KABC::Resource *resource = mCore->requestResource( this );
-    if ( !resource ) return;
-
     const QList< QPair<KLDAP::LdapAttrMap, QString> > selectedItems = d->selectedItems( mResultView );
     if ( selectedItems.isEmpty() ) {
       KMessageBox::information( this, i18n( "Please select the contacts you want to add to the distribution list." ),
                                       i18n( "No Contacts Selected" ) );
       return;
     }
+
+    KABC::Resource *resource = mCore->requestResource( this );
+    if ( !resource )
+      return;
+
     KABC::DistributionList *dist = selectDistributionList();
     if ( !dist )
       return;
@@ -733,7 +735,9 @@
     if ( !resource )
       return;
 
-    importContactsUnlessTheyExist( d->selectedItems( mResultView ), resource );
+    if ( !d->selectedItems( mResultView ).isEmpty() ) {
+      importContactsUnlessTheyExist( d->selectedItems( mResultView ), resource );
+    }
 }
 
 #include "ldapsearchdialog.moc"
Index: libkholidays/holidays/holiday_ro
===================================================================
--- libkholidays/holidays/holiday_ro	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ libkholidays/holidays/holiday_ro	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -4,18 +4,17 @@
 : Author: Claudiu Costin <claudiuc@kde.org>
 :
 small   "Anul nou"              on 1.1.
-small   "Sărbătoarea unirii"    on 24.1
-small   "Ziua mamei"            on 8.3
-small   "Ziua copilului"        on 1.6
-small   "Ziua naţională"        on 1.12
-small   "Ziua Revoluţiei"       on 22.12
-red     "Crăciunul"             weekend on 25.12
-small   "Ziua muncii"           on 1.5
+small   "Sărbătoarea unirii"    on 24.1.
+small   "Ziua mamei"            on 8.3.
+small   "Ziua copilului"        on 1.6.
+small   "Ziua naţională"        on 1.12.
+small   "Ziua Revoluţiei"       on 22.12.
+red     "Crăciunul"             weekend on 25.12.
+small   "Ziua muncii"           on 1.5.
 
 
 : relativ la Paşte
-small   "Floriile"              on easter minus 6 days
-red     "Paştele"               weekend on easter
-small   "Înălţarea Domnului"    on easter plus 40 days
-small   "Rusalii"               on easter plus 49 days
-
+small   "Floriile"              on pascha minus 6 days
+red     "Paştele"               weekend on pascha
+small   "Înălţarea Domnului"    on pascha plus 40 days
+small   "Rusalii"               on pascha plus 49 days
Index: libkholidays/holidays/CMakeLists.txt
===================================================================
--- libkholidays/holidays/CMakeLists.txt	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ libkholidays/holidays/CMakeLists.txt	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -7,6 +7,7 @@
          holiday_BelgiumDutch
          holiday_BelgiumFrench
          holiday_BelgiumWalloon
+         holiday_bg
          holiday_br
          holiday_ca
          holiday_catalan
Index: libkholidays/holidays/holiday_bg
===================================================================
--- libkholidays/holidays/holiday_bg	(.../tags/KDE/4.2.3/kdepim)	(wersja 0)
+++ libkholidays/holidays/holiday_bg	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -0,0 +1,17 @@
+:
+: Bulgarian holiday file.
+: Author: Alexander Kurtakov <akurtakov@gmail.com>
+:
+red "Нова година" on 1.1.
+red "Ден на Освобождението на България от османско иго" on 3.3.
+red "Великден" weekend on pascha
+red "Великден" weekend on pascha plus 1 days
+red "Ден на труда" on 1.5.
+red "Гергьовден, Ден на храбростта и Българската армия" on 6.5.
+red "Ден на българската просвета и култура и на славянската писменост" on 24.5.
+red "Ден на Съединението на България" on 6.9.
+red "Ден на Независимостта на България" on 22.9.
+blue "Ден на народните будители - неприсъствен за всички учебни заведения" on 1.11.
+red "Бъдни вечер" on 24.12.
+red "Коледа, Рождество Христово" on 25.12.
+red "Коледа, Рождество Христово" on 26.12.
Index: plugins/kmail/bodypartformatter/text_calendar.cpp
===================================================================
--- plugins/kmail/bodypartformatter/text_calendar.cpp	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ plugins/kmail/bodypartformatter/text_calendar.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -376,8 +376,13 @@
             i18n("Comment:"), QString(), &ok );
         if ( !ok )
           return true;
-        if ( !comment.isEmpty() )
-          incidence->addComment( comment );
+        if ( !comment.isEmpty() ) {
+          if ( callback.exchangeCompatibleInvitations() ) {
+            incidence->setDescription( comment );
+          } else {
+            incidence->addComment( comment );
+          }
+        }
       }
 
       // First, save it for KOrganizer to handle
@@ -518,8 +523,13 @@
             i18n("Comment:"), QString(), &ok );
         if ( !ok )
           return true;
-        if ( !comment.isEmpty() )
-          incidence->addComment( comment );
+        if ( !comment.isEmpty() ) {
+          if ( callback.exchangeCompatibleInvitations() ) {
+            incidence->setDescription( comment );
+          } else {
+            incidence->addComment( comment );
+          }
+        }
       }
       return mail( incidence, callback, "declinecounter", KCal::iTIPDeclineCounter,
                    callback.sender(), DeclineCounter );
Index: ktimetracker/support/ktimetracker.desktop
===================================================================
--- ktimetracker/support/ktimetracker.desktop	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ ktimetracker/support/ktimetracker.desktop	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -58,8 +58,8 @@
 GenericName[tr]=Kişisel Saat İzleyici
 GenericName[uk]=Персональний лічильник часу
 GenericName[vi]=Trình đo thời gian 
+GenericName[xh]=Umfumani Wexesha Lobuqu
 GenericName[x-test]=xxPersonal Time Trackerxx
-GenericName[xh]=Umfumani Wexesha Lobuqu
 GenericName[zh_CN]=个人时间记录
 GenericName[zh_TW]=個人時程記錄
 Exec=ktimetracker
Index: libkdepim/treewidget.cpp
===================================================================
--- libkdepim/treewidget.cpp	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ libkdepim/treewidget.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -73,7 +73,7 @@
 {
   group.writeEntry(
       keyName.isEmpty() ? QString( KPIM_TREEWIDGET_DEFAULT_CONFIG_KEY ) : keyName,
-      QVariant( header()->saveState() )
+      QVariant( header()->saveState().toHex() )
     );
 
   return true;
@@ -95,10 +95,13 @@
                              keyName.isEmpty() ? QString( KPIM_TREEWIDGET_DEFAULT_CONFIG_KEY ) : keyName,
                              QVariant( QVariant::ByteArray )
                          ).toByteArray();
+  state = QByteArray::fromHex( state );
 
   if( state.isEmpty() )
     return false;
 
+  int cc = header()->count();
+
   // Qt writes also some options that can be set only
   // programmatically. This can drive you crazy if you
   // first setup the view and then restore the layout:
@@ -106,12 +109,15 @@
 
   bool sectionsWereClickable = header()->isClickable();
   bool sectionsWereMovable = header()->isMovable();
-  bool lastSectionWasStretched = header()->stretchLastSection();
   bool sortIndicatorWasShown = header()->isSortIndicatorShown();
   Qt::Alignment originalDefaultAlignment = header()->defaultAlignment();
   //int defaultSectionSize = header()->defaultSectionSize();
   int minimumSectionSize = header()->minimumSectionSize();
   bool cascadingSectionResizes = header()->cascadingSectionResizes();
+  QVector<QHeaderView::ResizeMode> resizeModes( cc );
+  for ( int i = 0 ; i < cc ; ++i ) {
+    resizeModes[ i ] = header()->resizeMode( i );
+  }
 
   // Qt (4.4) will perform a layout based on the stored column sizes
   // when restoreState() is called. However, there is an issue
@@ -120,20 +126,17 @@
   // of the last section if that is actually greater than the stored
   // value. This is very likely to throw the last section out of
   // the view and cause a horizontal scroll bar to appear even
-  // if it wasn't present when saveState() was called. 
+  // if it wasn't present when saveState() was called.
   // This seems to be a Qt buggie and we workaround it by
   // setting all the sections sizes to something very small
   // just before calling restoreState().
 
-  int cc = header()->count();
-
   // we also need to save the current sections sizes in order to remain
   // consistent if restoreState() fails for some reason.
   QVector<int> savedSizes( cc );
   for ( int i = 0 ; i < cc ; i++ )
   {
      savedSizes[ i ] = header()->sectionSize( i );
-     header()->resizeSection( i , 10 );
   }
 
   if ( !header()->restoreState( state ) )
@@ -150,7 +153,10 @@
   header()->setDefaultAlignment( originalDefaultAlignment );
   header()->setMinimumSectionSize( minimumSectionSize );
   header()->setCascadingSectionResizes( cascadingSectionResizes );
-  header()->setStretchLastSection( lastSectionWasStretched ); 
+  for ( int i = 0 ; i < cc ; ++i ) {
+    header()->setResizeMode( i, resizeModes[ i ] );
+  }
+
   // FIXME: This would cause the sections to be resized and thus
   //        can't be reliably reset after the configuration
   //        has been read. Can do nothing about that except warning
Index: libkdepim/kmeditor.cpp
===================================================================
--- libkdepim/kmeditor.cpp	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ libkdepim/kmeditor.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -1007,4 +1007,88 @@
   QTimer::singleShot( 500, this, SLOT( ensureCursorVisibleDelayed() ) );
 }
 
+static bool isCharFormatFormatted( const QTextCharFormat &format, const QFont &defaultFont,
+                                   const QTextCharFormat &defaultBlockFormat )
+{
+  if ( !format.anchorHref().isEmpty() ||
+       format.font() != defaultFont ||
+       format.isAnchor() ||
+       format.verticalAlignment() != defaultBlockFormat.verticalAlignment() ||
+       format.underlineStyle() != defaultBlockFormat.underlineStyle() ||
+       format.foreground().color() != defaultBlockFormat.foreground().color() ||
+       format.background().color() != defaultBlockFormat.background().color() )
+    return true;
+
+  return false;
+}
+
+static bool isBlockFormatFormatted( const QTextBlockFormat &format,
+                                    const QTextBlockFormat &defaultFormat )
+{
+  if ( format.alignment() != defaultFormat.alignment() ||
+       format.indent() != defaultFormat.indent() ||
+       format.textIndent() != defaultFormat.textIndent() )
+    return true;
+
+  return false;
+}
+
+/// @return true if the format represents a list, table, image or something like that.
+static bool isSpecial( const QTextFormat &charFormat )
+{
+  return charFormat.isFrameFormat() || charFormat.isImageFormat() ||
+         charFormat.isListFormat() || charFormat.isTableFormat();
+}
+
+bool KMeditor::isFormattingUsed() const
+{
+  if ( textMode() == Plain )
+    return false;
+
+  // Below, we walk through all text blocks and through all text fragments in them
+  // and check if any of those has any formatting.
+  // To check if they have formatting, we use the functions isBlockFormatFormatted() and
+  // isCharFormatFormatted(). Those do not check all the exising formatting possibilities on
+  // earth, but everything that KRichTextEdit supports at the moment.
+  //
+  // Also, we have to compare the formats against those of a default text edit. For example,
+  // we can't compare the foreground color against black, because the user might have another
+  // color scheme. Therefore we compare the foreground color against a default text edit.
+
+  QTextEdit defaultTextEdit;
+  QTextCharFormat defaultCharFormat = defaultTextEdit.document()->begin().charFormat();
+  QTextBlockFormat defaultBlockFormat = defaultTextEdit.document()->begin().blockFormat();
+  QFont defaultFont = document()->defaultFont();
+
+  QTextBlock block = document()->firstBlock();
+  while ( block.isValid() ) {
+
+    if ( isBlockFormatFormatted( block.blockFormat(), defaultBlockFormat ) ) {
+      return true;
+    }
+
+    if ( isSpecial( block.charFormat() ) || isSpecial( block.blockFormat() ) ||
+         block.textList() ) {
+      return true;
+    }
+
+    QTextBlock::iterator it = block.begin();
+    while ( !it.atEnd() ) {
+      QTextFragment fragment = it.fragment();
+      QTextCharFormat charFormat = fragment.charFormat();
+      if ( isSpecial( charFormat ) ) {
+        return true;
+      }
+      if ( isCharFormatFormatted( fragment.charFormat(), defaultFont, defaultCharFormat ) ) {
+        return true;
+      }
+
+      it++;
+    }
+    block = block.next();
+  }
+
+  return false;
+}
+
 #include "kmeditor.moc"
Index: libkdepim/kmeditor.h
===================================================================
--- libkdepim/kmeditor.h	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ libkdepim/kmeditor.h	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -201,6 +201,16 @@
      */
     void ensureCursorVisible();
 
+    /**
+     * Checks if rich text formatting is used anywhere.
+     * This is not the same as checking whether textMode() returns "Rich", since
+     * that only tells that rich text mode is enabled, but not if any special formatting
+     * is actually used.
+     *
+     * @return true if formatting is used anywhere
+     */
+    bool isFormattingUsed() const;
+
   public Q_SLOTS:
 
     void slotAddQuotes();
Index: libkdepim/categoryselectdialog.cpp
===================================================================
--- libkdepim/categoryselectdialog.cpp	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ libkdepim/categoryselectdialog.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -24,6 +24,7 @@
 #include "categoryhierarchyreader.h"
 #include "autochecktreewidget.h"
 #include "kpimprefs.h"
+#include "ui_categoryselectdialog_base.h"
 
 #include <KLocale>
 
@@ -31,6 +32,23 @@
 #include <QVBoxLayout>
 #include <QHeaderView>
 
+namespace KPIM
+{
+
+class CategorySelectWidgetBase : public QWidget, public Ui::CategorySelectDialog_base
+{
+  public:
+    CategorySelectWidgetBase( QWidget *parent ) : QWidget( parent )
+    {
+      setupUi( this );
+
+      mButtonClear->setIcon( KIcon( "edit-clear-locationbar-rtl" ) );
+      mButtonEdit->setIcon( KIcon( "document-properties" ) );
+    }
+};
+
+}
+
 using namespace KPIM;
 
 CategorySelectWidget::CategorySelectWidget( QWidget *parent, KPimPrefs *prefs )
@@ -170,6 +188,7 @@
   lay->addWidget( mWidgets );
 
   mWidgets->setCategories();
+  mWidgets->setFocus();
 
   connect( mWidgets, SIGNAL(editCategories()), SIGNAL(editCategories()) );
 
@@ -224,4 +243,10 @@
   mWidgets->setSelected( selList );
 }
 
+void CategorySelectDialog::enterEvent( QEvent *event )
+{
+  Q_UNUSED( event );
+  mWidgets->listView()->setFocus();
+}
+
 #include "categoryselectdialog.moc"
Index: libkdepim/categoryselectdialog.h
===================================================================
--- libkdepim/categoryselectdialog.h	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ libkdepim/categoryselectdialog.h	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -23,7 +23,6 @@
 #define KDEPIM_CATEGORYSELECTDIALOG_H
 
 #include "kdepim_export.h"
-#include "ui_categoryselectdialog_base.h"
 
 #include <KDialog>
 
@@ -31,18 +30,8 @@
 
 class KPimPrefs;
 class AutoCheckTreeWidget;
+class CategorySelectWidgetBase;
 
-class CategorySelectWidgetBase : public QWidget, public Ui::CategorySelectDialog_base
-{
-  public:
-    CategorySelectWidgetBase( QWidget *parent ) : QWidget( parent ) {
-      setupUi( this );
-
-      mButtonClear->setIcon( KIcon( "edit-clear-locationbar-rtl" ) );
-      mButtonEdit->setIcon( KIcon( "document-properties" ) );
-    }
-};
-
 class KDEPIM_EXPORT CategorySelectWidget : public QWidget
 {
   Q_OBJECT
@@ -99,6 +88,9 @@
     void categoriesSelected( const QStringList & );
     void editCategories();
 
+  protected:
+    /*reimp*/void enterEvent( QEvent * );
+
   private:
     CategorySelectWidget *mWidgets;
 
Index: console/konsolekalendar/konsolekalendarexports.cpp
===================================================================
--- console/konsolekalendar/konsolekalendarexports.cpp	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ console/konsolekalendar/konsolekalendarexports.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -3,7 +3,7 @@
  *                                                                             *
  * KonsoleKalendar is a command line interface to KDE calendars                *
  * Copyright (C) 2002-2004  Tuukka Pasanen <illuusio@mailcity.com>             *
- * Copyright (C) 2003-2005  Allen Winter <winter@kde.org>                      *
+ * Copyright (C) 2003-2005,2009  Allen Winter <winter@kde.org>                 *
  *                                                                             *
  * This program is free software; you can redistribute it and/or modify        *
  * it under the terms of the GNU General Public License as published by        *
@@ -193,6 +193,9 @@
 
 // By user request, no longer print UIDs if export-type==short
 
+  // Print Separator
+  *ts << endl;
+
   return true;
 }
 
Index: console/konsolekalendar/main.cpp
===================================================================
--- console/konsolekalendar/main.cpp	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ console/konsolekalendar/main.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -64,7 +64,7 @@
 //@cond IGNORE
 static const char progName[] = "konsolekalendar";
 static const char progDisplay[] = "KonsoleKalendar";
-static const char progVersion[] = "1.4.3";
+static const char progVersion[] = "1.4.4";
 static const char progDesc[] = "A command line interface to KDE calendars";
 static const char progURL[] = "pim.kde.org/components/konsolekalendar.php";
 
Index: kpilot/conduits/keyringconduit/kpilot-conduit-keyring.desktop
===================================================================
--- kpilot/conduits/keyringconduit/kpilot-conduit-keyring.desktop	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ kpilot/conduits/keyringconduit/kpilot-conduit-keyring.desktop	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -48,6 +48,7 @@
 Name[ja]=鍵リング
 Name[lt]=Raktų ratas
 Name[lv]=Atslēgu saišķis
+Name[mai]=कीरिंग
 Name[nb]=Nøkkelring
 Name[nds]=Slötelbund
 Name[nl]=Sleutelbos
Index: kpilot/conduits/popmail/popmail-conduit.desktop
===================================================================
--- kpilot/conduits/popmail/popmail-conduit.desktop	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ kpilot/conduits/popmail/popmail-conduit.desktop	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -78,6 +78,7 @@
 Name[ko]=전자 우편
 Name[lt]=Paštas
 Name[lv]=Pasts
+Name[mai]=डाक
 Name[mk]=Е-пошта
 Name[ms]=Mel
 Name[nb]=E-post
Index: kpilot/conduits/calendar/kpilot-conduit-calendar.desktop
===================================================================
--- kpilot/conduits/calendar/kpilot-conduit-calendar.desktop	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ kpilot/conduits/calendar/kpilot-conduit-calendar.desktop	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -61,6 +61,7 @@
 Name[ko]=달력
 Name[lt]=Kalendorius
 Name[lv]=Kalendārs
+Name[mai]=कैलेंडर
 Name[mk]=Календар
 Name[ms]=Kalendar
 Name[nb]=Kalender
Index: kpilot/conduits/base/recordconduit.cc
===================================================================
--- kpilot/conduits/base/recordconduit.cc	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ kpilot/conduits/base/recordconduit.cc	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -115,11 +115,15 @@
 	//        here?
 	DEBUGKPILOT << "Databases open [hh,pc,bu]: [" << hhDatabaseOpen << "," 
 		<< pcDatabaseOpen << "," << backupDatabaseOpen << "]";
-	
+
+	//  Syncing can take a long time, so tickle the palm periodically
+	startTickle (0);
+
 	if( hhDatabaseOpen && pcDatabaseOpen && backupDatabaseOpen )
 	{
 		DEBUGKPILOT << "All proxies are initialized and open.";
 		// So what are we going to do this time?!
+
 		if( isFirstSync() )
 		{
 			firstSync();
@@ -192,7 +196,10 @@
 			"database, no data to sync." ) );
 		return false; // 6.3.7 and 6.3.8
 	}
-	
+
+	// Sync finished, so no need to tickle the palm for awhile
+	stopTickle();
+
 	// Sync finished, set the endcount of the CUD counters
 	fHHDataProxy->setEndcount();
 	fPCDataProxy->setEndcount();
@@ -242,7 +249,12 @@
 		return false;
 	}
 
+	// committing to the pc may take some time, so periodically tickle the palm during the commit
+	// so it doesn't disconnect.
+	startTickle(0);
 	success = fPCDataProxy->commit();
+	stopTickle();
+
 	if( !success )
 	{
 		DEBUGKPILOT << "Could not save PC changes. Sync failed";
@@ -500,14 +512,24 @@
 	// A firstSync iterates over all records.
 	fHHDataProxy->setIterateMode( DataProxy::All );
 	fPCDataProxy->setIterateMode( DataProxy::All );
-	
+
+	int hhRecordCount = fHHDataProxy->recordCount();
+	int recCount = 0;
+
 	DEBUGKPILOT << "Walking over all hh records.";
 	addSyncLogEntry(i18n("Doing first sync. This may take a while."));
+	addSyncLogEntry( i18n("Syncing handheld records to pc.") );
 	
 	fHHDataProxy->resetIterator();
 	QSet<QString> pcIds; // pcRecords that where created or for which we found a match.
 	while( fHHDataProxy->hasNext() )
 	{
+		recCount++;
+		if (recCount%100 == 0)
+		{
+			emit logProgress( QString(), (double)recCount/(double)hhRecordCount*100 );
+		}
+
 		HHRecord *hhRecord = static_cast<HHRecord*>( fHHDataProxy->next() );
 		Record *pcRecord = findMatch( hhRecord );
 		
@@ -556,10 +578,20 @@
 	}
 	
 	DEBUGKPILOT << "Walking over all pc records.";
-	
+	addSyncLogEntry( i18n("Syncing PC records to handheld.") );
+
+	int pcRecordCount = fPCDataProxy->recordCount();
+	recCount = 0;
+
 	fPCDataProxy->resetIterator();
 	while( fPCDataProxy->hasNext() )
 	{
+		recCount++;
+		if( recCount%100 == 0)
+		{
+			emit logProgress( QString(), (double)recCount/(double)pcRecordCount*100 );
+		}
+
 		Record *pcRecord = fPCDataProxy->next();
 		
 		if( !fMapping.containsPCId( pcRecord->id() ) )
Index: kpilot/conduits/null/null-conduit.desktop
===================================================================
--- kpilot/conduits/null/null-conduit.desktop	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ kpilot/conduits/null/null-conduit.desktop	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -4,6 +4,7 @@
 Name[ca]=NUL
 Name[fa]=پوچ
 Name[ko]=없음
+Name[mai]=रिक्त
 Name[mk]=Нулов
 Name[ne]=शून्य
 Name[pa]=ਖਾਲੀ
Index: kpilot/conduits/contacts/kpilot-conduit-contacts.desktop
===================================================================
--- kpilot/conduits/contacts/kpilot-conduit-contacts.desktop	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ kpilot/conduits/contacts/kpilot-conduit-contacts.desktop	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -62,6 +62,7 @@
 Name[ko]=연락처
 Name[lt]=Kontaktai
 Name[lv]=Kontakti
+Name[mai]=संपर्क
 Name[mk]=Контакти
 Name[ms]=Orang hubungan
 Name[nds]=Kontakten
Index: kpilot/kpilot/kpilot.desktop
===================================================================
--- kpilot/kpilot/kpilot.desktop	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ kpilot/kpilot/kpilot.desktop	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -62,8 +62,8 @@
 GenericName[tr]=Palm Pilot Aracı
 GenericName[uk]=Засіб для PalmPilot
 GenericName[vi]=Công cụ PalmPilot
+GenericName[xh]=Isixhobo se PalmPilot
 GenericName[x-test]=xxPalmPilot Toolxx
-GenericName[xh]=Isixhobo se PalmPilot
 GenericName[zh_CN]=掌上电脑工具
 GenericName[zh_TW]=PalmPilot 工具
 Exec=kpilot
Index: kpilot/lib/options.h
===================================================================
--- kpilot/lib/options.h	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ kpilot/lib/options.h	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -45,7 +45,7 @@
 // Other headers
 #include <iostream>
 
-#define KPILOT_VERSION	"5.2.3 (KDE 4.2.3)"
+#define KPILOT_VERSION	"5.2.4 (KDE 4.2.4)"
 
 extern KDE_EXPORT int debug_level;
 
Index: kpilot/Documentation/base-conduit-template/kpilot-conduit-contacts.desktop
===================================================================
--- kpilot/Documentation/base-conduit-template/kpilot-conduit-contacts.desktop	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ kpilot/Documentation/base-conduit-template/kpilot-conduit-contacts.desktop	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -62,6 +62,7 @@
 Name[ko]=연락처
 Name[lt]=Kontaktai
 Name[lv]=Kontakti
+Name[mai]=संपर्क
 Name[mk]=Контакти
 Name[ms]=Orang hubungan
 Name[nds]=Kontakten
Index: kpilot/Documentation/base-conduit-template/contacts-conduit.desktop
===================================================================
--- kpilot/Documentation/base-conduit-template/contacts-conduit.desktop	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ kpilot/Documentation/base-conduit-template/contacts-conduit.desktop	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -3,7 +3,7 @@
 Comment=This conduit syncs the handheld address book with a database stored on the pc.
 Comment[ca]=Aquest conducte sincronitza la llibreta d'adreces de l'agenda electrònica amb una base de dades emmagatzemada al PC.
 Comment[da]=Denne kanal synkroniserer den håndholdtes adressebog med en database lagret på pc'en.
-Comment[de]=Abgleich des Addressbuchs von Taschencomputer und PC.
+Comment[de]=Abgleich der Adressbücher von Taschencomputer und PC.
 Comment[el]=Αυτό το κύκλωμα συγχρονίζει το βιβλίο διευθύνσεων του υπολογιστή παλάμης με τη βάση δεδομένων του υπολογιστή.
 Comment[en_GB]=This conduit syncs the handheld address book with a database stored on the PC.
 Comment[es]=Este conducto sincroniza la libreta de direcciones de la agenda electrónica con la base de datos almacenada en el equipo.
@@ -62,6 +62,7 @@
 Name[ko]=연락처
 Name[lt]=Kontaktai
 Name[lv]=Kontakti
+Name[mai]=संपर्क
 Name[mk]=Контакти
 Name[ms]=Orang hubungan
 Name[nds]=Kontakten
Index: kontact/plugins/akregator/akregator.setdlg
===================================================================
--- kontact/plugins/akregator/akregator.setdlg	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ kontact/plugins/akregator/akregator.setdlg	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -28,6 +28,7 @@
 Name[ko]=피드
 Name[lt]=Kanalai
 Name[lv]=Barotnes
+Name[mai]=फीड
 Name[ms]=Suapan
 Name[nb]=Kanaler
 Name[nds]=Narichtenströöm
Index: kontact/plugins/akregator/akregatorplugin.desktop
===================================================================
--- kontact/plugins/akregator/akregatorplugin.desktop	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ kontact/plugins/akregator/akregatorplugin.desktop	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -96,6 +96,7 @@
 Name[ko]=피드
 Name[lt]=Kanalai
 Name[lv]=Barotnes
+Name[mai]=फीड
 Name[ms]=Suapan
 Name[nb]=Kanaler
 Name[nds]=Narichtenströöm
Index: kontact/plugins/weather/weather.setdlg
===================================================================
--- kontact/plugins/weather/weather.setdlg	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ kontact/plugins/weather/weather.setdlg	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -29,6 +29,7 @@
 Name[ko]=날씨
 Name[lt]=Orų pranešėjas
 Name[lv]=Laikapstākļi
+Name[mai]=मौसम
 Name[mk]=Време
 Name[ms]=Cuaca
 Name[nb]=Været
@@ -88,6 +89,7 @@
 Comment[ko]=날씨 정보
 Comment[lt]=Orų informacija
 Comment[lv]=Laikapstākļu informācija
+Comment[mai]=मौसम सूचना
 Comment[mk]=Информации за времето
 Comment[ms]=Maklumat Cuaca
 Comment[nb]=Værinformasjon
Index: kontact/plugins/weather/weatherplugin.desktop
===================================================================
--- kontact/plugins/weather/weatherplugin.desktop	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ kontact/plugins/weather/weatherplugin.desktop	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -100,6 +100,7 @@
 Name[ko]=날씨 서비스
 Name[lt]=Orų tarnyba
 Name[lv]=Laikapstākļu serviss
+Name[mai]=मौसम सेवा
 Name[mk]=Временска прогноза
 Name[nb]=Værtjeneste
 Name[nds]=Wederdeenst
Index: kontact/plugins/kaddressbook/kaddressbookplugin.desktop
===================================================================
--- kontact/plugins/kaddressbook/kaddressbookplugin.desktop	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ kontact/plugins/kaddressbook/kaddressbookplugin.desktop	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -99,6 +99,7 @@
 Name[ko]=연락처
 Name[lt]=Kontaktai
 Name[lv]=Kontakti
+Name[mai]=संपर्क
 Name[mk]=Контакти
 Name[ms]=Orang hubungan
 Name[nds]=Kontakten
Index: kontact/plugins/kaddressbook/kaddressbook.setdlg
===================================================================
--- kontact/plugins/kaddressbook/kaddressbook.setdlg	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ kontact/plugins/kaddressbook/kaddressbook.setdlg	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -29,6 +29,7 @@
 Name[ko]=연락처
 Name[lt]=Kontaktai
 Name[lv]=Kontakti
+Name[mai]=संपर्क
 Name[mk]=Контакти
 Name[ms]=Orang hubungan
 Name[nds]=Kontakten
Index: kontact/plugins/korganizer/korganizer.setdlg
===================================================================
--- kontact/plugins/korganizer/korganizer.setdlg	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ kontact/plugins/korganizer/korganizer.setdlg	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -29,6 +29,7 @@
 Name[ko]=달력
 Name[lt]=Kalendorius
 Name[lv]=Kalendārs
+Name[mai]=कैलेंडर
 Name[mk]=Календар
 Name[ms]=Kalendar
 Name[nb]=Kalender
Index: kontact/plugins/korganizer/journalplugin.desktop
===================================================================
--- kontact/plugins/korganizer/journalplugin.desktop	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ kontact/plugins/korganizer/journalplugin.desktop	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -89,6 +89,7 @@
 Name[ko]=저널
 Name[lt]=Dienynas
 Name[lv]=Dienasgrāmata
+Name[mai]=पत्रिका
 Name[ms]=Jurnal
 Name[nb]=Dagbok
 Name[nds]=Daagbook
Index: kontact/plugins/korganizer/korganizerplugin.desktop
===================================================================
--- kontact/plugins/korganizer/korganizerplugin.desktop	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ kontact/plugins/korganizer/korganizerplugin.desktop	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -100,6 +100,7 @@
 Name[ko]=달력
 Name[lt]=Kalendorius
 Name[lv]=Kalendārs
+Name[mai]=कैलेंडर
 Name[mk]=Календар
 Name[ms]=Kalendar
 Name[nb]=Kalender
Index: kontact/plugins/kmail/kmailplugin.desktop
===================================================================
--- kontact/plugins/kmail/kmailplugin.desktop	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ kontact/plugins/kmail/kmailplugin.desktop	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -104,6 +104,7 @@
 Name[ko]=전자 우편
 Name[lt]=Paštas
 Name[lv]=Pasts
+Name[mai]=डाक
 Name[mk]=Е-пошта
 Name[ms]=Mel
 Name[nb]=E-post
Index: kontact/plugins/kmail/kmail.setdlg
===================================================================
--- kontact/plugins/kmail/kmail.setdlg	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ kontact/plugins/kmail/kmail.setdlg	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -30,6 +30,7 @@
 Name[ko]=전자 우편
 Name[lt]=Paštas
 Name[lv]=Pasts
+Name[mai]=डाक
 Name[mk]=Е-пошта
 Name[ms]=Mel
 Name[nb]=E-post
Index: kontact/plugins/summary/summaryplugin.desktop
===================================================================
--- kontact/plugins/summary/summaryplugin.desktop	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ kontact/plugins/summary/summaryplugin.desktop	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -92,6 +92,7 @@
 Name[ku]=Kurte
 Name[lt]=Santrauka
 Name[lv]=Kopsavilkums
+Name[mai]=सारांश
 Name[mk]=Преглед
 Name[ms]=Ringkasan
 Name[nb]=Sammendrag
Index: kontact/plugins/summary/summary.setdlg
===================================================================
--- kontact/plugins/summary/summary.setdlg	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ kontact/plugins/summary/summary.setdlg	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -30,6 +30,7 @@
 Name[ku]=Kurte
 Name[lt]=Santrauka
 Name[lv]=Kopsavilkums
+Name[mai]=सारांश
 Name[mk]=Преглед
 Name[ms]=Ringkasan
 Name[nb]=Sammendrag
Index: kontact/plugins/newsticker/newsticker.setdlg
===================================================================
--- kontact/plugins/newsticker/newsticker.setdlg	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ kontact/plugins/newsticker/newsticker.setdlg	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -49,8 +49,8 @@
 Name[tr]=Haber İzleyici
 Name[uk]=Стрічка новин
 Name[vi]=Trình kiểm tra news 
+Name[xh]=Umchola-choli weendaba
 Name[x-test]=xxNews Tickerxx
-Name[xh]=Umchola-choli weendaba
 Name[zh_CN]=新闻点点通
 Name[zh_TW]=新聞顯示器
 Comment=News Ticker Component
Index: kontact/plugins/newsticker/kcmkontactknt.desktop
===================================================================
--- kontact/plugins/newsticker/kcmkontactknt.desktop	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ kontact/plugins/newsticker/kcmkontactknt.desktop	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -33,6 +33,7 @@
 Name[ko]=뉴스 피드
 Name[lt]=Naujienų kanalai
 Name[lv]=Ziņu barotnes
+Name[mai]=समाचार पुष्टि
 Name[nb]=Nyhetskilder
 Name[nds]=Mellenströöm
 Name[ne]=समाचार फिड
Index: kontact/src/main.cpp
===================================================================
--- kontact/src/main.cpp	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ kontact/src/main.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -48,7 +48,7 @@
 static const char description[] =
   I18N_NOOP( "KDE personal information manager" );
 
-static const char version[] = "1.4.3";
+static const char version[] = "1.4.4";
 
 
 
Index: knotes/knotes_manager.desktop
===================================================================
--- knotes/knotes_manager.desktop	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ knotes/knotes_manager.desktop	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -30,6 +30,7 @@
 Name[ko]=노트
 Name[lt]=Užrašai
 Name[lv]=Piezīmes
+Name[mai]=टिप्पणी
 Name[mk]=Белешки
 Name[ms]=Nota
 Name[nb]=Notater
Index: knotes/knotes.desktop
===================================================================
--- knotes/knotes.desktop	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ knotes/knotes.desktop	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -57,8 +57,8 @@
 GenericName[tr]=Seyyar Notlar
 GenericName[uk]=Записник
 GenericName[vi]=Ghi chép Popup
+GenericName[xh]=Ivelisa iincwadana
 GenericName[x-test]=xxPopup Notesxx
-GenericName[xh]=Ivelisa iincwadana
 GenericName[zh_CN]=弹出式记事本
 GenericName[zh_TW]=彈出式筆記本
 
Index: akonadi/kabc/kcontactmanager/kcontactmanager.desktop
===================================================================
--- akonadi/kabc/kcontactmanager/kcontactmanager.desktop	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ akonadi/kabc/kcontactmanager/kcontactmanager.desktop	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -20,12 +20,14 @@
 GenericName[ga]=Bainisteoir na dTeagmhálacha
 GenericName[gl]=Xestor de Contactos
 GenericName[hu]=Névjegykezelő
+GenericName[is]=Tengiliðastjórnun
 GenericName[it]=Gestione della rubrica
 GenericName[ja]=連絡先マネージャ
 GenericName[km]=កម្មវិធី​គ្រប់គ្រង​ទំនាក់ទំនង
 GenericName[ko]=연락처 관리자
 GenericName[lt]=Kontaktų tvarkytuvė
 GenericName[lv]=Kontaktu pārvaldnieks
+GenericName[mai]=सम्पर्क प्रबंधक
 GenericName[nb]=Kontaktbehandler
 GenericName[nds]=Kontaktenpleger
 GenericName[nl]=Contactpersoonbeheerder
Index: akonadi/clients/akonadiconsole/akonadiconsole.desktop
===================================================================
--- akonadi/clients/akonadiconsole/akonadiconsole.desktop	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ akonadi/clients/akonadiconsole/akonadiconsole.desktop	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -10,6 +10,7 @@
 Name[ga]=Consól Akonadi
 Name[gl]=Consola de Akonadi
 Name[hu]=Akonadi-konzol
+Name[is]=Akonadi stjórnskjár
 Name[it]=Console Akonadi
 Name[ja]=Akonadi コンソール
 Name[km]=កុងសូល​របស់ Akonadi
Index: akonadi/kcm/kcm_akonadi.desktop
===================================================================
--- akonadi/kcm/kcm_akonadi.desktop	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ akonadi/kcm/kcm_akonadi.desktop	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -25,6 +25,7 @@
 Name[ga]=Cumraíocht Akonadi
 Name[gl]=Configuración do Akonadi 
 Name[hu]=Akonadi-beállítások
+Name[is]=Akonadi stillingar
 Name[it]=Configurazione di Akonadi
 Name[ja]=Akonadi の設定
 Name[km]=ការ​កំណត់​រចនាសម្ព័ន្ធ​ម៉ាស៊ីនបម្រើ Akonadi
Index: akonadi/CMakeLists.txt
===================================================================
--- akonadi/CMakeLists.txt	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ akonadi/CMakeLists.txt	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -23,6 +23,7 @@
   endmacro( kcfg_generate_dbus_interface )
 endif (XSLTPROC_EXECUTABLE)
 
+set( CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} ${KDE4_ENABLE_EXCEPTIONS}" )
 include_directories(${AKONADI_INCLUDE_DIR})
 
 add_subdirectory(clients)
Index: korganizer/koeventview.cpp
===================================================================
--- korganizer/koeventview.cpp	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ korganizer/koeventview.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -166,5 +166,26 @@
 
 //---------------------------------------------------------------------------
 
+bool KOEventView::usesCompletedTodoPixmap( Todo *todo, const QDate &date )
+{
+  if ( todo->isCompleted() ) {
+    return true;
+  } else if ( todo->recurs() ) {
+    QTime time;
+    if ( todo->allDay() ) {
+      time = QTime( 0, 0 );
+    } else {
+      time = todo->dtDue().toTimeSpec( KOPrefs::instance()->timeSpec() ).time();
+    }
+
+    KDateTime itemDateTime( date, time, KOPrefs::instance()->timeSpec() );
+
+    return itemDateTime < todo->dtDue( false );
+
+  } else {
+    return false;
+  }
+}
+
 #include "koeventview.moc"
 
Index: korganizer/koeventview.h
===================================================================
--- korganizer/koeventview.h	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ korganizer/koeventview.h	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -26,6 +26,9 @@
 #ifndef KOEVENTVIEW_H
 #define KOEVENTVIEW_H
 
+#include "koprefs.h"
+
+#include <kcal/todo.h>
 #include <kcal/incidencebase.h>
 
 #include <korganizer/baseview.h>
@@ -89,6 +92,18 @@
     /** This view is an view for displaying events. */
     bool isEventView() { return true; }
 
+    /*
+     * Returns true if the view item, that represents a to-do, should use the "completed"
+     * pixmap.
+     *
+     * @param todo The to-do associated with the view item.
+     * @param date The date in which the item appears in the view, for non recuring to-dos
+     * this is the same as the start date, but, for recurring to-dos this is the date of
+     * a particular occurrence.
+     *
+     */
+    static bool usesCompletedTodoPixmap( Todo *todo, const QDate &date );
+
   public slots:
 
     /**
Index: korganizer/koeditorgeneral.h
===================================================================
--- korganizer/koeditorgeneral.h	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ korganizer/koeditorgeneral.h	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -145,6 +145,7 @@
     QCheckBox               *mRichDescription;
     KOEditorAttachments     *mAttachments;
     Calendar                *mCalendar;
+    QStringList              mCategories;
 
     enum AlarmStackPages {
       SimpleAlarmPage,
@@ -153,7 +154,6 @@
 
   private:
     void toggleDescriptionRichButtons( bool rich );
-    QStringList mCategories;
     KCal::Alarm::List mAlarmList;
 };
 
Index: korganizer/koeditorgeneralevent.cpp
===================================================================
--- korganizer/koeditorgeneralevent.cpp	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ korganizer/koeditorgeneralevent.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -405,8 +405,10 @@
     // the rest is for the events only
     setDateTimes( event->dtStart(), event->dtEnd() );
   } else {
-    // set the start/end time from the template
-    setTimes( event->dtStart(), event->dtEnd() );
+    // set the start/end time from the template, only as a last resort #190545
+    if ( !event->dtStart().isValid() || !event->dtEnd().isValid() ) {
+      setTimes( event->dtStart(), event->dtEnd() );
+    }
   }
 
   switch( event->transparency() ) {
Index: korganizer/interfaces/calendar/calendarplugin.desktop
===================================================================
--- korganizer/interfaces/calendar/calendarplugin.desktop	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ korganizer/interfaces/calendar/calendarplugin.desktop	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -92,8 +92,8 @@
 Comment[uz]=Kalendar plagini
 Comment[uz@cyrillic]=Календар плагини
 Comment[vi]=Plugin lịch
+Comment[xh]=Ikhalenda ye Plugin
 Comment[x-test]=xxCalendar Pluginxx
-Comment[xh]=Ikhalenda ye Plugin
 Comment[zh_CN]=日历插件
 Comment[zh_TW]=行事曆外掛程式
 
Index: korganizer/interfaces/calendar/calendardecoration.desktop
===================================================================
--- korganizer/interfaces/calendar/calendardecoration.desktop	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ korganizer/interfaces/calendar/calendardecoration.desktop	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -90,7 +90,7 @@
 Comment[tr]=Takvim Dekorasyon Eklentisi
 Comment[uk]=Втулок прикрас календаря
 Comment[vi]=Plugin phối trí lịch 
+Comment[xh]=Ikhalenda Yohombiso lwe Plugin
 Comment[x-test]=xxCalendar Decoration Pluginxx
-Comment[xh]=Ikhalenda Yohombiso lwe Plugin
 Comment[zh_CN]=日历装饰插件
 Comment[zh_TW]=行事曆文字裝飾外掛程式
Index: korganizer/interfaces/korganizer/korgprintplugin.desktop
===================================================================
--- korganizer/interfaces/korganizer/korgprintplugin.desktop	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ korganizer/interfaces/korganizer/korgprintplugin.desktop	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -82,8 +82,8 @@
 Comment[tg]=Қисмати органайзер
 Comment[tr]=KOrganizer Parçası
 Comment[uk]=Складова KOrganizer
+Comment[xh]=Indawana yeKOrganizer
 Comment[x-test]=xxKOrganizer Partxx
-Comment[xh]=Indawana yeKOrganizer
 Comment[zh_CN]=KOrganizer 部件
 Comment[zh_TW]=KOrganizer 組件
 
Index: korganizer/interfaces/korganizer/korganizerpart.desktop
===================================================================
--- korganizer/interfaces/korganizer/korganizerpart.desktop	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ korganizer/interfaces/korganizer/korganizerpart.desktop	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -83,8 +83,8 @@
 Comment[tg]=Қисмати органайзер
 Comment[tr]=KOrganizer Parçası
 Comment[uk]=Складова KOrganizer
+Comment[xh]=Indawana yeKOrganizer
 Comment[x-test]=xxKOrganizer Partxx
-Comment[xh]=Indawana yeKOrganizer
 Comment[zh_CN]=KOrganizer 部件
 Comment[zh_TW]=KOrganizer 組件
 
Index: korganizer/interfaces/korganizer/baseview.h
===================================================================
--- korganizer/interfaces/korganizer/baseview.h	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ korganizer/interfaces/korganizer/baseview.h	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -89,6 +89,19 @@
     */
     virtual DateList selectedDates() = 0;
 
+    /**
+      Returns the start of the selection, or an invalid QDateTime if there is no selection
+      or the view doesn't support selecting cells.
+     */
+    virtual QDateTime selectionStart() { return QDateTime(); };
+		
+    /**
+      Returns the end of the selection, or an invalid QDateTime if there is no selection
+      or the view doesn't support selecting cells.
+     */
+    virtual QDateTime selectionEnd() { return QDateTime(); };
+
+
     virtual CalPrinterBase::PrintType printType();
 
     /**
Index: korganizer/koeditorgeneraljournal.cpp
===================================================================
--- korganizer/koeditorgeneraljournal.cpp	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ korganizer/koeditorgeneraljournal.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -144,27 +144,7 @@
   categoriesLayout->addWidget( mCategoriesLabel, 1 );
 }
 
-void KOEditorGeneralJournal::setCategories( const QStringList &categories )
-{
-  mCategoriesLabel->setText( categories.join( "," ) );
-  mCategories = categories;
-}
 
-void KOEditorGeneralJournal::selectCategories()
-{
-  KPIM::CategorySelectDialog *categoryDialog =
-    new KPIM::CategorySelectDialog( KOPrefs::instance(), mCategoriesButton );
-  KOGlobals::fitDialogToScreen( categoryDialog );
-  categoryDialog->setSelected( mCategories );
-
-  connect( categoryDialog, SIGNAL(editCategories()), this, SIGNAL(openCategoryDialog()) );
-
-  if ( categoryDialog->exec() ) {
-    setCategories( categoryDialog->selectedCategories() );
-  }
-  delete categoryDialog;
-}
-
 void KOEditorGeneralJournal::readJournal( Journal *journal, bool tmpl )
 {
   setSummary( journal->summary() );
@@ -196,7 +176,7 @@
   if ( hasTime ) {
     tmpDT.setTime( mTimeEdit->getTime() );
   }
-  journal->setDtStart(tmpDT);
+  journal->setDtStart( tmpDT );
   journal->setCategories( mCategories );
 }
 
Index: korganizer/kodaymatrix.cpp
===================================================================
--- korganizer/kodaymatrix.cpp	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ korganizer/kodaymatrix.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -285,12 +285,15 @@
     Event *event = *it;
     ushort recurType = event->recurrenceType();
 
+    KDateTime dtStart = event->dtStart().toTimeSpec( mCalendar->timeSpec() );
+    KDateTime dtEnd   = event->dtEnd().toTimeSpec( mCalendar->timeSpec() );
+
     if ( !( recurType == Recurrence::rDaily  && !KOPrefs::instance()->mDailyRecur ) &&
          !( recurType == Recurrence::rWeekly && !KOPrefs::instance()->mWeeklyRecur ) ) {
 
       DateTimeList timeDateList;
       bool isRecurrent = event->recurs();
-      int eventDuration = event->dtStart().daysTo( event->dtEnd() );
+      int eventDuration = dtStart.daysTo( dtEnd );
 
       if ( isRecurrent ) {
         //Its a recurring event, find out in which days it occurs
@@ -298,7 +301,7 @@
           KDateTime( mDays[0], mCalendar->timeSpec() ),
           KDateTime( mDays[NUMDAYS-1], mCalendar->timeSpec() ) );
       } else {
-        if ( event->dtStart().date() >= mDays[0] ) {
+        if ( dtStart.date() >= mDays[0] ) {
           timeDateList.append( event->dtStart() );
         } else {
           // The event starts in another month (not visible))
@@ -309,14 +312,14 @@
       DateTimeList::iterator t;
       for ( t=timeDateList.begin(); t != timeDateList.end(); ++t ) {
         //This could be a multiday event, so iterate from dtStart() to dtEnd()
-        QDate d = t->date();
+        QDate d = t->toTimeSpec( mCalendar->timeSpec() ).date();
         int j   = 0;
 
         QDate occurrenceEnd;
         if ( isRecurrent ) {
           occurrenceEnd = d.addDays( eventDuration );
         } else {
-          occurrenceEnd = event->dtEnd().date();
+          occurrenceEnd = dtEnd.date();
         }
 
         do {
Index: korganizer/views/monthview/monthview.cpp
===================================================================
--- korganizer/views/monthview/monthview.cpp	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ korganizer/views/monthview/monthview.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -130,13 +130,31 @@
 {
   DateList list;
 
-  if ( mScene->selectedCell() ) {
-    list << mScene->selectedCell()->date();
+  if ( mScene->selectedItem() ) {
+    IncidenceMonthItem *tmp = dynamic_cast<IncidenceMonthItem *>( mScene->selectedItem() );
+    if ( tmp ) {
+      list << tmp->realStartDate();
+    }
   }
 
   return list;
 }
 
+QDateTime MonthView::selectionStart()
+{
+  if ( mScene->selectedCell() ) {
+    return QDateTime( mScene->selectedCell()->date() );
+  } else {
+    return QDateTime();
+  }
+}
+
+QDateTime MonthView::selectionEnd()
+{
+  // Only one cell can be selected (for now)
+  return selectionStart();
+}
+
 bool MonthView::eventDurationHint( QDateTime &startDt, QDateTime &endDt, bool &allDay )
 {
   if ( mScene->selectedCell() ) {
@@ -285,10 +303,15 @@
 {
   // keep selection if it exists
   Incidence *incidenceSelected = 0;
+
+  MonthItem *itemToReselect = 0;
+  QDate selectedItemDate;
+
   if ( mScene->selectedItem() ) {
     IncidenceMonthItem *tmp = dynamic_cast<IncidenceMonthItem *>( mScene->selectedItem() );
     if ( tmp ) {
       incidenceSelected = tmp->incidence();
+      selectedItemDate = tmp->realStartDate();
     }
   }
 
@@ -310,13 +333,16 @@
       continue;
     }
 
+    KDateTime incDtStart = incidence->dtStart().toTimeSpec( timeSpec );
+    KDateTime incDtEnd   = incidence->dtEnd().toTimeSpec( timeSpec );
+
     // An event could start before the currently displayed date, so we
     // have to check at least those dates before the start date, which would
     // cause the event to span into the displayed date range.
     int offset = 0;
     Event *event;
     if ( ( event = dynamic_cast<Event *>( incidence ) ) ) {
-      offset = event->dtStart().daysTo( event->dtEnd() );
+      offset = incDtStart.daysTo( incDtEnd );
     }
     
     KDateTime startDateTime( mStartDate.addDays( - offset ), timeSpec );
@@ -336,7 +362,7 @@
           dateToAdd = todo->dtDue();
         }
       } else {
-        dateToAdd = incidence->dtStart();
+        dateToAdd = incDtStart;
       }
     
       if ( dateToAdd >= startDateTime && dateToAdd <= endDateTime ) {
@@ -345,15 +371,22 @@
     }
     DateTimeList::iterator t;
     for ( t = dateTimeList.begin(); t != dateTimeList.end(); ++t ) {
-      MonthItem *manager = new IncidenceMonthItem( mScene, incidence, t->date() );
+      MonthItem *manager = new IncidenceMonthItem( mScene,
+                                                   incidence,
+                                                   t->toTimeSpec( timeSpec ).date() );
       mScene->mManagerList << manager;
-      if ( incidenceSelected == incidence ) {
-        // If there was an item selected before, reselect it.
-        mScene->selectItem( manager );
+      if ( incidenceSelected == incidence &&
+           manager->realStartDate() == selectedItemDate ) {
+        // only select it outside the loop because we are still creating items
+        itemToReselect = manager;
       }
     }
   }
 
+  if ( itemToReselect ) {
+    mScene->selectItem( itemToReselect );
+  }
+
   // add holidays
   for ( QDate d = mStartDate; d <= mEndDate; d = d.addDays( 1 ) ) {
     QStringList holidays( KOGlobals::self()->holiday( d ) );
Index: korganizer/views/monthview/monthitem.cpp
===================================================================
--- korganizer/views/monthview/monthitem.cpp	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ korganizer/views/monthview/monthitem.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -540,9 +540,22 @@
   QList<QPixmap *> ret;
 
   if ( mIsEvent ) {
-    ret << monthScene()->eventPixmap();
+
+   // smartins: Disabling the event Pixmap because:
+   // 1. Save precious space so we can read the event's title better.
+   // 2. We don't need a pixmap to tell us an item is an event we
+   //    only need one to tell us it's not, as month view was designed for events.
+   // 3. If only to-dos and journals have a pixmap they will be distinguished
+   //    from event's much easier.
+
+   // ret << monthScene()->eventPixmap();
   } else if ( mIsTodo ) {
-    if ( static_cast<Todo *>( mIncidence )->isCompleted() ) {
+
+    Todo *todo = static_cast<Todo *>( mIncidence );
+
+    bool isCompleted = KOEventView::usesCompletedTodoPixmap( todo, realStartDate() );
+
+    if ( isCompleted ) {
       ret << monthScene()->todoDonePixmap();
     } else {
       ret << monthScene()->todoPixmap();
Index: korganizer/views/monthview/monthview.h
===================================================================
--- korganizer/views/monthview/monthview.h	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ korganizer/views/monthview/monthview.h	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -53,6 +53,10 @@
     /** Returns dates of the currently selected events */
     virtual DateList selectedDates();
 
+    virtual QDateTime selectionStart();
+
+    virtual QDateTime selectionEnd();
+
     virtual bool eventDurationHint( QDateTime &startDt, QDateTime &endDt, bool &allDay );
 
     QDate startDate() const { return mStartDate; }
Index: korganizer/views/todoview/kotodoview.h
===================================================================
--- korganizer/views/todoview/kotodoview.h	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ korganizer/views/todoview/kotodoview.h	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -73,8 +73,9 @@
     void setDocumentId( const QString & ) {}
 
     void saveLayout( KConfig *config, const QString &group ) const;
-    void restoreLayout( KConfig *config, const QString &group );
 
+    void restoreLayout( KConfig *config, const QString &group, bool minimalDefaults );
+
     bool usesFullWindow();
 
   public Q_SLOTS:
@@ -105,6 +106,7 @@
     void copyTodoToDate( const QDate &date );
 
   private Q_SLOTS:
+    void resizeColumnsToContent();
     void itemDoubleClicked( const QModelIndex &index );
     void setNewDate( const QDate &date );
     void setNewPercentage( QAction *action );
@@ -136,6 +138,9 @@
     QMenu *mPercentageCompletedPopupMenu;
     QList<QAction*> mItemPopupMenuItemOnlyEntries;
 
+    QAction *mMakeTodoIndependent;
+    QAction *mMakeSubtodosIndependent;
+
     QMap<QAction *,int> mPercentage;
     QMap<QAction *,int> mPriority;
     QMap<QAction *,QString> mCategory;
Index: korganizer/views/todoview/kotodomodel.cpp
===================================================================
--- korganizer/views/todoview/kotodomodel.cpp	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ korganizer/views/todoview/kotodomodel.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -730,7 +730,7 @@
   }
 
   // item for recurring todos
-  if ( role == Qt::DecorationRole && index.column() == RecurColumn ) {
+  if ( role == Qt::DecorationRole && index.column() == DueDateColumn ) {
     if ( todo->recurs() ) {
       return QVariant( QIcon( KOGlobals::self()->smallIcon( "task-recurring" ) ) );
     }
Index: korganizer/views/todoview/kcheckcombobox.cpp
===================================================================
--- korganizer/views/todoview/kcheckcombobox.cpp	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ korganizer/views/todoview/kcheckcombobox.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -197,7 +197,9 @@
     text = items.join( mSeparator );
   }
 
-  setEditText( text );
+  setEditText( fontMetrics().elidedText( text, Qt::ElideRight, width() ) );
+  setToolTip( text );
+
   emit checkedItemsChanged( items );
 }
 
Index: korganizer/views/todoview/kotodoview.cpp
===================================================================
--- korganizer/views/todoview/kotodoview.cpp	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ korganizer/views/todoview/kotodoview.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -57,6 +57,7 @@
 #include <QHeaderView>
 #include <QList>
 #include <QMenu>
+#include <QTimer>
 #include <QModelIndex>
 
 using namespace KCal;
@@ -121,8 +122,9 @@
            SLOT(selectionChanged(const QItemSelection&, const QItemSelection&)) );
 
   mQuickAdd = new KOTodoViewQuickAddLine( this );
-  mQuickAdd->setClickMessage( i18n( "Click to add a new to-do" ) );
   mQuickAdd->setClearButtonShown( true );
+  QString clickText = i18n( "Click to add a new to-do" );
+  mQuickAdd->setToolTip( clickText );
   mQuickAdd->setVisible( KOPrefs::instance()->enableQuickTodo() );
   connect( mQuickAdd, SIGNAL(returnPressed(Qt::KeyboardModifiers)),
            this, SLOT(addQuickTodo(Qt::KeyboardModifiers)) );
@@ -143,6 +145,12 @@
 
   setLayout( layout );
 
+  // Do elided text after the layout is set so the width is properly computed
+  mQuickAdd->setClickMessage(
+    fontMetrics().elidedText(
+      clickText, Qt::ElideRight,
+      mQuickAdd->width() + mQuickAdd->clearButtonUsedSize().width() ) );
+
   // ---------------- POPUP-MENUS -----------------------
   mItemPopupMenu = new QMenu( this );
 
@@ -172,12 +180,16 @@
   mItemPopupMenuItemOnlyEntries << mItemPopupMenu->addAction(
     i18n( "New Su&b-to-do..." ), this, SLOT(newSubTodo()) );
 
-  mItemPopupMenuItemOnlyEntries << mItemPopupMenu->addAction(
-    i18n( "&Make this To-do Independent" ), this, SIGNAL(unSubTodoSignal()) );
+  mMakeTodoIndependent = mItemPopupMenu->addAction( i18n( "&Make this To-do Independent" ),
+                                                    this, SIGNAL(unSubTodoSignal()) );
 
-  mItemPopupMenuItemOnlyEntries << mItemPopupMenu->addAction(
-    i18n( "Make all Sub-to-dos &Independent" ), this, SIGNAL(unAllSubTodoSignal()) );
+  mMakeSubtodosIndependent = mItemPopupMenu->addAction( i18n( "Make all Sub-to-dos &Independent" ),
+                                                        this, SIGNAL(unAllSubTodoSignal()) );
 
+  mItemPopupMenuItemOnlyEntries << mMakeTodoIndependent;
+
+  mItemPopupMenuItemOnlyEntries << mMakeSubtodosIndependent;
+
   mItemPopupMenu->addSeparator();
 
   mCopyPopupMenu = new KDatePickerPopup( KDatePickerPopup::NoDate |
@@ -300,7 +312,7 @@
   cfgGroup.writeEntry( "FlatView", mFlatView->isChecked() );
 }
 
-void KOTodoView::restoreLayout( KConfig *config, const QString &group )
+void KOTodoView::restoreLayout( KConfig *config, const QString &group, bool minimalDefaults )
 {
   KConfigGroup cfgGroup = config->group( group );
   QHeaderView *header = mView->header();
@@ -308,20 +320,37 @@
   QVariantList columnVisibility = cfgGroup.readEntry( "ColumnVisibility", QVariantList() );
   QVariantList columnOrder = cfgGroup.readEntry( "ColumnOrder", QVariantList() );
   QVariantList columnWidths = cfgGroup.readEntry( "ColumnWidths", QVariantList() );
-  for ( int i = 0;
-        i < header->count() && i < columnOrder.size() &&
-            i < columnWidths.size() && i < columnVisibility.size();
-        i++ ) {
-    bool visible = columnVisibility[i].toBool();
-    int width = columnWidths[i].toInt();
-    int order = columnOrder[i].toInt();
 
-    header->resizeSection( i, width );
-    header->moveSection( header->visualIndex( i ), order );
-    if ( i != 0 && !visible ) {
-      mView->hideColumn( i );
+  if ( columnVisibility.isEmpty() ) {
+    // if config is empty then use default settings
+    mView->hideColumn( eRecurColumn );
+
+    if ( minimalDefaults ) {
+      mView->hideColumn( ePriorityColumn );
+      mView->hideColumn( ePercentColumn );
+      mView->hideColumn( eDescriptionColumn );
     }
+
+    // We don't have any incidences (content) yet, so we delay resizing
+    QTimer::singleShot( 0, this, SLOT(resizeColumnsToContent()) );
+
+  } else {
+      for ( int i = 0; i < header->count()     &&
+                       i < columnOrder.size()  &&
+                       i < columnWidths.size() &&
+                       i < columnVisibility.size(); i++ ) {
+      bool visible = columnVisibility[i].toBool();
+      int width = columnWidths[i].toInt();
+      int order = columnOrder[i].toInt();
+
+      header->resizeSection( i, width );
+      header->moveSection( header->visualIndex( i ), order );
+      if ( i != 0 && !visible ) {
+        mView->hideColumn( i );
+      }
+    }
   }
+
   int sortOrder = cfgGroup.readEntry( "SortAscending", (int)Qt::AscendingOrder );
   int sortColumn = cfgGroup.readEntry( "SortColumn", -1 );
   if ( sortColumn >= 0 ) {
@@ -416,6 +445,12 @@
   mMovePopupMenu->setEnabled( enable );
 
   if ( enable ) {
+    Incidence::List incidences = selectedIncidences();
+    if ( !incidences.isEmpty() ) {
+      mMakeSubtodosIndependent->setEnabled( !incidences[0]->relations().isEmpty() );
+      mMakeTodoIndependent->setEnabled( incidences[0]->relatedTo() );
+    }
+
     switch ( mView->indexAt( pos ).column() ) {
     case ePriorityColumn:
       mPriorityPopupMenu->popup( mView->viewport()->mapToGlobal( pos ) );
@@ -708,4 +743,10 @@
   return KOPrefs::instance()->mFullViewTodo;
 }
 
+void KOTodoView::resizeColumnsToContent()
+{
+  mView->resizeColumnToContents( eDueDateColumn );
+  mView->resizeColumnToContents( eSummaryColumn );
+}
+
 #include "kotodoview.moc"
Index: korganizer/views/agendaview/koagendaview.cpp
===================================================================
--- korganizer/views/agendaview/koagendaview.cpp	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ korganizer/views/agendaview/koagendaview.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -1393,13 +1393,16 @@
   firstVisibleDateTime.setTime( QTime( 0, 0 ) );
   DateTimeList dateTimeList;
 
+  KDateTime incDtStart = incidence->dtStart().toTimeSpec( KOPrefs::instance()->timeSpec() );
+  KDateTime incDtEnd   = incidence->dtEnd().toTimeSpec( KOPrefs::instance()->timeSpec() );
+
   if ( todo &&
        ( !KOPrefs::instance()->showAllDayTodo() || !todo->hasDueDate() ) ) {
     return;
   }
 
   if ( incidence->recurs() ) {
-    int eventDuration = incidence->dtStart().daysTo( incidence->dtEnd() );
+    int eventDuration = incDtStart.daysTo( incDtEnd );
 
     // if there's a multiday event that starts before firstVisibleDateTime but ends after
     // lets include it. timesInInterval() ignores incidences that aren't totaly inside
@@ -1415,11 +1418,11 @@
 
     if ( todo && todo->hasDueDate() && !todo->isOverdue() ) {
       // If it's not overdue it will be shown at the original date (not today)
-      dateToAdd = todo->dtDue();
+      dateToAdd = todo->dtDue().toTimeSpec( KOPrefs::instance()->timeSpec() );
       incidenceEnd = dateToAdd;
     } else if ( event ) {
-      dateToAdd = incidence->dtStart();
-      incidenceEnd = incidence->dtEnd();
+      dateToAdd = incDtStart;
+      incidenceEnd = incDtEnd;
 
       if ( dateToAdd.isDateOnly() ) {
         // so comparisons with < > actually work
@@ -1445,7 +1448,7 @@
       /* If there's a recurring instance showing up today don't add "today" again 
        * we don't want the event to appear duplicated */
       for ( t = dateTimeList.begin(); t != dateTimeList.end(); ++t ) {
-        if ( t->date() == today ) {
+        if ( t->toTimeSpec( KOPrefs::instance()->timeSpec() ).date() == today ) {
           doAdd = false;
           break;
         }
@@ -1458,7 +1461,7 @@
   }
 
   for ( t = dateTimeList.begin(); t != dateTimeList.end(); ++t ) {
-    insertIncidence( incidence, t->date() );
+    insertIncidence( incidence, t->toTimeSpec( KOPrefs::instance()->timeSpec() ).date() );
   }
 }
 
@@ -1555,8 +1558,9 @@
   QList<int> sizes = group.readEntry( "Separator AgendaView", QList<int>() );
 
   // the size depends on the number of plugins used
-  if ( sizes.count() >= 2 ) {
-    mSplitterAgenda->setSizes( sizes );
+  // we don't want to read invalid/corrupted settings or else agenda becomes invisible
+  if ( sizes.count() >= 2 && !sizes.contains( 0 ) ) {
+      mSplitterAgenda->setSizes( sizes );
   }
 
   updateConfig();
Index: korganizer/views/agendaview/koagendaitem.cpp
===================================================================
--- korganizer/views/agendaview/koagendaitem.cpp	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ korganizer/views/agendaview/koagendaitem.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -26,6 +26,7 @@
 #include "koagendaitem.h"
 #include "koprefs.h"
 #include "koglobals.h"
+#include "koeventview.h"
 
 #include <libkdepim/kvcarddrag.h>
 
@@ -739,9 +740,12 @@
     return;
   }
 
-  bool b = ( static_cast<Todo *>( mIncidence ) )->isCompleted();
-  conditionalPaint( p, !b, x, y, ft, *todoPxmp );
-  conditionalPaint( p, b, x, y, ft, *completedPxmp );
+  Todo *todo = static_cast<Todo *>( mIncidence );
+
+  bool isCompleted = KOEventView::usesCompletedTodoPixmap( todo, mDate );
+
+  conditionalPaint( p, !isCompleted, x, y, ft, *todoPxmp );
+  conditionalPaint( p, isCompleted, x, y, ft, *completedPxmp );
 }
 
 void KOAgendaItem::paintJournalIcon( QPainter *p, int &x, int y, int ft )
@@ -754,7 +758,15 @@
 
 void KOAgendaItem::paintIcons( QPainter *p, int &x, int y, int ft )
 {
-  paintEventIcon( p, x, y, ft );
+
+  // smartins: Disabling the event Pixmap because:
+  // 1. We don't need a pixmap to tell us an item is an event we
+  //    only need one to tell us it's not, as agenda view was designed for events.
+  // 2. If only to-dos have a pixmap they will be distinguished
+  //    from event's much easier.
+  // 3. Be consistent with month view
+  //paintEventIcon( p, x, y, ft );
+
   paintTodoIcon( p, x, y, ft );
   paintJournalIcon( p, x, y, ft );
 #if 0
Index: korganizer/views/agendaview/koagenda.cpp
===================================================================
--- korganizer/views/agendaview/koagenda.cpp	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ korganizer/views/agendaview/koagenda.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -1966,7 +1966,17 @@
   if ( mSelectedItem.isNull() ) {
     return;
   }
-  mSelectedItem->select(false);
+
+  Incidence *selectedInc = mSelectedItem->incidence();
+
+  foreach ( KOAgendaItem *item, mItems ) {
+    Incidence *itemInc = item->incidence();
+    if( itemInc && selectedInc &&
+        itemInc->uid() == selectedInc->uid() ) {
+      item->select( false );
+    }
+  }
+
   mSelectedItem = 0;
 }
 
@@ -1984,6 +1994,13 @@
   mSelectedItem->select();
   assert( mSelectedItem->incidence() );
   mSelectedUid = mSelectedItem->incidence()->uid();
+
+  foreach ( KOAgendaItem *item, mItems ) {
+    if( item->incidence() && item->incidence()->uid() == mSelectedUid ) {
+      item->select();
+    }
+  }
+
   emit incidenceSelected( mSelectedItem->incidence() );
 }
 
Index: korganizer/views/agendaview/koagendaview.h
===================================================================
--- korganizer/views/agendaview/koagendaview.h	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ korganizer/views/agendaview/koagendaview.h	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -106,7 +106,7 @@
     /** returns the currently selected events */
     virtual Incidence::List selectedIncidences();
 
-    /** returns the currently selected events */
+    /** returns the currently selected incidence's dates */
     virtual DateList selectedDates();
 
     /** return the default start/end date/time for new events   */
@@ -118,9 +118,11 @@
     CalPrinter::PrintType printType();
 
     /** start-datetime of selection */
-    QDateTime selectionStart() { return mTimeSpanBegin; }
+    virtual QDateTime selectionStart() { return mTimeSpanBegin; }
+
     /** end-datetime of selection */
-    QDateTime selectionEnd() { return mTimeSpanEnd; }
+    virtual QDateTime selectionEnd() { return mTimeSpanEnd; }
+
     /** returns true if selection is for whole day */
     bool selectedIsAllDay() { return mTimeSpanInAllDay; }
     /** make selected start/end invalid */
Index: korganizer/version.h
===================================================================
--- korganizer/version.h	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ korganizer/version.h	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -53,6 +53,6 @@
     3.2 alpha1
 */
 
-static const char korgVersion[] = "4.2.3";
+static const char korgVersion[] = "4.2.4";
 
 #endif
Index: korganizer/korganizer.desktop
===================================================================
--- korganizer/korganizer.desktop	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ korganizer/korganizer.desktop	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -55,8 +55,8 @@
 Comment[uz]=Kalendar va rejalashtirish dasturi
 Comment[uz@cyrillic]=Календар ва режалаштириш дастури
 Comment[vi]=Chương trình lịch và kế hoạch
+Comment[xh]=Ikhalenda no Dweliso lwenkqubo Yokucwangcisa
 Comment[x-test]=xxCalendar and Scheduling Programxx
-Comment[xh]=Ikhalenda no Dweliso lwenkqubo Yokucwangcisa
 Comment[zh_CN]=日历和日程安排程序
 Comment[zh_TW]=行事曆與排程軟體
 Exec=korganizer %U
Index: korganizer/calendarview.cpp
===================================================================
--- korganizer/calendarview.cpp	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ korganizer/calendarview.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -326,13 +326,10 @@
 {
   KOrg::BaseView *curView = mViewManager->currentView();
   if ( curView ) {
-    // Only the agenda view has a selectionStart (at this time)
-    KOAgendaView *aView = mViewManager->agendaView();
-    if ( curView == aView && aView->selectionStart().isValid() ) {
-      if ( aView->selectionStart().isValid() ) {
-        return aView->selectionStart().date();
-      }
+    if ( curView->selectionStart().isValid() ) {
+      return curView->selectionStart().date();
     }
+
     // Try the view's selectedDates()
     if ( !curView->selectedDates().isEmpty() ) {
       if ( curView->selectedDates().first().isValid() ) {
@@ -347,7 +344,6 @@
   } else {  
     return mDateNavigator->selectedDates().first();
   }
-
 }
 
 QDate CalendarView::startDate()
@@ -476,7 +472,7 @@
 
   mEventViewer->readSettings( config );
   mViewManager->readSettings( config );
-  mTodoList->restoreLayout( config, QString( "Sidebar Todo View" ) );
+  mTodoList->restoreLayout( config, QString( "Sidebar Todo View" ), true );
 
   readFilterSettings( config );
 
Index: korganizer/koprefs.cpp
===================================================================
--- korganizer/koprefs.cpp	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ korganizer/koprefs.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -370,12 +370,22 @@
 
 QString KOPrefs::fullName()
 {
+  QString tusername;
   if ( mEmailControlCenter ) {
     KEMailSettings settings;
-    return settings.getSetting( KEMailSettings::RealName );
+    tusername = settings.getSetting( KEMailSettings::RealName );
   } else {
-    return userName();
+    tusername = userName();
   }
+
+  // Quote the username as it might contain commas and other quotable chars.
+  tusername = KPIMUtils::quoteNameIfNecessary( tusername );
+
+  QString tname, temail;
+  // ignore the return value from extractEmailAddressAndName() because
+  // it will always be false since tusername does not contain "@domain".
+  KPIMUtils::extractEmailAddressAndName( tusername, temail, tname );
+  return tname;
 }
 
 QString KOPrefs::email()
Index: korganizer/kojournaleditor.cpp
===================================================================
--- korganizer/kojournaleditor.cpp	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ korganizer/kojournaleditor.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -66,8 +66,6 @@
   connect( this, SIGNAL(updateCategoryConfig()),
            mGeneral, SIGNAL(updateCategoryConfig()) );
 
-  connect( mDetails, SIGNAL(updateAttendeeSummary(int)),
-           mGeneral, SLOT(updateAttendeeSummary(int)) );
 }
 
 void KOJournalEditor::reload()
Index: korganizer/koeditorattachments.cpp
===================================================================
--- korganizer/koeditorattachments.cpp	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ korganizer/koeditorattachments.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -653,7 +653,7 @@
 
       AttachmentEditDialog *dialog = new AttachmentEditDialog( attitem, mAttachments, false );
       dialog->setModal( false );
-      connect( dialog, SIGNAL(hidden()), dialog, SLOT(slotDelayedDestruct()) );
+      connect( dialog, SIGNAL(hidden()), dialog, SLOT(delayedDestruct()) );
       dialog->show();
     }
   }
Index: korganizer/resourceview.cpp
===================================================================
--- korganizer/resourceview.cpp	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ korganizer/resourceview.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -95,13 +95,13 @@
   : QTreeWidgetItem( parent ),
     mResource( resource ), mView( view ), mBlockStateChange( false ),
     mIsSubresource( false ), mResourceIdentifier( QString() ),
-    mSubItemsCreated( false ), mIsStandardResource( false )
+    mSubItemsCreated( false ), mIsStandardResource( false ),
+    mIsReloading( false )
 {
   setFlags( flags() | Qt::ItemIsUserCheckable );
 
   setText( 0, resource->resourceName() );
-
-  mResourceColor = QColor();
+  mResourceColor = KOPrefs::instance()->resourceColor( resource->identifier() );
   setGuiState();
 
   if ( mResource->isActive() ) {
@@ -118,27 +118,47 @@
     QStringList::ConstIterator it;
     for ( it = subresources.begin(); it != subresources.end(); ++it ) {
       if ( !mView->findItemByIdentifier( *it ) ) {
-        ResourceItem *item = new ResourceItem( mResource, *it, mResource->labelForSubresource( *it ),
-                                               mView, this );
-        QColor resourceColor = KOPrefs::instance()->resourceColor( *it );
-        item->setResourceColor( resourceColor );
+        new ResourceItem( mResource, *it, mResource->labelForSubresource( *it ),
+                          mView, this );
       }
     }
   }
   mSubItemsCreated = true;
 }
 
+bool ResourceItem::useColors() const
+{
+  // assign a color, but only if this is a resource that actually
+  // hold items at top level
+  return KOPrefs::instance()->agendaViewColors() != KOPrefs::CategoryOnly  &&
+         ( mIsSubresource || ( !mIsReloading && mResource->subresources().isEmpty() ) ||
+           !mResource->canHaveSubresources() );
+}
+
+QVariant ResourceItem::data( int column, int role ) const
+{
+  if ( column == 0 &&
+       role == Qt::DecorationRole &&
+       mResourceColor.isValid() &&
+       useColors() ) {
+    return QVariant( mResourceColor );
+  } else {
+    return QTreeWidgetItem::data( column, role );
+  }
+}
+
 ResourceItem::ResourceItem( KCal::ResourceCalendar *resource,
                             const QString &sub, const QString &label,
                             ResourceView *view, ResourceItem *parent )
 
   : QTreeWidgetItem( parent ), mResource( resource ),
     mView( view ), mBlockStateChange( false ), mIsSubresource( true ),
-    mSubItemsCreated( false ), mIsStandardResource( false ), mActive( false )
+    mSubItemsCreated( false ), mIsStandardResource( false ), mActive( false ),
+    mIsReloading( false )
 {
   setFlags( flags() | Qt::ItemIsUserCheckable );
   setText( 0, label );
-  mResourceColor = QColor();
+  mResourceColor = KOPrefs::instance()->resourceColor( sub );
   mResourceIdentifier = sub;
   setGuiState();
 
@@ -209,18 +229,7 @@
 
 void ResourceItem::setResourceColor( QColor &color )
 {
-  if ( color.isValid() ) {
-    if ( mResourceColor != color ) {
-      int height = treeWidget()->visualItemRect(this).height();
-      QPixmap px( height - 4, height - 4 );
-      mResourceColor = color;
-      px.fill(color);
-      setData( 0, Qt::DecorationRole, px );
-    }
-  } else {
-    mResourceColor = color ;
-    setData( 0, Qt::DecorationRole, QPixmap() );
-  }
+  mResourceColor = color ;
 }
 
 void ResourceItem::setStandardResource( bool std )
@@ -444,16 +453,8 @@
 
 void ResourceView::addResourceItem( ResourceCalendar *resource, bool emitSignal )
 {
-  ResourceItem *item = new ResourceItem( resource, this, mListView );
+  new ResourceItem( resource, this, mListView );
 
-  // assign a color, but only if this is a resource that actually
-  // hold items at top level
-  if ( !resource->canHaveSubresources() || resource->subresources().isEmpty() ) {
-    QColor resourceColor = KOPrefs::instance()->resourceColor( resource->identifier() );
-    item->setResourceColor( resourceColor );
-    item->update();
-  }
-
   connect( resource,
            SIGNAL(signalSubresourceAdded(ResourceCalendar *,const QString &,const QString &,const QString &)),
            SLOT(slotSubresourceAdded(ResourceCalendar *,const QString &,const QString &,const QString &)) );
@@ -633,7 +634,7 @@
 
     QAction *saveAction = menu->addAction(
       i18nc( "save the resource", "&Save" ), this, SLOT(saveResource()) );
-    saveAction->setEnabled( item->resource()->isActive() );
+    saveAction->setEnabled( item->resource()->isActive() && !item->resource()->readOnly() );
 
     menu->addSeparator();
 
@@ -721,9 +722,9 @@
   if ( !item ) {
     return;
   }
-
-  ResourceCalendar *r = item->resource();
-  r->load();
+  item->setIsReloading( true );
+  item->resource()->load();
+  item->setIsReloading( false );
 }
 
 void ResourceView::saveResource()
@@ -777,13 +778,9 @@
 void ResourceView::currentChanged()
 {
   ResourceItem *i = currentItem();
-  if ( !i || i->isSubresource() ) {
-    mDeleteButton->setEnabled( false );
-    mEditButton->setEnabled( false );
-  } else {
-    mDeleteButton->setEnabled( true );
-    mEditButton->setEnabled( true );
-  }
+
+  mDeleteButton->setEnabled( i != 0 );
+  mEditButton->setEnabled( i != 0 );
 }
 
 #include "resourceview.moc"
Index: korganizer/navigatorbar.h
===================================================================
--- korganizer/navigatorbar.h	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ korganizer/navigatorbar.h	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -26,24 +26,11 @@
 
 #include <kcal/incidencebase.h>
 
-#include <QLabel>
+#include <QWidget>
 #include <QMouseEvent>
 
 class QToolButton;
 
-class ActiveLabel : public QLabel
-{
-  Q_OBJECT
-  public:
-    explicit ActiveLabel( QWidget *parent );
-
-  signals:
-    void clicked();
-
-  protected:
-    void mouseReleaseEvent ( QMouseEvent *e );
-};
-
 class NavigatorBar: public QWidget
 {
   Q_OBJECT
@@ -74,14 +61,12 @@
     void selectYear();
 
   private:
-    bool mHasMinWidth;
-
     QDate mDate;
 
     QToolButton *mPrevYear;
     QToolButton *mPrevMonth;
-    ActiveLabel *mMonth;
-    ActiveLabel *mYear;
+    QToolButton *mMonth;
+    QToolButton *mYear;
     QToolButton *mNextMonth;
     QToolButton *mNextYear;
 };
Index: korganizer/koviewmanager.cpp
===================================================================
--- korganizer/koviewmanager.cpp	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ korganizer/koviewmanager.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -422,9 +422,13 @@
 
 void KOViewManager::showWorkWeekView()
 {
-  QDate date = mMainView->activeDate();
-  showAgendaView();
-  mMainView->dateNavigator()->selectWorkWeek( date );
+  if ( KOGlobals::self()->getWorkWeekMask() != 0 ) {
+    QDate date = mMainView->activeDate();
+    showAgendaView();
+    mMainView->dateNavigator()->selectWorkWeek( date );
+  } else {
+    // TODO: tell the user he must configure work days
+  }
 }
 
 void KOViewManager::showWeekView()
@@ -451,7 +455,7 @@
     connectTodoView( mTodoView );
 
     KConfig *config = KOGlobals::self()->config();
-    mTodoView->restoreLayout( config, "Todo View" );
+    mTodoView->restoreLayout( config, "Todo View", false );
   }
   showView( mTodoView );
 }
Index: korganizer/kcmconfigs/korganizer_configviews.desktop
===================================================================
--- korganizer/kcmconfigs/korganizer_configviews.desktop	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ korganizer/kcmconfigs/korganizer_configviews.desktop	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -43,6 +43,7 @@
 Name[ko]=보기
 Name[lt]=Peržiūros
 Name[lv]=Skati
+Name[mai]=दृश्य
 Name[mk]=Приказ
 Name[ms]=Paparan
 Name[nb]=Visninger
Index: korganizer/kcmconfigs/korganizer_configtime.desktop
===================================================================
--- korganizer/kcmconfigs/korganizer_configtime.desktop	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ korganizer/kcmconfigs/korganizer_configtime.desktop	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -32,6 +32,7 @@
 Name[ko]=시간과 날짜
 Name[lt]=Laikas ir data
 Name[lv]=Laiks un datums
+Name[mai]=समय आओर दिनांक
 Name[nb]=Dato og klokkeslett
 Name[nds]=Tiet un Datum
 Name[nl]=Datum & tijd
Index: korganizer/kcmconfigs/korganizer_configplugins.desktop
===================================================================
--- korganizer/kcmconfigs/korganizer_configplugins.desktop	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ korganizer/kcmconfigs/korganizer_configplugins.desktop	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -42,6 +42,7 @@
 Name[ko]=플러그인
 Name[lt]=Priedai
 Name[lv]=Spraudņi
+Name[mai]=प्लगिन
 Name[mk]=Приклучоци
 Name[ms]=Plugin
 Name[nb]=Programtillegg
Index: korganizer/kcmconfigs/korganizer_configmain.desktop
===================================================================
--- korganizer/kcmconfigs/korganizer_configmain.desktop	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ korganizer/kcmconfigs/korganizer_configmain.desktop	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -42,6 +42,7 @@
 Name[ko]=일반
 Name[lt]=Bendras
 Name[lv]=Pamata
+Name[mai]=सामान्य
 Name[mk]=Општо
 Name[ms]=Umum
 Name[nb]=SGenerelt
Index: korganizer/korganizer-import.desktop
===================================================================
--- korganizer/korganizer-import.desktop	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ korganizer/korganizer-import.desktop	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -55,8 +55,8 @@
 Comment[uz]=Kalendar va rejalashtirish dasturi
 Comment[uz@cyrillic]=Календар ва режалаштириш дастури
 Comment[vi]=Chương trình lịch và kế hoạch
+Comment[xh]=Ikhalenda no Dweliso lwenkqubo Yokucwangcisa
 Comment[x-test]=xxCalendar and Scheduling Programxx
-Comment[xh]=Ikhalenda no Dweliso lwenkqubo Yokucwangcisa
 Comment[zh_CN]=日历和日程安排程序
 Comment[zh_TW]=行事曆與排程軟體
 Exec=korganizer --import %U
Index: korganizer/koeditorgeneraljournal.h
===================================================================
--- korganizer/koeditorgeneraljournal.h	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ korganizer/koeditorgeneraljournal.h	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -77,10 +77,6 @@
     void setSummary( const QString &text );
     void finishSetup();
 
-  public slots:
-    void setCategories( const QStringList &categories );
-    void selectCategories();
-
   signals:
     void openCategoryDialog();
 
@@ -91,11 +87,6 @@
     KPIM::KDateEdit *mDateEdit;
     QCheckBox *mTimeCheckBox;
     KPIM::KTimeEdit *mTimeEdit;
-    QPushButton *mCategoriesButton;
-    KSqueezedTextLabel *mCategoriesLabel;
-
-  private:
-    QStringList mCategories;
 };
 
 #endif
Index: korganizer/navigatorbar.cpp
===================================================================
--- korganizer/navigatorbar.cpp	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ korganizer/navigatorbar.cpp	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -40,18 +40,8 @@
 #include <QSpacerItem>
 #include <QToolButton>
 
-ActiveLabel::ActiveLabel( QWidget *parent ) : QLabel( parent )
+NavigatorBar::NavigatorBar( QWidget *parent ) : QWidget( parent )
 {
-}
-
-void ActiveLabel::mouseReleaseEvent( QMouseEvent * )
-{
-  emit clicked();
-}
-
-NavigatorBar::NavigatorBar( QWidget *parent )
-  : QWidget( parent ), mHasMinWidth( false )
-{
   QFont tfont = font();
   tfont.setPointSize( 10 );
   tfont.setBold( false );
@@ -87,17 +77,17 @@
           "same approximate day of the next year" ) );
 
   // Create month name button
-  mMonth = new ActiveLabel( this );
+  mMonth = new QToolButton( this );
+  mMonth->setPopupMode( QToolButton::InstantPopup );
+  mMonth->setAutoRaise( true );
   mMonth->setFont( tfont );
-  mMonth->setAlignment( Qt::AlignCenter );
-  mMonth->setMinimumHeight( mPrevYear->sizeHint().height() );
   mMonth->setToolTip( i18n( "Select a month" ) );
 
   // Create year button
-  mYear = new ActiveLabel( this );
+  mYear = new QToolButton( this );
+  mYear->setPopupMode( QToolButton::InstantPopup );
+  mYear->setAutoRaise( true );
   mYear->setFont( tfont );
-  mYear->setAlignment( Qt::AlignCenter );
-  mYear->setMinimumHeight( mPrevYear->sizeHint().height() );
   mYear->setToolTip( i18n( "Select a year" ) );
 
   // set up control frame layout
@@ -149,23 +139,6 @@
 
     const KCalendarSystem *calSys = KOGlobals::self()->calendarSystem();
 
-    if ( !mHasMinWidth ) {
-      // Set minimum width to width of widest month name label
-      int i;
-      int maxwidth = 0;
-
-      for ( i = 1; i <= calSys->monthsInYear( mDate ); ++i ) {
-        QString m = calSys->monthName( i, calSys->year( mDate ) );
-        int w = QFontMetrics( mMonth->font() ).width( QString( "%1" ).arg( m ) );
-        if ( w > maxwidth ) {
-          maxwidth = w;
-        }
-      }
-      mMonth->setMinimumWidth( maxwidth );
-
-      mHasMinWidth = true;
-    }
-
     // set the label text at the top of the navigator
     mMonth->setText( i18nc( "monthname", "%1", calSys->monthName( mDate ) ) );
     mYear->setText( i18nc( "4 digit year", "%1", calSys->yearString( mDate ) ) );
@@ -258,6 +231,7 @@
     KIconLoader::global()->loadIcon( icon, KIconLoader::Desktop, KIconLoader::SizeSmall ) );
   button->setIconSize( QSize( KIconLoader::SizeSmall, KIconLoader::SizeSmall ) );
   button->setToolButtonStyle( Qt::ToolButtonIconOnly );
+  button->setAutoRaise( true );
   button->setToolTip( toolTip );
   button->setWhatsThis( whatsThis );
 
Index: korganizer/resourceview.h
===================================================================
--- korganizer/resourceview.h	(.../tags/KDE/4.2.3/kdepim)	(wersja 974231)
+++ korganizer/resourceview.h	(.../branches/KDE/4.2/kdepim)	(wersja 974231)
@@ -76,6 +76,10 @@
 
     void stateChange( bool active );
 
+    virtual QVariant data( int column, int role ) const;
+
+    void setIsReloading( bool value ) { mIsReloading = value; };
+
   protected:
     void setGuiState();
     QColor mResourceColor;
@@ -83,6 +87,11 @@
     void setOn( bool checked );
 
   private:
+    /*
+     * Returns if this item uses colors
+     */
+    bool useColors() const;
+
     KCal::ResourceCalendar *mResource;
     ResourceView *mView;
     bool mBlockStateChange;
@@ -91,6 +100,7 @@
     bool mSubItemsCreated;
     bool mIsStandardResource;
     bool mActive;
+    bool mIsReloading;
 };
 
 /**

Zmiany atrybutów dla: .
___________________________________________________________________
Dodane: svn:externals
   + 


