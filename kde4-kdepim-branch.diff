Index: akregator/src/browserframe.h
===================================================================
--- akregator/src/browserframe.h	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ akregator/src/browserframe.h	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -68,6 +68,10 @@
 
         void loadConfig( const KConfigGroup& config, const QString& prefix);
         void saveConfig( KConfigGroup& config, const QString& prefix);
+
+        bool hasZoom() const;
+        int  getZoomFactor() const;
+        void setZoomFactor(int);
     public slots:
 
         void slotHistoryForward();
@@ -80,6 +84,8 @@
         void slotPaletteOrFontChanged();
         void slotOpenLinkInBrowser();
         void slotOpenLinkInNewTab();
+        void slotZoomIn(int);
+        void slotZoomOut(int);
 
     private slots:
 
Index: akregator/src/articleviewer.cpp
===================================================================
--- akregator/src/articleviewer.cpp	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ akregator/src/articleviewer.cpp	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -76,7 +76,7 @@
 namespace Akregator {
 
 ArticleViewer::ArticleViewer(QWidget *parent)
-    : QWidget(parent),
+    : QFrame(parent),
       m_url(0),
       m_htmlFooter(),
       m_currentText(),
@@ -87,6 +87,7 @@
       m_normalViewFormatter( new DefaultNormalViewFormatter( m_imageDir, m_part->view() ) ),
       m_combinedViewFormatter( new DefaultCombinedViewFormatter( m_imageDir, m_part->view() ) )
 {
+    setFrameStyle(QFrame::StyledPanel | QFrame::Raised);
     QGridLayout* layout = new QGridLayout(this);
     layout->setMargin(0);
     layout->addWidget(m_part->widget(), 0, 0);
@@ -137,16 +138,6 @@
     action->setText(i18n("&Save Link As..."));
     connect(action, SIGNAL(triggered(bool) ), SLOT(slotSaveLinkAs()));
 
-    action = m_part->actionCollection()->addAction("articleviewer_scroll_up");
-    action->setText(i18n("&Scroll Up"));
-    connect(action, SIGNAL(triggered(bool)), SLOT(slotScrollUp()));
-    action->setShortcuts(KShortcut( "Up" ));
-
-    action = m_part->actionCollection()->addAction("articleviewer_scroll_down");
-    action->setText(i18n("&Scroll Down"));
-    connect(action, SIGNAL(triggered(bool)), SLOT(slotScrollDown()));
-    action->setShortcuts(KShortcut( "Down" ));
-
     updateCss();
 
     connect(this, SIGNAL(selectionChanged()), this, SLOT(slotSelectionChanged()));
@@ -337,18 +328,11 @@
     emit completed();
 }
 
-void ArticleViewer::slotScrollUp()
+void ArticleViewer::slotZoomIn(int id)
 {
-    m_part->view()->scrollBy(0,-10);
-}
+    if (id != 0)
+        return;
 
-void ArticleViewer::slotScrollDown()
-{
-    m_part->view()->scrollBy(0,10);
-}
-
-void ArticleViewer::slotZoomIn()
-{
     int zf = m_part->fontScaleFactor();
     if (zf < 100)
     {
@@ -362,8 +346,11 @@
     }
 }
 
-void ArticleViewer::slotZoomOut()
+void ArticleViewer::slotZoomOut(int id)
 {
+    if (id != 0)
+        return;
+
     int zf = m_part->fontScaleFactor();
     if (zf <= 100)
     {
Index: akregator/src/org.kde.akregator.part.xml
===================================================================
--- akregator/src/org.kde.akregator.part.xml	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ akregator/src/org.kde.akregator.part.xml	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -16,5 +16,8 @@
       <arg name="url" type="s" direction="in"/>
     </method>
     <method name="addFeed" />
+    <method name="handleCommandLine">
+      <arg name="result" type="b" direction="out"/>
+    </method>
   </interface>
 </node>
Index: akregator/src/aboutdata.h
===================================================================
--- akregator/src/aboutdata.h	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ akregator/src/aboutdata.h	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -28,7 +28,7 @@
 #include "akregator_export.h"
 #include <kaboutdata.h>
 
-#define AKREGATOR_VERSION "1.5.0"
+#define AKREGATOR_VERSION "1.5.1"
 
 namespace Akregator {
 /**
Index: akregator/src/akregator_part.h
===================================================================
--- akregator/src/akregator_part.h	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ akregator/src/akregator_part.h	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -124,6 +124,8 @@
 
         void exportFile(const KUrl& url);
 
+        bool handleCommandLine();
+
     public slots:
         /** Used to save settings after changing them from configuration dialog. Calls AkregatorPart's saveSettings. */
         void saveSettings();
Index: akregator/src/actionmanagerimpl.cpp
===================================================================
--- akregator/src/actionmanagerimpl.cpp	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ akregator/src/actionmanagerimpl.cpp	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -366,7 +366,9 @@
     KToggleAction* importantAction = coll->add<KToggleAction>("article_set_status_important");
     importantAction->setText(i18n("&Mark as Important"));
     importantAction->setIcon(KIcon("mail-mark-important"));
-    importantAction->setShortcuts(KShortcut("Ctrl+I"));
+    KShortcut importantSC( "Ctrl+I" );
+    importantSC.setAlternate( Qt::Key_I );
+    importantAction->setShortcuts( importantSC );
     importantAction->setCheckedState(KGuiItem(i18n("Remove &Important Mark")));
     connect(importantAction, SIGNAL(triggered(bool)), d->mainWidget, SLOT(slotArticleToggleKeepFlag(bool)));
 
@@ -419,17 +421,8 @@
     action = KStandardAction::copy(articleViewer, SLOT(slotCopy()), coll);
     coll->addAction("viewer_copy", action);
 
-    action = coll->addAction("inc_font_sizes");
-    action->setIcon(KIcon("zoom-in"));
-    action->setText(i18n("&Increase Font Sizes"));
-    connect(action, SIGNAL(triggered(bool)), articleViewer, SLOT(slotZoomIn()));
-    action->setShortcut( QKeySequence::ZoomIn );
-
-    action = coll->addAction("dec_font_sizes");
-    action->setIcon(KIcon("zoom-out"));
-    action->setText(i18n("&Decrease Font Sizes"));
-    connect(action, SIGNAL(triggered(bool)), articleViewer, SLOT(slotZoomOut()));
-    action->setShortcut( QKeySequence::ZoomOut );
+    connect(d->tabWidget, SIGNAL(signalZoomInFrame(int)), d->articleViewer, SLOT(slotZoomIn(int)));
+    connect(d->tabWidget, SIGNAL(signalZoomOutFrame(int)), d->articleViewer, SLOT(slotZoomOut(int)));
 }
 
 void ActionManagerImpl::initArticleListView(ArticleListView* articleList)
@@ -545,6 +538,18 @@
     action->setText(i18n("&Close Tab"));
     connect(action, SIGNAL(triggered(bool)), d->tabWidget, SLOT(slotCloseTab()));
     action->setShortcuts(KStandardShortcut::close());
+
+    action = coll->addAction("inc_font_sizes");
+    action->setIcon(KIcon("zoom-in"));
+    action->setText(i18n("&Increase Font Sizes"));
+    connect(action, SIGNAL(triggered(bool)), d->tabWidget, SLOT(slotFrameZoomIn()));
+    action->setShortcut( QKeySequence::ZoomIn );
+
+    action = coll->addAction("dec_font_sizes");
+    action->setIcon(KIcon("zoom-out"));
+    action->setText(i18n("&Decrease Font Sizes"));
+    connect(action, SIGNAL(triggered(bool)), d->tabWidget, SLOT(slotFrameZoomOut()));
+    action->setShortcut( QKeySequence::ZoomOut );
 }
 
 void ActionManagerImpl::initFrameManager(FrameManager* frameManager)
Index: akregator/src/akregator_part.cpp
===================================================================
--- akregator/src/akregator_part.cpp	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ akregator/src/akregator_part.cpp	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -46,6 +46,7 @@
 #include <knotifyconfigwidget.h>
 #include <kaboutdata.h>
 #include <kapplication.h>
+#include <KCmdLineArgs>
 #include <kconfig.h>
 #include <kconfigdialog.h>
 #include <kfiledialog.h>
@@ -658,7 +659,25 @@
             underline = konq.readEntry("UnderlineLinks", false);
         Settings::setUnderlineLinks(underline);
     }
+}
 
+bool Part::handleCommandLine() {
+    KCmdLineArgs *args = KCmdLineArgs::parsedArgs();
+    QString addFeedGroup = !args->getOption("group").isEmpty() ?
+         args->getOption("group")
+         : i18n("Imported Folder");
+
+    QStringList feedsToAdd = args->getOptionList("addfeed");
+
+    if (feedsToAdd.isEmpty() && args->count() > 0) {
+        QString url = args->url(0).url();
+        if(!url.isEmpty())
+            feedsToAdd.append(url);
+    }
+
+    if (!feedsToAdd.isEmpty())
+        addFeedsToGroup( feedsToAdd, addFeedGroup );
+    return true;
 }
 
 } // namespace Akregator
Index: akregator/src/tabwidget.cpp
===================================================================
--- akregator/src/tabwidget.cpp	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ akregator/src/tabwidget.cpp	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -179,6 +179,21 @@
     return w ? frames.value(w) : 0;
 }
 
+void TabWidget::slotFrameZoomIn()
+{
+    if ( !d->currentFrame() )
+        return;
+    emit signalZoomInFrame( d->currentFrame()->id() );
+}
+
+void TabWidget::slotFrameZoomOut()
+{
+    if ( !d->currentFrame() )
+        return;
+    emit signalZoomOutFrame( d->currentFrame()->id() );
+}
+
+
 void TabWidget::slotTabChanged(int index)
 {
 
Index: akregator/src/main.cpp
===================================================================
--- akregator/src/main.cpp	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ akregator/src/main.cpp	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -27,6 +27,7 @@
 #include "akregator_options.h"
 
 #include <kcmdlineargs.h>
+#include <KDebug>
 #include <klocale.h>
 #include <libkdepim/pimapplication.h>
 #include <QtDBus/QtDBus>
@@ -62,25 +63,7 @@
       akr.call( "openStandardFeedList");
     }
 
-    QString addFeedGroup = !args->getOption("group").isEmpty() ?
-         args->getOption("group")
-         : i18n("Imported Folder");
-
-    QStringList feeds = args->getOptionList("addfeed");
-    QStringList feedsToAdd;
-    QStringList::ConstIterator end( feeds.constEnd() );
-    for (QStringList::ConstIterator it = feeds.constBegin(); it != end; ++it)
-        feedsToAdd.append(*it);
-
-    if (feedsToAdd.isEmpty() && args->count() > 0) {
-        QString url = args->url(0).url();
-        if(!url.isEmpty())
-            feedsToAdd.append(url);
-    }
-
-    if (!feedsToAdd.isEmpty())
-        akr.call("addFeedsToGroup", feedsToAdd, addFeedGroup );
-
+    akr.call( "handleCommandLine" );
     args->clear();
   }
   return KUniqueApplication::newInstance();
@@ -95,6 +78,11 @@
     KCmdLineArgs::addCmdLineOptions( Akregator::akregator_options() );
     KUniqueApplication::addCmdLineOptions();
 
+    if ( !Akregator::Application::start() ) {
+        kWarning() << "akregator is already running, exiting.";
+        exit( 0 );
+    }
+
     Akregator::Application app;
 
     // start knotifyclient if not already started. makes it work for people who doesn't use full kde, according to kmail devels
Index: akregator/src/mainwidget.cpp
===================================================================
--- akregator/src/mainwidget.cpp	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ akregator/src/mainwidget.cpp	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -343,6 +343,8 @@
     BrowserFrame* frame = new BrowserFrame(m_tabWidget);
 
     connect( m_part, SIGNAL(signalSettingsChanged()), frame, SLOT(slotPaletteOrFontChanged()));
+    connect( m_tabWidget, SIGNAL(signalZoomInFrame(int)), frame, SLOT(slotZoomIn(int)));
+    connect( m_tabWidget, SIGNAL(signalZoomOutFrame(int)), frame, SLOT(slotZoomOut(int)));
 
     Kernel::self()->frameManager()->slotAddFrame(frame);
 
@@ -1114,6 +1116,8 @@
         frame->loadConfig( config, framePrefix + QLatin1Char( '_' ) );
 
         connect( m_part, SIGNAL(signalSettingsChanged()), frame, SLOT(slotPaletteOrFontChanged()));
+        connect( m_tabWidget, SIGNAL(signalZoomInFrame(int)), frame, SLOT(slotZoomIn(int)));
+        connect( m_tabWidget, SIGNAL(signalZoomOutFrame(int)), frame, SLOT(slotZoomOut(int)));
 
         Kernel::self()->frameManager()->slotAddFrame(frame);
 
Index: akregator/src/browserframe.cpp
===================================================================
--- akregator/src/browserframe.cpp	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ akregator/src/browserframe.cpp	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -47,6 +47,7 @@
 #include <kxmlguiclient.h>
 #include <kparts/browserextension.h>
 #include <kparts/part.h>
+#include <khtml_part.h>
 
 #include <cassert>
 
@@ -131,6 +132,65 @@
     emit signalOpenUrlRequest( req );
 }
 
+bool BrowserFrame::hasZoom() const
+{
+    return qobject_cast<KHTMLPart *>( d->part ) != 0;
+}
+
+void BrowserFrame::slotZoomIn(int zoomid)
+{
+    if ( zoomid != id() )
+        return;
+
+    if ( !d->part )
+        return;
+
+    if ( KHTMLPart * const khtml_part = qobject_cast<KHTMLPart *>( d->part ) ) {
+        int zf = khtml_part->fontScaleFactor();
+        if (zf < 100) {
+            zf = zf - (zf % 20) + 20;
+            khtml_part->setFontScaleFactor(zf);
+        } else {
+            zf = zf - (zf % 50) + 50;
+            khtml_part->setFontScaleFactor(zf < 300 ? zf : 300);
+        }
+    }
+}
+
+void BrowserFrame::slotZoomOut(int zoomid)
+{
+    if ( zoomid != id() )
+        return;
+
+    if ( !d->part )
+        return;
+
+    if (  KHTMLPart * const khtml_part = qobject_cast<KHTMLPart *>( d->part ) ) {
+        int zf = khtml_part->fontScaleFactor();
+        if (zf <= 100) {
+            zf = zf - (zf % 20) - 20;
+            khtml_part->setFontScaleFactor(zf > 20 ? zf : 20);
+        } else {
+            zf = zf - (zf % 50) - 50;
+            khtml_part->setFontScaleFactor(zf);
+        }
+    }
+}
+
+int BrowserFrame::getZoomFactor() const
+{
+    if ( KHTMLPart * const khtml_part = qobject_cast<KHTMLPart *>( d->part ) )
+        return khtml_part->fontScaleFactor();
+
+    return -1;
+}
+
+void BrowserFrame::setZoomFactor( int zf )
+{
+    if (KHTMLPart* const khtml_part = qobject_cast<KHTMLPart *>( d->part ) )
+        khtml_part->setFontScaleFactor( zf );
+}
+
 namespace {
 
 enum SeparatorOption {
@@ -198,6 +258,13 @@
         addActionsToMenu( popup, actionGroups.value( "editactions" ), NoSeparator );
     }
 
+    if (hasZoom())
+    {
+        addSeparatorIfNotFirst();
+        popup->addAction( ActionManager::getInstance()->action("inc_font_sizes") );
+        popup->addAction( ActionManager::getInstance()->action("dec_font_sizes") );
+    }
+
     addSeparatorIfNotFirst();
     addActionsToMenu( popup, actionGroups.value( "part" ), NoSeparator );
 
@@ -367,19 +434,22 @@
 
 void BrowserFrame::loadConfig( const KConfigGroup& config, const QString& prefix)
 {
-    QString url = config.readEntry( QString::fromLatin1( "url" ).prepend( prefix ), QString() );
-    QString mimetype = config.readEntry( QString::fromLatin1( "mimetype" ).prepend( prefix ), QString() );
+    const QString url = config.readEntry( QString::fromLatin1( "url" ).prepend( prefix ), QString() );
+    const QString mimetype = config.readEntry( QString::fromLatin1( "mimetype" ).prepend( prefix ), QString() );
+    const int zf = config.readEntry( QString::fromLatin1( "zoom" ).prepend( prefix ), 100 );
     OpenUrlRequest req(url);
     KParts::OpenUrlArguments args;
     args.setMimeType(mimetype);
     req.setArgs(args);
     openUrl(req);
+    setZoomFactor( zf );
 }
 
 void BrowserFrame::saveConfig( KConfigGroup& config, const QString& prefix)
 {
     config.writeEntry( QString::fromLatin1( "url" ).prepend( prefix ), url().url() );
     config.writeEntry( QString::fromLatin1( "mimetype" ).prepend( prefix ), d->mimetype );
+    config.writeEntry( QString::fromLatin1( "zoom" ).prepend( prefix ), getZoomFactor() );
 }
 
 #include "browserframe.moc"
Index: akregator/src/articleviewer.h
===================================================================
--- akregator/src/articleviewer.h	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ akregator/src/articleviewer.h	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -29,8 +29,8 @@
 
 #include <khtml_part.h>
 
+#include <QFrame>
 #include <QPointer>
-#include <QWidget>
 
 #include <boost/shared_ptr.hpp>
 #include <vector>
@@ -51,7 +51,7 @@
 
 class ArticleViewerPart;
 
-class ArticleViewer : public QWidget
+class ArticleViewer : public QFrame
 {
     Q_OBJECT
     public:
@@ -80,10 +80,8 @@
 
     public slots:
 
-        void slotScrollUp();
-        void slotScrollDown();
-        void slotZoomIn();
-        void slotZoomOut();
+        void slotZoomIn(int);
+        void slotZoomOut(int);
         void slotSetZoomFactor(int percent);
         void slotPrint();
 
Index: akregator/src/tabwidget.h
===================================================================
--- akregator/src/tabwidget.h	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ akregator/src/tabwidget.h	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -54,11 +54,15 @@
         void slotAddFrame(Akregator::Frame* f);
         void slotRemoveFrame(int frameId);
         void slotSelectFrame(int frameId);
+        void slotFrameZoomIn();
+        void slotFrameZoomOut();
 
     Q_SIGNALS:
         void signalCurrentFrameChanged(int);
         void signalRemoveFrameRequest(int);
         void signalOpenUrlRequest(Akregator::OpenUrlRequest&);
+        void signalZoomInFrame(int);
+        void signalZoomOutFrame(int);
 
     private:
         /*reimpl*/ void tabInserted( int );
Index: akregator/src/utils/filtercolumnsproxymodel.cpp
===================================================================
--- akregator/src/utils/filtercolumnsproxymodel.cpp	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ akregator/src/utils/filtercolumnsproxymodel.cpp	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -29,7 +29,7 @@
 using namespace Akregator;
 
 FilterColumnsProxyModel::FilterColumnsProxyModel( QObject* parent )
-    : QSortFilterProxyModel( parent ), m_mode( Whitelist ), m_vecSize( 0 )
+    : QSortFilterProxyModel( parent ), m_vecSize( 0 ), m_mode( Whitelist )
 {
     
 }
Index: akregator/src/addfeeddialog.cpp
===================================================================
--- akregator/src/addfeeddialog.cpp	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ akregator/src/addfeeddialog.cpp	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -87,11 +87,17 @@
     m_feed = new Feed( Kernel::self()->storage() );
 
     // HACK: make weird wordpress links ("feed:http://foobar/rss") work
-    if (feedUrl.startsWith(QLatin1String("feed:")))
+    if (feedUrl.startsWith(QLatin1String("feed:http")))
         feedUrl = feedUrl.right( feedUrl.length() - 5 );
 
     if (feedUrl.indexOf(":/") == -1)
         feedUrl.prepend("http://");
+
+    KUrl asUrl( feedUrl );
+    if ( asUrl.scheme() == QLatin1String("feed") ) {
+        asUrl.setScheme( "http" );
+        feedUrl = asUrl.url();
+    }
     m_feed->setXmlUrl(feedUrl);
 
     widget->statusLabel->setText( i18n("Downloading %1", feedUrl) );
Index: akregator/configuration/akregator_config_advanced.desktop
===================================================================
--- akregator/configuration/akregator_config_advanced.desktop	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ akregator/configuration/akregator_config_advanced.desktop	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -23,6 +23,7 @@
 Name[ga]=Ardsocruithe
 Name[gl]=Avanzado
 Name[hu]=Speciális
+Name[is]=Nánar
 Name[it]=Avanzate
 Name[ja]=詳細
 Name[km]=កម្រិត​ខ្ពស់
Index: libkleo/libkleopatrarc.desktop
===================================================================
--- libkleo/libkleopatrarc.desktop	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ libkleo/libkleopatrarc.desktop	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -333,6 +333,7 @@
 Name[ga]=Eochracha Eile
 Name[gl]=Outras chaves
 Name[hu]=Egyéb kulcsok
+Name[is]=Aðrir lyklar
 Name[it]=Altre chiavi
 Name[ja]=その他の鍵
 Name[km]=សោ​ផ្សេង​ទៀត
Index: kmail/kmreadermainwin.rc
===================================================================
--- kmail/kmreadermainwin.rc	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ kmail/kmreadermainwin.rc	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -1,5 +1,5 @@
 <!DOCTYPE kpartgui>
-<kpartgui version="411" name="kmreadermainwin" >
+<kpartgui version="412" name="kmreadermainwin" >
  <MenuBar>
   <Menu noMerge="1" name="file" >
    <text>&amp;File</text>
@@ -11,6 +11,10 @@
    <Separator/>
    <Action name="file_close" />
   </Menu>
+  <Menu noMerge="1" name="edit">
+   <text>&amp;Edit</text>
+   <Action name="kmail_copy"/>
+  </Menu>
   <Menu noMerge="1" name="view">
    <text>&amp;View</text>
    <Action name="view_headers"/>
Index: kmail/kmfilterdlg.cpp
===================================================================
--- kmail/kmfilterdlg.cpp	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ kmail/kmfilterdlg.cpp	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -168,14 +168,14 @@
     hbl = new QHBoxLayout( page1 );
     hbl->setObjectName( "kmfd_hbl" );
     hbl->setSpacing( spacingHint() );
-    hbl->setMargin( 0 );
+    hbl->setMargin( marginHint() );
 
     page2 = new QWidget( tabWidget );
     tabWidget->addTab( page2, i18nc("Advanced mail filter settings.","Advanced") );
     vbl2 = new QVBoxLayout( page2 );
     vbl2->setObjectName( "kmfd_vbl2" );
     vbl2->setSpacing( spacingHint() );
-    vbl2->setMargin( 0 );
+    vbl2->setMargin( marginHint() );
   }
 
   QVBoxLayout *vbl = new QVBoxLayout();
Index: kmail/stringutil.h
===================================================================
--- kmail/stringutil.h	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ kmail/stringutil.h	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -21,6 +21,7 @@
 
 #include <QString>
 
+class KUrl;
 namespace KMime
 {
   class CharFreq;
@@ -154,6 +155,12 @@
    *    linefeeds at word boundaries to make it fit.
    */
   QString smartQuote( const QString &msg, int maxLineLength );
+
+  /**
+   * Parses a mailto: url and extracts the information about to, cc, subject and body out into
+   * the QStrings given as argument.
+   */
+  void parseMailtoUrl( const KUrl &url, QString &to, QString &cc, QString &subject, QString &body );
 }
 
 }
Index: kmail/templateparser.cpp
===================================================================
--- kmail/templateparser.cpp	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ kmail/templateparser.cpp	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -891,7 +891,7 @@
 
     // If we have no attachment, simply create a text/plain part and
     // set the processed template text as the body
-    if ( ac.attachments().empty() ) {
+    if ( ac.attachments().empty() || mMode != Forward ) {
       mMsg->headers().ContentType().FromString( DwString() ); // to get rid of old boundary
       mMsg->headers().ContentType().Parse();
       mMsg->headers().ContentType().SetType( DwMime::kTypeText );
Index: kmail/messageactions.h
===================================================================
--- kmail/messageactions.h	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ kmail/messageactions.h	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -117,6 +117,7 @@
     KActionMenu *mForwardActionMenu;
     KToggleAction *mToggleFlagAction, *mToggleToActAction;
     KAction *mEditAction;
+    bool mKorganizerIsOnSystem;
 };
 
 }
Index: kmail/util.cpp
===================================================================
--- kmail/util.cpp	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ kmail/util.cpp	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -157,3 +157,18 @@
 
 }
 
+KMail::Util::RecursionPreventer::RecursionPreventer( int &counter )
+  : mCounter( counter )
+{
+  mCounter++;
+}
+
+KMail::Util::RecursionPreventer::~RecursionPreventer()
+{
+  mCounter--;
+}
+
+bool KMail::Util::RecursionPreventer::isRecursive() const
+{
+  return mCounter > 1;
+}
Index: kmail/messagelistview/storagemodel.cpp
===================================================================
--- kmail/messagelistview/storagemodel.cpp	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ kmail/messagelistview/storagemodel.cpp	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -154,6 +154,21 @@
     mColorToDoMessage = config.readEntry( "TodoMessage", mColorToDoMessage );
   }
 
+  if ( GlobalSettings::self()->useDefaultFonts() )
+  {
+    mFont = mFontImportantMessage = mFontNewMessage = mFontUnreadMessage =
+      mFontToDoMessage = KGlobalSettings::generalFont();
+  }
+  else
+  {
+    KConfigGroup fonts( KMKernel::config(), "Fonts" );
+    mFont = fonts.readEntry( "list-font",  KGlobalSettings::generalFont() );
+
+    mFontImportantMessage = fonts.readEntry( "list-important-font", mFont );
+    mFontNewMessage       = fonts.readEntry( "list-new-font",       mFont );
+    mFontUnreadMessage    = fonts.readEntry( "list-unread-font",    mFont );
+    mFontToDoMessage      = fonts.readEntry( "list-toact-font",     mFont );
+  }
 }
 
 StorageModel::~StorageModel()
@@ -290,46 +305,15 @@
   return mFolder->whoField().toLower() == "to";
 }
 
-bool StorageModel::initializeMessageItem( Core::MessageItem * mi, int row, bool bUseReceiver ) const
+/**
+ * Uses the KMMsgBase to fill a list of tags. It also picks out
+ * the colors the message should use.
+ */
+QList< Core::MessageItem::Tag * > * fillTagList( KMMsgBase * msg,
+    QColor & textColor, QColor & backgroundColor )
 {
-  KMMsgBase * msg = mFolder->getMsgBase( row );
-  if ( !msg )
-    return false;
-
-  QString sender = msg->fromStrip();
-  QString receiver = msg->toStrip();
-
-  // Static for speed reasons
-  static const QString noSubject = i18nc( "displayed as subject when the subject of a mail is empty", "No Subject" );
-  static const QString unknown( i18nc( "displayed when a mail has unknown sender, receiver or date", "Unknown" ) );
-
-  if ( sender.isEmpty() )
-    sender = unknown;
-  if ( receiver.isEmpty() )
-    receiver = unknown;
-
-  mi->initialSetup(
-      msg->date(),
-      mFolder->folderType() == KMFolderTypeImap ? msg->msgSizeServer() : msg->msgSize(),
-      sender, receiver,
-      bUseReceiver ? receiver : sender
-    );
-
-  mi->setUniqueId( msg->getMsgSerNum() );
-
-  KPIM::MessageStatus stat = msg->messageStatus();
-
-  QString subject = msg->subject();
-  if ( subject.isEmpty() )
-    subject = '(' + noSubject + ')';
-  mi->setSubjectAndStatus(
-      subject,
-      stat
-    );
-
-  QColor clr;
-
   // FIXME: Tags should be sorted by priority!
+  QList< Core::MessageItem::Tag * > * tagList = 0;
 
   if ( msg->tagList() )
   {
@@ -337,15 +321,16 @@
     {
       int bestPriority = -0xfffff;
 
-      QList< Core::MessageItem::Tag * > * tagList = new QList< Core::MessageItem::Tag * >();
+      tagList = new QList< Core::MessageItem::Tag * >();
       for ( KMMessageTagList::Iterator it = msg->tagList()->begin(); it != msg->tagList()->end(); ++it )
       {
         const KMMessageTagDescription * description = kmkernel->msgTagMgr()->find( *it );
         if ( description )
         {
-          if ( ( bestPriority < description->priority() ) || ( !clr.isValid() ) )
+          if ( ( bestPriority < description->priority() ) || ( !textColor.isValid() ) )
           {
-            clr = description->textColor();
+            textColor = description->textColor();
+            backgroundColor = description->backgroundColor();
             bestPriority = description->priority();
           }
 
@@ -358,14 +343,18 @@
         }
       }
       if ( tagList->isEmpty() )
+      {
         delete tagList;
-      else
-        mi->setTagList( tagList );
+        tagList = 0;
+      }
     }
   }
 
+  return tagList;
+}
 
-
+static void setMessageItemEncryptionState( Core::MessageItem * mi, KMMsgBase * msg )
+{
   switch ( msg->encryptionState() )
   {
     case KMMsgFullyEncrypted:
@@ -375,13 +364,17 @@
       mi->setEncryptionState( Core::MessageItem::PartiallyEncrypted );
     break;
     case KMMsgEncryptionStateUnknown:
+    case KMMsgEncryptionProblematic:
       mi->setEncryptionState( Core::MessageItem::EncryptionStateUnknown );
     break;
     default:
       mi->setEncryptionState( Core::MessageItem::NotEncrypted );
     break;
   }
+}
 
+static void setMessageItemSignatureState( Core::MessageItem * mi, KMMsgBase * msg )
+{
   switch ( msg->signatureState() )
   {
     case KMMsgFullySigned:
@@ -391,28 +384,51 @@
       mi->setSignatureState( Core::MessageItem::PartiallySigned );
     break;
     case KMMsgSignatureStateUnknown:
+    case KMMsgSignatureProblematic:
       mi->setSignatureState( Core::MessageItem::SignatureStateUnknown );
     break;
     default:
       mi->setSignatureState( Core::MessageItem::NotSigned );
     break;
   }
+}
 
-  if ( !clr.isValid() )
-  {
-    if ( stat.isNew() )
-      clr = mColorNewMessage;
-    else if ( stat.isUnread() )
-      clr = mColorUnreadMessage;
-    else if ( stat.isImportant() )
-      clr = mColorImportantMessage;
-    else if ( stat.isToAct() )
-      clr = mColorToDoMessage;
-  }
+bool StorageModel::initializeMessageItem( Core::MessageItem * mi, int row, bool bUseReceiver ) const
+{
+  KMMsgBase * msg = mFolder->getMsgBase( row );
+  if ( !msg )
+    return false;
 
-  if ( clr.isValid() )
-    mi->setTextColor( clr );
+  QString sender = msg->fromStrip();
+  QString receiver = msg->toStrip();
 
+  // Static for speed reasons
+  static const QString noSubject = i18nc( "displayed as subject when the subject of a mail is empty", "No Subject" );
+  static const QString unknown( i18nc( "displayed when a mail has unknown sender, receiver or date", "Unknown" ) );
+
+  if ( sender.isEmpty() )
+    sender = unknown;
+  if ( receiver.isEmpty() )
+    receiver = unknown;
+
+  mi->initialSetup(
+      msg->date(),
+      mFolder->folderType() == KMFolderTypeImap ? msg->msgSizeServer() : msg->msgSize(),
+      sender, receiver,
+      bUseReceiver ? receiver : sender
+    );
+
+  mi->setUniqueId( msg->getMsgSerNum() );
+
+  KPIM::MessageStatus stat = msg->messageStatus();
+
+  QString subject = msg->subject();
+  if ( subject.isEmpty() )
+    subject = '(' + noSubject + ')';
+  mi->setSubjectAndStatus( subject, stat );
+
+  setMessageItemData( mi, msg );
+
   return true;
 }
 
@@ -429,99 +445,53 @@
     mi->recomputeMaxDate();
   }
 
-  QColor clr;
-
   KPIM::MessageStatus stat = msg->messageStatus();
 
   mi->setStatus( stat );
 
-  switch ( msg->encryptionState() )
-  {
-    case KMMsgFullyEncrypted:
-      mi->setEncryptionState( Core::MessageItem::FullyEncrypted );
-    break;
-    case KMMsgPartiallyEncrypted:
-      mi->setEncryptionState( Core::MessageItem::PartiallyEncrypted );
-    break;
-    case KMMsgEncryptionStateUnknown:
-    case KMMsgEncryptionProblematic:
-      mi->setEncryptionState( Core::MessageItem::EncryptionStateUnknown );
-    break;
-    default:
-      mi->setEncryptionState( Core::MessageItem::NotEncrypted );
-    break;
-  }
+  setMessageItemData( mi, msg );
+}
 
-  switch ( msg->signatureState() )
-  {
-    case KMMsgFullySigned:
-      mi->setSignatureState( Core::MessageItem::FullySigned );
-    break;
-    case KMMsgPartiallySigned:
-      mi->setSignatureState( Core::MessageItem::PartiallySigned );
-    break;
-    case KMMsgSignatureStateUnknown:
-    case KMMsgSignatureProblematic:
-      mi->setSignatureState( Core::MessageItem::SignatureStateUnknown );
-    break;
-    default:
-      mi->setSignatureState( Core::MessageItem::NotSigned );
-    break;
-  }
+void StorageModel::setMessageItemData( Core::MessageItem * mi, KMMsgBase * msg ) const
+{
+  setMessageItemEncryptionState( mi, msg );
+  setMessageItemSignatureState( mi, msg );
 
-  QList< Core::MessageItem::Tag * > * tagList = 0;
-
-  if ( msg->tagList() )
-  {
-    if ( !msg->tagList()->isEmpty() )
-    {
-      int bestPriority = -0xfffff;
-
-      tagList = new QList< Core::MessageItem::Tag * >();
-      for ( KMMessageTagList::Iterator it = msg->tagList()->begin(); it != msg->tagList()->end(); ++it )
-      {
-        const KMMessageTagDescription * description = kmkernel->msgTagMgr()->find( *it );
-        if ( description )
-        {
-          if ( ( bestPriority < description->priority() ) || ( !clr.isValid() ) )
-          {
-            clr = description->textColor();
-            bestPriority = description->priority();
-          }
-
-          Core::MessageItem::Tag * tag;
-          if ( description->toolbarIconName().isEmpty() )
-            tag = new Core::MessageItem::Tag( SmallIcon( "feed-subscribe" ), description->name(), *it );
-          else
-            tag = new Core::MessageItem::Tag( SmallIcon( description->toolbarIconName() ), description->name(), *it );
-          tagList->append( tag );
-        }
-      }
-      if ( tagList->isEmpty() )
-      {
-        delete tagList;
-        tagList = 0;
-      }
-    }
-  }
-
+  QColor clr;
+  QColor backClr;
+  QList< Core::MessageItem::Tag * > * tagList;
+  tagList = fillTagList( msg, clr, backClr );
   mi->setTagList( tagList );
 
+  KPIM::MessageStatus stat = msg->messageStatus();
+
   if ( !clr.isValid() )
   {
-    if ( stat.isNew() )
+    // from KDE3: "important" overrides "new" overrides "unread" overrides "todo"
+    if ( stat.isImportant() )
+      clr = mColorImportantMessage;
+    else if ( stat.isNew() )
       clr = mColorNewMessage;
     else if ( stat.isUnread() )
       clr = mColorUnreadMessage;
-    else if ( stat.isImportant() )
-      clr = mColorImportantMessage;
     else if ( stat.isToAct() )
       clr = mColorToDoMessage;
   }
 
   mi->setTextColor( clr ); // set even if invalid (->default color)
+  mi->setBackgroundColor( backClr );
 
-  // FIXME: Handle MDN State ?
+  // from KDE3: "important" overrides "new" overrides "unread" overrides "todo"
+  if ( stat.isImportant() )
+    mi->setFont( mFontImportantMessage );
+  else if ( stat.isNew() )
+    mi->setFont( mFontNewMessage );
+  else if ( stat.isUnread() )
+    mi->setFont( mFontUnreadMessage );
+  else if ( stat.isToAct() )
+    mi->setFont( mFontToDoMessage );
+  else
+    mi->setFont( mFont );
 }
 
 void StorageModel::fillMessageItemThreadingData( Core::MessageItem * mi, int row, ThreadingDataSubset subset ) const
Index: kmail/messagelistview/core/model.cpp
===================================================================
--- kmail/messagelistview/core/model.cpp	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ kmail/messagelistview/core/model.cpp	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -48,6 +48,7 @@
 #include "messagelistview/core/theme.h"
 #include "messagelistview/core/manager.h"
 #include "messagelistview/core/messageitemsetmanager.h"
+#include "util.h"
 
 #include <config-kmail.h>
 
@@ -255,6 +256,7 @@
 
 Model::Model( View *pParent )
   : QAbstractItemModel( pParent ),
+    mRecursionCounterForReset( 0 ),
     mStorageModel( 0 ), mView( pParent )
 {
   mAggregation = 0;
@@ -449,17 +451,24 @@
   if ( !column )
     return QVariant();
 
- if ( role != Qt::DisplayRole )
-    return QVariant();
-
-  if ( mStorageModel && column->isSenderOrReceiver() )
+  if ( mStorageModel && column->isSenderOrReceiver() &&
+       ( role == Qt::DisplayRole ) )
   {
     if ( mStorageModelContainsOutboundMessages )
       return QVariant( i18n( "Receiver" ) );
     return QVariant( i18n( "Sender" ) );
   }
 
-  return QVariant( column->label() );
+  if ( ( role == Qt::DisplayRole ) && column->pixmapName().isEmpty() )
+    return QVariant( column->label() );
+
+  if ( ( role == Qt::ToolTipRole ) && !column->pixmapName().isEmpty() )
+    return QVariant( column->label() );
+
+  if ( ( role == Qt::DecorationRole ) && !column->pixmapName().isEmpty() )
+    return QVariant( SmallIcon( column->pixmapName() ) );
+
+  return QVariant();
 }
 
 QModelIndex Model::index( Item *item, int column ) const
@@ -557,6 +566,12 @@
 
 void Model::setStorageModel( StorageModel *storageModel, PreSelectionMode preSelectionMode )
 {
+  // Prevent a case of recursion when opening a folder that has a message and the folder was
+  // never opened before.
+  KMail::Util::RecursionPreventer preventer( mRecursionCounterForReset );
+  if ( preventer.isRecursive() )
+    return;
+
   if( mFillStepTimer.isActive() )
     mFillStepTimer.stop();
 
@@ -3229,8 +3244,6 @@
   // The end index of our work.
   int endIndex = job->endIndex();
 
-  bool viewportNeedsUpdate = false;
-
   while( curIndex <= endIndex )
   {
     // Get the underlying storage message data...
@@ -3261,6 +3274,8 @@
 
     // Do update
     mStorageModel->updateMessageItemData( message, row );
+    QModelIndex idx = index( message, 0 );
+    emit dataChanged( idx, idx );
 
     // Reinsert the item to the cache, if needed
     if( mAggregation->threading() == Aggregation::PerfectReferencesAndSubject )
@@ -3281,22 +3296,6 @@
     if ( propertyChangeMask )
     {
       // Some message data has changed
-      // We could emit dataChanged() so the viewport would be updated...
-      // but this is AGAIN a huge performance cost. Since we don't actually
-      // use the standard painting code nothing will screw up if we don't
-      // emit this signal (I hope.. :D). We just set a flag that will cause
-      // us to update the viewport on exit instead.
-      //
-      // ... hm.. now that I think of it.. what the heck is the meaning of
-      // topLeft and bottomRight parameters of dataChanged() in a tree ?
-      // I guess that it should be always topLeft == bottomRight == itemIndex...
-      // But anyway, the view jumps like crazy when this signal is emitted.
-
-      // QModelIndex idx = index( message, 0 );
-      // emit dataChanged( idx, idx );
-
-      viewportNeedsUpdate = true;
-
       // now we need to handle the changes that might cause re-grouping/re-sorting
       // and propagate them to the parents.
 
@@ -3366,16 +3365,12 @@
         if ( curIndex <= endIndex )
         {
           job->setCurrentIndex( curIndex );
-          if ( viewportNeedsUpdate )
-            mView->viewport()->update();
           return ViewItemJobInterrupted;
         }
       }
     }
   }
 
-  if ( viewportNeedsUpdate )
-    mView->viewport()->update();
   return ViewItemJobCompleted;
 }
 
Index: kmail/messagelistview/core/item.h
===================================================================
--- kmail/messagelistview/core/item.h	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ kmail/messagelistview/core/item.h	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -29,6 +29,8 @@
 
 #include <libkdepim/messagestatus.h>
 
+#include <kmmsgbase.h>
+
 #include "messagelistview/core/model.h"
 
 // See the MessageListView::Item::insertChildItem() function below for an explaination of this macro.
@@ -731,7 +733,8 @@
 public:
   static inline bool firstGreaterOrEqual( Item * first, Item * second )
   {
-    int ret = first->subject().compare( second->subject(), Qt::CaseInsensitive );
+    int ret = KMMsgBase::stripOffPrefixes( first->subject() ).
+                compare( KMMsgBase::stripOffPrefixes( second->subject() ), Qt::CaseInsensitive );
     if ( ret < 0 )
       return false;
     // compare by date when subjects are equal
Index: kmail/messagelistview/core/theme.h
===================================================================
--- kmail/messagelistview/core/theme.h	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ kmail/messagelistview/core/theme.h	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -237,10 +237,6 @@
 
      QFont mFont;                     ///< The font to use with this content item, meaningful only if displaysText() returns true.
      QColor mCustomColor;             ///< The color to use with this content item, meaningful only if canUseCustomColor() return true.
-     // Cache stuff
-     QPaintDevice * mLastPaintDevice; ///< The last paint device that used this content item (this is usually set only once)
-     QFontMetrics mFontMetrics;       ///< Our font metrics cache (kept updated to the last QPaintDevice that uses this ContentItem)
-     int mLineSpacing;                ///< The line spacing in mFontMetrics, this is a value we use a lot (so by caching it we can avoid a function call)
 
   public:
     /**
@@ -437,46 +433,6 @@
     // so for portability we're using a public interface also here.
 
     /**
-     * The last QPaintDevice that made use of this item.
-     * This function is used by ThemeDelegate for QFontMetrics caching purposes.
-     */
-    const QPaintDevice * lastPaintDevice() const
-      { return mLastPaintDevice; };
-
-    /**
-     * Updates the font metrics cache for this item by recreating them
-     * for the currently set font and the specified QPaintDevice.
-     * This function will also reset the font to the KGlobalSettings::generalFont()
-     * if you haven't called setUseCustomFont().
-     * This function is used by ThemeDelegate, you usually don't need to care.
-     */
-    void updateFontMetrics( QPaintDevice * device );
-
-    /**
-     * Returns the cached font metrics attacched to this content item.
-     * The font metrics must be kept up-to-date by the means of the updateFontMetrics()
-     * function whenever the QPaintDevice that this ContentItem is painted
-     * on is different than lastPaintDevice(). This is done by ThemeDelegate
-     * and in fact you shouldn't care.
-     */
-    const QFontMetrics & fontMetrics() const
-      { return mFontMetrics; };
-
-    /**
-     * Returns the cached font metrics line spacing for this content item.
-     * The line spacing is used really often in ThemeDelegate so this
-     * inlineable getter will help the compiler in optimizing stuff.
-     */
-    int lineSpacing() const
-      { return mLineSpacing; };
-
-    /**
-     * Resets the cache of this content item.
-     * This is called by the Theme::Row resetCache() method.
-     */
-    void resetCache();
-
-    /**
      * Handles content item saving (used by Theme::Row::save())
      */
     void save( QDataStream &stream ) const;
@@ -502,7 +458,6 @@
   private:
     QList< ContentItem * > mLeftItems;   ///< The list of left aligned items
     QList< ContentItem * > mRightItems;  ///< The list of right aligned items
-    QSize mSizeHint;                     ///< The size hint for this row: the height is the sufficient minimum, the width is a guess, invalid size when not computed
 
   public:
     /**
@@ -569,19 +524,6 @@
       { mRightItems.removeAll( item ); };
 
     /**
-     * Returns the cached size hint for this row. The returned size is invalid
-     * if no cached size hint has been set yet.
-     */
-    QSize sizeHint() const
-      { return mSizeHint; };
-
-    /**
-     * Sets the cached size hint for this row.
-     */
-    void setSizeHint( const QSize &s )
-      { mSizeHint = s; };
-
-    /**
      * Returns true if this row contains text items.
      * This is useful if you want to know if the column should just get
      * its minimum allowable space or it should get more.
@@ -589,11 +531,6 @@
     bool containsTextItems() const;
 
     /**
-     * Called from the Column's resetCache() method. You shouldn't need to care.
-     */
-    void resetCache();
-
-    /**
      * Handles row saving (used by Theme::Column::save())
      */
     void save( QDataStream &stream ) const;
@@ -707,14 +644,13 @@
 
   private:
     QString mLabel;                                   ///< The label visible in the column header
+    QString mPixmapName;                              ///< The icon's name visible in the column header if it was set
     bool mVisibleByDefault;                           ///< Is this column visible by default ?
     bool mIsSenderOrReceiver;                         ///< If this column displays the sender/receiver field then we will update its label on the fly
     SortOrder::MessageSorting mMessageSorting;        ///< The message sort order we switch to when clicking on this column
     QList< Row * > mGroupHeaderRows;                  ///< The list of rows we display in this column for a GroupHeaderItem
     QList< Row * > mMessageRows;                      ///< The list of rows we display in this column for a MessageItem
-    // cache
-    QSize mGroupHeaderSizeHint;                       ///< The cached size hint for group header rows: invalid if not computed yet
-    QSize mMessageSizeHint;                           ///< The cached size hint for message rows: invalid if not computed yet
+
     SharedRuntimeData * mSharedRuntimeData;           ///< A pointer to the shared runtime data: shared between all instances of a theme with the same id
   public:
     /**
@@ -730,6 +666,18 @@
       { mLabel = label; };
 
     /**
+     * Returns the icon's name (used in SmallIcon) set for this column
+     */
+    const QString & pixmapName() const
+      { return mPixmapName; }
+
+    /**
+     * Sets the icon's name (used in SmallIcon) for this column
+     */
+    void setPixmapName( const QString &pixmapName )
+      { mPixmapName = pixmapName; };
+
+    /**
      * Returns true if this column is marked as "sender/receiver" and we should
      * update its label on-the-fly.
      */
@@ -872,38 +820,6 @@
     bool containsTextItems() const;
 
     /**
-     * This is called by the Theme when it's resetCache() method is called.
-     * You shouldn't need to care about this.
-     */
-    void resetCache();
-
-    /**
-     * Returns the cached size hint for group header rows in this column
-     * or an invalid QSize if the cached size hint hasn't been set yet.
-     */
-    QSize groupHeaderSizeHint() const
-      { return mGroupHeaderSizeHint; };
-
-    /**
-     * Sets the cached size hint for group header rows in this column.
-     */
-    void setGroupHeaderSizeHint( const QSize &sh )
-      { mGroupHeaderSizeHint = sh; };
-
-    /**
-     * Returns the cached size hint for message rows in this column
-     * or an invalid QSize if the cached size hint hasn't been set yet.
-     */
-    QSize messageSizeHint() const
-      { return mMessageSizeHint; };
-
-    /**
-     * Sets the cached size hint for message rows in this column.
-     */
-    void setMessageSizeHint( const QSize &sh )
-      { mMessageSizeHint = sh; };
-
-    /**
      * Handles column saving (used by Theme::save())
      */
     void save( QDataStream &stream ) const;
@@ -1113,14 +1029,6 @@
    */
   static QList< QPair< QString, int > > enumerateViewHeaderPolicyOptions();
 
-  /**
-   * Resets the cache for this theme. This is called by the ThemeDelegate
-   * when the theme is applied and must be called before any changes to this
-   * theme are going to be painted (that is, apply a chunk of changes, call
-   * resetCache() then repaint.
-   */
-  void resetCache();
-
 protected:
   /**
    * Pure virtual reimplemented from OptionSet.
Index: kmail/messagelistview/core/messageitem.h
===================================================================
--- kmail/messagelistview/core/messageitem.h	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ kmail/messagelistview/core/messageitem.h	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -101,6 +101,8 @@
   SignatureState mSignatureState;
   QList< Tag * > * mTagList;        ///< Usually 0....
   QColor mTextColor;                ///< If invalid, use default text color
+  QColor mBackgroundColor;          ///< If invalid, use default background color
+  QFont  mFont;
   unsigned long mUniqueId;          ///< The unique id of this message (serial number of KMMsgBase at the moment of writing)
   
   bool mAboutToBeRemoved;           ///< Set to true when this item is going to be deleted and shouldn't be selectable
@@ -130,9 +132,21 @@
   const QColor & textColor() const
     { return mTextColor; };
 
+  const QColor & backgroundColor() const
+    { return mBackgroundColor; };
+
+  const QFont &font() const
+    { return mFont; }
+
   void setTextColor( const QColor &clr )
     { mTextColor = clr; };
 
+  void setBackgroundColor( const QColor &clr )
+    { mBackgroundColor = clr; };
+
+  void setFont( const QFont &f )
+    { mFont = f; }
+
   SignatureState signatureState() const
     { return mSignatureState; };
 
Index: kmail/messagelistview/core/themeeditor.cpp
===================================================================
--- kmail/messagelistview/core/themeeditor.cpp	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ kmail/messagelistview/core/themeeditor.cpp	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -189,8 +189,8 @@
   drag->exec( Qt::CopyAction, Qt::CopyAction );
 }
 
-ThemePreviewDelegate::ThemePreviewDelegate( QAbstractItemView * parent, QPaintDevice * paintDevice )
-  : ThemeDelegate( parent, paintDevice )
+ThemePreviewDelegate::ThemePreviewDelegate( QAbstractItemView * parent )
+  : ThemeDelegate( parent )
 {
   mRowMapper = new ModelInvariantRowMapper();
 
@@ -263,7 +263,7 @@
   mSelectedThemeColumn = 0;
   mFirstShow = true;
 
-  mDelegate = new ThemePreviewDelegate( this, viewport() );
+  mDelegate = new ThemePreviewDelegate( this );
   setItemDelegate( mDelegate );
   setRootIsDecorated( false );
   viewport()->setAcceptDrops( true );
Index: kmail/messagelistview/core/delegate.cpp
===================================================================
--- kmail/messagelistview/core/delegate.cpp	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ kmail/messagelistview/core/delegate.cpp	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -34,7 +34,7 @@
 {
 
 Delegate::Delegate( View *pParent )
-  : ThemeDelegate( pParent, pParent->viewport() )
+  : ThemeDelegate( pParent )
 {
 }
 
Index: kmail/messagelistview/core/view.cpp
===================================================================
--- kmail/messagelistview/core/view.cpp	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ kmail/messagelistview/core/view.cpp	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -38,6 +38,7 @@
 #include <QToolTip>
 #include <QHeaderView>
 #include <QTimer>
+#include <QTextDocument>
 
 #include <KMenu>
 #include <KLocale>
@@ -101,7 +102,8 @@
   connect( selectionModel(), SIGNAL( selectionChanged( const QItemSelection &, const QItemSelection & ) ),
            this, SLOT( slotSelectionChanged( const QItemSelection &, const QItemSelection & ) ) );
 
-
+  // as in KDE3, when a root-item of a message thread is expanded, expand all children
+  connect( this, SIGNAL( expanded ( const QModelIndex & ) ), this, SLOT( expandFullThread( const QModelIndex & ) ) );
 }
 
 View::~View()
@@ -865,6 +867,20 @@
   }
 }
 
+void View::expandFullThread( const QModelIndex & index )
+{
+  if ( ! index.isValid() )
+    return;
+
+  Item * item = static_cast< Item * >( index.internalPointer() );
+  if ( item->type() != Item::Message )
+    return;
+
+  if ( ! static_cast< MessageItem * >( item )->parent() ||
+       ( static_cast< MessageItem * >( item )->parent()->type() != Item::Message ) )
+    setChildrenExpanded( item, true );
+}
+
 void View::setCurrentThreadExpanded( bool expand )
 {
   MessageItem * message = currentMessageItem();
@@ -2157,7 +2173,7 @@
                 "</div>" \
               "</td>" \
             "</tr>"
-        ).arg( txtColorName ).arg( bckColorName ).arg( mi->subject() );
+        ).arg( txtColorName ).arg( bckColorName ).arg( Qt::escape( mi->subject() ) );
 
       tip += QString::fromLatin1(
            "<tr>" \
Index: kmail/messagelistview/core/aggregation.cpp
===================================================================
--- kmail/messagelistview/core/aggregation.cpp	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ kmail/messagelistview/core/aggregation.cpp	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -216,7 +216,7 @@
   ret.append( QPair< QString, int >( i18n( "By Smart Date Ranges (of Thread Leaders)" ), GroupByDateRange ) );
   ret.append( QPair< QString, int >( i18n( "By Smart Sender/Receiver" ), GroupBySenderOrReceiver ) );
   ret.append( QPair< QString, int >( i18n( "By Sender" ), GroupBySender ) );
-  ret.append( QPair< QString, int >( i18n( "By Receiver" ), GroupBySender ) );
+  ret.append( QPair< QString, int >( i18n( "By Receiver" ), GroupByReceiver ) );
   return ret;
 }
 
Index: kmail/messagelistview/core/themedelegate.h
===================================================================
--- kmail/messagelistview/core/themedelegate.h	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ kmail/messagelistview/core/themedelegate.h	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -29,7 +29,6 @@
 #include "messagelistview/core/item.h"
 
 class QAbstractItemView;
-class QPaintDevice;
 
 namespace KMail
 {
@@ -49,13 +48,12 @@
 class ThemeDelegate : public QStyledItemDelegate
 {
 public:
-  ThemeDelegate( QAbstractItemView * parent, QPaintDevice * paintDevice );
+  ThemeDelegate( QAbstractItemView * parent );
   ~ThemeDelegate();
 
 private:
   const Theme * mTheme; ///< Shallow pointer to the current theme
   QAbstractItemView * mItemView;
-  QPaintDevice * mPaintDevice;
 
   QColor mGroupHeaderBackgroundColor; // cache
 
@@ -71,6 +69,7 @@
   bool mHitContentItemRight;
   const Theme::ContentItem * mHitContentItem;
   QRect mHitContentItemRect;
+
 public:
   const Theme * theme() const
     { return mTheme; };
@@ -80,7 +79,7 @@
    * Returns a heuristic sizeHint() for the specified item type and column.
    * The hint is based on the contents of the theme (and not of any message or group header).
    */
-  QSize sizeHintForItemTypeAndColumn( Item::Type type, int column ) const;
+  QSize sizeHintForItemTypeAndColumn( Item::Type type, int column, const Item *item = 0) const;
 
   /**
    * Performs a hit test on the specified viewport point.
@@ -195,6 +194,9 @@
   QRect hitContentItemRect() const
     { return mHitContentItemRect; };
 
+  /// return the font to paint given item with, checking global kmail settings and theme settings
+  static QFont itemFont( const Theme::ContentItem *ci, const Item *item );
+
 protected:
   /**
    * Returns the Item for the specified model index. Pure virtual: must be reimplemented
Index: kmail/messagelistview/core/theme.cpp
===================================================================
--- kmail/messagelistview/core/theme.cpp	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ kmail/messagelistview/core/theme.cpp	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -49,20 +49,22 @@
 //  0x1014  12.11.2008      Added runtime column data: width and column visibility
 //  0x1015  03.03.2009      Added icon size
 //  0x1016  08.03.2009      Added support for sorting by New/Unread status
+//  0x1017  16.08.2009      Added support for column icon
 //
-static const int gThemeCurrentVersion = 0x1016; // increase if you add new fields of change the meaning of some
+static const int gThemeCurrentVersion = 0x1017; // increase if you add new fields or change the meaning of some
 // you don't need to change the values below, but you might want to add new ones
 static const int gThemeMinimumSupportedVersion = 0x1013;
 static const int gThemeMinimumVersionWithColumnRuntimeData = 0x1014;
 static const int gThemeMinimumVersionWithIconSizeField = 0x1015;
 static const int gThemeMinimumVersionWithSortingByNewUnreadStatusAllowed = 0x1016;
+static const int gThemeMinimumVersionWithColumnIcon = 0x1017;
 
 // the default icon size
 static const int gThemeDefaultIconSize = 16;
 
 
 Theme::ContentItem::ContentItem( Type type )
-  : mType( type ), mFlags( 0 ), mLastPaintDevice( 0 ), mFontMetrics( QFont() )
+  : mType( type ), mFlags( 0 )
 {
 }
 
@@ -70,10 +72,7 @@
   : mType( src.mType ),
     mFlags( src.mFlags ),
     mFont( src.mFont ),
-    mCustomColor( src.mCustomColor ),
-    mLastPaintDevice( src.mLastPaintDevice ),
-    mFontMetrics( src.mFontMetrics ),
-    mLineSpacing( src.mLineSpacing )
+    mCustomColor( src.mCustomColor )
 {
 }
 
@@ -164,27 +163,11 @@
   return ( static_cast< int >( type ) & ApplicableToGroupHeaderItems );
 }
 
-
-void Theme::ContentItem::updateFontMetrics( QPaintDevice * device )
-{
-  if ( !( mFlags & UseCustomFont ) )
-    mFont = KGlobalSettings::generalFont();
-  mLastPaintDevice = device;
-  mFontMetrics = QFontMetrics( mFont, device );
-  mLineSpacing = mFontMetrics.lineSpacing();
-}
-
 void Theme::ContentItem::setFont( const QFont &font )
 {
   mFont = font;
-  mLastPaintDevice = 0; // will force regeneration of font metrics
 }
 
-void Theme::ContentItem::resetCache()
-{
-  mLastPaintDevice = 0; // will force regeneration of font metrics
-}
-
 void Theme::ContentItem::save( QDataStream &stream ) const
 {
   stream << (int)mType;
@@ -296,15 +279,6 @@
   mRightItems.insert( idx, item );
 }
 
-void Theme::Row::resetCache()
-{
-  mSizeHint = QSize();
-  for ( QList< ContentItem * >::ConstIterator it = mLeftItems.constBegin(); it != mLeftItems.constEnd() ; ++it )
-    ( *it )->resetCache();
-  for ( QList< ContentItem * >::ConstIterator it = mRightItems.constBegin(); it != mRightItems.constEnd() ; ++it )
-    ( *it )->resetCache();
-}
-
 bool Theme::Row::containsTextItems() const
 {
   for ( QList< ContentItem * >::ConstIterator it = mLeftItems.constBegin(); it != mLeftItems.constEnd() ; ++it )
@@ -444,6 +418,7 @@
 Theme::Column::Column( const Column &src )
 {
   mLabel = src.mLabel;
+  mPixmapName = src.mPixmapName;
   mVisibleByDefault = src.mVisibleByDefault;
   mIsSenderOrReceiver = src.mIsSenderOrReceiver;
   mMessageSorting = src.mMessageSorting;
@@ -508,17 +483,6 @@
   mGroupHeaderRows.insert( idx, row );
 }
 
-void Theme::Column::resetCache()
-{
-  mGroupHeaderSizeHint = QSize();
-  mMessageSizeHint = QSize();
-
-  for ( QList< Row * >::ConstIterator it = mMessageRows.constBegin(); it != mMessageRows.constEnd() ; ++it )
-    ( *it )->resetCache();
-  for ( QList< Row * >::ConstIterator it = mGroupHeaderRows.constBegin(); it != mGroupHeaderRows.constEnd() ; ++it )
-    ( *it )->resetCache();
-}
-
 bool Theme::Column::containsTextItems() const
 {
   for ( QList< Row * >::ConstIterator it = mMessageRows.constBegin(); it != mMessageRows.constEnd() ; ++it )
@@ -537,6 +501,7 @@
 void Theme::Column::save( QDataStream &stream ) const
 {
   stream << mLabel;
+  stream << mPixmapName;
   stream << mVisibleByDefault;
   stream << mIsSenderOrReceiver;
   stream << (int)mMessageSorting;
@@ -572,6 +537,10 @@
   removeAllMessageRows();
 
   stream >> mLabel;
+
+  if ( themeVersion >= gThemeMinimumVersionWithColumnIcon )
+    stream >> mPixmapName;
+
   stream >> mVisibleByDefault;
   stream >> mIsSenderOrReceiver;
 
@@ -769,12 +738,6 @@
     mIconSize = gThemeDefaultIconSize;
 }
 
-void Theme::resetCache()
-{
-  for ( QList< Column * >::ConstIterator it = mColumns.constBegin(); it != mColumns.constEnd() ; ++it )
-    ( *it )->resetCache();
-}
-
 bool Theme::load( QDataStream &stream )
 {
   removeAllColumns();
Index: kmail/messagelistview/core/model.h
===================================================================
--- kmail/messagelistview/core/model.h	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ kmail/messagelistview/core/model.h	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -96,6 +96,9 @@
 
 private:
 
+  /** counter to avoid infinite recursions in the setStorageModel() function */
+  int mRecursionCounterForReset;
+
   /**
    * The currently set storage model: shallow pointer.
    */
Index: kmail/messagelistview/core/manager.cpp
===================================================================
--- kmail/messagelistview/core/manager.cpp	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ kmail/messagelistview/core/manager.cpp	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -116,6 +116,7 @@
 
   saveConfiguration();
   removeAllAggregations();
+  removeAllThemes(); 
 
   delete mHeartBeatTimer;
 
@@ -634,10 +635,11 @@
   return c;
 }
 
-static Theme::Column * add_theme_simple_icon_column( Theme * s, const QString &name, Theme::ContentItem::Type type, bool visibleByDefault, SortOrder::MessageSorting messageSorting )
+static Theme::Column * add_theme_simple_icon_column( Theme * s, const QString &name, const QString &pixmapName, Theme::ContentItem::Type type, bool visibleByDefault, SortOrder::MessageSorting messageSorting )
 {
   Theme::Column * c = new Theme::Column();
   c->setLabel( name );
+  c->setPixmapName( pixmapName );
   c->setVisibleByDefault( visibleByDefault );
   c->setMessageSorting( messageSorting );
 
@@ -710,16 +712,16 @@
   add_theme_simple_text_column( s, i18nc( "Date of a message", "Date" ), Theme::ContentItem::Date, true, SortOrder::SortMessagesByDateTime, false, false );
   add_theme_simple_text_column( s, i18n( "Most Recent Date" ), Theme::ContentItem::MostRecentDate, false, SortOrder::SortMessagesByDateTimeOfMostRecent, false, true );
   add_theme_simple_text_column( s, i18nc( "Size of a message", "Size" ), Theme::ContentItem::Size, false, SortOrder::SortMessagesBySize, false, false );
-  add_theme_simple_icon_column( s, i18nc( "Attachement indication", "Attachment" ), Theme::ContentItem::AttachmentStateIcon, false, SortOrder::NoMessageSorting );
-  add_theme_simple_icon_column( s, i18n( "New/Unread" ), Theme::ContentItem::ReadStateIcon, false, SortOrder::SortMessagesByNewUnreadStatus );
-  add_theme_simple_icon_column( s, i18n( "Replied" ), Theme::ContentItem::RepliedStateIcon, false, SortOrder::NoMessageSorting );
-  add_theme_simple_icon_column( s, i18nc( "Message importance indication", "Important" ), Theme::ContentItem::ImportantStateIcon, false, SortOrder::NoMessageSorting );
-  add_theme_simple_icon_column( s, i18n( "Action Item" ), Theme::ContentItem::ActionItemStateIcon, false, SortOrder::SortMessagesByActionItemStatus );
-  add_theme_simple_icon_column( s, i18n( "Spam/Ham" ), Theme::ContentItem::SpamHamStateIcon, false, SortOrder::NoMessageSorting );
-  add_theme_simple_icon_column( s, i18n( "Watched/Ignored" ), Theme::ContentItem::WatchedIgnoredStateIcon, false, SortOrder::NoMessageSorting );
-  add_theme_simple_icon_column( s, i18n( "Encryption" ), Theme::ContentItem::EncryptionStateIcon, false, SortOrder::NoMessageSorting );
-  add_theme_simple_icon_column( s, i18n( "Signature" ), Theme::ContentItem::SignatureStateIcon, false, SortOrder::NoMessageSorting );
-  add_theme_simple_icon_column( s, i18n( "Tag List" ), Theme::ContentItem::TagList, false, SortOrder::NoMessageSorting );
+  add_theme_simple_icon_column( s, i18nc( "Attachement indication", "Attachment" ), "mail-attachment", Theme::ContentItem::AttachmentStateIcon, false, SortOrder::NoMessageSorting );
+  add_theme_simple_icon_column( s, i18n( "New/Unread" ), "mail-unread-new", Theme::ContentItem::ReadStateIcon, false, SortOrder::SortMessagesByNewUnreadStatus );
+  add_theme_simple_icon_column( s, i18n( "Replied" ), "mail-replied", Theme::ContentItem::RepliedStateIcon, false, SortOrder::NoMessageSorting );
+  add_theme_simple_icon_column( s, i18nc( "Message importance indication", "Important" ), "emblem-important", Theme::ContentItem::ImportantStateIcon, false, SortOrder::NoMessageSorting );
+  add_theme_simple_icon_column( s, i18n( "Action Item" ), "mail-task", Theme::ContentItem::ActionItemStateIcon, false, SortOrder::SortMessagesByActionItemStatus );
+  add_theme_simple_icon_column( s, i18n( "Spam/Ham" ), "mail-mark-junk", Theme::ContentItem::SpamHamStateIcon, false, SortOrder::NoMessageSorting );
+  add_theme_simple_icon_column( s, i18n( "Watched/Ignored" ), "mail-thread-watch", Theme::ContentItem::WatchedIgnoredStateIcon, false, SortOrder::NoMessageSorting );
+  add_theme_simple_icon_column( s, i18n( "Encryption" ), "mail-encrypted-full", Theme::ContentItem::EncryptionStateIcon, false, SortOrder::NoMessageSorting );
+  add_theme_simple_icon_column( s, i18n( "Signature" ), "mail-signed-verified", Theme::ContentItem::SignatureStateIcon, false, SortOrder::NoMessageSorting );
+  add_theme_simple_icon_column( s, i18n( "Tag List" ), "feed-subscribe", Theme::ContentItem::TagList, false, SortOrder::NoMessageSorting );
 
   s->resetColumnState(); // so it's initially set from defaults
 
Index: kmail/messagelistview/core/themeeditor.h
===================================================================
--- kmail/messagelistview/core/themeeditor.h	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ kmail/messagelistview/core/themeeditor.h	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -73,7 +73,7 @@
 {
   Q_OBJECT
 public:
-  ThemePreviewDelegate( QAbstractItemView * parent, QPaintDevice * paintDevice );
+  ThemePreviewDelegate( QAbstractItemView * parent );
   ~ThemePreviewDelegate();
 
 private:
Index: kmail/messagelistview/core/widgetbase.cpp
===================================================================
--- kmail/messagelistview/core/widgetbase.cpp	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ kmail/messagelistview/core/widgetbase.cpp	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -680,14 +680,14 @@
     // try to find the specified message sorting in the theme columns
     const QList< Theme::Column * > & columns = mTheme->columns();
     int idx = 0;
+
+    // First try with a well defined message sorting.
+
     foreach( const Theme::Column* column, columns )
     {
       if ( !mView->header()->isSectionHidden( idx ) )
       {
-        if ( ( column->messageSorting() == messageSorting ||
-             ( column->messageSorting() == SortOrder::SortMessagesBySenderOrReceiver ) ) &&
-              ( messageSorting == SortOrder::SortMessagesByReceiver ||
-                messageSorting == SortOrder::SortMessagesBySender ) )
+        if ( column->messageSorting() == messageSorting )
         {
           // found a visible column with this message sorting
           logicalHeaderColumnIndex = idx;
@@ -696,6 +696,36 @@
       }
       ++idx;
     }
+
+    // if still not found, try again with a wider range
+    if ( logicalHeaderColumnIndex == 1 )
+    {
+      idx = 0;
+      foreach( const Theme::Column* column, columns )
+      {
+        if ( !mView->header()->isSectionHidden( idx ) )
+        {
+          if (
+               (
+                 ( column->messageSorting() == SortOrder::SortMessagesBySenderOrReceiver ) ||
+                 ( column->messageSorting() == SortOrder::SortMessagesByReceiver ) ||
+                 ( column->messageSorting() == SortOrder::SortMessagesBySender )
+               ) && 
+               (
+                 ( messageSorting == SortOrder::SortMessagesBySenderOrReceiver ) ||
+                 ( messageSorting == SortOrder::SortMessagesByReceiver ) ||
+                 ( messageSorting == SortOrder::SortMessagesBySender )
+               )
+             )
+          {
+            // found a visible column with this message sorting
+            logicalHeaderColumnIndex = idx;
+            break;
+          }
+        }
+        ++idx;
+      }
+    }
   }
 
   if ( logicalHeaderColumnIndex == -1 )
@@ -706,6 +736,7 @@
   }
 
   mView->header()->setSortIndicatorShown( true );
+
   if ( sortDirection == SortOrder::Ascending )
     mView->header()->setSortIndicator( logicalHeaderColumnIndex, Qt::AscendingOrder );
   else
Index: kmail/messagelistview/core/view.h
===================================================================
--- kmail/messagelistview/core/view.h	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ kmail/messagelistview/core/view.h	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -607,6 +607,10 @@
    */
   void applyThemeColumns();
 
+private slots:
+  /// expand the whole thread (including all child messages)
+  void expandFullThread( const QModelIndex & );
+
 }; // class View
 
 } // namespace Core
Index: kmail/messagelistview/core/themedelegate.cpp
===================================================================
--- kmail/messagelistview/core/themedelegate.cpp	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ kmail/messagelistview/core/themedelegate.cpp	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -31,6 +31,7 @@
 #include <QPixmap>
 #include <QLinearGradient>
 #include <KColorScheme>
+#include <KGlobalSettings>
 
 namespace KMail
 {
@@ -50,11 +51,10 @@
 static const int gHorizontalItemSpacing = 2;
 
 
-ThemeDelegate::ThemeDelegate( QAbstractItemView * parent, QPaintDevice * paintDevice )
+ThemeDelegate::ThemeDelegate( QAbstractItemView * parent )
   : QStyledItemDelegate( parent )
 {
   mItemView = parent;
-  mPaintDevice = paintDevice;
   mTheme = 0;
 }
 
@@ -69,12 +69,6 @@
   if ( !mTheme )
     return; // hum
 
-  // yep..we're violating const here
-  // But most of the QStyledItemDelegate virtual methods are const and expect
-  // const behaviour. So we need the const pointer to avoid compiler complains
-  // but on the other side we're NOT really const... well...
-  const_cast< Theme * >( mTheme )->resetCache();
-
   // Rebuild the group header background color cache
   switch( mTheme->groupHeaderBackgroundMode() )
   {
@@ -104,14 +98,13 @@
 //        about function growth limit reached. Consider using macros
 //        or just convert to member functions.
 
-static inline void paint_right_aligned_elided_text( const QString &text, QPaintDevice * pd, Theme::ContentItem * ci, QPainter * painter, int &left, int top, int &right, Qt::LayoutDirection layoutDir )
+static inline void paint_right_aligned_elided_text( const QString &text, Theme::ContentItem * ci, QPainter * painter, int &left, int top, int &right, Qt::LayoutDirection layoutDir, const QFont &font )
 {
-  if ( ci->lastPaintDevice() != pd )
-    ci->updateFontMetrics( pd );
-  painter->setFont( ci->font() );
+  painter->setFont( font );
+  QFontMetrics fontMetrics( font );
   int w = right - left;
-  QString elidedText = ci->fontMetrics().elidedText( text, layoutDir == Qt::LeftToRight ? Qt::ElideLeft : Qt::ElideRight, w );
-  QRect rct( left, top, w, ci->lineSpacing() );
+  QString elidedText = fontMetrics.elidedText( text, layoutDir == Qt::LeftToRight ? Qt::ElideLeft : Qt::ElideRight, w );
+  QRect rct( left, top, w, fontMetrics.height() );
   QRect outRct;
 
   if ( ci->softenByBlending() )
@@ -129,15 +122,14 @@
     left += outRct.width() + gHorizontalItemSpacing;
 }
 
-static inline void compute_bounding_rect_for_right_aligned_elided_text( const QString &text, QPaintDevice * pd, Theme::ContentItem * ci, int &left, int top, int &right, QRect &outRect, Qt::LayoutDirection layoutDir )
+static inline void compute_bounding_rect_for_right_aligned_elided_text( const QString &text, int &left, int top, int &right, QRect &outRect, Qt::LayoutDirection layoutDir, const QFont &font )
 {
-  if ( ci->lastPaintDevice() != pd )
-    ci->updateFontMetrics( pd );
+  QFontMetrics fontMetrics( font );
   int w = right - left;
-  QString elidedText = ci->fontMetrics().elidedText( text, layoutDir == Qt::LeftToRight ? Qt::ElideLeft : Qt::ElideRight, w );
-  QRect rct( left, top, w, ci->lineSpacing() );
+  QString elidedText = fontMetrics.elidedText( text, layoutDir == Qt::LeftToRight ? Qt::ElideLeft : Qt::ElideRight, w );
+  QRect rct( left, top, w, fontMetrics.height() );
   Qt::AlignmentFlag af = layoutDir == Qt::LeftToRight ? Qt::AlignRight : Qt::AlignLeft;
-  outRect = ci->fontMetrics().boundingRect( rct, Qt::AlignTop | af | Qt::TextSingleLine, elidedText );
+  outRect = fontMetrics.boundingRect( rct, Qt::AlignTop | af | Qt::TextSingleLine, elidedText );
   if ( layoutDir == Qt::LeftToRight )
     right -= outRect.width() + gHorizontalItemSpacing;
   else
@@ -145,14 +137,13 @@
 }
 
 
-static inline void paint_left_aligned_elided_text( const QString &text, QPaintDevice * pd, Theme::ContentItem * ci, QPainter * painter, int &left, int top, int &right, Qt::LayoutDirection layoutDir )
+static inline void paint_left_aligned_elided_text( const QString &text, Theme::ContentItem * ci, QPainter * painter, int &left, int top, int &right, Qt::LayoutDirection layoutDir, const QFont &font )
 {
-  if ( ci->lastPaintDevice() != pd )
-    ci->updateFontMetrics( pd );
-  painter->setFont( ci->font() );
+  painter->setFont( font );
+  QFontMetrics fontMetrics( font );
   int w = right - left;
-  QString elidedText = ci->fontMetrics().elidedText( text, layoutDir == Qt::LeftToRight ? Qt::ElideRight : Qt::ElideLeft, w );
-  QRect rct( left, top, w, ci->lineSpacing() );
+  QString elidedText = fontMetrics.elidedText( text, layoutDir == Qt::LeftToRight ? Qt::ElideRight : Qt::ElideLeft, w );
+  QRect rct( left, top, w, fontMetrics.height() );
   QRect outRct;
   if ( ci->softenByBlending() )
   {
@@ -169,15 +160,14 @@
     right -= outRct.width() + gHorizontalItemSpacing;
 }
 
-static inline void compute_bounding_rect_for_left_aligned_elided_text( const QString &text, QPaintDevice * pd, Theme::ContentItem * ci, int &left, int top, int &right, QRect &outRect, Qt::LayoutDirection layoutDir )
+static inline void compute_bounding_rect_for_left_aligned_elided_text( const QString &text, int &left, int top, int &right, QRect &outRect, Qt::LayoutDirection layoutDir, const QFont &font )
 {
-  if ( ci->lastPaintDevice() != pd )
-    ci->updateFontMetrics( pd );
+  QFontMetrics fontMetrics( font );
   int w = right - left;
-  QString elidedText = ci->fontMetrics().elidedText( text, layoutDir == Qt::LeftToRight ? Qt::ElideRight : Qt::ElideLeft, w );
-  QRect rct( left, top, w, ci->lineSpacing() );
+  QString elidedText = fontMetrics.elidedText( text, layoutDir == Qt::LeftToRight ? Qt::ElideRight : Qt::ElideLeft, w );
+  QRect rct( left, top, w, fontMetrics.height() );
   Qt::AlignmentFlag af = layoutDir == Qt::LeftToRight ? Qt::AlignLeft : Qt::AlignRight;
-  outRect = ci->fontMetrics().boundingRect( rct, Qt::AlignTop | af | Qt::TextSingleLine, elidedText );
+  outRect = fontMetrics.boundingRect( rct, Qt::AlignTop | af | Qt::TextSingleLine, elidedText );
   if ( layoutDir == Qt::LeftToRight )
     left += outRect.width() + gHorizontalItemSpacing;
   else
@@ -485,15 +475,15 @@
   }
 }
 
-static inline void compute_size_hint_for_item( Theme::ContentItem * ci, QPaintDevice * pd,
-                                               int &maxh, int &totalw, int iconSize )
+static inline void compute_size_hint_for_item( Theme::ContentItem * ci,
+                                               int &maxh, int &totalw, int iconSize, const Item *item )
 {
   if ( ci->displaysText() )
   {
-    if ( ci->lastPaintDevice() != pd )
-      ci->updateFontMetrics( pd );
-    if ( ci->lineSpacing() > maxh )
-      maxh = ci->lineSpacing();
+    QFont font = ThemeDelegate::itemFont( ci, item );
+    QFontMetrics fontMetrics( font );
+    if ( fontMetrics.height() > maxh )
+      maxh = fontMetrics.height();
     totalw += ci->displaysLongText() ? 128 : 64;
     return;
   }
@@ -520,7 +510,7 @@
   totalw += gHorizontalItemSpacing;
 }
 
-static inline void compute_size_hint_for_row( const Theme::Row * r, QPaintDevice * pd, int iconSize )
+static inline QSize compute_size_hint_for_row( const Theme::Row * r, int iconSize, const Item *item )
 {
   int maxh = 8; // at least 8 pixels for a pixmap
   int totalw = 0;
@@ -530,15 +520,15 @@
   QList< Theme::ContentItem * >::ConstIterator itemit;
 
   for ( itemit = items->begin(); itemit != items->end() ; ++itemit )
-    compute_size_hint_for_item( const_cast< Theme::ContentItem * >( *itemit ), pd, maxh, totalw, iconSize );
+    compute_size_hint_for_item( const_cast< Theme::ContentItem * >( *itemit ), maxh, totalw, iconSize, item );
 
   // then left aligned stuff
   items = &( r->leftItems() );
 
   for ( itemit = items->begin(); itemit != items->end() ; ++itemit )
-    compute_size_hint_for_item( const_cast< Theme::ContentItem * >( *itemit ), pd, maxh, totalw, iconSize );
+    compute_size_hint_for_item( const_cast< Theme::ContentItem * >( *itemit ), maxh, totalw, iconSize, item );
 
-  const_cast< Theme::Row * >( r )->setSizeHint( QSize( totalw, maxh ) );
+  return QSize( totalw, maxh );
 }
 
 void ThemeDelegate::paint( QPainter * painter, const QStyleOptionViewItem & option, const QModelIndex & index ) const
@@ -555,6 +545,13 @@
 
   opt.text.clear(); // draw no text for me, please.. I'll do it in a while
 
+  // Set background color of control if necessary
+  if ( item->type() == Item::Message ) {
+    MessageItem * msgItem = static_cast< MessageItem * >( item );
+    if ( msgItem->backgroundColor().isValid() )
+      opt.backgroundBrush = QBrush( msgItem->backgroundColor() );
+  }
+
   QStyle * style = mItemView->style();
   style->drawControl( QStyle::CE_ItemViewItem, &opt, painter, mItemView );
 
@@ -806,12 +803,7 @@
 
   for ( QList< Theme::Row * >::ConstIterator rowit = rows->begin(); rowit != rows->end(); ++rowit )
   {
-    QSize rowSizeHint = ( *rowit )->sizeHint();
-    if ( !rowSizeHint.isValid() )
-    {
-      compute_size_hint_for_row( ( *rowit ), mPaintDevice, mTheme->iconSize() );
-      rowSizeHint = ( *rowit )->sizeHint();
-    }
+    QSize rowSizeHint = compute_size_hint_for_row( ( *rowit ), mTheme->iconSize(), item );
 
     int bottom = top + rowSizeHint.height();
 
@@ -848,32 +840,34 @@
           painter->setPen( defaultPen );
       } // otherwise setting a pen is useless at this time
 
+      QFont font = itemFont( ci, item );
+
       switch ( ci->type() )
       {
         case Theme::ContentItem::Subject:
-          paint_right_aligned_elided_text( item->subject(), mPaintDevice, ci, painter, l, top, r, layoutDir );
+          paint_right_aligned_elided_text( item->subject(), ci, painter, l, top, r, layoutDir, font );
         break;
         case Theme::ContentItem::SenderOrReceiver:
-          paint_right_aligned_elided_text( item->senderOrReceiver(), mPaintDevice, ci, painter, l, top, r, layoutDir );
+          paint_right_aligned_elided_text( item->senderOrReceiver(), ci, painter, l, top, r, layoutDir, font );
         break;
         case Theme::ContentItem::Receiver:
-          paint_right_aligned_elided_text( item->receiver(), mPaintDevice, ci, painter, l, top, r, layoutDir );
+          paint_right_aligned_elided_text( item->receiver(), ci, painter, l, top, r, layoutDir, font );
         break;
         case Theme::ContentItem::Sender:
-          paint_right_aligned_elided_text( item->sender(), mPaintDevice, ci, painter, l, top, r, layoutDir );
+          paint_right_aligned_elided_text( item->sender(), ci, painter, l, top, r, layoutDir, font );
         break;
         case Theme::ContentItem::Date:
-          paint_right_aligned_elided_text( item->formattedDate(), mPaintDevice, ci, painter, l, top, r, layoutDir );
+          paint_right_aligned_elided_text( item->formattedDate(), ci, painter, l, top, r, layoutDir, font );
         break;
         case Theme::ContentItem::MostRecentDate:
-          paint_right_aligned_elided_text( item->formattedMaxDate(), mPaintDevice, ci, painter, l, top, r, layoutDir );
+          paint_right_aligned_elided_text( item->formattedMaxDate(), ci, painter, l, top, r, layoutDir, font );
         break;
         case Theme::ContentItem::Size:
-          paint_right_aligned_elided_text( item->formattedSize(), mPaintDevice, ci, painter, l, top, r, layoutDir );
+          paint_right_aligned_elided_text( item->formattedSize(), ci, painter, l, top, r, layoutDir, font );
         break;
         case Theme::ContentItem::GroupHeaderLabel:
           if ( groupHeaderItem )
-            paint_right_aligned_elided_text( groupHeaderItem->label(), mPaintDevice, ci, painter, l, top, r, layoutDir );
+            paint_right_aligned_elided_text( groupHeaderItem->label(), ci, painter, l, top, r, layoutDir, font );
         break;
         case Theme::ContentItem::ReadStateIcon:
             paint_permanent_icon( get_read_state_icon( item ), ci, painter, l, top, r,
@@ -1001,32 +995,34 @@
         }
       } // otherwise setting a pen is useless at this time
 
+      QFont font = itemFont( ci, item );
+
       switch ( ci->type() )
       {
         case Theme::ContentItem::Subject:
-          paint_left_aligned_elided_text( item->subject(), mPaintDevice, ci, painter, l, top, r, layoutDir );
+          paint_left_aligned_elided_text( item->subject(), ci, painter, l, top, r, layoutDir, font );
         break;
         case Theme::ContentItem::SenderOrReceiver:
-          paint_left_aligned_elided_text( item->senderOrReceiver(), mPaintDevice, ci, painter, l, top, r, layoutDir );
+          paint_left_aligned_elided_text( item->senderOrReceiver(), ci, painter, l, top, r, layoutDir, font );
         break;
         case Theme::ContentItem::Receiver:
-          paint_left_aligned_elided_text( item->receiver(), mPaintDevice, ci, painter, l, top, r, layoutDir );
+          paint_left_aligned_elided_text( item->receiver(), ci, painter, l, top, r, layoutDir, font );
         break;
         case Theme::ContentItem::Sender:
-          paint_left_aligned_elided_text( item->sender(), mPaintDevice, ci, painter, l, top, r, layoutDir );
+          paint_left_aligned_elided_text( item->sender(), ci, painter, l, top, r, layoutDir, font );
         break;
         case Theme::ContentItem::Date:
-          paint_left_aligned_elided_text( item->formattedDate(), mPaintDevice, ci, painter, l, top, r, layoutDir );
+          paint_left_aligned_elided_text( item->formattedDate(), ci, painter, l, top, r, layoutDir, font );
         break;
         case Theme::ContentItem::MostRecentDate:
-          paint_left_aligned_elided_text( item->formattedMaxDate(), mPaintDevice, ci, painter, l, top, r, layoutDir );
+          paint_left_aligned_elided_text( item->formattedMaxDate(), ci, painter, l, top, r, layoutDir, font );
         break;
         case Theme::ContentItem::Size:
-          paint_left_aligned_elided_text( item->formattedSize(), mPaintDevice, ci, painter, l, top, r, layoutDir );
+          paint_left_aligned_elided_text( item->formattedSize(), ci, painter, l, top, r, layoutDir, font );
         break;
         case Theme::ContentItem::GroupHeaderLabel:
           if ( groupHeaderItem )
-            paint_left_aligned_elided_text( groupHeaderItem->label(), mPaintDevice, ci, painter, l, top, r, layoutDir );
+            paint_left_aligned_elided_text( groupHeaderItem->label(), ci, painter, l, top, r, layoutDir, font );
         break;
         case Theme::ContentItem::ReadStateIcon:
             paint_permanent_icon( get_read_state_icon( item ), ci, painter, l, top, r,
@@ -1203,12 +1199,7 @@
 
   for ( QList< Theme::Row * >::ConstIterator rowit = rows->begin(); rowit != rows->end(); ++rowit )
   {
-    QSize rowSizeHint = ( *rowit )->sizeHint();
-    if ( !rowSizeHint.isValid() )
-    {
-      compute_size_hint_for_row( ( *rowit ), mPaintDevice, mTheme->iconSize() );
-      rowSizeHint = ( *rowit )->sizeHint();
-    }
+    QSize rowSizeHint = compute_size_hint_for_row( ( *rowit ), mTheme->iconSize(), mHitItem );
 
     if ( ( viewportPoint.y() < top ) && ( rowIdx > 0 ) )
       break; // not this row (tough we should have already found it... probably clicked upper margin)
@@ -1246,32 +1237,34 @@
 
       mHitContentItemRect = QRect();
 
+      QFont font = itemFont( ci, mHitItem );
+
       switch ( ci->type() )
       {
         case Theme::ContentItem::Subject:
-          compute_bounding_rect_for_right_aligned_elided_text( mHitItem->subject(), mPaintDevice, ci, l, top, r, mHitContentItemRect, layoutDir );
+          compute_bounding_rect_for_right_aligned_elided_text( mHitItem->subject(), l, top, r, mHitContentItemRect, layoutDir, font );
         break;
         case Theme::ContentItem::SenderOrReceiver:
-          compute_bounding_rect_for_right_aligned_elided_text( mHitItem->senderOrReceiver(), mPaintDevice, ci, l, top, r, mHitContentItemRect, layoutDir );
+          compute_bounding_rect_for_right_aligned_elided_text( mHitItem->senderOrReceiver(), l, top, r, mHitContentItemRect, layoutDir, font );
         break;
         case Theme::ContentItem::Receiver:
-          compute_bounding_rect_for_right_aligned_elided_text( mHitItem->receiver(), mPaintDevice, ci, l, top, r, mHitContentItemRect, layoutDir );
+          compute_bounding_rect_for_right_aligned_elided_text( mHitItem->receiver(), l, top, r, mHitContentItemRect, layoutDir, font );
         break;
         case Theme::ContentItem::Sender:
-          compute_bounding_rect_for_right_aligned_elided_text( mHitItem->sender(), mPaintDevice, ci, l, top, r, mHitContentItemRect, layoutDir );
+          compute_bounding_rect_for_right_aligned_elided_text( mHitItem->sender(), l, top, r, mHitContentItemRect, layoutDir, font );
         break;
         case Theme::ContentItem::Date:
-          compute_bounding_rect_for_right_aligned_elided_text( mHitItem->formattedDate(), mPaintDevice, ci, l, top, r, mHitContentItemRect, layoutDir );
+          compute_bounding_rect_for_right_aligned_elided_text( mHitItem->formattedDate(), l, top, r, mHitContentItemRect, layoutDir, font );
         break;
         case Theme::ContentItem::MostRecentDate:
-          compute_bounding_rect_for_right_aligned_elided_text( mHitItem->formattedMaxDate(), mPaintDevice, ci, l, top, r, mHitContentItemRect, layoutDir );
+          compute_bounding_rect_for_right_aligned_elided_text( mHitItem->formattedMaxDate(), l, top, r, mHitContentItemRect, layoutDir, font );
         break;
         case Theme::ContentItem::Size:
-          compute_bounding_rect_for_right_aligned_elided_text( mHitItem->formattedSize(), mPaintDevice, ci, l, top, r, mHitContentItemRect, layoutDir );
+          compute_bounding_rect_for_right_aligned_elided_text( mHitItem->formattedSize(), l, top, r, mHitContentItemRect, layoutDir, font );
         break;
         case Theme::ContentItem::GroupHeaderLabel:
           if ( groupHeaderItem )
-            compute_bounding_rect_for_right_aligned_elided_text( groupHeaderItem->label(), mPaintDevice, ci, l, top, r, mHitContentItemRect, layoutDir );
+            compute_bounding_rect_for_right_aligned_elided_text( groupHeaderItem->label(), l, top, r, mHitContentItemRect, layoutDir, font );
         break;
         case Theme::ContentItem::ReadStateIcon:
           compute_bounding_rect_for_permanent_icon( ci, l, top, r, mHitContentItemRect, layoutDir == Qt::LeftToRight, mTheme->iconSize() );
@@ -1387,32 +1380,34 @@
 
       mHitContentItemRect = QRect();
 
+      QFont font = itemFont( ci, mHitItem );
+
       switch ( ci->type() )
       {
         case Theme::ContentItem::Subject:
-          compute_bounding_rect_for_left_aligned_elided_text( mHitItem->subject(), mPaintDevice, ci, l, top, r, mHitContentItemRect, layoutDir );
+          compute_bounding_rect_for_left_aligned_elided_text( mHitItem->subject(), l, top, r, mHitContentItemRect, layoutDir, font );
         break;
         case Theme::ContentItem::SenderOrReceiver:
-          compute_bounding_rect_for_left_aligned_elided_text( mHitItem->senderOrReceiver(), mPaintDevice, ci, l, top, r, mHitContentItemRect, layoutDir );
+          compute_bounding_rect_for_left_aligned_elided_text( mHitItem->senderOrReceiver(), l, top, r, mHitContentItemRect, layoutDir, font );
         break;
         case Theme::ContentItem::Receiver:
-          compute_bounding_rect_for_left_aligned_elided_text( mHitItem->receiver(), mPaintDevice, ci, l, top, r, mHitContentItemRect, layoutDir );
+          compute_bounding_rect_for_left_aligned_elided_text( mHitItem->receiver(), l, top, r, mHitContentItemRect, layoutDir, font );
         break;
         case Theme::ContentItem::Sender:
-          compute_bounding_rect_for_left_aligned_elided_text( mHitItem->sender(), mPaintDevice, ci, l, top, r, mHitContentItemRect, layoutDir );
+          compute_bounding_rect_for_left_aligned_elided_text( mHitItem->sender(), l, top, r, mHitContentItemRect, layoutDir, font );
         break;
         case Theme::ContentItem::Date:
-          compute_bounding_rect_for_left_aligned_elided_text( mHitItem->formattedDate(), mPaintDevice, ci, l, top, r, mHitContentItemRect, layoutDir );
+          compute_bounding_rect_for_left_aligned_elided_text( mHitItem->formattedDate(), l, top, r, mHitContentItemRect, layoutDir, font );
         break;
         case Theme::ContentItem::MostRecentDate:
-          compute_bounding_rect_for_left_aligned_elided_text( mHitItem->formattedMaxDate(), mPaintDevice, ci, l, top, r, mHitContentItemRect, layoutDir );
+          compute_bounding_rect_for_left_aligned_elided_text( mHitItem->formattedMaxDate(), l, top, r, mHitContentItemRect, layoutDir, font );
         break;
         case Theme::ContentItem::Size:
-          compute_bounding_rect_for_left_aligned_elided_text( mHitItem->formattedSize(), mPaintDevice, ci, l, top, r, mHitContentItemRect, layoutDir );
+          compute_bounding_rect_for_left_aligned_elided_text( mHitItem->formattedSize(), l, top, r, mHitContentItemRect, layoutDir, font );
         break;
         case Theme::ContentItem::GroupHeaderLabel:
           if ( groupHeaderItem )
-            compute_bounding_rect_for_left_aligned_elided_text( groupHeaderItem->label(), mPaintDevice, ci, l, top, r, mHitContentItemRect, layoutDir );
+            compute_bounding_rect_for_left_aligned_elided_text( groupHeaderItem->label(), l, top, r, mHitContentItemRect, layoutDir, font );
         break;
         case Theme::ContentItem::ReadStateIcon:
           compute_bounding_rect_for_permanent_icon( ci, l, top, r, mHitContentItemRect, layoutDir != Qt::LeftToRight, mTheme->iconSize() );
@@ -1527,7 +1522,7 @@
   return true;
 }
 
-QSize ThemeDelegate::sizeHintForItemTypeAndColumn( Item::Type type, int column ) const
+QSize ThemeDelegate::sizeHintForItemTypeAndColumn( Item::Type type, int column, const Item *item ) const
 {
   if ( !mTheme )
     return QSize( 16, 16 ); // bleah
@@ -1547,9 +1542,6 @@
   {
     case Item::Message:
     {
-      QSize cached = skcolumn->messageSizeHint();
-      if ( cached.isValid() )
-        return cached;
       rows = &( skcolumn->messageRows() );
 
       marginh = gMessageVerticalMargin << 1;
@@ -1558,9 +1550,6 @@
     break;
     case Item::GroupHeader:
     {
-      QSize cached = skcolumn->groupHeaderSizeHint();
-      if ( cached.isValid() )
-        return cached;
       rows = &( skcolumn->groupHeaderRows() );
 
       marginh = ( gGroupHeaderOuterVerticalMargin + gGroupHeaderInnerVerticalMargin ) << 1;
@@ -1577,34 +1566,15 @@
 
   for ( QList< Theme::Row * >::ConstIterator rowit = rows->begin(); rowit != rows->end(); ++rowit )
   {
-    compute_size_hint_for_row( *rowit, mPaintDevice, mTheme->iconSize() );
-
-    QSize sh = ( *rowit )->sizeHint();
+    QSize sh = compute_size_hint_for_row( ( *rowit ), mTheme->iconSize(), item );
     totalh += sh.height();
     if ( sh.width() > maxw )
       maxw = sh.width();
   }
 
-  QSize ret( maxw + marginw , totalh + marginh );
-
-  // cache it
-  switch ( type )
-  {
-    case Item::Message:
-      const_cast< Theme::Column * >( skcolumn )->setMessageSizeHint( ret );
-    break;
-    case Item::GroupHeader:
-      const_cast< Theme::Column * >( skcolumn )->setGroupHeaderSizeHint( ret );
-    break;
-    default:
-      // make gcc happy
-    break;
-  }
-
-  return ret;
+  return QSize( maxw + marginw , totalh + marginh );
 }
 
-
 QSize ThemeDelegate::sizeHint( const QStyleOptionViewItem &, const QModelIndex & index ) const
 {
   if ( !mTheme )
@@ -1619,9 +1589,20 @@
 
   //Item::Type type = item->type();
 
-  return sizeHintForItemTypeAndColumn( item->type(), index.column() );
+  return sizeHintForItemTypeAndColumn( item->type(), index.column(), item );
 }
 
+QFont ThemeDelegate::itemFont( const Theme::ContentItem *ci, const Item *item )
+{
+  if ( ci && ci->useCustomFont() )
+    return ci->font();
+
+  if ( item && ( item->type() == Item::Message ) )
+    return static_cast< const MessageItem * >( item )->font();
+
+  return KGlobalSettings::generalFont();
+}
+
 } // namespace Core
 
 } // namespace MessageListView
Index: kmail/messagelistview/storagemodel.h
===================================================================
--- kmail/messagelistview/storagemodel.h	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ kmail/messagelistview/storagemodel.h	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -28,10 +28,11 @@
 class KMMsgBase;
 
 #include <QColor>
+#include <QFont>
 
 namespace KPIM
 {
-	class MessageStatus;
+  class MessageStatus;
 }
 
 namespace KMail
@@ -65,6 +66,13 @@
   QColor mColorUnreadMessage;
   QColor mColorImportantMessage;
   QColor mColorToDoMessage;
+
+  QFont mFont;
+  QFont mFontNewMessage;
+  QFont mFontUnreadMessage;
+  QFont mFontImportantMessage;
+  QFont mFontToDoMessage;
+
 public:
 
   // When porting to Akonadi the stuff below will be simply killed as it serves
@@ -239,6 +247,11 @@
    */
   void slotMessageHeaderChanged( KMFolder *folder, int idx );
 
+private:
+  /**
+    *  set MessageItem's color and font, etc. to reflect given mail message's state
+    */
+  void setMessageItemData( Core::MessageItem * mi, KMMsgBase * msg ) const;
 };
 
 } // namespace MessageListView
Index: kmail/profiles/profile-html-rc.desktop
===================================================================
--- kmail/profiles/profile-html-rc.desktop	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ kmail/profiles/profile-html-rc.desktop	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -24,7 +24,7 @@
 Comment[fy]=Standertprofyl mei HTML-foarbyld aktivearre - minder feilich!
 Comment[ga]=Próifíl chaighdeánach le réamhamharc HTML cumasaithe - is lú slándáil!
 Comment[gl]=Perfil normal con previsualización HTML activada - menos seguro!
-Comment[hr]=Standardni profil sa uključenim pregledom HTML sadržaja - manje sigurno!
+Comment[hr]=Standardni profil sa uključenim pregledom HTML sadržaja – manje sigurno!
 Comment[hu]=Standard profil, HTML-előnézettel (kevésbé biztonságos)
 Comment[is]=Staðlað snið með HTML forsýn - minna öryggi!
 Comment[it]=Profilo standard con l'anteprima HTML abilitata - meno sicuro!
Index: kmail/kmmessage.h
===================================================================
--- kmail/kmmessage.h	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ kmail/kmmessage.h	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -628,6 +628,12 @@
   /** Delete all body parts. */
   void deleteBodyParts();
 
+  /**
+   * Delete a body part with the specified part index.
+   * A dummy body part with the text "the attachment foo was deleted" will replace the old part.
+   */
+  bool deleteBodyPart( int partIndex );
+
   /** Set "Status" and "X-Status" fields of the message from the
    * internal message status. */
   void setStatusFields();
@@ -813,8 +819,11 @@
    * If entity is 0, the root will be dumped.
    */
   void dump( DwEntity *entity = 0, int level = 0 );
+
 #endif
 
+  DwBodyPart* findPart( int index );
+
 private:
 
   /** Initialization shared by the ctors. */
@@ -822,6 +831,8 @@
   /** Assign the values of @param other to this message. Used in the copy c'tor. */
   void assign( const KMMessage& other );
 
+  DwBodyPart* findPartInternal( DwEntity* root, int index, int &accu );
+
   QString mDrafts;
   QString mTemplates;
   mutable DwMessage* mMsg;
Index: kmail/stringutil.cpp
===================================================================
--- kmail/stringutil.cpp	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ kmail/stringutil.cpp	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -34,6 +34,7 @@
 #include <kascii.h>
 #include <KConfigGroup>
 #include <KDebug>
+#include <KUrl>
 #include <kuser.h>
 
 #include <QHostInfo>
@@ -885,15 +886,16 @@
     }
 
     // check whether the address is missing the domain part
-    // FIXME: looking for '@' might be wrong
-    if ( !receiver.contains('@') ) {
+    QByteArray displayName, addrSpec, comment;
+    KPIMUtils::splitAddress( receiver.toLatin1(), displayName, addrSpec, comment );
+    if ( !addrSpec.contains('@') ) {
       KConfigGroup general( KMKernel::config(), "General" );
       QString defaultdomain = general.readEntry( "Default domain" );
-      if( !defaultdomain.isEmpty() ) {
-        expandedRecipients += receiver + '@' + defaultdomain;
+      if ( !defaultdomain.isEmpty() ) {
+        expandedRecipients += KPIMUtils::normalizedAddress( displayName, addrSpec + '@' + defaultdomain, comment );
       }
       else {
-        expandedRecipients += guessEmailAddressFromLoginName( receiver );
+        expandedRecipients += guessEmailAddressFromLoginName( addrSpec );
       }
     }
     else
@@ -994,6 +996,18 @@
   return result;
 }
 
+#ifndef KMAIL_UNITTESTS
+void parseMailtoUrl ( const KUrl& url, QString& to, QString& cc, QString& subject, QString& body )
+{
+  to = decodeMailtoUrl( url.path() );
+  body = url.queryItem( "body" );
+  subject = url.queryItem( "subject" );
+  kDebug() << url.pathOrUrl();
+  cc = url.queryItem( "cc" );
 }
+#endif
 
 }
+
+}
+
Index: kmail/newfolderdialog.cpp
===================================================================
--- kmail/newfolderdialog.cpp	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ kmail/newfolderdialog.cpp	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -55,7 +55,7 @@
 using namespace KMail;
 
 NewFolderDialog::NewFolderDialog( QWidget* parent, KMFolder *folder )
-  : KDialog( parent ), mFolder( folder )
+  : KDialog( parent ), mContentsComboBox( 0 ), mFolder( folder )
 {
   setCaption( i18n( "New Folder" ) );
   setButtons( Ok | Cancel );
@@ -129,7 +129,8 @@
   }
 
   // --- contents -----
-  if ( kmkernel->iCalIface().isEnabled() ) {
+  if ( kmkernel->iCalIface().isEnabled() &&
+       mFolder && mFolder->folderType() != KMFolderTypeImap ) {
     mContentsHBox = new QHBoxLayout();
     mContentsHBox->setSpacing( 6 );
     mContentsHBox->setMargin( 0 );
Index: kmail/kmreadermainwin.cpp
===================================================================
--- kmail/kmreadermainwin.cpp	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ kmail/kmreadermainwin.cpp	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -124,10 +124,15 @@
 }
 
 //-----------------------------------------------------------------------------
-void KMReaderMainWin::showMsg( const QString & encoding, KMMessage *msg )
+void KMReaderMainWin::showMsg( const QString & encoding, KMMessage *msg,
+                               unsigned long serNumOfOriginalMessage, int nodeIdOffset )
 {
   mReaderWin->setOverrideEncoding( encoding );
   mReaderWin->setMsg( msg, true );
+  if ( serNumOfOriginalMessage != 0 ) {
+    Q_ASSERT( nodeIdOffset != -1 );
+    mReaderWin->setOriginalMsg( serNumOfOriginalMessage, nodeIdOffset );
+  }
   mReaderWin->slotTouchMessage();
   setCaption( msg->subject() );
   mMsg = msg;
@@ -316,9 +321,6 @@
   updateMessageMenu();
   updateCustomTemplateMenus();
 
-  mCopyTextAction = new KAction( KStandardAction::copy(
-                   mReaderWin, SLOT( slotCopySelectedText() ), actionCollection() ) );
-
   connect( mReaderWin, SIGNAL(popupMenu(KMMessage&,const KUrl&,const QPoint&)),
            this, SLOT(slotMsgPopup(KMMessage&,const KUrl&,const QPoint&)) );
   connect( mReaderWin, SIGNAL(urlClicked(const KUrl&,int)),
Index: kmail/kmlineeditspell.cpp
===================================================================
--- kmail/kmlineeditspell.cpp	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ kmail/kmlineeditspell.cpp	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -23,6 +23,7 @@
 #include "recentaddresses.h"
 #include "kmkernel.h"
 #include "globalsettings.h"
+#include "stringutil.h"
 
 #include <libkdepim/kvcarddrag.h>
 #include <kpimutils/email.h>
@@ -128,7 +129,7 @@
       // email-address.
       if ( url.protocol() == "mailto" ) {
         KABC::Addressee addressee;
-        addressee.insertEmail( url.path(), true /* preferred */ );
+        addressee.insertEmail( KMail::StringUtil::decodeMailtoUrl( url.path() ), true /* preferred */ );
         list += addressee;
       }
 
Index: kmail/kmreaderwin.cpp
===================================================================
--- kmail/kmreaderwin.cpp	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ kmail/kmreaderwin.cpp	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -465,6 +465,8 @@
                          KActionCollection* actionCollection,
                          Qt::WindowFlags aFlags )
   : QWidget(aParent, aFlags ),
+    mSerNumOfOriginalMessage( 0 ),
+    mNodeIdOffset( -1 ),
     mAttachmentStrategy( 0 ),
     mHeaderStrategy( 0 ),
     mHeaderStyle( 0 ),
@@ -487,6 +489,10 @@
     mUrlSaveAsAction( 0 ),
     mAddBookmarksAction( 0 ),
     mSelectAllAction( 0 ),
+    mScrollUpAction( 0 ),
+    mScrollDownAction( 0 ),
+    mScrollUpMoreAction( 0 ),
+    mScrollDownMoreAction( 0 ),
     mSelectEncodingAction( 0 ),
     mToggleFixFontAction( 0 ),
     mHtmlWriter( 0 ),
@@ -750,6 +756,15 @@
            this, SLOT( slotScrollNext() ) );
 }
 
+void KMReaderWin::setUseFixedFont( bool useFixedFont )
+{
+  mUseFixedFont = useFixedFont;
+  if ( mToggleFixFontAction )
+  {
+    mToggleFixFontAction->setChecked( mUseFixedFont );
+  }
+}
+
 // little helper function
 KToggleAction *KMReaderWin::actionForHeaderStyle( const HeaderStyle * style, const HeaderStrategy * strategy ) {
   if ( !mActionCollection )
@@ -1255,12 +1270,20 @@
 }
 
 //-----------------------------------------------------------------------------
-void KMReaderWin::setMsg(KMMessage* aMsg, bool force)
+void KMReaderWin::setOriginalMsg( unsigned long serNumOfOriginalMessage, int nodeIdOffset )
 {
-  if (aMsg)
-      kDebug() <<"(" << aMsg->getMsgSerNum() <<", last" << mLastSerNum <<")" << aMsg->subject()
-        << aMsg->fromStrip() << ", readyToShow" << (aMsg->readyToShow());
+  mSerNumOfOriginalMessage = serNumOfOriginalMessage;
+  mNodeIdOffset = nodeIdOffset;
+}
 
+//-----------------------------------------------------------------------------
+void KMReaderWin::setMsg( KMMessage* aMsg, bool force )
+{
+  if ( aMsg ) {
+    kDebug() << "(" << aMsg->getMsgSerNum() <<", last" << mLastSerNum <<")" << aMsg->subject()
+             << aMsg->fromStrip() << ", readyToShow" << (aMsg->readyToShow());
+  }
+
   //Reset the level quote if the msg has changed.
   if (aMsg && aMsg->getMsgSerNum() != mLastSerNum ){
     mLevelQuote = GlobalSettings::self()->collapseQuoteLevelSpin()-1;
@@ -2187,7 +2210,7 @@
 
 
 //-----------------------------------------------------------------------------
-void KMReaderWin::atmViewMsg(KMMessagePart* aMsgPart)
+void KMReaderWin::atmViewMsg( KMMessagePart* aMsgPart, int nodeId )
 {
   assert(aMsgPart!=0);
   KMMessage* msg = new KMMessage;
@@ -2199,7 +2222,7 @@
   msg->setUID(message()->UID());
   msg->setReadyToShow(true);
   KMReaderMainWin *win = new KMReaderMainWin();
-  win->showMsg( overrideEncoding(), msg );
+  win->showMsg( overrideEncoding(), msg, message()->getMsgSerNum(), nodeId );
   win->show();
 }
 
@@ -2338,7 +2361,7 @@
     if (pname.isEmpty()) pname="unnamed";
     // image Attachment is saved already
     if (kasciistricmp(msgPart.typeStr(), "message")==0) {
-      atmViewMsg(&msgPart);
+      atmViewMsg( &msgPart,id );
     } else if ((kasciistricmp(msgPart.typeStr(), "text")==0) &&
                ( (kasciistricmp(msgPart.subtypeStr(), "x-vcard")==0) ||
                  (kasciistricmp(msgPart.subtypeStr(), "directory")==0) )) {
@@ -2370,7 +2393,7 @@
   KMMessagePart& msgPart = node->msgPart();
   if (kasciistricmp(msgPart.typeStr(), "message")==0)
   {
-    atmViewMsg(&msgPart);
+    atmViewMsg( &msgPart, id );
     return;
   }
 
@@ -2732,6 +2755,30 @@
   return false;
 }
 
+void KMReaderWin::fillCommandInfo( partNode *node, KMMessage **msg, int *nodeId )
+{
+  Q_ASSERT( msg && nodeId );
+
+  if ( mSerNumOfOriginalMessage != 0 ) {
+    KMFolder *folder = 0;
+    int index = -1;
+    KMMsgDict::instance()->getLocation( mSerNumOfOriginalMessage, &folder, &index );
+    if ( folder && index != -1 )
+      *msg = folder->getMsg( index );
+
+    if ( !( *msg ) ) {
+      kWarning() << "Unable to find the original message, aborting attachment deletion!";
+      return;
+    }
+
+    *nodeId = node->nodeId() + mNodeIdOffset;
+  }
+  else {
+    *nodeId = node->nodeId();
+    *msg = message();
+  }
+}
+
 void KMReaderWin::slotDeleteAttachment(partNode * node)
 {
   if ( KMessageBox::warningContinueCancel( this,
@@ -2741,8 +2788,20 @@
      != KMessageBox::Continue ) {
     return;
   }
-  KMDeleteAttachmentCommand* command = new KMDeleteAttachmentCommand( node, message(), this );
-  command->start();
+
+  int nodeId = -1;
+  KMMessage *msg = 0;
+  fillCommandInfo( node, &msg, &nodeId );
+  if ( msg && nodeId != -1 ) {
+    KMDeleteAttachmentCommand* command = new KMDeleteAttachmentCommand( nodeId, msg, this );
+    command->start();
+  }
+
+  // If we are operating on a copy of parts of the message, make sure to update the copy as well.
+  if ( mSerNumOfOriginalMessage != 0 && message() ) {
+    message()->deleteBodyPart( node->nodeId() );
+    update( true );
+  }
 }
 
 void KMReaderWin::slotEditAttachment(partNode * node)
@@ -2754,8 +2813,16 @@
         != KMessageBox::Continue ) {
     return;
   }
-  KMEditAttachmentCommand* command = new KMEditAttachmentCommand( node, message(), this );
-  command->start();
+
+  int nodeId = -1;
+  KMMessage *msg = 0;
+  fillCommandInfo( node, &msg, &nodeId );
+  if ( msg && nodeId != -1 ) {
+    KMEditAttachmentCommand* command = new KMEditAttachmentCommand( nodeId, msg, this );
+    command->start();
+  }
+
+  // FIXME: If we are operating on a copy of parts of the message, make sure to update the copy as well.
 }
 
 KMail::CSSHelper* KMReaderWin::cssHelper() const
@@ -2838,12 +2905,12 @@
       QString align = "left";
       if ( headerStyle() == HeaderStyle::enterprise() )
         align = "right";
-      if ( node->msgPart().typeStr() == "message" || node == mRootNode )
+      if ( node->msgPart().typeStr().toLower() == "message" || node == mRootNode )
         html += QString::fromLatin1("<div style=\"background:%1; %2"
                 "vertical-align:middle; float:%3; %4\">").arg( bgColor.name() ).arg( margin )
                                                          .arg( align ).arg( visibility );
       html += subHtml;
-      if ( node->msgPart().typeStr() == "message" || node == mRootNode )
+      if ( node->msgPart().typeStr().toLower() == "message" || node == mRootNode )
         html += "</div>";
     }
   } else {
@@ -2854,17 +2921,22 @@
       label = node->msgPart().name().trimmed();
     if( label.isEmpty() )
       label = node->msgPart().fileName();
-    bool typeBlacklisted = node->msgPart().typeStr() == "multipart";
-    if ( !typeBlacklisted && node->msgPart().typeStr() == "application" ) {
-      typeBlacklisted = node->msgPart().subtypeStr() == "pgp-encrypted"
-                     || node->msgPart().subtypeStr() == "pgp-signature"
-                     || node->msgPart().subtypeStr() == "pkcs7-mime"
-                     || node->msgPart().subtypeStr() == "pkcs7-signature"
-                     || node->msgPart().subtypeStr() == "x-pkcs7-signature"
-                     || ( node->msgPart().subtypeStr() == "octet-stream" &&
-                          node->msgPart().fileName() == "msg.asc" );
+    bool typeBlacklisted = node->msgPart().typeStr().toLower() == "multipart";
+    if ( !typeBlacklisted && node->msgPart().typeStr().toLower() == "application" ) {
+      typeBlacklisted = node->msgPart().subtypeStr().toLower() == "pgp-encrypted"
+                     || node->msgPart().subtypeStr().toLower() == "pgp-signature"
+                     || node->msgPart().subtypeStr().toLower() == "pkcs7-mime"
+                     || node->msgPart().subtypeStr().toLower() == "pkcs7-signature"
+                     || node->msgPart().subtypeStr().toLower() == "x-pkcs7-signature"
+                     || ( node->msgPart().subtypeStr().toLower() == "octet-stream" &&
+                          node->msgPart().fileName().toLower() == "msg.asc" );
     }
     typeBlacklisted = typeBlacklisted || node == mRootNode;
+    bool firstTextChildOfEncapsulatedMsg = node->msgPart().typeStr().toLower() == "text" &&
+                                           node->msgPart().subtypeStr().toLower() == "plain" &&
+                                           node->parentNode() &&
+                                           node->parentNode()->msgPart().typeStr().toLower() == "message";
+    typeBlacklisted = typeBlacklisted || firstTextChildOfEncapsulatedMsg;
     if ( !label.isEmpty() && !icon.isEmpty() && !typeBlacklisted ) {
       html += "<div style=\"float:left;\">";
       html += QString::fromLatin1( "<span style=\"white-space:nowrap; border-width: 0px; border-left-width: 5px; border-color: %1; 2px; border-left-style: solid;\">" ).arg( bgColor.name() );
Index: kmail/kmmessage.cpp
===================================================================
--- kmail/kmmessage.cpp	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ kmail/kmmessage.cpp	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -610,12 +610,13 @@
 
   const QString indentStr = formatString( aIndentStr );
 
+  if ( s->smartQuote && s->wordWrap )
+    content = StringUtil::smartQuote( content, s->wrapCol - indentStr.length() );
+
   content.replace( '\n', '\n' + indentStr );
   content.prepend( indentStr );
   content += '\n';
 
-  if ( s->smartQuote && s->wordWrap )
-    return StringUtil::smartQuote( content, s->wrapCol );
   return content;
 }
 
@@ -2774,6 +2775,44 @@
 }
 
 //-----------------------------------------------------------------------------
+
+bool KMMessage::deleteBodyPart( int partIndex )
+{
+  KMMessagePart part;
+  DwBodyPart *dwpart = findPart( partIndex );
+  if ( !dwpart )
+    return false;
+  KMMessage::bodyPart( dwpart, &part, true );
+  if ( !part.isComplete() )
+     return false;
+
+  DwBody *parentNode = dynamic_cast<DwBody*>( dwpart->Parent() );
+  if ( !parentNode )
+    return false;
+  parentNode->RemoveBodyPart( dwpart );
+
+  // add dummy part to show that a attachment has been deleted
+  KMMessagePart dummyPart;
+  dummyPart.duplicate( part );
+  QString comment = i18n("This attachment has been deleted.");
+  if ( !part.fileName().isEmpty() )
+    comment = i18n( "The attachment '%1' has been deleted." ).arg( part.fileName() );
+  dummyPart.setContentDescription( comment );
+  dummyPart.setBodyEncodedBinary( QByteArray() );
+  QByteArray cd = dummyPart.contentDisposition();
+  if ( cd.toLower().indexOf( "inline" ) == 0 ) {
+    cd.replace( 0, 10, "attachment" );
+    dummyPart.setContentDisposition( cd );
+  } else if ( cd.isEmpty() ) {
+    dummyPart.setContentDisposition( "attachment" );
+  }
+  DwBodyPart* newDwPart = createDWBodyPart( &dummyPart );
+  parentNode->AddBodyPart( newDwPart );
+  getTopLevelPart()->Assemble();
+  return true;
+}
+
+//-----------------------------------------------------------------------------
 DwBodyPart* KMMessage::createDWBodyPart(const KMMessagePart* aPart)
 {
   DwBodyPart* part = DwBodyPart::NewBodyPart(s->emptyString, 0);
@@ -3379,3 +3418,27 @@
   }
 }
 #endif
+
+DwBodyPart* KMMessage::findPart( int index )
+{
+  int accu = 0;
+  return findPartInternal( getTopLevelPart(), index, accu );
+}
+
+DwBodyPart* KMMessage::findPartInternal(DwEntity * root, int index, int & accu)
+{
+  accu++;
+  if ( index < accu ) // should not happen
+    return 0;
+  DwBodyPart *current = dynamic_cast<DwBodyPart*>( root );
+  if ( index == accu )
+    return current;
+  DwBodyPart *rv = 0;
+  if ( root->Body().FirstBodyPart() )
+    rv = findPartInternal( root->Body().FirstBodyPart(), index, accu );
+  if ( !rv && current && current->Next() )
+    rv = findPartInternal( current->Next(), index, accu );
+  if ( !rv && root->Body().Message() )
+    rv = findPartInternal( root->Body().Message(), index, accu );
+  return rv;
+}
Index: kmail/configuredialog_p.h
===================================================================
--- kmail/configuredialog_p.h	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ kmail/configuredialog_p.h	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -405,7 +405,7 @@
   KFontChooser *mFontChooser;
 
   int          mActiveFontIndex;
-  QFont        mFont[14];
+  QFont        mFont[13];
 };
 
 class AppearancePageColorsTab : public ConfigModuleTab {
Index: kmail/messageactions.cpp
===================================================================
--- kmail/messageactions.cpp	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ kmail/messageactions.cpp	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -30,6 +30,7 @@
 #include <KDebug>
 #include <KLocale>
 #include <KXMLGUIClient>
+#include <KStandardDirs>
 
 #include <qwidget.h>
 
@@ -90,8 +91,9 @@
   mActionCollection->addAction( "create_todo", mCreateTodoAction );
   connect( mCreateTodoAction, SIGNAL(triggered(bool)),
            this, SLOT(slotCreateTodo()) );
+  mKorganizerIsOnSystem = !KStandardDirs::findExe("korganizer").isEmpty();
+  mCreateTodoAction->setEnabled( mKorganizerIsOnSystem );
 
-
   mStatusMenu = new KActionMenu ( i18n( "Mar&k Message" ), this );
   mActionCollection->addAction( "set_status", mStatusMenu );
 
@@ -207,7 +209,7 @@
   const bool flagsAvailable = GlobalSettings::self()->allowLocalFlags() ||
       !((mCurrentMessage && mCurrentMessage->parent()) ? mCurrentMessage->parent()->isReadOnly() : true);
 
-  mCreateTodoAction->setEnabled( singleMsg );
+  mCreateTodoAction->setEnabled( singleMsg && mKorganizerIsOnSystem);
   mReplyActionMenu->setEnabled( singleMsg );
   mReplyAction->setEnabled( singleMsg );
   mNoQuoteReplyAction->setEnabled( singleMsg );
Index: kmail/kmcommands.cpp
===================================================================
--- kmail/kmcommands.cpp	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ kmail/kmcommands.cpp	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -2282,11 +2282,11 @@
     msg = new KMMessage;
     msg->initHeader(mIdentity);
     msg->setCharset("utf-8");
-    msg->setTo( KMail::StringUtil::decodeMailtoUrl( mUrl.path() ) );
 
-    QString body = mUrl.queryItem( "body" );
-    QString subject = mUrl.queryItem( "subject" );
-    QString cc = mUrl.queryItem( "cc" );
+    QString to, body, subject, cc;
+    KMail::StringUtil::parseMailtoUrl( mUrl, to, cc, subject, body );
+
+    msg->setTo( to );
     if ( !subject.isEmpty() )
       msg->setSubject( subject );
     if ( !body.isEmpty() )
@@ -2296,6 +2296,7 @@
 
     KMail::Composer * win = KMail::makeComposer( msg, mIdentity );
     win->setCharset("", true);
+    win->setFocusToSubject();
     win->show();
   }
   else if ((mUrl.protocol() == "http") || (mUrl.protocol() == "https") ||
@@ -3211,6 +3212,13 @@
 {
 }
 
+AttachmentModifyCommand::AttachmentModifyCommand( int nodeId, KMMessage *msg, QWidget *parent )
+  : KMCommand( parent, msg ),
+    mPartIndex( nodeId ),
+    mSernum( 0 )
+{
+}
+
 AttachmentModifyCommand::~ AttachmentModifyCommand()
 {
 }
@@ -3277,35 +3285,18 @@
   deleteLater();
 }
 
-DwBodyPart * AttachmentModifyCommand::findPart(KMMessage* msg, int index)
-{
-  int accu = 0;
-  return findPartInternal( msg->getTopLevelPart(), index, accu );
-}
-
-DwBodyPart * AttachmentModifyCommand::findPartInternal(DwEntity * root, int index, int & accu)
-{
-  accu++;
-  if ( index < accu ) // should not happen
-    return 0;
-  DwBodyPart *current = dynamic_cast<DwBodyPart*>( root );
-  if ( index == accu )
-    return current;
-  DwBodyPart *rv = 0;
-  if ( root->Body().FirstBodyPart() )
-    rv = findPartInternal( root->Body().FirstBodyPart(), index, accu );
-  if ( !rv && current && current->Next() )
-    rv = findPartInternal( current->Next(), index, accu );
-  return rv;
-}
-
-
 KMDeleteAttachmentCommand::KMDeleteAttachmentCommand(partNode * node, KMMessage * msg, QWidget * parent) :
     AttachmentModifyCommand( node, msg, parent )
 {
   kDebug() ;
 }
 
+KMDeleteAttachmentCommand::KMDeleteAttachmentCommand( int nodeId, KMMessage *msg, QWidget *parent )
+  : AttachmentModifyCommand( nodeId, msg, parent )
+{
+  kDebug();
+}
+
 KMDeleteAttachmentCommand::~KMDeleteAttachmentCommand()
 {
   kDebug() ;
@@ -3314,38 +3305,9 @@
 KMCommand::Result KMDeleteAttachmentCommand::doAttachmentModify()
 {
   KMMessage *msg = retrievedMessage();
-  KMMessagePart part;
-  DwBodyPart *dwpart = findPart( msg, mPartIndex );
-  if ( !dwpart )
+  if ( !msg || !msg->deleteBodyPart( mPartIndex ) )
     return Failed;
-  KMMessage::bodyPart( dwpart, &part, true );
-  if ( !part.isComplete() )
-     return Failed;
 
-  DwBody *parentNode = dynamic_cast<DwBody*>( dwpart->Parent() );
-  if ( !parentNode )
-    return Failed;
-  parentNode->RemoveBodyPart( dwpart );
-
-  // add dummy part to show that a attachment has been deleted
-  KMMessagePart dummyPart;
-  dummyPart.duplicate( part );
-  QString comment = i18n("This attachment has been deleted.");
-  if ( !part.fileName().isEmpty() )
-    comment = i18n( "The attachment '%1' has been deleted.", part.fileName() );
-  dummyPart.setContentDescription( comment );
-  dummyPart.setBodyEncodedBinary( QByteArray() );
-  QByteArray cd = dummyPart.contentDisposition();
-  if ( cd.toLower().indexOf( "inline" ) == 0 ) {
-    cd.replace( 0, 10, "attachment" );
-    dummyPart.setContentDisposition( cd );
-  } else if ( cd.isEmpty() ) {
-    dummyPart.setContentDisposition( "attachment" );
-  }
-  DwBodyPart* newDwPart = msg->createDWBodyPart( &dummyPart );
-  parentNode->AddBodyPart( newDwPart );
-  msg->getTopLevelPart()->Assemble();
-
   KMMessage *newMsg = new KMMessage();
   newMsg->fromDwString( msg->asDwString() );
   newMsg->setStatus( msg->status() );
@@ -3358,10 +3320,17 @@
 KMEditAttachmentCommand::KMEditAttachmentCommand(partNode * node, KMMessage * msg, QWidget * parent) :
     AttachmentModifyCommand( node, msg, parent )
 {
-  kDebug() ;
+  kDebug();
   mTempFile.setAutoRemove( true );
 }
 
+KMEditAttachmentCommand::KMEditAttachmentCommand( int nodeId, KMMessage *msg, QWidget *parent )
+  : AttachmentModifyCommand( nodeId, msg, parent )
+{
+  kDebug();
+  mTempFile.setAutoRemove( true );
+}
+
 KMEditAttachmentCommand::~ KMEditAttachmentCommand()
 {
 }
@@ -3369,8 +3338,11 @@
 KMCommand::Result KMEditAttachmentCommand::doAttachmentModify()
 {
   KMMessage *msg = retrievedMessage();
+  if ( !msg )
+    return Failed;
+
   KMMessagePart part;
-  DwBodyPart *dwpart = findPart( msg, mPartIndex );
+  DwBodyPart *dwpart = msg->findPart( mPartIndex );
   if ( !dwpart )
     return Failed;
   KMMessage::bodyPart( dwpart, &part, true );
@@ -3416,7 +3388,7 @@
   // build the new message
   KMMessage *msg = retrievedMessage();
   KMMessagePart part;
-  DwBodyPart *dwpart = findPart( msg, mPartIndex );
+  DwBodyPart *dwpart = msg->findPart( mPartIndex );
   KMMessage::bodyPart( dwpart, &part, true );
 
   DwBody *parentNode = dynamic_cast<DwBody*>( dwpart->Parent() );
Index: kmail/kmkernel.cpp
===================================================================
--- kmail/kmkernel.cpp	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ kmail/kmkernel.cpp	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -30,10 +30,10 @@
 #include "recentaddresses.h"
 using KPIM::RecentAddresses;
 #include "kmmsgdict.h"
-
 #include "configuredialog.h"
 #include "kmcommands.h"
 #include "kmsystemtray.h"
+#include "stringutil.h"
 
 // kdepimlibs includes
 #include <kpimidentities/identity.h>
@@ -306,8 +306,18 @@
     // not called with "-session foo"
     for(int i= 0; i < args->count(); i++)
     {
-      if (args->arg(i).startsWith(QLatin1String("mailto:"), Qt::CaseInsensitive))
-        to += args->url(i).path() + ", ";
+      if ( args->arg(i).startsWith( QLatin1String( "mailto:" ), Qt::CaseInsensitive ) ) {
+        QString mailtoTo, mailtoBody, mailtoSubject, mailtoCC;
+        KMail::StringUtil::parseMailtoUrl( args->url( i ), mailtoTo, mailtoCC, mailtoSubject, mailtoBody );
+        if ( !mailtoTo.isEmpty() )
+          to += mailtoTo + ", ";
+        if ( !mailtoCC.isEmpty() )
+          cc += mailtoCC + ", ";
+        if ( !mailtoSubject.isEmpty() )
+          subj = mailtoSubject;
+        if ( !mailtoBody.isEmpty() )
+          body = mailtoBody;
+      }
       else {
         QString tmpArg = args->arg(i);
         KUrl url( tmpArg );
@@ -462,6 +472,8 @@
 
   KMail::Composer * cWin = KMail::makeComposer( msg );
   cWin->setCharset( "", true );
+  if (!to.isEmpty())
+    cWin->setFocusToSubject();
   KUrl::List attachURLs = KUrl::List( attachmentPaths );
   for ( KUrl::List::ConstIterator it = attachURLs.constBegin() ; it != attachURLs.constEnd() ; ++it )
     cWin->addAttach( (*it) );
@@ -2079,18 +2091,16 @@
 
 KMainWindow* KMKernel::mainWin()
 {
-  KMainWindow *kmWin = 0;
-
   // First look for a KMMainWin.
   foreach ( KMainWindow* window, KMainWindow::memberList() )
     if ( ::qobject_cast<KMMainWin *>(window) )
-      return kmWin;
+      return window;
 
   // There is no KMMainWin. Use any other KMainWindow instead (e.g. in
   // case we are running inside Kontact) because we anyway only need
   // it for modal message boxes and for KNotify events.
   if ( !KMainWindow::memberList().isEmpty() ) {
-    kmWin = KMainWindow::memberList().first();
+    KMainWindow *kmWin = KMainWindow::memberList().first();
     if ( kmWin )
       return kmWin;
   }
Index: kmail/kmmsgbase.cpp
===================================================================
--- kmail/kmmsgbase.cpp	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ kmail/kmmsgbase.cpp	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -447,11 +447,12 @@
   for (QStringList::Iterator it = encodingNames.begin();
     it != encodingNames.end(); ++it)
   {
-    QTextCodec *codec = KGlobal::charsets()->codecForName(*it);
-    QString mimeName = (codec) ? QString(codec->name()).toLower() : (*it);
-    if (!mimeNames.contains(mimeName) )
+    bool ok;
+    QTextCodec *codec = KGlobal::charsets()->codecForName( *it, ok );
+    QString mimeName = codec ? QString( codec->name() ).toLower() : *it;
+    if ( ok && !mimeNames.contains( mimeName ) )
     {
-      encodings.append( KGlobal::charsets()->descriptionForEncoding(*it) );
+      encodings.append( KGlobal::charsets()->descriptionForEncoding( *it ) );
       mimeNames.insert( mimeName, true );
     }
   }
Index: kmail/kmmainwidget.cpp
===================================================================
--- kmail/kmmainwidget.cpp	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ kmail/kmmainwidget.cpp	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -4414,8 +4414,8 @@
   actionCollection()->action( "send_queued" )->setEnabled( kmkernel->outboxFolder()->count() > 0 );
   actionCollection()->action( "send_queued_via" )->setEnabled( kmkernel->outboxFolder()->count() > 0 );
   slotUpdateOnlineStatus( static_cast<GlobalSettingsBase::EnumNetworkState::type>( GlobalSettings::self()->networkState() ) );
-  if (action( "edit_undo" ))
-    action( "edit_undo" )->setEnabled( kmkernel->undoStack()->size() > 0 );
+  if (action( "kmail_undo" ))
+    action( "kmail_undo" )->setEnabled( kmkernel->undoStack()->size() > 0 );
 
   if ( ( count == 1 ) && currentMessage )
   {
@@ -4747,8 +4747,8 @@
 //-----------------------------------------------------------------------------
 void KMMainWidget::slotUpdateUndo()
 {
-  if ( actionCollection()->action( "edit_undo" ) ) {
-    actionCollection()->action( "edit_undo" )->setEnabled( kmkernel->undoStack()->size() > 0 );
+  if ( actionCollection()->action( "kmail_undo" ) ) {
+    actionCollection()->action( "kmail_undo" )->setEnabled( kmkernel->undoStack()->size() > 0 );
   }
 }
 
Index: kmail/kmfolderdialog.cpp
===================================================================
--- kmail/kmfolderdialog.cpp	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ kmail/kmfolderdialog.cpp	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -539,6 +539,7 @@
 
   // folder contents
   if ( ( !mIsLocalSystemFolder || mIsResourceFolder ) &&
+       mDlg->folder() && mDlg->folder()->folderType() != KMFolderTypeImap &&
        kmkernel->iCalIface().isEnabled() ) {
     // Only do make this settable, if the IMAP resource is enabled
     // and it's not the personal folders (those must not be changed)
@@ -747,7 +748,7 @@
   folder->setPutRepliesInSameFolder( mKeepRepliesInSameFolderCheckBox->isChecked() );
 
   QString fldName, oldFldName;
-  if ( !mIsLocalSystemFolder )
+  if ( !mIsLocalSystemFolder || mIsResourceFolder )
   {
     QString acctName;
     oldFldName = mDlg->folder()->name();
Index: kmail/kmcommands.h
===================================================================
--- kmail/kmcommands.h	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ kmail/kmcommands.h	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -983,11 +983,11 @@
   Q_OBJECT
   public:
     AttachmentModifyCommand( partNode *node, KMMessage *msg, QWidget *parent );
+    AttachmentModifyCommand( int nodeId, KMMessage *msg, QWidget *parent );
     ~AttachmentModifyCommand();
 
   protected:
     void storeChangedMessage( KMMessage* msg );
-    DwBodyPart* findPart( KMMessage* msg, int index );
     virtual Result doAttachmentModify() = 0;
 
   protected:
@@ -996,7 +996,6 @@
 
   private:
     Result execute();
-    DwBodyPart* findPartInternal( DwEntity* root, int index, int &accu );
 
   private slots:
     void messageStoreResult( KMFolderImap* folder, bool success );
@@ -1011,6 +1010,7 @@
   Q_OBJECT
   public:
     KMDeleteAttachmentCommand( partNode *node, KMMessage *msg, QWidget *parent );
+    KMDeleteAttachmentCommand( int nodeId, KMMessage *msg, QWidget *parent );
     ~KMDeleteAttachmentCommand();
 
   protected:
@@ -1023,6 +1023,7 @@
   Q_OBJECT
   public:
     KMEditAttachmentCommand( partNode *node, KMMessage *msg, QWidget *parent );
+    KMEditAttachmentCommand( int nodeId, KMMessage *msg, QWidget *parent );
     ~KMEditAttachmentCommand();
 
   protected:
Index: kmail/kmcomposewin.cpp
===================================================================
--- kmail/kmcomposewin.cpp	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ kmail/kmcomposewin.cpp	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -170,7 +170,7 @@
     mAutoSaveTimer( 0 ), mLastAutoSaveErrno( 0 ),
     mSignatureStateIndicator( 0 ), mEncryptionStateIndicator( 0 ),
     mPreventFccOverwrite( false ),
-    mCheckForRecipients( false )
+    mCheckForRecipients( true )
 {
   (void) new MailcomposerAdaptor( this );
   mdbusObjectPath = "/Composer_" + QString::number( ++s_composerNumber );
@@ -1801,6 +1801,8 @@
           kDebug() << "found image in multipart/related : " << node->msgPart().name();
           QImage img;
           img.loadFromData( KMime::Codec::codecForName( "base64" )->decode( node->msgPart().body() )); // create image from the base64 encoded one
+
+          QSet<int> cursorPositionsToSkip;
           QTextBlock currentBlock = mEditor->document()->begin();
           QTextBlock::iterator it;
           while ( currentBlock.isValid() ) {
@@ -1812,12 +1814,19 @@
                      imageFormat.name() == "cid:" + node->msgPart().contentId() ) {
                   kDebug() << "newImageFormat.Name="<< imageFormat.name();
                   int pos = fragment.position();
-                  QTextCursor cursor( mEditor->document() );
-                  cursor.setPosition( pos );
-                  cursor.setPosition( pos + 1, QTextCursor::KeepAnchor );
-                  cursor.removeSelectedText();
-                  mEditor->document()->addResource( QTextDocument::ImageResource, QUrl( node->msgPart().name() ), QVariant( img ) );
-                  cursor.insertImage( node->msgPart().name() );
+                  if ( !cursorPositionsToSkip.contains( pos ) ) {
+                    QTextCursor cursor( mEditor->document() );
+                    cursor.setPosition( pos );
+                    cursor.setPosition( pos + 1, QTextCursor::KeepAnchor );
+                    cursor.removeSelectedText();
+                    mEditor->document()->addResource( QTextDocument::ImageResource, QUrl( node->msgPart().name() ), QVariant( img ) );
+                    cursor.insertImage( node->msgPart().name() );
+
+                    // The textfragment iterator is now invalid, restart from the beginning
+                    // Take care not to replace the same fragment again, or we would be in an infinite loop.
+                    cursorPositionsToSkip.insert( pos );
+                    it = currentBlock.begin();
+                  }
                 }
               }
             }
@@ -4036,7 +4045,7 @@
   // disable certain actions if there is no PGP user identity set
   // for this profile
   bool bNewIdentityHasSigningKey = !ident.pgpSigningKey().isEmpty() || !ident.smimeSigningKey().isEmpty();
-  bool bNewIdentityHasEncryptionKey = !ident.pgpSigningKey().isEmpty() || !ident.smimeSigningKey().isEmpty();
+  bool bNewIdentityHasEncryptionKey = !ident.pgpEncryptionKey().isEmpty() || !ident.smimeEncryptionKey().isEmpty();
   mAttachMPK->setEnabled( Kleo::CryptoBackendFactory::instance()->openpgp() &&
                           !ident.pgpEncryptionKey().isEmpty() );
   // save the state of the sign and encrypt button
@@ -4048,16 +4057,21 @@
     mLastSignActionState = mSignAction->isChecked();
     setSigning( false );
   }
-  // restore the last state of the sign and encrypt button
+  // restore the last state of the encrypt button
   if ( bNewIdentityHasEncryptionKey && !mLastIdentityHasEncryptionKey ) {
     setEncryption( mLastEncryptActionState );
   }
+  // if the new identity has a signing key but the last had none, the signing can
+  // not be activated. Therefore set the signing to what is globally defined
   if ( bNewIdentityHasSigningKey && !mLastIdentityHasSigningKey ) {
-    setSigning( mLastSignActionState );
+    // setSigning() already uses this member as the state of the currently selected identity
+    mLastIdentityHasSigningKey = true;
+    setSigning( GlobalSettings::self()->pgpAutoSign() );
   }
 
   mLastIdentityHasSigningKey = bNewIdentityHasSigningKey;
   mLastIdentityHasEncryptionKey = bNewIdentityHasEncryptionKey;
+  slotUpdateSignatureAndEncrypionStateIndicators();
 
   setModified( true );
   mId = uoid;
Index: kmail/kmreaderwin.h
===================================================================
--- kmail/kmreaderwin.h	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ kmail/kmreaderwin.h	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -146,8 +146,19 @@
 
   /** Set the message that shall be shown. If msg is 0, an empty page is
       displayed. */
-  virtual void setMsg(KMMessage* msg, bool force = false);
+  virtual void setMsg( KMMessage* msg, bool force = false );
 
+  /**
+   * This should be called when setting a message that was constructed from another message, which
+   * is the case when viewing encapsulated messages in the seperate reader window.
+   * We need to know the serial number of the original message, and at which part index the encapsulated
+   * message was at that original message, so that deleting and editing attachments can work on the
+   * original message.
+   *
+   * @see slotDeleteAttachment, slotEditAttachment, fillCommandInfo
+   */
+  void setOriginalMsg( unsigned long serNumOfOriginalMessage, int nodeIdOffset );
+
   /** Instead of settings a message to be shown sets a message part
       to be shown */
   void setMsgPart( KMMessagePart* aMsgPart, bool aHTML,
@@ -217,13 +228,17 @@
   /** Enable the displaying of messages again after an URL was displayed */
   void enableMsgDisplay();
 
-  /** View message part of type message/RFC822 in extra viewer window. */
-  void atmViewMsg(KMMessagePart* msgPart);
+  /**
+   * View message part of type message/RFC822 in extra viewer window.
+   * @param msgPart the part to display
+   * @param nodeId the part index of the message part that is displayed
+   */
+  void atmViewMsg( KMMessagePart* msgPart, int nodeId );
 
   bool atBottom() const;
 
   bool isFixedFont() { return mUseFixedFont; }
-  void setUseFixedFont( bool useFixedFont ) { mUseFixedFont = useFixedFont; }
+  void setUseFixedFont( bool useFixedFont );
 
   /** Return the HtmlWriter connected to the KHTMLPart we use */
   KMail::HtmlWriter * htmlWriter() { return mHtmlWriter; }
@@ -393,6 +408,15 @@
   void slotLevelQuote( int l );
   void slotTouchMessage();
 
+  /**
+   * Find the node ID and the message of the attachment that should be edited or deleted.
+   * This is used when setOriginalMsg() was called before, in that case we want to operate
+   * on the original message instead of our copy.
+   *
+   * @see setOriginalMsg
+   */
+  void fillCommandInfo( partNode *node, KMMessage **msg, int *nodeId );
+
   void slotDeleteAttachment( partNode* node );
   void slotEditAttachment( partNode* node );
 
@@ -507,6 +531,11 @@
   int mAtmCurrent;
   QString mAtmCurrentName;
   KMMessage *mMessage;
+
+  // See setOriginalMsg() for an explaination for those two.
+  unsigned long mSerNumOfOriginalMessage;
+  int mNodeIdOffset;
+
   // widgets:
   QSplitter * mSplitter;
   KHBox *mBox;
Index: kmail/configuredialog.cpp
===================================================================
--- kmail/configuredialog.cpp	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ kmail/configuredialog.cpp	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -1249,7 +1249,6 @@
   { "list-unread-font", I18N_NOOP("Message List - Unread Messages"), true, false },
   { "list-important-font", I18N_NOOP("Message List - Important Messages"), true, false },
   { "list-toact-font", I18N_NOOP("Message List - Action Item Messages"), true, false },
-  { "list-date-font", I18N_NOOP("Message List - Date Field"), true, false },
   { "folder-font", I18N_NOOP("Folder List"), true, false },
   { "quote1-font", I18N_NOOP("Quoted Text - First Level"), false, false },
   { "quote2-font", I18N_NOOP("Quoted Text - Second Level"), false, false },
@@ -3023,7 +3022,7 @@
 
   // editor group:
   mExternalEditorCheck->setChecked( GlobalSettings::self()->useExternalEditor() );
-  mEditorRequester->setUrl( KUrl( GlobalSettings::self()->externalEditor() ) );
+  mEditorRequester->setText( GlobalSettings::self()->externalEditor() );
 }
 
 void ComposerPage::GeneralTab::installProfile( KConfig * profile ) {
@@ -3084,7 +3083,7 @@
 
   // editor group:
   GlobalSettings::self()->setUseExternalEditor( mExternalEditorCheck->isChecked() );
-  GlobalSettings::self()->setExternalEditor( mEditorRequester->url().toLocalFile() );
+  GlobalSettings::self()->setExternalEditor( mEditorRequester->text() );
 }
 
 void ComposerPage::GeneralTab::slotConfigureRecentAddresses( )
Index: kmail/kmcomposereditor.cpp
===================================================================
--- kmail/kmcomposereditor.cpp	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ kmail/kmcomposereditor.cpp	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -36,6 +36,7 @@
 #include <KMenu>
 #include <KMessageBox>
 #include <KPushButton>
+#include <KInputDialog>
 
 #include <QBuffer>
 #include <QClipboard>
@@ -145,6 +146,8 @@
 
 bool KMComposerEditor::canInsertFromMimeData( const QMimeData *source ) const
 {
+  if ( source->hasImage() && source->hasFormat( "image/png" ) )
+    return true;
   if ( KPIM::MailList::canDecode( source ) )
     return true;
   if ( source->hasFormat( "text/x-kmail-textsnippet" ) )
@@ -157,6 +160,29 @@
 
 void KMComposerEditor::insertFromMimeData( const QMimeData *source )
 {
+  // If this is a PNG image, either add it as an attachment or as an inline image
+  if ( source->hasImage() && source->hasFormat( "image/png" ) ) {
+    if ( textMode() == KRichTextEdit::Rich ) {
+      // Let the textedit from kdepimlibs handle inline images
+      KPIMTextEdit::TextEdit::insertFromMimeData( source );
+      return;
+    }
+
+    // Ok, when we reached this point, the user wants to add the image as an attachment.
+    // Ask for the filename first.
+    bool ok;
+    const QString attName =
+       KInputDialog::getText( "KMail", i18n( "Name of the attachment:" ), QString(), &ok, this );
+    if ( !ok ) {
+      return;
+    }
+
+    const QByteArray imageData = source->data( "image/png" );
+    m_composerWin->addAttachment( attName, "base64", imageData, "image", "png", QByteArray(),
+                                  QString(), QByteArray() );
+    return;
+  }
+
     // If this is a list of mails, attach those mails as forwards.
   if ( KPIM::MailList::canDecode( source ) ) {
 
@@ -212,7 +238,7 @@
     return;
   }
 
-  KPIMTextEdit::TextEdit::insertFromMimeData(source);
+  KPIMTextEdit::TextEdit::insertFromMimeData( source );
 }
 
 #include "kmcomposereditor.moc"
Index: kmail/util.h
===================================================================
--- kmail/util.h	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ kmail/util.h	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -135,6 +135,22 @@
       bool m_disabled;
     };
 
+    /**
+      * Small helper class that implements a variable when it is constructed and decrements that
+      * when it is destructed.
+      * Intended use is to use this with a static int that is initialy 0.
+      */
+    class RecursionPreventer
+    {
+      public:
+        explicit RecursionPreventer( int &counter );
+        ~RecursionPreventer();
+        bool isRecursive() const;
+
+      private:
+        int &mCounter;
+    };
+
 }
 }
 
Index: kmail/folderview.cpp
===================================================================
--- kmail/folderview.cpp	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ kmail/folderview.cpp	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -2294,15 +2294,6 @@
       e->mimeData()->hasFormat( KPIM::MailList::mimeDataType() )
     )
   {
-    // show all the items (we might want to drop anywhere)
-    QTreeWidgetItemIterator it( this );
-    while ( *it )
-    {
-      if ( ( *it )->isHidden() )
-        ( *it )->setHidden( false );
-      ++it;
-    }
-
     e->acceptProposedAction();
   } else
     e->ignore();
Index: kmail/kmreadermainwin.h
===================================================================
--- kmail/kmreadermainwin.h	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ kmail/kmreadermainwin.h	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -38,8 +38,16 @@
 
   void setUseFixedFont( bool useFixedFont );
 
-  // take ownership of and show @param msg
-  void showMsg( const QString & encoding, KMMessage *msg );
+  /**
+   * take ownership of and show @param msg
+   *
+   * The last two paramters, serNumOfOriginalMessage and nodeIdOffset, are needed when @p msg
+   * is derived from another message, e.g. the user views an encapsulated message in this window.
+   * Then, the reader needs to know about that original message, so those to paramters are passed
+   * onto setOriginalMsg() of KMReaderWin.
+   */
+  void showMsg( const QString & encoding, KMMessage *msg,
+                unsigned long serNumOfOriginalMessage = 0, int nodeIdOffset = -1 );
 
 private slots:
   void slotMsgPopup(KMMessage &aMsg, const KUrl &aUrl, const QPoint& aPoint);
@@ -76,7 +84,7 @@
   KUrl mUrl;
   // a few actions duplicated from kmmainwidget
   KAction *mTrashAction, *mPrintAction, *mSaveAsAction, *mSaveAtmAction,
-          *mViewSourceAction, *mCopyTextAction;
+          *mViewSourceAction;
   KActionMenu *mCopyActionMenu;
   KFontAction *fontAction;
   KFontSizeAction *fontSizeAction;
Index: kmail/objecttreeparser.cpp
===================================================================
--- kmail/objecttreeparser.cpp	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ kmail/objecttreeparser.cpp	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -201,6 +201,7 @@
       desc.FromString( cntDesc );
       desc.SetModified();
       myBody->Headers().Parse();
+      kDebug() << "SUBJECT:" << myBody->Headers().Subject().AsString().c_str() << "FROM:" << myBody->Headers().From().AsString().c_str();
     }
 
     partNode* parentNode = &startNode;
@@ -933,7 +934,11 @@
                                   "<a href=\"kmail:showHTML\">by clicking here</a>.") );
         htmlWriter()->queue( "</div><br><br>" );
       }
+      // Make sure the body is relative, so that nothing is painted over above "Note: ..."
+      // if a malicious message uses absolute positioning. #137643
+      htmlWriter()->queue( "<div style=\"position: relative\">\n" );
       htmlWriter()->queue( bodyText );
+      htmlWriter()->queue( "</div>\n" );
       mReader->mColorBar->setHtmlMode();
       return true;
     }
@@ -991,7 +996,7 @@
     //  curNode = curNode->mRoot;
 
     // at least one message found: build a mime tree
-    digestHeaderStr = "Content-Type=text/plain\nContent-Description=digest header\n\n";
+    digestHeaderStr = "Content-Type: text/plain\nContent-Description: digest header\n\n";
     digestHeaderStr += str.mid( 0, thisDelim );
     insertAndParseNewChildNode( *curNode,
                                 digestHeaderStr.toLatin1(),
@@ -1018,7 +1023,7 @@
       //while( thisDelim < cstr.size() && '\n' == cstr[thisDelim] )
       //  ++thisDelim;
 
-      partStr = "Content-Type=message/rfc822\nContent-Description=embedded message\n";
+      partStr = "Content-Type: message/rfc822\nContent-Description: embedded message\n\n";
       partStr += str.mid( thisDelim, nextDelim-thisDelim );
       QString subject = QString::fromLatin1("embedded message");
       QString subSearch = QString::fromLatin1("\nSubject:");
@@ -1029,7 +1034,7 @@
         if ( -1 < thisEoL )
           subject.truncate( thisEoL );
       }
-      kDebug() << "        embedded message found: \"" << subject <<"\"";
+      kDebug() << "        embedded message found:" << subject;
       insertAndParseNewChildNode( *curNode,
                                   partStr.toLatin1(),
                                   subject.toLatin1(), true );
@@ -1055,7 +1060,7 @@
     }
     else
       thisDelim = thisDelim+1;
-    partStr = "Content-Type=text/plain\nContent-Description=digest footer\n\n";
+    partStr = "Content-Type: text/plain\nContent-Description: digest footer\n\n";
     partStr += str.mid( thisDelim );
     insertAndParseNewChildNode( *curNode,
                                 partStr.toLatin1(),
@@ -1159,6 +1164,13 @@
 
     partNode * dataHtml = child->findType( DwMime::kTypeText,
                                            DwMime::kSubtypeHtml, false, true );
+    if ( !dataHtml ) {
+      // If we didn't find the HTML part as the first child of the multipart/alternative, it might
+      // be that this is a HTML message with images, and text/plain and multipart/related are the
+      // immediate children of this multipart/alternative node.
+      // In this case, the HTML node is a child of multipart/related.
+      dataHtml = child->findType( DwMime::kTypeMultipart, DwMime::kSubtypeRelated, false, true );
+    }
     partNode * dataPlain = child->findType( DwMime::kTypeText,
                                             DwMime::kSubtypePlain, false, true );
 
Index: kmail/kmversion.h
===================================================================
--- kmail/kmversion.h	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ kmail/kmversion.h	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -3,6 +3,6 @@
 #ifndef kmversion_h
 #define kmversion_h
 
-#define KMAIL_VERSION "1.12.0"
+#define KMAIL_VERSION "1.12.1"
 
 #endif /*kmversion_h*/
Index: kalarm/ox64-app-kalarm.png
===================================================================
Nie można wyświetlić: plik binarny.
svn:mime-type = application/octet-stream
Index: kalarm/hi16-app-kalarm.png
===================================================================
Nie można wyświetlić: plik binarny.
svn:mime-type = image/png
Index: kalarm/ox22-app-kalarm.png
===================================================================
Nie można wyświetlić: plik binarny.
svn:mime-type = application/octet-stream
Index: kalarm/ox32-app-kalarm.png
===================================================================
Nie można wyświetlić: plik binarny.
svn:mime-type = application/octet-stream
Index: kalarm/ox48-app-kalarm.png
===================================================================
Nie można wyświetlić: plik binarny.
svn:mime-type = application/octet-stream
Index: kalarm/hi32-app-kalarm.png
===================================================================
Nie można wyświetlić: plik binarny.
svn:mime-type = image/png
Index: kalarm/ox128-app-kalarm.png
===================================================================
Nie można wyświetlić: plik binarny.
svn:mime-type = application/octet-stream
Index: kalarm/ox16-app-kalarm.png
===================================================================
Nie można wyświetlić: plik binarny.
svn:mime-type = application/octet-stream
Index: kalarm/hi48-app-kalarm.png
===================================================================
Nie można wyświetlić: plik binarny.
svn:mime-type = image/png
Index: kalarm/kamail.cpp
===================================================================
--- kalarm/kamail.cpp	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ kalarm/kamail.cpp	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -182,11 +182,11 @@
 			if (!jobdata.bcc.isEmpty())
 			{
 				command += QLatin1String(" -b ");
-				command += KShell::quoteArg(jobdata.bcc);
+				command += KPIMUtils::extractEmailAddress(jobdata.bcc);
 			}
 
 			command += ' ';
-			command += jobdata.event.emailAddresses(" "); // locally provided, okay
+			command += jobdata.event.emailPureAddresses(" "); // locally provided, okay
 		}
 
 		// Add the body and attachments to the message.
@@ -250,10 +250,10 @@
 			errmsgs = errors(err);
 			return -1;
 		}
-		mailjob->setSender(jobdata.from);
-		mailjob->setTo(QStringList(jobdata.event.emailAddresses()));
+		mailjob->setSender(KPIMUtils::extractEmailAddress(jobdata.from));
+		mailjob->setTo(jobdata.event.emailPureAddresses());
 		if (!jobdata.bcc.isEmpty())
-			mailjob->setBcc(QStringList(jobdata.bcc));
+			mailjob->setBcc(QStringList(KPIMUtils::extractEmailAddress(jobdata.bcc)));
 		mailjob->setData(message.toLocal8Bit());
 		mJobs.enqueue(mailjob);
 		mJobData.enqueue(jobdata);
Index: kalarm/editdlgprivate.h
===================================================================
--- kalarm/editdlgprivate.h	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ kalarm/editdlgprivate.h	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -1,7 +1,7 @@
 /*
  *  editdlgprivate.h  -  private classes for editdlg.cpp
  *  Program:  kalarm
- *  Copyright © 2003-2005,2007,2008 by David Jarvie <djarvie@kde.org>
+ *  Copyright © 2003-2005,2007-2009 by David Jarvie <djarvie@kde.org>
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -67,6 +67,7 @@
 
 	signals:
 		void      scriptToggled(bool);
+		void      changed();        // emitted when any changes occur
 
 	private slots:
 		void      slotCmdScriptToggled(bool);
Index: kalarm/functions.h
===================================================================
--- kalarm/functions.h	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ kalarm/functions.h	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -92,6 +92,7 @@
 void                editNewTemplate(EditAlarmDlg::Type, QWidget* parent = 0);
 void                editNewTemplate(const KAEvent* preset, QWidget* parent = 0);
 void                editTemplate(KAEvent*, QWidget* parent = 0);
+void                execNewAlarmDlg(EditAlarmDlg*, bool alreadyExecuted = false);
 /** Create a "New From Template" QAction */
 TemplateMenuAction* createNewFromTemplateAction(const QString& label, KActionCollection*, const QString& name);
 KToggleAction*      createAlarmEnableAction(QObject* parent);
@@ -104,7 +105,6 @@
 void                refreshAlarms();
 void                refreshAlarmsIfQueued();    // must only be called from KAlarmApp::processQueue()
 QString             runKMail(bool minimise);
-bool                runProgram(const QString& program, QString& dbusService, const QString& dbusWindowPath, QString& errorMessage);
 
 QStringList         dontShowErrors(const QString& eventId);
 bool                dontShowErrors(const QString& eventId, const QString& tag);
@@ -137,7 +137,7 @@
 void                displayUpdateError(QWidget* parent, UpdateStatus, UpdateError, int nAlarms, int nKOrgAlarms = 1, bool showKOrgError = true);
 void                displayKOrgUpdateError(QWidget* parent, UpdateError, UpdateStatus korgError, int nAlarms);
 
-bool                convTimeString(const QByteArray& timeString, KDateTime& dateTime, const KDateTime& defaultDt = KDateTime(), bool allowTZ = true);
+bool                convertTimeString(const QByteArray& timeString, KDateTime& dateTime, const KDateTime& defaultDt = KDateTime(), bool allowTZ = true);
 KDateTime           applyTimeZone(const QString& tzstring, const QDate& date, const QTime& time,
                                   bool haveTime, const KDateTime& defaultDt = KDateTime());
 bool                isWorkingTime(const KDateTime&, const KAEvent*);
@@ -158,7 +158,7 @@
 
 #ifndef NDEBUG
 void                setTestModeConditions();
-bool                setSimulatedSystemTime(const QByteArray& timeString);
+void                setSimulatedSystemTime(const KDateTime&);
 #endif
 
 } // namespace KAlarm
Index: kalarm/commandoptions.cpp
===================================================================
--- kalarm/commandoptions.cpp	(.../tags/KDE/4.3.0/kdepim)	(wersja 0)
+++ kalarm/commandoptions.cpp	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -0,0 +1,597 @@
+/*
+ *  commandoptions.cpp  -  extract command line options
+ *  Program:  kalarm
+ *  Copyright © 2001-2009 by David Jarvie <djarvie@kde.org>
+ *
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the GNU General Public License as published by
+ *  the Free Software Foundation; either version 2 of the License, or
+ *  (at your option) any later version.
+ *
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
+ *  GNU General Public License for more details.
+ *
+ *  You should have received a copy of the GNU General Public License along
+ *  with this program; if not, write to the Free Software Foundation, Inc.,
+ *  51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ */
+
+#include "kalarm.h"
+#include "commandoptions.h"
+#include "functions.h"
+#include "kalarmapp.h"
+#include "kamail.h"
+#include "identities.h"
+
+#include <kcmdlineargs.h>
+
+#include <iostream>
+
+static bool convInterval(const QByteArray& timeParam, KARecurrence::Type&, int& timeInterval, bool allowMonthYear = false);
+
+void CommandOptions::setError(const QString& error)
+{
+	if (mError.isEmpty())
+		mError = error;
+}
+
+CommandOptions::CommandOptions()
+	: mCommand(NONE),
+	  mEditActionSet(false),
+	  mRecurrence(0),
+	  mRepeatCount(0),
+	  mRepeatInterval(0),
+	  mLateCancel(0),
+	  mBgColour(Preferences::defaultBgColour()),
+	  mFgColour(Preferences::defaultFgColour()),
+	  mReminderMinutes(0),
+	  mAudioVolume(-1),
+	  mFromID(0),
+	  mFlags(KAEvent::DEFAULT_FONT)
+{
+	mArgs = KCmdLineArgs::parsedArgs();
+#ifndef NDEBUG
+	if (mArgs->isSet("test-set-time"))
+	{
+		QString time = mArgs->getOption("test-set-time");
+		if (!KAlarm::convertTimeString(time.toLatin1(), mSimulationTime, KDateTime::realCurrentLocalDateTime(), true))
+			setErrorParameter("--test-set-time");
+	}
+#endif
+	if (checkCommand("tray", TRAY))
+	{
+	}
+	if (checkCommand("triggerEvent", TRIGGER_EVENT))
+	{
+		mEventId = mArgs->getOption(mCommandName);
+	}
+	if (checkCommand("cancelEvent", CANCEL_EVENT))
+	{
+		mEventId = mArgs->getOption(mCommandName);
+	}
+	if (checkCommand("edit", EDIT))
+	{
+		mEventId = mArgs->getOption(mCommandName);
+	}
+	if (checkCommand("edit-new-preset", EDIT_NEW_PRESET))
+	{
+		mTemplateName = mArgs->getOption(mCommandName);
+	}
+	if (checkCommand("file", NEW))
+	{
+		mEditType      = EditAlarmDlg::DISPLAY;
+		mEditAction    = KAEvent::FILE;
+		mEditActionSet = true;
+		mText          = mArgs->getOption(mCommandName);
+	}
+	if (checkCommand("exec-display", NEW))
+	{
+		mEditType      = EditAlarmDlg::DISPLAY;
+		mEditAction    = KAEvent::COMMAND;
+		mEditActionSet = true;
+		mFlags        |= KAEvent::DISPLAY_COMMAND;
+		mText          = mArgs->getOption(mCommandName);
+		int n = mArgs->count();
+		for (int i = 0;  i < n;  ++i)
+		{
+			mText += ' ';
+			mText += mArgs->arg(i);
+		}
+	}
+	if (checkCommand("exec", NEW))
+	{
+		mEditType      = EditAlarmDlg::COMMAND;
+		mEditAction    = KAEvent::COMMAND;
+		mEditActionSet = true;
+		mText          = mArgs->getOption(mCommandName);
+		int n = mArgs->count();
+		for (int i = 0;  i < n;  ++i)
+		{
+			mText += ' ';
+			mText += mArgs->arg(i);
+		}
+	}
+	if (checkCommand("mail", NEW))
+	{
+		mEditType      = EditAlarmDlg::EMAIL;
+		mEditAction    = KAEvent::EMAIL;
+		mEditActionSet = true;
+	}
+	if (checkCommand("edit-new-display", EDIT_NEW, EditAlarmDlg::DISPLAY))
+	{
+		mEditType = EditAlarmDlg::DISPLAY;
+		if (!mEditActionSet  ||  (mEditAction != KAEvent::COMMAND && mEditAction != KAEvent::FILE))
+		{
+			mEditAction    = KAEvent::MESSAGE;
+			mEditActionSet = true;
+		}
+		if (mArgs->count())
+			mText = mArgs->arg(0);
+	}
+	if (checkCommand("edit-new-command", EDIT_NEW))
+	{
+		mEditType      = EditAlarmDlg::COMMAND;
+		mEditAction    = KAEvent::COMMAND;
+		mEditActionSet = true;
+	}
+	if (checkCommand("edit-new-email", EDIT_NEW, EditAlarmDlg::EMAIL))
+	{
+		mEditType      = EditAlarmDlg::EMAIL;
+		mEditAction    = KAEvent::EMAIL;
+		mEditActionSet = true;
+	}
+	if (mError.isEmpty()  &&  mCommand == NONE  &&  mArgs->count())
+	{
+		kDebug() << "Message";
+		mCommand       = NEW;
+		mCommandName   = "message";
+		mEditType      = EditAlarmDlg::DISPLAY;
+		mEditAction    = KAEvent::MESSAGE;
+		mEditActionSet = true;
+		if (mArgs->count())
+			mText = mArgs->arg(0);
+	}
+	if (mEditAction == KAEvent::EMAIL)
+	{
+		if (mArgs->isSet("subject"))
+			mSubject = mArgs->getOption("subject");
+		if (mArgs->isSet("from-id"))
+			mFromID = Identities::identityUoid(mArgs->getOption("from-id"));
+		QStringList params = mArgs->getOptionList("mail");
+		for (int i = 0, count = params.count();  i < count;  ++i)
+		{
+			QString addr = params[i];
+			if (!KAMail::checkAddress(addr))
+				setError(i18nc("@info:shell", "<icode>%1</icode>: invalid email address", QLatin1String("--mail")));
+			mAddressees += KCal::Person(QString(), addr);
+		}
+		params = mArgs->getOptionList("attach");
+		for (int i = 0, count = params.count();  i < count;  ++i)
+			mAttachments += params[i];
+		if (mArgs->count())
+			mText = mArgs->arg(0);
+	}
+
+	// Check that other options are only specified for the
+	// correct main command options.
+	checkEditType(EditAlarmDlg::DISPLAY, "color");
+	checkEditType(EditAlarmDlg::DISPLAY, "colorfg");
+	checkEditType(EditAlarmDlg::DISPLAY, "play");
+	checkEditType(EditAlarmDlg::DISPLAY, "play-repeat");
+	checkEditType(EditAlarmDlg::DISPLAY, "volume");
+	checkEditType(EditAlarmDlg::DISPLAY, "speak");
+	checkEditType(EditAlarmDlg::DISPLAY, "beep");
+	checkEditType(EditAlarmDlg::DISPLAY, "reminder");
+	checkEditType(EditAlarmDlg::DISPLAY, "reminder-once");
+	checkEditType(EditAlarmDlg::DISPLAY, "ack-confirm");
+	checkEditType(EditAlarmDlg::DISPLAY, "auto-close");
+	checkEditType(EditAlarmDlg::EMAIL, "subject");
+	checkEditType(EditAlarmDlg::EMAIL, "from-id");
+	checkEditType(EditAlarmDlg::EMAIL, "attach");
+	checkEditType(EditAlarmDlg::EMAIL, "bcc");
+
+	switch (mCommand)
+	{
+		case EDIT_NEW:
+			if (mArgs->isSet("disable"))
+				setErrorIncompatible("--disable", mCommandName);
+			// Fall through to NEW
+		case NEW:
+		{
+			// Display a message or file, execute a command, or send an email
+			if (mArgs->isSet("color"))
+			{
+				// Background colour is specified
+				QString colourText = mArgs->getOption("color");
+				if (colourText[0] == '0' && colourText[1].toLower() == 'x')
+					colourText.replace(0, 2, "#");
+				mBgColour.setNamedColor(colourText);
+				if (!mBgColour.isValid())
+					setErrorParameter("--color");
+			}
+			if (mArgs->isSet("colorfg"))
+			{
+				// Foreground colour is specified
+				QString colourText = mArgs->getOption("colorfg");
+				if (colourText[0] == '0' && colourText[1].toLower() == 'x')
+					colourText.replace(0, 2, "#");
+				mFgColour.setNamedColor(colourText);
+				if (!mFgColour.isValid())
+					setErrorParameter("--colorfg");
+			}
+
+			if (mArgs->isSet("time"))
+			{
+				QByteArray dateTime = mArgs->getOption("time").toLocal8Bit();
+				if (!KAlarm::convertTimeString(dateTime, mAlarmTime))
+					setErrorParameter("--time");
+			}
+			else
+				mAlarmTime = KDateTime::currentLocalDateTime();
+
+			bool haveRecurrence = mArgs->isSet("recurrence");
+			if (haveRecurrence)
+			{
+				if (mArgs->isSet("login"))
+					setErrorIncompatible("--login", "--recurrence");
+				else if (mArgs->isSet("until"))
+					setErrorIncompatible("--until", "--recurrence");
+				QString rule = mArgs->getOption("recurrence");
+				mRecurrence = new KARecurrence;
+				mRecurrence->set(rule);
+			}
+			if (mArgs->isSet("interval"))
+			{
+				// Repeat count is specified
+				int count = 0;
+				KDateTime endTime;
+				if (mArgs->isSet("login"))
+					setErrorIncompatible("--login", "--interval");
+				bool ok;
+				if (mArgs->isSet("repeat"))
+				{
+					count = mArgs->getOption("repeat").toInt(&ok);
+					if (!ok || !count || count < -1 || (count < 0 && haveRecurrence))
+						setErrorParameter("--repeat");
+				}
+				else if (haveRecurrence)
+					setErrorRequires("--interval", "--repeat");
+				else if (mArgs->isSet("until"))
+				{
+					count = 0;
+					QByteArray dateTime = mArgs->getOption("until").toLocal8Bit();
+					bool ok;
+					if (mArgs->isSet("time"))
+						ok = KAlarm::convertTimeString(dateTime, endTime, mAlarmTime);
+					else
+						ok = KAlarm::convertTimeString(dateTime, endTime);
+					if (!ok)
+						setErrorParameter("--until");
+					else if (mAlarmTime.isDateOnly()  &&  !endTime.isDateOnly())
+						setError(i18nc("@info:shell", "Invalid <icode>%1</icode> parameter for date-only alarm", QLatin1String("--until")));
+					if (!mAlarmTime.isDateOnly()  &&  endTime.isDateOnly())
+						endTime.setTime(QTime(23,59,59));
+					if (endTime < mAlarmTime)
+						setError(i18nc("@info:shell", "<icode>%1</icode> earlier than <icode>%2</icode>", QLatin1String("--until"), QLatin1String("--time")));
+				}
+				else
+					count = -1;
+
+				// Get the recurrence interval
+				int interval;
+				KARecurrence::Type recurType;
+				if (!convInterval(mArgs->getOption("interval").toLocal8Bit(), recurType, interval, !haveRecurrence)
+				||  interval < 0)
+					setErrorParameter("--interval");
+				else if (mAlarmTime.isDateOnly()  &&  recurType == KARecurrence::MINUTELY)
+					setError(i18nc("@info:shell", "Invalid <icode>%1</icode> parameter for date-only alarm", QLatin1String("--interval")));
+
+				if (haveRecurrence)
+				{
+					if (mRecurrence)
+					{
+						// There is a also a recurrence specified, so set up a sub-repetition
+						int longestInterval = mRecurrence->longestInterval();
+						if (count * interval > longestInterval)
+							setError(i18nc("@info:shell", "Invalid <icode>%1</icode> and <icode>%2</icode> parameters: repetition is longer than <icode>%3</icode> interval",
+							               QLatin1String("--interval"), QLatin1String("--repeat"), QLatin1String("--recurrence")));
+						mRepeatCount    = count;
+						mRepeatInterval = interval;
+					}
+				}
+				else
+				{
+					// There is no other recurrence specified, so convert the repetition
+					// parameters into a KCal::Recurrence
+					mRecurrence = new KARecurrence;
+					mRecurrence->set(recurType, interval, count, mAlarmTime, endTime);
+				}
+			}
+			else
+			{
+				if (mArgs->isSet("repeat"))
+					setErrorRequires("--repeat", "--interval");
+				else if (mArgs->isSet("until"))
+					setErrorRequires("--until", "--interval");
+			}
+
+			bool audioRepeat = mArgs->isSet("play-repeat");
+			if (audioRepeat  ||  mArgs->isSet("play"))
+			{
+				// Play a sound with the alarm
+				const char* opt = audioRepeat ? "--play-repeat" : "--play";
+				if (audioRepeat  &&  mArgs->isSet("play"))
+					setErrorIncompatible("--play", "--play-repeat");
+				if (mArgs->isSet("beep"))
+					setErrorIncompatible("--beep", opt);
+				else if (mArgs->isSet("speak"))
+					setErrorIncompatible("--speak", opt);
+				mAudioFile = mArgs->getOption(audioRepeat ? "play-repeat" : "play");
+				if (mArgs->isSet("volume"))
+				{
+					bool ok;
+					int volumepc = mArgs->getOption("volume").toInt(&ok);
+					if (!ok  ||  volumepc < 0  ||  volumepc > 100)
+						setErrorParameter("--volume");
+					mAudioVolume = static_cast<float>(volumepc) / 100;
+				}
+			}
+			else if (mArgs->isSet("volume"))
+				setErrorRequires("--volume", "--play", "--play-repeat");
+			if (mArgs->isSet("speak"))
+			{
+				if (mArgs->isSet("beep"))
+					setErrorIncompatible("--beep", "--speak");
+				else if (!theApp()->speechEnabled())
+					setError(i18nc("@info:shell", "<icode>%1</icode> requires speech synthesis to be configured using KTTSD", QLatin1String("--speak")));
+			}
+			bool onceOnly = mArgs->isSet("reminder-once");
+			if (mArgs->isSet("reminder")  ||  onceOnly)
+			{
+				// Issue a reminder alarm in advance of the main alarm
+				if (onceOnly  &&  mArgs->isSet("reminder"))
+					setErrorIncompatible("--reminder", "--reminder-once");
+				const char* opt = onceOnly ? "--reminder-once" : "--reminder";
+				KARecurrence::Type recurType;
+				QString optval = mArgs->getOption(onceOnly ? "reminder-once" : "reminder");
+				if (!convInterval(mArgs->getOption(onceOnly ? "reminder-once" : "reminder").toLocal8Bit(), recurType, mReminderMinutes))
+					setErrorParameter(opt);
+				else if (recurType == KARecurrence::MINUTELY  &&  mAlarmTime.isDateOnly())
+					setError(i18nc("@info:shell", "Invalid <icode>%1</icode> parameter for date-only alarm", QLatin1String(opt)));
+				if (onceOnly)
+					mReminderMinutes = -mReminderMinutes;
+			}
+
+			if (mArgs->isSet("late-cancel"))
+			{
+				KARecurrence::Type recurType;
+				bool ok = convInterval(mArgs->getOption("late-cancel").toLocal8Bit(), recurType, mLateCancel);
+				if (!ok  ||  mLateCancel <= 0)
+					setErrorParameter("--late-cancel");
+			}
+			else if (mArgs->isSet("auto-close"))
+				setErrorRequires("--auto-close", "--late-cancel");
+
+			if (mArgs->isSet("ack-confirm"))
+				mFlags |= KAEvent::CONFIRM_ACK;
+			if (mArgs->isSet("auto-close"))
+				mFlags |= KAEvent::AUTO_CLOSE;
+			if (mArgs->isSet("beep"))
+				mFlags |= KAEvent::BEEP;
+			if (mArgs->isSet("speak"))
+				mFlags |= KAEvent::SPEAK;
+			if (mArgs->isSet("korganizer"))
+				mFlags |= KAEvent::COPY_KORGANIZER;
+			if (mArgs->isSet("disable"))
+				mFlags |= KAEvent::DISABLED;
+			if (audioRepeat)
+				mFlags |= KAEvent::REPEAT_SOUND;
+			if (mArgs->isSet("login"))
+				mFlags |= KAEvent::REPEAT_AT_LOGIN;
+			if (mArgs->isSet("bcc"))
+				mFlags |= KAEvent::EMAIL_BCC;
+			if (mAlarmTime.isDateOnly())
+				mFlags |= KAEvent::ANY_TIME;
+			break;
+		}
+		case NONE:
+			// No arguments - run interactively & display the main window
+			if (!mError.isEmpty())
+				break;
+			kDebug() << "Interactive";
+			if (mArgs->isSet("ack-confirm"))
+				mError += QLatin1String("--ack-confirm ");
+			if (mArgs->isSet("attach"))
+				mError += QLatin1String("--attach ");
+			if (mArgs->isSet("auto-close"))
+				mError += QLatin1String("--auto-close ");
+			if (mArgs->isSet("bcc"))
+				mError += QLatin1String("--bcc ");
+			if (mArgs->isSet("beep"))
+				mError += QLatin1String("--beep ");
+			if (mArgs->isSet("color"))
+				mError += QLatin1String("--color ");
+			if (mArgs->isSet("colorfg"))
+				mError += QLatin1String("--colorfg ");
+			if (mArgs->isSet("disable"))
+				mError += QLatin1String("--disable ");
+			if (mArgs->isSet("from-id"))
+				mError += QLatin1String("--from-id ");
+			if (mArgs->isSet("korganizer"))
+				mError += QLatin1String("--korganizer ");
+			if (mArgs->isSet("late-cancel"))
+				mError += QLatin1String("--late-cancel ");
+			if (mArgs->isSet("login"))
+				mError += QLatin1String("--login ");
+			if (mArgs->isSet("play"))
+				mError += QLatin1String("--play ");
+			if (mArgs->isSet("play-repeat"))
+				mError += QLatin1String("--play-repeat ");
+			if (mArgs->isSet("reminder"))
+				mError += QLatin1String("--reminder ");
+			if (mArgs->isSet("reminder-once"))
+				mError += QLatin1String("--reminder-once ");
+			if (mArgs->isSet("speak"))
+				mError += QLatin1String("--speak ");
+			if (mArgs->isSet("subject"))
+				mError += QLatin1String("--subject ");
+			if (mArgs->isSet("time"))
+				mError += QLatin1String("--time ");
+			if (mArgs->isSet("volume"))
+				mError += QLatin1String("--volume ");
+			if (!mError.isEmpty())
+				mError += i18nc("@info:shell", ": option(s) only valid with an appropriate action option or message");
+			break;
+		default:
+			break;
+	}
+
+	mArgs->clear();      // free up memory
+
+	if (!mError.isEmpty())
+	{
+		printError(mError);
+		mCommand = CMD_ERROR;
+	}
+}
+
+void CommandOptions::printError(const QString& errmsg)
+{
+	// Note: we can't use mArgs->usage() since that also quits any other
+	// running 'instances' of the program.
+	std::cerr << errmsg.toLocal8Bit().data()
+		  << i18nc("@info:shell", "\nUse --help to get a list of available command line options.\n").toLocal8Bit().data();
+}
+
+/******************************************************************************
+* Check if the given command option is specified, and if so set mCommand etc.
+* If another command option has also been detected, issue an error.
+* If 'allowedEditType' is set, supersede any previous specification of that
+* edit type with the given command option - this allows, e.g., --mail to be
+* used along with --edit-new-email so the user can specify addressees.
+*/
+bool CommandOptions::checkCommand(const QByteArray& command, Command code, EditAlarmDlg::Type allowedEditType)
+{
+	if (!mError.isEmpty()
+	||  !mArgs->isSet(command))
+		return false;
+	if (mCommand != NONE
+	&&  (allowedEditType == EditAlarmDlg::NO_TYPE
+	  || (allowedEditType != EditAlarmDlg::NO_TYPE  &&  (mCommand != NEW || mEditType != allowedEditType))))
+		setErrorIncompatible(mCommandName, "--" + command);
+	kDebug().nospace() << " --" << command;
+	mCommand = code;
+	mCommandName = command;
+	return true;
+}
+
+// Set the error message to "--opt requires --opt2" or "--opt requires --opt2 or --opt3".
+void CommandOptions::setErrorRequires(const char* opt, const char* opt2, const char* opt3)
+{
+	if (!opt3)
+		setError(i18nc("@info:shell", "<icode>%1</icode> requires <icode>%2</icode>", QLatin1String(opt), QLatin1String(opt2)));
+	else
+		setError(i18nc("@info:shell", "<icode>%1</icode> requires <icode>%2</icode> or <icode>%3</icode>", QLatin1String(opt), QLatin1String(opt2), QLatin1String(opt3)));
+}
+
+void CommandOptions::setErrorParameter(const char* opt)
+{
+	setError(i18nc("@info:shell", "Invalid <icode>%1</icode> parameter", QLatin1String(opt)));
+}
+
+void CommandOptions::setErrorIncompatible(const QByteArray& opt1, const QByteArray& opt2)
+{
+	QByteArray o1 = opt1;
+	if (!opt1.startsWith("--")  &&  opt1 != "message")
+		o1.prepend("--");
+	QByteArray o2 = opt2;
+	if (!opt2.startsWith("--")  &&  opt2 != "message")
+		o2.prepend("--");
+	setError(i18nc("@info:shell", "<icode>%1</icode> incompatible with <icode>%2</icode>", QString::fromLatin1(o1), QString::fromLatin1(o2)));
+}
+
+void CommandOptions::checkEditType(EditAlarmDlg::Type type, const QByteArray& optName)
+{
+	if (mArgs->isSet(optName)  &&  mCommand != NONE
+	&&  ((mCommand != NEW && mCommand != EDIT_NEW)  ||  mEditType != type))
+		setErrorIncompatible(optName, mCommandName);
+}
+
+/******************************************************************************
+* Convert a time interval command line parameter.
+* 'timeInterval' receives the count for the recurType. If 'allowMonthYear' is
+* false, weeks are converted to days in 'timeInterval'.
+* Reply = true if successful.
+*/
+static bool convInterval(const QByteArray& timeParam, KARecurrence::Type& recurType, int& timeInterval, bool allowMonthYear)
+{
+	QByteArray timeString = timeParam;
+	// Get the recurrence interval
+	bool ok = true;
+	uint interval = 0;
+	bool negative = (timeString[0] == '-');
+	if (negative)
+		timeString = timeString.right(1);
+	uint length = timeString.length();
+	switch (timeString[length - 1])
+	{
+		case 'Y':
+			if (!allowMonthYear)
+				ok = false;
+			recurType = KARecurrence::ANNUAL_DATE;
+			timeString = timeString.left(length - 1);
+			break;
+		case 'W':
+			recurType = KARecurrence::WEEKLY;
+			timeString = timeString.left(length - 1);
+			break;
+		case 'D':
+			recurType = KARecurrence::DAILY;
+			timeString = timeString.left(length - 1);
+			break;
+		case 'M':
+		{
+			int i = timeString.indexOf('H');
+			if (i < 0)
+			{
+				if (!allowMonthYear)
+					ok = false;
+				recurType = KARecurrence::MONTHLY_DAY;
+				timeString = timeString.left(length - 1);
+			}
+			else
+			{
+				recurType = KARecurrence::MINUTELY;
+				interval = timeString.left(i).toUInt(&ok) * 60;
+				timeString = timeString.mid(i + 1, length - i - 2);
+			}
+			break;
+		}
+		default:       // should be a digit
+			recurType = KARecurrence::MINUTELY;
+			break;
+	}
+	if (ok)
+		interval += timeString.toUInt(&ok);
+	if (!allowMonthYear)
+	{
+		// Convert time interval to minutes
+		switch (recurType)
+		{
+			case KARecurrence::WEEKLY:
+				interval *= 7;
+				// fall through to DAILY
+			case KARecurrence::DAILY:
+				interval *= 24*60;
+				break;
+			default:
+				break;
+		}
+	}
+	timeInterval = static_cast<int>(interval);
+	if (negative)
+		timeInterval = -timeInterval;
+	return ok;
+}
Index: kalarm/latecancel.h
===================================================================
--- kalarm/latecancel.h	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ kalarm/latecancel.h	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -1,7 +1,7 @@
 /*
  *  latecancel.h  -  widget to specify cancellation if late
  *  Program:  kalarm
- *  Copyright © 2004,2005,2007 by David Jarvie <software@astrojar.org.uk>
+ *  Copyright © 2004,2005,2007,2009 by David Jarvie <djarvie@kde.org>
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -47,6 +47,9 @@
 		static QString  i18n_chk_AutoCloseWin();     // text of 'Auto-close window after this time' checkbox
 		static QString  i18n_chk_AutoCloseWinLC();   // text of 'Auto-close window after late-cancellation time' checkbox
 
+	signals:
+		void            changed();          // emitted whenever any change occurs
+
 	private slots:
 		void            slotToggled(bool);
 
Index: kalarm/kamail.h
===================================================================
--- kalarm/kamail.h	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ kalarm/kamail.h	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -30,7 +30,6 @@
 
 class KUrl;
 class KJob;
-class DateTime;
 class EmailAddressList;
 namespace MailTransport  { class TransportJob; }
 namespace KMime { namespace Types { struct Address; } }
Index: kalarm/pickfileradio.h
===================================================================
--- kalarm/pickfileradio.h	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ kalarm/pickfileradio.h	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -100,6 +100,9 @@
 		 */
 		virtual void    setEnabled(bool);
 
+	signals:
+		void          fileChanged();   // emitted whenever the selected file changes
+
 	private slots:
 		void          slotSelectionChanged(QAbstractButton*);
 		QString       slotPickFile();
Index: kalarm/reminder.h
===================================================================
--- kalarm/reminder.h	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ kalarm/reminder.h	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -1,7 +1,7 @@
 /*
  *  reminder.h  -  reminder setting widget
  *  Program:  kalarm
- *  Copyright © 2003-2005,2007,2008 by David Jarvie <djarvie@kde.org>
+ *  Copyright © 2003-2005,2007-2009 by David Jarvie <djarvie@kde.org>
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -50,6 +50,9 @@
 	public slots:
 		void           setDefaultUnits(const KDateTime&);
 
+	signals:
+		void           changed();
+
 	private slots:
 		void           slotReminderToggled(bool);
 
Index: kalarm/kalarm.h
===================================================================
--- kalarm/kalarm.h	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ kalarm/kalarm.h	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -23,7 +23,7 @@
 
 #undef QT3_SUPPORT
 
-#define KALARM_VERSION "2.2.6"
+#define KALARM_VERSION "2.2.7"
 #define KALARM_NAME "KAlarm"
 #define KALARM_DBUS_SERVICE  "org.kde.kalarm"  // D-Bus service name of KAlarm application
 
Index: kalarm/mainwindow.cpp
===================================================================
--- kalarm/mainwindow.cpp	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ kalarm/mainwindow.cpp	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -178,6 +178,7 @@
 	connect(resources, SIGNAL(resourceStatusChanged(AlarmResource*, AlarmResources::Change)),
 	                   SLOT(slotResourceStatusChanged()));
 	connect(mResourceSelector, SIGNAL(resized(const QSize&, const QSize&)), SLOT(resourcesResized()));
+	mListView->installEventFilter(this);
 	initActions();
 
 	setAutoSaveSettings(QLatin1String(WINDOW_NAME), true);    // save toolbars, window sizes etc.
@@ -308,6 +309,25 @@
 				break;
 		}
 	}
+	else if (obj == mListView)
+	{
+		switch (e->type())
+		{
+			case QEvent::KeyPress:
+			{
+				QKeyEvent* ke = static_cast<QKeyEvent*>(e);
+				if (ke->key() == Qt::Key_Delete  &&  ke->modifiers() == Qt::ShiftModifier)
+				{
+					// Prevent Shift-Delete being processed by EventListDelegate
+					mActionDeleteForce->trigger();
+					return true;
+				}
+				break;
+			}
+			default:
+				break;
+		}
+	}
 	return false;
 }
 
@@ -441,9 +461,15 @@
 
 	mActionDelete = new KAction(KIcon("edit-delete"), i18nc("@action", "&Delete"), this);
 	actions->addAction(QLatin1String("delete"), mActionDelete);
-	mActionDelete->setShortcut(QKeySequence(Qt::Key_Delete));
-	connect(mActionDelete, SIGNAL(triggered(bool)), SLOT(slotDelete()));
+	mActionDelete->setShortcut(QKeySequence::Delete);
+	connect(mActionDelete, SIGNAL(triggered(bool)), SLOT(slotDeleteIf()));
 
+	// Set up Shift-Delete as a shortcut to delete without confirmation
+	mActionDeleteForce = new KAction(this);
+	actions->addAction(QLatin1String("delete-force"), mActionDeleteForce);
+	mActionDeleteForce->setShortcut(QKeySequence::Delete + Qt::SHIFT);
+	connect(mActionDeleteForce, SIGNAL(triggered(bool)), SLOT(slotDeleteForce()));
+
 	mActionReactivate = new KAction(i18nc("@action", "Reac&tivate"), this);
 	actions->addAction(QLatin1String("undelete"), mActionReactivate);
 	mActionReactivate->setShortcut(QKeySequence(Qt::CTRL + Qt::Key_R));
@@ -684,7 +710,7 @@
 *  Called when the Delete button is clicked to delete the currently highlighted
 *  alarms in the list.
 */
-void MainWindow::slotDelete()
+void MainWindow::slotDelete(bool force)
 {
 	KAEvent::List events = mListView->selectedEvents();
 	// Copy the events to be deleted, in case any are deleted by being
@@ -698,7 +724,7 @@
 		eventCopies.append(event);
 		undos.append(*event, resources->resourceForEvent(event->id()));
 	}
-	if (Preferences::confirmAlarmDeletion())
+	if (!force  &&  Preferences::confirmAlarmDeletion())
 	{
 		int n = events.count();
 		if (KMessageBox::warningContinueCancel(this, i18ncp("@info", "Do you really want to delete the selected alarm?",
Index: kalarm/editdlg.h
===================================================================
--- kalarm/editdlg.h	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ kalarm/editdlg.h	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -1,7 +1,7 @@
 /*
  *  editdlg.h  -  dialog to create or modify an alarm or alarm template
  *  Program:  kalarm
- *  Copyright © 2001-2008 by David Jarvie <djarvie@kde.org>
+ *  Copyright © 2001-2009 by David Jarvie <djarvie@kde.org>
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -54,7 +54,7 @@
 {
 		Q_OBJECT
 	public:
-		enum Type { DISPLAY, COMMAND, EMAIL };
+		enum Type { NO_TYPE, DISPLAY, COMMAND, EMAIL };
 		enum GetResourceType {
 			RES_PROMPT,        // prompt for resource
 			RES_USE_EVENT_ID,  // use resource containing event, or prompt if not found
@@ -67,7 +67,17 @@
 		                            GetResourceType = RES_PROMPT, bool readOnly = false);
 		virtual ~EditAlarmDlg();
 		bool            getEvent(KAEvent&, AlarmResource*&);
+
+		// Methods to initialise values in the New Alarm dialogue.
+		// N.B. setTime() must be called first to set the date-only characteristic,
+		//      followed by setRecurrence() if applicable.
+		void            setTime(const DateTime&);    // must be called first to set date-only value
+		void            setRecurrence(const KARecurrence&, int subRepeatInterval, int subRepeatCount);
+		void            setRepeatAtLogin();
 		virtual void    setAction(KAEvent::Action, const AlarmText& = AlarmText()) = 0;
+		void            setLateCancel(int minutes);
+		void            setShowInKOrganizer(bool);
+
 		virtual QSize   sizeHint() const    { return minimumSizeHint(); }
 
 		static QString  i18n_chk_ShowInKOrganizer();   // text of 'Show in KOrganizer' checkbox
@@ -108,6 +118,8 @@
 		virtual void    slotHelp();      // Load Template
 		virtual void    slotDefault();   // More/Less Options
 		virtual void    slotButtonClicked(int button);
+		void            contentsChanged();
+
 	private slots:
 		void            slotRecurTypeChange(int repeatType);
 		void            slotRecurFrequencyChange();
@@ -188,6 +200,7 @@
 		int                 mSavedTemplateAfterTime;// mTemplateAfterTime value
 		QString             mSavedTextFileCommandMessage;  // mTextMessageEdit/mFileMessageEdit/mCmdCommandEdit/mEmailMessageEdit value
 		KDateTime           mSavedDateTime;         // mTimeWidget value
+		KDateTime           mSavedDeferTime;        // mDeferDateTime value
 		int                 mSavedRecurrenceType;   // RecurrenceEdit::RepeatType value
 		int                 mSavedLateCancel;       // mLateCancel value
 		bool                mSavedShowInKorganizer; // mShowInKorganizer status
Index: kalarm/latecancel.cpp
===================================================================
--- kalarm/latecancel.cpp	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ kalarm/latecancel.cpp	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -1,7 +1,7 @@
 /*
  *  latecancel.cpp  -  widget to specify cancellation if late
  *  Program:  kalarm
- *  Copyright © 2004,2005,2007,2008 by David Jarvie <djarvie@kde.org>
+ *  Copyright © 2004,2005,2007-2009 by David Jarvie <djarvie@kde.org>
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -64,6 +64,7 @@
 	hlayout->setMargin(0);
 	mCheckbox = new CheckBox(i18n_chk_CancelIfLate(), mCheckboxFrame);
 	connect(mCheckbox, SIGNAL(toggled(bool)), SLOT(slotToggled(bool)));
+	connect(mCheckbox, SIGNAL(toggled(bool)), SIGNAL(changed()));
 	mCheckbox->setWhatsThis(whatsThis);
 	hlayout->addWidget(mCheckbox, 0, Qt::AlignLeft);
 
@@ -75,6 +76,7 @@
 	                                 whatsThis, i18nc("@info:whatsthis", "Enter how late will cause the alarm to be canceled"),
 	                                 allowHourMinute, mTimeSelectorFrame);
 	connect(mTimeSelector, SIGNAL(toggled(bool)), SLOT(slotToggled(bool)));
+	connect(mTimeSelector, SIGNAL(valueChanged(const KCal::Duration&)), SIGNAL(changed()));
 	hlayout->addWidget(mTimeSelector, 0, Qt::AlignLeft);
 
 	hlayout = new QHBoxLayout();
@@ -82,6 +84,7 @@
 	hlayout->addSpacing(3*KDialog::spacingHint());
 	topLayout->addLayout(hlayout);
 	mAutoClose = new CheckBox(i18n_chk_AutoCloseWin(), this);
+	connect(mAutoClose, SIGNAL(toggled(bool)), SIGNAL(changed()));
 	mAutoClose->setWhatsThis(i18nc("@info:whatsthis", "Automatically close the alarm window after the expiry of the late-cancellation period"));
 	hlayout->addWidget(mAutoClose);
 	hlayout->addStretch();
Index: kalarm/commandoptions.h
===================================================================
--- kalarm/commandoptions.h	(.../tags/KDE/4.3.0/kdepim)	(wersja 0)
+++ kalarm/commandoptions.h	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -0,0 +1,113 @@
+/*
+ *  commandoptions.h  -  extract command line options
+ *  Program:  kalarm
+ *  Copyright © 2001-2009 by David Jarvie <djarvie@kde.org>
+ *
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the GNU General Public License as published by
+ *  the Free Software Foundation; either version 2 of the License, or
+ *  (at your option) any later version.
+ *
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
+ *  GNU General Public License for more details.
+ *
+ *  You should have received a copy of the GNU General Public License along
+ *  with this program; if not, write to the Free Software Foundation, Inc.,
+ *  51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ */
+
+#ifndef COMMANDOPTIONS_H
+#define COMMANDOPTIONS_H
+
+#include "alarmevent.h"
+#include "editdlg.h"
+#include "karecurrence.h"
+#include <KDateTime>
+#include <QByteArray>
+#include <QColor>
+#include <QStringList>
+class KCmdLineArgs;
+
+class CommandOptions
+{
+	public:
+		enum Command
+		{
+			CMD_ERROR,        // error in command line options
+			NONE,             // no command
+			TRAY,             // --tray
+			TRIGGER_EVENT,    // --triggerEvent
+			CANCEL_EVENT,     // --cancelEvent
+			EDIT,             // --edit
+			EDIT_NEW_PRESET,  // --edit-new-preset
+			EDIT_NEW,         // --edit-new-display, --edit-new-command, --edit-new-email
+			NEW               // --file, --exec-display, --exec, --mail, message
+		};
+		CommandOptions();
+		Command             command() const           { return mCommand; }
+		QString             eventId() const           { return mEventId; }
+		QString             templateName() const      { return mTemplateName; }
+		EditAlarmDlg::Type  editType() const          { return mEditType; }
+		KAEvent::Action     editAction() const        { return mEditAction; }
+		QString             text() const              { return mText; }
+		KDateTime           alarmTime() const         { return mAlarmTime; }
+		KARecurrence*       recurrence() const        { return mRecurrence; }
+		int                 subRepeatCount() const    { return mRepeatCount; }
+		int                 subRepeatInterval() const { return mRepeatInterval; }
+		int                 lateCancel() const        { return mLateCancel; }
+		QColor              bgColour() const          { return mBgColour; }
+		QColor              fgColour() const          { return mFgColour; }
+		int                 reminderMinutes() const   { return mReminderMinutes; }
+		QString             audioFile() const         { return mAudioFile; }
+		float               audioVolume() const       { return mAudioVolume; }
+		EmailAddressList    addressees() const        { return mAddressees; }
+		QStringList         attachments() const       { return mAttachments; }
+		QString             subject() const           { return mSubject; }
+		uint                fromID() const            { return mFromID; }
+		int                 flags() const             { return mFlags; }
+#ifndef NDEBUG
+		KDateTime           simulationTime() const    { return mSimulationTime; }
+#endif
+		static void         printError(const QString& errmsg);
+
+	private:
+		bool        checkCommand(const QByteArray& command, Command, EditAlarmDlg::Type = EditAlarmDlg::NO_TYPE);
+		inline void setError(const QString& error);
+		void        setErrorRequires(const char* opt, const char* opt2, const char* opt3 = 0);
+		void        setErrorParameter(const char* opt);
+		void        setErrorIncompatible(const QByteArray& opt1, const QByteArray& opt2);
+		void        checkEditType(EditAlarmDlg::Type, const QByteArray& opt);
+
+		KCmdLineArgs*       mArgs;
+		QString             mError;          // error message
+		Command             mCommand;        // the selected command
+		QByteArray          mCommandName;    // option string for the selected command
+		QString             mEventId;        // TRIGGER_EVENT, CANCEL_EVENT, EDIT: event ID
+		QString             mTemplateName;   // EDIT_NEW_PRESET: template name
+		EditAlarmDlg::Type  mEditType;       // NEW, EDIT_NEW_*: alarm edit type
+		KAEvent::Action     mEditAction;     // NEW: alarm edit sub-type
+		bool                mEditActionSet;  // NEW: mEditAction is valid
+		QString             mText;           // NEW: alarm text
+		KDateTime           mAlarmTime;      // NEW: alarm time
+		KARecurrence*       mRecurrence;     // NEW: recurrence
+		int                 mRepeatCount;    // NEW: sub-repetition count
+		int                 mRepeatInterval; // NEW: sub-repetition interval
+		int                 mLateCancel;     // NEW: late-cancellation interval
+		QColor              mBgColour;       // NEW: background colour
+		QColor              mFgColour;       // NEW: foreground colour
+		int                 mReminderMinutes;// NEW: reminder period, < 0 if once only reminder
+		QString             mAudioFile;      // NEW: audio file path
+		float               mAudioVolume;    // NEW: audio file volume
+		EmailAddressList    mAddressees;     // NEW: email addressees
+		QStringList         mAttachments;    // NEW: email attachment file names
+		QString             mSubject;        // NEW: email subject
+		uint                mFromID;         // NEW: email sender ID
+		int                 mFlags;          // NEW: event flags
+#ifndef NDEBUG
+		KDateTime           mSimulationTime; // system time to be simulated, or invalid if none
+#endif
+};
+
+#endif // COMMANDOPTIONS_H
Index: kalarm/specialactions.h
===================================================================
--- kalarm/specialactions.h	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ kalarm/specialactions.h	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -1,7 +1,7 @@
 /*
  *  specialactions.h  -  widget to specify special alarm actions
  *  Program:  kalarm
- *  Copyright (c) 2004-2008 by David Jarvie <djarvie@kde.org>
+ *  Copyright © 2004-2009 by David Jarvie <djarvie@kde.org>
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -43,6 +43,7 @@
 		virtual bool   isReadOnly() const     { return mReadOnly; }
 
 	signals:
+		/** Signal emitted whenever the widget has been changed. */
 		void           selected();
 
 	protected slots:
Index: kalarm/Changelog
===================================================================
--- kalarm/Changelog	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ kalarm/Changelog	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -1,15 +1,26 @@
 KAlarm Change Log
 
-=== Version 2.2.6 --- 26 July 2009 ===
+=== Version 2.2.7 --- 18 August 2009 ===
+- Shift-Delete now deletes alarms without showing confirmation prompt.
+- Disable edit alarm dialogue OK button if no changes have been made.
+- Command line options: validate better, and remove unnecessary restrictions.
+- Fix crash when restoring alarm with invalid type.
+- Fix bad addresses when sending email alarms.
+- Fix volume when playing audio files.
+- Install action icons into kalarm directory, not system directory.
+- Fix KMail not starting minimised when adding mail to a KMail folder.
+- Fix use of wrong time zone if deferral is cancelled and then reinstated.
+
+=== Version 2.2.6 (KDE 4.3.0) --- 26 July 2009 ===
 - Use new setting after "prompt for calendar to store in" selection changes.
 - Sort alarm list after an alarm triggers.
 - Display translated time zone names in time zone selection combo box.
 - Make Defaults button in configuration dialogue set the correct default values.
 
-=== Version 2.2.5 --- 10 July 2009 ===
+=== Version 2.2.5 (KDE 4.3.0 RC3) --- 10 July 2009 ===
 - Fix alarms not triggering when reminder is erroneously AFTER the main alarm.
 
-=== Version 2.2.4 --- 7 July 2009 ===
+=== Version 2.2.4 (KDE 4.3.0 RC2) --- 7 July 2009 ===
 - Fix crash when deleting an alarm which has an entry in the 'redo' list.
 
 === Version 2.2.4 (KDE 4.3.0 RC1) --- 23 June 2009 ===
Index: kalarm/kalarmapp.cpp
===================================================================
--- kalarm/kalarmapp.cpp	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ kalarm/kalarmapp.cpp	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -22,13 +22,14 @@
 #include "kalarmapp.moc"
 
 #include "alarmcalendar.h"
-#include "eventlistmodel.h"
 #include "alarmlistview.h"
+#include "autoqpointer.h"
 #include "birthdaymodel.h"
-#include "editdlg.h"
+#include "commandoptions.h"
 #include "dbushandler.h"
+#include "editdlgtypes.h"
+#include "eventlistmodel.h"
 #include "functions.h"
-#include "identities.h"
 #include "kamail.h"
 #include "karecurrence.h"
 #include "mainwindow.h"
@@ -40,7 +41,8 @@
 #include "startdaytimer.h"
 #include "traywindow.h"
 
-#include <kcmdlineargs.h>
+#include "kspeechinterface.h"
+
 #include <klocale.h>
 #include <kstandarddirs.h>
 #include <kconfig.h>
@@ -50,7 +52,6 @@
 #include <kglobal.h>
 #include <kstandardguiitem.h>
 #include <kservicetypetrader.h>
-#include <kspeechinterface.h>
 #include <kspeech.h>
 #include <ktoolinvocation.h>
 #include <netwm.h>
@@ -73,7 +74,6 @@
 static const char* KTTSD_DBUS_SERVICE  = "org.kde.kttsd";
 static const char* KTTDS_DBUS_PATH     = "/KSpeech";
 
-static bool convInterval(const QByteArray& timeParam, KARecurrence::Type&, int& timeInterval, bool allowMonthYear = false);
 static void setEventCommandError(const KAEvent&, KAEvent::CmdErrType);
 static void clearEventCommandError(const KAEvent&, KAEvent::CmdErrType);
 
@@ -275,477 +275,155 @@
 	bool dontRedisplay = false;
 	if (!firstInstance || !isSessionRestored())
 	{
-		QString usage;
-		KCmdLineArgs* args = KCmdLineArgs::parsedArgs();
-
-		// Use a 'do' loop which is executed only once to allow easy error exits.
-		// Errors use 'break' to skip to the end of the function.
-		do
+		CommandOptions options;   // fetch and parse command line options
+#ifndef NDEBUG
+		if (options.simulationTime().isValid())
+			KAlarm::setSimulatedSystemTime(options.simulationTime());
+#endif
+		CommandOptions::Command command = options.command();
+		switch (command)
 		{
-			#define USAGE(message)  { usage = message; break; }
-			if (args->isSet("tray"))
-			{
+			case CommandOptions::TRAY:
 				// Display only the system tray icon
-				kDebug() << "--tray";
-				args->clear();      // free up memory
-				if (!KSystemTrayIcon::isSystemTrayAvailable())
-				{
+				if (!KSystemTrayIcon::isSystemTrayAvailable()
+				||  !initCheck()   // open the calendar, start processing execution queue
+				||  !displayTrayIcon(true))
 					exitCode = 1;
-					break;
-				}
-				if (!initCheck())   // open the calendar, start processing execution queue
-				{
-					exitCode = 1;
-					break;
-				}
-				if (!displayTrayIcon(true))
-				{
-					exitCode = 1;
-					break;
-				}
-			}
-			else
-			if (args->isSet("triggerEvent")  ||  args->isSet("cancelEvent"))
+				break;
+
+			case CommandOptions::TRIGGER_EVENT:
+			case CommandOptions::CANCEL_EVENT:
 			{
 				// Display or delete the event with the specified event ID
-				kDebug() << "Handle event";
-				EventFunc function = EVENT_HANDLE;
-				int count = 0;
-				const char* option = 0;
-				if (args->isSet("triggerEvent"))  { function = EVENT_TRIGGER;  option = "triggerEvent";  ++count; }
-				if (args->isSet("cancelEvent"))   { function = EVENT_CANCEL;   option = "cancelEvent";   ++count; }
-				if (count > 1)
-					USAGE(i18nc("@info:shell", "<icode>%1</icode> incompatible with <icode>%2</icode>", QLatin1String("--triggerEvent"), QLatin1String("--cancelEvent")));
+				EventFunc function = (command == CommandOptions::TRIGGER_EVENT) ? EVENT_TRIGGER : EVENT_CANCEL;
 				if (!initCheck(true))   // open the calendar, don't start processing execution queue yet
-				{
 					exitCode = 1;
-					break;
-				}
-				QString eventID = args->getOption(option);
-				args->clear();      // free up memory
-				startProcessQueue();        // start processing the execution queue
-				if (!handleEvent(eventID, function))
+				else
 				{
-					exitCode = 1;
-					break;
+					startProcessQueue();        // start processing the execution queue
+					if (!handleEvent(options.eventId(), function))
+						exitCode = 1;
 				}
+				break;
 			}
-			else
-			if (args->isSet("edit"))
-			{
-				QString eventID = args->getOption("edit");
+			case CommandOptions::EDIT:
+				// Edit a specified existing alarm
 				if (!initCheck())
-				{
 					exitCode = 1;
-					break;
-				}
-				if (!KAlarm::editAlarm(eventID))
+				else if (!KAlarm::editAlarm(options.eventId()))
 				{
-					USAGE(i18nc("@info:shell", "<icode>%1</icode>: Event <resource>%2</resource> not found, or not editable", QString::fromLatin1("--edit"), eventID))
+					CommandOptions::printError(i18nc("@info:shell", "<icode>%1</icode>: Event <resource>%2</resource> not found, or not editable", QString::fromLatin1("--edit"), options.eventId()));
 					exitCode = 1;
-					break;
 				}
-			}
-			else
-			if (args->isSet("edit-new-display")  ||  args->isSet("edit-new-command")  ||  args->isSet("edit-new-email"))
+				break;
+
+			case CommandOptions::EDIT_NEW:
 			{
-				EditAlarmDlg::Type type = args->isSet("edit-new-display") ? EditAlarmDlg::DISPLAY
-				                        : args->isSet("edit-new-command") ? EditAlarmDlg::COMMAND
-				                        : EditAlarmDlg::EMAIL;
+				// Edit a new alarm, and optionally preset selected values
 				if (!initCheck())
-				{
 					exitCode = 1;
-					break;
-				}
-				KAlarm::editNewAlarm(type);
-			}
-			else
-			if (args->isSet("edit-new-preset"))
-			{
-				QString templ = args->getOption("edit-new-preset");
-				if (!initCheck())
-				{
-					exitCode = 1;
-					break;
-				}
-				KAlarm::editNewAlarm(templ);
-			}
-			else
-			if (args->isSet("file")  ||  args->isSet("exec")  ||  args->isSet("exec-display")  ||  args->isSet("mail")  ||  args->count())
-			{
-				// Display a message or file, execute a command, or send an email
-				KAEvent::Action action = KAEvent::MESSAGE;
-				QString          alMessage;
-				uint             alFromID = 0;
-				EmailAddressList alAddresses;
-				QStringList      alAttachments;
-				QString          alSubject;
-				int flags = KAEvent::DEFAULT_FONT;
-				if (args->isSet("file"))
-				{
-					kDebug() << "File";
-					if (args->isSet("exec"))
-						USAGE(i18nc("@info:shell", "<icode>%1</icode> incompatible with <icode>%2</icode>", QLatin1String("--exec"), QLatin1String("--file")))
-					if (args->isSet("mail"))
-						USAGE(i18nc("@info:shell", "<icode>%1</icode> incompatible with <icode>%2</icode>", QLatin1String("--mail"), QLatin1String("--file")))
-					if (args->count())
-						USAGE(i18nc("@info:shell", "message incompatible with <icode>%1</icode>", QLatin1String("--file")))
-					alMessage = args->getOption("file");
-					action = KAEvent::FILE;
-				}
-				else if (args->isSet("exec-display"))
-				{
-					kDebug() << "--exec-display";
-					if (args->isSet("exec"))
-						USAGE(i18nc("@info:shell", "<icode>%1</icode> incompatible with <icode>%2</icode>", QLatin1String("--exec"), QLatin1String("--exec-display")))
-					if (args->isSet("mail"))
-						USAGE(i18nc("@info:shell", "<icode>%1</icode> incompatible with <icode>%2</icode>", QLatin1String("--mail"), QLatin1String("--exec-display")))
-					alMessage = args->getOption("exec-display");
-					int n = args->count();
-					for (int i = 0;  i < n;  ++i)
-					{
-						alMessage += ' ';
-						alMessage += args->arg(i);
-					}
-					action = KAEvent::COMMAND;
-					flags |= KAEvent::DISPLAY_COMMAND;
-				}
-				else if (args->isSet("exec"))
-				{
-					kDebug() << "--exec";
-					if (args->isSet("mail"))
-						USAGE(i18nc("@info:shell", "<icode>%1</icode> incompatible with <icode>%2</icode>", QLatin1String("--mail"), QLatin1String("--exec")))
-					alMessage = args->getOption("exec");
-					int n = args->count();
-					for (int i = 0;  i < n;  ++i)
-					{
-						alMessage += ' ';
-						alMessage += args->arg(i);
-					}
-					action = KAEvent::COMMAND;
-				}
-				else if (args->isSet("mail"))
-				{
-					kDebug() << "--mail";
-					if (args->isSet("subject"))
-						alSubject = args->getOption("subject");
-					if (args->isSet("from-id"))
-						alFromID = Identities::identityUoid(args->getOption("from-id"));
-					QStringList params = args->getOptionList("mail");
-					for (QStringList::Iterator i = params.begin();  i != params.end();  ++i)
-					{
-						QString addr = *i;
-						if (!KAMail::checkAddress(addr))
-							USAGE(i18nc("@info:shell", "<icode>%1</icode>: invalid email address", QLatin1String("--mail")))
-						alAddresses += KCal::Person(QString(), addr);
-					}
-					params = args->getOptionList("attach");
-					for (QStringList::Iterator i = params.begin();  i != params.end();  ++i)
-						alAttachments += *i;
-					alMessage = args->arg(0);
-					action = KAEvent::EMAIL;
-				}
 				else
 				{
-					kDebug() << "Message";
-					alMessage = args->arg(0);
-				}
-
-				if (action != KAEvent::EMAIL)
-				{
-					if (args->isSet("subject"))
-						USAGE(i18nc("@info:shell", "<icode>%1</icode> requires <icode>%2</icode>", QLatin1String("--subject"), QLatin1String("--mail")))
-					if (args->isSet("from-id"))
-						USAGE(i18nc("@info:shell", "<icode>%1</icode> requires <icode>%2</icode>", QLatin1String("--from-id"), QLatin1String("--mail")))
-					if (args->isSet("attach"))
-						USAGE(i18nc("@info:shell", "<icode>%1</icode> requires <icode>%2</icode>", QLatin1String("--attach"), QLatin1String("--mail")))
-					if (args->isSet("bcc"))
-						USAGE(i18nc("@info:shell", "<icode>%1</icode> requires <icode>%2</icode>", QLatin1String("--bcc"), QLatin1String("--mail")))
-				}
-
-				KDateTime alarmTime, endTime;
-				QColor    bgColour = Preferences::defaultBgColour();
-				QColor    fgColour = Preferences::defaultFgColour();
-				KARecurrence recurrence;
-				int       repeatCount    = 0;
-				int       repeatInterval = 0;
-				if (args->isSet("color"))
-				{
-					// Background colour is specified
-					QString colourText = args->getOption("color");
-					if (colourText[0] == '0' && colourText[1].toLower() == 'x')
-						colourText.replace(0, 2, "#");
-					bgColour.setNamedColor(colourText);
-					if (!bgColour.isValid())
-						USAGE(i18nc("@info:shell", "Invalid <icode>%1</icode> parameter", QLatin1String("--color")))
-				}
-				if (args->isSet("colorfg"))
-				{
-					// Foreground colour is specified
-					QString colourText = args->getOption("colorfg");
-					if (colourText[0] == '0' && colourText[1].toLower() == 'x')
-						colourText.replace(0, 2, "#");
-					fgColour.setNamedColor(colourText);
-					if (!fgColour.isValid())
-						USAGE(i18nc("@info:shell", "Invalid <icode>%1</icode> parameter", QLatin1String("--colorfg")))
-				}
-
-				if (args->isSet("time"))
-				{
-					QByteArray dateTime = args->getOption("time").toLocal8Bit();
-					if (!KAlarm::convTimeString(dateTime, alarmTime))
-						USAGE(i18nc("@info:shell", "Invalid <icode>%1</icode> parameter", QLatin1String("--time")))
-				}
-				else
-					alarmTime = KDateTime::currentLocalDateTime();
-
-				bool haveRecurrence = args->isSet("recurrence");
-				if (haveRecurrence)
-				{
-					if (args->isSet("login"))
-						USAGE(i18nc("@info:shell", "<icode>%1</icode> incompatible with <icode>%2</icode>", QLatin1String("--login"), QLatin1String("--recurrence")))
-					if (args->isSet("until"))
-						USAGE(i18nc("@info:shell", "<icode>%1</icode> incompatible with <icode>%2</icode>", QLatin1String("--until"), QLatin1String("--recurrence")))
-					QString rule = args->getOption("recurrence");
-					recurrence.set(rule);
-				}
-				if (args->isSet("interval"))
-				{
-					// Repeat count is specified
-					int count;
-					if (args->isSet("login"))
-						USAGE(i18nc("@info:shell", "<icode>%1</icode> incompatible with <icode>%2</icode>", QLatin1String("--login"), QLatin1String("--interval")))
-					bool ok;
-					if (args->isSet("repeat"))
+					// Use AutoQPointer to guard against crash on application exit while
+					// the dialogue is still open. It prevents double deletion (both on
+					// deletion of parent, and on return from this function).
+					AutoQPointer<EditAlarmDlg> editDlg = EditAlarmDlg::create(false, options.editType(), true);
+					if (options.alarmTime().isValid())
+						editDlg->setTime(options.alarmTime());
+					if (options.recurrence())
+						editDlg->setRecurrence(*options.recurrence(), options.subRepeatInterval(), options.subRepeatCount());
+					else if (options.flags() & KAEvent::REPEAT_AT_LOGIN)
+						editDlg->setRepeatAtLogin();
+					editDlg->setAction(options.editAction(), options.text());
+					if (options.lateCancel())
+						editDlg->setLateCancel(options.lateCancel());
+					if (options.flags() & KAEvent::COPY_KORGANIZER)
+						editDlg->setShowInKOrganizer(true);
+					switch (options.editType())
 					{
-						count = args->getOption("repeat").toInt(&ok);
-						if (!ok || !count || count < -1 || (count < 0 && haveRecurrence))
-							USAGE(i18nc("@info:shell", "Invalid <icode>%1</icode> parameter", QLatin1String("--repeat")))
+						case EditAlarmDlg::DISPLAY:
+						{
+							// EditAlarmDlg::create() always returns EditDisplayAlarmDlg for type = DISPLAY
+							EditDisplayAlarmDlg* dlg = qobject_cast<EditDisplayAlarmDlg*>(editDlg);
+							if (options.fgColour().isValid())
+								dlg->setFgColour(options.fgColour());
+							if (options.bgColour().isValid())
+								dlg->setBgColour(options.bgColour());
+							if (!options.audioFile().isEmpty()
+							||  options.flags() & (KAEvent::BEEP | KAEvent::SPEAK))
+							{
+								int flags = options.flags();
+								Preferences::SoundType type = (flags & KAEvent::BEEP) ? Preferences::Sound_Beep
+								                            : (flags & KAEvent::SPEAK) ? Preferences::Sound_Speak
+								                            : Preferences::Sound_File;
+								dlg->setAudio(type, options.audioFile(), options.audioVolume(), flags & KAEvent::REPEAT_SOUND);
+							}
+							if (options.reminderMinutes())
+								dlg->setReminder(options.reminderMinutes());
+							if (options.flags() & KAEvent::CONFIRM_ACK)
+								dlg->setConfirmAck(true);
+							if (options.flags() & KAEvent::AUTO_CLOSE)
+								dlg->setAutoClose(true);
+							break;
+						}
+						case EditAlarmDlg::COMMAND:
+							break;
+						case EditAlarmDlg::EMAIL:
+						{
+							// EditAlarmDlg::create() always returns EditEmailAlarmDlg for type = EMAIL
+							EditEmailAlarmDlg* dlg = qobject_cast<EditEmailAlarmDlg*>(editDlg);
+							if (options.fromID()
+							||  !options.addressees().isEmpty()
+							||  !options.subject().isEmpty()
+							||  !options.attachments().isEmpty())
+								dlg->setEmailFields(options.fromID(), options.addressees(), options.subject(), options.attachments());
+							if (options.flags() & KAEvent::EMAIL_BCC)
+								dlg->setBcc(true);
+							break;
+						}
+						case EditAlarmDlg::NO_TYPE:
+							break;
 					}
-					else if (haveRecurrence)
-						USAGE(i18nc("@info:shell", "<icode>%1</icode> requires <icode>%2</icode>", QLatin1String("--interval"), QLatin1String("--repeat")))
-					else if (args->isSet("until"))
-					{
-						count = 0;
-						QByteArray dateTime = args->getOption("until").toLocal8Bit();
-						bool ok;
-						if (args->isSet("time"))
-							ok = KAlarm::convTimeString(dateTime, endTime, alarmTime);
-						else
-							ok = KAlarm::convTimeString(dateTime, endTime);
-						if (!ok)
-							USAGE(i18nc("@info:shell", "Invalid <icode>%1</icode> parameter", QLatin1String("--until")))
-						if (alarmTime.isDateOnly()  &&  !endTime.isDateOnly())
-							USAGE(i18nc("@info:shell", "Invalid <icode>%1</icode> parameter for date-only alarm", QLatin1String("--until")))
-						if (!alarmTime.isDateOnly()  &&  endTime.isDateOnly())
-							endTime.setTime(QTime(23,59,59));
-						if (endTime < alarmTime)
-							USAGE(i18nc("@info:shell", "<icode>%1</icode> earlier than <icode>%2</icode>", QLatin1String("--until"), QLatin1String("--time")))
-					}
-					else
-						count = -1;
-
-					// Get the recurrence interval
-					int interval;
-					KARecurrence::Type recurType;
-					if (!convInterval(args->getOption("interval").toLocal8Bit(), recurType, interval, !haveRecurrence)
-					||  interval < 0)
-						USAGE(i18nc("@info:shell", "Invalid <icode>%1</icode> parameter", QLatin1String("--interval")))
-					if (alarmTime.isDateOnly()  &&  recurType == KARecurrence::MINUTELY)
-						USAGE(i18nc("@info:shell", "Invalid <icode>%1</icode> parameter for date-only alarm", QLatin1String("--interval")))
-
-					if (haveRecurrence)
-					{
-						// There is a also a recurrence specified, so set up a sub-repetition
-						int longestInterval = recurrence.longestInterval();
-						if (count * interval > longestInterval)
-							USAGE(i18nc("@info:shell", "Invalid <icode>%1</icode> and <icode>%2</icode> parameters: repetition is longer than <icode>%3</icode> interval", QLatin1String("--interval"), QLatin1String("--repeat"), QLatin1String("--recurrence")));
-						repeatCount    = count;
-						repeatInterval = interval;
-					}
-					else
-					{
-						// There is no other recurrence specified, so convert the repetition
-						// parameters into a KCal::Recurrence
-						recurrence.set(recurType, interval, count, alarmTime, endTime);
-					}
+					KAlarm::execNewAlarmDlg(editDlg);
 				}
+				break;
+			}
+			case CommandOptions::EDIT_NEW_PRESET:
+				// Edit a new alarm, preset with a template
+				if (!initCheck())
+					exitCode = 1;
 				else
-				{
-					if (args->isSet("repeat"))
-						USAGE(i18nc("@info:shell", "<icode>%1</icode> requires <icode>%2</icode>", QLatin1String("--repeat"), QLatin1String("--interval")))
-					if (args->isSet("until"))
-						USAGE(i18nc("@info:shell", "<icode>%1</icode> requires <icode>%2</icode>", QLatin1String("--until"), QLatin1String("--interval")))
-				}
+					KAlarm::editNewAlarm(options.templateName());
+				break;
 
-				QString    audioFile;
-				float      audioVolume = -1;
-				bool       audioRepeat = args->isSet("play-repeat");
-				if (audioRepeat  ||  args->isSet("play"))
-				{
-					// Play a sound with the alarm
-					if (audioRepeat  &&  args->isSet("play"))
-						USAGE(i18nc("@info:shell", "<icode>%1</icode> incompatible with <icode>%2</icode>", QLatin1String("--play"), QLatin1String("--play-repeat")))
-					if (args->isSet("beep"))
-						USAGE(i18nc("@info:shell", "<icode>%1</icode> incompatible with <icode>%2</icode>", QLatin1String("--beep"), QLatin1String(audioRepeat ? "--play-repeat" : "--play")))
-					if (args->isSet("speak"))
-						USAGE(i18nc("@info:shell", "<icode>%1</icode> incompatible with <icode>%2</icode>", QLatin1String("--speak"), QLatin1String(audioRepeat ? "--play-repeat" : "--play")))
-					audioFile = args->getOption(audioRepeat ? "play-repeat" : "play");
-					if (args->isSet("volume"))
-					{
-						bool ok;
-						int volumepc = args->getOption("volume").toInt(&ok);
-						if (!ok  ||  volumepc < 0  ||  volumepc > 100)
-							USAGE(i18nc("@info:shell", "Invalid <icode>%1</icode> parameter", QLatin1String("--volume")))
-						audioVolume = static_cast<float>(volumepc) / 100;
-					}
-				}
-				else if (args->isSet("volume"))
-					USAGE(i18nc("@info:shell", "<icode>%1</icode> requires <icode>%2</icode> or <icode>%3</icode>", QLatin1String("--volume"), QLatin1String("--play"), QLatin1String("--play-repeat")))
-				if (args->isSet("speak"))
-				{
-					if (args->isSet("beep"))
-						USAGE(i18nc("@info:shell", "<icode>%1</icode> incompatible with <icode>%2</icode>", QLatin1String("--beep"), QLatin1String("--speak")))
-					if (!mSpeechEnabled)
-						USAGE(i18nc("@info:shell", "<icode>%1</icode> requires speech synthesis to be configured using KTTSD", QLatin1String("--speak")))
-				}
-				int reminderMinutes = 0;
-				bool onceOnly = args->isSet("reminder-once");
-				if (args->isSet("reminder")  ||  onceOnly)
-				{
-					// Issue a reminder alarm in advance of the main alarm
-					if (onceOnly  &&  args->isSet("reminder"))
-						USAGE(i18nc("@info:shell", "<icode>%1</icode> incompatible with <icode>%2</icode>", QLatin1String("--reminder"), QLatin1String("--reminder-once")))
-					QString opt = onceOnly ? QLatin1String("--reminder-once") : QLatin1String("--reminder");
-					if (args->isSet("exec"))
-						USAGE(i18nc("@info:shell", "<icode>%1</icode> incompatible with <icode>%2</icode>", opt, QLatin1String("--exec")))
-					if (args->isSet("mail"))
-						USAGE(i18nc("@info:shell", "<icode>%1</icode> incompatible with <icode>%2</icode>", opt, QLatin1String("--mail")))
-					KARecurrence::Type recurType;
-					QString optval = args->getOption(onceOnly ? "reminder-once" : "reminder");
-					if (!convInterval(args->getOption(onceOnly ? "reminder-once" : "reminder").toLocal8Bit(), recurType, reminderMinutes))
-						USAGE(i18nc("@info:shell", "Invalid <icode>%1</icode> parameter", opt))
-					if (recurType == KARecurrence::MINUTELY  &&  alarmTime.isDateOnly())
-						USAGE(i18nc("@info:shell", "Invalid <icode>%1</icode> parameter for date-only alarm", opt))
-					if (onceOnly)
-						reminderMinutes = -reminderMinutes;
-				}
-
-				int lateCancel = 0;
-				if (args->isSet("late-cancel"))
-				{
-					KARecurrence::Type recurType;
-					bool ok = convInterval(args->getOption("late-cancel").toLocal8Bit(), recurType, lateCancel);
-					if (!ok  ||  lateCancel <= 0)
-						USAGE(i18nc("@info:shell", "Invalid <icode>%1</icode> parameter", QLatin1String("late-cancel")))
-				}
-				else if (args->isSet("auto-close"))
-					USAGE(i18nc("@info:shell", "<icode>%1</icode> requires <icode>%2</icode>", QLatin1String("--auto-close"), QLatin1String("--late-cancel")))
-
-				if (args->isSet("ack-confirm"))
-					flags |= KAEvent::CONFIRM_ACK;
-				if (args->isSet("auto-close"))
-					flags |= KAEvent::AUTO_CLOSE;
-				if (args->isSet("beep"))
-					flags |= KAEvent::BEEP;
-				if (args->isSet("speak"))
-					flags |= KAEvent::SPEAK;
-				if (args->isSet("korganizer"))
-					flags |= KAEvent::COPY_KORGANIZER;
-				if (args->isSet("disable"))
-					flags |= KAEvent::DISABLED;
-				if (audioRepeat)
-					flags |= KAEvent::REPEAT_SOUND;
-				if (args->isSet("login"))
-					flags |= KAEvent::REPEAT_AT_LOGIN;
-				if (args->isSet("bcc"))
-					flags |= KAEvent::EMAIL_BCC;
-				if (alarmTime.isDateOnly())
-					flags |= KAEvent::ANY_TIME;
-				args->clear();      // free up memory
-
-				// Display or schedule the event
-				if (!initCheck())
-				{
+			case CommandOptions::NEW:
+				// Display a message or file, execute a command, or send an email
+				if (!initCheck()
+				||  !scheduleEvent(options.editAction(), options.text(), options.alarmTime(),
+				                   options.lateCancel(), options.flags(), options.bgColour(),
+				                   options.fgColour(), QFont(), options.audioFile(), options.audioVolume(),
+				                   options.reminderMinutes(), (options.recurrence() ? *options.recurrence() : KARecurrence()),
+				                   options.subRepeatInterval(), options.subRepeatCount(),
+				                   options.fromID(), options.addressees(),
+				                   options.subject(), options.attachments()))
 					exitCode = 1;
-					break;
-				}
-				if (!scheduleEvent(action, alMessage, alarmTime, lateCancel, flags, bgColour, fgColour, QFont(), audioFile,
-				                   audioVolume, reminderMinutes, recurrence, repeatInterval, repeatCount,
-				                   alFromID, alAddresses, alSubject, alAttachments))
-				{
-					exitCode = 1;
-					break;
-				}
-			}
-			else
-			{
-				// No arguments - run interactively & display the main window
-				kDebug() << "Interactive";
-				if (args->isSet("ack-confirm"))
-					usage += QLatin1String("--ack-confirm ");
-				if (args->isSet("attach"))
-					usage += QLatin1String("--attach ");
-				if (args->isSet("auto-close"))
-					usage += QLatin1String("--auto-close ");
-				if (args->isSet("bcc"))
-					usage += QLatin1String("--bcc ");
-				if (args->isSet("beep"))
-					usage += QLatin1String("--beep ");
-				if (args->isSet("color"))
-					usage += QLatin1String("--color ");
-				if (args->isSet("colorfg"))
-					usage += QLatin1String("--colorfg ");
-				if (args->isSet("disable"))
-					usage += QLatin1String("--disable ");
-				if (args->isSet("from-id"))
-					usage += QLatin1String("--from-id ");
-				if (args->isSet("korganizer"))
-					usage += QLatin1String("--korganizer ");
-				if (args->isSet("late-cancel"))
-					usage += QLatin1String("--late-cancel ");
-				if (args->isSet("login"))
-					usage += QLatin1String("--login ");
-				if (args->isSet("play"))
-					usage += QLatin1String("--play ");
-				if (args->isSet("play-repeat"))
-					usage += QLatin1String("--play-repeat ");
-				if (args->isSet("reminder"))
-					usage += QLatin1String("--reminder ");
-				if (args->isSet("reminder-once"))
-					usage += QLatin1String("--reminder-once ");
-				if (args->isSet("speak"))
-					usage += QLatin1String("--speak ");
-				if (args->isSet("subject"))
-					usage += QLatin1String("--subject ");
-				if (args->isSet("time"))
-					usage += QLatin1String("--time ");
-				if (args->isSet("volume"))
-					usage += QLatin1String("--volume ");
-				if (!usage.isEmpty())
-				{
-					usage += i18nc("@info:shell", ": option(s) only valid with a message/<icode>%1</icode>/<icode>%2</icode>", QLatin1String("--file"), QLatin1String("--exec"));
-					break;
-				}
+				break;
 
-				args->clear();      // free up memory
+			case CommandOptions::NONE:
+				// No arguments - run interactively & display the main window
+#ifndef NDEBUG
+				if (options.simulationTime().isValid()  &&  !firstInstance)
+					break;   // simulating time: don't open main window if already running
+#endif
 				if (!initCheck())
-				{
 					exitCode = 1;
-					break;
-				}
+				else
+					(MainWindow::create())->show();
+				break;
 
-				(MainWindow::create())->show();
-			}
-		} while (0);    // only execute once
-
-		if (!usage.isEmpty())
-		{
-			// Note: we can't use args->usage() since that also quits any other
-			// running 'instances' of the program.
-			std::cerr << usage.toLocal8Bit().data()
-			          << i18nc("@info:shell", "\nUse --help to get a list of available command line options.\n").toLocal8Bit().data();
-			exitCode = 1;
+			case CommandOptions::CMD_ERROR:
+				exitCode = 1;
+				break;
 		}
 	}
 
@@ -2086,7 +1764,7 @@
 	}
 
 	// Record the alarm's error status
-        setEventCommandError(event, cmderr);
+	setEventCommandError(event, cmderr);
 	// Display an error message
 	if (proc)
 	{
@@ -2189,83 +1867,6 @@
 	return true;
 }
 
-/******************************************************************************
-* Convert a time interval command line parameter.
-* 'timeInterval' receives the count for the recurType. If 'allowMonthYear' is
-* false, weeks are converted to days in 'timeInterval'.
-* Reply = true if successful.
-*/
-static bool convInterval(const QByteArray& timeParam, KARecurrence::Type& recurType, int& timeInterval, bool allowMonthYear)
-{
-	QByteArray timeString = timeParam;
-	// Get the recurrence interval
-	bool ok = true;
-	uint interval = 0;
-	bool negative = (timeString[0] == '-');
-	if (negative)
-		timeString = timeString.right(1);
-	uint length = timeString.length();
-	switch (timeString[length - 1])
-	{
-		case 'Y':
-			if (!allowMonthYear)
-				ok = false;
-			recurType = KARecurrence::ANNUAL_DATE;
-			timeString = timeString.left(length - 1);
-			break;
-		case 'W':
-			recurType = KARecurrence::WEEKLY;
-			timeString = timeString.left(length - 1);
-			break;
-		case 'D':
-			recurType = KARecurrence::DAILY;
-			timeString = timeString.left(length - 1);
-			break;
-		case 'M':
-		{
-			int i = timeString.indexOf('H');
-			if (i < 0)
-			{
-				if (!allowMonthYear)
-					ok = false;
-				recurType = KARecurrence::MONTHLY_DAY;
-				timeString = timeString.left(length - 1);
-			}
-			else
-			{
-				recurType = KARecurrence::MINUTELY;
-				interval = timeString.left(i).toUInt(&ok) * 60;
-				timeString = timeString.mid(i + 1, length - i - 2);
-			}
-			break;
-		}
-		default:       // should be a digit
-			recurType = KARecurrence::MINUTELY;
-			break;
-	}
-	if (ok)
-		interval += timeString.toUInt(&ok);
-	if (!allowMonthYear)
-	{
-		// Convert time interval to minutes
-		switch (recurType)
-		{
-			case KARecurrence::WEEKLY:
-				interval *= 7;
-				// fall through to DAILY
-			case KARecurrence::DAILY:
-				interval *= 24*60;
-				break;
-			default:
-				break;
-		}
-	}
-	timeInterval = static_cast<int>(interval);
-	if (negative)
-		timeInterval = -timeInterval;
-	return ok;
-}
-
 void setEventCommandError(const KAEvent& event, KAEvent::CmdErrType err)
 {
 	if (err == KAEvent::CMD_ERROR_POST  &&  event.commandError() == KAEvent::CMD_ERROR_PRE)
Index: kalarm/appicons/ox22-app-kalarm.png
===================================================================
Nie można wyświetlić: plik binarny.
svn:mime-type = application/octet-stream

Zmiany atrybutów dla: kalarm/appicons/ox22-app-kalarm.png
___________________________________________________________________
Dodane: svn:mime-type
   + application/octet-stream
Dodane: svn:mergeinfo

Index: kalarm/appicons/ox32-app-kalarm.png
===================================================================
Nie można wyświetlić: plik binarny.
svn:mime-type = application/octet-stream

Zmiany atrybutów dla: kalarm/appicons/ox32-app-kalarm.png
___________________________________________________________________
Dodane: svn:mime-type
   + application/octet-stream
Dodane: svn:mergeinfo

Index: kalarm/appicons/hi48-app-kalarm.png
===================================================================
Nie można wyświetlić: plik binarny.
svn:mime-type = image/png

Zmiany atrybutów dla: kalarm/appicons/hi48-app-kalarm.png
___________________________________________________________________
Dodane: svn:mime-type
   + image/png
Dodane: svn:mergeinfo

Index: kalarm/appicons/ox16-app-kalarm.png
===================================================================
Nie można wyświetlić: plik binarny.
svn:mime-type = application/octet-stream

Zmiany atrybutów dla: kalarm/appicons/ox16-app-kalarm.png
___________________________________________________________________
Dodane: svn:mime-type
   + application/octet-stream
Dodane: svn:mergeinfo

Index: kalarm/appicons/ox64-app-kalarm.png
===================================================================
Nie można wyświetlić: plik binarny.
svn:mime-type = application/octet-stream

Zmiany atrybutów dla: kalarm/appicons/ox64-app-kalarm.png
___________________________________________________________________
Dodane: svn:mime-type
   + application/octet-stream
Dodane: svn:mergeinfo

Index: kalarm/appicons/ox128-app-kalarm.png
===================================================================
Nie można wyświetlić: plik binarny.
svn:mime-type = application/octet-stream

Zmiany atrybutów dla: kalarm/appicons/ox128-app-kalarm.png
___________________________________________________________________
Dodane: svn:mime-type
   + application/octet-stream
Dodane: svn:mergeinfo

Index: kalarm/appicons/ox48-app-kalarm.png
===================================================================
Nie można wyświetlić: plik binarny.
svn:mime-type = application/octet-stream

Zmiany atrybutów dla: kalarm/appicons/ox48-app-kalarm.png
___________________________________________________________________
Dodane: svn:mime-type
   + application/octet-stream
Dodane: svn:mergeinfo

Index: kalarm/appicons/oxsc-apps-kalarm.svgz
===================================================================
Nie można wyświetlić: plik binarny.
svn:mime-type = application/octet-stream

Zmiany atrybutów dla: kalarm/appicons/oxsc-apps-kalarm.svgz
___________________________________________________________________
Dodane: svn:mime-type
   + application/octet-stream
Dodane: svn:mergeinfo

Index: kalarm/appicons/hi32-app-kalarm.png
===================================================================
Nie można wyświetlić: plik binarny.
svn:mime-type = image/png

Zmiany atrybutów dla: kalarm/appicons/hi32-app-kalarm.png
___________________________________________________________________
Dodane: svn:mime-type
   + image/png
Dodane: svn:mergeinfo

Index: kalarm/appicons/CMakeLists.txt
===================================================================
--- kalarm/appicons/CMakeLists.txt	(.../tags/KDE/4.3.0/kdepim)	(wersja 0)
+++ kalarm/appicons/CMakeLists.txt	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -0,0 +1 @@
+kde4_install_icons( ${ICON_INSTALL_DIR} )
Index: kalarm/appicons/hi16-app-kalarm.png
===================================================================
Nie można wyświetlić: plik binarny.
svn:mime-type = image/png

Zmiany atrybutów dla: kalarm/appicons/hi16-app-kalarm.png
___________________________________________________________________
Dodane: svn:mime-type
   + image/png
Dodane: svn:mergeinfo

Index: kalarm/editdlgtypes.cpp
===================================================================
--- kalarm/editdlgtypes.cpp	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ kalarm/editdlgtypes.cpp	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -153,6 +153,7 @@
 	mTypeCombo->setFixedSize(mTypeCombo->sizeHint());
 	mTypeCombo->setCurrentIndex(-1);    // ensure slotAlarmTypeChanged() is called when index is set
 	connect(mTypeCombo, SIGNAL(currentIndexChanged(int)), SLOT(slotAlarmTypeChanged(int)));
+	connect(mTypeCombo, SIGNAL(currentIndexChanged(int)), SLOT(contentsChanged()));
 	label->setBuddy(mTypeCombo);
 	box->setWhatsThis(i18nc("@info:whatsthis", "<para>Select what the alarm should display:"
 	      "<list><item><interface>%1</interface>: the alarm will display the text message you type in.</item>"
@@ -166,6 +167,7 @@
 	mTextMessageEdit = new TextEdit(parent);
 	mTextMessageEdit->setLineWrapMode(KTextEdit::NoWrap);
 	mTextMessageEdit->setWhatsThis(i18nc("@info:whatsthis", "Enter the text of the alarm message. It may be multi-line."));
+	connect(mTextMessageEdit, SIGNAL(textChanged()), SLOT(contentsChanged()));
 	frameLayout->addWidget(mTextMessageEdit);
 
 	// File name edit box
@@ -175,6 +177,7 @@
 	mFileMessageEdit = new LineEdit(LineEdit::Url, mFileBox);
 	mFileMessageEdit->setAcceptDrops(true);
 	mFileMessageEdit->setWhatsThis(i18nc("@info:whatsthis", "Enter the name or URL of a text or image file to display."));
+	connect(mFileMessageEdit, SIGNAL(textChanged(const QString&)), SLOT(contentsChanged()));
 
 	// File browse button
 	mFileBrowseButton = new QPushButton(mFileBox);
@@ -187,8 +190,9 @@
 
 	// Command type checkbox and edit box
 	mCmdEdit = new CommandEdit(parent);
+	connect(mCmdEdit, SIGNAL(scriptToggled(bool)), SLOT(slotCmdScriptToggled(bool)));
+	connect(mCmdEdit, SIGNAL(changed()), SLOT(contentsChanged()));
 	frameLayout->addWidget(mCmdEdit);
-	connect(mCmdEdit, SIGNAL(scriptToggled(bool)), SLOT(slotCmdScriptToggled(bool)));
 
 	// Sound checkbox and file selector
 	QHBoxLayout* hlayout = new QHBoxLayout();
@@ -196,6 +200,7 @@
 	frameLayout->addLayout(hlayout);
 	mSoundPicker = new SoundPicker(parent);
 	mSoundPicker->setFixedSize(mSoundPicker->sizeHint());
+	connect(mSoundPicker, SIGNAL(changed()), SLOT(contentsChanged()));
 	hlayout->addWidget(mSoundPicker);
 	hlayout->addSpacing(2*spacingHint());
 	hlayout->addStretch();
@@ -205,12 +210,14 @@
 	mFontColourButton->setMaximumHeight(mFontColourButton->sizeHint().height() * 3/2);
 	hlayout->addWidget(mFontColourButton);
 	connect(mFontColourButton, SIGNAL(selected(const QColor&, const QColor&)), SLOT(setColours(const QColor&, const QColor&)));
+	connect(mFontColourButton, SIGNAL(selected(const QColor&, const QColor&)), SLOT(contentsChanged()));
 
 	if (ShellProcess::authorised())    // don't display if shell commands not allowed (e.g. kiosk mode)
 	{
 		// Special actions button
 		mSpecialActionsButton = new SpecialActionsButton(false, parent);
 		mSpecialActionsButton->setFixedSize(mSpecialActionsButton->sizeHint());
+		connect(mSpecialActionsButton, SIGNAL(selected()), SLOT(contentsChanged()));
 		frameLayout->addWidget(mSpecialActionsButton, 0, Qt::AlignRight);
 	}
 
@@ -386,6 +393,41 @@
 }
 
 /******************************************************************************
+* Initialise various values in the New Alarm dialogue.
+*/
+void EditDisplayAlarmDlg::setBgColour(const QColor& colour)
+{
+	mFontColourButton->setBgColour(colour);
+	setColours(mFontColourButton->fgColour(), colour);
+}
+void EditDisplayAlarmDlg::setFgColour(const QColor& colour)
+{
+	mFontColourButton->setFgColour(colour);
+	setColours(colour, mFontColourButton->bgColour());
+}
+void EditDisplayAlarmDlg::setConfirmAck(bool confirm)
+{
+	mConfirmAck->setChecked(confirm);
+}
+void EditDisplayAlarmDlg::setAutoClose(bool close)
+{
+	lateCancel()->setAutoClose(close);
+}
+void EditDisplayAlarmDlg::setAudio(Preferences::SoundType type, const QString& file, float volume, bool repeat)
+{
+	mSoundPicker->set(type, file, volume, -1, 0, repeat);
+}
+void EditDisplayAlarmDlg::setReminder(int minutes)
+{
+	bool onceOnly = (minutes < 0);
+	if (onceOnly)
+		minutes = -minutes;
+	reminder()->setMinutes(minutes, dateOnly());
+	reminder()->setOnceOnly(onceOnly);
+	reminder()->enableOnceOnly(isTimedRecurrence());
+}
+
+/******************************************************************************
 * Set the read-only status of all non-template controls.
 */
 void EditDisplayAlarmDlg::setReadOnly(bool readOnly)
@@ -583,7 +625,10 @@
 	QString file = KAlarm::browseFile(i18nc("@title:window", "Choose Text or Image File to Display"),
 	                                  defaultDir, mFileMessageEdit->text(), QString(), KFile::ExistingOnly, this);
 	if (!file.isEmpty())
+	{
 		mFileMessageEdit->setText(file);
+		contentsChanged();
+	}
 }
 
 /******************************************************************************
@@ -746,6 +791,7 @@
 
 	mCmdEdit = new CommandEdit(parent);
 	connect(mCmdEdit, SIGNAL(scriptToggled(bool)), SLOT(slotCmdScriptToggled(bool)));
+	connect(mCmdEdit, SIGNAL(changed()), SLOT(contentsChanged()));
 	frameLayout->addWidget(mCmdEdit);
 
 	// What to do with command output
@@ -756,6 +802,7 @@
 	vlayout->setMargin(marginHint());
 	vlayout->setSpacing(spacingHint());
 	mCmdOutputGroup = new ButtonGroup(mCmdOutputBox);
+	connect(mCmdOutputGroup, SIGNAL(buttonSet(QAbstractButton*)), SLOT(contentsChanged()));
 
 	// Execute in terminal window
 	mCmdExecInTerm = new RadioButton(i18n_radio_ExecInTermWindow(), mCmdOutputBox);
@@ -771,6 +818,7 @@
 	mCmdLogFileEdit = new LineEdit(LineEdit::Url, box);
 	mCmdLogFileEdit->setAcceptDrops(true);
 	mCmdLogFileEdit->setWhatsThis(i18nc("@info:whatsthis", "Enter the name or path of the log file."));
+	connect(mCmdLogFileEdit, SIGNAL(textChanged(const QString&)), SLOT(contentsChanged()));
 
 	// Log file browse button.
 	// The file browser dialog is activated by the PickLogFileRadio class.
@@ -785,6 +833,7 @@
 	mCmdLogToFile = new PickLogFileRadio(browseButton, mCmdLogFileEdit, i18nc("@option:radio", "Log to file"), mCmdOutputGroup, mCmdOutputBox);
 	mCmdLogToFile->setFixedSize(mCmdLogToFile->sizeHint());
 	mCmdLogToFile->setWhatsThis(i18nc("@info:whatsthis", "Check to log the command output to a local file. The output will be appended to any existing contents of the file."));
+	connect(mCmdLogToFile, SIGNAL(fileChanged()), SLOT(contentsChanged()));
 	mCmdOutputGroup->addButton(mCmdLogToFile, Preferences::Log_File);
 	vlayout->addWidget(mCmdLogToFile, 0, Qt::AlignLeft);
 	vlayout->addWidget(box);
@@ -1054,6 +1103,7 @@
 		mEmailFromList->setMinimumSize(mEmailFromList->sizeHint());
 		label->setBuddy(mEmailFromList);
 		mEmailFromList->setWhatsThis(i18nc("@info:whatsthis", "Your email identity, used to identify you as the sender when sending email alarms."));
+		connect(mEmailFromList, SIGNAL(identityChanged(uint)), SLOT(contentsChanged()));
 		grid->addWidget(mEmailFromList, 0, 1, 1, 2);
 	}
 
@@ -1066,6 +1116,7 @@
 	mEmailToEdit->setMinimumSize(mEmailToEdit->sizeHint());
 	mEmailToEdit->setWhatsThis(i18nc("@info:whatsthis", "Enter the addresses of the email recipients. Separate multiple addresses by "
 	                                "commas or semicolons."));
+	connect(mEmailToEdit, SIGNAL(textChanged(const QString&)), SLOT(contentsChanged()));
 	grid->addWidget(mEmailToEdit, 1, 1);
 
 	mEmailAddressButton = new QPushButton(parent);
@@ -1086,11 +1137,13 @@
 	mEmailSubjectEdit->setMinimumSize(mEmailSubjectEdit->sizeHint());
 	label->setBuddy(mEmailSubjectEdit);
 	mEmailSubjectEdit->setWhatsThis(i18nc("@info:whatsthis", "Enter the email subject."));
+	connect(mEmailSubjectEdit, SIGNAL(textChanged(const QString&)), SLOT(contentsChanged()));
 	grid->addWidget(mEmailSubjectEdit, 2, 1, 1, 2);
 
 	// Email body
 	mEmailMessageEdit = new TextEdit(parent);
 	mEmailMessageEdit->setWhatsThis(i18nc("@info:whatsthis", "Enter the email message."));
+	connect(mEmailMessageEdit, SIGNAL(textChanged()), SLOT(contentsChanged()));
 	frameLayout->addWidget(mEmailMessageEdit);
 
 	// Email attachments
@@ -1128,6 +1181,7 @@
 	mEmailBcc = new CheckBox(i18n_chk_CopyEmailToSelf(), parent);
 	mEmailBcc->setFixedSize(mEmailBcc->sizeHint());
 	mEmailBcc->setWhatsThis(i18nc("@info:whatsthis", "If checked, the email will be blind copied to you."));
+	connect(mEmailBcc, SIGNAL(toggled(bool)), SLOT(contentsChanged()));
 	grid->addWidget(mEmailBcc, 1, 0, 1, 2, Qt::AlignLeft);
 }
 
@@ -1151,6 +1205,14 @@
 		// Set the values to their defaults
 		mEmailBcc->setChecked(Preferences::defaultEmailBcc());
 	}
+	attachmentEnable();
+}
+
+/******************************************************************************
+* Enable/disable controls depending on whether any attachments are entered.
+*/
+void EditEmailAlarmDlg::attachmentEnable()
+{
 	bool enable = mEmailAttachList->count();
 	mEmailAttachList->setEnabled(enable);
 	if (mEmailRemoveButton)
@@ -1174,6 +1236,29 @@
 }
 
 /******************************************************************************
+* Initialise various values in the New Alarm dialogue.
+*/
+void EditEmailAlarmDlg::setEmailFields(uint fromID, const EmailAddressList& addresses,
+                                       const QString& subject, const QStringList& attachments)
+{
+	if (fromID)
+		mEmailFromList->setCurrentIdentity(fromID);
+	if (!addresses.isEmpty())
+		mEmailToEdit->setText(addresses.join(", "));
+	if (!subject.isEmpty())
+		mEmailSubjectEdit->setText(subject);
+	if (!attachments.isEmpty())
+	{
+		mEmailAttachList->addItems(attachments);
+		attachmentEnable();
+	}
+}
+void EditEmailAlarmDlg::setBcc(bool bcc)
+{
+	mEmailBcc->setChecked(bcc);
+}
+
+/******************************************************************************
 * Set the read-only status of all non-template controls.
 */
 void EditEmailAlarmDlg::setReadOnly(bool readOnly)
@@ -1311,11 +1396,14 @@
 void EditEmailAlarmDlg::type_trySuccessMessage(ShellProcess*, const QString&)
 {
 	QString msg;
+	QString to = mEmailAddresses.join("<nl/>");
+	to.replace('<', "&lt;");
+	to.replace('>', "&gt;");
 	if (mEmailBcc->isChecked())
-		msg = i18nc("@info", "Email sent to:<nl/>%1<nl/>Bcc: <email>%2</email>",
-		            mEmailAddresses.join("<nl/>"), Preferences::emailBccAddress());
+		msg = "<qt>" + i18nc("@info", "Email sent to:<nl/>%1<nl/>Bcc: <email>%2</email>",
+		            to, Preferences::emailBccAddress()) + "</qt>";
 	else
-		msg = i18nc("@info", "Email sent to:<nl/>%1", mEmailAddresses.join("<nl/>"));
+		msg = "<qt>" + i18nc("@info", "Email sent to:<nl/>%1", to) + "</qt>";
 	KMessageBox::information(this, msg);
 }
 
@@ -1348,6 +1436,7 @@
 		mEmailAttachList->setCurrentIndex(mEmailAttachList->count() - 1);   // select the new item
 		mEmailRemoveButton->setEnabled(true);
 		mEmailAttachList->setEnabled(true);
+		contentsChanged();
 	}
 }
 
@@ -1366,6 +1455,7 @@
 		mEmailRemoveButton->setEnabled(false);
 		mEmailAttachList->setEnabled(false);
 	}
+	contentsChanged();
 }
 
 /******************************************************************************
@@ -1391,16 +1481,19 @@
 	vlayout->setSpacing(KDialog::spacingHint());
 	mTypeScript = new CheckBox(EditCommandAlarmDlg::i18n_chk_EnterScript(), this);
 	mTypeScript->setFixedSize(mTypeScript->sizeHint());
+	mTypeScript->setWhatsThis(i18nc("@info:whatsthis", "Check to enter the contents of a script instead of a shell command line"));
 	connect(mTypeScript, SIGNAL(toggled(bool)), SLOT(slotCmdScriptToggled(bool)));
-	mTypeScript->setWhatsThis(i18nc("@info:whatsthis", "Check to enter the contents of a script instead of a shell command line"));
+	connect(mTypeScript, SIGNAL(toggled(bool)), SIGNAL(changed()));
 	vlayout->addWidget(mTypeScript, 0, Qt::AlignLeft);
 
 	mCommandEdit = new LineEdit(LineEdit::Url, this);
 	mCommandEdit->setWhatsThis(i18nc("@info:whatsthis", "Enter a shell command to execute."));
+	connect(mCommandEdit, SIGNAL(textChanged(const QString&)), SIGNAL(changed()));
 	vlayout->addWidget(mCommandEdit);
 
 	mScriptEdit = new TextEdit(this);
 	mScriptEdit->setWhatsThis(i18nc("@info:whatsthis", "Enter the contents of a script to execute"));
+	connect(mScriptEdit, SIGNAL(textChanged()), SIGNAL(changed()));
 	vlayout->addWidget(mScriptEdit);
 
 	slotCmdScriptToggled(mTypeScript->isChecked());
Index: kalarm/functions.cpp
===================================================================
--- kalarm/functions.cpp	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ kalarm/functions.cpp	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -20,6 +20,7 @@
 
 #include "kalarm.h"   //krazy:exclude=includes (kalarm.h must be first)
 #include "functions.h"
+#include "functions_p.h"
 
 #include "alarmcalendar.h"
 #include "alarmevent.h"
@@ -38,6 +39,14 @@
 #include "templatelistview.h"
 #include "templatemenuaction.h"
 
+#ifdef Q_WS_X11
+#include <kwindowsystem.h>
+#include <kxmessages.h>
+#include <kstartupinfo.h>
+#include <netwm.h>
+#include <QX11Info>
+#endif
+
 #include <QDir>
 #include <QRegExp>
 #include <QDesktopWidget>
@@ -78,13 +87,13 @@
 
 const char*   KMAIL_DBUS_SERVICE      = "org.kde.kmail";
 //const char*   KMAIL_DBUS_IFACE        = "org.kde.kmail.kmail";
-const char*   KMAIL_DBUS_WINDOW_PATH  = "/kmail/kmail_mainwindow_1";
+//const char*   KMAIL_DBUS_WINDOW_PATH  = "/kmail/kmail_mainwindow_1";
 const char*   KORG_DBUS_SERVICE       = "org.kde.korganizer";
 const char*   KORG_DBUS_IFACE         = "org.kde.korganizer.Korganizer";
 // D-Bus object path of KOrganizer's notification interface
 #define       KORG_DBUS_PATH            "/Korganizer"
 #define       KORG_DBUS_LOAD_PATH       "/korganizer_PimApplication"
-const char*   KORG_DBUS_WINDOW_PATH   = "/korganizer/MainWindow_1";
+//const char*   KORG_DBUS_WINDOW_PATH   = "/korganizer/MainWindow_1";
 const QString KORGANIZER_UID         = QString::fromLatin1("-korg");
 
 const char*   ALARM_OPTS_FILE        = "alarmopts";
@@ -101,7 +110,7 @@
 namespace KAlarm
 {
 
-void doEditNewAlarm(EditAlarmDlg*, bool alreadyExecuted = false);
+Private* Private::mInstance = 0;
 
 
 /******************************************************************************
@@ -855,7 +864,7 @@
 	// the dialogue is still open. It prevents double deletion (both on
 	// deletion of parent, and on return from this function).
 	AutoQPointer<EditAlarmDlg> editDlg = EditAlarmDlg::create(false, type, true, parent);
-	doEditNewAlarm(editDlg);
+	execNewAlarmDlg(editDlg);
 }
 
 /******************************************************************************
@@ -887,7 +896,7 @@
 	AutoQPointer<EditAlarmDlg> editDlg = EditAlarmDlg::create(false, type, true, parent);
 	if (setAction  ||  text)
 		editDlg->setAction(action, *text);
-	doEditNewAlarm(editDlg);
+	execNewAlarmDlg(editDlg);
 }
 
 /******************************************************************************
@@ -900,13 +909,13 @@
 	// the dialogue is still open. It prevents double deletion (both on
 	// deletion of parent, and on return from this function).
 	AutoQPointer<EditAlarmDlg> editDlg = EditAlarmDlg::create(false, preset, true, parent);
-	doEditNewAlarm(editDlg);
+	execNewAlarmDlg(editDlg);
 }
 
 /******************************************************************************
 * Common code for editNewAlarm() variants.
 */
-void doEditNewAlarm(EditAlarmDlg* editDlg, bool alreadyExecuted)
+void execNewAlarmDlg(EditAlarmDlg* editDlg, bool alreadyExecuted)
 {
 	if (alreadyExecuted  ||  editDlg->exec() == QDialog::Accepted)
 	{
@@ -1030,7 +1039,7 @@
 		{
 			// Event has been deleted while the user was editing the alarm,
 			// so treat it as a new alarm.
-			doEditNewAlarm(editDlg, true);
+			execNewAlarmDlg(editDlg, true);
 			return;
 		}
 		KAEvent newEvent;
@@ -1096,17 +1105,17 @@
 	if (AlarmCalendar::resources()->eventReadOnly(event->id()))
 	{
 		// The template is read-only, so make the dialogue read-only.
-                // Use AutoQPointer to guard against crash on application exit while
-                // the dialogue is still open. It prevents double deletion (both on
-                // deletion of parent, and on return from this function).
-                AutoQPointer<EditAlarmDlg> editDlg = EditAlarmDlg::create(true, event, false, parent, EditAlarmDlg::RES_PROMPT, true);
+		// Use AutoQPointer to guard against crash on application exit while
+		// the dialogue is still open. It prevents double deletion (both on
+		// deletion of parent, and on return from this function).
+		AutoQPointer<EditAlarmDlg> editDlg = EditAlarmDlg::create(true, event, false, parent, EditAlarmDlg::RES_PROMPT, true);
 		editDlg->exec();
 		return;
 	}
-        // Use AutoQPointer to guard against crash on application exit while
-        // the dialogue is still open. It prevents double deletion (both on
-        // deletion of parent, and on return from this function).
-        AutoQPointer<EditAlarmDlg> editDlg = EditAlarmDlg::create(true, event, false, parent, EditAlarmDlg::RES_USE_EVENT_ID);
+	// Use AutoQPointer to guard against crash on application exit while
+	// the dialogue is still open. It prevents double deletion (both on
+	// deletion of parent, and on return from this function).
+	AutoQPointer<EditAlarmDlg> editDlg = EditAlarmDlg::create(true, event, false, parent, EditAlarmDlg::RES_USE_EVENT_ID);
 	if (editDlg->exec() == QDialog::Accepted)
 	{
 		KAEvent newEvent;
@@ -1127,10 +1136,10 @@
 */
 void viewAlarm(const KAEvent* event, QWidget* parent)
 {
-        // Use AutoQPointer to guard against crash on application exit while
-        // the dialogue is still open. It prevents double deletion (both on
-        // deletion of parent, and on return from this function).
-        AutoQPointer<EditAlarmDlg> editDlg = EditAlarmDlg::create(false, event, false, parent, EditAlarmDlg::RES_PROMPT, true);
+	// Use AutoQPointer to guard against crash on application exit while
+	// the dialogue is still open. It prevents double deletion (both on
+	// deletion of parent, and on return from this function).
+	AutoQPointer<EditAlarmDlg> editDlg = EditAlarmDlg::create(false, event, false, parent, EditAlarmDlg::RES_PROMPT, true);
 	editDlg->exec();
 }
 
@@ -1218,61 +1227,116 @@
 }
 
 /******************************************************************************
-*  Start KMail if it isn't already running, and optionally iconise it.
+*  Start KMail if it isn't already running, optionally minimised.
 *  Reply = reason for failure to run KMail (which may be the empty string)
 *        = null string if success.
 */
 QString runKMail(bool minimise)
 {
-	QString dbusService = KMAIL_DBUS_SERVICE;
-	QString errmsg;
-	if (!runProgram(QLatin1String("kmail"), dbusService, (minimise ? QLatin1String(KMAIL_DBUS_WINDOW_PATH) : QString()), errmsg))
-		return i18nc("@info", "Unable to start <application>KMail</application><nl/>(<message>%1</message>)", errmsg);
+	QDBusReply<bool> reply = QDBusConnection::sessionBus().interface()->isServiceRegistered(KMAIL_DBUS_SERVICE);
+	if (!reply.isValid()  ||  !reply.value())
+	{
+		// Program is not already running, so start it
+		QString errmsg;
+		if (minimise  &&  Private::startKMailMinimised())
+			return QString();
+		if (KToolInvocation::startServiceByDesktopName(QLatin1String("kmail"), QString(), &errmsg))
+		{
+			kError() << "Couldn't start KMail (" << errmsg << ")";
+			return i18nc("@info", "Unable to start <application>KMail</application><nl/>(<message>%1</message>)", errmsg);
+		}
+	}
 	return QString();
 }
 
 /******************************************************************************
-*  Start another program for D-Bus access if it isn't already running.
-*  If 'dbusWindowPath' is not empty, the program's window with that D-Bus path
-*  name is iconised.
-*  On exit, 'errorMessage' contains an error message if failure.
-*  Reply = true if the program is now running.
+* Start KMail, minimised.
+* This code is taken from kstart in kdebase.
 */
-bool runProgram(const QString& program, QString& dbusService, const QString& dbusWindowPath, QString& errorMessage)
+bool Private::startKMailMinimised()
 {
-	QDBusReply<bool> reply = QDBusConnection::sessionBus().interface()->isServiceRegistered(dbusService);
-	if (!reply.isValid()  ||  !reply.value())
+#ifdef Q_WS_X11
+	NETRootInfo i(QX11Info::display(), NET::Supported);
+	if (i.isSupported(NET::WM2KDETemporaryRules))
 	{
-		// Program is not already running, so start it
-		if (KToolInvocation::startServiceByDesktopName(program, QString(), &errorMessage, &dbusService))
-		{
-			kError() << "Couldn't start" << program << " (" << errorMessage << ")";
-			return false;
-		}
-		if (!dbusWindowPath.isEmpty())
-		{
-			// Minimise its window - don't use hide() since this would remove all
-			// trace of it from the panel if it is not configured to be docked in
-			// the system tray.
-#ifdef __GNUC__
-#warning Make minimise window work
-#endif
-//Call D-Bus app/MainWin showMinimized()???
-#if 0
-//			QDBusInterface iface(dbusService, DBUS_PATH, DBUS_IFACE);
-//			QDBusInterface iface(dbusService, dbusWindowPath);
-			QDBusInterface iface(dbusService, "/kmail_mainwindow_1", "com.trolltech.Qt.QWidget");
-			QDBusError err = iface.callWithArgumentList(QDBus::NoBlock, QLatin1String("showMinimized"), QList<QVariant>());
-			if (err.isValid())
-				kError() << program << ": showMinimized D-Bus call failed:" << err.message();
-#endif
-		}
+		kDebug() << "using rules";
+		KXMessages msg;
+		QString message = "wmclass=kmail\nwmclassmatch=1\n"  // 1 = exact match
+		                  "wmclasscomplete=false\n"
+		                  "minimize=true\nminimizerule=3\n"
+		                  "type=" + QString().setNum(NET::Normal) + "\ntyperule=2";
+		msg.broadcastMessage("_KDE_NET_WM_TEMPORARY_RULES", message, -1, false);
+		qApp->flush();
 	}
-	errorMessage.clear();
+	else
+	{
+		// Connect to window add to get the NEW windows
+		kDebug() << "connecting to window add";
+		connect(KWindowSystem::self(), SIGNAL(windowAdded(WId)), instance(), SLOT(windowAdded(WId)));
+	}
+	// Propagate the app startup notification info to the started app.
+	// We are not using KApplication, so the env remained set.
+	KStartupInfoId id = KStartupInfo::currentStartupIdEnv();
+	KProcess* proc = new KProcess;
+	(*proc) << "kmail";
+	int pid = proc->startDetached();
+	if (!pid)
+	{
+		KStartupInfo::sendFinish(id); // failed to start
+		return false;
+	}
+	KStartupInfoData data;
+	data.addPid(pid);
+	data.setName("kmail");
+	data.setBin("kmail");
+	KStartupInfo::sendChange(id, data);
 	return true;
+#else
+	return false;
+#endif
 }
 
+#ifdef Q_WS_X11
 /******************************************************************************
+* Called when a window is created, to minimise it.
+* This code is taken from kstart in kdebase.
+*/
+void Private::windowAdded(WId w)
+{
+	static const int SUPPORTED_TYPES = NET::NormalMask | NET::DesktopMask | NET::DockMask
+	                                 | NET::ToolbarMask | NET::MenuMask | NET::DialogMask
+	                                 | NET::OverrideMask | NET::TopMenuMask | NET::UtilityMask | NET::SplashMask;
+kDebug();
+	KWindowInfo kwinfo = KWindowSystem::windowInfo(w, NET::WMWindowType | NET::WMName);
+	if (kwinfo.windowType(SUPPORTED_TYPES) == NET::TopMenu
+	||  kwinfo.windowType(SUPPORTED_TYPES) == NET::Toolbar
+	||  kwinfo.windowType(SUPPORTED_TYPES) == NET::Desktop)
+		return;   // always ignore these window types
+
+kDebug()<<"1";
+	QX11Info qxinfo;
+	XWithdrawWindow(QX11Info::display(), w, qxinfo.screen());
+	QApplication::flush();
+
+	NETWinInfo info(QX11Info::display(), w, QX11Info::appRootWindow(), NET::WMState);
+	XWMHints* hints = XGetWMHints(QX11Info::display(), w);
+	if (hints)
+	{
+		hints->flags |= StateHint;
+		hints->initial_state = IconicState;
+		XSetWMHints(QX11Info::display(), w, hints);
+		XFree(hints);
+	}
+	info.setWindowType(NET::Normal);
+
+	XSync(QX11Info::display(), False);
+	XMapWindow(QX11Info::display(), w);
+	XSync(QX11Info::display(), False);
+	QApplication::flush();
+}
+#endif
+
+/******************************************************************************
 * The "Don't show again" option for error messages is personal to the user on a
 * particular computer. For example, he may want to inhibit error messages only
 * on his laptop. So the status is not stored in the alarm calendar, but in the
@@ -1537,7 +1601,7 @@
 *   allowTZ   = whether to allow a time zone specifier in timeString.
 * Reply = true if successful.
 */
-bool convTimeString(const QByteArray& timeString, KDateTime& dateTime, const KDateTime& defaultDt, bool allowTZ)
+bool convertTimeString(const QByteArray& timeString, KDateTime& dateTime, const KDateTime& defaultDt, bool allowTZ)
 {
 #define MAX_DT_LEN 19
 	int i = timeString.indexOf(' ');
@@ -1716,21 +1780,20 @@
 {
 	const QByteArray newTime = qgetenv("KALARM_TIME");
 	if (!newTime.isEmpty())
-		setSimulatedSystemTime(newTime);
+	{
+		KDateTime dt;
+		if (convertTimeString(newTime, dt, KDateTime::realCurrentLocalDateTime(), true))
+			setSimulatedSystemTime(dt);
+	}
 }
 
 /******************************************************************************
-* Set the simulated system time (format [[[yyyy-]mm-]dd-]hh:mm [TZ]).
+* Set the simulated system time.
 */
-bool setSimulatedSystemTime(const QByteArray& timeString)
+void setSimulatedSystemTime(const KDateTime& dt)
 {
-	KDateTime dt;
-	if (!convTimeString(timeString, dt, KDateTime::realCurrentLocalDateTime(), true))
-		return false;
 	KDateTime::setSimulatedSystemTime(dt);
-	KDateTime now = KDateTime::currentLocalDateTime();
-	kDebug() << "New time=" << qPrintable(KDateTime::currentLocalDateTime().dateTime().toString("yyyy-MM-dd hh:mm")) << KSystemTimeZones::local().name();
-	return true;
+	kDebug() << "New time =" << qPrintable(KDateTime::currentLocalDateTime().toString("%Y-%m-%d %H:%M %:Z"));
 }
 #endif
 
Index: kalarm/soundpicker.cpp
===================================================================
--- kalarm/soundpicker.cpp	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ kalarm/soundpicker.cpp	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -84,6 +84,7 @@
 	mSpeakShowing = !theApp()->speechEnabled();
 	showSpeak(!mSpeakShowing);            // index Speak (only displayed if appropriate)
 	connect(mTypeCombo, SIGNAL(activated(int)), SLOT(slotTypeSelected(int)));
+	connect(mTypeCombo, SIGNAL(currentIndexChanged(int)), SIGNAL(changed()));
 	label->setBuddy(mTypeCombo);
 	soundLayout->addWidget(mTypeBox);
 
@@ -259,6 +260,7 @@
 */
 void SoundPicker::slotPickFile()
 {
+	KUrl oldfile = mFile;
 	KUrl file = mFile;
 	SoundDlg dlg(mFile.prettyUrl(), mVolume, mFadeVolume, mFadeSeconds, mRepeat, i18nc("@title:window", "Sound File"), this);
 	dlg.setReadOnly(mReadOnly);
@@ -295,6 +297,8 @@
 	}
 	else
 		mTypeCombo->setToolTip(mFile.prettyUrl());
+	if (accepted  ||  mFile != oldfile)
+		emit changed();
 }
 
 /******************************************************************************
Index: kalarm/alarmevent.cpp
===================================================================
--- kalarm/alarmevent.cpp	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ kalarm/alarmevent.cpp	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -4440,7 +4440,36 @@
 	return result;
 }
 
+/******************************************************************************
+* Return a list of the pure email addresses, excluding names.
+*/
+QStringList EmailAddressList::pureAddresses() const
+{
+	QStringList list;
+	for (int p = 0, end = count();  p < end;  ++p)
+		list += at(p).email();
+	return list;
+}
 
+/******************************************************************************
+* Return a list of the pure email addresses, excluding names, as a string.
+*/
+QString EmailAddressList::pureAddresses(const QString& separator) const
+{
+	QString result;
+	bool first = true;
+	for (int p = 0, end = count();  p < end;  ++p)
+	{
+		if (first)
+			first = false;
+		else
+			result += separator;
+		result += at(p).email();
+	}
+	return result;
+}
+
+
 /*=============================================================================
 = Static functions
 =============================================================================*/
Index: kalarm/messagewin.cpp
===================================================================
--- kalarm/messagewin.cpp	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ kalarm/messagewin.cpp	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -33,6 +33,8 @@
 #include "shellprocess.h"
 #include "synchtimer.h"
 
+#include "kspeechinterface.h"
+
 #include <kstandarddirs.h>
 #include <kaction.h>
 #include <kstandardguiitem.h>
@@ -51,7 +53,6 @@
 #include <kio/netaccess.h>
 #include <knotification.h>
 #include <kpushbutton.h>
-#include <kspeechinterface.h>
 #include <phonon/mediaobject.h>
 #include <phonon/audiooutput.h>
 #include <phonon/volumefadereffect.h>
@@ -817,6 +818,8 @@
 	{
 		config.writeEntry("EventID", mEventID);
 		config.writeEntry("AlarmType", static_cast<int>(mAlarmType));
+		if (mAlarmType == KAAlarm::INVALID_ALARM)
+			kError() << "Invalid alarm: id=" << mEventID << ", alarm count=" << mEvent.alarmCount();
 		config.writeEntry("Message", mMessage);
 		config.writeEntry("Type", static_cast<int>(mAction));
 		config.writeEntry("Font", mFont);
@@ -870,6 +873,11 @@
 	mInvalid             = config.readEntry("Invalid", false);
 	mEventID             = config.readEntry("EventID");
 	mAlarmType           = static_cast<KAAlarm::Type>(config.readEntry("AlarmType", 0));
+	if (mAlarmType == KAAlarm::INVALID_ALARM)
+	{
+		mInvalid = true;
+		kError() << "Invalid alarm: id=" << mEventID;
+	}
 	mMessage             = config.readEntry("Message");
 	mAction              = static_cast<KAEvent::Action>(config.readEntry("Type", 0));
 	mFont                = config.readEntry("Font", QFont());
@@ -1301,13 +1309,14 @@
 	mAudioObject = new Phonon::MediaObject();
 	mAudioObject->setCurrentSource(source);
 	Phonon::AudioOutput* output = new Phonon::AudioOutput(Phonon::NotificationCategory, mAudioObject);
-	output->setVolume(mVolume);
 	mPath = Phonon::createPath(mAudioObject, output);
+	float maxvol = qMax(mVolume, mFadeVolume);
+	output->setVolume(maxvol);
 	if (mFadeVolume >= 0  &&  mFadeSeconds > 0)
 	{
 		Phonon::VolumeFaderEffect* fader = new Phonon::VolumeFaderEffect(mAudioObject);
-		fader->setVolume(mFadeVolume);
-		fader->fadeIn(mFadeSeconds);
+		fader->setVolume(mFadeVolume / maxvol);
+		fader->fadeTo(mVolume / maxvol, mFadeSeconds * 1000);
 		mPath.insertEffect(fader);
 	}
 	connect(mAudioObject, SIGNAL(stateChanged(Phonon::State, Phonon::State)), SLOT(playStateChanged(Phonon::State)), Qt::DirectConnection);
@@ -1494,7 +1503,7 @@
 void MessageWin::showEvent(QShowEvent* se)
 {
 	MainWindowBase::showEvent(se);
-	if (mShown)
+	if (mShown  ||  mAlarmType == KAAlarm::INVALID_ALARM)
 		return;
 	if (mErrorWindow)
 		enableButtons();    // don't bother repositioning error messages
Index: kalarm/editdlg.cpp
===================================================================
--- kalarm/editdlg.cpp	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ kalarm/editdlg.cpp	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -47,6 +47,22 @@
 #include "timeedit.h"
 #include "timespinbox.h"
 
+#include <libkdepim/maillistdrag.h>
+#include <libkdepim/kvcarddrag.h>
+#include <kcal/period.h>
+#include <kcal/icaldrag.h>
+
+#include <kglobal.h>
+#include <klocale.h>
+#include <kconfig.h>
+#include <kfiledialog.h>
+#include <kpushbutton.h>
+#include <kmessagebox.h>
+#include <khbox.h>
+#include <kvbox.h>
+#include <kwindowsystem.h>
+#include <kdebug.h>
+
 #include <QLabel>
 #include <QDir>
 #include <QStyle>
@@ -62,20 +78,6 @@
 #include <QScrollBar>
 #include <QTimer>
 
-#include <kglobal.h>
-#include <klocale.h>
-#include <kconfig.h>
-#include <kfiledialog.h>
-#include <kmessagebox.h>
-#include <khbox.h>
-#include <kvbox.h>
-#include <kwindowsystem.h>
-#include <kdebug.h>
-
-#include <libkdepim/maillistdrag.h>
-#include <libkdepim/kvcarddrag.h>
-#include <kcal/icaldrag.h>
-
 using namespace KCal;
 
 static const char EDIT_DIALOG_NAME[] = "EditDialog";
@@ -107,6 +109,7 @@
 		case DISPLAY:  return new EditDisplayAlarmDlg(Template, newAlarm, parent, getResource);
 		case COMMAND:  return new EditCommandAlarmDlg(Template, newAlarm, parent, getResource);
 		case EMAIL:    return new EditEmailAlarmDlg(Template, newAlarm, parent, getResource);
+		default:  break;
 	}
 	return 0;
 }
@@ -234,6 +237,7 @@
 		label->setFixedSize(label->sizeHint());
 		mTemplateName = new KLineEdit(box);
 		mTemplateName->setReadOnly(mReadOnly);
+		connect(mTemplateName, SIGNAL(userTextChanged(const QString&)), SLOT(contentsChanged()));
 		label->setBuddy(mTemplateName);
 		box->setWhatsThis(i18nc("@info:whatsthis", "Enter the name of the alarm template"));
 		box->setFixedHeight(box->sizeHint().height());
@@ -263,6 +267,7 @@
 	connect(mRecurrenceEdit, SIGNAL(typeChanged(int)), SLOT(slotRecurTypeChange(int)));
 	connect(mRecurrenceEdit, SIGNAL(frequencyChanged()), SLOT(slotRecurFrequencyChange()));
 	connect(mRecurrenceEdit, SIGNAL(repeatNeedsInitialisation()), SLOT(slotSetSubRepetition()));
+	connect(mRecurrenceEdit, SIGNAL(contentsChanged()), SLOT(contentsChanged()));
 
 	// Controls specific to the alarm type
 	QGroupBox* actionBox = new QGroupBox(i18nc("@title:group", "Action"), mainPage);
@@ -309,6 +314,7 @@
 		grid->setSpacing(spacingHint());
 		mTemplateTimeGroup = new ButtonGroup(templateTimeBox);
 		connect(mTemplateTimeGroup, SIGNAL(buttonSet(QAbstractButton*)), SLOT(slotTemplateTimeType(QAbstractButton*)));
+		connect(mTemplateTimeGroup, SIGNAL(buttonSet(QAbstractButton*)), SLOT(contentsChanged()));
 
 		mTemplateDefaultTime = new RadioButton(i18nc("@option:radio", "Default time"), templateTimeBox);
 		mTemplateDefaultTime->setFixedSize(mTemplateDefaultTime->sizeHint());
@@ -332,6 +338,7 @@
 		mTemplateTime->setWhatsThis(i18nc("@info:whatsthis",
 		      "<para>Enter the start time for alarms based on this template.</para><para>%1</para>",
 		      TimeSpinBox::shiftWhatsThis()));
+		connect(mTemplateTime, SIGNAL(valueChanged(int)), SLOT(contentsChanged()));
 		box->setStretchFactor(new QWidget(box), 1);    // left adjust the controls
 		box->setFixedHeight(box->sizeHint().height());
 		grid->addWidget(box, 0, 1, Qt::AlignLeft);
@@ -357,6 +364,7 @@
 		mTemplateTimeAfter->setValue(1439);
 		mTemplateTimeAfter->setFixedSize(mTemplateTimeAfter->sizeHint());
 		mTemplateTimeAfter->setReadOnly(mReadOnly);
+		connect(mTemplateTimeAfter, SIGNAL(valueChanged(int)), SLOT(contentsChanged()));
 		mTemplateTimeAfter->setWhatsThis(i18nc("@info:whatsthis", "<para>%1</para><para>%2</para>",
 		                                       AlarmTimeWidget::i18n_TimeAfterPeriod(), TimeSpinBox::shiftWhatsThis()));
 		box->setFixedHeight(box->sizeHint().height());
@@ -368,6 +376,7 @@
 	{
 		mTimeWidget = new AlarmTimeWidget(i18nc("@title:group", "Time"), AlarmTimeWidget::AT_TIME, mainPage);
 		connect(mTimeWidget, SIGNAL(dateOnlyToggled(bool)), SLOT(slotAnyTimeToggled(bool)));
+		connect(mTimeWidget, SIGNAL(changed(const KDateTime&)), SLOT(contentsChanged()));
 		topLayout->addWidget(mTimeWidget);
 	}
 
@@ -384,6 +393,7 @@
 	if (mReminder)
 	{
 		mReminder->setFixedSize(mReminder->sizeHint());
+		connect(mReminder, SIGNAL(changed()), SLOT(contentsChanged()));
 		moreLayout->addWidget(mReminder, 0, Qt::AlignLeft);
 		if (mTimeWidget)
 			connect(mTimeWidget, SIGNAL(changed(const KDateTime&)), mReminder, SLOT(setDefaultUnits(const KDateTime&)));
@@ -391,6 +401,7 @@
 
 	// Late cancel selector - default = allow late display
 	mLateCancel = new LateCancelSelector(true, mMoreOptions);
+	connect(mLateCancel, SIGNAL(changed()), SLOT(contentsChanged()));
 	moreLayout->addWidget(mLateCancel, 0, Qt::AlignLeft);
 
 	PackedLayout* playout = new PackedLayout(Qt::AlignJustify);
@@ -402,6 +413,7 @@
 	if (confirmAck)
 	{
 		confirmAck->setFixedSize(confirmAck->sizeHint());
+		connect(confirmAck, SIGNAL(toggled(bool)), SLOT(contentsChanged()));
 		playout->addWidget(confirmAck);
 	}
 
@@ -410,6 +422,7 @@
 		// Show in KOrganizer checkbox
 		mShowInKorganizer = new CheckBox(i18n_chk_ShowInKOrganizer(), mMoreOptions);
 		mShowInKorganizer->setFixedSize(mShowInKorganizer->sizeHint());
+		connect(mShowInKorganizer, SIGNAL(toggled(bool)), SLOT(contentsChanged()));
 		mShowInKorganizer->setWhatsThis(i18nc("@info:whatsthis", "Check to copy the alarm into KOrganizer's calendar"));
 		playout->addWidget(mShowInKorganizer);
 	}
@@ -429,6 +442,7 @@
 	{
 		// Save the initial state of all controls so that we can later tell if they have changed
 		saveState((event && (mTemplate || !event->isTemplate())) ? event : 0);
+		contentsChanged();    // enable/disable OK button
 	}
 
 	// Note the current desktop so that the dialog can be shown on it.
@@ -528,7 +542,7 @@
 		if (mShowInKorganizer)
 			mShowInKorganizer->setChecked(event->copyToKOrganizer());
 		type_initValues(event);
-		mRecurrenceEdit->set(*event, (mTemplate || event->isTemplate()));   // must be called after mTimeWidget is set up, to ensure correct date-only enabling
+		mRecurrenceEdit->set(*event);   // must be called after mTimeWidget is set up, to ensure correct date-only enabling
 		mTabs->setTabText(mRecurPageIndex, recurText(*event));
 	}
 	else
@@ -561,6 +575,35 @@
 }
 
 /******************************************************************************
+* Initialise various values in the New Alarm dialogue.
+*/
+void EditAlarmDlg::setTime(const DateTime& start)
+{
+	mTimeWidget->setDateTime(start);
+}
+void EditAlarmDlg::setRecurrence(const KARecurrence& recur, int subRepeatInterval, int subRepeatCount)
+{
+	KAEvent event;
+	event.setTime(mTimeWidget->getDateTime(0, false, false));
+	event.setRecurrence(recur);
+	event.setRepetition(subRepeatInterval, subRepeatCount - 1);
+	mRecurrenceEdit->set(event);
+}
+void EditAlarmDlg::setRepeatAtLogin()
+{
+	mRecurrenceEdit->setRepeatAtLogin();
+}
+void EditAlarmDlg::setLateCancel(int minutes)
+{
+	mLateCancel->setMinutes(minutes, mTimeWidget->getDateTime(0, false, false).isDateOnly(),
+	                        TimePeriod::HoursMinutes);
+}
+void EditAlarmDlg::setShowInKOrganizer(bool show)
+{
+	mShowInKorganizer->setChecked(show);
+}
+
+/******************************************************************************
 * Set the read-only status of all non-template controls.
 */
 void EditAlarmDlg::setReadOnly(bool readOnly)
@@ -604,6 +647,7 @@
 	if (mShowInKorganizer)
 		mSavedShowInKorganizer = mShowInKorganizer->isChecked();
 	mSavedRecurrenceType   = mRecurrenceEdit->repeatType();
+	mSavedDeferTime        = mDeferDateTime.kDateTime();
 }
 
 /******************************************************************************
@@ -651,6 +695,19 @@
 }
 
 /******************************************************************************
+* Called whenever any of the controls changes state.
+* Enable or disable the OK button depending on whether any controls have a
+* different state from their initial state.
+*/
+void EditAlarmDlg::contentsChanged()
+{
+	// Don't do anything if it's a new alarm or we're still initialising
+	// (i.e. mSavedEvent null).
+	if (mSavedEvent  &&  button(Ok))
+		button(Ok)->setEnabled(stateChanged() || mDeferDateTime.kDateTime() != mSavedDeferTime);
+}
+
+/******************************************************************************
 * Get the currently entered dialog data.
 * The data is returned in the supplied KAEvent instance.
 * Reply = false if the only change has been to an existing deferral.
@@ -1122,7 +1179,7 @@
 	// Use AutoQPointer to guard against crash on application exit while
 	// the dialogue is still open. It prevents double deletion (both on
 	// deletion of EditAlarmDlg, and on return from this function).
-	AutoQPointer<DeferAlarmDlg> deferDlg = new DeferAlarmDlg((deferred ? mDeferDateTime : DateTime(now.addSecs(60))), deferred, this);
+	AutoQPointer<DeferAlarmDlg> deferDlg = new DeferAlarmDlg((deferred ? mDeferDateTime : DateTime(now.addSecs(60).toTimeSpec(start.timeSpec()))), deferred, this);
 	deferDlg->setObjectName("EditDeferDlg");    // used by LikeBack
 	if (limit)
 	{
@@ -1140,6 +1197,7 @@
 	{
 		mDeferDateTime = deferDlg->getDateTime();
 		mDeferTimeLabel->setText(mDeferDateTime.isValid() ? mDeferDateTime.formatLocale() : QString());
+		contentsChanged();
 	}
 }
 
Index: kalarm/fontcolourbutton.h
===================================================================
--- kalarm/fontcolourbutton.h	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ kalarm/fontcolourbutton.h	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -1,7 +1,7 @@
 /*
  *  fontcolourbutton.h  -  pushbutton widget to select a font and colour
  *  Program:  kalarm
- *  Copyright © 2003-2008 by David Jarvie <djarvie@kde.org>
+ *  Copyright © 2003-2009 by David Jarvie <djarvie@kde.org>
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -46,6 +46,7 @@
 		virtual bool  isReadOnly() const     { return mReadOnly; }
 
 	signals:
+		/** Signal emitted whenever a font or colour has been selected. */
 		void          selected(const QColor& fg, const QColor& bg);
 
 	protected slots:
Index: kalarm/soundpicker.h
===================================================================
--- kalarm/soundpicker.h	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ kalarm/soundpicker.h	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -1,7 +1,7 @@
 /*
  *  soundpicker.h  -  widget to select a sound file or a beep
  *  Program:  kalarm
- *  Copyright © 2002,2004-2007 by David Jarvie <software@astrojar.org.uk>
+ *  Copyright © 2002,2004-2007,2009 by David Jarvie <djarvie@kde.org>
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -105,6 +105,8 @@
 		static QString i18n_combo_Speak();  // text of Speak combo box item
 		static QString i18n_combo_File();   // text of File combo box item
 
+	signals:
+		void           changed();     // emitted when any contents change
 
 	private slots:
 		void           slotTypeSelected(int id);
Index: kalarm/fontcolour.h
===================================================================
--- kalarm/fontcolour.h	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ kalarm/fontcolour.h	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -25,7 +25,6 @@
 #include <QStringList>
 #include <klocale.h>
 
-class QPushButton;
 class KFontChooser;
 class CheckBox;
 class ColourButton;
Index: kalarm/alarmevent.h
===================================================================
--- kalarm/alarmevent.h	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ kalarm/alarmevent.h	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -50,9 +50,11 @@
 		EmailAddressList(const QList<KCal::Person>& list)  { operator=(list); }
 		EmailAddressList& operator=(const QList<KCal::Person>&);
 		operator QStringList() const;
-		QString join(const QString& separator) const;
+		QString     join(const QString& separator) const;
+		QStringList pureAddresses() const;
+		QString     pureAddresses(const QString& separator) const;
 	private:
-		QString address(int index) const;
+		QString     address(int index) const;
 };
 
 
@@ -68,6 +70,8 @@
 		uint               emailFromId() const         { return mEmailFromIdentity; }
 		const EmailAddressList& emailAddresses() const { return mEmailAddresses; }
 		QString            emailAddresses(const QString& sep) const  { return mEmailAddresses.join(sep); }
+		QStringList        emailPureAddresses() const  { return mEmailAddresses.pureAddresses(); }
+		QString            emailPureAddresses(const QString& sep) const  { return mEmailAddresses.pureAddresses(sep); }
 		const QString&     emailSubject() const        { return mEmailSubject; }
 		const QStringList& emailAttachments() const    { return mEmailAttachments; }
 		QString            emailAttachments(const QString& sep) const  { return mEmailAttachments.join(sep); }
@@ -477,7 +481,6 @@
 		KARecurrence::Type checkRecur() const;
 		void               checkRepetition() const;
 		OccurType          nextRecurrence(const KDateTime& preDateTime, DateTime& result) const;
-		OccurType          previousRecurrence(const KDateTime& afterDateTime, DateTime& result) const;
 		int                nextWorkRepetition(const KDateTime& pre) const;
 		void               calcTriggerTimes() const;
 		void               calcNextWorkingTime(const DateTime& nextTrigger) const;
@@ -510,7 +513,7 @@
 		DateTime           mDisplayingTime;   // date/time shown in the alarm currently being displayed
 		int                mDisplayingFlags;  // type of alarm which is currently being displayed
 		int                mReminderMinutes;  // how long in advance reminder is to be, or 0 if none
-		int                mArchiveReminderMinutes;  // original reminder period if now expired, or 0 if none
+		int                mArchiveReminderMinutes; // original reminder period if now expired, or for restoration after next recurrence, or 0 if none
 		int                mDeferDefaultMinutes; // default number of minutes for deferral dialog, or 0 to select time control
 		int                mRevision;         // SEQUENCE: revision number of the original alarm, or 0
 		KARecurrence*      mRecurrence;       // RECUR: recurrence specification, or 0 if none
Index: kalarm/functions_p.h
===================================================================
--- kalarm/functions_p.h	(.../tags/KDE/4.3.0/kdepim)	(wersja 0)
+++ kalarm/functions_p.h	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -0,0 +1,58 @@
+/*
+ *  functions_p.h  -  private declarations for miscellaneous functions
+ *  Program:  kalarm
+ *  Copyright © 2009 by David Jarvie <djarvie@kde.org>
+ *
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the GNU General Public License as published by
+ *  the Free Software Foundation; either version 2 of the License, or
+ *  (at your option) any later version.
+ *
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
+ *  GNU General Public License for more details.
+ *
+ *  You should have received a copy of the GNU General Public License along
+ *  with this program; if not, write to the Free Software Foundation, Inc.,
+ *  51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ */
+
+#ifndef FUNCTIONS_P_H
+#define FUNCTIONS_P_H
+
+#include "kalarm.h"   //krazy:exclude=includes (kalarm.h must be first)
+#ifdef Q_WS_X11
+#include <kwindowsystem.h>
+#endif
+#include <QObject>
+
+namespace KAlarm
+{
+
+// Private class which exists solely to allow signals/slots to work.
+class Private : public QObject
+{
+	Q_OBJECT
+    public:
+	Private(QObject* parent = 0) : QObject(parent) {}
+	static bool startKMailMinimised();
+	static Private* instance()
+	{
+		if (!mInstance)
+			mInstance = new Private;
+		return mInstance;
+	}
+
+    public slots:
+#ifdef Q_WS_X11
+	void windowAdded(WId);
+#endif
+
+    private:
+	static Private* mInstance;
+};
+
+} // namespace KAlarm
+
+#endif // FUNCTIONS_P_H
Index: kalarm/pixmaps/oxsc-apps-kalarm.svgz
===================================================================
Nie można wyświetlić: plik binarny.
svn:mime-type = application/octet-stream
Index: kalarm/pixmaps/CMakeLists.txt
===================================================================
--- kalarm/pixmaps/CMakeLists.txt	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ kalarm/pixmaps/CMakeLists.txt	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -1,3 +1 @@
-
-kde4_install_icons( ${ICON_INSTALL_DIR}  )
-
+kde4_install_icons( ${DATA_INSTALL_DIR}/kalarm/icons )
Index: kalarm/recurrenceeditprivate.h
===================================================================
--- kalarm/recurrenceeditprivate.h	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ kalarm/recurrenceeditprivate.h	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -1,7 +1,7 @@
 /*
  *  recurrenceeditprivate.h  -  private classes for recurrenceedit.cpp
  *  Program:  kalarm
- *  Copyright © 2003,2005,2007 by David Jarvie <software@astrojar.org.uk>
+ *  Copyright © 2003,2005,2007,2009 by David Jarvie <djarvie@kde.org>
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -59,6 +59,7 @@
 		virtual bool     stateChanged() const;
 	signals:
 		void             frequencyChanged();
+		void             changed();          // emitted whenever any control changes
 	private:
 		QWidget*         mSpinBox;
 		SpinBox*         mIntSpinBox;
Index: kalarm/pickfileradio.cpp
===================================================================
--- kalarm/pickfileradio.cpp	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ kalarm/pickfileradio.cpp	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -33,18 +33,12 @@
 PickFileRadio::PickFileRadio(QPushButton* button, LineEdit* edit, const QString& text, ButtonGroup* group, QWidget* parent)
 	: RadioButton(text, parent),
 	  mGroup(group),
-	  mEdit(edit),
-	  mButton(button),
+	  mEdit(0),
 	  mLastButton(0),
 	  mRevertButton(false)
 {
 	Q_ASSERT(parent);
-	Q_ASSERT(button);
-	mButton->setEnabled(false);
-	connect(mButton, SIGNAL(clicked()), SLOT(slotPickFile()));
-	if (mEdit)
-		mEdit->setEnabled(false);
-	connect(mGroup, SIGNAL(buttonSet(QAbstractButton*)), SLOT(slotSelectionChanged(QAbstractButton*)));
+	init(button, edit);
 }
 
 PickFileRadio::PickFileRadio(const QString& text, ButtonGroup* group, QWidget* parent)
@@ -61,12 +55,17 @@
 void PickFileRadio::init(QPushButton* button, LineEdit* edit)
 {
 	Q_ASSERT(button);
+	if (mEdit)
+		mEdit->disconnect(this);
 	mEdit   = edit;
 	mButton = button;
 	mButton->setEnabled(false);
 	connect(mButton, SIGNAL(clicked()), SLOT(slotPickFile()));
 	if (mEdit)
+	{
 		mEdit->setEnabled(false);
+		connect(mEdit, SIGNAL(textChanged(const QString&)), SIGNAL(fileChanged()));
+	}
 	connect(mGroup, SIGNAL(buttonSet(QAbstractButton*)), SLOT(slotSelectionChanged(QAbstractButton*)));
 	setReadOnly(RadioButton::isReadOnly());
 }
Index: kalarm/reminder.cpp
===================================================================
--- kalarm/reminder.cpp	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ kalarm/reminder.cpp	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -1,7 +1,7 @@
 /*
  *  reminder.cpp  -  reminder setting widget
  *  Program:  kalarm
- *  Copyright © 2003-2005,2007,2008 by David Jarvie <djarvie@kde.org>
+ *  Copyright © 2003-2005,2007-2009 by David Jarvie <djarvie@kde.org>
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -55,6 +55,7 @@
 	                         reminderWhatsThis, valueWhatsThis, allowHourMinute, this);
 	mTime->setFixedSize(mTime->sizeHint());
 	connect(mTime, SIGNAL(toggled(bool)), SLOT(slotReminderToggled(bool)));
+	connect(mTime, SIGNAL(valueChanged(const KCal::Duration&)), SIGNAL(changed()));
 	topLayout->addWidget(mTime, 0, Qt::AlignLeft);
 
 	if (showOnceOnly)
@@ -65,6 +66,7 @@
 		topLayout->addLayout(layout);
 		mOnceOnly = new CheckBox(i18n_chk_FirstRecurrenceOnly(), this);
 		mOnceOnly->setFixedSize(mOnceOnly->sizeHint());
+		connect(mOnceOnly, SIGNAL(toggled(bool)), SIGNAL(changed()));
 		mOnceOnly->setWhatsThis(i18nc("@info:whatsthis", "Display the reminder only before the first time the alarm is scheduled"));
 		layout->addWidget(mOnceOnly);
 		layout->addStretch();
Index: kalarm/editdlgtypes.h
===================================================================
--- kalarm/editdlgtypes.h	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ kalarm/editdlgtypes.h	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -1,7 +1,7 @@
 /*
  *  editdlgtypes.h  -  dialogues to create or edit alarm or alarm template types
  *  Program:  kalarm
- *  Copyright © 2001-2008 by David Jarvie <djarvie@kde.org>
+ *  Copyright © 2001-2009 by David Jarvie <djarvie@kde.org>
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -28,7 +28,6 @@
 #include "editdlg.h"
 
 class QAbstractButton;
-class QHBoxLayout;
 class QGroupBox;
 class KComboBox;
 class KHBox;
@@ -36,7 +35,6 @@
 class CheckBox;
 class ComboBox;
 class FontColourButton;
-class ColourButton;
 class ButtonGroup;
 class RadioButton;
 class Reminder;
@@ -57,10 +55,20 @@
 		             GetResourceType = RES_PROMPT);
 		EditDisplayAlarmDlg(bool Template, const KAEvent*, bool newAlarm, QWidget* parent = 0,
 		             GetResourceType = RES_PROMPT, bool readOnly = false);
+
+		// Methods to initialise values in the New Alarm dialogue.
+		// N.B. setTime() must be called first to set the date-only characteristic,
+		//      followed by setRecurrence().
 		virtual void    setAction(KAEvent::Action, const AlarmText& = AlarmText());
+		void            setBgColour(const QColor&);
+		void            setFgColour(const QColor&);
+		void            setConfirmAck(bool);
+		void            setAutoClose(bool);
+		void            setAudio(Preferences::SoundType, const QString& file = QString(), float volume = -1, bool repeat = false);
+		void            setReminder(int minutes);   // minutes < 0 for once only option
 
-		virtual Reminder*   createReminder(QWidget* parent);
-		static CheckBox*    createConfirmAckCheckbox(QWidget* parent);
+		virtual Reminder* createReminder(QWidget* parent);
+		static CheckBox*  createConfirmAckCheckbox(QWidget* parent);
 
 		static QString  i18n_chk_ConfirmAck();    // text of 'Confirm acknowledgement' checkbox
 
@@ -139,6 +147,10 @@
 		                    GetResourceType = RES_PROMPT);
 		EditCommandAlarmDlg(bool Template, const KAEvent*, bool newAlarm, QWidget* parent = 0,
 		                    GetResourceType = RES_PROMPT, bool readOnly = false);
+
+		// Methods to initialise values in the New Alarm dialogue.
+		// N.B. setTime() must be called first to set the date-only characteristic,
+		//      followed by setRecurrence().
 		virtual void    setAction(KAEvent::Action, const AlarmText& = AlarmText());
 
 		static QString  i18n_chk_EnterScript();        // text of 'Enter a script' checkbox
@@ -188,7 +200,14 @@
 		                  GetResourceType = RES_PROMPT);
 		EditEmailAlarmDlg(bool Template, const KAEvent*, bool newAlarm, QWidget* parent = 0,
 		                  GetResourceType = RES_PROMPT, bool readOnly = false);
+
+		// Methods to initialise values in the New Alarm dialogue.
+		// N.B. setTime() must be called first to set the date-only characteristic,
+		//      followed by setRecurrence().
 		virtual void    setAction(KAEvent::Action, const AlarmText& = AlarmText());
+		void            setEmailFields(uint fromID, const EmailAddressList&, const QString& subject,
+		                               const QStringList& attachments);
+		void            setBcc(bool);
 
 		static QString  i18n_chk_CopyEmailToSelf();    // text of 'Copy email to self' checkbox
 
@@ -212,6 +231,8 @@
 		void            slotRemoveAttachment();
 
 	private:
+		void            attachmentEnable();
+
 		// Email alarm options
 		EmailIdCombo*       mEmailFromList;
 		LineEdit*           mEmailToEdit;
Index: kalarm/recurrenceedit.h
===================================================================
--- kalarm/recurrenceedit.h	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ kalarm/recurrenceedit.h	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -1,7 +1,7 @@
 /*
  *  recurrenceedit.h  -  widget to edit the event's recurrence definition
  *  Program:  kalarm
- *  Copyright © 2002-2008 by David Jarvie <djarvie@kde.org>
+ *  Copyright © 2002-2009 by David Jarvie <djarvie@kde.org>
  *
  *  Based originally on KOrganizer module koeditorrecurrence.h,
  *  Copyright (c) 2000,2001 Cornelius Schumacher <schumacher@kde.org>
@@ -66,7 +66,9 @@
 		/** Set widgets to default values */
 		void          setDefaults(const KDateTime& from);
 		/** Initialise according to a specified event */
-		void          set(const KAEvent&, bool keepDuration);
+		void          set(const KAEvent&);
+		/** Initialise with repeat-at-login selected, instead of calling set(). */
+		void          setRepeatAtLogin();
 		/** Write recurrence settings into an event */
 		void          updateEvent(KAEvent&, bool adjustStart);
 		QWidget*      checkData(const KDateTime& startDateTime, QString& errorMessage) const;
@@ -98,6 +100,7 @@
 		void          typeChanged(int recurType);   // returns a RepeatType value
 		void          frequencyChanged();
 		void          repeatNeedsInitialisation();
+		void          contentsChanged();
 
 	protected:
 		virtual void  showEvent(QShowEvent*);
Index: kalarm/ACKNOWLEDGEMENTS
===================================================================
--- kalarm/ACKNOWLEDGEMENTS	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ kalarm/ACKNOWLEDGEMENTS	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -26,3 +26,7 @@
 Daniel Eckl for helping to fix some calendar problems in a beta issue.
 
 Olaf Schmidt for useful suggestions on improving the user interface.
+
+Karl Ove Hufthammer for suggestions on simplifying the user interface.
+
+Daniel Ramón Fernández Macia for new KAlarm icons.
Index: kalarm/traywindow.h
===================================================================
--- kalarm/traywindow.h	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ kalarm/traywindow.h	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -30,7 +30,6 @@
 class QDragEnterEvent;
 class QDropEvent;
 class KAction;
-class KMenu;
 class KAEvent;
 class MainWindow;
 class NewAlarmAction;
Index: kalarm/mainwindow.h
===================================================================
--- kalarm/mainwindow.h	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ kalarm/mainwindow.h	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -40,14 +40,12 @@
 class QResizeEvent;
 class QDropEvent;
 class QCloseEvent;
-class QModelIndex;
 class QSplitter;
 class QMenu;
 class KAction;
 class KToggleAction;
 class KToolBarPopupAction;
 class AlarmListFilterModel;
-class AlarmListDelegate;
 class AlarmListView;
 class NewAlarmAction;
 class TemplateDlg;
@@ -104,7 +102,8 @@
 		void           slotNewTemplate();
 		void           slotCopy();
 		void           slotModify();
-		void           slotDelete();
+		void           slotDeleteIf()     { slotDelete(false); }
+		void           slotDeleteForce()  { slotDelete(true); }
 		void           slotReactivate();
 		void           slotEnable();
 		void           slotToggleTrayIcon();
@@ -150,6 +149,7 @@
 		void           selectionCleared();
 		void           setEnableText(bool enable);
 		void           initUndoMenu(QMenu*, Undo::Type);
+		void           slotDelete(bool force);
 		static KAEvent::Action  getDropAction(QDropEvent*, QString& text);
 		static void    setUpdateTimer();
 		static void    enableTemplateMenuItem(bool);
@@ -177,6 +177,7 @@
 		KAction*             mActionCopy;
 		KAction*             mActionModify;
 		KAction*             mActionDelete;
+		KAction*             mActionDeleteForce;
 		KAction*             mActionReactivate;
 		KAction*             mActionEnable;
 		KAction*             mActionFindNext;
Index: kalarm/prefdlg.cpp
===================================================================
--- kalarm/prefdlg.cpp	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ kalarm/prefdlg.cpp	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -1156,7 +1156,7 @@
 	StackedWidgetT<KVBox>* topFontColour = new StackedWidgetT<KVBox>(tabgroup);
 	topFontColour->setMargin(KDialog::marginHint()/2);
 	topFontColour->setSpacing(KDialog::spacingHint());
-	tabs->addTab(topFontColour, i18nc("@title:tab", "Font & Color"));
+	tabs->addTab(topFontColour, i18nc("@title:tab", "Font && Color"));
 
 	// MISCELLANEOUS
 	// Show in KOrganizer
Index: kalarm/CMakeLists.txt
===================================================================
--- kalarm/CMakeLists.txt	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ kalarm/CMakeLists.txt	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -1,6 +1,9 @@
 project(kalarm)
 
 add_definitions(-DKDE_DEFAULT_DEBUG_AREA=5950)
+if(KMAIL_SUPPORTED)
+  add_definitions(-DKMAIL_SUPPORTED)
+endif(KMAIL_SUPPORTED)
 
 include_directories(
         ./ 
@@ -9,6 +12,7 @@
 ) 
 
 add_subdirectory( resources ) 
+add_subdirectory( appicons ) 
 add_subdirectory( pixmaps ) 
 add_subdirectory( autostart ) 
 
@@ -95,6 +99,7 @@
    resourceconfigdialog.cpp
    resourcemodelview.cpp
    resourceselector.cpp
+   commandoptions.cpp
 )
 qt4_add_dbus_adaptor(kalarm_bin_SRCS org.kde.kalarm.kalarm.xml dbushandler.h DBusHandler)
 if (KMAIL_SUPPORTED)
@@ -105,8 +110,7 @@
 kde4_add_kcfg_files(kalarm_bin_SRCS GENERATE_MOC kalarmconfig.kcfgc)
 
 #if (UNIX)
-# todo: move to Oxygen icon
-kde4_add_app_icon(kalarm_bin_SRCS "ox*-app-kalarm.png")
+kde4_add_app_icon(kalarm_bin_SRCS "${CMAKE_CURRENT_SOURCE_DIR}/appicons/ox*-app-kalarm.png")
 kde4_add_executable(kalarm_bin ${kalarm_bin_SRCS})
 if (KMAIL_SUPPORTED)
    add_dependencies(kalarm_bin kmail_xml)
@@ -114,9 +118,8 @@
 
 set_target_properties(kalarm_bin PROPERTIES OUTPUT_NAME kalarm)
 
-target_link_libraries(kalarm_bin ${KDE4_KUTILS_LIBS} kalarm_resources ${KDEPIMLIBS_KCAL_LIBS} ${KDE4_KABC_LIBRARY} ${KDE4_KMIME_LIBRARY} ${KDEPIMLIBS_KPIMIDENTITIES_LIBS} ${KDEPIMLIBS_MAILTRANSPORT_LIBS} ${KDEPIMLIBS_KHOLIDAYS_LIBS} ${KDE4_PHONON_LIBS} kdepim)
+target_link_libraries(kalarm_bin ${KDE4_KUTILS_LIBS} kalarm_resources ${KDEPIMLIBS_KCAL_LIBS} ${KDE4_KABC_LIBRARY} ${KDE4_KMIME_LIBRARY} ${KDEPIMLIBS_KPIMIDENTITIES_LIBS} ${KDEPIMLIBS_MAILTRANSPORT_LIBS} ${KDEPIMLIBS_KHOLIDAYS_LIBS} ${KDE4_PHONON_LIBS} ${X11_X11_LIB} kdepim)
 
-
 install(TARGETS kalarm_bin ${INSTALL_TARGETS_DEFAULT_ARGS} )
 #endif (UNIX)
 
@@ -129,5 +132,3 @@
 install( FILES org.kde.kalarm.kalarm.xml DESTINATION ${KDE4_DBUS_INTERFACES_DIR} )
 install( FILES kalarm.upd DESTINATION ${KCONF_UPDATE_INSTALL_DIR})
 install( PROGRAMS kalarm-version.pl kalarm-1.2.1-general.pl kalarm-1.9.5-defaults.pl kalarm-2.0.2-general.pl kalarm-2.1.5-general.pl DESTINATION ${KCONF_UPDATE_INSTALL_DIR})
-
-kde4_install_icons( ${ICON_INSTALL_DIR} )
Index: kalarm/specialactions.cpp
===================================================================
--- kalarm/specialactions.cpp	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ kalarm/specialactions.cpp	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -102,9 +102,6 @@
                                      bool cancelOnError, bool enableCancelOnError, QWidget* parent)
 	: KDialog(parent)
 {
-#ifdef __GNUC__
-#warning Dialogue appears below edit dialogue when Edit button in alarm message window is clicked
-#endif
 	setCaption(i18nc("@title:window", "Special Alarm Actions"));
 	setButtons(Ok|Cancel);
 	setDefaultButton(Ok);
Index: kalarm/recurrenceedit.cpp
===================================================================
--- kalarm/recurrenceedit.cpp	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ kalarm/recurrenceedit.cpp	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -1,7 +1,7 @@
 /*
  *  recurrenceedit.cpp  -  widget to edit the event's recurrence definition
  *  Program:  kalarm
- *  Copyright © 2002-2008 by David Jarvie <djarvie@kde.org>
+ *  Copyright © 2002-2009 by David Jarvie <djarvie@kde.org>
  *
  *  Based originally on KOrganizer module koeditorrecurrence.cpp,
  *  Copyright (c) 2000,2001 Cornelius Schumacher <schumacher@kde.org>
@@ -118,6 +118,7 @@
 	hlayout->addLayout(vlayout);
 	mRuleButtonGroup = new ButtonGroup(recurGroup);
 	connect(mRuleButtonGroup, SIGNAL(buttonSet(QAbstractButton*)), SLOT(periodClicked(QAbstractButton*)));
+	connect(mRuleButtonGroup, SIGNAL(buttonSet(QAbstractButton*)), SIGNAL(contentsChanged()));
 
 	mNoneButton = new RadioButton(i18n_combo_NoRecur(), recurGroup);
 	mNoneButton->setFixedSize(mNoneButton->sizeHint());
@@ -175,10 +176,11 @@
 	mSubRepetition = new RepetitionButton(i18nc("@action:button", "Sub-Repetition"), true, recurGroup);
 	mSubRepetition->setFixedSize(mSubRepetition->sizeHint());
 	mSubRepetition->setReadOnly(mReadOnly);
+	mSubRepetition->setWhatsThis(i18nc("@info:whatsthis",
+	                                   "Set up a repetition within the recurrence, to trigger the alarm multiple times each time the recurrence is due."));
 	connect(mSubRepetition, SIGNAL(needsInitialisation()), SIGNAL(repeatNeedsInitialisation()));
 	connect(mSubRepetition, SIGNAL(changed()), SIGNAL(frequencyChanged()));
-	mSubRepetition->setWhatsThis(i18nc("@info:whatsthis",
-	                                   "Set up a repetition within the recurrence, to trigger the alarm multiple times each time the recurrence is due."));
+	connect(mSubRepetition, SIGNAL(changed()), SIGNAL(contentsChanged()));
 	vlayout->addSpacing(KDialog::spacingHint());
 	vlayout->addWidget(mSubRepetition);
 
@@ -201,11 +203,16 @@
 	mMonthlyRule  = new MonthlyRule(mReadOnly, mRuleStack);
 	mYearlyRule   = new YearlyRule(mReadOnly, mRuleStack);
 
-	connect(mSubDailyRule, SIGNAL(frequencyChanged()), this, SIGNAL(frequencyChanged()));
-	connect(mDailyRule, SIGNAL(frequencyChanged()), this, SIGNAL(frequencyChanged()));
-	connect(mWeeklyRule, SIGNAL(frequencyChanged()), this, SIGNAL(frequencyChanged()));
-	connect(mMonthlyRule, SIGNAL(frequencyChanged()), this, SIGNAL(frequencyChanged()));
-	connect(mYearlyRule, SIGNAL(frequencyChanged()), this, SIGNAL(frequencyChanged()));
+	connect(mSubDailyRule, SIGNAL(frequencyChanged()), SIGNAL(frequencyChanged()));
+	connect(mDailyRule, SIGNAL(frequencyChanged()), SIGNAL(frequencyChanged()));
+	connect(mWeeklyRule, SIGNAL(frequencyChanged()), SIGNAL(frequencyChanged()));
+	connect(mMonthlyRule, SIGNAL(frequencyChanged()), SIGNAL(frequencyChanged()));
+	connect(mYearlyRule, SIGNAL(frequencyChanged()), SIGNAL(frequencyChanged()));
+	connect(mSubDailyRule, SIGNAL(changed()), SIGNAL(contentsChanged()));
+	connect(mDailyRule, SIGNAL(changed()), SIGNAL(contentsChanged()));
+	connect(mWeeklyRule, SIGNAL(changed()), SIGNAL(contentsChanged()));
+	connect(mMonthlyRule, SIGNAL(changed()), SIGNAL(contentsChanged()));
+	connect(mYearlyRule, SIGNAL(changed()), SIGNAL(contentsChanged()));
 
 	mRuleStack->addWidget(mNoRule);
 	mRuleStack->addWidget(mSubDailyRule);
@@ -222,6 +229,7 @@
 	topLayout->addWidget(mRangeButtonBox);
 	mRangeButtonGroup = new ButtonGroup(mRangeButtonBox);
 	connect(mRangeButtonGroup, SIGNAL(buttonSet(QAbstractButton*)), SLOT(rangeTypeClicked()));
+	connect(mRangeButtonGroup, SIGNAL(buttonSet(QAbstractButton*)), SIGNAL(contentsChanged()));
 
 	vlayout = new QVBoxLayout(mRangeButtonBox);
 	vlayout->setMargin(KDialog::marginHint());
@@ -246,8 +254,9 @@
 	mRepeatCountEntry->setSingleShiftStep(10);
 	mRepeatCountEntry->setSelectOnStep(false);
 	mRepeatCountEntry->setReadOnly(mReadOnly);
+	mRepeatCountEntry->setWhatsThis(i18nc("@info:whatsthis", "Enter the total number of times to trigger the alarm"));
 	connect(mRepeatCountEntry, SIGNAL(valueChanged(int)), SLOT(repeatCountChanged(int)));
-	mRepeatCountEntry->setWhatsThis(i18nc("@info:whatsthis", "Enter the total number of times to trigger the alarm"));
+	connect(mRepeatCountEntry, SIGNAL(valueChanged(int)), SIGNAL(contentsChanged()));
 	mRepeatCountButton->setFocusWidget(mRepeatCountEntry);
 	mRepeatCountLabel = new QLabel(i18nc("@label", "occurrence(s)"), mRangeButtonBox);
 	mRepeatCountLabel->setFixedSize(mRepeatCountLabel->sizeHint());
@@ -272,17 +281,20 @@
 	static const QString tzText = i18nc("@info/plain", "This uses the same time zone as the start time.");
 	mEndDateEdit->setWhatsThis(i18nc("@info:whatsthis",
 	      "<para>Enter the last date to repeat the alarm.</para><para>%1</para>", tzText));
+	connect(mEndDateEdit, SIGNAL(dateChanged(const QDate&)), SIGNAL(contentsChanged()));
 	mEndDateButton->setFocusWidget(mEndDateEdit);
 	mEndTimeEdit = new TimeEdit(mRangeButtonBox);
 	mEndTimeEdit->setFixedSize(mEndTimeEdit->sizeHint());
 	mEndTimeEdit->setReadOnly(mReadOnly);
 	mEndTimeEdit->setWhatsThis(i18nc("@info:whatsthis",
 	      "<para>Enter the last time to repeat the alarm.</para><para>%1</para><para>%2</para>", tzText, TimeSpinBox::shiftWhatsThis()));
+	connect(mEndTimeEdit, SIGNAL(valueChanged(int)), SIGNAL(contentsChanged()));
 	mEndAnyTimeCheckBox = new CheckBox(i18nc("@option:check", "Any time"), mRangeButtonBox);
 	mEndAnyTimeCheckBox->setFixedSize(mEndAnyTimeCheckBox->sizeHint());
 	mEndAnyTimeCheckBox->setReadOnly(mReadOnly);
+	mEndAnyTimeCheckBox->setWhatsThis(i18nc("@info:whatsthis", "Stop repeating the alarm after your first login on or after the specified end date"));
 	connect(mEndAnyTimeCheckBox, SIGNAL(toggled(bool)), SLOT(slotAnyTimeToggled(bool)));
-	mEndAnyTimeCheckBox->setWhatsThis(i18nc("@info:whatsthis", "Stop repeating the alarm after your first login on or after the specified end date"));
+	connect(mEndAnyTimeCheckBox, SIGNAL(toggled(bool)), SIGNAL(contentsChanged()));
 	hlayout->addWidget(mEndDateButton);
 	hlayout->addSpacing(KDialog::spacingHint());
 	hlayout->addWidget(mEndDateEdit);
@@ -309,8 +321,8 @@
 	hlayout->addLayout(vlayout);
 
 	mExceptionDateList = new ListWidget(mExceptionGroup);
+	mExceptionDateList->setWhatsThis(i18nc("@info:whatsthis", "The list of exceptions, i.e. dates/times excluded from the recurrence"));
 	connect(mExceptionDateList, SIGNAL(currentRowChanged(int)), SLOT(enableExceptionButtons()));
-	mExceptionDateList->setWhatsThis(i18nc("@info:whatsthis", "The list of exceptions, i.e. dates/times excluded from the recurrence"));
 	vlayout->addWidget(mExceptionDateList);
 
 	if (mReadOnly)
@@ -335,19 +347,19 @@
 		hlayout->setMargin(0);
 		vlayout->addLayout(hlayout);
 		QPushButton* button = new QPushButton(i18nc("@action:button", "Add"), mExceptionGroup);
+		button->setWhatsThis(i18nc("@info:whatsthis", "Add the date entered above to the exceptions list"));
 		connect(button, SIGNAL(clicked()), SLOT(addException()));
-		button->setWhatsThis(i18nc("@info:whatsthis", "Add the date entered above to the exceptions list"));
 		hlayout->addWidget(button);
 
 		mChangeExceptionButton = new QPushButton(i18nc("@action:button", "Change"), mExceptionGroup);
-		connect(mChangeExceptionButton, SIGNAL(clicked()), SLOT(changeException()));
 		mChangeExceptionButton->setWhatsThis(i18nc("@info:whatsthis",
 		      "Replace the currently highlighted item in the exceptions list with the date entered above"));
+		connect(mChangeExceptionButton, SIGNAL(clicked()), SLOT(changeException()));
 		hlayout->addWidget(mChangeExceptionButton);
 
 		mDeleteExceptionButton = new QPushButton(i18nc("@action:button", "Delete"), mExceptionGroup);
+		mDeleteExceptionButton->setWhatsThis(i18nc("@info:whatsthis", "Remove the currently highlighted item from the exceptions list"));
 		connect(mDeleteExceptionButton, SIGNAL(clicked()), SLOT(deleteException()));
-		mDeleteExceptionButton->setWhatsThis(i18nc("@info:whatsthis", "Remove the currently highlighted item from the exceptions list"));
 		hlayout->addWidget(mDeleteExceptionButton);
 	}
 
@@ -358,6 +370,7 @@
 	mExcludeHolidays->setWhatsThis(i18nc("@info:whatsthis",
 	      "<para>Do not trigger the alarm on holidays.</para>"
 	      "<para>You can specify your holiday region in the Configuration dialog.</para>"));
+	connect(mExcludeHolidays, SIGNAL(toggled(bool)), SIGNAL(contentsChanged()));
 	vlayout->addWidget(mExcludeHolidays);
 
 	mWorkTimeOnly = new CheckBox(i18nc("@option:check", "Only during working time"), mExceptionGroup);
@@ -365,6 +378,7 @@
 	mWorkTimeOnly->setWhatsThis(i18nc("@info:whatsthis",
 	      "<para>Only execute the alarm during working hours, on working days.</para>"
 	      "<para>You can specify working days and hours in the Configuration dialog.</para>"));
+	connect(mWorkTimeOnly, SIGNAL(toggled(bool)), SIGNAL(contentsChanged()));
 	vlayout->addWidget(mWorkTimeOnly);
 
 	topLayout->addStretch();
@@ -600,6 +614,7 @@
 	{
 		mExceptionDates.insert(it, date);
 		mExceptionDateList->insertItem(index, new QListWidgetItem(KGlobal::locale()->formatDate(date)));
+		emit contentsChanged();
 	}
 	mExceptionDateList->setCurrentItem(mExceptionDateList->item(index));
 	enableExceptionButtons();
@@ -623,6 +638,7 @@
 		{
 			mExceptionDates.removeAt(index);
 			mExceptionDateList->takeItem(index);
+			emit contentsChanged();
 			addException();
 		}
 	}
@@ -639,6 +655,7 @@
 		int index = mExceptionDateList->row(item);
 		mExceptionDates.removeAt(index);
 		mExceptionDateList->takeItem(index);
+		emit contentsChanged();
 		enableExceptionButtons();
 	}
 }
@@ -771,11 +788,19 @@
 }
 
 /******************************************************************************
+* Initialise the recurrence to select repeat-at-login.
+* This function and set() are mutually exclusive: call one or the other, not both.
+*/
+void RecurrenceEdit::setRepeatAtLogin()
+{
+	mAtLoginButton->setChecked(true);
+	mEndDateButton->setChecked(true);
+}
+
+/******************************************************************************
 * Set the state of all controls to reflect the data in the specified event.
-* Set 'keepDuration' true to prevent the recurrence count being adjusted to the
-* remaining number of recurrences.
 */
-void RecurrenceEdit::set(const KAEvent& event, bool keepDuration)
+void RecurrenceEdit::set(const KAEvent& event)
 {
 	setDefaults(event.mainDateTime().kDateTime());
 	if (event.repeatAtLogin())
@@ -1109,6 +1134,7 @@
 		mIntSpinBox->setReadOnly(readOnly);
 	}
 	connect(mSpinBox, SIGNAL(valueChanged(int)), SIGNAL(frequencyChanged()));
+	connect(mSpinBox, SIGNAL(valueChanged(int)), SIGNAL(changed()));
 	label->setBuddy(mSpinBox);
 	label = new QLabel(freqText, box);
 	label->setFixedSize(label->sizeHint());
@@ -1199,6 +1225,7 @@
 		mDayBox[i] = new CheckBox(calendar->weekDayName(day), box);
 		mDayBox[i]->setFixedSize(mDayBox[i]->sizeHint());
 		mDayBox[i]->setReadOnly(readOnly);
+		connect(mDayBox[i], SIGNAL(toggled(bool)), SIGNAL(changed()));
 		dgrid->addWidget(mDayBox[i], i%4, i/4, Qt::AlignLeft);
 	}
 	box->setFixedSize(box->sizeHint());
@@ -1345,6 +1372,7 @@
 	mDayCombo->setWhatsThis(i18nc("@info:whatsthis", "Select the day of the month on which to repeat the alarm"));
 	mDayButton->setFocusWidget(mDayCombo);
 	connect(mDayCombo, SIGNAL(activated(int)), SLOT(slotDaySelected(int)));
+	connect(mDayCombo, SIGNAL(currentIndexChanged(int)), SIGNAL(changed()));
 
 	box->setStretchFactor(new QWidget(box), 1);    // left adjust the controls
 	box->setFixedHeight(box->sizeHint().height());
@@ -1382,6 +1410,7 @@
 	mWeekCombo->setFixedSize(mWeekCombo->sizeHint());
 	mWeekCombo->setReadOnly(readOnly);
 	mPosButton->setFocusWidget(mWeekCombo);
+	connect(mWeekCombo, SIGNAL(currentIndexChanged(int)), SIGNAL(changed()));
 
 	mDayOfWeekCombo = new ComboBox(box);
 	mDayOfWeekCombo->setEditable(false);
@@ -1393,10 +1422,12 @@
 	}
 	mDayOfWeekCombo->setReadOnly(readOnly);
 	mDayOfWeekCombo->setWhatsThis(i18nc("@info:whatsthis", "Select the day of the week on which to repeat the alarm"));
+	connect(mDayOfWeekCombo, SIGNAL(currentIndexChanged(int)), SIGNAL(changed()));
 
 	box->setStretchFactor(new QWidget(box), 1);    // left adjust the controls
 	box->setFixedHeight(box->sizeHint().height());
 	connect(mButtonGroup, SIGNAL(buttonSet(QAbstractButton*)), SLOT(clicked(QAbstractButton*)));
+	connect(mButtonGroup, SIGNAL(buttonSet(QAbstractButton*)), SIGNAL(changed()));
 }
 
 MonthYearRule::DayPosType MonthYearRule::type() const
@@ -1550,6 +1581,7 @@
 		mMonthBox[i] = new CheckBox(calendar->monthName(i + 1, year, KCalendarSystem::ShortName), w);
 		mMonthBox[i]->setFixedSize(mMonthBox[i]->sizeHint());
 		mMonthBox[i]->setReadOnly(readOnly);
+		connect(mMonthBox[i], SIGNAL(toggled(bool)), SIGNAL(changed()));
 		grid->addWidget(mMonthBox[i], i%3, i/3, Qt::AlignLeft);
 	}
 	connect(mMonthBox[1], SIGNAL(toggled(bool)), SLOT(enableFeb29()));
@@ -1572,6 +1604,7 @@
 	mFeb29Combo->addItem(i18nc("@item:inlistbox 28th February (short form)", "28 Feb"));
 	mFeb29Combo->setFixedSize(mFeb29Combo->sizeHint());
 	mFeb29Combo->setReadOnly(readOnly);
+	connect(mFeb29Combo, SIGNAL(currentIndexChanged(int)), SIGNAL(changed()));
 	mFeb29Label->setBuddy(mFeb29Combo);
 	box->setFixedSize(box->sizeHint());
 	box->setWhatsThis(i18nc("@info:whatsthis", "Select which date, if any, the February 29th alarm should trigger in non-leap years"));
Index: kaddressbook/dbusaddressbook.desktop
===================================================================
--- kaddressbook/dbusaddressbook.desktop	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ kaddressbook/dbusaddressbook.desktop	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -18,6 +18,7 @@
 Comment[ga]=Leabhar Seoltaí le comhéadan D-Bus
 Comment[gl]=Caderno de enderezos cunha interface D-Bus
 Comment[hu]=Címjegyzék D-Bus-felülettel
+Comment[is]=Vistfangaskrá með D-Bus tengingu
 Comment[it]=Rubrica indirizzi con un'interfaccia D-Bus
 Comment[ja]=D-Bus インターフェースを持つアドレス帳
 Comment[kk]=D-Bus интерфейсті адрестік кітапшасы
Index: kaddressbook/csv-templates/yahoo.desktop
===================================================================
--- kaddressbook/csv-templates/yahoo.desktop	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ kaddressbook/csv-templates/yahoo.desktop	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -18,6 +18,7 @@
 Name[fr]=Carnet d'adresses Yahoo!
 Name[ga]=Leabhar Seoltaí Yahoo!
 Name[gl]=Caderno de enderezos de Yahoo!
+Name[is]=Yahoo! vistfangaskrá
 Name[it]=Rubrica indirizzi Yahoo!
 Name[ja]=Yahoo! アドレス帳
 Name[km]=សៀវភៅ​អាសយដ្ឋាន Yahoo!
Index: kaddressbook/xxport/gmx_xxport.desktop
===================================================================
--- kaddressbook/xxport/gmx_xxport.desktop	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ kaddressbook/xxport/gmx_xxport.desktop	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -16,6 +16,7 @@
 Name[ga]=Breiseán Iompórtála/Easpórtála GMX le haghaidh KAB
 Name[gl]=Engadido KAB GMX XXPort 
 Name[hu]=KAB GMX XXPort bővítmény
+Name[is]=Íforrit fyrir KAB GMX XXPort
 Name[it]=Estensione XXPort di KAB per GMX
 Name[ja]=KAB GMX XXPort プラグイン
 Name[kk]=GMX-қа экспорт/импорт ету
@@ -51,6 +52,7 @@
 Comment[fr]=Module d'import / export de contacts au format GMX
 Comment[ga]=Breiseán a iompórtálann agus easpórtálann teagmhálacha i bhformáid leabhair seoltaí GMX
 Comment[gl]=Engadido para importar e exportar contactos en formato de caderno de enderezos GMX
+Comment[is]=Íforrit til að flytja inn eða út tengiliði í GMX sniði
 Comment[it]=Estensione per importare ed esportare contatti nel formato della rubrica di GMX
 Comment[ja]=GMX アドレス帳のフォーマットで連絡先をインポート/エクスポートするプラグイン
 Comment[km]=កម្មវិធីជំនួយ​ដែល​ត្រូវ​នាំចូល និង​នាំចេញ​ទំនាក់ទំនង​នៅ​ក្នុង​ទ្រង់ទ្រាយ​សៀវភៅ​អាសយដ្ឋានរបស់ GMX
Index: kaddressbook/xxport/pab_xxport.desktop
===================================================================
--- kaddressbook/xxport/pab_xxport.desktop	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ kaddressbook/xxport/pab_xxport.desktop	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -10,6 +10,7 @@
 Name[et]=KAB MS Exchange personaalse aadressiraamatu import/eksportplugin
 Name[fr]=Module d'import / export de carnet d'adresses personnel MS Exchange pour KAB
 Name[gl]=Engadido XXPort do caderno de enderezos de MS Exchange para KAB
+Name[is]=Íforrit fyrir KAB MS Exchange Personal Addressbook XXPort
 Name[it]=Estensione XXPort di KAB per rubrica personale MS Exchange
 Name[ja]=KAB MS Exchange パーソナルアドレス帳インポート/エクスポートプラグイン
 Name[km]=កម្មវិធី​ជំនួយ KAB MS Exchange Personal Address Book XXPort
Index: kaddressbook/xxport/gnokii_xxport.desktop
===================================================================
--- kaddressbook/xxport/gnokii_xxport.desktop	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ kaddressbook/xxport/gnokii_xxport.desktop	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -61,6 +61,7 @@
 Comment[fr]=Module de téléphone portable pour importer et exporter des entrées du carnet d'adresses
 Comment[ga]=Breiseán fóin póca a iompórtálann agus easpórtálann teagmhálacha Eudora
 Comment[gl]=Engadido de teléfono móbil para importar e exportar entradas do caderno de enderezos
+Comment[is]=Íforrit til að færa tengilið milli póstfangaskrár og farsíma
 Comment[it]=Estensione per importare ed esportare voci della rubrica di un telefono cellulare
 Comment[ja]=アドレス帳のエントリをインポート/エクスポートする携帯電話用プラグイン
 Comment[km]=កម្មវិធី​ជំនួយ​ទូរស័ព្ទ​ចល័ត ដែល​ត្រូវ​នាំចូល និង​នាំចេញ​ធាតុ​សៀវភៅ​អាសយដ្ឋាន
Index: plugins/kmail/bodypartformatter/text_xdiff.desktop
===================================================================
--- plugins/kmail/bodypartformatter/text_xdiff.desktop	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ plugins/kmail/bodypartformatter/text_xdiff.desktop	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -48,6 +48,7 @@
 Comment[fr]=Module de mise en forme du corps du message pour text/x-patch
 Comment[gl]=Un engadido para formatar o corpo do texto/x-patch
 Comment[hu]=Formázómodul text/x-patch adatok kezeléséhez
+Comment[is]=Sniðmátstól fyrir text/x-patch
 Comment[it]=Un'estensione per la formattazione di text/x-patch nei messaggi di posta
 Comment[ja]=text/x-patch 用のメッセージ本体フォーマッタ
 Comment[kk]=Text/x-diff бөлімін пішімдеу модулі
Index: plugins/kmail/bodypartformatter/text_calendar.cpp
===================================================================
--- plugins/kmail/bodypartformatter/text_calendar.cpp	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ plugins/kmail/bodypartformatter/text_calendar.cpp	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -306,6 +306,13 @@
           break;
       }
 
+      // Set the organizer to the sender, if the ORGANIZER hasn't been set.
+      if ( incidence->organizer().isEmpty() ) {
+        QString tname, temail;
+        KPIMUtils::extractEmailAddressAndName( callback.sender(), temail, tname );
+        incidence->setOrganizer( Person( tname, temail ) );
+      }
+
       QString recv = to;
       if ( recv.isEmpty() )
         recv = incidence->organizer().fullName();
@@ -324,10 +331,12 @@
         if ( iface.isValid() ) {
           iface.call( "newInstance" );
           QDBusReply<bool> r = iface.call( "load" );
-          if ( !r.isValid() || !r.value() )
+          if ( !r.isValid() || !r.value() ) {
             kWarning() << "Loading korganizer failed: " << iface.lastError().message();
-        } else
+          }
+        } else {
           kWarning() << "Couldn't obtain korganizer D-Bus interface" << iface.lastError().message();
+        }
 
         // We don't do anything with it, we just need it to be running so that it handles
         // the incoming directory.
@@ -675,19 +684,20 @@
   public:
     const KMail::Interface::BodyPartFormatter *bodyPartFormatter( int idx ) const
     {
-      if ( idx == 0 ) return new Formatter();
+      if ( idx == 0 || idx == 1 ) return new Formatter();
       else return 0;
     }
 
     const char *type( int idx ) const
     {
-      if ( idx == 0 ) return "text";
+      if ( idx == 0 || idx == 1 ) return "text";
       else return 0;
     }
 
     const char *subtype( int idx ) const
     {
       if ( idx == 0 ) return "calendar";
+      if ( idx == 1 ) return "x-vcalendar";
       else return 0;
     }
 
Index: ktimetracker/ktimetracker_config_storage.desktop
===================================================================
--- ktimetracker/ktimetracker_config_storage.desktop	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ ktimetracker/ktimetracker_config_storage.desktop	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -54,6 +54,7 @@
 Comment[fr]=Configuration du stockage
 Comment[ga]=Cumraigh Stóras
 Comment[gl]=Configurar o almacenamento
+Comment[is]=Stilla geymslumiðla
 Comment[it]=Configura la memorizzazione
 Comment[km]=កំណត់​រចនា​សម្ព័ន្ធ​ឧបករណ៍​ផ្ទុក
 Comment[lv]=Konfigurēt glabāšanu
Index: libkdepim/kmeditor.cpp
===================================================================
--- libkdepim/kmeditor.cpp	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ libkdepim/kmeditor.cpp	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -139,7 +139,7 @@
   }
 
   mExtEditorTempFile->write( q->textOrHtml().toUtf8() );
-  mExtEditorTempFile->flush();
+  mExtEditorTempFile->close();
 
   mExtEditorProcess = new KProcess();
     // construct command line...
@@ -171,10 +171,15 @@
 void KMeditorPrivate::slotEditorFinished(int, QProcess::ExitStatus exitStatus)
 {
   if ( exitStatus == QProcess::NormalExit ) {
-    mExtEditorTempFile->flush();
-    mExtEditorTempFile->seek( 0 );
-    QByteArray f = mExtEditorTempFile->readAll();
-    q->setTextOrHtml( QString::fromUtf8( f.data(), f.size() ) );
+    // the external editor could have renamed the original file and recreated a new file
+    // with the given filename, so we need to reopen the file after the editor exited
+    QFile localFile(mExtEditorTempFile->fileName());
+    if ( localFile.open(QIODevice::ReadOnly | QIODevice::Text) ) {
+      QByteArray f = localFile.readAll();
+      q->setTextOrHtml( QString::fromUtf8( f.data(), f.size() ) );
+      q->document()->setModified( true );
+      localFile.close();
+    }
   }
 
   q->killExternalEditor();   // cleanup...
@@ -188,7 +193,15 @@
 
 void KMeditor::keyPressEvent ( QKeyEvent * e )
 {
-  if ( d->useExtEditor ) {
+  if ( d->useExtEditor &&
+       ( e->key() != Qt::Key_Shift ) &&
+       ( e->key() != Qt::Key_Control ) &&
+       ( e->key() != Qt::Key_Meta ) &&
+       ( e->key() != Qt::Key_CapsLock ) &&
+       ( e->key() != Qt::Key_NumLock ) &&
+       ( e->key() != Qt::Key_ScrollLock ) &&
+       ( e->key() != Qt::Key_Alt ) &&
+       ( e->key() != Qt::Key_AltGr ) ) {
     if ( !d->mExtEditorProcess ) {
       d->startExternalEditor();
     }
Index: libkdepim/ksubscription.cpp
===================================================================
--- libkdepim/ksubscription.cpp	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ libkdepim/ksubscription.cpp	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -210,6 +210,7 @@
   : KDialog( parent ),
     mAcct( acct )
 {
+  KGlobal::locale()->insertCatalog("libkdepim");
   setCaption( caption );
   setButtons( buttons | Help | Ok | Cancel );
   setDefaultButton( Ok );
Index: libkdepim/kwidgetlister.cpp
===================================================================
--- libkdepim/kwidgetlister.cpp	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ libkdepim/kwidgetlister.cpp	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -65,11 +65,11 @@
   mLayout->addWidget( mButtonBox );
 
   mBtnMore = new KPushButton( KGuiItem( i18nc( "more widgets", "More" ),
-                                        "button_more" ), mButtonBox );
+                                        "list-add" ), mButtonBox );
   mButtonBox->setStretchFactor( mBtnMore, 0 );
 
   mBtnFewer = new KPushButton( KGuiItem( i18nc( "fewer widgets", "Fewer" ),
-                                         "button_fewer" ), mButtonBox );
+                                         "list-remove" ), mButtonBox );
   mButtonBox->setStretchFactor( mBtnFewer, 0 );
 
   QWidget *spacer = new QWidget( mButtonBox );
Index: knotes/knote.cpp
===================================================================
--- knotes/knote.cpp	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ knotes/knote.cpp	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -1049,7 +1049,6 @@
 {
   if ( hasFocus() )
   {
-    m_button->show();
 
     if ( !m_editor->isReadOnly() )
     {
@@ -1072,7 +1071,6 @@
   }
   else
   {
-    m_button->hide();
     m_grip->hide();
 
     if ( m_tool && !m_tool->isHidden() )
Index: kontact/plugins/akregator/akregator_plugin.cpp
===================================================================
--- kontact/plugins/akregator/akregator_plugin.cpp	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ kontact/plugins/akregator/akregator_plugin.cpp	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -157,6 +157,7 @@
   org::kde::akregator::part akregator(
     "org.kde.akregator", "/Akregator", QDBusConnection::sessionBus() );
   akregator.openStandardFeedList();
+  akregator.handleCommandLine();
 
   return Kontact::UniqueAppHandler::newInstance();
 }
Index: akonadi/plugins/akonadi_serializer_addressee.desktop
===================================================================
--- akonadi/plugins/akonadi_serializer_addressee.desktop	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ akonadi/plugins/akonadi_serializer_addressee.desktop	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -61,6 +61,7 @@
 Comment[pl]=Wtyczka serializowania do Akonadi dla obiektów adresata
 Comment[pt]=Um 'plugin' de serialização do Akonadi para os objectos endereçados
 Comment[pt_BR]=Um plug-in de serialização do Akonadi para os objetos dos destinatários
+Comment[ro]=Modul de serializare Akonadi pentru obiecte „destinatar”
 Comment[ru]=Модуль сохранения контактов для Akonadi
 Comment[sv]=Ett insticksprogram till Akonadi för serialisering av adressatobjekt
 Comment[tr]=Adres nesneleri için bir Akonadi sıralandırıcısı
Index: akonadi/plugins/akonadi_serializer_bookmark.desktop
===================================================================
--- akonadi/plugins/akonadi_serializer_bookmark.desktop	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ akonadi/plugins/akonadi_serializer_bookmark.desktop	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -59,7 +59,7 @@
 Comment[pl]=Wtyczka Akonadi do serializowania dla obiektów zakładek
 Comment[pt]=Um 'plugin' de serialização do Akonadi para os objectos de favoritos
 Comment[pt_BR]=Um plug-in de serialização do Akonadi para os objetos dos favoritos
-Comment[ro]=Modul de serializare Akonadi pentru obiecte semn de carte
+Comment[ro]=Modul de serializare Akonadi pentru obiecte „semn de carte”
 Comment[ru]=Модуль сохранения закладок для Akonadi
 Comment[sv]=Ett insticksprogram till Akonadi för serialisering av bokmärkesobjekt
 Comment[tr]=Yer imi nesneleri için bir Akonadi sıralandırıcısı
Index: akonadi/plugins/akonadi_serializer_contactgroup.desktop
===================================================================
--- akonadi/plugins/akonadi_serializer_contactgroup.desktop	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ akonadi/plugins/akonadi_serializer_contactgroup.desktop	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -59,6 +59,7 @@
 Comment[pl]=Wtyczka Akonadi do serializowania wizytówek
 Comment[pt]=Um 'plugin' de serialização do Akonadi para os objectos de grupos de contactos
 Comment[pt_BR]=Um plug-in de serialização do Akonadi para os objetos de grupos de contatos
+Comment[ro]=Modul de serializare Akonadi pentru obiecte „grup de contacte”
 Comment[ru]=Модуль сохранения групп контактов для Akonadi
 Comment[sv]=Ett insticksprogram till Akonadi för serialisering av kontaktgruppobjekt
 Comment[tr]=Kişi grubu nesneleri için bir Akonadi sıralandırıcısı
Index: akonadi/plugins/akonadi_serializer_kcal.desktop
===================================================================
--- akonadi/plugins/akonadi_serializer_kcal.desktop	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ akonadi/plugins/akonadi_serializer_kcal.desktop	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -28,7 +28,7 @@
 Name[ro]=Serializator incidență
 Name[ru]=Сохранение событий
 Name[sv]=Förekomstserialisering
-Name[tr]=Tekrar Sıralandırıcısı
+Name[tr]=Olay Sıralandırıcısı
 Name[uk]=Серіалізатор подій
 Name[x-test]=xxIncidence Serializerxx
 Name[zh_CN]=事件序列转换器
Index: akonadi/plugins/akonadi_serializer_microblog.desktop
===================================================================
--- akonadi/plugins/akonadi_serializer_microblog.desktop	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ akonadi/plugins/akonadi_serializer_microblog.desktop	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -21,6 +21,7 @@
 Name[pl]=Serializacja mikrobloga
 Name[pt]=Serializador do Micro-blog
 Name[pt_BR]=Serializador de microblog
+Name[ro]=Serializator de microbloguri
 Name[ru]=Сохранение записей микроблога
 Name[sv]=Serialisering av mikrowebbjournal
 Name[tr]=Mini Günlük Sıralandırıcı
@@ -51,6 +52,7 @@
 Comment[pl]=Wtyczka Akonadi do serializacji mikrobloga
 Comment[pt]=Um 'plugin' de serialização do Akonadi para o Micro-blog
 Comment[pt_BR]=Um plug-in de serialização do Akonadi para microblog
+Comment[ro]=Modul de serializare Akonadi pentru Microblog
 Comment[ru]=Модуль сохранения записей микроблога для Akonadi
 Comment[sv]=Ett insticksprogram till Akonadi för serialisering av mikrowebbjournaler
 Comment[tr]=Mini günlükler için bir Akonadi sıralandırıcı
Index: akonadi/agents/nepomuk_email_feeder/nepomukemailfeeder.desktop
===================================================================
--- akonadi/agents/nepomuk_email_feeder/nepomukemailfeeder.desktop	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ akonadi/agents/nepomuk_email_feeder/nepomukemailfeeder.desktop	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -25,6 +25,7 @@
 Name[pl]=Obsługa e-maili dla Nepomuka
 Name[pt]=Alimentação de E-Mail do Nepomuk
 Name[pt_BR]=Alimentador de e-mail do Nepomuk
+Name[ro]=Alimentare Nepomuk cu poștă
 Name[ru]=Добавление писем в Nepomuk
 Name[sl]=Podajalnik epošte za Nepomuk
 Name[sv]=E-postinmatning till Nepomuk
@@ -56,6 +57,7 @@
 Comment[pl]=Rozszerzenie do wysyłania e-maili do Nepomuka
 Comment[pt]=Extensão para enviar mensagens de e-mail para o Nepomuk
 Comment[pt_BR]=Extensão para enviar e-mails para o Nepomuk
+Comment[ro]=Extensie de împins scrisori în Nepomuk
 Comment[ru]=Расширение добавления писем в Nepomuk
 Comment[sl]=Razširitev, ki posreduje e-pošto v Nepomuk
 Comment[sv]=Utökning för att skicka e-postadresser till Nepomuk
Index: akonadi/agents/nepomuk_contact_feeder/nepomukcontactfeeder.desktop
===================================================================
--- akonadi/agents/nepomuk_contact_feeder/nepomukcontactfeeder.desktop	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ akonadi/agents/nepomuk_contact_feeder/nepomukcontactfeeder.desktop	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -25,6 +25,7 @@
 Name[pl]=Obsługa wizytówek dla Nepomuka
 Name[pt]=Alimentação de Contactos para o Nepomuk
 Name[pt_BR]=Alimentador de contatos para o Nepomuk
+Name[ro]=Alimentare Nepomuk cu fluxuri
 Name[ru]=Добавление контактов в Nepomuk
 Name[sl]=Podajalnik stikov za Nepomuk
 Name[sv]=Kontaktinmatning till Nepomuk
@@ -56,6 +57,7 @@
 Comment[pl]=Rozszerzenie do wysyłania wizytówek do Nepomuka
 Comment[pt]=Extensão para enviar contactos para o Nepomuk
 Comment[pt_BR]=Extensão para enviar contatos para o Nepomuk
+Comment[ro]=Extensie de împins contacte în Nepomuk
 Comment[ru]=Расширение добавления контактов в Nepomuk
 Comment[sl]=Razširitev, ki posreduje stike v Nepomuk
 Comment[sv]=Utökning för att skicka kontakter till Nepomuk
Index: akonadi/kresources/kabc/akonadi.desktop
===================================================================
--- akonadi/kresources/kabc/akonadi.desktop	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ akonadi/kresources/kabc/akonadi.desktop	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -58,6 +58,7 @@
 Comment[pl]=Zapewnia dostęp do wizytówek przechowywanych w katalogach książki adresowej Akonadi
 Comment[pt]=Oferece o acesso aos contactos guardados nas pastas do livro de endereços do Akonadi
 Comment[pt_BR]=Fornece acesso aos contatos armazenados nas pastas do livro de endereços do Akonadi
+Comment[ro]=Oferă acces la contactele stocate în dosarele cărții de adrese Akonadi
 Comment[ru]=Доступ к папкам адресных книг Akonadi
 Comment[sl]=Omogoča dostop do stikov, shranjenih v Akonadijevih mapah z adresarji
 Comment[sv]=Ger tillgång till kontakter lagrade i Akonadi adressbokskataloger
Index: akonadi/kresources/kcal/akonadi.desktop
===================================================================
--- akonadi/kresources/kcal/akonadi.desktop	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ akonadi/kresources/kcal/akonadi.desktop	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -28,6 +28,7 @@
 Comment[pl]=Zapewnia dostęp do kalendarzy przechowywanych w katalogach kalendarzy Akonadi
 Comment[pt]=Oferece o acesso aos calendários guardados nas pastas de calendários do Akonadi
 Comment[pt_BR]=Fornece acesso aos calendários armazenados nas pastas de calendários do Akonadi
+Comment[ro]=Oferă acces la calendarele stocate în dosarele de calendar Akonadi
 Comment[ru]=Доступ к папкам календарей Akonadi
 Comment[sl]=Omogoča dostop do koledarjev, shranjenih v Akonadijevih mapah s koledarji
 Comment[sv]=Ger tillgång till kalendrar lagrade i Akonadi-kalenderkataloger
Index: akonadi/clients/akonablog/CMakeLists.txt
===================================================================
--- akonadi/clients/akonablog/CMakeLists.txt	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ akonadi/clients/akonablog/CMakeLists.txt	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -1,3 +1,5 @@
+include_directories( ${QT_QTWEBKIT_INCLUDE_DIR} )
+
 set(akonablog_bin_SRCS
     main.cpp
     mainwidget.cpp
Index: akonadi/libkdepim-copy/ksubscription.cpp
===================================================================
--- akonadi/libkdepim-copy/ksubscription.cpp	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ akonadi/libkdepim-copy/ksubscription.cpp	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -210,6 +210,8 @@
   : KDialog( parent ),
     mAcct( acct )
 {
+  KGlobal::locale()->insertCatalog("libkdepim");
+
   setCaption( caption );
   setButtons( buttons | Help | Ok | Cancel );
   setDefaultButton( Ok );
Index: akonadi/kcm/kcm_akonadi.desktop
===================================================================
--- akonadi/kcm/kcm_akonadi.desktop	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ akonadi/kcm/kcm_akonadi.desktop	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -19,6 +19,7 @@
 Name[cs]=Nastavení Akonadi
 Name[da]=Konfiguration af Akonadi
 Name[de]=Akonadi-Einrichtung
+Name[el]=Ρυθμίσεις του Akonadi
 Name[es]=Configuración de Akonadi
 Name[et]=Akonadi seadistused
 Name[fr]=Configuration d'Akonadi
@@ -34,6 +35,7 @@
 Name[pl]=Konfiguracja Akonadi
 Name[pt]=Configuração do Akonadi
 Name[pt_BR]=Configuração do Akonadi
+Name[ro]=Configurare Akonadi
 Name[ru]=Настройка Akonadi
 Name[sv]=Inställning av Akonadi
 Name[tr]=Akonadi Yapılandırması
@@ -66,6 +68,7 @@
 Comment[pl]=Konfiguracja Akonadi - systemu zarządzania informacją osobistą
 Comment[pt]=Configuração da plataforma de Gestão de Informação Pessoal do Akonadi
 Comment[pt_BR]=Configuração da plataforma do gerenciador de informações pessoais do Akonadi
+Comment[ro]=Configurarea platformei de gestiune a informațiilor personale Akonadi
 Comment[ru]=Настройка инфраструктуры персональных данных Akonadi
 Comment[sl]=Nastavitev ogrodja Akonadi za upravljanje z osebnimi podatki
 Comment[sv]=Inställning av Akonadi: Ramverk för personlig informationshantering
Index: akonadi/resources/nntp/nntpresource.desktop
===================================================================
--- akonadi/resources/nntp/nntpresource.desktop	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ akonadi/resources/nntp/nntpresource.desktop	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -11,6 +11,7 @@
 Name[fr]=Forum de discussion usenet (NNTP)
 Name[gl]=Grupos de noticias da Usenet (NNTP)
 Name[hu]=Usenet-hírcsoportok (NNTP)
+Name[is]=Usenet fréttahópar (NNTP)
 Name[it]=Gruppi di discussione Usenet (NNTP)
 Name[ja]=Usenet ニュースグループ (NNTP)
 Name[ko]=유즈넷 뉴스그룹 (NNTP)
Index: akonadi/resources/birthdays/birthdaysresource.desktop
===================================================================
--- akonadi/resources/birthdays/birthdaysresource.desktop	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ akonadi/resources/birthdays/birthdaysresource.desktop	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -9,6 +9,7 @@
 Name[et]=Sünni- ja aastapäevad
 Name[fr]=Anniversaires et fêtes
 Name[gl]=Cumpreanos e aniversarios
+Name[is]=Afmælis- & merkisdagar
 Name[it]=Compleanni e anniversari
 Name[ja]=誕生日と記念日
 Name[km]=បុណ្យ​ខួប និង​បុណ្យ​ខួប​កំណើត
@@ -21,6 +22,7 @@
 Name[pl]=Urodziny i rocznice
 Name[pt]=Datas de Nascimento & Aniversários
 Name[pt_BR]=Aniversários e aniversários de casamento
+Name[ro]=Zile de naștere și aniversări
 Name[ru]=Праздники
 Name[sv]=Födelsedagar och årsdagar
 Name[tr]=Doğumgünleri & Yıldönümleri
@@ -61,5 +63,5 @@
 Icon=preferences-web-browser-cookies
 
 X-Akonadi-MimeTypes=text/calendar,application/x-vnd.akonadi.calendar.event
-X-Akonadi-Capabilities=Resource,Unique
+X-Akonadi-Capabilities=Resource
 X-Akonadi-Identifier=akonadi_birthdays_resource
Index: akonadi/resources/kolabproxy/incidencehandler.cpp
===================================================================
--- akonadi/resources/kolabproxy/incidencehandler.cpp	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ akonadi/resources/kolabproxy/incidencehandler.cpp	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -29,6 +29,7 @@
 #include <kmime/kmime_codecs.h>
 #include <kcal/comparisonvisitor.h>
 #include <kcal/calformat.h>
+#include <kcal/kcalmimetypevisitor.h>
 #include <libkdepim-copy/kincidencechooser.h>
 #include <KLocale>
 
@@ -60,6 +61,8 @@
     KCal::Incidence *inc = incidenceFromKolab(payload);
     kDebug() << "KCal::Incidence " << inc;
     if (inc) {
+      Akonadi::KCalMimeTypeVisitor visitor;
+      inc->accept( visitor );
       IncidencePtr incidencePtr(inc);
       if (m_uidMap.contains(incidencePtr->uid())) {
         ConflictResolution res = resolveConflict(incidencePtr);
@@ -75,7 +78,7 @@
         } else if (res == Both) {
           incidencePtr->setSummary( i18n("Copy of: %1", incidencePtr->summary() ) );
           incidencePtr->setUid( KCal::CalFormat::createUniqueId() );
-          Akonadi::Item copiedItem("text/calendar");
+          Akonadi::Item copiedItem( visitor.mimeType() );
           incidenceToItem(incidencePtr, copiedItem);
           Akonadi::ItemFetchJob *job = new Akonadi::ItemFetchJob( item );
           job->fetchScope().fetchFullPayload();
@@ -86,7 +89,7 @@
       }
       m_uidMap[incidencePtr->uid()] = StoredItem(item.id(), incidencePtr);
       kDebug() << "Add to uidMap: " << incidencePtr->uid() << item.id() << incidencePtr;
-      Akonadi::Item newItem("text/calendar");
+      Akonadi::Item newItem( visitor.mimeType() );
       newItem.setPayload(incidencePtr);
       newItem.setRemoteId(QString::number(item.id()));
       newItems << newItem;
Index: akonadi/resources/kolabproxy/kolabproxyresource.desktop
===================================================================
--- akonadi/resources/kolabproxy/kolabproxyresource.desktop	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ akonadi/resources/kolabproxy/kolabproxyresource.desktop	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -4,6 +4,7 @@
 Name[ca]=Recurs Kolab Proxy de l'Akonadi
 Name[da]=Akonadi Kolab-proxy-ressource
 Name[de]=Akonadi-Proxy-Ressource für Kolab
+Name[el]=Πόρος διαμεσολαβητή του Akonadi Kolab 
 Name[es]=Recurso proxy Kolab de Akonadi
 Name[et]=Akonadi Kolabi puhverserveri ressurss
 Name[fr]=Ressource mandaire Kolab Akonadi
@@ -29,6 +30,7 @@
 Comment[ca]=Recurs proxy per controlar carpetes de groupware.
 Comment[da]=Proxy-ressource til overvågning af groupware-mapper.
 Comment[de]=Proxy-Ressource zur Überwachung von Arbeitsgruppen-Ordnern.
+Comment[el]=Πόρος διαμεσολαβητή για την παρακολούθηση των φακέλων groupware.
 Comment[es]=Recurso de proxy para seguimiento de carpetas groupware.
 Comment[et]=Puhverserveri ressurss grupitöö kaustade jälgimiseks
 Comment[fr]=Ressource mandataire permettant de surveiller les dossiers de travail collaboratif
Index: akonadi/resources/vcarddir/vcarddirresource.desktop
===================================================================
--- akonadi/resources/vcarddir/vcarddirresource.desktop	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ akonadi/resources/vcarddir/vcarddirresource.desktop	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -12,6 +12,7 @@
 Name[ga]=Comhadlann v-Chárta
 Name[gl]=Directorio de VCard
 Name[hu]=vCard-mappa
+Name[is]=Mappa fyrir VCard spjaldskrár
 Name[it]=Cartella vCard
 Name[ja]=VCard ディレクトリ
 Name[km]=ថត VCard
@@ -48,6 +49,7 @@
 Comment[ga]=Gníomhaire a luchtaíonn sonraí ó chomhadlann ina bhfuil v-Chártaí
 Comment[gl]=Carregar datos desde un cartafol con VCards 
 Comment[hu]=Adatbetöltő vCard-fájlokat tartalmazó fájlrendszerbeli mappákhoz
+Comment[is]=Hleður inn gögnum úr möppu með VCard spjaldskrám
 Comment[it]=Caricare dati da una cartella con file vCard
 Comment[ja]=VCard のディレクトリからデータを読み込みます
 Comment[km]=ផ្ទុក​ទីន្នន័យ​ពី​ថត​ដែល​មាន VCards
Index: akonadi/resources/vcard/vcardresource.desktop
===================================================================
--- akonadi/resources/vcard/vcardresource.desktop	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ akonadi/resources/vcard/vcardresource.desktop	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -12,6 +12,7 @@
 Name[ga]=Comhad v-Chárta
 Name[gl]=Ficheiro de VCard
 Name[hu]=vCard-fájl
+Name[is]=VCard spjaldskrá
 Name[it]=File vCard
 Name[ja]=VCard ファイル
 Name[km]=ឯកសារ VCard
@@ -48,6 +49,7 @@
 Comment[ga]=Breiseán a luchtaíonn sonraí ó chomhad v-Chárta
 Comment[gl]=Carrega datos desde un ficheiro VCard
 Comment[hu]=Adatbetöltő vCard-fájlokhoz
+Comment[is]=Hleður inn gögnum úr VCard spjaldskrá
 Comment[it]=Caricare dati da un file vCard
 Comment[ja]=VCard ファイルからデータを読み込みます
 Comment[km]=ផ្ទុក​ទិន្នន័យ​ពី​ឯកសារ VCard
Index: akonadi/resources/distlist/distlistresource.desktop
===================================================================
--- akonadi/resources/distlist/distlistresource.desktop	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ akonadi/resources/distlist/distlistresource.desktop	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -10,6 +10,7 @@
 Name[fr]=Fichier de liste de distribution
 Name[ga]=Comhad Liosta Dáilte
 Name[gl]=Ficheiro de lista de distribución
+Name[is]=Dreifilistaskrá
 Name[it]=File lista di distribuzione
 Name[ja]=配布リストファイル
 Name[km]=ឯកសារ​បញ្ជី​ចែកចាយ
@@ -22,6 +23,7 @@
 Name[pl]=Plik list dystrybucyjnych
 Name[pt]=Ficheiro de Lista de Distribuição
 Name[pt_BR]=Arquivo de lista de distribuição
+Name[ro]=Fișier-listă de distribuție
 Name[ru]=Файл со списком рассылки
 Name[sv]=Fil med fördelningslista
 Name[tr]=Dağıtım Listesi Dosyası
@@ -52,6 +54,7 @@
 Comment[pl]=Wczytuje dane z pliku list dystrybucyjnych
 Comment[pt]=Carrega os dados a partir de um ficheiro de lista de distribuição
 Comment[pt_BR]=Carrega os dados de um arquivo de lista de distribuição
+Comment[ro]=Încarcă date dintr-un fișier listă de distribuție
 Comment[ru]=Загрузка данных из файла со списком рассылки
 Comment[sv]=Laddar data från en fil med en fördelningslista
 Comment[tr]=Bir dağıtım listesi dosyasından veri yükler
Index: akonadi/resources/kabc/kabcresource.desktop
===================================================================
--- akonadi/resources/kabc/kabcresource.desktop	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ akonadi/resources/kabc/kabcresource.desktop	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -22,6 +22,7 @@
 Name[pl]=Książka adresowa KDE (tradycyjna)
 Name[pt]=Livro de Endereços do KDE (tradicional)
 Name[pt_BR]=Livro de endereços do KDE (tradicional)
+Name[ro]=Carte de adrese KDE (tradițională)
 Name[sv]=KDE:s adressbok (traditionell)
 Name[tr]=KDE Adres Defteri (geleneksel)
 Name[uk]=Адресна книга KDE (традиційна)
Index: akonadi/resources/localbookmarks/localbookmarksresource.desktop
===================================================================
--- akonadi/resources/localbookmarks/localbookmarksresource.desktop	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ akonadi/resources/localbookmarks/localbookmarksresource.desktop	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -23,6 +23,7 @@
 Name[pl]=Zakładki lokalne
 Name[pt]=Favoritos Locais
 Name[pt_BR]=Favoritos locais
+Name[ro]=Semne de carte locale
 Name[ru]=Локальные закладки
 Name[sv]=Lokala bokmärken
 Name[tr]=Yerel Yer İmleri
Index: akonadi/resources/ical/icalresource.desktop
===================================================================
--- akonadi/resources/ical/icalresource.desktop	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ akonadi/resources/ical/icalresource.desktop	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -12,6 +12,7 @@
 Name[ga]=Comhad Féilire ICal
 Name[gl]=Ficheiro de calendario de ICal
 Name[hu]=iCal-naptárfájl
+Name[is]=ICal dagatalsskrá
 Name[it]=Calendario iCal
 Name[ja]=iCal カレンダーファイル
 Name[km]=ឯកសារ​ប្រតិទិន ICal
@@ -48,6 +49,7 @@
 Comment[ga]=Breiseán a luchtaíonn sonraí ó chomhad iCal
 Comment[gl]=Carrega datos desde un ficheiro iCal
 Comment[hu]=Adatbetöltés iCal formátumú naptárból
+Comment[is]=Hleður inn gögnum úr iCal skrá
 Comment[it]=Carica dati da un file iCal
 Comment[ja]=iCal ファイルからデータを読み込みます
 Comment[km]=ផ្ទុក​ទិន្នន័យ​ពី​ឯកសារ iCal
Index: akonadi/resources/ical/notesresource.desktop
===================================================================
--- akonadi/resources/ical/notesresource.desktop	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ akonadi/resources/ical/notesresource.desktop	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -81,6 +81,7 @@
 Comment[pl]=Wczytuje dane z pliku notatek
 Comment[pt]=Carrega os dados de um ficheiro de notas
 Comment[pt_BR]=Carrega os dados de um arquivo de notas
+Comment[ro]=Încarcă date dintr-un fișier cu note
 Comment[ru]=Загрузка данных из файла заметок
 Comment[sv]=Laddar data från en anteckningsfil
 Comment[tr]=Bir not dosyasından veri yükler
Index: akonadi/resources/nepomuktag/nepomuktagresource.desktop
===================================================================
--- akonadi/resources/nepomuktag/nepomuktagresource.desktop	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ akonadi/resources/nepomuktag/nepomuktagresource.desktop	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -11,6 +11,7 @@
 Name[fr]=Étiquettes Nepomuk (dossiers virtuels)
 Name[gl]=Etiquetas Nepomuk (cartafoles virtuais)
 Name[hu]=Nepomuk-címkék (virtuális mappák)
+Name[is]=Nepomuk merki (Virtual Folders)
 Name[it]=Etichette Nepomuk (cartelle virtuali)
 Name[ja]=Nepomuk タグ (仮想フォルダ)
 Name[km]=ស្លាក Nepomuk (ថត​និម្មិត)
Index: korganizer/koattendeeeditor.cpp
===================================================================
--- korganizer/koattendeeeditor.cpp	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ korganizer/koattendeeeditor.cpp	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -294,7 +294,7 @@
   qDeleteAll( mDelAttendees );
   mDelAttendees.clear();
 
-  if ( KOPrefs::instance()->thatIsMe( incidence->organizer().email() ) ) {
+  if ( KOPrefs::instance()->thatIsMe( incidence->organizer().email() ) || incidence->organizer().isEmpty() ) {
     //TODO: make a new private method for creating the mOrganizerCombo
     //and use it here and initOrganizerWidgets() above.
     if ( !mOrganizerCombo ) {
Index: korganizer/koeditorgeneral.cpp
===================================================================
--- korganizer/koeditorgeneral.cpp	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ korganizer/koeditorgeneral.cpp	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -288,22 +288,24 @@
   mAlarmIncrCombo->addItem( i18nc( "@item:inlistbox alarm expressed in minutes", "minute(s)" ) );
   mAlarmIncrCombo->addItem( i18nc( "@item:inlistbox alarm expressed in hours", "hour(s)" ) );
   mAlarmIncrCombo->addItem( i18nc( "@item:inlistbox alarm expressed in days", "day(s)" ) );
-//  mAlarmIncrCombo->setMinimumHeight(20);
   connect( mAlarmButton, SIGNAL(toggled(bool)), mAlarmTimeEdit, SLOT(setEnabled(bool)) );
   connect( mAlarmButton, SIGNAL(toggled(bool)), mAlarmIncrCombo, SLOT(setEnabled(bool)) );
   simpleAlarmLayout->addWidget( mAlarmIncrCombo );
 
-  mAlarmTimeEdit->setEnabled( false );
-  mAlarmIncrCombo->setEnabled( false );
-
   mAlarmEditButton =
     new QPushButton( i18nc( "@action:button advanced alarm settings", "Advanced..." ), parent );
+  connect( mAlarmButton, SIGNAL(toggled(bool)), mAlarmEditButton, SLOT(setEnabled(bool)) );
   mAlarmEditButton->setWhatsThis(
     i18nc( "@info:whatsthis",
            "Push this button to create an advanced alarm for this event or to-do" ) );
   mAlarmEditButton->setToolTip( i18nc( "@info:tooltip", "Set an advanced alarm" ) );
   alarmLayout->addWidget( mAlarmEditButton );
   alarmLayout->addStretch();
+
+  mAlarmTimeEdit->setEnabled( false );
+  mAlarmIncrCombo->setEnabled( false );
+  mAlarmEditButton->setEnabled( false );
+
   connect( mAlarmEditButton, SIGNAL(clicked()), SLOT(editAlarms()) );
 }
 
Index: korganizer/actionmanager.cpp
===================================================================
--- korganizer/actionmanager.cpp	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ korganizer/actionmanager.cpp	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -1798,6 +1798,7 @@
                i18n( "Removing attachments from an email might invalidate its signature." ),
                i18n( "Remove Attachments" ), KStandardGuiItem::cont(), KStandardGuiItem::cancel(),
                "BodyOnlyInlineAttachment" ) != KMessageBox::Continue ) {
+          delete msg;
           return;
         }
         KMime::Message *newMsg = new KMime::Message();
Index: korganizer/views/todoview/kotodomodel.cpp
===================================================================
--- korganizer/views/todoview/kotodomodel.cpp	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ korganizer/views/todoview/kotodomodel.cpp	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -281,8 +281,10 @@
     insertTodo( todo );
   } else if ( action == KOGlobals::INCIDENCEDELETED ) {
     TodoTreeNode *ttTodo = findTodo( todo );
-    // we can only delete todo's which are in the tree
-    Q_ASSERT( ttTodo );
+    if ( !ttTodo || !ttTodo->isValid() ) {
+      return;
+    }
+
     // somebody should assure that all todo's which relate to this one
     // are un-linked before deleting this one
     Q_ASSERT( !ttTodo->hasChildren() );
Index: korganizer/templatemanagementdialog.cpp
===================================================================
--- korganizer/templatemanagementdialog.cpp	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ korganizer/templatemanagementdialog.cpp	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -169,9 +169,12 @@
   // Once the user has applied the current template to the event,
   // it makes no sense to add it again
   m_base.m_buttonAdd->setEnabled( false );
-  const QString &cur = m_base.m_listBox->currentItem()->text();
-  if ( !cur.isEmpty() && cur != m_newTemplate ) {
-    emit loadTemplate( cur );
+  QListWidgetItem *item = m_base.m_listBox->currentItem();
+  if ( item ) {
+    const QString &cur = item->text();
+    if ( !cur.isEmpty() && cur != m_newTemplate ) {
+      emit loadTemplate( cur );
+    }
   }
 }
 
Index: korganizer/kcmconfigs/korganizer_configfreebusy.desktop
===================================================================
--- korganizer/kcmconfigs/korganizer_configfreebusy.desktop	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ korganizer/kcmconfigs/korganizer_configfreebusy.desktop	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -20,7 +20,7 @@
 Name[cs]=Aktivita
 Name[cy]=Rhydd/Prysur
 Name[da]=Fri/Optaget
-Name[de]=Frei/Beschäftigt
+Name[de]=Frei/Belegt
 Name[eo]=Libera/Okupita
 Name[es]=Libre/Ocupado
 Name[et]=Vaba/hõivatud
@@ -76,7 +76,7 @@
 Comment[cs]=Nastavení aktivity pro KOrganizer
 Comment[cy]=Ffurfweddiad Rhydd/Prysur KTrefnydd
 Comment[da]=KOrganizer Fri/Optaget-indstilling
-Comment[de]=Frei/Beschäftigt-Festlegung für KOrganizer
+Comment[de]=Frei/Belegt-Festlegung für KOrganizer
 Comment[el]=Ρυθμίσεις KOrganizer Free/Busy
 Comment[eo]=KOrganizilo Agordo pri libero/okupito
 Comment[es]=Configuración de libre/ocupado de KOrganizer
Index: korganizer/koeditoralarms.cpp
===================================================================
--- korganizer/koeditoralarms.cpp	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ korganizer/koeditoralarms.cpp	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -453,6 +453,8 @@
   if ( mWidget.mAlarmList->topLevelItemCount() > 0 ) {
     mWidget.mAlarmList->setCurrentItem( mWidget.mAlarmList->topLevelItem( 0 ) );
   }
+  mWidget.mAlarmOffset->setFocus();
+
   mInitializing = false;
 }
 
Index: mimelib/dw_mime.cpp
===================================================================
--- mimelib/dw_mime.cpp	(.../tags/KDE/4.3.0/kdepim)	(wersja 1013413)
+++ mimelib/dw_mime.cpp	(.../branches/KDE/4.3/kdepim)	(wersja 1013413)
@@ -344,6 +344,9 @@
         if (DwStrcasecmp(aStr, "x-diff") == 0) {
             type = DwMime::kSubtypeXDiff;
         }
+        if (DwStrcasecmp(aStr, "x-vcalendar") == 0) {
+            type = DwMime::kSubtypeVCal;
+        }
         break;
     }
     return type;

Zmiany atrybutów dla: .
___________________________________________________________________
Dodane: svn:externals
   + 


